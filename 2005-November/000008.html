<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Xoops4-svn] r15 - in XoopsCore/branches/2.3.x/2.3-main: docs htdocs htdocs/class htdocs/class/smarty htdocs/class/smarty/plugins htdocs/include
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/xoops4-svn/2005-November/index.html" >
   <LINK REL="made" HREF="mailto:xoops4-svn%40lists.berlios.de?Subject=Re%3A%20%5BXoops4-svn%5D%20r15%20-%20in%20XoopsCore/branches/2.3.x/2.3-main%3A%20docs%20htdocs%20htdocs/class%20htdocs/class/smarty%20htdocs/class/smarty/plugins%20htdocs/include&In-Reply-To=%3C200511200442.jAK4gMEn017756%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000007.html">
   <LINK REL="Next"  HREF="000009.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Xoops4-svn] r15 - in XoopsCore/branches/2.3.x/2.3-main: docs htdocs htdocs/class htdocs/class/smarty htdocs/class/smarty/plugins htdocs/include</H1>
    <B>skalpa at BerliOS</B> 
    <A HREF="mailto:xoops4-svn%40lists.berlios.de?Subject=Re%3A%20%5BXoops4-svn%5D%20r15%20-%20in%20XoopsCore/branches/2.3.x/2.3-main%3A%20docs%20htdocs%20htdocs/class%20htdocs/class/smarty%20htdocs/class/smarty/plugins%20htdocs/include&In-Reply-To=%3C200511200442.jAK4gMEn017756%40sheep.berlios.de%3E"
       TITLE="[Xoops4-svn] r15 - in XoopsCore/branches/2.3.x/2.3-main: docs htdocs htdocs/class htdocs/class/smarty htdocs/class/smarty/plugins htdocs/include">skalpa at berlios.de
       </A><BR>
    <I>Sun Nov 20 05:42:22 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000007.html">[Xoops4-svn] r14 - XoopsCore/branches/2.3.x
</A></li>
        <LI>Next message: <A HREF="000009.html">[Xoops4-svn] r16 - in XoopsCore/branches/2.3.x/2.3-main: . XOOPS XOOPS-data XOOPS-data/Application Support XOOPS-data/Caches htdocs htdocs/include upgrade
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8">[ date ]</a>
              <a href="thread.html#8">[ thread ]</a>
              <a href="subject.html#8">[ subject ]</a>
              <a href="author.html#8">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: skalpa
Date: 2005-11-20 05:41:49 +0100 (Sun, 20 Nov 2005)
New Revision: 15

Added:
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/internals/
Removed:
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/configs/
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/core/
Modified:
   XoopsCore/branches/2.3.x/2.3-main/docs/changelog.txt
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Config_File.class.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Smarty.class.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Smarty_Compiler.class.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/debug.tpl
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/block.textformat.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/compiler.assign.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.assign_debug_info.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.config_load.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.counter.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.cycle.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.debug.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.eval.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.fetch.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_checkboxes.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_image.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_options.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_radios.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_select_date.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_select_time.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_table.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.mailto.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.math.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.popup.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.popup_init.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.capitalize.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.cat.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_characters.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_paragraphs.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_sentences.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_words.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.date_format.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.debug_print_var.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.default.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.escape.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.indent.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.lower.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.nl2br.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.regex_replace.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.replace.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.spacify.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.string_format.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.strip.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.strip_tags.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.truncate.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.upper.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.wordwrap.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/outputfilter.trimwhitespace.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/shared.escape_special_chars.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/shared.make_timestamp.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/class/snoopy.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/include/version.php
   XoopsCore/branches/2.3.x/2.3-main/htdocs/mainfile.dist.php
Log:
Merged the changes from task #121119, updating Smarty to 2.6.10 and Snoopy to 1.2.3

Modified: XoopsCore/branches/2.3.x/2.3-main/docs/changelog.txt
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/docs/changelog.txt	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/docs/changelog.txt	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,5 +1,19 @@
-XOOPS v2.0.x Changelog
+XOOPS 2 changelog
+
 ============================
+YYYY/MM/DD: Version 2.3.0-alpha1
+============================
+- Updated Smarty to 2.6.10 (skalpa)
+- Updated Snoopy to 1.2.3 (skalpa)
+
+
+
+
+
+
+
+
+============================
 2005/10/28: Version 2.0.13.2
 ============================
 - SECURITY: Fix to prevent mail headers injection (Skalpa/XOOPS Cube)

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Config_File.class.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Config_File.class.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Config_File.class.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,389 +1,389 @@
-&lt;?php
-
-/**
- * Config_File class.
- *
- * This library is free software; you can redistribute it and/or
- * modify it under the terms of the GNU Lesser General Public
- * License as published by the Free Software Foundation; either
- * version 2.1 of the License, or (at your option) any later version.
- *
- * This library is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
- * Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU Lesser General Public
- * License along with this library; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- *
- * @link <A HREF="http://smarty.php.net/">http://smarty.php.net/</A>
- * @version 2.6.5-dev
- * @copyright Copyright: 2001-2004 ispi of Lincoln, Inc.
- * @author Andrei Zmievski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">andrei at php.net</A>&gt;
- * @access public
- * @package Smarty
- */
-
-/* $Id$ */
-
-/**
- * Config file reading class
- * @package Smarty
- */
-class Config_File {
-    /**#@+
-     * Options
-     * @var boolean
-     */
-    /**
-     * Controls whether variables with the same name overwrite each other.
-     */
-    var $overwrite        =    true;
-
-    /**
-     * Controls whether config values of on/true/yes and off/false/no get
-     * converted to boolean values automatically.
-     */
-    var $booleanize        =    true;
-
-    /**
-     * Controls whether hidden config sections/vars are read from the file.
-     */
-    var $read_hidden     =    true;
-
-    /**
-     * Controls whether or not to fix mac or dos formatted newlines.
-     * If set to true, \r or \r\n will be changed to \n.
-     */
-    var $fix_newlines =    true;
-    /**#@-*/
-
-    /** @access private */
-    var $_config_path    = &quot;&quot;;
-    var $_config_data    = array();
-    /**#@-*/
-
-    /**
-     * Constructs a new config file class.
-     *
-     * @param string $config_path (optional) path to the config files
-     */
-    function Config_File($config_path = NULL)
-    {
-        if (isset($config_path))
-            $this-&gt;set_path($config_path);
-    }
-
-
-    /**
-     * Set the path where configuration files can be found.
-     *
-     * @param string $config_path path to the config files
-     */
-    function set_path($config_path)
-    {
-        if (!empty($config_path)) {
-            if (!is_string($config_path) || !file_exists($config_path) || !is_dir($config_path)) {
-                $this-&gt;_trigger_error_msg(&quot;Bad config file path '$config_path'&quot;);
-                return;
-            }
-            if(substr($config_path, -1) != DIRECTORY_SEPARATOR) {
-                $config_path .= DIRECTORY_SEPARATOR;
-            }
-
-            $this-&gt;_config_path = $config_path;
-        }
-    }
-
-
-    /**
-     * Retrieves config info based on the file, section, and variable name.
-     *
-     * @param string $file_name config file to get info for
-     * @param string $section_name (optional) section to get info for
-     * @param string $var_name (optional) variable to get info for
-     * @return string|array a value or array of values
-     */
-    function &amp;get($file_name, $section_name = NULL, $var_name = NULL)
-    {
-        if (empty($file_name)) {
-            $this-&gt;_trigger_error_msg('Empty config file name');
-            return;
-        } else {
-            $file_name = $this-&gt;_config_path . $file_name;
-            if (!isset($this-&gt;_config_data[$file_name]))
-                $this-&gt;load_file($file_name, false);
-        }
-
-        if (!empty($var_name)) {
-            if (empty($section_name)) {
-                return $this-&gt;_config_data[$file_name][&quot;vars&quot;][$var_name];
-            } else {
-                if(isset($this-&gt;_config_data[$file_name][&quot;sections&quot;][$section_name][&quot;vars&quot;][$var_name]))
-                    return $this-&gt;_config_data[$file_name][&quot;sections&quot;][$section_name][&quot;vars&quot;][$var_name];
-                else
-                    return array();
-            }
-        } else {
-            if (empty($section_name)) {
-                return (array)$this-&gt;_config_data[$file_name][&quot;vars&quot;];
-            } else {
-                if(isset($this-&gt;_config_data[$file_name][&quot;sections&quot;][$section_name][&quot;vars&quot;]))
-                    return (array)$this-&gt;_config_data[$file_name][&quot;sections&quot;][$section_name][&quot;vars&quot;];
-                else
-                    return array();
-            }
-        }
-    }
-
-
-    /**
-     * Retrieves config info based on the key.
-     *
-     * @param $file_name string config key (filename/section/var)
-     * @return string|array same as get()
-     * @uses get() retrieves information from config file and returns it
-     */
-    function &amp;get_key($config_key)
-    {
-        list($file_name, $section_name, $var_name) = explode('/', $config_key, 3);
-        $result = &amp;$this-&gt;get($file_name, $section_name, $var_name);
-        return $result;
-    }
-
-    /**
-     * Get all loaded config file names.
-     *
-     * @return array an array of loaded config file names
-     */
-    function get_file_names()
-    {
-        return array_keys($this-&gt;_config_data);
-    }
-
-
-    /**
-     * Get all section names from a loaded file.
-     *
-     * @param string $file_name config file to get section names from
-     * @return array an array of section names from the specified file
-     */
-    function get_section_names($file_name)
-    {
-        $file_name = $this-&gt;_config_path . $file_name;
-        if (!isset($this-&gt;_config_data[$file_name])) {
-            $this-&gt;_trigger_error_msg(&quot;Unknown config file '$file_name'&quot;);
-            return;
-        }
-
-        return array_keys($this-&gt;_config_data[$file_name][&quot;sections&quot;]);
-    }
-
-
-    /**
-     * Get all global or section variable names.
-     *
-     * @param string $file_name config file to get info for
-     * @param string $section_name (optional) section to get info for
-     * @return array an array of variables names from the specified file/section
-     */
-    function get_var_names($file_name, $section = NULL)
-    {
-        if (empty($file_name)) {
-            $this-&gt;_trigger_error_msg('Empty config file name');
-            return;
-        } else if (!isset($this-&gt;_config_data[$file_name])) {
-            $this-&gt;_trigger_error_msg(&quot;Unknown config file '$file_name'&quot;);
-            return;
-        }
-
-        if (empty($section))
-            return array_keys($this-&gt;_config_data[$file_name][&quot;vars&quot;]);
-        else
-            return array_keys($this-&gt;_config_data[$file_name][&quot;sections&quot;][$section][&quot;vars&quot;]);
-    }
-
-
-    /**
-     * Clear loaded config data for a certain file or all files.
-     *
-     * @param string $file_name file to clear config data for
-     */
-    function clear($file_name = NULL)
-    {
-        if ($file_name === NULL)
-            $this-&gt;_config_data = array();
-        else if (isset($this-&gt;_config_data[$file_name]))
-            $this-&gt;_config_data[$file_name] = array();
-    }
-
-
-    /**
-     * Load a configuration file manually.
-     *
-     * @param string $file_name file name to load
-     * @param boolean $prepend_path whether current config path should be
-     *                              prepended to the filename
-     */
-    function load_file($file_name, $prepend_path = true)
-    {
-        if ($prepend_path &amp;&amp; $this-&gt;_config_path != &quot;&quot;)
-            $config_file = $this-&gt;_config_path . $file_name;
-        else
-            $config_file = $file_name;
-
-        ini_set('track_errors', true);
-        $fp = @fopen($config_file, &quot;r&quot;);
-        if (!is_resource($fp)) {
-            $this-&gt;_trigger_error_msg(&quot;Could not open config file '$config_file'&quot;);
-            return false;
-        }
-
-        $contents = ($size = filesize($config_file)) ? fread($fp, $size) : '';
-        fclose($fp);
-
-        $this-&gt;_config_data[$config_file] = $this-&gt;parse_contents($contents);
-        return true;
-    }
-
-    /**
-     * Store the contents of a file manually.
-     *
-     * @param string $config_file file name of the related contents
-     * @param string $contents the file-contents to parse
-     */
-    function set_file_contents($config_file, $contents)
-    {
-        $this-&gt;_config_data[$config_file] = $this-&gt;parse_contents($contents);
-        return true;
-    }
-
-    /**
-     * parse the source of a configuration file manually.
-     *
-     * @param string $contents the file-contents to parse
-     */
-    function parse_contents($contents)
-    {
-        if($this-&gt;fix_newlines) {
-            // fix mac/dos formatted newlines
-            $contents = preg_replace('!\r\n?!', &quot;\n&quot;, $contents);
-        }
-
-        $config_data = array();
-        $config_data['sections'] = array();
-        $config_data['vars'] = array();
-
-        /* reference to fill with data */
-        $vars =&amp; $config_data['vars'];
-
-        /* parse file line by line */
-        preg_match_all('!^.*\r?\n?!m', $contents, $match);
-        $lines = $match[0];
-        for ($i=0, $count=count($lines); $i&lt;$count; $i++) {
-            $line = $lines[$i];
-            if (empty($line)) continue;
-
-            if ( $line{0} == '[' &amp;&amp; preg_match('!^\[(.*?)\]!', $line, $match) ) {
-                /* section found */
-                if ($match[1]{0} == '.') {
-                    /* hidden section */
-                    if ($this-&gt;read_hidden) {
-                        $section_name = substr($match[1], 1);
-                    } else {
-                        /* break reference to $vars to ignore hidden section */
-                        unset($vars);
-                        $vars = array();
-                        continue;
-                    }
-                } else {                    
-                    $section_name = $match[1];
-                }
-                if (!isset($config_data['sections'][$section_name]))
-                    $config_data['sections'][$section_name] = array('vars' =&gt; array());
-                $vars =&amp; $config_data['sections'][$section_name]['vars'];
-                continue;
-            }
-
-            if (preg_match('/^\s*(\.?\w+)\s*=\s*(.*)/s', $line, $match)) {
-                /* variable found */
-                $var_name = rtrim($match[1]);
-                if (strpos($match[2], '&quot;&quot;&quot;') === 0) {
-                    /* handle multiline-value */
-                    $lines[$i] = substr($match[2], 3);
-                    $var_value = '';
-                    while ($i&lt;$count) {
-                        if (($pos = strpos($lines[$i], '&quot;&quot;&quot;')) === false) {
-                            $var_value .= $lines[$i++];
-                        } else {
-                            /* end of multiline-value */
-                            $var_value .= substr($lines[$i], 0, $pos);
-                            break;
-                        }
-                    }
-                    $booleanize = false;
-
-                } else {
-                    /* handle simple value */
-                    $var_value = preg_replace('/^([\'&quot;])(.*)\1$/', '\2', rtrim($match[2]));
-                    $booleanize = $this-&gt;booleanize;
-
-                }
-                $this-&gt;_set_config_var($vars, $var_name, $var_value, $booleanize);
-            }
-            /* else unparsable line / means it is a comment / means ignore it */
-        }
-        return $config_data;
-    }
-
-    /**#@+ @access private */
-    /**
-     * @param array &amp;$container
-     * @param string $var_name
-     * @param mixed $var_value
-     * @param boolean $booleanize determines whether $var_value is converted to
-     *                            to true/false
-     */
-    function _set_config_var(&amp;$container, $var_name, $var_value, $booleanize)
-    {
-        if ($var_name{0} == '.') {
-            if (!$this-&gt;read_hidden)
-                return;
-            else
-                $var_name = substr($var_name, 1);
-        }
-
-        if (!preg_match(&quot;/^[a-zA-Z_]\w*$/&quot;, $var_name)) {
-            $this-&gt;_trigger_error_msg(&quot;Bad variable name '$var_name'&quot;);
-            return;
-        }
-
-        if ($booleanize) {
-            if (preg_match(&quot;/^(on|true|yes)$/i&quot;, $var_value))
-                $var_value = true;
-            else if (preg_match(&quot;/^(off|false|no)$/i&quot;, $var_value))
-                $var_value = false;
-        }
-
-        if (!isset($container[$var_name]) || $this-&gt;overwrite)
-            $container[$var_name] = $var_value;
-        else {
-            settype($container[$var_name], 'array');
-            $container[$var_name][] = $var_value;
-        }
-    }
-
-    /**
-     * @uses trigger_error() creates a PHP warning/error
-     * @param string $error_msg
-     * @param integer $error_type one of
-     */
-    function _trigger_error_msg($error_msg, $error_type = E_USER_WARNING)
-    {
-        trigger_error(&quot;Config_File error: $error_msg&quot;, $error_type);
-    }
-    /**#@-*/
-}
-
-?&gt;
+&lt;?php
+
+/**
+ * Config_File class.
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * @link <A HREF="http://smarty.php.net/">http://smarty.php.net/</A>
+ * @version 2.6.10
+ * @copyright Copyright: 2001-2005 New Digital Group, Inc.
+ * @author Andrei Zmievski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">andrei at php.net</A>&gt;
+ * @access public
+ * @package Smarty
+ */
+
+/* $Id$ */
+
+/**
+ * Config file reading class
+ * @package Smarty
+ */
+class Config_File {
+    /**#@+
+     * Options
+     * @var boolean
+     */
+    /**
+     * Controls whether variables with the same name overwrite each other.
+     */
+    var $overwrite        =    true;
+
+    /**
+     * Controls whether config values of on/true/yes and off/false/no get
+     * converted to boolean values automatically.
+     */
+    var $booleanize        =    true;
+
+    /**
+     * Controls whether hidden config sections/vars are read from the file.
+     */
+    var $read_hidden     =    true;
+
+    /**
+     * Controls whether or not to fix mac or dos formatted newlines.
+     * If set to true, \r or \r\n will be changed to \n.
+     */
+    var $fix_newlines =    true;
+    /**#@-*/
+
+    /** @access private */
+    var $_config_path    = &quot;&quot;;
+    var $_config_data    = array();
+    /**#@-*/
+
+    /**
+     * Constructs a new config file class.
+     *
+     * @param string $config_path (optional) path to the config files
+     */
+    function Config_File($config_path = NULL)
+    {
+        if (isset($config_path))
+            $this-&gt;set_path($config_path);
+    }
+
+
+    /**
+     * Set the path where configuration files can be found.
+     *
+     * @param string $config_path path to the config files
+     */
+    function set_path($config_path)
+    {
+        if (!empty($config_path)) {
+            if (!is_string($config_path) || !file_exists($config_path) || !is_dir($config_path)) {
+                $this-&gt;_trigger_error_msg(&quot;Bad config file path '$config_path'&quot;);
+                return;
+            }
+            if(substr($config_path, -1) != DIRECTORY_SEPARATOR) {
+                $config_path .= DIRECTORY_SEPARATOR;
+            }
+
+            $this-&gt;_config_path = $config_path;
+        }
+    }
+
+
+    /**
+     * Retrieves config info based on the file, section, and variable name.
+     *
+     * @param string $file_name config file to get info for
+     * @param string $section_name (optional) section to get info for
+     * @param string $var_name (optional) variable to get info for
+     * @return string|array a value or array of values
+     */
+    function get($file_name, $section_name = NULL, $var_name = NULL)
+    {
+        if (empty($file_name)) {
+            $this-&gt;_trigger_error_msg('Empty config file name');
+            return;
+        } else {
+            $file_name = $this-&gt;_config_path . $file_name;
+            if (!isset($this-&gt;_config_data[$file_name]))
+                $this-&gt;load_file($file_name, false);
+        }
+
+        if (!empty($var_name)) {
+            if (empty($section_name)) {
+                return $this-&gt;_config_data[$file_name][&quot;vars&quot;][$var_name];
+            } else {
+                if(isset($this-&gt;_config_data[$file_name][&quot;sections&quot;][$section_name][&quot;vars&quot;][$var_name]))
+                    return $this-&gt;_config_data[$file_name][&quot;sections&quot;][$section_name][&quot;vars&quot;][$var_name];
+                else
+                    return array();
+            }
+        } else {
+            if (empty($section_name)) {
+                return (array)$this-&gt;_config_data[$file_name][&quot;vars&quot;];
+            } else {
+                if(isset($this-&gt;_config_data[$file_name][&quot;sections&quot;][$section_name][&quot;vars&quot;]))
+                    return (array)$this-&gt;_config_data[$file_name][&quot;sections&quot;][$section_name][&quot;vars&quot;];
+                else
+                    return array();
+            }
+        }
+    }
+
+
+    /**
+     * Retrieves config info based on the key.
+     *
+     * @param $file_name string config key (filename/section/var)
+     * @return string|array same as get()
+     * @uses get() retrieves information from config file and returns it
+     */
+    function &amp;get_key($config_key)
+    {
+        list($file_name, $section_name, $var_name) = explode('/', $config_key, 3);
+        $result = &amp;$this-&gt;get($file_name, $section_name, $var_name);
+        return $result;
+    }
+
+    /**
+     * Get all loaded config file names.
+     *
+     * @return array an array of loaded config file names
+     */
+    function get_file_names()
+    {
+        return array_keys($this-&gt;_config_data);
+    }
+
+
+    /**
+     * Get all section names from a loaded file.
+     *
+     * @param string $file_name config file to get section names from
+     * @return array an array of section names from the specified file
+     */
+    function get_section_names($file_name)
+    {
+        $file_name = $this-&gt;_config_path . $file_name;
+        if (!isset($this-&gt;_config_data[$file_name])) {
+            $this-&gt;_trigger_error_msg(&quot;Unknown config file '$file_name'&quot;);
+            return;
+        }
+
+        return array_keys($this-&gt;_config_data[$file_name][&quot;sections&quot;]);
+    }
+
+
+    /**
+     * Get all global or section variable names.
+     *
+     * @param string $file_name config file to get info for
+     * @param string $section_name (optional) section to get info for
+     * @return array an array of variables names from the specified file/section
+     */
+    function get_var_names($file_name, $section = NULL)
+    {
+        if (empty($file_name)) {
+            $this-&gt;_trigger_error_msg('Empty config file name');
+            return;
+        } else if (!isset($this-&gt;_config_data[$file_name])) {
+            $this-&gt;_trigger_error_msg(&quot;Unknown config file '$file_name'&quot;);
+            return;
+        }
+
+        if (empty($section))
+            return array_keys($this-&gt;_config_data[$file_name][&quot;vars&quot;]);
+        else
+            return array_keys($this-&gt;_config_data[$file_name][&quot;sections&quot;][$section][&quot;vars&quot;]);
+    }
+
+
+    /**
+     * Clear loaded config data for a certain file or all files.
+     *
+     * @param string $file_name file to clear config data for
+     */
+    function clear($file_name = NULL)
+    {
+        if ($file_name === NULL)
+            $this-&gt;_config_data = array();
+        else if (isset($this-&gt;_config_data[$file_name]))
+            $this-&gt;_config_data[$file_name] = array();
+    }
+
+
+    /**
+     * Load a configuration file manually.
+     *
+     * @param string $file_name file name to load
+     * @param boolean $prepend_path whether current config path should be
+     *                              prepended to the filename
+     */
+    function load_file($file_name, $prepend_path = true)
+    {
+        if ($prepend_path &amp;&amp; $this-&gt;_config_path != &quot;&quot;)
+            $config_file = $this-&gt;_config_path . $file_name;
+        else
+            $config_file = $file_name;
+
+        ini_set('track_errors', true);
+        $fp = @fopen($config_file, &quot;r&quot;);
+        if (!is_resource($fp)) {
+            $this-&gt;_trigger_error_msg(&quot;Could not open config file '$config_file'&quot;);
+            return false;
+        }
+
+        $contents = ($size = filesize($config_file)) ? fread($fp, $size) : '';
+        fclose($fp);
+
+        $this-&gt;_config_data[$config_file] = $this-&gt;parse_contents($contents);
+        return true;
+    }
+
+    /**
+     * Store the contents of a file manually.
+     *
+     * @param string $config_file file name of the related contents
+     * @param string $contents the file-contents to parse
+     */
+    function set_file_contents($config_file, $contents)
+    {
+        $this-&gt;_config_data[$config_file] = $this-&gt;parse_contents($contents);
+        return true;
+    }
+
+    /**
+     * parse the source of a configuration file manually.
+     *
+     * @param string $contents the file-contents to parse
+     */
+    function parse_contents($contents)
+    {
+        if($this-&gt;fix_newlines) {
+            // fix mac/dos formatted newlines
+            $contents = preg_replace('!\r\n?!', &quot;\n&quot;, $contents);
+        }
+
+        $config_data = array();
+        $config_data['sections'] = array();
+        $config_data['vars'] = array();
+
+        /* reference to fill with data */
+        $vars =&amp; $config_data['vars'];
+
+        /* parse file line by line */
+        preg_match_all('!^.*\r?\n?!m', $contents, $match);
+        $lines = $match[0];
+        for ($i=0, $count=count($lines); $i&lt;$count; $i++) {
+            $line = $lines[$i];
+            if (empty($line)) continue;
+
+            if ( $line{0} == '[' &amp;&amp; preg_match('!^\[(.*?)\]!', $line, $match) ) {
+                /* section found */
+                if ($match[1]{0} == '.') {
+                    /* hidden section */
+                    if ($this-&gt;read_hidden) {
+                        $section_name = substr($match[1], 1);
+                    } else {
+                        /* break reference to $vars to ignore hidden section */
+                        unset($vars);
+                        $vars = array();
+                        continue;
+                    }
+                } else {                    
+                    $section_name = $match[1];
+                }
+                if (!isset($config_data['sections'][$section_name]))
+                    $config_data['sections'][$section_name] = array('vars' =&gt; array());
+                $vars =&amp; $config_data['sections'][$section_name]['vars'];
+                continue;
+            }
+
+            if (preg_match('/^\s*(\.?\w+)\s*=\s*(.*)/s', $line, $match)) {
+                /* variable found */
+                $var_name = rtrim($match[1]);
+                if (strpos($match[2], '&quot;&quot;&quot;') === 0) {
+                    /* handle multiline-value */
+                    $lines[$i] = substr($match[2], 3);
+                    $var_value = '';
+                    while ($i&lt;$count) {
+                        if (($pos = strpos($lines[$i], '&quot;&quot;&quot;')) === false) {
+                            $var_value .= $lines[$i++];
+                        } else {
+                            /* end of multiline-value */
+                            $var_value .= substr($lines[$i], 0, $pos);
+                            break;
+                        }
+                    }
+                    $booleanize = false;
+
+                } else {
+                    /* handle simple value */
+                    $var_value = preg_replace('/^([\'&quot;])(.*)\1$/', '\2', rtrim($match[2]));
+                    $booleanize = $this-&gt;booleanize;
+
+                }
+                $this-&gt;_set_config_var($vars, $var_name, $var_value, $booleanize);
+            }
+            /* else unparsable line / means it is a comment / means ignore it */
+        }
+        return $config_data;
+    }
+
+    /**#@+ @access private */
+    /**
+     * @param array &amp;$container
+     * @param string $var_name
+     * @param mixed $var_value
+     * @param boolean $booleanize determines whether $var_value is converted to
+     *                            to true/false
+     */
+    function _set_config_var(&amp;$container, $var_name, $var_value, $booleanize)
+    {
+        if ($var_name{0} == '.') {
+            if (!$this-&gt;read_hidden)
+                return;
+            else
+                $var_name = substr($var_name, 1);
+        }
+
+        if (!preg_match(&quot;/^[a-zA-Z_]\w*$/&quot;, $var_name)) {
+            $this-&gt;_trigger_error_msg(&quot;Bad variable name '$var_name'&quot;);
+            return;
+        }
+
+        if ($booleanize) {
+            if (preg_match(&quot;/^(on|true|yes)$/i&quot;, $var_value))
+                $var_value = true;
+            else if (preg_match(&quot;/^(off|false|no)$/i&quot;, $var_value))
+                $var_value = false;
+        }
+
+        if (!isset($container[$var_name]) || $this-&gt;overwrite)
+            $container[$var_name] = $var_value;
+        else {
+            settype($container[$var_name], 'array');
+            $container[$var_name][] = $var_value;
+        }
+    }
+
+    /**
+     * @uses trigger_error() creates a PHP warning/error
+     * @param string $error_msg
+     * @param integer $error_type one of
+     */
+    function _trigger_error_msg($error_msg, $error_type = E_USER_WARNING)
+    {
+        trigger_error(&quot;Config_File error: $error_msg&quot;, $error_type);
+    }
+    /**#@-*/
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Smarty.class.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Smarty.class.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Smarty.class.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,1932 +1,1934 @@
-&lt;?php
-
-/**
- * Project:     Smarty: the PHP compiling template engine
- * File:        Smarty.class.php
- *
- * This library is free software; you can redistribute it and/or
- * modify it under the terms of the GNU Lesser General Public
- * License as published by the Free Software Foundation; either
- * version 2.1 of the License, or (at your option) any later version.
- *
- * This library is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
- * Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU Lesser General Public
- * License along with this library; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- *
- * For questions, help, comments, discussion, etc., please join the
- * Smarty mailing list. Send a blank e-mail to
- * <A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">smarty-general-subscribe at lists.php.net</A>
- *
- * @link <A HREF="http://smarty.php.net/">http://smarty.php.net/</A>
- * @copyright 2001-2004 ispi of Lincoln, Inc.
- * @author Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @author Andrei Zmievski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">andrei at php.net</A>&gt;
- * @package Smarty
- * @version 2.6.5-dev
- */
-
-/* $Id$ */
-
-/**
- * DIR_SEP isn't used anymore, but third party apps might
- */
-if(!defined('DIR_SEP')) {
-    define('DIR_SEP', DIRECTORY_SEPARATOR);
-}
-
-/**
- * set SMARTY_DIR to absolute path to Smarty library files.
- * if not defined, include_path will be used. Sets SMARTY_DIR only if user
- * application has not already defined it.
- */
-
-if (!defined('SMARTY_DIR')) {
-    define('SMARTY_DIR', dirname(__FILE__) . DIRECTORY_SEPARATOR);
-}
-
-define('SMARTY_PHP_PASSTHRU',   0);
-define('SMARTY_PHP_QUOTE',      1);
-define('SMARTY_PHP_REMOVE',     2);
-define('SMARTY_PHP_ALLOW',      3);
-
-/**
- * @package Smarty
- */
-class Smarty
-{
-    /**#@+
-     * Smarty Configuration Section
-     */
-
-    /**
-     * The name of the directory where templates are located.
-     *
-     * @var string
-     */
-    var $template_dir    =  'templates';
-
-    /**
-     * The directory where compiled templates are located.
-     *
-     * @var string
-     */
-    var $compile_dir     =  'templates_c';
-
-    /**
-     * The directory where config files are located.
-     *
-     * @var string
-     */
-    var $config_dir      =  'configs';
-
-    /**
-     * An array of directories searched for plugins.
-     *
-     * @var array
-     */
-    var $plugins_dir     =  array('plugins');
-
-    /**
-     * If debugging is enabled, a debug console window will display
-     * when the page loads (make sure your browser allows unrequested
-     * popup windows)
-     *
-     * @var boolean
-     */
-    var $debugging       =  false;
-
-    /**
-     * When set, smarty does uses this value as error_reporting-level.
-     *
-     * @var boolean
-     */
-    var $error_reporting  =  null;
-
-    /**
-     * This is the path to the debug console template. If not set,
-     * the default one will be used.
-     *
-     * @var string
-     */
-    var $debug_tpl       =  '';
-
-    /**
-     * This determines if debugging is enable-able from the browser.
-     * &lt;ul&gt;
-     *  &lt;li&gt;NONE =&gt; no debugging control allowed&lt;/li&gt;
-     *  &lt;li&gt;URL =&gt; enable debugging when SMARTY_DEBUG is found in the URL.&lt;/li&gt;
-     * &lt;/ul&gt;
-     * @link <A HREF="http://www.foo.dom/index.php?SMARTY_DEBUG">http://www.foo.dom/index.php?SMARTY_DEBUG</A>
-     * @var string
-     */
-    var $debugging_ctrl  =  'NONE';
-
-    /**
-     * This tells Smarty whether to check for recompiling or not. Recompiling
-     * does not need to happen unless a template or config file is changed.
-     * Typically you enable this during development, and disable for
-     * production.
-     *
-     * @var boolean
-     */
-    var $compile_check   =  true;
-
-    /**
-     * This forces templates to compile every time. Useful for development
-     * or debugging.
-     *
-     * @var boolean
-     */
-    var $force_compile   =  false;
-
-    /**
-     * This enables template caching.
-     * &lt;ul&gt;
-     *  &lt;li&gt;0 = no caching&lt;/li&gt;
-     *  &lt;li&gt;1 = use class cache_lifetime value&lt;/li&gt;
-     *  &lt;li&gt;2 = use cache_lifetime in cache file&lt;/li&gt;
-     * &lt;/ul&gt;
-     * @var integer
-     */
-    var $caching         =  0;
-
-    /**
-     * The name of the directory for cache files.
-     *
-     * @var string
-     */
-    var $cache_dir       =  'cache';
-
-    /**
-     * This is the number of seconds cached content will persist.
-     * &lt;ul&gt;
-     *  &lt;li&gt;0 = always regenerate cache&lt;/li&gt;
-     *  &lt;li&gt;-1 = never expires&lt;/li&gt;
-     * &lt;/ul&gt;
-     *
-     * @var integer
-     */
-    var $cache_lifetime  =  3600;
-
-    /**
-     * Only used when $caching is enabled. If true, then If-Modified-Since headers
-     * are respected with cached content, and appropriate HTTP headers are sent.
-     * This way repeated hits to a cached page do not send the entire page to the
-     * client every time.
-     *
-     * @var boolean
-     */
-    var $cache_modified_check = false;
-
-    /**
-     * This determines how Smarty handles &quot;&lt;?php ... ?&gt;&quot; tags in templates.
-     * possible values:
-     * &lt;ul&gt;
-     *  &lt;li&gt;SMARTY_PHP_PASSTHRU -&gt; print tags as plain text&lt;/li&gt;
-     *  &lt;li&gt;SMARTY_PHP_QUOTE    -&gt; escape tags as entities&lt;/li&gt;
-     *  &lt;li&gt;SMARTY_PHP_REMOVE   -&gt; remove php tags&lt;/li&gt;
-     *  &lt;li&gt;SMARTY_PHP_ALLOW    -&gt; execute php tags&lt;/li&gt;
-     * &lt;/ul&gt;
-     *
-     * @var integer
-     */
-    var $php_handling    =  SMARTY_PHP_PASSTHRU;
-
-    /**
-     * This enables template security. When enabled, many things are restricted
-     * in the templates that normally would go unchecked. This is useful when
-     * untrusted parties are editing templates and you want a reasonable level
-     * of security. (no direct execution of PHP in templates for example)
-     *
-     * @var boolean
-     */
-    var $security       =   false;
-
-    /**
-     * This is the list of template directories that are considered secure. This
-     * is used only if {@link $security} is enabled. One directory per array
-     * element.  {@link $template_dir} is in this list implicitly.
-     *
-     * @var array
-     */
-    var $secure_dir     =   array();
-
-    /**
-     * These are the security settings for Smarty. They are used only when
-     * {@link $security} is enabled.
-     *
-     * @var array
-     */
-    var $security_settings  = array(
-                                    'PHP_HANDLING'    =&gt; false,
-                                    'IF_FUNCS'        =&gt; array('array', 'list',
-                                                               'isset', 'empty',
-                                                               'count', 'sizeof',
-                                                               'in_array', 'is_array',
-                                                               'true','false'),
-                                    'INCLUDE_ANY'     =&gt; false,
-                                    'PHP_TAGS'        =&gt; false,
-                                    'MODIFIER_FUNCS'  =&gt; array('count'),
-                                    'ALLOW_CONSTANTS'  =&gt; false
-                                   );
-
-    /**
-     * This is an array of directories where trusted php scripts reside.
-     * {@link $security} is disabled during their inclusion/execution.
-     *
-     * @var array
-     */
-    var $trusted_dir        = array();
-
-    /**
-     * The left delimiter used for the template tags.
-     *
-     * @var string
-     */
-    var $left_delimiter  =  '{';
-
-    /**
-     * The right delimiter used for the template tags.
-     *
-     * @var string
-     */
-    var $right_delimiter =  '}';
-
-    /**
-     * The order in which request variables are registered, similar to
-     * variables_order in php.ini E = Environment, G = GET, P = POST,
-     * C = Cookies, S = Server
-     *
-     * @var string
-     */
-    var $request_vars_order    = 'EGPCS';
-
-    /**
-     * Indicates wether $HTTP_*_VARS[] (request_use_auto_globals=false)
-     * are uses as request-vars or $_*[]-vars. note: if
-     * request_use_auto_globals is true, then $request_vars_order has
-     * no effect, but the php-ini-value &quot;gpc_order&quot;
-     *
-     * @var boolean
-     */
-    var $request_use_auto_globals      = true;
-
-    /**
-     * Set this if you want different sets of compiled files for the same
-     * templates. This is useful for things like different languages.
-     * Instead of creating separate sets of templates per language, you
-     * set different compile_ids like 'en' and 'de'.
-     *
-     * @var string
-     */
-    var $compile_id            = null;
-
-    /**
-     * This tells Smarty whether or not to use sub dirs in the cache/ and
-     * templates_c/ directories. sub directories better organized, but
-     * may not work well with PHP safe mode enabled.
-     *
-     * @var boolean
-     *
-     */
-    var $use_sub_dirs          = false;
-
-    /**
-     * This is a list of the modifiers to apply to all template variables.
-     * Put each modifier in a separate array element in the order you want
-     * them applied. example: &lt;code&gt;array('escape:&quot;htmlall&quot;');&lt;/code&gt;
-     *
-     * @var array
-     */
-    var $default_modifiers        = array();
-
-    /**
-     * This is the resource type to be used when not specified
-     * at the beginning of the resource path. examples:
-     * $smarty-&gt;display('file:index.tpl');
-     * $smarty-&gt;display('db:index.tpl');
-     * $smarty-&gt;display('index.tpl'); // will use default resource type
-     * {include file=&quot;file:index.tpl&quot;}
-     * {include file=&quot;db:index.tpl&quot;}
-     * {include file=&quot;index.tpl&quot;} {* will use default resource type *}
-     *
-     * @var array
-     */
-    var $default_resource_type    = 'file';
-
-    /**
-     * The function used for cache file handling. If not set, built-in caching is used.
-     *
-     * @var null|string function name
-     */
-    var $cache_handler_func   = null;
-
-    /**
-     * This indicates which filters are automatically loaded into Smarty.
-     *
-     * @var array array of filter names
-     */
-    var $autoload_filters = array();
-
-    /**#@+
-     * @var boolean
-     */
-    /**
-     * This tells if config file vars of the same name overwrite each other or not.
-     * if disabled, same name variables are accumulated in an array.
-     */
-    var $config_overwrite = true;
-
-    /**
-     * This tells whether or not to automatically booleanize config file variables.
-     * If enabled, then the strings &quot;on&quot;, &quot;true&quot;, and &quot;yes&quot; are treated as boolean
-     * true, and &quot;off&quot;, &quot;false&quot; and &quot;no&quot; are treated as boolean false.
-     */
-    var $config_booleanize = true;
-
-    /**
-     * This tells whether hidden sections [.foobar] are readable from the
-     * tempalates or not. Normally you would never allow this since that is
-     * the point behind hidden sections: the application can access them, but
-     * the templates cannot.
-     */
-    var $config_read_hidden = false;
-
-    /**
-     * This tells whether or not automatically fix newlines in config files.
-     * It basically converts \r (mac) or \r\n (dos) to \n
-     */
-    var $config_fix_newlines = true;
-    /**#@-*/
-
-    /**
-     * If a template cannot be found, this PHP function will be executed.
-     * Useful for creating templates on-the-fly or other special action.
-     *
-     * @var string function name
-     */
-    var $default_template_handler_func = '';
-
-    /**
-     * The file that contains the compiler class. This can a full
-     * pathname, or relative to the php_include path.
-     *
-     * @var string
-     */
-    var $compiler_file        =    'Smarty_Compiler.class.php';
-
-    /**
-     * The class used for compiling templates.
-     *
-     * @var string
-     */
-    var $compiler_class        =   'Smarty_Compiler';
-
-    /**
-     * The class used to load config vars.
-     *
-     * @var string
-     */
-    var $config_class          =   'Config_File';
-
-/**#@+
- * END Smarty Configuration Section
- * There should be no need to touch anything below this line.
- * @access private
- */
-    /**
-     * where assigned template vars are kept
-     *
-     * @var array
-     */
-    var $_tpl_vars             = array();
-
-    /**
-     * stores run-time $smarty.* vars
-     *
-     * @var null|array
-     */
-    var $_smarty_vars          = null;
-
-    /**
-     * keeps track of sections
-     *
-     * @var array
-     */
-    var $_sections             = array();
-
-    /**
-     * keeps track of foreach blocks
-     *
-     * @var array
-     */
-    var $_foreach              = array();
-
-    /**
-     * keeps track of tag hierarchy
-     *
-     * @var array
-     */
-    var $_tag_stack            = array();
-
-    /**
-     * configuration object
-     *
-     * @var Config_file
-     */
-    var $_conf_obj             = null;
-
-    /**
-     * loaded configuration settings
-     *
-     * @var array
-     */
-    var $_config               = array(array('vars'  =&gt; array(), 'files' =&gt; array()));
-
-    /**
-     * md5 checksum of the string 'Smarty'
-     *
-     * @var string
-     */
-    var $_smarty_md5           = 'f8d698aea36fcbead2b9d5359ffca76f';
-
-    /**
-     * Smarty version number
-     *
-     * @var string
-     */
-    var $_version              = '2.6.5-dev';
-
-    /**
-     * current template inclusion depth
-     *
-     * @var integer
-     */
-    var $_inclusion_depth      = 0;
-
-    /**
-     * for different compiled templates
-     *
-     * @var string
-     */
-    var $_compile_id           = null;
-
-    /**
-     * text in URL to enable debug mode
-     *
-     * @var string
-     */
-    var $_smarty_debug_id      = 'SMARTY_DEBUG';
-
-    /**
-     * debugging information for debug console
-     *
-     * @var array
-     */
-    var $_smarty_debug_info    = array();
-
-    /**
-     * info that makes up a cache file
-     *
-     * @var array
-     */
-    var $_cache_info           = array();
-
-    /**
-     * default file permissions
-     *
-     * @var integer
-     */
-    var $_file_perms           = 0644;
-
-    /**
-     * default dir permissions
-     *
-     * @var integer
-     */
-    var $_dir_perms               = 0771;
-
-    /**
-     * registered objects
-     *
-     * @var array
-     */
-    var $_reg_objects           = array();
-
-    /**
-     * table keeping track of plugins
-     *
-     * @var array
-     */
-    var $_plugins              = array(
-                                       'modifier'      =&gt; array(),
-                                       'function'      =&gt; array(),
-                                       'block'         =&gt; array(),
-                                       'compiler'      =&gt; array(),
-                                       'prefilter'     =&gt; array(),
-                                       'postfilter'    =&gt; array(),
-                                       'outputfilter'  =&gt; array(),
-                                       'resource'      =&gt; array(),
-                                       'insert'        =&gt; array());
-
-
-    /**
-     * cache serials
-     *
-     * @var array
-     */
-    var $_cache_serials = array();
-
-    /**
-     * name of optional cache include file
-     *
-     * @var string
-     */
-    var $_cache_include = null;
-
-    /**
-     * indicate if the current code is used in a compiled
-     * include
-     *
-     * @var string
-     */
-    var $_cache_including = false;
-
-    /**#@-*/
-    /**
-     * The class constructor.
-     */
-    function Smarty()
-    {
-      $this-&gt;assign('SCRIPT_NAME', isset($_SERVER['SCRIPT_NAME']) ? $_SERVER['SCRIPT_NAME']
-                    : @$GLOBALS['HTTP_SERVER_VARS']['SCRIPT_NAME']);
-    }
-
-    /**
-     * assigns values to template variables
-     *
-     * @param array|string $tpl_var the template variable name(s)
-     * @param mixed $value the value to assign
-     */
-    function assign($tpl_var, $value = null)
-    {
-        if (is_array($tpl_var)){
-            foreach ($tpl_var as $key =&gt; $val) {
-                if ($key != '') {
-                    $this-&gt;_tpl_vars[$key] = $val;
-                }
-            }
-        } else {
-            if ($tpl_var != '')
-                $this-&gt;_tpl_vars[$tpl_var] = $value;
-        }
-    }
-
-    /**
-     * assigns values to template variables by reference
-     *
-     * @param string $tpl_var the template variable name
-     * @param mixed $value the referenced value to assign
-     */
-    function assign_by_ref($tpl_var, &amp;$value)
-    {
-        if ($tpl_var != '')
-            $this-&gt;_tpl_vars[$tpl_var] = &amp;$value;
-    }
-
-    /**
-     * appends values to template variables
-     *
-     * @param array|string $tpl_var the template variable name(s)
-     * @param mixed $value the value to append
-     */
-    function append($tpl_var, $value=null, $merge=false)
-    {
-        if (is_array($tpl_var)) {
-            // $tpl_var is an array, ignore $value
-            foreach ($tpl_var as $_key =&gt; $_val) {
-                if ($_key != '') {
-                    if(!@is_array($this-&gt;_tpl_vars[$_key])) {
-                        settype($this-&gt;_tpl_vars[$_key],'array');
-                    }
-                    if($merge &amp;&amp; is_array($_val)) {
-                        foreach($_val as $_mkey =&gt; $_mval) {
-                            $this-&gt;_tpl_vars[$_key][$_mkey] = $_mval;
-                        }
-                    } else {
-                        $this-&gt;_tpl_vars[$_key][] = $_val;
-                    }
-                }
-            }
-        } else {
-            if ($tpl_var != '' &amp;&amp; isset($value)) {
-                if(!@is_array($this-&gt;_tpl_vars[$tpl_var])) {
-                    settype($this-&gt;_tpl_vars[$tpl_var],'array');
-                }
-                if($merge &amp;&amp; is_array($value)) {
-                    foreach($value as $_mkey =&gt; $_mval) {
-                        $this-&gt;_tpl_vars[$tpl_var][$_mkey] = $_mval;
-                    }
-                } else {
-                    $this-&gt;_tpl_vars[$tpl_var][] = $value;
-                }
-            }
-        }
-    }
-
-    /**
-     * appends values to template variables by reference
-     *
-     * @param string $tpl_var the template variable name
-     * @param mixed $value the referenced value to append
-     */
-    function append_by_ref($tpl_var, &amp;$value, $merge=false)
-    {
-        if ($tpl_var != '' &amp;&amp; isset($value)) {
-            if(!@is_array($this-&gt;_tpl_vars[$tpl_var])) {
-             settype($this-&gt;_tpl_vars[$tpl_var],'array');
-            }
-            if ($merge &amp;&amp; is_array($value)) {
-                foreach($value as $_key =&gt; $_val) {
-                    $this-&gt;_tpl_vars[$tpl_var][$_key] = &amp;$value[$_key];
-                }
-            } else {
-                $this-&gt;_tpl_vars[$tpl_var][] = &amp;$value;
-            }
-        }
-    }
-
-
-    /**
-     * clear the given assigned template variable.
-     *
-     * @param string $tpl_var the template variable to clear
-     */
-    function clear_assign($tpl_var)
-    {
-        if (is_array($tpl_var))
-            foreach ($tpl_var as $curr_var)
-                unset($this-&gt;_tpl_vars[$curr_var]);
-        else
-            unset($this-&gt;_tpl_vars[$tpl_var]);
-    }
-
-
-    /**
-     * Registers custom function to be used in templates
-     *
-     * @param string $function the name of the template function
-     * @param string $function_impl the name of the PHP function to register
-     */
-    function register_function($function, $function_impl, $cacheable=true, $cache_attrs=null)
-    {
-        $this-&gt;_plugins['function'][$function] =
-            array($function_impl, null, null, false, $cacheable, $cache_attrs);
-
-    }
-
-    /**
-     * Unregisters custom function
-     *
-     * @param string $function name of template function
-     */
-    function unregister_function($function)
-    {
-        unset($this-&gt;_plugins['function'][$function]);
-    }
-
-    /**
-     * Registers object to be used in templates
-     *
-     * @param string $object name of template object
-     * @param object &amp;$object_impl the referenced PHP object to register
-     * @param null|array $allowed list of allowed methods (empty = all)
-     * @param boolean $smarty_args smarty argument format, else traditional
-     * @param null|array $block_functs list of methods that are block format
-     */
-    function register_object($object, &amp;$object_impl, $allowed = array(), $smarty_args = true, $block_methods = array())
-    {
-        settype($allowed, 'array');
-        settype($smarty_args, 'boolean');
-        $this-&gt;_reg_objects[$object] =
-            array(&amp;$object_impl, $allowed, $smarty_args, $block_methods);
-    }
-
-    /**
-     * Unregisters object
-     *
-     * @param string $object name of template object
-     */
-    function unregister_object($object)
-    {
-        unset($this-&gt;_reg_objects[$object]);
-    }
-
-
-    /**
-     * Registers block function to be used in templates
-     *
-     * @param string $block name of template block
-     * @param string $block_impl PHP function to register
-     */
-    function register_block($block, $block_impl, $cacheable=true, $cache_attrs=null)
-    {
-        $this-&gt;_plugins['block'][$block] =
-            array($block_impl, null, null, false, $cacheable, $cache_attrs);
-    }
-
-    /**
-     * Unregisters block function
-     *
-     * @param string $block name of template function
-     */
-    function unregister_block($block)
-    {
-        unset($this-&gt;_plugins['block'][$block]);
-    }
-
-    /**
-     * Registers compiler function
-     *
-     * @param string $function name of template function
-     * @param string $function_impl name of PHP function to register
-     */
-    function register_compiler_function($function, $function_impl, $cacheable=true)
-    {
-        $this-&gt;_plugins['compiler'][$function] =
-            array($function_impl, null, null, false, $cacheable);
-    }
-
-    /**
-     * Unregisters compiler function
-     *
-     * @param string $function name of template function
-     */
-    function unregister_compiler_function($function)
-    {
-        unset($this-&gt;_plugins['compiler'][$function]);
-    }
-
-    /**
-     * Registers modifier to be used in templates
-     *
-     * @param string $modifier name of template modifier
-     * @param string $modifier_impl name of PHP function to register
-     */
-    function register_modifier($modifier, $modifier_impl)
-    {
-        $this-&gt;_plugins['modifier'][$modifier] =
-            array($modifier_impl, null, null, false);
-    }
-
-    /**
-     * Unregisters modifier
-     *
-     * @param string $modifier name of template modifier
-     */
-    function unregister_modifier($modifier)
-    {
-        unset($this-&gt;_plugins['modifier'][$modifier]);
-    }
-
-    /**
-     * Registers a resource to fetch a template
-     *
-     * @param string $type name of resource
-     * @param array $functions array of functions to handle resource
-     */
-    function register_resource($type, $functions)
-    {
-        if (count($functions)==4) {
-            $this-&gt;_plugins['resource'][$type] =
-                array($functions, false);
-
-        } elseif (count($functions)==5) {
-            $this-&gt;_plugins['resource'][$type] =
-                array(array(array(&amp;$functions[0], $functions[1])
-                            ,array(&amp;$functions[0], $functions[2])
-                            ,array(&amp;$functions[0], $functions[3])
-                            ,array(&amp;$functions[0], $functions[4]))
-                      ,false);
-
-        } else {
-            $this-&gt;trigger_error(&quot;malformed function-list for '$type' in register_resource&quot;);
-
-        }
-    }
-
-    /**
-     * Unregisters a resource
-     *
-     * @param string $type name of resource
-     */
-    function unregister_resource($type)
-    {
-        unset($this-&gt;_plugins['resource'][$type]);
-    }
-
-    /**
-     * Registers a prefilter function to apply
-     * to a template before compiling
-     *
-     * @param string $function name of PHP function to register
-     */
-    function register_prefilter($function)
-    {
-    $_name = (is_array($function)) ? $function[1] : $function;
-        $this-&gt;_plugins['prefilter'][$_name]
-            = array($function, null, null, false);
-    }
-
-    /**
-     * Unregisters a prefilter function
-     *
-     * @param string $function name of PHP function
-     */
-    function unregister_prefilter($function)
-    {
-        unset($this-&gt;_plugins['prefilter'][$function]);
-    }
-
-    /**
-     * Registers a postfilter function to apply
-     * to a compiled template after compilation
-     *
-     * @param string $function name of PHP function to register
-     */
-    function register_postfilter($function)
-    {
-    $_name = (is_array($function)) ? $function[1] : $function;
-        $this-&gt;_plugins['postfilter'][$_name]
-            = array($function, null, null, false);
-    }
-
-    /**
-     * Unregisters a postfilter function
-     *
-     * @param string $function name of PHP function
-     */
-    function unregister_postfilter($function)
-    {
-        unset($this-&gt;_plugins['postfilter'][$function]);
-    }
-
-    /**
-     * Registers an output filter function to apply
-     * to a template output
-     *
-     * @param string $function name of PHP function
-     */
-    function register_outputfilter($function)
-    {
-    $_name = (is_array($function)) ? $function[1] : $function;
-        $this-&gt;_plugins['outputfilter'][$_name]
-            = array($function, null, null, false);
-    }
-
-    /**
-     * Unregisters an outputfilter function
-     *
-     * @param string $function name of PHP function
-     */
-    function unregister_outputfilter($function)
-    {
-        unset($this-&gt;_plugins['outputfilter'][$function]);
-    }
-
-    /**
-     * load a filter of specified type and name
-     *
-     * @param string $type filter type
-     * @param string $name filter name
-     */
-    function load_filter($type, $name)
-    {
-        switch ($type) {
-            case 'output':
-                $_params = array('plugins' =&gt; array(array($type . 'filter', $name, null, null, false)));
-                require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.load_plugins.php');
-                smarty_core_load_plugins($_params, $this);
-                break;
-
-            case 'pre':
-            case 'post':
-                if (!isset($this-&gt;_plugins[$type . 'filter'][$name]))
-                    $this-&gt;_plugins[$type . 'filter'][$name] = false;
-                break;
-        }
-    }
-
-    /**
-     * clear cached content for the given template and cache id
-     *
-     * @param string $tpl_file name of template file
-     * @param string $cache_id name of cache_id
-     * @param string $compile_id name of compile_id
-     * @param string $exp_time expiration time
-     * @return boolean
-     */
-    function clear_cache($tpl_file = null, $cache_id = null, $compile_id = null, $exp_time = null)
-    {
-
-        if (!isset($compile_id))
-            $compile_id = $this-&gt;compile_id;
-
-        if (!isset($tpl_file))
-            $compile_id = null;
-
-        $_auto_id = $this-&gt;_get_auto_id($cache_id, $compile_id);
-
-        if (!empty($this-&gt;cache_handler_func)) {
-            return call_user_func_array($this-&gt;cache_handler_func,
-                                  array('clear', &amp;$this, &amp;$dummy, $tpl_file, $cache_id, $compile_id, $exp_time));
-        } else {
-            $_params = array('auto_base' =&gt; $this-&gt;cache_dir,
-                            'auto_source' =&gt; $tpl_file,
-                            'auto_id' =&gt; $_auto_id,
-                            'exp_time' =&gt; $exp_time);
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.rm_auto.php');
-            return smarty_core_rm_auto($_params, $this);
-        }
-
-    }
-
-
-    /**
-     * clear the entire contents of cache (all templates)
-     *
-     * @param string $exp_time expire time
-     * @return boolean results of {@link smarty_core_rm_auto()}
-     */
-    function clear_all_cache($exp_time = null)
-    {
-        return $this-&gt;clear_cache(null, null, null, $exp_time);
-    }
-
-
-    /**
-     * test to see if valid cache exists for this template
-     *
-     * @param string $tpl_file name of template file
-     * @param string $cache_id
-     * @param string $compile_id
-     * @return string|false results of {@link _read_cache_file()}
-     */
-    function is_cached($tpl_file, $cache_id = null, $compile_id = null)
-    {
-        if (!$this-&gt;caching)
-            return false;
-
-        if (!isset($compile_id))
-            $compile_id = $this-&gt;compile_id;
-
-        $_params = array(
-            'tpl_file' =&gt; $tpl_file,
-            'cache_id' =&gt; $cache_id,
-            'compile_id' =&gt; $compile_id
-        );
-        require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.read_cache_file.php');
-        return smarty_core_read_cache_file($_params, $this);
-    }
-
-
-    /**
-     * clear all the assigned template variables.
-     *
-     */
-    function clear_all_assign()
-    {
-        $this-&gt;_tpl_vars = array();
-    }
-
-    /**
-     * clears compiled version of specified template resource,
-     * or all compiled template files if one is not specified.
-     * This function is for advanced use only, not normally needed.
-     *
-     * @param string $tpl_file
-     * @param string $compile_id
-     * @param string $exp_time
-     * @return boolean results of {@link smarty_core_rm_auto()}
-     */
-    function clear_compiled_tpl($tpl_file = null, $compile_id = null, $exp_time = null)
-    {
-        if (!isset($compile_id)) {
-            $compile_id = $this-&gt;compile_id;
-        }
-        $_params = array('auto_base' =&gt; $this-&gt;compile_dir,
-                        'auto_source' =&gt; $tpl_file,
-                        'auto_id' =&gt; $compile_id,
-                        'exp_time' =&gt; $exp_time,
-                        'extensions' =&gt; array('.inc', '.php'));
-        require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.rm_auto.php');
-        return smarty_core_rm_auto($_params, $this);
-    }
-
-    /**
-     * Checks whether requested template exists.
-     *
-     * @param string $tpl_file
-     * @return boolean
-     */
-    function template_exists($tpl_file)
-    {
-        $_params = array('resource_name' =&gt; $tpl_file, 'quiet'=&gt;true, 'get_source'=&gt;false);
-        return $this-&gt;_fetch_resource_info($_params);
-    }
-
-    /**
-     * Returns an array containing template variables
-     *
-     * @param string $name
-     * @param string $type
-     * @return array
-     */
-    function &amp;get_template_vars($name=null)
-    {
-        if(!isset($name)) {
-            return $this-&gt;_tpl_vars;
-        }
-        if(isset($this-&gt;_tpl_vars[$name])) {
-            return $this-&gt;_tpl_vars[$name];
-        }
-    }
-
-    /**
-     * Returns an array containing config variables
-     *
-     * @param string $name
-     * @param string $type
-     * @return array
-     */
-    function &amp;get_config_vars($name=null)
-    {
-        if(!isset($name) &amp;&amp; is_array($this-&gt;_config[0])) {
-            return $this-&gt;_config[0]['vars'];
-        } else if(isset($this-&gt;_config[0]['vars'][$name])) {
-            return $this-&gt;_config[0]['vars'][$name];
-        }
-    }
-
-    /**
-     * trigger Smarty error
-     *
-     * @param string $error_msg
-     * @param integer $error_type
-     */
-    function trigger_error($error_msg, $error_type = E_USER_WARNING)
-    {
-        trigger_error(&quot;Smarty error: $error_msg&quot;, $error_type);
-    }
-
-
-    /**
-     * executes &amp; displays the template results
-     *
-     * @param string $resource_name
-     * @param string $cache_id
-     * @param string $compile_id
-     */
-    function display($resource_name, $cache_id = null, $compile_id = null)
-    {
-        $this-&gt;fetch($resource_name, $cache_id, $compile_id, true);
-    }
-
-    /**
-     * executes &amp; returns or displays the template results
-     *
-     * @param string $resource_name
-     * @param string $cache_id
-     * @param string $compile_id
-     * @param boolean $display
-     */
-    function fetch($resource_name, $cache_id = null, $compile_id = null, $display = false)
-    {
-        static $_cache_info = array();
-        
-        $_smarty_old_error_level = $this-&gt;debugging ? error_reporting() : error_reporting(isset($this-&gt;error_reporting)
-               ? $this-&gt;error_reporting : error_reporting() &amp; ~E_NOTICE);
-
-        if (!$this-&gt;debugging &amp;&amp; $this-&gt;debugging_ctrl == 'URL') {
-            $_query_string = $this-&gt;request_use_auto_globals ? $_SERVER['QUERY_STRING'] : $GLOBALS['HTTP_SERVER_VARS']['QUERY_STRING'];
-            if (@strstr($_query_string, $this-&gt;_smarty_debug_id)) {
-                if (@strstr($_query_string, $this-&gt;_smarty_debug_id . '=on')) {
-                    // enable debugging for this browser session
-                    @setcookie('SMARTY_DEBUG', true);
-                    $this-&gt;debugging = true;
-                } elseif (@strstr($_query_string, $this-&gt;_smarty_debug_id . '=off')) {
-                    // disable debugging for this browser session
-                    @setcookie('SMARTY_DEBUG', false);
-                    $this-&gt;debugging = false;
-                } else {
-                    // enable debugging for this page
-                    $this-&gt;debugging = true;
-                }
-            } else {
-                $_cookie_var = $this-&gt;request_use_auto_globals ? $_COOKIE['SMARTY_DEBUG'] : $GLOBALS['HTTP_COOKIE_VARS']['SMARTY_DEBUG'];
-                $this-&gt;debugging = $_cookie_var ? true : false;
-            }
-        }
-
-        if ($this-&gt;debugging) {
-            // capture time for debugging info
-            $_params = array();
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.get_microtime.php');
-            $_debug_start_time = smarty_core_get_microtime($_params, $this);
-            $this-&gt;_smarty_debug_info[] = array('type'      =&gt; 'template',
-                                                'filename'  =&gt; $resource_name,
-                                                'depth'     =&gt; 0);
-            $_included_tpls_idx = count($this-&gt;_smarty_debug_info) - 1;
-        }
-
-        if (!isset($compile_id)) {
-            $compile_id = $this-&gt;compile_id;
-        }
-
-        $this-&gt;_compile_id = $compile_id;
-        $this-&gt;_inclusion_depth = 0;
-
-        if ($this-&gt;caching) {
-            // save old cache_info, initialize cache_info
-            array_push($_cache_info, $this-&gt;_cache_info);
-            $this-&gt;_cache_info = array();
-            $_params = array(
-                'tpl_file' =&gt; $resource_name,
-                'cache_id' =&gt; $cache_id,
-                'compile_id' =&gt; $compile_id,
-                'results' =&gt; null
-            );
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.read_cache_file.php');
-            if (smarty_core_read_cache_file($_params, $this)) {
-                $_smarty_results = $_params['results'];
-                if (@count($this-&gt;_cache_info['insert_tags'])) {
-                    $_params = array('plugins' =&gt; $this-&gt;_cache_info['insert_tags']);
-                    require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.load_plugins.php');
-                    smarty_core_load_plugins($_params, $this);
-                    $_params = array('results' =&gt; $_smarty_results);
-                    require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.process_cached_inserts.php');
-                    $_smarty_results = smarty_core_process_cached_inserts($_params, $this);
-                }
-                if (@count($this-&gt;_cache_info['cache_serials'])) {
-                    $_params = array('results' =&gt; $_smarty_results);
-                    require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.process_compiled_include.php');
-                    $_smarty_results = smarty_core_process_compiled_include($_params, $this);
-                }
-
-
-                if ($display) {
-                    if ($this-&gt;debugging)
-                    {
-                        // capture time for debugging info
-                        $_params = array();
-                        require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.get_microtime.php');
-                        $this-&gt;_smarty_debug_info[$_included_tpls_idx]['exec_time'] = smarty_core_get_microtime($_params, $this) - $_debug_start_time;
-                        require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.display_debug_console.php');
-                        $_smarty_results .= smarty_core_display_debug_console($_params, $this);
-                    }
-                    if ($this-&gt;cache_modified_check) {
-                        $_server_vars = ($this-&gt;request_use_auto_globals) ? $_SERVER : $GLOBALS['HTTP_SERVER_VARS'];
-                        $_last_modified_date = @substr($_server_vars['HTTP_IF_MODIFIED_SINCE'], 0, strpos($_server_vars['HTTP_IF_MODIFIED_SINCE'], 'GMT') + 3);
-                        $_gmt_mtime = gmdate('D, d M Y H:i:s', $this-&gt;_cache_info['timestamp']).' GMT';
-                        if (@count($this-&gt;_cache_info['insert_tags']) == 0
-                            &amp;&amp; !$this-&gt;_cache_serials
-                            &amp;&amp; $_gmt_mtime == $_last_modified_date) {
-                            if (php_sapi_name()=='cgi')
-                                header('Status: 304 Not Modified');
-                            else
-                                header('HTTP/1.1 304 Not Modified');
-
-                        } else {
-                            header('Last-Modified: '.$_gmt_mtime);
-                            echo $_smarty_results;
-                        }
-                    } else {
-                            echo $_smarty_results;
-                    }
-                    error_reporting($_smarty_old_error_level);
-                    // restore initial cache_info
-                    $this-&gt;_cache_info = array_pop($_cache_info);
-                    return true;
-                } else {
-                    error_reporting($_smarty_old_error_level);
-                    // restore initial cache_info
-                    $this-&gt;_cache_info = array_pop($_cache_info);
-                    return $_smarty_results;
-                }
-            } else {
-                $this-&gt;_cache_info['template'][$resource_name] = true;
-                if ($this-&gt;cache_modified_check &amp;&amp; $display) {
-                    header('Last-Modified: '.gmdate('D, d M Y H:i:s', time()).' GMT');
-                }
-            }
-        }
-
-        // load filters that are marked as autoload
-        if (count($this-&gt;autoload_filters)) {
-            foreach ($this-&gt;autoload_filters as $_filter_type =&gt; $_filters) {
-                foreach ($_filters as $_filter) {
-                    $this-&gt;load_filter($_filter_type, $_filter);
-                }
-            }
-        }
-
-        $_smarty_compile_path = $this-&gt;_get_compile_path($resource_name);
-
-        // if we just need to display the results, don't perform output
-        // buffering - for speed
-        $_cache_including = $this-&gt;_cache_including;
-        $this-&gt;_cache_including = false;
-        if ($display &amp;&amp; !$this-&gt;caching &amp;&amp; count($this-&gt;_plugins['outputfilter']) == 0) {
-            if ($this-&gt;_is_compiled($resource_name, $_smarty_compile_path)
-                    || $this-&gt;_compile_resource($resource_name, $_smarty_compile_path))
-            {
-                include($_smarty_compile_path);
-            }
-        } else {
-            ob_start();
-            if ($this-&gt;_is_compiled($resource_name, $_smarty_compile_path)
-                    || $this-&gt;_compile_resource($resource_name, $_smarty_compile_path))
-            {
-                include($_smarty_compile_path);
-            }
-            $_smarty_results = ob_get_contents();
-            ob_end_clean();
-
-            foreach ((array)$this-&gt;_plugins['outputfilter'] as $_output_filter) {
-                $_smarty_results = call_user_func_array($_output_filter[0], array($_smarty_results, &amp;$this));
-            }
-        }
-
-        if ($this-&gt;caching) {
-            $_params = array('tpl_file' =&gt; $resource_name,
-                        'cache_id' =&gt; $cache_id,
-                        'compile_id' =&gt; $compile_id,
-                        'results' =&gt; $_smarty_results);
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.write_cache_file.php');
-            smarty_core_write_cache_file($_params, $this);
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.process_cached_inserts.php');
-            $_smarty_results = smarty_core_process_cached_inserts($_params, $this);
-
-            if ($this-&gt;_cache_serials) {
-                // strip nocache-tags from output
-                $_smarty_results = preg_replace('!(\{/?nocache\:[0-9a-f]{32}#\d+\})!s'
-                                                ,''
-                                                ,$_smarty_results);
-            }
-            // restore initial cache_info
-            $this-&gt;_cache_info = array_pop($_cache_info);
-        }
-        $this-&gt;_cache_including = $_cache_including;
-
-        if ($display) {
-            if (isset($_smarty_results)) { echo $_smarty_results; }
-            if ($this-&gt;debugging) {
-                // capture time for debugging info
-                $_params = array();
-                require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.get_microtime.php');
-                $this-&gt;_smarty_debug_info[$_included_tpls_idx]['exec_time'] = (smarty_core_get_microtime($_params, $this) - $_debug_start_time);
-                require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.display_debug_console.php');
-                echo smarty_core_display_debug_console($_params, $this);
-            }
-            error_reporting($_smarty_old_error_level);
-            return;
-        } else {
-            error_reporting($_smarty_old_error_level);
-            if (isset($_smarty_results)) { return $_smarty_results; }
-        }
-    }
-
-    /**
-     * load configuration values
-     *
-     * @param string $file
-     * @param string $section
-     * @param string $scope
-     */
-    function config_load($file, $section = null, $scope = 'global')
-    {
-        require_once($this-&gt;_get_plugin_filepath('function', 'config_load'));
-        smarty_function_config_load(array('file' =&gt; $file, 'section' =&gt; $section, 'scope' =&gt; $scope), $this);
-    }
-
-    /**
-     * return a reference to a registered object
-     *
-     * @param string $name
-     * @return object
-     */
-    function &amp;get_registered_object($name) {
-        if (!isset($this-&gt;_reg_objects[$name]))
-        $this-&gt;_trigger_fatal_error(&quot;'$name' is not a registered object&quot;);
-
-        if (!is_object($this-&gt;_reg_objects[$name][0]))
-        $this-&gt;_trigger_fatal_error(&quot;registered '$name' is not an object&quot;);
-
-        return $this-&gt;_reg_objects[$name][0];
-    }
-
-    /**
-     * clear configuration values
-     *
-     * @param string $var
-     */
-    function clear_config($var = null)
-    {
-        if(!isset($var)) {
-            // clear all values
-            $this-&gt;_config = array(array('vars'  =&gt; array(),
-                                         'files' =&gt; array()));
-        } else {
-            unset($this-&gt;_config[0]['vars'][$var]);
-        }
-    }
-
-    /**
-     * get filepath of requested plugin
-     *
-     * @param string $type
-     * @param string $name
-     * @return string|false
-     */
-    function _get_plugin_filepath($type, $name)
-    {
-        $_params = array('type' =&gt; $type, 'name' =&gt; $name);
-        require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.assemble_plugin_filepath.php');
-        return smarty_core_assemble_plugin_filepath($_params, $this);
-    }
-
-   /**
-     * test if resource needs compiling
-     *
-     * @param string $resource_name
-     * @param string $compile_path
-     * @return boolean
-     */
-    function _is_compiled($resource_name, $compile_path)
-    {
-        if (!$this-&gt;force_compile &amp;&amp; file_exists($compile_path)) {
-            if (!$this-&gt;compile_check) {
-                // no need to check compiled file
-                return true;
-            } else {
-                // get file source and timestamp
-                $_params = array('resource_name' =&gt; $resource_name, 'get_source'=&gt;false);
-                if (!$this-&gt;_fetch_resource_info($_params)) {
-                    return false;
-                }
-                if ($_params['resource_timestamp'] &lt;= filemtime($compile_path)) {
-                    // template not expired, no recompile
-                    return true;
-                } else {
-                    // compile template
-                    return false;
-                }
-            }
-        } else {
-            // compiled template does not exist, or forced compile
-            return false;
-        }
-    }
-
-   /**
-     * compile the template
-     *
-     * @param string $resource_name
-     * @param string $compile_path
-     * @return boolean
-     */
-    function _compile_resource($resource_name, $compile_path)
-    {
-
-        $_params = array('resource_name' =&gt; $resource_name);
-        if (!$this-&gt;_fetch_resource_info($_params)) {
-            return false;
-        }
-
-        $_source_content = $_params['source_content'];
-        $_cache_include    = substr($compile_path, 0, -4).'.inc';
-
-        if ($this-&gt;_compile_source($resource_name, $_source_content, $_compiled_content, $_cache_include)) {
-            // if a _cache_serial was set, we also have to write an include-file:
-            if ($this-&gt;_cache_include_info) {
-                require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.write_compiled_include.php');
-                smarty_core_write_compiled_include(array_merge($this-&gt;_cache_include_info, array('compiled_content'=&gt;$_compiled_content)),  $this);
-            }
-
-            $_params = array('compile_path'=&gt;$compile_path, 'compiled_content' =&gt; $_compiled_content);
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.write_compiled_resource.php');
-            smarty_core_write_compiled_resource($_params, $this);
-
-            return true;
-        } else {
-            return false;
-        }
-
-    }
-
-   /**
-     * compile the given source
-     *
-     * @param string $resource_name
-     * @param string $source_content
-     * @param string $compiled_content
-     * @return boolean
-     */
-    function _compile_source($resource_name, &amp;$source_content, &amp;$compiled_content, $cache_include_path=null)
-    {
-        if (file_exists(SMARTY_DIR . $this-&gt;compiler_file)) {
-            require_once(SMARTY_DIR . $this-&gt;compiler_file);
-        } else {
-            // use include_path
-            require_once($this-&gt;compiler_file);
-        }
-
-
-        $smarty_compiler = new $this-&gt;compiler_class;
-
-        $smarty_compiler-&gt;template_dir      = $this-&gt;template_dir;
-        $smarty_compiler-&gt;compile_dir       = $this-&gt;compile_dir;
-        $smarty_compiler-&gt;plugins_dir       = $this-&gt;plugins_dir;
-        $smarty_compiler-&gt;config_dir        = $this-&gt;config_dir;
-        $smarty_compiler-&gt;force_compile     = $this-&gt;force_compile;
-        $smarty_compiler-&gt;caching           = $this-&gt;caching;
-        $smarty_compiler-&gt;php_handling      = $this-&gt;php_handling;
-        $smarty_compiler-&gt;left_delimiter    = $this-&gt;left_delimiter;
-        $smarty_compiler-&gt;right_delimiter   = $this-&gt;right_delimiter;
-        $smarty_compiler-&gt;_version          = $this-&gt;_version;
-        $smarty_compiler-&gt;security          = $this-&gt;security;
-        $smarty_compiler-&gt;secure_dir        = $this-&gt;secure_dir;
-        $smarty_compiler-&gt;security_settings = $this-&gt;security_settings;
-        $smarty_compiler-&gt;trusted_dir       = $this-&gt;trusted_dir;
-        $smarty_compiler-&gt;use_sub_dirs      = $this-&gt;use_sub_dirs;
-        $smarty_compiler-&gt;_reg_objects      = &amp;$this-&gt;_reg_objects;
-        $smarty_compiler-&gt;_plugins          = &amp;$this-&gt;_plugins;
-        $smarty_compiler-&gt;_tpl_vars         = &amp;$this-&gt;_tpl_vars;
-        $smarty_compiler-&gt;default_modifiers = $this-&gt;default_modifiers;
-        $smarty_compiler-&gt;compile_id        = $this-&gt;_compile_id;
-        $smarty_compiler-&gt;_config            = $this-&gt;_config;
-        $smarty_compiler-&gt;request_use_auto_globals  = $this-&gt;request_use_auto_globals;
-
-        $smarty_compiler-&gt;_cache_serial = null;
-        $smarty_compiler-&gt;_cache_include = $cache_include_path;
-
-
-        $_results = $smarty_compiler-&gt;_compile_file($resource_name, $source_content, $compiled_content);
-
-        if ($smarty_compiler-&gt;_cache_serial) {
-            $this-&gt;_cache_include_info = array(
-                'cache_serial'=&gt;$smarty_compiler-&gt;_cache_serial
-                ,'plugins_code'=&gt;$smarty_compiler-&gt;_plugins_code
-                ,'include_file_path' =&gt; $cache_include_path);
-
-        } else {
-            $this-&gt;_cache_include_info = null;
-
-        }
-
-        return $_results;
-    }
-
-    /**
-     * Get the compile path for this resource
-     *
-     * @param string $resource_name
-     * @return string results of {@link _get_auto_filename()}
-     */
-    function _get_compile_path($resource_name)
-    {
-        return $this-&gt;_get_auto_filename($this-&gt;compile_dir, $resource_name,
-                                         $this-&gt;_compile_id) . '.php';
-    }
-
-    /**
-     * fetch the template info. Gets timestamp, and source
-     * if get_source is true
-     *
-     * sets $source_content to the source of the template, and
-     * $resource_timestamp to its time stamp
-     * @param string $resource_name
-     * @param string $source_content
-     * @param integer $resource_timestamp
-     * @param boolean $get_source
-     * @param boolean $quiet
-     * @return boolean
-     */
-
-    function _fetch_resource_info(&amp;$params)
-    {
-        if(!isset($params['get_source'])) { $params['get_source'] = true; }
-        if(!isset($params['quiet'])) { $params['quiet'] = false; }
-
-        $_return = false;
-        $_params = array('resource_name' =&gt; $params['resource_name']) ;
-        if (isset($params['resource_base_path']))
-            $_params['resource_base_path'] = $params['resource_base_path'];
-        else
-            $_params['resource_base_path'] = $this-&gt;template_dir;
-
-        if ($this-&gt;_parse_resource_name($_params)) {
-            $_resource_type = $_params['resource_type'];
-            $_resource_name = $_params['resource_name'];
-            switch ($_resource_type) {
-                case 'file':
-                    if ($params['get_source']) {
-                        $params['source_content'] = $this-&gt;_read_file($_resource_name);
-                    }
-                    $params['resource_timestamp'] = filemtime($_resource_name);
-                    $_return = is_file($_resource_name);
-                    break;
-
-                default:
-                    // call resource functions to fetch the template source and timestamp
-                    if ($params['get_source']) {
-                        $_source_return = isset($this-&gt;_plugins['resource'][$_resource_type]) &amp;&amp;
-                            call_user_func_array($this-&gt;_plugins['resource'][$_resource_type][0][0],
-                                                 array($_resource_name, &amp;$params['source_content'], &amp;$this));
-                    } else {
-                        $_source_return = true;
-                    }
-
-                    $_timestamp_return = isset($this-&gt;_plugins['resource'][$_resource_type]) &amp;&amp;
-                        call_user_func_array($this-&gt;_plugins['resource'][$_resource_type][0][1],
-                                             array($_resource_name, &amp;$params['resource_timestamp'], &amp;$this));
-
-                    $_return = $_source_return &amp;&amp; $_timestamp_return;
-                    break;
-            }
-        }
-
-        if (!$_return) {
-            // see if we can get a template with the default template handler
-            if (!empty($this-&gt;default_template_handler_func)) {
-                if (!is_callable($this-&gt;default_template_handler_func)) {
-                    $this-&gt;trigger_error(&quot;default template handler function \&quot;$this-&gt;default_template_handler_func\&quot; doesn't exist.&quot;);
-                } else {
-                    $_return = call_user_func_array(
-                        $this-&gt;default_template_handler_func,
-                        array($_params['resource_type'], $_params['resource_name'], &amp;$params['source_content'], &amp;$params['resource_timestamp'], &amp;$this));
-                }
-            }
-        }
-
-        if (!$_return) {
-            if (!$params['quiet']) {
-                $this-&gt;trigger_error('unable to read resource: &quot;' . $params['resource_name'] . '&quot;');
-            }
-        } else if ($_return &amp;&amp; $this-&gt;security) {
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.is_secure.php');
-            if (!smarty_core_is_secure($_params, $this)) {
-                if (!$params['quiet'])
-                    $this-&gt;trigger_error('(secure mode) accessing &quot;' . $params['resource_name'] . '&quot; is not allowed');
-                $params['source_content'] = null;
-                $params['resource_timestamp'] = null;
-                return false;
-            }
-        }
-        return $_return;
-    }
-
-
-    /**
-     * parse out the type and name from the resource
-     *
-     * @param string $resource_base_path
-     * @param string $resource_name
-     * @param string $resource_type
-     * @param string $resource_name
-     * @return boolean
-     */
-
-    function _parse_resource_name(&amp;$params)
-    {
-
-        // split tpl_path by the first colon
-        $_resource_name_parts = explode(':', $params['resource_name'], 2);
-
-        if (count($_resource_name_parts) == 1) {
-            // no resource type given
-            $params['resource_type'] = $this-&gt;default_resource_type;
-            $params['resource_name'] = $_resource_name_parts[0];
-        } else {
-            if(strlen($_resource_name_parts[0]) == 1) {
-                // 1 char is not resource type, but part of filepath
-                $params['resource_type'] = $this-&gt;default_resource_type;
-                $params['resource_name'] = $params['resource_name'];
-            } else {
-                $params['resource_type'] = $_resource_name_parts[0];
-                $params['resource_name'] = $_resource_name_parts[1];
-            }
-        }
-
-        if ($params['resource_type'] == 'file') {
-            if (!preg_match('/^([\/\\\\]|[a-zA-Z]:[\/\\\\])/', $params['resource_name'])) {
-                // relative pathname to $params['resource_base_path']
-                // use the first directory where the file is found
-                foreach ((array)$params['resource_base_path'] as $_curr_path) {
-                    $_fullpath = $_curr_path . DIRECTORY_SEPARATOR . $params['resource_name'];
-                    if (file_exists($_fullpath) &amp;&amp; is_file($_fullpath)) {
-                        $params['resource_name'] = $_fullpath;
-                        return true;
-                    }
-                    // didn't find the file, try include_path
-                    $_params = array('file_path' =&gt; $_fullpath);
-                    require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.get_include_path.php');
-                    if(smarty_core_get_include_path($_params, $this)) {
-                        $params['resource_name'] = $_params['new_file_path'];
-                        return true;
-                    }
-                }
-                return false;
-            } else {
-                /* absolute path */
-                return file_exists($params['resource_name']);
-            }
-        } elseif (empty($this-&gt;_plugins['resource'][$params['resource_type']])) {
-            $_params = array('type' =&gt; $params['resource_type']);
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.load_resource_plugin.php');
-            smarty_core_load_resource_plugin($_params, $this);
-        }
-
-        return true;
-    }
-
-
-    /**
-     * Handle modifiers
-     *
-     * @param string|null $modifier_name
-     * @param array|null $map_array
-     * @return string result of modifiers
-     */
-    function _run_mod_handler()
-    {
-        $_args = func_get_args();
-        list($_modifier_name, $_map_array) = array_splice($_args, 0, 2);
-        list($_func_name, $_tpl_file, $_tpl_line) =
-            $this-&gt;_plugins['modifier'][$_modifier_name];
-
-        $_var = $_args[0];
-        foreach ($_var as $_key =&gt; $_val) {
-            $_args[0] = $_val;
-            $_var[$_key] = call_user_func_array($_func_name, $_args);
-        }
-        return $_var;
-    }
-
-    /**
-     * Remove starting and ending quotes from the string
-     *
-     * @param string $string
-     * @return string
-     */
-    function _dequote($string)
-    {
-        if (($string{0} == &quot;'&quot; || $string{0} == '&quot;') &amp;&amp;
-            $string{strlen($string)-1} == $string{0})
-            return substr($string, 1, -1);
-        else
-            return $string;
-    }
-
-
-    /**
-     * read in a file from line $start for $lines.
-     * read the entire file if $start and $lines are null.
-     *
-     * @param string $filename
-     * @param integer $start
-     * @param integer $lines
-     * @return string
-     */
-    function _read_file($filename)
-    {
-        if ( file_exists($filename) &amp;&amp; ($fd = @fopen($filename, 'rb')) ) {
-            $contents = ($size = filesize($filename)) ? fread($fd, $size) : '';
-            fclose($fd);
-            return $contents;
-        } else {
-            return false;
-        }
-    }
-
-    /**
-     * get a concrete filename for automagically created content
-     *
-     * @param string $auto_base
-     * @param string $auto_source
-     * @param string $auto_id
-     * @return string
-     * @staticvar string|null
-     * @staticvar string|null
-     */
-    function _get_auto_filename($auto_base, $auto_source = null, $auto_id = null)
-    {
-        $_compile_dir_sep =  $this-&gt;use_sub_dirs ? DIRECTORY_SEPARATOR : '^';
-        $_return = $auto_base . DIRECTORY_SEPARATOR;
-
-        if(isset($auto_id)) {
-            // make auto_id safe for directory names
-            $auto_id = str_replace('%7C',$_compile_dir_sep,(urlencode($auto_id)));
-            // split into separate directories
-            $_return .= $auto_id . $_compile_dir_sep;
-        }
-
-        if(isset($auto_source)) {
-            // make source name safe for filename
-            $_filename = urlencode(basename($auto_source));
-            $_crc32 = sprintf('%08X', crc32($auto_source));
-            // prepend %% to avoid name conflicts with
-            // with $params['auto_id'] names
-            $_crc32 = substr($_crc32, 0, 2) . $_compile_dir_sep .
-                      substr($_crc32, 0, 3) . $_compile_dir_sep . $_crc32;
-            $_return .= '%%' . $_crc32 . '%%' . $_filename;
-        }
-
-        return $_return;
-    }
-
-    /**
-     * unlink a file, possibly using expiration time
-     *
-     * @param string $resource
-     * @param integer $exp_time
-     */
-    function _unlink($resource, $exp_time = null)
-    {
-        if(isset($exp_time)) {
-            if(time() - @filemtime($resource) &gt;= $exp_time) {
-                return @unlink($resource);
-            }
-        } else {
-            return @unlink($resource);
-        }
-    }
-
-    /**
-     * returns an auto_id for auto-file-functions
-     *
-     * @param string $cache_id
-     * @param string $compile_id
-     * @return string|null
-     */
-    function _get_auto_id($cache_id=null, $compile_id=null) {
-    if (isset($cache_id))
-        return (isset($compile_id)) ? $cache_id . '|' . $compile_id  : $cache_id;
-    elseif(isset($compile_id))
-        return $compile_id;
-    else
-        return null;
-    }
-
-    /**
-     * trigger Smarty plugin error
-     *
-     * @param string $error_msg
-     * @param string $tpl_file
-     * @param integer $tpl_line
-     * @param string $file
-     * @param integer $line
-     * @param integer $error_type
-     */
-    function _trigger_fatal_error($error_msg, $tpl_file = null, $tpl_line = null,
-            $file = null, $line = null, $error_type = E_USER_ERROR)
-    {
-        if(isset($file) &amp;&amp; isset($line)) {
-            $info = ' ('.basename($file).&quot;, line $line)&quot;;
-        } else {
-            $info = '';
-        }
-        if (isset($tpl_line) &amp;&amp; isset($tpl_file)) {
-            $this-&gt;trigger_error('[in ' . $tpl_file . ' line ' . $tpl_line . &quot;]: $error_msg$info&quot;, $error_type);
-        } else {
-            $this-&gt;trigger_error($error_msg . $info, $error_type);
-        }
-    }
-
-
-    /**
-     * callback function for preg_replace, to call a non-cacheable block
-     * @return string
-     */
-    function _process_compiled_include_callback($match) {
-        $_func = '_smarty_tplfunc_'.$match[2].'_'.$match[3];
-        ob_start();
-        $_func($this);
-        $_ret = ob_get_contents();
-        ob_end_clean();
-        return $_ret;
-    }
-
-
-    /**
-     * called for included templates
-     *
-     * @param string $_smarty_include_tpl_file
-     * @param string $_smarty_include_vars
-     */
-
-    // $_smarty_include_tpl_file, $_smarty_include_vars
-
-    function _smarty_include($params)
-    {
-        if ($this-&gt;debugging) {
-            $_params = array();
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.get_microtime.php');
-            $debug_start_time = smarty_core_get_microtime($_params, $this);
-            $this-&gt;_smarty_debug_info[] = array('type'      =&gt; 'template',
-                                                  'filename'  =&gt; $params['smarty_include_tpl_file'],
-                                                  'depth'     =&gt; ++$this-&gt;_inclusion_depth);
-            $included_tpls_idx = count($this-&gt;_smarty_debug_info) - 1;
-        }
-
-        $this-&gt;_tpl_vars = array_merge($this-&gt;_tpl_vars, $params['smarty_include_vars']);
-
-        // config vars are treated as local, so push a copy of the
-        // current ones onto the front of the stack
-        array_unshift($this-&gt;_config, $this-&gt;_config[0]);
-
-        $_smarty_compile_path = $this-&gt;_get_compile_path($params['smarty_include_tpl_file']);
-
-
-        if ($this-&gt;_is_compiled($params['smarty_include_tpl_file'], $_smarty_compile_path)
-            || $this-&gt;_compile_resource($params['smarty_include_tpl_file'], $_smarty_compile_path))
-        {
-            include($_smarty_compile_path);
-        }
-
-        // pop the local vars off the front of the stack
-        array_shift($this-&gt;_config);
-
-        $this-&gt;_inclusion_depth--;
-
-        if ($this-&gt;debugging) {
-            // capture time for debugging info
-            $_params = array();
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.get_microtime.php');
-            $this-&gt;_smarty_debug_info[$included_tpls_idx]['exec_time'] = smarty_core_get_microtime($_params, $this) - $debug_start_time;
-        }
-
-        if ($this-&gt;caching) {
-            $this-&gt;_cache_info['template'][$params['smarty_include_tpl_file']] = true;
-        }
-    }
-
-
-    /**
-     * get or set an array of cached attributes for function that is
-     * not cacheable
-     * @return array
-     */
-    function &amp;_smarty_cache_attrs($cache_serial, $count) {
-        $_cache_attrs =&amp; $this-&gt;_cache_info['cache_attrs'][$cache_serial][$count];
-
-        if ($this-&gt;_cache_including) {
-            /* return next set of cache_attrs */
-            $_return =&amp; current($_cache_attrs);
-            next($_cache_attrs);
-            return $_return;
-
-        } else {
-            /* add a reference to a new set of cache_attrs */
-            $_cache_attrs[] = array();
-            return $_cache_attrs[count($_cache_attrs)-1];
-
-        }
-
-    }
-
-
-    /**
-     * wrapper for include() retaining $this
-     * @return mixed
-     */
-    function _include($filename, $once=false, $params=null)
-    {
-        if ($once) {
-            return include_once($filename);
-        } else {
-            return include($filename);
-        }
-    }
-
-
-    /**
-     * wrapper for eval() retaining $this
-     * @return mixed
-     */
-    function _eval($code, $params=null)
-    {
-        return eval($code);
-    }
-    /**#@-*/
-
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+
+/**
+ * Project:     Smarty: the PHP compiling template engine
+ * File:        Smarty.class.php
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * For questions, help, comments, discussion, etc., please join the
+ * Smarty mailing list. Send a blank e-mail to
+ * <A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">smarty-general-subscribe at lists.php.net</A>
+ *
+ * @link <A HREF="http://smarty.php.net/">http://smarty.php.net/</A>
+ * @copyright 2001-2005 New Digital Group, Inc.
+ * @author Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @author Andrei Zmievski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">andrei at php.net</A>&gt;
+ * @package Smarty
+ * @version 2.6.10
+ */
+
+/* $Id$ */
+
+/**
+ * DIR_SEP isn't used anymore, but third party apps might
+ */
+if(!defined('DIR_SEP')) {
+    define('DIR_SEP', DIRECTORY_SEPARATOR);
+}
+
+/**
+ * set SMARTY_DIR to absolute path to Smarty library files.
+ * if not defined, include_path will be used. Sets SMARTY_DIR only if user
+ * application has not already defined it.
+ */
+
+if (!defined('SMARTY_DIR')) {
+    define('SMARTY_DIR', dirname(__FILE__) . DIRECTORY_SEPARATOR);
+}
+
+if (!defined('SMARTY_CORE_DIR')) {
+    define('SMARTY_CORE_DIR', SMARTY_DIR . 'internals' . DIRECTORY_SEPARATOR);
+}
+
+define('SMARTY_PHP_PASSTHRU',   0);
+define('SMARTY_PHP_QUOTE',      1);
+define('SMARTY_PHP_REMOVE',     2);
+define('SMARTY_PHP_ALLOW',      3);
+
+/**
+ * @package Smarty
+ */
+class Smarty
+{
+    /**#@+
+     * Smarty Configuration Section
+     */
+
+    /**
+     * The name of the directory where templates are located.
+     *
+     * @var string
+     */
+    var $template_dir    =  'templates';
+
+    /**
+     * The directory where compiled templates are located.
+     *
+     * @var string
+     */
+    var $compile_dir     =  'templates_c';
+
+    /**
+     * The directory where config files are located.
+     *
+     * @var string
+     */
+    var $config_dir      =  'configs';
+
+    /**
+     * An array of directories searched for plugins.
+     *
+     * @var array
+     */
+    var $plugins_dir     =  array('plugins');
+
+    /**
+     * If debugging is enabled, a debug console window will display
+     * when the page loads (make sure your browser allows unrequested
+     * popup windows)
+     *
+     * @var boolean
+     */
+    var $debugging       =  false;
+
+    /**
+     * When set, smarty does uses this value as error_reporting-level.
+     *
+     * @var boolean
+     */
+    var $error_reporting  =  null;
+
+    /**
+     * This is the path to the debug console template. If not set,
+     * the default one will be used.
+     *
+     * @var string
+     */
+    var $debug_tpl       =  '';
+
+    /**
+     * This determines if debugging is enable-able from the browser.
+     * &lt;ul&gt;
+     *  &lt;li&gt;NONE =&gt; no debugging control allowed&lt;/li&gt;
+     *  &lt;li&gt;URL =&gt; enable debugging when SMARTY_DEBUG is found in the URL.&lt;/li&gt;
+     * &lt;/ul&gt;
+     * @link <A HREF="http://www.foo.dom/index.php?SMARTY_DEBUG">http://www.foo.dom/index.php?SMARTY_DEBUG</A>
+     * @var string
+     */
+    var $debugging_ctrl  =  'NONE';
+
+    /**
+     * This tells Smarty whether to check for recompiling or not. Recompiling
+     * does not need to happen unless a template or config file is changed.
+     * Typically you enable this during development, and disable for
+     * production.
+     *
+     * @var boolean
+     */
+    var $compile_check   =  true;
+
+    /**
+     * This forces templates to compile every time. Useful for development
+     * or debugging.
+     *
+     * @var boolean
+     */
+    var $force_compile   =  false;
+
+    /**
+     * This enables template caching.
+     * &lt;ul&gt;
+     *  &lt;li&gt;0 = no caching&lt;/li&gt;
+     *  &lt;li&gt;1 = use class cache_lifetime value&lt;/li&gt;
+     *  &lt;li&gt;2 = use cache_lifetime in cache file&lt;/li&gt;
+     * &lt;/ul&gt;
+     * @var integer
+     */
+    var $caching         =  0;
+
+    /**
+     * The name of the directory for cache files.
+     *
+     * @var string
+     */
+    var $cache_dir       =  'cache';
+
+    /**
+     * This is the number of seconds cached content will persist.
+     * &lt;ul&gt;
+     *  &lt;li&gt;0 = always regenerate cache&lt;/li&gt;
+     *  &lt;li&gt;-1 = never expires&lt;/li&gt;
+     * &lt;/ul&gt;
+     *
+     * @var integer
+     */
+    var $cache_lifetime  =  3600;
+
+    /**
+     * Only used when $caching is enabled. If true, then If-Modified-Since headers
+     * are respected with cached content, and appropriate HTTP headers are sent.
+     * This way repeated hits to a cached page do not send the entire page to the
+     * client every time.
+     *
+     * @var boolean
+     */
+    var $cache_modified_check = false;
+
+    /**
+     * This determines how Smarty handles &quot;&lt;?php ... ?&gt;&quot; tags in templates.
+     * possible values:
+     * &lt;ul&gt;
+     *  &lt;li&gt;SMARTY_PHP_PASSTHRU -&gt; print tags as plain text&lt;/li&gt;
+     *  &lt;li&gt;SMARTY_PHP_QUOTE    -&gt; escape tags as entities&lt;/li&gt;
+     *  &lt;li&gt;SMARTY_PHP_REMOVE   -&gt; remove php tags&lt;/li&gt;
+     *  &lt;li&gt;SMARTY_PHP_ALLOW    -&gt; execute php tags&lt;/li&gt;
+     * &lt;/ul&gt;
+     *
+     * @var integer
+     */
+    var $php_handling    =  SMARTY_PHP_PASSTHRU;
+
+    /**
+     * This enables template security. When enabled, many things are restricted
+     * in the templates that normally would go unchecked. This is useful when
+     * untrusted parties are editing templates and you want a reasonable level
+     * of security. (no direct execution of PHP in templates for example)
+     *
+     * @var boolean
+     */
+    var $security       =   false;
+
+    /**
+     * This is the list of template directories that are considered secure. This
+     * is used only if {@link $security} is enabled. One directory per array
+     * element.  {@link $template_dir} is in this list implicitly.
+     *
+     * @var array
+     */
+    var $secure_dir     =   array();
+
+    /**
+     * These are the security settings for Smarty. They are used only when
+     * {@link $security} is enabled.
+     *
+     * @var array
+     */
+    var $security_settings  = array(
+                                    'PHP_HANDLING'    =&gt; false,
+                                    'IF_FUNCS'        =&gt; array('array', 'list',
+                                                               'isset', 'empty',
+                                                               'count', 'sizeof',
+                                                               'in_array', 'is_array',
+                                                               'true', 'false', 'null'),
+                                    'INCLUDE_ANY'     =&gt; false,
+                                    'PHP_TAGS'        =&gt; false,
+                                    'MODIFIER_FUNCS'  =&gt; array('count'),
+                                    'ALLOW_CONSTANTS'  =&gt; false
+                                   );
+
+    /**
+     * This is an array of directories where trusted php scripts reside.
+     * {@link $security} is disabled during their inclusion/execution.
+     *
+     * @var array
+     */
+    var $trusted_dir        = array();
+
+    /**
+     * The left delimiter used for the template tags.
+     *
+     * @var string
+     */
+    var $left_delimiter  =  '{';
+
+    /**
+     * The right delimiter used for the template tags.
+     *
+     * @var string
+     */
+    var $right_delimiter =  '}';
+
+    /**
+     * The order in which request variables are registered, similar to
+     * variables_order in php.ini E = Environment, G = GET, P = POST,
+     * C = Cookies, S = Server
+     *
+     * @var string
+     */
+    var $request_vars_order    = 'EGPCS';
+
+    /**
+     * Indicates wether $HTTP_*_VARS[] (request_use_auto_globals=false)
+     * are uses as request-vars or $_*[]-vars. note: if
+     * request_use_auto_globals is true, then $request_vars_order has
+     * no effect, but the php-ini-value &quot;gpc_order&quot;
+     *
+     * @var boolean
+     */
+    var $request_use_auto_globals      = true;
+
+    /**
+     * Set this if you want different sets of compiled files for the same
+     * templates. This is useful for things like different languages.
+     * Instead of creating separate sets of templates per language, you
+     * set different compile_ids like 'en' and 'de'.
+     *
+     * @var string
+     */
+    var $compile_id            = null;
+
+    /**
+     * This tells Smarty whether or not to use sub dirs in the cache/ and
+     * templates_c/ directories. sub directories better organized, but
+     * may not work well with PHP safe mode enabled.
+     *
+     * @var boolean
+     *
+     */
+    var $use_sub_dirs          = false;
+
+    /**
+     * This is a list of the modifiers to apply to all template variables.
+     * Put each modifier in a separate array element in the order you want
+     * them applied. example: &lt;code&gt;array('escape:&quot;htmlall&quot;');&lt;/code&gt;
+     *
+     * @var array
+     */
+    var $default_modifiers        = array();
+
+    /**
+     * This is the resource type to be used when not specified
+     * at the beginning of the resource path. examples:
+     * $smarty-&gt;display('file:index.tpl');
+     * $smarty-&gt;display('db:index.tpl');
+     * $smarty-&gt;display('index.tpl'); // will use default resource type
+     * {include file=&quot;file:index.tpl&quot;}
+     * {include file=&quot;db:index.tpl&quot;}
+     * {include file=&quot;index.tpl&quot;} {* will use default resource type *}
+     *
+     * @var array
+     */
+    var $default_resource_type    = 'file';
+
+    /**
+     * The function used for cache file handling. If not set, built-in caching is used.
+     *
+     * @var null|string function name
+     */
+    var $cache_handler_func   = null;
+
+    /**
+     * This indicates which filters are automatically loaded into Smarty.
+     *
+     * @var array array of filter names
+     */
+    var $autoload_filters = array();
+
+    /**#@+
+     * @var boolean
+     */
+    /**
+     * This tells if config file vars of the same name overwrite each other or not.
+     * if disabled, same name variables are accumulated in an array.
+     */
+    var $config_overwrite = true;
+
+    /**
+     * This tells whether or not to automatically booleanize config file variables.
+     * If enabled, then the strings &quot;on&quot;, &quot;true&quot;, and &quot;yes&quot; are treated as boolean
+     * true, and &quot;off&quot;, &quot;false&quot; and &quot;no&quot; are treated as boolean false.
+     */
+    var $config_booleanize = true;
+
+    /**
+     * This tells whether hidden sections [.foobar] are readable from the
+     * tempalates or not. Normally you would never allow this since that is
+     * the point behind hidden sections: the application can access them, but
+     * the templates cannot.
+     */
+    var $config_read_hidden = false;
+
+    /**
+     * This tells whether or not automatically fix newlines in config files.
+     * It basically converts \r (mac) or \r\n (dos) to \n
+     */
+    var $config_fix_newlines = true;
+    /**#@-*/
+
+    /**
+     * If a template cannot be found, this PHP function will be executed.
+     * Useful for creating templates on-the-fly or other special action.
+     *
+     * @var string function name
+     */
+    var $default_template_handler_func = '';
+
+    /**
+     * The file that contains the compiler class. This can a full
+     * pathname, or relative to the php_include path.
+     *
+     * @var string
+     */
+    var $compiler_file        =    'Smarty_Compiler.class.php';
+
+    /**
+     * The class used for compiling templates.
+     *
+     * @var string
+     */
+    var $compiler_class        =   'Smarty_Compiler';
+
+    /**
+     * The class used to load config vars.
+     *
+     * @var string
+     */
+    var $config_class          =   'Config_File';
+
+/**#@+
+ * END Smarty Configuration Section
+ * There should be no need to touch anything below this line.
+ * @access private
+ */
+    /**
+     * where assigned template vars are kept
+     *
+     * @var array
+     */
+    var $_tpl_vars             = array();
+
+    /**
+     * stores run-time $smarty.* vars
+     *
+     * @var null|array
+     */
+    var $_smarty_vars          = null;
+
+    /**
+     * keeps track of sections
+     *
+     * @var array
+     */
+    var $_sections             = array();
+
+    /**
+     * keeps track of foreach blocks
+     *
+     * @var array
+     */
+    var $_foreach              = array();
+
+    /**
+     * keeps track of tag hierarchy
+     *
+     * @var array
+     */
+    var $_tag_stack            = array();
+
+    /**
+     * configuration object
+     *
+     * @var Config_file
+     */
+    var $_conf_obj             = null;
+
+    /**
+     * loaded configuration settings
+     *
+     * @var array
+     */
+    var $_config               = array(array('vars'  =&gt; array(), 'files' =&gt; array()));
+
+    /**
+     * md5 checksum of the string 'Smarty'
+     *
+     * @var string
+     */
+    var $_smarty_md5           = 'f8d698aea36fcbead2b9d5359ffca76f';
+
+    /**
+     * Smarty version number
+     *
+     * @var string
+     */
+    var $_version              = '2.6.10';
+
+    /**
+     * current template inclusion depth
+     *
+     * @var integer
+     */
+    var $_inclusion_depth      = 0;
+
+    /**
+     * for different compiled templates
+     *
+     * @var string
+     */
+    var $_compile_id           = null;
+
+    /**
+     * text in URL to enable debug mode
+     *
+     * @var string
+     */
+    var $_smarty_debug_id      = 'SMARTY_DEBUG';
+
+    /**
+     * debugging information for debug console
+     *
+     * @var array
+     */
+    var $_smarty_debug_info    = array();
+
+    /**
+     * info that makes up a cache file
+     *
+     * @var array
+     */
+    var $_cache_info           = array();
+
+    /**
+     * default file permissions
+     *
+     * @var integer
+     */
+    var $_file_perms           = 0644;
+
+    /**
+     * default dir permissions
+     *
+     * @var integer
+     */
+    var $_dir_perms               = 0771;
+
+    /**
+     * registered objects
+     *
+     * @var array
+     */
+    var $_reg_objects           = array();
+
+    /**
+     * table keeping track of plugins
+     *
+     * @var array
+     */
+    var $_plugins              = array(
+                                       'modifier'      =&gt; array(),
+                                       'function'      =&gt; array(),
+                                       'block'         =&gt; array(),
+                                       'compiler'      =&gt; array(),
+                                       'prefilter'     =&gt; array(),
+                                       'postfilter'    =&gt; array(),
+                                       'outputfilter'  =&gt; array(),
+                                       'resource'      =&gt; array(),
+                                       'insert'        =&gt; array());
+
+
+    /**
+     * cache serials
+     *
+     * @var array
+     */
+    var $_cache_serials = array();
+
+    /**
+     * name of optional cache include file
+     *
+     * @var string
+     */
+    var $_cache_include = null;
+
+    /**
+     * indicate if the current code is used in a compiled
+     * include
+     *
+     * @var string
+     */
+    var $_cache_including = false;
+
+    /**#@-*/
+    /**
+     * The class constructor.
+     */
+    function Smarty()
+    {
+      $this-&gt;assign('SCRIPT_NAME', isset($_SERVER['SCRIPT_NAME']) ? $_SERVER['SCRIPT_NAME']
+                    : @$GLOBALS['HTTP_SERVER_VARS']['SCRIPT_NAME']);
+    }
+
+    /**
+     * assigns values to template variables
+     *
+     * @param array|string $tpl_var the template variable name(s)
+     * @param mixed $value the value to assign
+     */
+    function assign($tpl_var, $value = null)
+    {
+        if (is_array($tpl_var)){
+            foreach ($tpl_var as $key =&gt; $val) {
+                if ($key != '') {
+                    $this-&gt;_tpl_vars[$key] = $val;
+                }
+            }
+        } else {
+            if ($tpl_var != '')
+                $this-&gt;_tpl_vars[$tpl_var] = $value;
+        }
+    }
+
+    /**
+     * assigns values to template variables by reference
+     *
+     * @param string $tpl_var the template variable name
+     * @param mixed $value the referenced value to assign
+     */
+    function assign_by_ref($tpl_var, &amp;$value)
+    {
+        if ($tpl_var != '')
+            $this-&gt;_tpl_vars[$tpl_var] = &amp;$value;
+    }
+
+    /**
+     * appends values to template variables
+     *
+     * @param array|string $tpl_var the template variable name(s)
+     * @param mixed $value the value to append
+     */
+    function append($tpl_var, $value=null, $merge=false)
+    {
+        if (is_array($tpl_var)) {
+            // $tpl_var is an array, ignore $value
+            foreach ($tpl_var as $_key =&gt; $_val) {
+                if ($_key != '') {
+                    if(!@is_array($this-&gt;_tpl_vars[$_key])) {
+                        settype($this-&gt;_tpl_vars[$_key],'array');
+                    }
+                    if($merge &amp;&amp; is_array($_val)) {
+                        foreach($_val as $_mkey =&gt; $_mval) {
+                            $this-&gt;_tpl_vars[$_key][$_mkey] = $_mval;
+                        }
+                    } else {
+                        $this-&gt;_tpl_vars[$_key][] = $_val;
+                    }
+                }
+            }
+        } else {
+            if ($tpl_var != '' &amp;&amp; isset($value)) {
+                if(!@is_array($this-&gt;_tpl_vars[$tpl_var])) {
+                    settype($this-&gt;_tpl_vars[$tpl_var],'array');
+                }
+                if($merge &amp;&amp; is_array($value)) {
+                    foreach($value as $_mkey =&gt; $_mval) {
+                        $this-&gt;_tpl_vars[$tpl_var][$_mkey] = $_mval;
+                    }
+                } else {
+                    $this-&gt;_tpl_vars[$tpl_var][] = $value;
+                }
+            }
+        }
+    }
+
+    /**
+     * appends values to template variables by reference
+     *
+     * @param string $tpl_var the template variable name
+     * @param mixed $value the referenced value to append
+     */
+    function append_by_ref($tpl_var, &amp;$value, $merge=false)
+    {
+        if ($tpl_var != '' &amp;&amp; isset($value)) {
+            if(!@is_array($this-&gt;_tpl_vars[$tpl_var])) {
+             settype($this-&gt;_tpl_vars[$tpl_var],'array');
+            }
+            if ($merge &amp;&amp; is_array($value)) {
+                foreach($value as $_key =&gt; $_val) {
+                    $this-&gt;_tpl_vars[$tpl_var][$_key] = &amp;$value[$_key];
+                }
+            } else {
+                $this-&gt;_tpl_vars[$tpl_var][] = &amp;$value;
+            }
+        }
+    }
+
+
+    /**
+     * clear the given assigned template variable.
+     *
+     * @param string $tpl_var the template variable to clear
+     */
+    function clear_assign($tpl_var)
+    {
+        if (is_array($tpl_var))
+            foreach ($tpl_var as $curr_var)
+                unset($this-&gt;_tpl_vars[$curr_var]);
+        else
+            unset($this-&gt;_tpl_vars[$tpl_var]);
+    }
+
+
+    /**
+     * Registers custom function to be used in templates
+     *
+     * @param string $function the name of the template function
+     * @param string $function_impl the name of the PHP function to register
+     */
+    function register_function($function, $function_impl, $cacheable=true, $cache_attrs=null)
+    {
+        $this-&gt;_plugins['function'][$function] =
+            array($function_impl, null, null, false, $cacheable, $cache_attrs);
+
+    }
+
+    /**
+     * Unregisters custom function
+     *
+     * @param string $function name of template function
+     */
+    function unregister_function($function)
+    {
+        unset($this-&gt;_plugins['function'][$function]);
+    }
+
+    /**
+     * Registers object to be used in templates
+     *
+     * @param string $object name of template object
+     * @param object &amp;$object_impl the referenced PHP object to register
+     * @param null|array $allowed list of allowed methods (empty = all)
+     * @param boolean $smarty_args smarty argument format, else traditional
+     * @param null|array $block_functs list of methods that are block format
+     */
+    function register_object($object, &amp;$object_impl, $allowed = array(), $smarty_args = true, $block_methods = array())
+    {
+        settype($allowed, 'array');
+        settype($smarty_args, 'boolean');
+        $this-&gt;_reg_objects[$object] =
+            array(&amp;$object_impl, $allowed, $smarty_args, $block_methods);
+    }
+
+    /**
+     * Unregisters object
+     *
+     * @param string $object name of template object
+     */
+    function unregister_object($object)
+    {
+        unset($this-&gt;_reg_objects[$object]);
+    }
+
+
+    /**
+     * Registers block function to be used in templates
+     *
+     * @param string $block name of template block
+     * @param string $block_impl PHP function to register
+     */
+    function register_block($block, $block_impl, $cacheable=true, $cache_attrs=null)
+    {
+        $this-&gt;_plugins['block'][$block] =
+            array($block_impl, null, null, false, $cacheable, $cache_attrs);
+    }
+
+    /**
+     * Unregisters block function
+     *
+     * @param string $block name of template function
+     */
+    function unregister_block($block)
+    {
+        unset($this-&gt;_plugins['block'][$block]);
+    }
+
+    /**
+     * Registers compiler function
+     *
+     * @param string $function name of template function
+     * @param string $function_impl name of PHP function to register
+     */
+    function register_compiler_function($function, $function_impl, $cacheable=true)
+    {
+        $this-&gt;_plugins['compiler'][$function] =
+            array($function_impl, null, null, false, $cacheable);
+    }
+
+    /**
+     * Unregisters compiler function
+     *
+     * @param string $function name of template function
+     */
+    function unregister_compiler_function($function)
+    {
+        unset($this-&gt;_plugins['compiler'][$function]);
+    }
+
+    /**
+     * Registers modifier to be used in templates
+     *
+     * @param string $modifier name of template modifier
+     * @param string $modifier_impl name of PHP function to register
+     */
+    function register_modifier($modifier, $modifier_impl)
+    {
+        $this-&gt;_plugins['modifier'][$modifier] =
+            array($modifier_impl, null, null, false);
+    }
+
+    /**
+     * Unregisters modifier
+     *
+     * @param string $modifier name of template modifier
+     */
+    function unregister_modifier($modifier)
+    {
+        unset($this-&gt;_plugins['modifier'][$modifier]);
+    }
+
+    /**
+     * Registers a resource to fetch a template
+     *
+     * @param string $type name of resource
+     * @param array $functions array of functions to handle resource
+     */
+    function register_resource($type, $functions)
+    {
+        if (count($functions)==4) {
+            $this-&gt;_plugins['resource'][$type] =
+                array($functions, false);
+
+        } elseif (count($functions)==5) {
+            $this-&gt;_plugins['resource'][$type] =
+                array(array(array(&amp;$functions[0], $functions[1])
+                            ,array(&amp;$functions[0], $functions[2])
+                            ,array(&amp;$functions[0], $functions[3])
+                            ,array(&amp;$functions[0], $functions[4]))
+                      ,false);
+
+        } else {
+            $this-&gt;trigger_error(&quot;malformed function-list for '$type' in register_resource&quot;);
+
+        }
+    }
+
+    /**
+     * Unregisters a resource
+     *
+     * @param string $type name of resource
+     */
+    function unregister_resource($type)
+    {
+        unset($this-&gt;_plugins['resource'][$type]);
+    }
+
+    /**
+     * Registers a prefilter function to apply
+     * to a template before compiling
+     *
+     * @param string $function name of PHP function to register
+     */
+    function register_prefilter($function)
+    {
+    $_name = (is_array($function)) ? $function[1] : $function;
+        $this-&gt;_plugins['prefilter'][$_name]
+            = array($function, null, null, false);
+    }
+
+    /**
+     * Unregisters a prefilter function
+     *
+     * @param string $function name of PHP function
+     */
+    function unregister_prefilter($function)
+    {
+        unset($this-&gt;_plugins['prefilter'][$function]);
+    }
+
+    /**
+     * Registers a postfilter function to apply
+     * to a compiled template after compilation
+     *
+     * @param string $function name of PHP function to register
+     */
+    function register_postfilter($function)
+    {
+    $_name = (is_array($function)) ? $function[1] : $function;
+        $this-&gt;_plugins['postfilter'][$_name]
+            = array($function, null, null, false);
+    }
+
+    /**
+     * Unregisters a postfilter function
+     *
+     * @param string $function name of PHP function
+     */
+    function unregister_postfilter($function)
+    {
+        unset($this-&gt;_plugins['postfilter'][$function]);
+    }
+
+    /**
+     * Registers an output filter function to apply
+     * to a template output
+     *
+     * @param string $function name of PHP function
+     */
+    function register_outputfilter($function)
+    {
+    $_name = (is_array($function)) ? $function[1] : $function;
+        $this-&gt;_plugins['outputfilter'][$_name]
+            = array($function, null, null, false);
+    }
+
+    /**
+     * Unregisters an outputfilter function
+     *
+     * @param string $function name of PHP function
+     */
+    function unregister_outputfilter($function)
+    {
+        unset($this-&gt;_plugins['outputfilter'][$function]);
+    }
+
+    /**
+     * load a filter of specified type and name
+     *
+     * @param string $type filter type
+     * @param string $name filter name
+     */
+    function load_filter($type, $name)
+    {
+        switch ($type) {
+            case 'output':
+                $_params = array('plugins' =&gt; array(array($type . 'filter', $name, null, null, false)));
+                require_once(SMARTY_CORE_DIR . 'core.load_plugins.php');
+                smarty_core_load_plugins($_params, $this);
+                break;
+
+            case 'pre':
+            case 'post':
+                if (!isset($this-&gt;_plugins[$type . 'filter'][$name]))
+                    $this-&gt;_plugins[$type . 'filter'][$name] = false;
+                break;
+        }
+    }
+
+    /**
+     * clear cached content for the given template and cache id
+     *
+     * @param string $tpl_file name of template file
+     * @param string $cache_id name of cache_id
+     * @param string $compile_id name of compile_id
+     * @param string $exp_time expiration time
+     * @return boolean
+     */
+    function clear_cache($tpl_file = null, $cache_id = null, $compile_id = null, $exp_time = null)
+    {
+
+        if (!isset($compile_id))
+            $compile_id = $this-&gt;compile_id;
+
+        if (!isset($tpl_file))
+            $compile_id = null;
+
+        $_auto_id = $this-&gt;_get_auto_id($cache_id, $compile_id);
+
+        if (!empty($this-&gt;cache_handler_func)) {
+            return call_user_func_array($this-&gt;cache_handler_func,
+                                  array('clear', &amp;$this, &amp;$dummy, $tpl_file, $cache_id, $compile_id, $exp_time));
+        } else {
+            $_params = array('auto_base' =&gt; $this-&gt;cache_dir,
+                            'auto_source' =&gt; $tpl_file,
+                            'auto_id' =&gt; $_auto_id,
+                            'exp_time' =&gt; $exp_time);
+            require_once(SMARTY_CORE_DIR . 'core.rm_auto.php');
+            return smarty_core_rm_auto($_params, $this);
+        }
+
+    }
+
+
+    /**
+     * clear the entire contents of cache (all templates)
+     *
+     * @param string $exp_time expire time
+     * @return boolean results of {@link smarty_core_rm_auto()}
+     */
+    function clear_all_cache($exp_time = null)
+    {
+        return $this-&gt;clear_cache(null, null, null, $exp_time);
+    }
+
+
+    /**
+     * test to see if valid cache exists for this template
+     *
+     * @param string $tpl_file name of template file
+     * @param string $cache_id
+     * @param string $compile_id
+     * @return string|false results of {@link _read_cache_file()}
+     */
+    function is_cached($tpl_file, $cache_id = null, $compile_id = null)
+    {
+        if (!$this-&gt;caching)
+            return false;
+
+        if (!isset($compile_id))
+            $compile_id = $this-&gt;compile_id;
+
+        $_params = array(
+            'tpl_file' =&gt; $tpl_file,
+            'cache_id' =&gt; $cache_id,
+            'compile_id' =&gt; $compile_id
+        );
+        require_once(SMARTY_CORE_DIR . 'core.read_cache_file.php');
+        return smarty_core_read_cache_file($_params, $this);
+    }
+
+
+    /**
+     * clear all the assigned template variables.
+     *
+     */
+    function clear_all_assign()
+    {
+        $this-&gt;_tpl_vars = array();
+    }
+
+    /**
+     * clears compiled version of specified template resource,
+     * or all compiled template files if one is not specified.
+     * This function is for advanced use only, not normally needed.
+     *
+     * @param string $tpl_file
+     * @param string $compile_id
+     * @param string $exp_time
+     * @return boolean results of {@link smarty_core_rm_auto()}
+     */
+    function clear_compiled_tpl($tpl_file = null, $compile_id = null, $exp_time = null)
+    {
+        if (!isset($compile_id)) {
+            $compile_id = $this-&gt;compile_id;
+        }
+        $_params = array('auto_base' =&gt; $this-&gt;compile_dir,
+                        'auto_source' =&gt; $tpl_file,
+                        'auto_id' =&gt; $compile_id,
+                        'exp_time' =&gt; $exp_time,
+                        'extensions' =&gt; array('.inc', '.php'));
+        require_once(SMARTY_CORE_DIR . 'core.rm_auto.php');
+        return smarty_core_rm_auto($_params, $this);
+    }
+
+    /**
+     * Checks whether requested template exists.
+     *
+     * @param string $tpl_file
+     * @return boolean
+     */
+    function template_exists($tpl_file)
+    {
+        $_params = array('resource_name' =&gt; $tpl_file, 'quiet'=&gt;true, 'get_source'=&gt;false);
+        return $this-&gt;_fetch_resource_info($_params);
+    }
+
+    /**
+     * Returns an array containing template variables
+     *
+     * @param string $name
+     * @param string $type
+     * @return array
+     */
+    function &amp;get_template_vars($name=null)
+    {
+        if(!isset($name)) {
+            return $this-&gt;_tpl_vars;
+        }
+        if(isset($this-&gt;_tpl_vars[$name])) {
+            return $this-&gt;_tpl_vars[$name];
+        }
+    }
+
+    /**
+     * Returns an array containing config variables
+     *
+     * @param string $name
+     * @param string $type
+     * @return array
+     */
+    function &amp;get_config_vars($name=null)
+    {
+        if(!isset($name) &amp;&amp; is_array($this-&gt;_config[0])) {
+            return $this-&gt;_config[0]['vars'];
+        } else if(isset($this-&gt;_config[0]['vars'][$name])) {
+            return $this-&gt;_config[0]['vars'][$name];
+        }
+    }
+
+    /**
+     * trigger Smarty error
+     *
+     * @param string $error_msg
+     * @param integer $error_type
+     */
+    function trigger_error($error_msg, $error_type = E_USER_WARNING)
+    {
+        trigger_error(&quot;Smarty error: $error_msg&quot;, $error_type);
+    }
+
+
+    /**
+     * executes &amp; displays the template results
+     *
+     * @param string $resource_name
+     * @param string $cache_id
+     * @param string $compile_id
+     */
+    function display($resource_name, $cache_id = null, $compile_id = null)
+    {
+        $this-&gt;fetch($resource_name, $cache_id, $compile_id, true);
+    }
+
+    /**
+     * executes &amp; returns or displays the template results
+     *
+     * @param string $resource_name
+     * @param string $cache_id
+     * @param string $compile_id
+     * @param boolean $display
+     */
+    function fetch($resource_name, $cache_id = null, $compile_id = null, $display = false)
+    {
+        static $_cache_info = array();
+        
+        $_smarty_old_error_level = $this-&gt;debugging ? error_reporting() : error_reporting(isset($this-&gt;error_reporting)
+               ? $this-&gt;error_reporting : error_reporting() &amp; ~E_NOTICE);
+
+        if (!$this-&gt;debugging &amp;&amp; $this-&gt;debugging_ctrl == 'URL') {
+            $_query_string = $this-&gt;request_use_auto_globals ? $_SERVER['QUERY_STRING'] : $GLOBALS['HTTP_SERVER_VARS']['QUERY_STRING'];
+            if (@strstr($_query_string, $this-&gt;_smarty_debug_id)) {
+                if (@strstr($_query_string, $this-&gt;_smarty_debug_id . '=on')) {
+                    // enable debugging for this browser session
+                    @setcookie('SMARTY_DEBUG', true);
+                    $this-&gt;debugging = true;
+                } elseif (@strstr($_query_string, $this-&gt;_smarty_debug_id . '=off')) {
+                    // disable debugging for this browser session
+                    @setcookie('SMARTY_DEBUG', false);
+                    $this-&gt;debugging = false;
+                } else {
+                    // enable debugging for this page
+                    $this-&gt;debugging = true;
+                }
+            } else {
+                $this-&gt;debugging = (bool)($this-&gt;request_use_auto_globals ? @$_COOKIE['SMARTY_DEBUG'] : @$GLOBALS['HTTP_COOKIE_VARS']['SMARTY_DEBUG']);
+            }
+        }
+
+        if ($this-&gt;debugging) {
+            // capture time for debugging info
+            $_params = array();
+            require_once(SMARTY_CORE_DIR . 'core.get_microtime.php');
+            $_debug_start_time = smarty_core_get_microtime($_params, $this);
+            $this-&gt;_smarty_debug_info[] = array('type'      =&gt; 'template',
+                                                'filename'  =&gt; $resource_name,
+                                                'depth'     =&gt; 0);
+            $_included_tpls_idx = count($this-&gt;_smarty_debug_info) - 1;
+        }
+
+        if (!isset($compile_id)) {
+            $compile_id = $this-&gt;compile_id;
+        }
+
+        $this-&gt;_compile_id = $compile_id;
+        $this-&gt;_inclusion_depth = 0;
+
+        if ($this-&gt;caching) {
+            // save old cache_info, initialize cache_info
+            array_push($_cache_info, $this-&gt;_cache_info);
+            $this-&gt;_cache_info = array();
+            $_params = array(
+                'tpl_file' =&gt; $resource_name,
+                'cache_id' =&gt; $cache_id,
+                'compile_id' =&gt; $compile_id,
+                'results' =&gt; null
+            );
+            require_once(SMARTY_CORE_DIR . 'core.read_cache_file.php');
+            if (smarty_core_read_cache_file($_params, $this)) {
+                $_smarty_results = $_params['results'];
+                if (!empty($this-&gt;_cache_info['insert_tags'])) {
+                    $_params = array('plugins' =&gt; $this-&gt;_cache_info['insert_tags']);
+                    require_once(SMARTY_CORE_DIR . 'core.load_plugins.php');
+                    smarty_core_load_plugins($_params, $this);
+                    $_params = array('results' =&gt; $_smarty_results);
+                    require_once(SMARTY_CORE_DIR . 'core.process_cached_inserts.php');
+                    $_smarty_results = smarty_core_process_cached_inserts($_params, $this);
+                }
+                if (!empty($this-&gt;_cache_info['cache_serials'])) {
+                    $_params = array('results' =&gt; $_smarty_results);
+                    require_once(SMARTY_CORE_DIR . 'core.process_compiled_include.php');
+                    $_smarty_results = smarty_core_process_compiled_include($_params, $this);
+                }
+
+
+                if ($display) {
+                    if ($this-&gt;debugging)
+                    {
+                        // capture time for debugging info
+                        $_params = array();
+                        require_once(SMARTY_CORE_DIR . 'core.get_microtime.php');
+                        $this-&gt;_smarty_debug_info[$_included_tpls_idx]['exec_time'] = smarty_core_get_microtime($_params, $this) - $_debug_start_time;
+                        require_once(SMARTY_CORE_DIR . 'core.display_debug_console.php');
+                        $_smarty_results .= smarty_core_display_debug_console($_params, $this);
+                    }
+                    if ($this-&gt;cache_modified_check) {
+                        $_server_vars = ($this-&gt;request_use_auto_globals) ? $_SERVER : $GLOBALS['HTTP_SERVER_VARS'];
+                        $_last_modified_date = @substr($_server_vars['HTTP_IF_MODIFIED_SINCE'], 0, strpos($_server_vars['HTTP_IF_MODIFIED_SINCE'], 'GMT') + 3);
+                        $_gmt_mtime = gmdate('D, d M Y H:i:s', $this-&gt;_cache_info['timestamp']).' GMT';
+                        if (@count($this-&gt;_cache_info['insert_tags']) == 0
+                            &amp;&amp; !$this-&gt;_cache_serials
+                            &amp;&amp; $_gmt_mtime == $_last_modified_date) {
+                            if (php_sapi_name()=='cgi')
+                                header('Status: 304 Not Modified');
+                            else
+                                header('HTTP/1.1 304 Not Modified');
+
+                        } else {
+                            header('Last-Modified: '.$_gmt_mtime);
+                            echo $_smarty_results;
+                        }
+                    } else {
+                            echo $_smarty_results;
+                    }
+                    error_reporting($_smarty_old_error_level);
+                    // restore initial cache_info
+                    $this-&gt;_cache_info = array_pop($_cache_info);
+                    return true;
+                } else {
+                    error_reporting($_smarty_old_error_level);
+                    // restore initial cache_info
+                    $this-&gt;_cache_info = array_pop($_cache_info);
+                    return $_smarty_results;
+                }
+            } else {
+                $this-&gt;_cache_info['template'][$resource_name] = true;
+                if ($this-&gt;cache_modified_check &amp;&amp; $display) {
+                    header('Last-Modified: '.gmdate('D, d M Y H:i:s', time()).' GMT');
+                }
+            }
+        }
+
+        // load filters that are marked as autoload
+        if (count($this-&gt;autoload_filters)) {
+            foreach ($this-&gt;autoload_filters as $_filter_type =&gt; $_filters) {
+                foreach ($_filters as $_filter) {
+                    $this-&gt;load_filter($_filter_type, $_filter);
+                }
+            }
+        }
+
+        $_smarty_compile_path = $this-&gt;_get_compile_path($resource_name);
+
+        // if we just need to display the results, don't perform output
+        // buffering - for speed
+        $_cache_including = $this-&gt;_cache_including;
+        $this-&gt;_cache_including = false;
+        if ($display &amp;&amp; !$this-&gt;caching &amp;&amp; count($this-&gt;_plugins['outputfilter']) == 0) {
+            if ($this-&gt;_is_compiled($resource_name, $_smarty_compile_path)
+                    || $this-&gt;_compile_resource($resource_name, $_smarty_compile_path))
+            {
+                include($_smarty_compile_path);
+            }
+        } else {
+            ob_start();
+            if ($this-&gt;_is_compiled($resource_name, $_smarty_compile_path)
+                    || $this-&gt;_compile_resource($resource_name, $_smarty_compile_path))
+            {
+                include($_smarty_compile_path);
+            }
+            $_smarty_results = ob_get_contents();
+            ob_end_clean();
+
+            foreach ((array)$this-&gt;_plugins['outputfilter'] as $_output_filter) {
+                $_smarty_results = call_user_func_array($_output_filter[0], array($_smarty_results, &amp;$this));
+            }
+        }
+
+        if ($this-&gt;caching) {
+            $_params = array('tpl_file' =&gt; $resource_name,
+                        'cache_id' =&gt; $cache_id,
+                        'compile_id' =&gt; $compile_id,
+                        'results' =&gt; $_smarty_results);
+            require_once(SMARTY_CORE_DIR . 'core.write_cache_file.php');
+            smarty_core_write_cache_file($_params, $this);
+            require_once(SMARTY_CORE_DIR . 'core.process_cached_inserts.php');
+            $_smarty_results = smarty_core_process_cached_inserts($_params, $this);
+
+            if ($this-&gt;_cache_serials) {
+                // strip nocache-tags from output
+                $_smarty_results = preg_replace('!(\{/?nocache\:[0-9a-f]{32}#\d+\})!s'
+                                                ,''
+                                                ,$_smarty_results);
+            }
+            // restore initial cache_info
+            $this-&gt;_cache_info = array_pop($_cache_info);
+        }
+        $this-&gt;_cache_including = $_cache_including;
+
+        if ($display) {
+            if (isset($_smarty_results)) { echo $_smarty_results; }
+            if ($this-&gt;debugging) {
+                // capture time for debugging info
+                $_params = array();
+                require_once(SMARTY_CORE_DIR . 'core.get_microtime.php');
+                $this-&gt;_smarty_debug_info[$_included_tpls_idx]['exec_time'] = (smarty_core_get_microtime($_params, $this) - $_debug_start_time);
+                require_once(SMARTY_CORE_DIR . 'core.display_debug_console.php');
+                echo smarty_core_display_debug_console($_params, $this);
+            }
+            error_reporting($_smarty_old_error_level);
+            return;
+        } else {
+            error_reporting($_smarty_old_error_level);
+            if (isset($_smarty_results)) { return $_smarty_results; }
+        }
+    }
+
+    /**
+     * load configuration values
+     *
+     * @param string $file
+     * @param string $section
+     * @param string $scope
+     */
+    function config_load($file, $section = null, $scope = 'global')
+    {
+        require_once($this-&gt;_get_plugin_filepath('function', 'config_load'));
+        smarty_function_config_load(array('file' =&gt; $file, 'section' =&gt; $section, 'scope' =&gt; $scope), $this);
+    }
+
+    /**
+     * return a reference to a registered object
+     *
+     * @param string $name
+     * @return object
+     */
+    function &amp;get_registered_object($name) {
+        if (!isset($this-&gt;_reg_objects[$name]))
+        $this-&gt;_trigger_fatal_error(&quot;'$name' is not a registered object&quot;);
+
+        if (!is_object($this-&gt;_reg_objects[$name][0]))
+        $this-&gt;_trigger_fatal_error(&quot;registered '$name' is not an object&quot;);
+
+        return $this-&gt;_reg_objects[$name][0];
+    }
+
+    /**
+     * clear configuration values
+     *
+     * @param string $var
+     */
+    function clear_config($var = null)
+    {
+        if(!isset($var)) {
+            // clear all values
+            $this-&gt;_config = array(array('vars'  =&gt; array(),
+                                         'files' =&gt; array()));
+        } else {
+            unset($this-&gt;_config[0]['vars'][$var]);
+        }
+    }
+
+    /**
+     * get filepath of requested plugin
+     *
+     * @param string $type
+     * @param string $name
+     * @return string|false
+     */
+    function _get_plugin_filepath($type, $name)
+    {
+        $_params = array('type' =&gt; $type, 'name' =&gt; $name);
+        require_once(SMARTY_CORE_DIR . 'core.assemble_plugin_filepath.php');
+        return smarty_core_assemble_plugin_filepath($_params, $this);
+    }
+
+   /**
+     * test if resource needs compiling
+     *
+     * @param string $resource_name
+     * @param string $compile_path
+     * @return boolean
+     */
+    function _is_compiled($resource_name, $compile_path)
+    {
+        if (!$this-&gt;force_compile &amp;&amp; file_exists($compile_path)) {
+            if (!$this-&gt;compile_check) {
+                // no need to check compiled file
+                return true;
+            } else {
+                // get file source and timestamp
+                $_params = array('resource_name' =&gt; $resource_name, 'get_source'=&gt;false);
+                if (!$this-&gt;_fetch_resource_info($_params)) {
+                    return false;
+                }
+                if ($_params['resource_timestamp'] &lt;= filemtime($compile_path)) {
+                    // template not expired, no recompile
+                    return true;
+                } else {
+                    // compile template
+                    return false;
+                }
+            }
+        } else {
+            // compiled template does not exist, or forced compile
+            return false;
+        }
+    }
+
+   /**
+     * compile the template
+     *
+     * @param string $resource_name
+     * @param string $compile_path
+     * @return boolean
+     */
+    function _compile_resource($resource_name, $compile_path)
+    {
+
+        $_params = array('resource_name' =&gt; $resource_name);
+        if (!$this-&gt;_fetch_resource_info($_params)) {
+            return false;
+        }
+
+        $_source_content = $_params['source_content'];
+        $_cache_include    = substr($compile_path, 0, -4).'.inc';
+
+        if ($this-&gt;_compile_source($resource_name, $_source_content, $_compiled_content, $_cache_include)) {
+            // if a _cache_serial was set, we also have to write an include-file:
+            if ($this-&gt;_cache_include_info) {
+                require_once(SMARTY_CORE_DIR . 'core.write_compiled_include.php');
+                smarty_core_write_compiled_include(array_merge($this-&gt;_cache_include_info, array('compiled_content'=&gt;$_compiled_content, 'resource_name'=&gt;$resource_name)),  $this);
+            }
+
+            $_params = array('compile_path'=&gt;$compile_path, 'compiled_content' =&gt; $_compiled_content);
+            require_once(SMARTY_CORE_DIR . 'core.write_compiled_resource.php');
+            smarty_core_write_compiled_resource($_params, $this);
+
+            return true;
+        } else {
+            return false;
+        }
+
+    }
+
+   /**
+     * compile the given source
+     *
+     * @param string $resource_name
+     * @param string $source_content
+     * @param string $compiled_content
+     * @return boolean
+     */
+    function _compile_source($resource_name, &amp;$source_content, &amp;$compiled_content, $cache_include_path=null)
+    {
+        if (file_exists(SMARTY_DIR . $this-&gt;compiler_file)) {
+            require_once(SMARTY_DIR . $this-&gt;compiler_file);
+        } else {
+            // use include_path
+            require_once($this-&gt;compiler_file);
+        }
+
+
+        $smarty_compiler = new $this-&gt;compiler_class;
+
+        $smarty_compiler-&gt;template_dir      = $this-&gt;template_dir;
+        $smarty_compiler-&gt;compile_dir       = $this-&gt;compile_dir;
+        $smarty_compiler-&gt;plugins_dir       = $this-&gt;plugins_dir;
+        $smarty_compiler-&gt;config_dir        = $this-&gt;config_dir;
+        $smarty_compiler-&gt;force_compile     = $this-&gt;force_compile;
+        $smarty_compiler-&gt;caching           = $this-&gt;caching;
+        $smarty_compiler-&gt;php_handling      = $this-&gt;php_handling;
+        $smarty_compiler-&gt;left_delimiter    = $this-&gt;left_delimiter;
+        $smarty_compiler-&gt;right_delimiter   = $this-&gt;right_delimiter;
+        $smarty_compiler-&gt;_version          = $this-&gt;_version;
+        $smarty_compiler-&gt;security          = $this-&gt;security;
+        $smarty_compiler-&gt;secure_dir        = $this-&gt;secure_dir;
+        $smarty_compiler-&gt;security_settings = $this-&gt;security_settings;
+        $smarty_compiler-&gt;trusted_dir       = $this-&gt;trusted_dir;
+        $smarty_compiler-&gt;use_sub_dirs      = $this-&gt;use_sub_dirs;
+        $smarty_compiler-&gt;_reg_objects      = &amp;$this-&gt;_reg_objects;
+        $smarty_compiler-&gt;_plugins          = &amp;$this-&gt;_plugins;
+        $smarty_compiler-&gt;_tpl_vars         = &amp;$this-&gt;_tpl_vars;
+        $smarty_compiler-&gt;default_modifiers = $this-&gt;default_modifiers;
+        $smarty_compiler-&gt;compile_id        = $this-&gt;_compile_id;
+        $smarty_compiler-&gt;_config            = $this-&gt;_config;
+        $smarty_compiler-&gt;request_use_auto_globals  = $this-&gt;request_use_auto_globals;
+
+        if (isset($cache_include_path) &amp;&amp; isset($this-&gt;_cache_serials[$cache_include_path])) {
+            $smarty_compiler-&gt;_cache_serial = $this-&gt;_cache_serials[$cache_include_path];
+        }
+        $smarty_compiler-&gt;_cache_include = $cache_include_path;
+
+
+        $_results = $smarty_compiler-&gt;_compile_file($resource_name, $source_content, $compiled_content);
+
+        if ($smarty_compiler-&gt;_cache_serial) {
+            $this-&gt;_cache_include_info = array(
+                'cache_serial'=&gt;$smarty_compiler-&gt;_cache_serial
+                ,'plugins_code'=&gt;$smarty_compiler-&gt;_plugins_code
+                ,'include_file_path' =&gt; $cache_include_path);
+
+        } else {
+            $this-&gt;_cache_include_info = null;
+
+        }
+
+        return $_results;
+    }
+
+    /**
+     * Get the compile path for this resource
+     *
+     * @param string $resource_name
+     * @return string results of {@link _get_auto_filename()}
+     */
+    function _get_compile_path($resource_name)
+    {
+        return $this-&gt;_get_auto_filename($this-&gt;compile_dir, $resource_name,
+                                         $this-&gt;_compile_id) . '.php';
+    }
+
+    /**
+     * fetch the template info. Gets timestamp, and source
+     * if get_source is true
+     *
+     * sets $source_content to the source of the template, and
+     * $resource_timestamp to its time stamp
+     * @param string $resource_name
+     * @param string $source_content
+     * @param integer $resource_timestamp
+     * @param boolean $get_source
+     * @param boolean $quiet
+     * @return boolean
+     */
+
+    function _fetch_resource_info(&amp;$params)
+    {
+        if(!isset($params['get_source'])) { $params['get_source'] = true; }
+        if(!isset($params['quiet'])) { $params['quiet'] = false; }
+
+        $_return = false;
+        $_params = array('resource_name' =&gt; $params['resource_name']) ;
+        if (isset($params['resource_base_path']))
+            $_params['resource_base_path'] = $params['resource_base_path'];
+        else
+            $_params['resource_base_path'] = $this-&gt;template_dir;
+
+        if ($this-&gt;_parse_resource_name($_params)) {
+            $_resource_type = $_params['resource_type'];
+            $_resource_name = $_params['resource_name'];
+            switch ($_resource_type) {
+                case 'file':
+                    if ($params['get_source']) {
+                        $params['source_content'] = $this-&gt;_read_file($_resource_name);
+                    }
+                    $params['resource_timestamp'] = filemtime($_resource_name);
+                    $_return = is_file($_resource_name);
+                    break;
+
+                default:
+                    // call resource functions to fetch the template source and timestamp
+                    if ($params['get_source']) {
+                        $_source_return = isset($this-&gt;_plugins['resource'][$_resource_type]) &amp;&amp;
+                            call_user_func_array($this-&gt;_plugins['resource'][$_resource_type][0][0],
+                                                 array($_resource_name, &amp;$params['source_content'], &amp;$this));
+                    } else {
+                        $_source_return = true;
+                    }
+
+                    $_timestamp_return = isset($this-&gt;_plugins['resource'][$_resource_type]) &amp;&amp;
+                        call_user_func_array($this-&gt;_plugins['resource'][$_resource_type][0][1],
+                                             array($_resource_name, &amp;$params['resource_timestamp'], &amp;$this));
+
+                    $_return = $_source_return &amp;&amp; $_timestamp_return;
+                    break;
+            }
+        }
+
+        if (!$_return) {
+            // see if we can get a template with the default template handler
+            if (!empty($this-&gt;default_template_handler_func)) {
+                if (!is_callable($this-&gt;default_template_handler_func)) {
+                    $this-&gt;trigger_error(&quot;default template handler function \&quot;$this-&gt;default_template_handler_func\&quot; doesn't exist.&quot;);
+                } else {
+                    $_return = call_user_func_array(
+                        $this-&gt;default_template_handler_func,
+                        array($_params['resource_type'], $_params['resource_name'], &amp;$params['source_content'], &amp;$params['resource_timestamp'], &amp;$this));
+                }
+            }
+        }
+
+        if (!$_return) {
+            if (!$params['quiet']) {
+                $this-&gt;trigger_error('unable to read resource: &quot;' . $params['resource_name'] . '&quot;');
+            }
+        } else if ($_return &amp;&amp; $this-&gt;security) {
+            require_once(SMARTY_CORE_DIR . 'core.is_secure.php');
+            if (!smarty_core_is_secure($_params, $this)) {
+                if (!$params['quiet'])
+                    $this-&gt;trigger_error('(secure mode) accessing &quot;' . $params['resource_name'] . '&quot; is not allowed');
+                $params['source_content'] = null;
+                $params['resource_timestamp'] = null;
+                return false;
+            }
+        }
+        return $_return;
+    }
+
+
+    /**
+     * parse out the type and name from the resource
+     *
+     * @param string $resource_base_path
+     * @param string $resource_name
+     * @param string $resource_type
+     * @param string $resource_name
+     * @return boolean
+     */
+
+    function _parse_resource_name(&amp;$params)
+    {
+
+        // split tpl_path by the first colon
+        $_resource_name_parts = explode(':', $params['resource_name'], 2);
+
+        if (count($_resource_name_parts) == 1) {
+            // no resource type given
+            $params['resource_type'] = $this-&gt;default_resource_type;
+            $params['resource_name'] = $_resource_name_parts[0];
+        } else {
+            if(strlen($_resource_name_parts[0]) == 1) {
+                // 1 char is not resource type, but part of filepath
+                $params['resource_type'] = $this-&gt;default_resource_type;
+                $params['resource_name'] = $params['resource_name'];
+            } else {
+                $params['resource_type'] = $_resource_name_parts[0];
+                $params['resource_name'] = $_resource_name_parts[1];
+            }
+        }
+
+        if ($params['resource_type'] == 'file') {
+            if (!preg_match('/^([\/\\\\]|[a-zA-Z]:[\/\\\\])/', $params['resource_name'])) {
+                // relative pathname to $params['resource_base_path']
+                // use the first directory where the file is found
+                foreach ((array)$params['resource_base_path'] as $_curr_path) {
+                    $_fullpath = $_curr_path . DIRECTORY_SEPARATOR . $params['resource_name'];
+                    if (file_exists($_fullpath) &amp;&amp; is_file($_fullpath)) {
+                        $params['resource_name'] = $_fullpath;
+                        return true;
+                    }
+                    // didn't find the file, try include_path
+                    $_params = array('file_path' =&gt; $_fullpath);
+                    require_once(SMARTY_CORE_DIR . 'core.get_include_path.php');
+                    if(smarty_core_get_include_path($_params, $this)) {
+                        $params['resource_name'] = $_params['new_file_path'];
+                        return true;
+                    }
+                }
+                return false;
+            } else {
+                /* absolute path */
+                return file_exists($params['resource_name']);
+            }
+        } elseif (empty($this-&gt;_plugins['resource'][$params['resource_type']])) {
+            $_params = array('type' =&gt; $params['resource_type']);
+            require_once(SMARTY_CORE_DIR . 'core.load_resource_plugin.php');
+            smarty_core_load_resource_plugin($_params, $this);
+        }
+
+        return true;
+    }
+
+
+    /**
+     * Handle modifiers
+     *
+     * @param string|null $modifier_name
+     * @param array|null $map_array
+     * @return string result of modifiers
+     */
+    function _run_mod_handler()
+    {
+        $_args = func_get_args();
+        list($_modifier_name, $_map_array) = array_splice($_args, 0, 2);
+        list($_func_name, $_tpl_file, $_tpl_line) =
+            $this-&gt;_plugins['modifier'][$_modifier_name];
+
+        $_var = $_args[0];
+        foreach ($_var as $_key =&gt; $_val) {
+            $_args[0] = $_val;
+            $_var[$_key] = call_user_func_array($_func_name, $_args);
+        }
+        return $_var;
+    }
+
+    /**
+     * Remove starting and ending quotes from the string
+     *
+     * @param string $string
+     * @return string
+     */
+    function _dequote($string)
+    {
+        if (($string{0} == &quot;'&quot; || $string{0} == '&quot;') &amp;&amp;
+            $string{strlen($string)-1} == $string{0})
+            return substr($string, 1, -1);
+        else
+            return $string;
+    }
+
+
+    /**
+     * read in a file
+     *
+     * @param string $filename
+     * @return string
+     */
+    function _read_file($filename)
+    {
+        if ( file_exists($filename) &amp;&amp; ($fd = @fopen($filename, 'rb')) ) {
+            $contents = ($size = filesize($filename)) ? fread($fd, $size) : '';
+            fclose($fd);
+            return $contents;
+        } else {
+            return false;
+        }
+    }
+
+    /**
+     * get a concrete filename for automagically created content
+     *
+     * @param string $auto_base
+     * @param string $auto_source
+     * @param string $auto_id
+     * @return string
+     * @staticvar string|null
+     * @staticvar string|null
+     */
+    function _get_auto_filename($auto_base, $auto_source = null, $auto_id = null)
+    {
+        $_compile_dir_sep =  $this-&gt;use_sub_dirs ? DIRECTORY_SEPARATOR : '^';
+        $_return = $auto_base . DIRECTORY_SEPARATOR;
+
+        if(isset($auto_id)) {
+            // make auto_id safe for directory names
+            $auto_id = str_replace('%7C',$_compile_dir_sep,(urlencode($auto_id)));
+            // split into separate directories
+            $_return .= $auto_id . $_compile_dir_sep;
+        }
+
+        if(isset($auto_source)) {
+            // make source name safe for filename
+            $_filename = urlencode(basename($auto_source));
+            $_crc32 = sprintf('%08X', crc32($auto_source));
+            // prepend %% to avoid name conflicts with
+            // with $params['auto_id'] names
+            $_crc32 = substr($_crc32, 0, 2) . $_compile_dir_sep .
+                      substr($_crc32, 0, 3) . $_compile_dir_sep . $_crc32;
+            $_return .= '%%' . $_crc32 . '%%' . $_filename;
+        }
+
+        return $_return;
+    }
+
+    /**
+     * unlink a file, possibly using expiration time
+     *
+     * @param string $resource
+     * @param integer $exp_time
+     */
+    function _unlink($resource, $exp_time = null)
+    {
+        if(isset($exp_time)) {
+            if(time() - @filemtime($resource) &gt;= $exp_time) {
+                return @unlink($resource);
+            }
+        } else {
+            return @unlink($resource);
+        }
+    }
+
+    /**
+     * returns an auto_id for auto-file-functions
+     *
+     * @param string $cache_id
+     * @param string $compile_id
+     * @return string|null
+     */
+    function _get_auto_id($cache_id=null, $compile_id=null) {
+    if (isset($cache_id))
+        return (isset($compile_id)) ? $cache_id . '|' . $compile_id  : $cache_id;
+    elseif(isset($compile_id))
+        return $compile_id;
+    else
+        return null;
+    }
+
+    /**
+     * trigger Smarty plugin error
+     *
+     * @param string $error_msg
+     * @param string $tpl_file
+     * @param integer $tpl_line
+     * @param string $file
+     * @param integer $line
+     * @param integer $error_type
+     */
+    function _trigger_fatal_error($error_msg, $tpl_file = null, $tpl_line = null,
+            $file = null, $line = null, $error_type = E_USER_ERROR)
+    {
+        if(isset($file) &amp;&amp; isset($line)) {
+            $info = ' ('.basename($file).&quot;, line $line)&quot;;
+        } else {
+            $info = '';
+        }
+        if (isset($tpl_line) &amp;&amp; isset($tpl_file)) {
+            $this-&gt;trigger_error('[in ' . $tpl_file . ' line ' . $tpl_line . &quot;]: $error_msg$info&quot;, $error_type);
+        } else {
+            $this-&gt;trigger_error($error_msg . $info, $error_type);
+        }
+    }
+
+
+    /**
+     * callback function for preg_replace, to call a non-cacheable block
+     * @return string
+     */
+    function _process_compiled_include_callback($match) {
+        $_func = '_smarty_tplfunc_'.$match[2].'_'.$match[3];
+        ob_start();
+        $_func($this);
+        $_ret = ob_get_contents();
+        ob_end_clean();
+        return $_ret;
+    }
+
+
+    /**
+     * called for included templates
+     *
+     * @param string $_smarty_include_tpl_file
+     * @param string $_smarty_include_vars
+     */
+
+    // $_smarty_include_tpl_file, $_smarty_include_vars
+
+    function _smarty_include($params)
+    {
+        if ($this-&gt;debugging) {
+            $_params = array();
+            require_once(SMARTY_CORE_DIR . 'core.get_microtime.php');
+            $debug_start_time = smarty_core_get_microtime($_params, $this);
+            $this-&gt;_smarty_debug_info[] = array('type'      =&gt; 'template',
+                                                  'filename'  =&gt; $params['smarty_include_tpl_file'],
+                                                  'depth'     =&gt; ++$this-&gt;_inclusion_depth);
+            $included_tpls_idx = count($this-&gt;_smarty_debug_info) - 1;
+        }
+
+        $this-&gt;_tpl_vars = array_merge($this-&gt;_tpl_vars, $params['smarty_include_vars']);
+
+        // config vars are treated as local, so push a copy of the
+        // current ones onto the front of the stack
+        array_unshift($this-&gt;_config, $this-&gt;_config[0]);
+
+        $_smarty_compile_path = $this-&gt;_get_compile_path($params['smarty_include_tpl_file']);
+
+
+        if ($this-&gt;_is_compiled($params['smarty_include_tpl_file'], $_smarty_compile_path)
+            || $this-&gt;_compile_resource($params['smarty_include_tpl_file'], $_smarty_compile_path))
+        {
+            include($_smarty_compile_path);
+        }
+
+        // pop the local vars off the front of the stack
+        array_shift($this-&gt;_config);
+
+        $this-&gt;_inclusion_depth--;
+
+        if ($this-&gt;debugging) {
+            // capture time for debugging info
+            $_params = array();
+            require_once(SMARTY_CORE_DIR . 'core.get_microtime.php');
+            $this-&gt;_smarty_debug_info[$included_tpls_idx]['exec_time'] = smarty_core_get_microtime($_params, $this) - $debug_start_time;
+        }
+
+        if ($this-&gt;caching) {
+            $this-&gt;_cache_info['template'][$params['smarty_include_tpl_file']] = true;
+        }
+    }
+
+
+    /**
+     * get or set an array of cached attributes for function that is
+     * not cacheable
+     * @return array
+     */
+    function &amp;_smarty_cache_attrs($cache_serial, $count) {
+        $_cache_attrs =&amp; $this-&gt;_cache_info['cache_attrs'][$cache_serial][$count];
+
+        if ($this-&gt;_cache_including) {
+            /* return next set of cache_attrs */
+            $_return = current($_cache_attrs);
+            next($_cache_attrs);
+            return $_return;
+
+        } else {
+            /* add a reference to a new set of cache_attrs */
+            $_cache_attrs[] = array();
+            return $_cache_attrs[count($_cache_attrs)-1];
+
+        }
+
+    }
+
+
+    /**
+     * wrapper for include() retaining $this
+     * @return mixed
+     */
+    function _include($filename, $once=false, $params=null)
+    {
+        if ($once) {
+            return include_once($filename);
+        } else {
+            return include($filename);
+        }
+    }
+
+
+    /**
+     * wrapper for eval() retaining $this
+     * @return mixed
+     */
+    function _eval($code, $params=null)
+    {
+        return eval($code);
+    }
+    /**#@-*/
+
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Smarty_Compiler.class.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Smarty_Compiler.class.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/Smarty_Compiler.class.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,2259 +1,2311 @@
-&lt;?php
-
-if (!defined('SMARTY_DIR')) {
-	exit();
-}
-/**
- * Project:     Smarty: the PHP compiling template engine
- * File:        Smarty_Compiler.class.php
- *
- * This library is free software; you can redistribute it and/or
- * modify it under the terms of the GNU Lesser General Public
- * License as published by the Free Software Foundation; either
- * version 2.1 of the License, or (at your option) any later version.
- *
- * This library is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
- * Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU Lesser General Public
- * License along with this library; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- *
- * @link <A HREF="http://smarty.php.net/">http://smarty.php.net/</A>
- * @author Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @author Andrei Zmievski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">andrei at php.net</A>&gt;
- * @version 2.6.5-dev
- * @copyright 2001-2004 ispi of Lincoln, Inc.
- * @package Smarty
- */
-
-/* $Id$ */
-
-/**
- * Template compiling class
- * @package Smarty
- */
-class Smarty_Compiler extends Smarty {
-
-    // internal vars
-    /**#@+
-     * @access private
-     */
-    var $_folded_blocks         =   array();    // keeps folded template blocks
-    var $_current_file          =   null;       // the current template being compiled
-    var $_current_line_no       =   1;          // line number for error messages
-    var $_capture_stack         =   array();    // keeps track of nested capture buffers
-    var $_plugin_info           =   array();    // keeps track of plugins to load
-    var $_init_smarty_vars      =   false;
-    var $_permitted_tokens      =   array('true','false','yes','no','on','off','null');
-    var $_db_qstr_regexp        =   null;        // regexps are setup in the constructor
-    var $_si_qstr_regexp        =   null;
-    var $_qstr_regexp           =   null;
-    var $_func_regexp           =   null;
-    var $_var_bracket_regexp    =   null;
-    var $_dvar_guts_regexp      =   null;
-    var $_dvar_regexp           =   null;
-    var $_cvar_regexp           =   null;
-    var $_svar_regexp           =   null;
-    var $_avar_regexp           =   null;
-    var $_mod_regexp            =   null;
-    var $_var_regexp            =   null;
-    var $_parenth_param_regexp  =   null;
-    var $_func_call_regexp      =   null;
-    var $_obj_ext_regexp        =   null;
-    var $_obj_start_regexp      =   null;
-    var $_obj_params_regexp     =   null;
-    var $_obj_call_regexp       =   null;
-    var $_cacheable_state       =   0;
-    var $_cache_attrs_count     =   0;
-    var $_nocache_count         =   0;
-    var $_cache_serial          =   null;
-    var $_cache_include         =   null;
-
-    var $_strip_depth           =   0;
-    var $_additional_newline    =   &quot;\n&quot;;
-
-    /**#@-*/
-    /**
-     * The class constructor.
-     */
-    function Smarty_Compiler()
-    {
-        // matches double quoted strings:
-        // &quot;foobar&quot;
-        // &quot;foo\&quot;bar&quot;
-        $this-&gt;_db_qstr_regexp = '&quot;[^&quot;\\\\]*(?:\\\\.[^&quot;\\\\]*)*&quot;';
-
-        // matches single quoted strings:
-        // 'foobar'
-        // 'foo\'bar'
-        $this-&gt;_si_qstr_regexp = '\'[^\'\\\\]*(?:\\\\.[^\'\\\\]*)*\'';
-
-        // matches single or double quoted strings
-        $this-&gt;_qstr_regexp = '(?:' . $this-&gt;_db_qstr_regexp . '|' . $this-&gt;_si_qstr_regexp . ')';
-
-        // matches bracket portion of vars
-        // [0]
-        // [foo]
-        // [$bar]
-        $this-&gt;_var_bracket_regexp = '\[\$?[\w\.]+\]';
-
-        // matches numerical constants
-        // 30
-        // -12
-        // 13.22
-        $this-&gt;_num_const_regexp = '\-?\d+(?:\.\d+)?';
-
-        // matches $ vars (not objects):
-        // $foo
-        // $foo.bar
-        // $foo.bar.foobar
-        // $foo[0]
-        // $foo[$bar]
-        // $foo[5][blah]
-        // $foo[5].bar[$foobar][4]
-        $this-&gt;_dvar_math_regexp = '(?:[\+\*\/\%]|(?:-(?!&gt;)))';
-        $this-&gt;_dvar_math_var_regexp = '[\$\w\.\+\-\*\/\%\d\&gt;\[\]]';
-        $this-&gt;_dvar_guts_regexp = '\w+(?:' . $this-&gt;_var_bracket_regexp
-                . ')*(?:\.\$?\w+(?:' . $this-&gt;_var_bracket_regexp . ')*)*(?:' . $this-&gt;_dvar_math_regexp . '(?:' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_dvar_math_var_regexp . ')*)?';
-        $this-&gt;_dvar_regexp = '\$' . $this-&gt;_dvar_guts_regexp;
-
-        // matches config vars:
-        // #foo#
-        // #foobar123_foo#
-        $this-&gt;_cvar_regexp = '\#\w+\#';
-
-        // matches section vars:
-        // %foo.bar%
-        $this-&gt;_svar_regexp = '\%\w+\.\w+\%';
-
-        // matches all valid variables (no quotes, no modifiers)
-        $this-&gt;_avar_regexp = '(?:' . $this-&gt;_dvar_regexp . '|'
-           . $this-&gt;_cvar_regexp . '|' . $this-&gt;_svar_regexp . ')';
-
-        // matches valid variable syntax:
-        // $foo
-        // $foo
-        // #foo#
-        // #foo#
-        // &quot;text&quot;
-        // &quot;text&quot;
-        $this-&gt;_var_regexp = '(?:' . $this-&gt;_avar_regexp . '|' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_qstr_regexp . ')';
-
-        // matches valid object call (one level of object nesting allowed in parameters):
-        // $foo-&gt;bar
-        // $foo-&gt;bar()
-        // $foo-&gt;bar(&quot;text&quot;)
-        // $foo-&gt;bar($foo, $bar, &quot;text&quot;)
-        // $foo-&gt;bar($foo, &quot;foo&quot;)
-        // $foo-&gt;bar-&gt;foo()
-        // $foo-&gt;bar-&gt;foo-&gt;bar()
-        // $foo-&gt;bar($foo-&gt;bar)
-        // $foo-&gt;bar($foo-&gt;bar())
-        // $foo-&gt;bar($foo-&gt;bar($blah,$foo,44,&quot;foo&quot;,$foo[0].bar))
-        $this-&gt;_obj_ext_regexp = '\-&gt;(?:\$?' . $this-&gt;_dvar_guts_regexp . ')';
-        $this-&gt;_obj_restricted_param_regexp = '(?:'
-                . $this-&gt;_var_regexp . '(?:' . $this-&gt;_obj_ext_regexp . '(?:\((?:' . $this-&gt;_var_regexp
-                . '(?:\s*,\s*' . $this-&gt;_var_regexp . ')*)?\))?)*)';
-        $this-&gt;_obj_single_param_regexp = '(?:\w+|' . $this-&gt;_obj_restricted_param_regexp . '(?:\s*,\s*(?:(?:\w+|'
-                . $this-&gt;_var_regexp . $this-&gt;_obj_restricted_param_regexp . ')))*)';
-        $this-&gt;_obj_params_regexp = '\((?:' . $this-&gt;_obj_single_param_regexp
-                . '(?:\s*,\s*' . $this-&gt;_obj_single_param_regexp . ')*)?\)';
-        $this-&gt;_obj_start_regexp = '(?:' . $this-&gt;_dvar_regexp . '(?:' . $this-&gt;_obj_ext_regexp . ')+)';
-        $this-&gt;_obj_call_regexp = '(?:' . $this-&gt;_obj_start_regexp . '(?:' . $this-&gt;_obj_params_regexp . ')?(?:' . $this-&gt;_dvar_math_regexp . '(?:' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_dvar_math_var_regexp . ')*)?)';
-        
-        // matches valid modifier syntax:
-        // |foo
-        // |@foo
-        // |foo:&quot;bar&quot;
-        // |foo:$bar
-        // |foo:&quot;bar&quot;:$foobar
-        // |foo|bar
-        // |foo:$foo-&gt;bar
-        $this-&gt;_mod_regexp = '(?:\|@?\w+(?::(?&gt;-?\w+|'
-           . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_avar_regexp . '|' . $this-&gt;_qstr_regexp .'))*)';
-
-        // matches valid function name:
-        // foo123
-        // _foo_bar
-        $this-&gt;_func_regexp = '[a-zA-Z_]\w*';
-
-        // matches valid registered object:
-        // foo-&gt;bar
-        $this-&gt;_reg_obj_regexp = '[a-zA-Z_]\w*-&gt;[a-zA-Z_]\w*';
-
-        // matches valid parameter values:
-        // true
-        // $foo
-        // $foo|bar
-        // #foo#
-        // #foo#|bar
-        // &quot;text&quot;
-        // &quot;text&quot;|bar
-        // $foo-&gt;bar
-        $this-&gt;_param_regexp = '(?:\s*(?:' . $this-&gt;_obj_call_regexp . '|'
-           . $this-&gt;_var_regexp  . '|\w+)(?&gt;' . $this-&gt;_mod_regexp . '*)\s*)';
-
-        // matches valid parenthesised function parameters:
-        //
-        // &quot;text&quot;
-        //    $foo, $bar, &quot;text&quot;
-        // $foo|bar, &quot;foo&quot;|bar, $foo-&gt;bar($foo)|bar
-        $this-&gt;_parenth_param_regexp = '(?:\((?:\w+|'
-                . $this-&gt;_param_regexp . '(?:\s*,\s*(?:(?:\w+|'
-                . $this-&gt;_param_regexp . ')))*)?\))';
-
-        // matches valid function call:
-        // foo()
-        // foo_bar($foo)
-        // _foo_bar($foo,&quot;bar&quot;)
-        // foo123($foo,$foo-&gt;bar(),&quot;foo&quot;)
-        $this-&gt;_func_call_regexp = '(?:' . $this-&gt;_func_regexp . '\s*(?:'
-           . $this-&gt;_parenth_param_regexp . '))';
-    }
-
-    /**
-     * compile a resource
-     *
-     * sets $compiled_content to the compiled source
-     * @param string $resource_name
-     * @param string $source_content
-     * @param string $compiled_content
-     * @return true
-     */
-    function _compile_file($resource_name, $source_content, &amp;$compiled_content)
-    {
-
-        if ($this-&gt;security) {
-            // do not allow php syntax to be executed unless specified
-            if ($this-&gt;php_handling == SMARTY_PHP_ALLOW &amp;&amp;
-                !$this-&gt;security_settings['PHP_HANDLING']) {
-                $this-&gt;php_handling = SMARTY_PHP_PASSTHRU;
-            }
-        }
-
-        $this-&gt;_load_filters();
-
-        $this-&gt;_current_file = $resource_name;
-        $this-&gt;_current_line_no = 1;
-        $ldq = preg_quote($this-&gt;left_delimiter, '~');
-        $rdq = preg_quote($this-&gt;right_delimiter, '~');
-
-        // run template source through prefilter functions
-        if (count($this-&gt;_plugins['prefilter']) &gt; 0) {
-            foreach ($this-&gt;_plugins['prefilter'] as $filter_name =&gt; $prefilter) {
-                if ($prefilter === false) continue;
-                if ($prefilter[3] || is_callable($prefilter[0])) {
-                    $source_content = call_user_func_array($prefilter[0],
-                                                            array($source_content, &amp;$this));
-                    $this-&gt;_plugins['prefilter'][$filter_name][3] = true;
-                } else {
-                    $this-&gt;_trigger_fatal_error(&quot;[plugin] prefilter '$filter_name' is not implemented&quot;);
-                }
-            }
-        }
-
-        /* fetch all special blocks */
-        $search = &quot;~{$ldq}\*(.*?)\*{$rdq}|{$ldq}\s*literal\s*{$rdq}(.*?){$ldq}\s*/literal\s*{$rdq}|{$ldq}\s*php\s*{$rdq}(.*?){$ldq}\s*/php\s*{$rdq}~s&quot;;
-
-        preg_match_all($search, $source_content, $match,  PREG_SET_ORDER);
-        $this-&gt;_folded_blocks = $match;
-        reset($this-&gt;_folded_blocks);
-
-        /* replace special blocks by &quot;{php}&quot; */
-        $source_content = preg_replace($search.'e', &quot;'&quot;
-                                       . $this-&gt;_quote_replace($this-&gt;left_delimiter) . 'php'
-                                       . &quot;' . str_repeat(\&quot;\n\&quot;, substr_count('\\0', \&quot;\n\&quot;)) .'&quot;
-                                       . $this-&gt;_quote_replace($this-&gt;right_delimiter)
-                                       . &quot;'&quot;
-                                       , $source_content);
-
-        /* Gather all template tags. */
-        preg_match_all(&quot;~{$ldq}\s*(.*?)\s*{$rdq}~s&quot;, $source_content, $_match);
-        $template_tags = $_match[1];
-        /* Split content by template tags to obtain non-template content. */
-        $text_blocks = preg_split(&quot;~{$ldq}.*?{$rdq}~s&quot;, $source_content);
-
-        /* loop through text blocks */
-        for ($curr_tb = 0, $for_max = count($text_blocks); $curr_tb &lt; $for_max; $curr_tb++) {
-            /* match anything resembling php tags */
-            if (preg_match_all('~(&lt;\?(?:\w+|=)?|\?&gt;|language\s*=\s*[\&quot;\']?php[\&quot;\']?)~is', $text_blocks[$curr_tb], $sp_match)) {
-                /* replace tags with placeholders to prevent recursive replacements */
-                $sp_match[1] = array_unique($sp_match[1]);
-                usort($sp_match[1], '_smarty_sort_length');
-                for ($curr_sp = 0, $for_max2 = count($sp_match[1]); $curr_sp &lt; $for_max2; $curr_sp++) {
-                    $text_blocks[$curr_tb] = str_replace($sp_match[1][$curr_sp],'%%%SMARTYSP'.$curr_sp.'%%%',$text_blocks[$curr_tb]);
-                }
-                /* process each one */
-                for ($curr_sp = 0, $for_max2 = count($sp_match[1]); $curr_sp &lt; $for_max2; $curr_sp++) {
-                    if ($this-&gt;php_handling == SMARTY_PHP_PASSTHRU) {
-                        /* echo php contents */
-                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', '&lt;?php echo \''.str_replace(&quot;'&quot;, &quot;\'&quot;, $sp_match[1][$curr_sp]).'\'; ?&gt;'.&quot;\n&quot;, $text_blocks[$curr_tb]);
-                    } else if ($this-&gt;php_handling == SMARTY_PHP_QUOTE) {
-                        /* quote php tags */
-                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', htmlspecialchars($sp_match[1][$curr_sp]), $text_blocks[$curr_tb]);
-                    } else if ($this-&gt;php_handling == SMARTY_PHP_REMOVE) {
-                        /* remove php tags */
-                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', '', $text_blocks[$curr_tb]);
-                    } else {
-                        /* SMARTY_PHP_ALLOW, but echo non php starting tags */
-                        $sp_match[1][$curr_sp] = preg_replace('~(&lt;\?(?!php|=|$))~i', '&lt;?php echo \'\\1\'?&gt;'.&quot;\n&quot;, $sp_match[1][$curr_sp]);
-                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', $sp_match[1][$curr_sp], $text_blocks[$curr_tb]);
-                    }
-                }
-            }
-        }
-
-        /* Compile the template tags into PHP code. */
-        $compiled_tags = array();
-        for ($i = 0, $for_max = count($template_tags); $i &lt; $for_max; $i++) {
-            $this-&gt;_current_line_no += substr_count($text_blocks[$i], &quot;\n&quot;);
-            $compiled_tags[] = $this-&gt;_compile_tag($template_tags[$i]);
-            $this-&gt;_current_line_no += substr_count($template_tags[$i], &quot;\n&quot;);
-        }
-        if (count($this-&gt;_tag_stack)&gt;0) {
-            list($_open_tag, $_line_no) = end($this-&gt;_tag_stack);
-            $this-&gt;_syntax_error(&quot;unclosed tag \{$_open_tag} (opened line $_line_no).&quot;, E_USER_ERROR, __FILE__, __LINE__);
-            return;
-        }
-
-        $compiled_content = '';
-
-        /* Interleave the compiled contents and text blocks to get the final result. */
-        for ($i = 0, $for_max = count($compiled_tags); $i &lt; $for_max; $i++) {
-            if ($compiled_tags[$i] == '') {
-                // tag result empty, remove first newline from following text block
-                $text_blocks[$i+1] = preg_replace('~^(\r\n|\r|\n)~', '', $text_blocks[$i+1]);
-            }
-            $compiled_content .= $text_blocks[$i].$compiled_tags[$i];
-        }
-        $compiled_content .= $text_blocks[$i];
-
-        /* Reformat data between 'strip' and '/strip' tags, removing spaces, tabs and newlines. */
-        if (preg_match_all(&quot;~{$ldq}strip{$rdq}.*?{$ldq}/strip{$rdq}~s&quot;, $compiled_content, $_match)) {
-            $strip_tags = $_match[0];
-            $strip_tags_modified = preg_replace(&quot;~{$ldq}/?strip{$rdq}|[\t ]+$|^[\t ]+~m&quot;, '', $strip_tags);
-            $strip_tags_modified = preg_replace('~[\r\n]+~m', '', $strip_tags_modified);
-            for ($i = 0, $for_max = count($strip_tags); $i &lt; $for_max; $i++)
-                $compiled_content = preg_replace(&quot;~{$ldq}strip{$rdq}.*?{$ldq}/strip{$rdq}~s&quot;,
-                                                  $this-&gt;_quote_replace($strip_tags_modified[$i]),
-                                                  $compiled_content, 1);
-        }
-
-        // remove \n from the end of the file, if any
-        if (($_len=strlen($compiled_content)) &amp;&amp; ($compiled_content{$_len - 1} == &quot;\n&quot; )) {
-            $compiled_content = substr($compiled_content, 0, -1);
-        }
-
-        if (!empty($this-&gt;_cache_serial)) {
-            $compiled_content = &quot;&lt;?php \$this-&gt;_cache_serials['&quot;.$this-&gt;_cache_include.&quot;'] = '&quot;.$this-&gt;_cache_serial.&quot;'; ?&gt;&quot; . $compiled_content;
-        }
-
-        // remove unnecessary close/open tags
-        $compiled_content = preg_replace('~\?&gt;\n?&lt;\?php~', '', $compiled_content);
-
-        // run compiled template through postfilter functions
-        if (count($this-&gt;_plugins['postfilter']) &gt; 0) {
-            foreach ($this-&gt;_plugins['postfilter'] as $filter_name =&gt; $postfilter) {
-                if ($postfilter === false) continue;
-                if ($postfilter[3] || is_callable($postfilter[0])) {
-                    $compiled_content = call_user_func_array($postfilter[0],
-                                                              array($compiled_content, &amp;$this));
-                    $this-&gt;_plugins['postfilter'][$filter_name][3] = true;
-                } else {
-                    $this-&gt;_trigger_fatal_error(&quot;Smarty plugin error: postfilter '$filter_name' is not implemented&quot;);
-                }
-            }
-        }
-
-        // put header at the top of the compiled template
-        $template_header = &quot;&lt;?php /* Smarty version &quot;.$this-&gt;_version.&quot;, created on &quot;.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;).&quot;\n&quot;;
-        $template_header .= &quot;         compiled from &quot;.strtr(urlencode($resource_name), array('%2F'=&gt;'/', '%3A'=&gt;':')).&quot; */ ?&gt;\n&quot;;
-
-        /* Emit code to load needed plugins. */
-        $this-&gt;_plugins_code = '';
-        if (count($this-&gt;_plugin_info)) {
-            $_plugins_params = &quot;array('plugins' =&gt; array(&quot;;
-            foreach ($this-&gt;_plugin_info as $plugin_type =&gt; $plugins) {
-                foreach ($plugins as $plugin_name =&gt; $plugin_info) {
-                    $_plugins_params .= &quot;array('$plugin_type', '$plugin_name', '$plugin_info[0]', $plugin_info[1], &quot;;
-                    $_plugins_params .= $plugin_info[2] ? 'true),' : 'false),';
-                }
-            }
-            $_plugins_params .= '))';
-            $plugins_code = &quot;&lt;?php require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.load_plugins.php');\nsmarty_core_load_plugins($_plugins_params, \$this); ?&gt;\n&quot;;
-            $template_header .= $plugins_code;
-            $this-&gt;_plugin_info = array();
-            $this-&gt;_plugins_code = $plugins_code;
-        }
-
-        if ($this-&gt;_init_smarty_vars) {
-            $template_header .= &quot;&lt;?php require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.assign_smarty_interface.php');\nsmarty_core_assign_smarty_interface(null, \$this); ?&gt;\n&quot;;
-            $this-&gt;_init_smarty_vars = false;
-        }
-
-        $compiled_content = $template_header . $compiled_content;
-        return true;
-    }
-
-    /**
-     * Compile a template tag
-     *
-     * @param string $template_tag
-     * @return string
-     */
-    function _compile_tag($template_tag)
-    {
-        /* Matched comment. */
-        if ($template_tag{0} == '*' &amp;&amp; $template_tag{strlen($template_tag) - 1} == '*')
-            return '';
-        
-        /* Split tag into two three parts: command, command modifiers and the arguments. */
-        if(! preg_match('~^(?:(' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp
-                . '|\/?' . $this-&gt;_reg_obj_regexp . '|\/?' . $this-&gt;_func_regexp . ')(' . $this-&gt;_mod_regexp . '*))
-                      (?:\s+(.*))?$
-                    ~xs', $template_tag, $match)) {
-            $this-&gt;_syntax_error(&quot;unrecognized tag: $template_tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-        
-        $tag_command = $match[1];
-        $tag_modifier = isset($match[2]) ? $match[2] : null;
-        $tag_args = isset($match[3]) ? $match[3] : null;
-
-        if (preg_match('~^' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '$~', $tag_command)) {
-            /* tag name is a variable or object */
-            $_return = $this-&gt;_parse_var_props($tag_command . $tag_modifier, $this-&gt;_parse_attrs($tag_args));
-            if(isset($_tag_attrs['assign'])) {
-                return &quot;&lt;?php \$this-&gt;assign('&quot; . $this-&gt;_dequote($_tag_attrs['assign']) . &quot;', $_return ); ?&gt;\n&quot;;
-            } else {
-                return &quot;&lt;?php echo $_return; ?&gt;&quot; . $this-&gt;_additional_newline;
-            }
-        }
-
-        /* If the tag name is a registered object, we process it. */
-        if (preg_match('~^\/?' . $this-&gt;_reg_obj_regexp . '$~', $tag_command)) {
-            return $this-&gt;_compile_registered_object_tag($tag_command, $this-&gt;_parse_attrs($tag_args), $tag_modifier);
-        }
-
-        switch ($tag_command) {
-            case 'include':
-                return $this-&gt;_compile_include_tag($tag_args);
-
-            case 'include_php':
-                return $this-&gt;_compile_include_php_tag($tag_args);
-
-            case 'if':
-                $this-&gt;_push_tag('if');
-                return $this-&gt;_compile_if_tag($tag_args);
-
-            case 'else':
-                list($_open_tag) = end($this-&gt;_tag_stack);
-                if ($_open_tag != 'if' &amp;&amp; $_open_tag != 'elseif')
-                    $this-&gt;_syntax_error('unexpected {else}', E_USER_ERROR, __FILE__, __LINE__);
-                else
-                    $this-&gt;_push_tag('else');
-                return '&lt;?php else: ?&gt;';
-
-            case 'elseif':
-                list($_open_tag) = end($this-&gt;_tag_stack);
-                if ($_open_tag != 'if' &amp;&amp; $_open_tag != 'elseif')
-                    $this-&gt;_syntax_error('unexpected {elseif}', E_USER_ERROR, __FILE__, __LINE__);
-                if ($_open_tag == 'if')
-                    $this-&gt;_push_tag('elseif');
-                return $this-&gt;_compile_if_tag($tag_args, true);
-
-            case '/if':
-                $this-&gt;_pop_tag('if');
-                return '&lt;?php endif; ?&gt;';
-
-            case 'capture':
-                return $this-&gt;_compile_capture_tag(true, $tag_args);
-
-            case '/capture':
-                return $this-&gt;_compile_capture_tag(false);
-
-            case 'ldelim':
-                return $this-&gt;left_delimiter;
-
-            case 'rdelim':
-                return $this-&gt;right_delimiter;
-
-            case 'section':
-                $this-&gt;_push_tag('section');
-                return $this-&gt;_compile_section_start($tag_args);
-
-            case 'sectionelse':
-                $this-&gt;_push_tag('sectionelse');
-                return &quot;&lt;?php endfor; else: ?&gt;&quot;;
-                break;
-
-            case '/section':
-                $_open_tag = $this-&gt;_pop_tag('section');
-                if ($_open_tag == 'sectionelse')
-                    return &quot;&lt;?php endif; ?&gt;&quot;;
-                else
-                    return &quot;&lt;?php endfor; endif; ?&gt;&quot;;
-
-            case 'foreach':
-                $this-&gt;_push_tag('foreach');
-                return $this-&gt;_compile_foreach_start($tag_args);
-                break;
-
-            case 'foreachelse':
-                $this-&gt;_push_tag('foreachelse');
-                return &quot;&lt;?php endforeach; unset(\$_from); else: ?&gt;&quot;;
-
-            case '/foreach':
-                $_open_tag = $this-&gt;_pop_tag('foreach');
-                if ($_open_tag == 'foreachelse')
-                    return &quot;&lt;?php endif; ?&gt;&quot;;
-                else
-                    return &quot;&lt;?php endforeach; unset(\$_from); endif; ?&gt;&quot;;
-                break;
-
-            case 'strip':
-            case '/strip':
-                if ($tag_command{0}=='/') {
-                    $this-&gt;_pop_tag('strip');
-                    if (--$this-&gt;_strip_depth==0) { /* outermost closing {/strip} */
-                        $this-&gt;_additional_newline = &quot;\n&quot;;
-                        return $this-&gt;left_delimiter.$tag_command.$this-&gt;right_delimiter;
-                    }
-                } else {
-                    $this-&gt;_push_tag('strip');
-                    if ($this-&gt;_strip_depth++==0) { /* outermost opening {strip} */
-                        $this-&gt;_additional_newline = &quot;&quot;;
-                        return $this-&gt;left_delimiter.$tag_command.$this-&gt;right_delimiter;
-                    }
-                }
-                return '';
-
-            case 'php':
-                /* handle folded tags replaced by {php} */
-                list(, $block) = each($this-&gt;_folded_blocks);
-                $this-&gt;_current_line_no += substr_count($block[0], &quot;\n&quot;);
-                /* the number of matched elements in the regexp in _compile_file()
-                   determins the type of folded tag that was found */
-                switch (count($block)) {
-                    case 2: /* comment */
-                        return '';
-
-                    case 3: /* literal */
-                        return &quot;&lt;?php echo '&quot; . strtr($block[2], array(&quot;'&quot;=&gt;&quot;\'&quot;, &quot;\\&quot;=&gt;&quot;\\\\&quot;)) . &quot;'; ?&gt;&quot; . $this-&gt;_additional_newline;
-
-                    case 4: /* php */
-                        if ($this-&gt;security &amp;&amp; !$this-&gt;security_settings['PHP_TAGS']) {
-                            $this-&gt;_syntax_error(&quot;(secure mode) php tags not permitted&quot;, E_USER_WARNING, __FILE__, __LINE__);
-                            return;
-                        }
-                        return '&lt;?php ' . $block[3] .' ?&gt;';
-                }
-                break;
-
-            case 'insert':
-                return $this-&gt;_compile_insert_tag($tag_args);
-
-            default:
-                if ($this-&gt;_compile_compiler_tag($tag_command, $tag_args, $output)) {
-                    return $output;
-                } else if ($this-&gt;_compile_block_tag($tag_command, $tag_args, $tag_modifier, $output)) {
-                    return $output;
-                } else if ($this-&gt;_compile_custom_tag($tag_command, $tag_args, $tag_modifier, $output)) {
-                    return $output;                    
-                } else {
-                    $this-&gt;_syntax_error(&quot;unrecognized tag '$tag_command'&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                }
-
-        }
-    }
-
-
-    /**
-     * compile the custom compiler tag
-     *
-     * sets $output to the compiled custom compiler tag
-     * @param string $tag_command
-     * @param string $tag_args
-     * @param string $output
-     * @return boolean
-     */
-    function _compile_compiler_tag($tag_command, $tag_args, &amp;$output)
-    {
-        $found = false;
-        $have_function = true;
-
-        /*
-         * First we check if the compiler function has already been registered
-         * or loaded from a plugin file.
-         */
-        if (isset($this-&gt;_plugins['compiler'][$tag_command])) {
-            $found = true;
-            $plugin_func = $this-&gt;_plugins['compiler'][$tag_command][0];
-            if (!is_callable($plugin_func)) {
-                $message = &quot;compiler function '$tag_command' is not implemented&quot;;
-                $have_function = false;
-            }
-        }
-        /*
-         * Otherwise we need to load plugin file and look for the function
-         * inside it.
-         */
-        else if ($plugin_file = $this-&gt;_get_plugin_filepath('compiler', $tag_command)) {
-            $found = true;
-
-            include_once $plugin_file;
-
-            $plugin_func = 'smarty_compiler_' . $tag_command;
-            if (!is_callable($plugin_func)) {
-                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
-                $have_function = false;
-            } else {
-                $this-&gt;_plugins['compiler'][$tag_command] = array($plugin_func, null, null, null, true);
-            }
-        }
-
-        /*
-         * True return value means that we either found a plugin or a
-         * dynamically registered function. False means that we didn't and the
-         * compiler should now emit code to load custom function plugin for this
-         * tag.
-         */
-        if ($found) {
-            if ($have_function) {
-                $output = call_user_func_array($plugin_func, array($tag_args, &amp;$this));
-                if($output != '') {
-                $output = '&lt;?php ' . $this-&gt;_push_cacheable_state('compiler', $tag_command)
-                                   . $output
-                                   . $this-&gt;_pop_cacheable_state('compiler', $tag_command) . ' ?&gt;';
-                }
-            } else {
-                $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
-            }
-            return true;
-        } else {
-            return false;
-        }
-    }
-
-
-    /**
-     * compile block function tag
-     *
-     * sets $output to compiled block function tag
-     * @param string $tag_command
-     * @param string $tag_args
-     * @param string $tag_modifier
-     * @param string $output
-     * @return boolean
-     */
-    function _compile_block_tag($tag_command, $tag_args, $tag_modifier, &amp;$output)
-    {
-        if ($tag_command{0} == '/') {
-            $start_tag = false;
-            $tag_command = substr($tag_command, 1);
-        } else
-            $start_tag = true;
-
-        $found = false;
-        $have_function = true;
-
-        /*
-         * First we check if the block function has already been registered
-         * or loaded from a plugin file.
-         */
-        if (isset($this-&gt;_plugins['block'][$tag_command])) {
-            $found = true;
-            $plugin_func = $this-&gt;_plugins['block'][$tag_command][0];
-            if (!is_callable($plugin_func)) {
-                $message = &quot;block function '$tag_command' is not implemented&quot;;
-                $have_function = false;
-            }
-        }
-        /*
-         * Otherwise we need to load plugin file and look for the function
-         * inside it.
-         */
-        else if ($plugin_file = $this-&gt;_get_plugin_filepath('block', $tag_command)) {
-            $found = true;
-
-            include_once $plugin_file;
-
-            $plugin_func = 'smarty_block_' . $tag_command;
-            if (!function_exists($plugin_func)) {
-                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
-                $have_function = false;
-            } else {
-                $this-&gt;_plugins['block'][$tag_command] = array($plugin_func, null, null, null, true);
-
-            }
-        }
-
-        if (!$found) {
-            return false;
-        } else if (!$have_function) {
-            $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
-            return true;
-        }
-
-        /*
-         * Even though we've located the plugin function, compilation
-         * happens only once, so the plugin will still need to be loaded
-         * at runtime for future requests.
-         */
-        $this-&gt;_add_plugin('block', $tag_command);
-
-        if ($start_tag)
-            $this-&gt;_push_tag($tag_command);
-        else
-            $this-&gt;_pop_tag($tag_command);
-
-        if ($start_tag) {
-            $output = '&lt;?php ' . $this-&gt;_push_cacheable_state('block', $tag_command);
-            $attrs = $this-&gt;_parse_attrs($tag_args);
-            $arg_list = $this-&gt;_compile_arg_list('block', $tag_command, $attrs, $_cache_attrs='');
-            $output .= &quot;$_cache_attrs\$this-&gt;_tag_stack[] = array('$tag_command', array(&quot;.implode(',', $arg_list).')); ';
-            $output .= $this-&gt;_compile_plugin_call('block', $tag_command).'($this-&gt;_tag_stack[count($this-&gt;_tag_stack)-1][1], null, $this, $_block_repeat=true);';
-            $output .= 'while ($_block_repeat) { ob_start(); ?&gt;';
-        } else {
-            $output = '&lt;?php $this-&gt;_block_content = ob_get_contents(); ob_end_clean(); ';
-            $_out_tag_text = $this-&gt;_compile_plugin_call('block', $tag_command).'($this-&gt;_tag_stack[count($this-&gt;_tag_stack)-1][1], $this-&gt;_block_content, $this, $_block_repeat=false)';
-            if ($tag_modifier != '') {
-                $this-&gt;_parse_modifiers($_out_tag_text, $tag_modifier);
-            }
-            $output .= 'echo '.$_out_tag_text.'; } ';
-            $output .= &quot; array_pop(\$this-&gt;_tag_stack); &quot; . $this-&gt;_pop_cacheable_state('block', $tag_command) . '?&gt;';
-        }
-
-        return true;
-    }
-
-
-    /**
-     * compile custom function tag
-     *
-     * @param string $tag_command
-     * @param string $tag_args
-     * @param string $tag_modifier
-     * @return string
-     */
-    function _compile_custom_tag($tag_command, $tag_args, $tag_modifier, &amp;$output)
-    {
-        $found = false;
-        $have_function = true;
-
-        /*
-         * First we check if the custom function has already been registered
-         * or loaded from a plugin file.
-         */
-        if (isset($this-&gt;_plugins['function'][$tag_command])) {
-            $found = true;
-            $plugin_func = $this-&gt;_plugins['function'][$tag_command][0];
-            if (!is_callable($plugin_func)) {
-                $message = &quot;custom function '$tag_command' is not implemented&quot;;
-                $have_function = false;
-            }
-        }
-        /*
-         * Otherwise we need to load plugin file and look for the function
-         * inside it.
-         */
-        else if ($plugin_file = $this-&gt;_get_plugin_filepath('function', $tag_command)) {
-            $found = true;
-
-            include_once $plugin_file;
-
-            $plugin_func = 'smarty_function_' . $tag_command;
-            if (!function_exists($plugin_func)) {
-                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
-                $have_function = false;
-            } else {
-                $this-&gt;_plugins['function'][$tag_command] = array($plugin_func, null, null, null, true);
-
-            }
-        }
-
-        if (!$found) {
-            return false;
-        } else if (!$have_function) {
-            $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
-            return true;
-        }
-
-        /* declare plugin to be loaded on display of the template that
-           we compile right now */
-        $this-&gt;_add_plugin('function', $tag_command);
-
-        $_cacheable_state = $this-&gt;_push_cacheable_state('function', $tag_command);
-        $attrs = $this-&gt;_parse_attrs($tag_args);
-        $arg_list = $this-&gt;_compile_arg_list('function', $tag_command, $attrs, $_cache_attrs='');
-
-        $output = $this-&gt;_compile_plugin_call('function', $tag_command).'(array('.implode(',', $arg_list).&quot;), \$this)&quot;;
-        if($tag_modifier != '') {
-            $this-&gt;_parse_modifiers($output, $tag_modifier);
-        }
-
-        if($output != '') {
-            $output =  '&lt;?php ' . $_cacheable_state . $_cache_attrs . 'echo ' . $output . ';'
-                . $this-&gt;_pop_cacheable_state('function', $tag_command) . &quot;?&gt;&quot; . $this-&gt;_additional_newline;
-        }
-
-        return true;
-    }
-
-    /**
-     * compile a registered object tag
-     *
-     * @param string $tag_command
-     * @param array $attrs
-     * @param string $tag_modifier
-     * @return string
-     */
-    function _compile_registered_object_tag($tag_command, $attrs, $tag_modifier)
-    {
-        if ($tag_command{0} == '/') {
-            $start_tag = false;
-            $tag_command = substr($tag_command, 1);
-        } else {
-            $start_tag = true;
-        }
-
-        list($object, $obj_comp) = explode('-&gt;', $tag_command);
-
-        $arg_list = array();
-        if(count($attrs)) {
-            $_assign_var = false;
-            foreach ($attrs as $arg_name =&gt; $arg_value) {
-                if($arg_name == 'assign') {
-                    $_assign_var = $arg_value;
-                    unset($attrs['assign']);
-                    continue;
-                }
-                if (is_bool($arg_value))
-                    $arg_value = $arg_value ? 'true' : 'false';
-                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
-            }
-        }
-
-        if($this-&gt;_reg_objects[$object][2]) {
-            // smarty object argument format
-            $args = &quot;array(&quot;.implode(',', (array)$arg_list).&quot;), \$this&quot;;
-        } else {
-            // traditional argument format
-            $args = implode(',', array_values($attrs));
-            if (empty($args)) {
-                $args = 'null';
-            }
-        }
-
-        $prefix = '';
-        $postfix = '';
-        $newline = '';
-        if(!is_object($this-&gt;_reg_objects[$object][0])) {
-            $this-&gt;_trigger_fatal_error(&quot;registered '$object' is not an object&quot; , $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
-        } elseif(!empty($this-&gt;_reg_objects[$object][1]) &amp;&amp; !in_array($obj_comp, $this-&gt;_reg_objects[$object][1])) {
-            $this-&gt;_trigger_fatal_error(&quot;'$obj_comp' is not a registered component of object '$object'&quot;, $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
-        } elseif(method_exists($this-&gt;_reg_objects[$object][0], $obj_comp)) {
-            // method
-            if(in_array($obj_comp, $this-&gt;_reg_objects[$object][3])) {
-                // block method
-                if ($start_tag) {
-                    $prefix = &quot;\$this-&gt;_tag_stack[] = array('$obj_comp', $args); &quot;;
-                    $prefix .= &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp(\$this-&gt;_tag_stack[count(\$this-&gt;_tag_stack)-1][1], null, \$this, \$_block_repeat=true); &quot;;
-                    $prefix .= &quot;while (\$_block_repeat) { ob_start();&quot;;
-                    $return = null;
-                    $postfix = '';
-            } else {
-                    $prefix = &quot;\$this-&gt;_obj_block_content = ob_get_contents(); ob_end_clean(); &quot;;
-                    $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp(\$this-&gt;_tag_stack[count(\$this-&gt;_tag_stack)-1][1], \$this-&gt;_obj_block_content, \$this, \$_block_repeat=false)&quot;;
-                    $postfix = &quot;} array_pop(\$this-&gt;_tag_stack);&quot;;
-                }
-            } else {
-                // non-block method
-                $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp($args)&quot;;
-            }
-        } else {
-            // property
-            $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp&quot;;
-        }
-
-        if($return != null) {
-            if($tag_modifier != '') {
-                $this-&gt;_parse_modifiers($return, $tag_modifier);
-            }
-
-            if(!empty($_assign_var)) {
-                $output = &quot;\$this-&gt;assign('&quot; . $this-&gt;_dequote($_assign_var) .&quot;',  $return);&quot;;
-            } else {
-                $output = 'echo ' . $return . ';';
-                $newline = $this-&gt;_additional_newline;
-            }
-        } else {
-            $output = '';
-        }
-
-        return '&lt;?php ' . $prefix . $output . $postfix . &quot;?&gt;&quot; . $newline;
-    }
-
-    /**
-     * Compile {insert ...} tag
-     *
-     * @param string $tag_args
-     * @return string
-     */
-    function _compile_insert_tag($tag_args)
-    {
-        $attrs = $this-&gt;_parse_attrs($tag_args);
-        $name = $this-&gt;_dequote($attrs['name']);
-
-        if (empty($name)) {
-            $this-&gt;_syntax_error(&quot;missing insert name&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-
-        if (!empty($attrs['script'])) {
-            $delayed_loading = true;
-        } else {
-            $delayed_loading = false;
-        }
-
-        foreach ($attrs as $arg_name =&gt; $arg_value) {
-            if (is_bool($arg_value))
-                $arg_value = $arg_value ? 'true' : 'false';
-            $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
-        }
-
-        $this-&gt;_add_plugin('insert', $name, $delayed_loading);
-
-        $_params = &quot;array('args' =&gt; array(&quot;.implode(', ', (array)$arg_list).&quot;))&quot;;
-
-        return &quot;&lt;?php require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.run_insert_handler.php');\necho smarty_core_run_insert_handler($_params, \$this); ?&gt;&quot; . $this-&gt;_additional_newline;
-    }
-
-    /**
-     * Compile {include ...} tag
-     *
-     * @param string $tag_args
-     * @return string
-     */
-    function _compile_include_tag($tag_args)
-    {
-        $attrs = $this-&gt;_parse_attrs($tag_args);
-        $arg_list = array();
-
-        if (empty($attrs['file'])) {
-            $this-&gt;_syntax_error(&quot;missing 'file' attribute in include tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-
-        foreach ($attrs as $arg_name =&gt; $arg_value) {
-            if ($arg_name == 'file') {
-                $include_file = $arg_value;
-                continue;
-            } else if ($arg_name == 'assign') {
-                $assign_var = $arg_value;
-                continue;
-            }
-            if (is_bool($arg_value))
-                $arg_value = $arg_value ? 'true' : 'false';
-            $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
-        }
-
-        $output = '&lt;?php ';
-
-        if (isset($assign_var)) {
-            $output .= &quot;ob_start();\n&quot;;
-        }
-
-        $output .=
-            &quot;\$_smarty_tpl_vars = \$this-&gt;_tpl_vars;\n&quot;;
-
-
-        $_params = &quot;array('smarty_include_tpl_file' =&gt; &quot; . $include_file . &quot;, 'smarty_include_vars' =&gt; array(&quot;.implode(',', (array)$arg_list).&quot;))&quot;;
-        $output .= &quot;\$this-&gt;_smarty_include($_params);\n&quot; .
-        &quot;\$this-&gt;_tpl_vars = \$_smarty_tpl_vars;\n&quot; .
-        &quot;unset(\$_smarty_tpl_vars);\n&quot;;
-
-        if (isset($assign_var)) {
-            $output .= &quot;\$this-&gt;assign(&quot; . $assign_var . &quot;, ob_get_contents()); ob_end_clean();\n&quot;;
-        }
-
-        $output .= ' ?&gt;';
-
-        return $output;
-
-    }
-
-    /**
-     * Compile {include ...} tag
-     *
-     * @param string $tag_args
-     * @return string
-     */
-    function _compile_include_php_tag($tag_args)
-    {
-        $attrs = $this-&gt;_parse_attrs($tag_args);
-
-        if (empty($attrs['file'])) {
-            $this-&gt;_syntax_error(&quot;missing 'file' attribute in include_php tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-
-        $assign_var = (empty($attrs['assign'])) ? '' : $this-&gt;_dequote($attrs['assign']);
-        $once_var = (empty($attrs['once']) || $attrs['once']=='false') ? 'false' : 'true';
-
-        $arg_list = array();
-        foreach($attrs as $arg_name =&gt; $arg_value) {
-            if($arg_name != 'file' AND $arg_name != 'once' AND $arg_name != 'assign') {
-                if(is_bool($arg_value))
-                    $arg_value = $arg_value ? 'true' : 'false';
-                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
-            }
-        }
-
-        $_params = &quot;array('smarty_file' =&gt; &quot; . $attrs['file'] . &quot;, 'smarty_assign' =&gt; '$assign_var', 'smarty_once' =&gt; $once_var, 'smarty_include_vars' =&gt; array(&quot;.implode(',', $arg_list).&quot;))&quot;;
-
-        return &quot;&lt;?php require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.smarty_include_php.php');\nsmarty_core_smarty_include_php($_params, \$this); ?&gt;&quot; . $this-&gt;_additional_newline;
-    }
-
-
-    /**
-     * Compile {section ...} tag
-     *
-     * @param string $tag_args
-     * @return string
-     */
-    function _compile_section_start($tag_args)
-    {
-        $attrs = $this-&gt;_parse_attrs($tag_args);
-        $arg_list = array();
-
-        $output = '&lt;?php ';
-        $section_name = $attrs['name'];
-        if (empty($section_name)) {
-            $this-&gt;_syntax_error(&quot;missing section name&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-
-        $output .= &quot;unset(\$this-&gt;_sections[$section_name]);\n&quot;;
-        $section_props = &quot;\$this-&gt;_sections[$section_name]&quot;;
-
-        foreach ($attrs as $attr_name =&gt; $attr_value) {
-            switch ($attr_name) {
-                case 'loop':
-                    $output .= &quot;{$section_props}['loop'] = is_array(\$_loop=$attr_value) ? count(\$_loop) : max(0, (int)\$_loop); unset(\$_loop);\n&quot;;
-                    break;
-
-                case 'show':
-                    if (is_bool($attr_value))
-                        $show_attr_value = $attr_value ? 'true' : 'false';
-                    else
-                        $show_attr_value = &quot;(bool)$attr_value&quot;;
-                    $output .= &quot;{$section_props}['show'] = $show_attr_value;\n&quot;;
-                    break;
-
-                case 'name':
-                    $output .= &quot;{$section_props}['$attr_name'] = $attr_value;\n&quot;;
-                    break;
-
-                case 'max':
-                case 'start':
-                    $output .= &quot;{$section_props}['$attr_name'] = (int)$attr_value;\n&quot;;
-                    break;
-
-                case 'step':
-                    $output .= &quot;{$section_props}['$attr_name'] = ((int)$attr_value) == 0 ? 1 : (int)$attr_value;\n&quot;;
-                    break;
-
-                default:
-                    $this-&gt;_syntax_error(&quot;unknown section attribute - '$attr_name'&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                    break;
-            }
-        }
-
-        if (!isset($attrs['show']))
-            $output .= &quot;{$section_props}['show'] = true;\n&quot;;
-
-        if (!isset($attrs['loop']))
-            $output .= &quot;{$section_props}['loop'] = 1;\n&quot;;
-
-        if (!isset($attrs['max']))
-            $output .= &quot;{$section_props}['max'] = {$section_props}['loop'];\n&quot;;
-        else
-            $output .= &quot;if ({$section_props}['max'] &lt; 0)\n&quot; .
-                       &quot;    {$section_props}['max'] = {$section_props}['loop'];\n&quot;;
-
-        if (!isset($attrs['step']))
-            $output .= &quot;{$section_props}['step'] = 1;\n&quot;;
-
-        if (!isset($attrs['start']))
-            $output .= &quot;{$section_props}['start'] = {$section_props}['step'] &gt; 0 ? 0 : {$section_props}['loop']-1;\n&quot;;
-        else {
-            $output .= &quot;if ({$section_props}['start'] &lt; 0)\n&quot; .
-                       &quot;    {$section_props}['start'] = max({$section_props}['step'] &gt; 0 ? 0 : -1, {$section_props}['loop'] + {$section_props}['start']);\n&quot; .
-                       &quot;else\n&quot; .
-                       &quot;    {$section_props}['start'] = min({$section_props}['start'], {$section_props}['step'] &gt; 0 ? {$section_props}['loop'] : {$section_props}['loop']-1);\n&quot;;
-        }
-
-        $output .= &quot;if ({$section_props}['show']) {\n&quot;;
-        if (!isset($attrs['start']) &amp;&amp; !isset($attrs['step']) &amp;&amp; !isset($attrs['max'])) {
-            $output .= &quot;    {$section_props}['total'] = {$section_props}['loop'];\n&quot;;
-        } else {
-            $output .= &quot;    {$section_props}['total'] = min(ceil(({$section_props}['step'] &gt; 0 ? {$section_props}['loop'] - {$section_props}['start'] : {$section_props}['start']+1)/abs({$section_props}['step'])), {$section_props}['max']);\n&quot;;
-        }
-        $output .= &quot;    if ({$section_props}['total'] == 0)\n&quot; .
-                   &quot;        {$section_props}['show'] = false;\n&quot; .
-                   &quot;} else\n&quot; .
-                   &quot;    {$section_props}['total'] = 0;\n&quot;;
-
-        $output .= &quot;if ({$section_props}['show']):\n&quot;;
-        $output .= &quot;
-            for ({$section_props}['index'] = {$section_props}['start'], {$section_props}['iteration'] = 1;
-                 {$section_props}['iteration'] &lt;= {$section_props}['total'];
-                 {$section_props}['index'] += {$section_props}['step'], {$section_props}['iteration']++):\n&quot;;
-        $output .= &quot;{$section_props}['rownum'] = {$section_props}['iteration'];\n&quot;;
-        $output .= &quot;{$section_props}['index_prev'] = {$section_props}['index'] - {$section_props}['step'];\n&quot;;
-        $output .= &quot;{$section_props}['index_next'] = {$section_props}['index'] + {$section_props}['step'];\n&quot;;
-        $output .= &quot;{$section_props}['first']      = ({$section_props}['iteration'] == 1);\n&quot;;
-        $output .= &quot;{$section_props}['last']       = ({$section_props}['iteration'] == {$section_props}['total']);\n&quot;;
-
-        $output .= &quot;?&gt;&quot;;
-
-        return $output;
-    }
-
-
-    /**
-     * Compile {foreach ...} tag.
-     *
-     * @param string $tag_args
-     * @return string
-     */
-    function _compile_foreach_start($tag_args)
-    {
-        $attrs = $this-&gt;_parse_attrs($tag_args);
-        $arg_list = array();
-
-        if (empty($attrs['from'])) {
-            return $this-&gt;_syntax_error(&quot;foreach: missing 'from' attribute&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-        $from = $attrs['from'];
-
-        if (empty($attrs['item'])) {
-            return $this-&gt;_syntax_error(&quot;foreach: missing 'item' attribute&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-        $item = $this-&gt;_dequote($attrs['item']);
-        if (!preg_match('~^\w+$~', $item)) {
-            return $this-&gt;_syntax_error(&quot;'foreach: item' must be a variable name (literal string)&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-
-        if (isset($attrs['key'])) {
-            $key  = $this-&gt;_dequote($attrs['key']);
-            if (!preg_match('~^\w+$~', $key)) {
-                return $this-&gt;_syntax_error(&quot;foreach: 'key' must to be a variable name (literal string)&quot;, E_USER_ERROR, __FILE__, __LINE__);
-            }
-            $key_part = &quot;\$this-&gt;_tpl_vars['$key'] =&gt; &quot;;
-        } else {
-            $key = null;
-            $key_part = '';
-        }
-
-        if (isset($attrs['name'])) {
-            $name = $attrs['name'];
-        } else {
-            $name = null;
-        }
-
-        $output = '&lt;?php ';
-        if (isset($name)) {
-            $foreach_props = &quot;\$this-&gt;_foreach[$name]&quot;;
-            $output .= &quot;if (isset(\$this-&gt;_foreach[$name])) unset(\$this-&gt;_foreach[$name]);\n&quot;;
-            $output .= &quot;{$foreach_props}['total'] = count(\$_from = (array)$from);\n&quot;;
-            $output .= &quot;{$foreach_props}['show'] = {$foreach_props}['total'] &gt; 0;\n&quot;;
-            $output .= &quot;if ({$foreach_props}['show']):\n&quot;;
-            $output .= &quot;{$foreach_props}['iteration'] = 0;\n&quot;;
-            $output .= &quot;    foreach (\$_from as $key_part\$this-&gt;_tpl_vars['$item']):\n&quot;;
-            $output .= &quot;        {$foreach_props}['iteration']++;\n&quot;;
-            $output .= &quot;        {$foreach_props}['first'] = ({$foreach_props}['iteration'] == 1);\n&quot;;
-            $output .= &quot;        {$foreach_props}['last']  = ({$foreach_props}['iteration'] == {$foreach_props}['total']);\n&quot;;
-        } else {
-            $output .= &quot;if (count(\$_from = (array)$from)):\n&quot;;
-            $output .= &quot;    foreach (\$_from as $key_part\$this-&gt;_tpl_vars['$item']):\n&quot;;
-        }
-        $output .= '?&gt;';
-
-        return $output;
-    }
-
-
-    /**
-     * Compile {capture} .. {/capture} tags
-     *
-     * @param boolean $start true if this is the {capture} tag
-     * @param string $tag_args
-     * @return string
-     */
-
-    function _compile_capture_tag($start, $tag_args = '')
-    {
-        $attrs = $this-&gt;_parse_attrs($tag_args);
-
-        if ($start) {
-            if (isset($attrs['name']))
-                $buffer = $attrs['name'];
-            else
-                $buffer = &quot;'default'&quot;;
-
-            if (isset($attrs['assign']))
-                $assign = $attrs['assign'];
-            else
-                $assign = null;
-            $output = &quot;&lt;?php ob_start(); ?&gt;&quot;;
-            $this-&gt;_capture_stack[] = array($buffer, $assign);
-        } else {
-            list($buffer, $assign) = array_pop($this-&gt;_capture_stack);
-            $output = &quot;&lt;?php \$this-&gt;_smarty_vars['capture'][$buffer] = ob_get_contents(); &quot;;
-            if (isset($assign)) {
-                $output .= &quot; \$this-&gt;assign($assign, ob_get_contents());&quot;;
-            }
-            $output .= &quot;ob_end_clean(); ?&gt;&quot;;
-        }
-
-        return $output;
-    }
-
-    /**
-     * Compile {if ...} tag
-     *
-     * @param string $tag_args
-     * @param boolean $elseif if true, uses elseif instead of if
-     * @return string
-     */
-    function _compile_if_tag($tag_args, $elseif = false)
-    {
-
-        /* Tokenize args for 'if' tag. */
-        preg_match_all('~(?&gt;
-                ' . $this-&gt;_obj_call_regexp . '(?:' . $this-&gt;_mod_regexp . '*)? | # valid object call
-                ' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . '*)?    | # var or quoted string
-                \-?0[xX][0-9a-fA-F]+|\-?\d+(?:\.\d+)?|\.\d+|!==|===|==|!=|&lt;&gt;|&lt;&lt;|&gt;&gt;|&lt;=|&gt;=|\&amp;\&amp;|\|\||\(|\)|,|\!|\^|=|\&amp;|\~|&lt;|&gt;|\||\%|\+|\-|\/|\*|\@    | # valid non-word token
-                \b\w+\b                                                        | # valid word token
-                \S+                                                           # anything else
-                )~x', $tag_args, $match);
-
-        $tokens = $match[0];
-
-        // make sure we have balanced parenthesis
-        $token_count = array_count_values($tokens);
-        if(isset($token_count['(']) &amp;&amp; $token_count['('] != $token_count[')']) {
-            $this-&gt;_syntax_error(&quot;unbalanced parenthesis in if statement&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-
-        $is_arg_stack = array();
-
-        for ($i = 0; $i &lt; count($tokens); $i++) {
-
-            $token = &amp;$tokens[$i];
-
-            switch (strtolower($token)) {
-                case '!':
-                case '%':
-                case '!==':
-                case '==':
-                case '===':
-                case '&gt;':
-                case '&lt;':
-                case '!=':
-                case '&lt;&gt;':
-                case '&lt;&lt;':
-                case '&gt;&gt;':
-                case '&lt;=':
-                case '&gt;=':
-                case '&amp;&amp;':
-                case '||':
-                case '|':
-                case '^':
-                case '&amp;':
-                case '~':
-                case ')':
-                case ',':
-                case '+':
-                case '-':
-                case '*':
-                case '/':
-                case '@':
-                    break;
-
-                case 'eq':
-                    $token = '==';
-                    break;
-
-                case 'ne':
-                case 'neq':
-                    $token = '!=';
-                    break;
-
-                case 'lt':
-                    $token = '&lt;';
-                    break;
-
-                case 'le':
-                case 'lte':
-                    $token = '&lt;=';
-                    break;
-
-                case 'gt':
-                    $token = '&gt;';
-                    break;
-
-                case 'ge':
-                case 'gte':
-                    $token = '&gt;=';
-                    break;
-
-                case 'and':
-                    $token = '&amp;&amp;';
-                    break;
-
-                case 'or':
-                    $token = '||';
-                    break;
-
-                case 'not':
-                    $token = '!';
-                    break;
-
-                case 'mod':
-                    $token = '%';
-                    break;
-
-                case '(':
-                    array_push($is_arg_stack, $i);
-                    break;
-
-                case 'is':
-                    /* If last token was a ')', we operate on the parenthesized
-                       expression. The start of the expression is on the stack.
-                       Otherwise, we operate on the last encountered token. */
-                    if ($tokens[$i-1] == ')')
-                        $is_arg_start = array_pop($is_arg_stack);
-                    else
-                        $is_arg_start = $i-1;
-                    /* Construct the argument for 'is' expression, so it knows
-                       what to operate on. */
-                    $is_arg = implode(' ', array_slice($tokens, $is_arg_start, $i - $is_arg_start));
-
-                    /* Pass all tokens from next one until the end to the
-                       'is' expression parsing function. The function will
-                       return modified tokens, where the first one is the result
-                       of the 'is' expression and the rest are the tokens it
-                       didn't touch. */
-                    $new_tokens = $this-&gt;_parse_is_expr($is_arg, array_slice($tokens, $i+1));
-
-                    /* Replace the old tokens with the new ones. */
-                    array_splice($tokens, $is_arg_start, count($tokens), $new_tokens);
-
-                    /* Adjust argument start so that it won't change from the
-                       current position for the next iteration. */
-                    $i = $is_arg_start;
-                    break;
-
-                default:
-                    if(preg_match('~^' . $this-&gt;_func_regexp . '$~', $token) ) {
-                            // function call
-                            if($this-&gt;security &amp;&amp;
-                               !in_array($token, $this-&gt;security_settings['IF_FUNCS'])) {
-                                $this-&gt;_syntax_error(&quot;(secure mode) '$token' not allowed in if statement&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                            }
-                    } elseif(preg_match('~^' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $token)) {
-                        // object or variable
-                        $token = $this-&gt;_parse_var_props($token);
-                    } elseif(is_numeric($token)) {
-                        // number, skip it
-                    } else {
-                        $this-&gt;_syntax_error(&quot;unidentified token '$token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                    }
-                    break;
-            }
-        }
-
-        if ($elseif)
-            return '&lt;?php elseif ('.implode(' ', $tokens).'): ?&gt;';
-        else
-            return '&lt;?php if ('.implode(' ', $tokens).'): ?&gt;';
-    }
-
-
-    function _compile_arg_list($type, $name, $attrs, &amp;$cache_code) {
-        $arg_list = array();
-
-        if (isset($type) &amp;&amp; isset($name)
-            &amp;&amp; isset($this-&gt;_plugins[$type])
-            &amp;&amp; isset($this-&gt;_plugins[$type][$name])
-            &amp;&amp; empty($this-&gt;_plugins[$type][$name][4])
-            &amp;&amp; is_array($this-&gt;_plugins[$type][$name][5])
-            ) {
-            /* we have a list of parameters that should be cached */
-            $_cache_attrs = $this-&gt;_plugins[$type][$name][5];
-            $_count = $this-&gt;_cache_attrs_count++;
-            $cache_code = &quot;\$_cache_attrs =&amp; \$this-&gt;_smarty_cache_attrs('$this-&gt;_cache_serial','$_count');&quot;;
-
-        } else {
-            /* no parameters are cached */
-            $_cache_attrs = null;
-        }
-
-        foreach ($attrs as $arg_name =&gt; $arg_value) {
-            if (is_bool($arg_value))
-                $arg_value = $arg_value ? 'true' : 'false';
-            if (is_null($arg_value))
-                $arg_value = 'null';
-            if ($_cache_attrs &amp;&amp; in_array($arg_name, $_cache_attrs)) {
-                $arg_list[] = &quot;'$arg_name' =&gt; (\$this-&gt;_cache_including) ? \$_cache_attrs['$arg_name'] : (\$_cache_attrs['$arg_name']=$arg_value)&quot;;
-            } else {
-                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
-            }
-        }
-        return $arg_list;
-    }
-
-    /**
-     * Parse is expression
-     *
-     * @param string $is_arg
-     * @param array $tokens
-     * @return array
-     */
-    function _parse_is_expr($is_arg, $tokens)
-    {
-        $expr_end = 0;
-        $negate_expr = false;
-
-        if (($first_token = array_shift($tokens)) == 'not') {
-            $negate_expr = true;
-            $expr_type = array_shift($tokens);
-        } else
-            $expr_type = $first_token;
-
-        switch ($expr_type) {
-            case 'even':
-                if (isset($tokens[$expr_end]) &amp;&amp; $tokens[$expr_end] == 'by') {
-                    $expr_end++;
-                    $expr_arg = $tokens[$expr_end++];
-                    $expr = &quot;!(1 &amp; ($is_arg / &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;))&quot;;
-                } else
-                    $expr = &quot;!(1 &amp; $is_arg)&quot;;
-                break;
-
-            case 'odd':
-                if (isset($tokens[$expr_end]) &amp;&amp; $tokens[$expr_end] == 'by') {
-                    $expr_end++;
-                    $expr_arg = $tokens[$expr_end++];
-                    $expr = &quot;(1 &amp; ($is_arg / &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;))&quot;;
-                } else
-                    $expr = &quot;(1 &amp; $is_arg)&quot;;
-                break;
-
-            case 'div':
-                if (@$tokens[$expr_end] == 'by') {
-                    $expr_end++;
-                    $expr_arg = $tokens[$expr_end++];
-                    $expr = &quot;!($is_arg % &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;)&quot;;
-                } else {
-                    $this-&gt;_syntax_error(&quot;expecting 'by' after 'div'&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                }
-                break;
-
-            default:
-                $this-&gt;_syntax_error(&quot;unknown 'is' expression - '$expr_type'&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                break;
-        }
-
-        if ($negate_expr) {
-            $expr = &quot;!($expr)&quot;;
-        }
-
-        array_splice($tokens, 0, $expr_end, $expr);
-
-        return $tokens;
-    }
-
-
-    /**
-     * Parse attribute string
-     *
-     * @param string $tag_args
-     * @return array
-     */
-    function _parse_attrs($tag_args)
-    {
-
-        /* Tokenize tag attributes. */
-        preg_match_all('~(?:' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_qstr_regexp . ' | (?&gt;[^&quot;\'=\s]+)
-                         )+ |
-                         [=]
-                        ~x', $tag_args, $match);
-        $tokens       = $match[0];
-
-        $attrs = array();
-        /* Parse state:
-            0 - expecting attribute name
-            1 - expecting '='
-            2 - expecting attribute value (not '=') */
-        $state = 0;
-
-        foreach ($tokens as $token) {
-            switch ($state) {
-                case 0:
-                    /* If the token is a valid identifier, we set attribute name
-                       and go to state 1. */
-                    if (preg_match('~^\w+$~', $token)) {
-                        $attr_name = $token;
-                        $state = 1;
-                    } else
-                        $this-&gt;_syntax_error(&quot;invalid attribute name: '$token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                    break;
-
-                case 1:
-                    /* If the token is '=', then we go to state 2. */
-                    if ($token == '=') {
-                        $state = 2;
-                    } else
-                        $this-&gt;_syntax_error(&quot;expecting '=' after attribute name '$last_token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                    break;
-
-                case 2:
-                    /* If token is not '=', we set the attribute value and go to
-                       state 0. */
-                    if ($token != '=') {
-                        /* We booleanize the token if it's a non-quoted possible
-                           boolean value. */
-                        if (preg_match('~^(on|yes|true)$~', $token)) {
-                            $token = 'true';
-                        } else if (preg_match('~^(off|no|false)$~', $token)) {
-                            $token = 'false';
-                        } else if ($token == 'null') {
-                            $token = 'null';
-                        } else if (preg_match('~^-?([0-9]+|0[xX][0-9a-fA-F]+)$~', $token)) {
-                            /* treat integer literally */
-                        } else if (!preg_match('~^' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . ')*$~', $token)) {
-                            /* treat as a string, double-quote it escaping quotes */
-                            $token = '&quot;'.addslashes($token).'&quot;';
-                        }
-
-                        $attrs[$attr_name] = $token;
-                        $state = 0;
-                    } else
-                        $this-&gt;_syntax_error(&quot;'=' cannot be an attribute value&quot;, E_USER_ERROR, __FILE__, __LINE__);
-                    break;
-            }
-            $last_token = $token;
-        }
-
-        if($state != 0) {
-            if($state == 1) {
-                $this-&gt;_syntax_error(&quot;expecting '=' after attribute name '$last_token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
-            } else {
-                $this-&gt;_syntax_error(&quot;missing attribute value&quot;, E_USER_ERROR, __FILE__, __LINE__);
-            }
-        }
-
-        $this-&gt;_parse_vars_props($attrs);
-
-        return $attrs;
-    }
-
-    /**
-     * compile multiple variables and section properties tokens into
-     * PHP code
-     *
-     * @param array $tokens
-     */
-    function _parse_vars_props(&amp;$tokens)
-    {
-        foreach($tokens as $key =&gt; $val) {
-            $tokens[$key] = $this-&gt;_parse_var_props($val);
-        }
-    }
-
-    /**
-     * compile single variable and section properties token into
-     * PHP code
-     *
-     * @param string $val
-     * @param string $tag_attrs
-     * @return string
-     */
-    function _parse_var_props($val)
-    {
-        $val = trim($val);
-
-        if(preg_match('~^(' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_dvar_regexp . ')(' . $this-&gt;_mod_regexp . '*)$~', $val, $match)) {
-            // $ variable or object
-            $return = $this-&gt;_parse_var($match[1]);
-            $modifiers = $match[2];
-            if (!empty($this-&gt;default_modifiers) &amp;&amp; !preg_match('~(^|\|)smarty:nodefaults($|\|)~',$modifiers)) {
-                $_default_mod_string = implode('|',(array)$this-&gt;default_modifiers);
-                $modifiers = empty($modifiers) ? $_default_mod_string : $_default_mod_string . '|' . $modifiers;
-            }
-            $this-&gt;_parse_modifiers($return, $modifiers);
-            return $return;
-        } elseif (preg_match('~^' . $this-&gt;_db_qstr_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
-                // double quoted text
-                preg_match('~^(' . $this-&gt;_db_qstr_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
-                $return = $this-&gt;_expand_quoted_text($match[1]);
-                if($match[2] != '') {
-                    $this-&gt;_parse_modifiers($return, $match[2]);
-                }
-                return $return;
-            }
-        elseif(preg_match('~^' . $this-&gt;_num_const_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
-                // numerical constant
-                preg_match('~^(' . $this-&gt;_num_const_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
-                if($match[2] != '') {
-                    $this-&gt;_parse_modifiers($match[1], $match[2]);
-                    return $match[1];
-                }
-            }
-        elseif(preg_match('~^' . $this-&gt;_si_qstr_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
-                // single quoted text
-                preg_match('~^(' . $this-&gt;_si_qstr_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
-                if($match[2] != '') {
-                    $this-&gt;_parse_modifiers($match[1], $match[2]);
-                    return $match[1];
-                }
-            }
-        elseif(preg_match('~^' . $this-&gt;_cvar_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
-                // config var
-                return $this-&gt;_parse_conf_var($val);
-            }
-        elseif(preg_match('~^' . $this-&gt;_svar_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
-                // section var
-                return $this-&gt;_parse_section_prop($val);
-            }
-        elseif(!in_array($val, $this-&gt;_permitted_tokens) &amp;&amp; !is_numeric($val)) {
-            // literal string
-            return $this-&gt;_expand_quoted_text('&quot;' . $val .'&quot;');
-        }
-        return $val;
-    }
-
-    /**
-     * expand quoted text with embedded variables
-     *
-     * @param string $var_expr
-     * @return string
-     */
-    function _expand_quoted_text($var_expr)
-    {
-        // if contains unescaped $, expand it
-        if(preg_match_all('~(?:\`(?&lt;!\\\\)\$' . $this-&gt;_dvar_guts_regexp . '\`)|(?:(?&lt;!\\\\)\$\w+(\[[a-zA-Z0-9]+\])*)~', $var_expr, $_match)) {
-            $_match = $_match[0];
-            rsort($_match);
-            reset($_match);
-            foreach($_match as $_var) {
-                $var_expr = str_replace ($_var, '&quot;.(' . $this-&gt;_parse_var(str_replace('`','',$_var)) . ').&quot;', $var_expr);
-            }
-            $_return = preg_replace('~\.&quot;&quot;|(?&lt;!\\\\)&quot;&quot;\.~', '', $var_expr);
-        } else {
-            $_return = $var_expr;
-        }
-        // replace double quoted literal string with single quotes
-        $_return = preg_replace('~^&quot;([\s\w]+)&quot;$~',&quot;'\\1'&quot;,$_return);
-        return $_return;
-    }
-
-    /**
-     * parse variable expression into PHP code
-     *
-     * @param string $var_expr
-     * @param string $output
-     * @return string
-     */
-    function _parse_var($var_expr)
-    {
-        $_has_math = false;
-        $_math_vars = preg_split('~('.$this-&gt;_dvar_math_regexp.'|'.$this-&gt;_qstr_regexp.')~', $var_expr, -1, PREG_SPLIT_DELIM_CAPTURE);
-
-        if(count($_math_vars) &gt; 1) {
-            $_first_var = &quot;&quot;;
-            $_complete_var = &quot;&quot;;
-            $_output = &quot;&quot;;
-            // simple check if there is any math, to stop recursion (due to modifiers with &quot;xx % yy&quot; as parameter)
-            foreach($_math_vars as $_k =&gt; $_math_var) {
-                $_math_var = $_math_vars[$_k];
-
-                if(!empty($_math_var) || is_numeric($_math_var)) {
-                    // hit a math operator, so process the stuff which came before it
-                    if(preg_match('~^' . $this-&gt;_dvar_math_regexp . '$~', $_math_var)) {
-                        $_has_math = true;
-                        if(!empty($_complete_var) || is_numeric($_complete_var)) {
-                            $_output .= $this-&gt;_parse_var($_complete_var);
-                        }
-
-                        // just output the math operator to php
-                        $_output .= $_math_var;
-
-                        if(empty($_first_var))
-                            $_first_var = $_complete_var;
-
-                        $_complete_var = &quot;&quot;;
-                    } else {
-                        $_complete_var .= $_math_var;
-                    }
-                }
-            }
-            if($_has_math) {
-                if(!empty($_complete_var) || is_numeric($_complete_var))
-                    $_output .= $this-&gt;_parse_var($_complete_var);
-
-                // get the modifiers working (only the last var from math + modifier is left)
-                $var_expr = $_complete_var;
-            }
-        }
-
-        // prevent cutting of first digit in the number (we _definitly_ got a number if the first char is a digit)
-        if(is_numeric($var_expr{0}))
-            $_var_ref = $var_expr;
-        else
-            $_var_ref = substr($var_expr, 1);
-        
-        if(!$_has_math) {
-            
-            // get [foo] and .foo and -&gt;foo and (...) pieces
-            preg_match_all('~(?:^\w+)|' . $this-&gt;_obj_params_regexp . '|(?:' . $this-&gt;_var_bracket_regexp . ')|-&gt;\$?\w+|\.\$?\w+|\S+~', $_var_ref, $match);
-                        
-            $_indexes = $match[0];
-            $_var_name = array_shift($_indexes);
-
-            /* Handle $smarty.* variable references as a special case. */
-            if ($_var_name == 'smarty') {
-                /*
-                 * If the reference could be compiled, use the compiled output;
-                 * otherwise, fall back on the $smarty variable generated at
-                 * run-time.
-                 */
-                if (($smarty_ref = $this-&gt;_compile_smarty_ref($_indexes)) !== null) {
-                    $_output = $smarty_ref;
-                } else {
-                    $_var_name = substr(array_shift($_indexes), 1);
-                    $_output = &quot;\$this-&gt;_smarty_vars['$_var_name']&quot;;
-                }
-            } elseif(is_numeric($_var_name) &amp;&amp; is_numeric($var_expr{0})) {
-                // because . is the operator for accessing arrays thru inidizes we need to put it together again for floating point numbers
-                if(count($_indexes) &gt; 0)
-                {
-                    $_var_name .= implode(&quot;&quot;, $_indexes);
-                    $_indexes = array();
-                }
-                $_output = $_var_name;
-            } else {
-                $_output = &quot;\$this-&gt;_tpl_vars['$_var_name']&quot;;
-            }
-
-            foreach ($_indexes as $_index) {
-                if ($_index{0} == '[') {
-                    $_index = substr($_index, 1, -1);
-                    if (is_numeric($_index)) {
-                        $_output .= &quot;[$_index]&quot;;
-                    } elseif ($_index{0} == '$') {
-                        if (strpos($_index, '.') !== false) {
-                            $_output .= '[' . $this-&gt;_parse_var($_index) . ']';
-                        } else {
-                            $_output .= &quot;[\$this-&gt;_tpl_vars['&quot; . substr($_index, 1) . &quot;']]&quot;;
-                        }
-                    } else {
-                        $_var_parts = explode('.', $_index);
-                        $_var_section = $_var_parts[0];
-                        $_var_section_prop = isset($_var_parts[1]) ? $_var_parts[1] : 'index';
-                        $_output .= &quot;[\$this-&gt;_sections['$_var_section']['$_var_section_prop']]&quot;;
-                    }
-                } else if ($_index{0} == '.') {
-                    if ($_index{1} == '$')
-                        $_output .= &quot;[\$this-&gt;_tpl_vars['&quot; . substr($_index, 2) . &quot;']]&quot;;
-                    else
-                        $_output .= &quot;['&quot; . substr($_index, 1) . &quot;']&quot;;
-                } else if (substr($_index,0,2) == '-&gt;') {
-                    if(substr($_index,2,2) == '__') {
-                        $this-&gt;_syntax_error('call to internal object members is not allowed', E_USER_ERROR, __FILE__, __LINE__);
-                    } elseif($this-&gt;security &amp;&amp; substr($_index, 2, 1) == '_') {
-                        $this-&gt;_syntax_error('(secure) call to private object member is not allowed', E_USER_ERROR, __FILE__, __LINE__);
-                    } elseif ($_index{2} == '$') {
-                        if ($this-&gt;security) {
-                            $this-&gt;_syntax_error('(secure) call to dynamic object member is not allowed', E_USER_ERROR, __FILE__, __LINE__);
-                        } else {
-                            $_output .= '-&gt;{(($_var=$this-&gt;_tpl_vars[\''.substr($_index,3).'\']) &amp;&amp; substr($_var,0,2)!=\'__\') ? $_var : $this-&gt;trigger_error(&quot;cannot access property \\&quot;$_var\\&quot;&quot;)}';
-                        }
-                    } else {
-                        $_output .= $_index;
-                    }
-                } elseif ($_index{0} == '(') {
-                    $_index = $this-&gt;_parse_parenth_args($_index);
-                    $_output .= $_index;
-                } else {
-                    $_output .= $_index;
-                }
-            }
-        }
-
-        return $_output;
-    }
-
-    /**
-     * parse arguments in function call parenthesis
-     *
-     * @param string $parenth_args
-     * @return string
-     */
-    function _parse_parenth_args($parenth_args)
-    {
-        preg_match_all('~' . $this-&gt;_param_regexp . '~',$parenth_args, $match);
-        $orig_vals = $match = $match[0];
-        $this-&gt;_parse_vars_props($match);
-        $replace = array();
-        for ($i = 0, $count = count($match); $i &lt; $count; $i++) {
-            $replace[$orig_vals[$i]] = $match[$i];
-        }
-        return strtr($parenth_args, $replace);
-    }
-
-    /**
-     * parse configuration variable expression into PHP code
-     *
-     * @param string $conf_var_expr
-     */
-    function _parse_conf_var($conf_var_expr)
-    {
-        $parts = explode('|', $conf_var_expr, 2);
-        $var_ref = $parts[0];
-        $modifiers = isset($parts[1]) ? $parts[1] : '';
-
-        $var_name = substr($var_ref, 1, -1);
-
-        $output = &quot;\$this-&gt;_config[0]['vars']['$var_name']&quot;;
-
-        $this-&gt;_parse_modifiers($output, $modifiers);
-
-        return $output;
-    }
-
-    /**
-     * parse section property expression into PHP code
-     *
-     * @param string $section_prop_expr
-     * @return string
-     */
-    function _parse_section_prop($section_prop_expr)
-    {
-        $parts = explode('|', $section_prop_expr, 2);
-        $var_ref = $parts[0];
-        $modifiers = isset($parts[1]) ? $parts[1] : '';
-
-        preg_match('!%(\w+)\.(\w+)%!', $var_ref, $match);
-        $section_name = $match[1];
-        $prop_name = $match[2];
-
-        $output = &quot;\$this-&gt;_sections['$section_name']['$prop_name']&quot;;
-
-        $this-&gt;_parse_modifiers($output, $modifiers);
-
-        return $output;
-    }
-
-
-    /**
-     * parse modifier chain into PHP code
-     *
-     * sets $output to parsed modified chain
-     * @param string $output
-     * @param string $modifier_string
-     */
-    function _parse_modifiers(&amp;$output, $modifier_string)
-    {
-        preg_match_all('~\|(@?\w+)((?&gt;:(?:'. $this-&gt;_qstr_regexp . '|[^|]+))*)~', '|' . $modifier_string, $_match);
-        list(, $_modifiers, $modifier_arg_strings) = $_match;
-
-        for ($_i = 0, $_for_max = count($_modifiers); $_i &lt; $_for_max; $_i++) {
-            $_modifier_name = $_modifiers[$_i];
-
-            if($_modifier_name == 'smarty') {
-                // skip smarty modifier
-                continue;
-            }
-
-            preg_match_all('~:(' . $this-&gt;_qstr_regexp . '|[^:]+)~', $modifier_arg_strings[$_i], $_match);
-            $_modifier_args = $_match[1];
-
-            if ($_modifier_name{0} == '@') {
-                $_map_array = false;
-                $_modifier_name = substr($_modifier_name, 1);
-            } else {
-                $_map_array = true;
-            }
-
-            if (empty($this-&gt;_plugins['modifier'][$_modifier_name])
-                &amp;&amp; !$this-&gt;_get_plugin_filepath('modifier', $_modifier_name)
-                &amp;&amp; function_exists($_modifier_name)) {
-                if ($this-&gt;security &amp;&amp; !in_array($_modifier_name, $this-&gt;security_settings['MODIFIER_FUNCS'])) {
-                    $this-&gt;_trigger_fatal_error(&quot;[plugin] (secure mode) modifier '$_modifier_name' is not allowed&quot; , $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
-                } else {
-                    $this-&gt;_plugins['modifier'][$_modifier_name] = array($_modifier_name,  null, null, false);
-                }
-            }
-            $this-&gt;_add_plugin('modifier', $_modifier_name);
-
-            $this-&gt;_parse_vars_props($_modifier_args);
-
-            if($_modifier_name == 'default') {
-                // supress notifications of default modifier vars and args
-                if($output{0} == '$') {
-                    $output = '@' . $output;
-                }
-                if(isset($_modifier_args[0]) &amp;&amp; $_modifier_args[0]{0} == '$') {
-                    $_modifier_args[0] = '@' . $_modifier_args[0];
-                }
-            }
-            if (count($_modifier_args) &gt; 0)
-                $_modifier_args = ', '.implode(', ', $_modifier_args);
-            else
-                $_modifier_args = '';
-
-            if ($_map_array) {
-                $output = &quot;((is_array(\$_tmp=$output)) ? \$this-&gt;_run_mod_handler('$_modifier_name', true, \$_tmp$_modifier_args) : &quot; . $this-&gt;_compile_plugin_call('modifier', $_modifier_name) . &quot;(\$_tmp$_modifier_args))&quot;;
-
-            } else {
-
-                $output = $this-&gt;_compile_plugin_call('modifier', $_modifier_name).&quot;($output$_modifier_args)&quot;;
-
-            }
-        }
-    }
-
-
-    /**
-     * add plugin
-     *
-     * @param string $type
-     * @param string $name
-     * @param boolean? $delayed_loading
-     */
-    function _add_plugin($type, $name, $delayed_loading = null)
-    {
-        if (!isset($this-&gt;_plugin_info[$type])) {
-            $this-&gt;_plugin_info[$type] = array();
-        }
-        if (!isset($this-&gt;_plugin_info[$type][$name])) {
-            $this-&gt;_plugin_info[$type][$name] = array($this-&gt;_current_file,
-                                                      $this-&gt;_current_line_no,
-                                                      $delayed_loading);
-        }
-    }
-
-
-    /**
-     * Compiles references of type $smarty.foo
-     *
-     * @param string $indexes
-     * @return string
-     */
-    function _compile_smarty_ref(&amp;$indexes)
-    {
-        /* Extract the reference name. */
-        $_ref = substr($indexes[0], 1);
-        foreach($indexes as $_index_no=&gt;$_index) {
-            if ($_index{0} != '.' &amp;&amp; $_index_no&lt;2 || !preg_match('~^(\.|\[|-&gt;)~', $_index)) {
-                $this-&gt;_syntax_error('$smarty' . implode('', array_slice($indexes, 0, 2)) . ' is an invalid reference', E_USER_ERROR, __FILE__, __LINE__);
-            }
-        }
-
-        switch ($_ref) {
-            case 'now':
-                $compiled_ref = 'time()';
-                $_max_index = 1;
-                break;
-
-            case 'foreach':
-            case 'section':
-                array_shift($indexes);
-                $_var = $this-&gt;_parse_var_props(substr($indexes[0], 1));
-                if ($_ref == 'foreach')
-                    $compiled_ref = &quot;\$this-&gt;_foreach[$_var]&quot;;
-                else
-                    $compiled_ref = &quot;\$this-&gt;_sections[$_var]&quot;;
-                break;
-
-            case 'get':
-                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_GET' : &quot;\$GLOBALS['HTTP_GET_VARS']&quot;;
-                break;
-
-            case 'post':
-                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_POST' : &quot;\$GLOBALS['HTTP_POST_VARS']&quot;;
-                break;
-
-            case 'cookies':
-                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_COOKIE' : &quot;\$GLOBALS['HTTP_COOKIE_VARS']&quot;;
-                break;
-
-            case 'env':
-                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_ENV' : &quot;\$GLOBALS['HTTP_ENV_VARS']&quot;;
-                break;
-
-            case 'server':
-                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_SERVER' : &quot;\$GLOBALS['HTTP_SERVER_VARS']&quot;;
-                break;
-
-            case 'session':
-                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_SESSION' : &quot;\$GLOBALS['HTTP_SESSION_VARS']&quot;;
-                break;
-
-            /*
-             * These cases are handled either at run-time or elsewhere in the
-             * compiler.
-             */
-            case 'request':
-                if ($this-&gt;request_use_auto_globals) {
-                    $compiled_ref = '$_REQUEST';
-                    break;
-                } else {
-                    $this-&gt;_init_smarty_vars = true;
-                }
-                return null;
-
-            case 'capture':
-                return null;
-
-            case 'template':
-                $compiled_ref = &quot;'$this-&gt;_current_file'&quot;;
-                $_max_index = 1;
-                break;
-
-            case 'version':
-                $compiled_ref = &quot;'$this-&gt;_version'&quot;;
-                $_max_index = 1;
-                break;
-
-            case 'const':
-                if ($this-&gt;security &amp;&amp; !$this-&gt;security_settings['ALLOW_CONSTANTS']) {
-                    $this-&gt;_syntax_error(&quot;(secure mode) constants not permitted&quot;,
-                                         E_USER_WARNING, __FILE__, __LINE__);
-                    return;
-                }
-                array_shift($indexes);
-                $_val = $this-&gt;_parse_var_props(substr($indexes[0],1));
-                $compiled_ref = '@constant(' . $_val . ')';
-                $_max_index = 1;
-                break;
-
-            case 'config':
-                $compiled_ref = &quot;\$this-&gt;_config[0]['vars']&quot;;
-                $_max_index = 3;
-                break;
-
-            case 'ldelim':
-                $compiled_ref = &quot;'$this-&gt;left_delimiter'&quot;;
-                break;
-
-            case 'rdelim':
-                $compiled_ref = &quot;'$this-&gt;right_delimiter'&quot;;
-                break;
-                
-            default:
-                $this-&gt;_syntax_error('$smarty.' . $_ref . ' is an unknown reference', E_USER_ERROR, __FILE__, __LINE__);
-                break;
-        }
-
-        if (isset($_max_index) &amp;&amp; count($indexes) &gt; $_max_index) {
-            $this-&gt;_syntax_error('$smarty' . implode('', $indexes) .' is an invalid reference', E_USER_ERROR, __FILE__, __LINE__);
-        }
-
-        array_shift($indexes);
-        return $compiled_ref;
-    }
-
-    /**
-     * compiles call to plugin of type $type with name $name
-     * returns a string containing the function-name or method call
-     * without the paramter-list that would have follow to make the
-     * call valid php-syntax
-     *
-     * @param string $type
-     * @param string $name
-     * @return string
-     */
-    function _compile_plugin_call($type, $name) {
-        if (isset($this-&gt;_plugins[$type][$name])) {
-            /* plugin loaded */
-            if (is_array($this-&gt;_plugins[$type][$name][0])) {
-                return ((is_object($this-&gt;_plugins[$type][$name][0][0])) ?
-                        &quot;\$this-&gt;_plugins['$type']['$name'][0][0]-&gt;&quot;    /* method callback */
-                        : (string)($this-&gt;_plugins[$type][$name][0][0]).'::'    /* class callback */
-                       ). $this-&gt;_plugins[$type][$name][0][1];
-
-            } else {
-                /* function callback */
-                return $this-&gt;_plugins[$type][$name][0];
-
-            }
-        } else {
-            /* plugin not loaded -&gt; auto-loadable-plugin */
-            return 'smarty_'.$type.'_'.$name;
-
-        }
-    }
-
-    /**
-     * load pre- and post-filters
-     */
-    function _load_filters()
-    {
-        if (count($this-&gt;_plugins['prefilter']) &gt; 0) {
-            foreach ($this-&gt;_plugins['prefilter'] as $filter_name =&gt; $prefilter) {
-                if ($prefilter === false) {
-                    unset($this-&gt;_plugins['prefilter'][$filter_name]);
-                    $_params = array('plugins' =&gt; array(array('prefilter', $filter_name, null, null, false)));
-                    require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.load_plugins.php');
-                    smarty_core_load_plugins($_params, $this);
-                }
-            }
-        }
-        if (count($this-&gt;_plugins['postfilter']) &gt; 0) {
-            foreach ($this-&gt;_plugins['postfilter'] as $filter_name =&gt; $postfilter) {
-                if ($postfilter === false) {
-                    unset($this-&gt;_plugins['postfilter'][$filter_name]);
-                    $_params = array('plugins' =&gt; array(array('postfilter', $filter_name, null, null, false)));
-                    require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.load_plugins.php');
-                    smarty_core_load_plugins($_params, $this);
-                }
-            }
-        }
-    }
-
-
-    /**
-     * Quote subpattern references
-     *
-     * @param string $string
-     * @return string
-     */
-    function _quote_replace($string)
-    {
-        return strtr($string, array('\\' =&gt; '\\\\', '$' =&gt; '\\$'));
-    }
-
-    /**
-     * display Smarty syntax error
-     *
-     * @param string $error_msg
-     * @param integer $error_type
-     * @param string $file
-     * @param integer $line
-     */
-    function _syntax_error($error_msg, $error_type = E_USER_ERROR, $file=null, $line=null)
-    {
-        $this-&gt;_trigger_fatal_error(&quot;syntax error: $error_msg&quot;, $this-&gt;_current_file, $this-&gt;_current_line_no, $file, $line, $error_type);
-    }
-
-
-    /**
-     * check if the compilation changes from cacheable to
-     * non-cacheable state with the beginning of the current
-     * plugin. return php-code to reflect the transition.
-     * @return string
-     */
-    function _push_cacheable_state($type, $name) {
-        $_cacheable = !isset($this-&gt;_plugins[$type][$name]) || $this-&gt;_plugins[$type][$name][4];
-        if ($_cacheable
-            || 0&lt;$this-&gt;_cacheable_state++) return '';
-        if (!isset($this-&gt;_cache_serial)) $this-&gt;_cache_serial = md5(uniqid('Smarty'));
-        $_ret = 'if ($this-&gt;caching) { echo \'{nocache:'
-            . $this-&gt;_cache_serial . '#' . $this-&gt;_nocache_count
-            . '}\';}';
-        return $_ret;
-    }
-
-
-    /**
-     * check if the compilation changes from non-cacheable to
-     * cacheable state with the end of the current plugin return
-     * php-code to reflect the transition.
-     * @return string
-     */
-    function _pop_cacheable_state($type, $name) {
-        $_cacheable = !isset($this-&gt;_plugins[$type][$name]) || $this-&gt;_plugins[$type][$name][4];
-        if ($_cacheable
-            || --$this-&gt;_cacheable_state&gt;0) return '';
-        return 'if ($this-&gt;caching) { echo \'{/nocache:'
-            . $this-&gt;_cache_serial . '#' . ($this-&gt;_nocache_count++)
-            . '}\';}';
-    }
-
-
-    /**
-     * push opening tag-name, file-name and line-number on the tag-stack
-     * @param string the opening tag's name
-     */
-    function _push_tag($open_tag)
-    {
-        array_push($this-&gt;_tag_stack, array($open_tag, $this-&gt;_current_line_no));
-    }
-
-    /**
-     * pop closing tag-name
-     * raise an error if this stack-top doesn't match with the closing tag
-     * @param string the closing tag's name
-     * @return string the opening tag's name
-     */
-    function _pop_tag($close_tag)
-    {
-        $message = '';
-        if (count($this-&gt;_tag_stack)&gt;0) {
-            list($_open_tag, $_line_no) = array_pop($this-&gt;_tag_stack);
-            if ($close_tag == $_open_tag) {
-                return $_open_tag;
-            }
-            if ($close_tag == 'if' &amp;&amp; ($_open_tag == 'else' || $_open_tag == 'elseif' )) {
-                return $this-&gt;_pop_tag($close_tag);
-            }
-            if ($close_tag == 'section' &amp;&amp; $_open_tag == 'sectionelse') {
-                $this-&gt;_pop_tag($close_tag);
-                return $_open_tag;
-            }
-            if ($close_tag == 'foreach' &amp;&amp; $_open_tag == 'foreachelse') {
-                $this-&gt;_pop_tag($close_tag);
-                return $_open_tag;
-            }
-            if ($_open_tag == 'else' || $_open_tag == 'elseif') {
-                $_open_tag = 'if';
-            } elseif ($_open_tag == 'sectionelse') {
-                $_open_tag = 'section';
-            } elseif ($_open_tag == 'foreachelse') {
-                $_open_tag = 'foreach';
-            }
-            $message = &quot; expected {/$_open_tag} (opened line $_line_no).&quot;;
-        }
-        $this-&gt;_syntax_error(&quot;mismatched tag {/$close_tag}.$message&quot;,
-                             E_USER_ERROR, __FILE__, __LINE__);
-    }
-
-}
-
-/**
- * compare to values by their string length
- *
- * @access private
- * @param string $a
- * @param string $b
- * @return 0|-1|1
- */
-function _smarty_sort_length($a, $b)
-{
-    if($a == $b)
-        return 0;
-
-    if(strlen($a) == strlen($b))
-        return ($a &gt; $b) ? -1 : 1;
-
-    return (strlen($a) &gt; strlen($b)) ? -1 : 1;
-}
-
-
-/* vim: set et: */
-
-?&gt;
+&lt;?php
+
+/**
+ * Project:     Smarty: the PHP compiling template engine
+ * File:        Smarty_Compiler.class.php
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * @link <A HREF="http://smarty.php.net/">http://smarty.php.net/</A>
+ * @author Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @author Andrei Zmievski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">andrei at php.net</A>&gt;
+ * @version 2.6.10
+ * @copyright 2001-2005 New Digital Group, Inc.
+ * @package Smarty
+ */
+
+/* $Id$ */
+
+/**
+ * Template compiling class
+ * @package Smarty
+ */
+class Smarty_Compiler extends Smarty {
+
+    // internal vars
+    /**#@+
+     * @access private
+     */
+    var $_folded_blocks         =   array();    // keeps folded template blocks
+    var $_current_file          =   null;       // the current template being compiled
+    var $_current_line_no       =   1;          // line number for error messages
+    var $_capture_stack         =   array();    // keeps track of nested capture buffers
+    var $_plugin_info           =   array();    // keeps track of plugins to load
+    var $_init_smarty_vars      =   false;
+    var $_permitted_tokens      =   array('true','false','yes','no','on','off','null');
+    var $_db_qstr_regexp        =   null;        // regexps are setup in the constructor
+    var $_si_qstr_regexp        =   null;
+    var $_qstr_regexp           =   null;
+    var $_func_regexp           =   null;
+    var $_reg_obj_regexp        =   null;
+    var $_var_bracket_regexp    =   null;
+    var $_num_const_regexp      =   null;
+    var $_dvar_guts_regexp      =   null;
+    var $_dvar_regexp           =   null;
+    var $_cvar_regexp           =   null;
+    var $_svar_regexp           =   null;
+    var $_avar_regexp           =   null;
+    var $_mod_regexp            =   null;
+    var $_var_regexp            =   null;
+    var $_parenth_param_regexp  =   null;
+    var $_func_call_regexp      =   null;
+    var $_obj_ext_regexp        =   null;
+    var $_obj_start_regexp      =   null;
+    var $_obj_params_regexp     =   null;
+    var $_obj_call_regexp       =   null;
+    var $_cacheable_state       =   0;
+    var $_cache_attrs_count     =   0;
+    var $_nocache_count         =   0;
+    var $_cache_serial          =   null;
+    var $_cache_include         =   null;
+
+    var $_strip_depth           =   0;
+    var $_additional_newline    =   &quot;\n&quot;;
+
+    /**#@-*/
+    /**
+     * The class constructor.
+     */
+    function Smarty_Compiler()
+    {
+        // matches double quoted strings:
+        // &quot;foobar&quot;
+        // &quot;foo\&quot;bar&quot;
+        $this-&gt;_db_qstr_regexp = '&quot;[^&quot;\\\\]*(?:\\\\.[^&quot;\\\\]*)*&quot;';
+
+        // matches single quoted strings:
+        // 'foobar'
+        // 'foo\'bar'
+        $this-&gt;_si_qstr_regexp = '\'[^\'\\\\]*(?:\\\\.[^\'\\\\]*)*\'';
+
+        // matches single or double quoted strings
+        $this-&gt;_qstr_regexp = '(?:' . $this-&gt;_db_qstr_regexp . '|' . $this-&gt;_si_qstr_regexp . ')';
+
+        // matches bracket portion of vars
+        // [0]
+        // [foo]
+        // [$bar]
+        $this-&gt;_var_bracket_regexp = '\[\$?[\w\.]+\]';
+
+        // matches numerical constants
+        // 30
+        // -12
+        // 13.22
+        $this-&gt;_num_const_regexp = '(?:\-?\d+(?:\.\d+)?)';
+
+        // matches $ vars (not objects):
+        // $foo
+        // $foo.bar
+        // $foo.bar.foobar
+        // $foo[0]
+        // $foo[$bar]
+        // $foo[5][blah]
+        // $foo[5].bar[$foobar][4]
+        $this-&gt;_dvar_math_regexp = '(?:[\+\*\/\%]|(?:-(?!&gt;)))';
+        $this-&gt;_dvar_math_var_regexp = '[\$\w\.\+\-\*\/\%\d\&gt;\[\]]';
+        $this-&gt;_dvar_guts_regexp = '\w+(?:' . $this-&gt;_var_bracket_regexp
+                . ')*(?:\.\$?\w+(?:' . $this-&gt;_var_bracket_regexp . ')*)*(?:' . $this-&gt;_dvar_math_regexp . '(?:' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_dvar_math_var_regexp . ')*)?';
+        $this-&gt;_dvar_regexp = '\$' . $this-&gt;_dvar_guts_regexp;
+
+        // matches config vars:
+        // #foo#
+        // #foobar123_foo#
+        $this-&gt;_cvar_regexp = '\#\w+\#';
+
+        // matches section vars:
+        // %foo.bar%
+        $this-&gt;_svar_regexp = '\%\w+\.\w+\%';
+
+        // matches all valid variables (no quotes, no modifiers)
+        $this-&gt;_avar_regexp = '(?:' . $this-&gt;_dvar_regexp . '|'
+           . $this-&gt;_cvar_regexp . '|' . $this-&gt;_svar_regexp . ')';
+
+        // matches valid variable syntax:
+        // $foo
+        // $foo
+        // #foo#
+        // #foo#
+        // &quot;text&quot;
+        // &quot;text&quot;
+        $this-&gt;_var_regexp = '(?:' . $this-&gt;_avar_regexp . '|' . $this-&gt;_qstr_regexp . ')';
+
+        // matches valid object call (one level of object nesting allowed in parameters):
+        // $foo-&gt;bar
+        // $foo-&gt;bar()
+        // $foo-&gt;bar(&quot;text&quot;)
+        // $foo-&gt;bar($foo, $bar, &quot;text&quot;)
+        // $foo-&gt;bar($foo, &quot;foo&quot;)
+        // $foo-&gt;bar-&gt;foo()
+        // $foo-&gt;bar-&gt;foo-&gt;bar()
+        // $foo-&gt;bar($foo-&gt;bar)
+        // $foo-&gt;bar($foo-&gt;bar())
+        // $foo-&gt;bar($foo-&gt;bar($blah,$foo,44,&quot;foo&quot;,$foo[0].bar))
+        $this-&gt;_obj_ext_regexp = '\-&gt;(?:\$?' . $this-&gt;_dvar_guts_regexp . ')';
+        $this-&gt;_obj_restricted_param_regexp = '(?:'
+                . '(?:' . $this-&gt;_var_regexp . '|' . $this-&gt;_num_const_regexp . ')(?:' . $this-&gt;_obj_ext_regexp . '(?:\((?:(?:' . $this-&gt;_var_regexp . '|' . $this-&gt;_num_const_regexp . ')'
+                . '(?:\s*,\s*(?:' . $this-&gt;_var_regexp . '|' . $this-&gt;_num_const_regexp . '))*)?\))?)*)';
+        $this-&gt;_obj_single_param_regexp = '(?:\w+|' . $this-&gt;_obj_restricted_param_regexp . '(?:\s*,\s*(?:(?:\w+|'
+                . $this-&gt;_var_regexp . $this-&gt;_obj_restricted_param_regexp . ')))*)';
+        $this-&gt;_obj_params_regexp = '\((?:' . $this-&gt;_obj_single_param_regexp
+                . '(?:\s*,\s*' . $this-&gt;_obj_single_param_regexp . ')*)?\)';
+        $this-&gt;_obj_start_regexp = '(?:' . $this-&gt;_dvar_regexp . '(?:' . $this-&gt;_obj_ext_regexp . ')+)';
+        $this-&gt;_obj_call_regexp = '(?:' . $this-&gt;_obj_start_regexp . '(?:' . $this-&gt;_obj_params_regexp . ')?(?:' . $this-&gt;_dvar_math_regexp . '(?:' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_dvar_math_var_regexp . ')*)?)';
+        
+        // matches valid modifier syntax:
+        // |foo
+        // |@foo
+        // |foo:&quot;bar&quot;
+        // |foo:$bar
+        // |foo:&quot;bar&quot;:$foobar
+        // |foo|bar
+        // |foo:$foo-&gt;bar
+        $this-&gt;_mod_regexp = '(?:\|@?\w+(?::(?:\w+|' . $this-&gt;_num_const_regexp . '|'
+           . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_avar_regexp . '|' . $this-&gt;_qstr_regexp .'))*)';
+
+        // matches valid function name:
+        // foo123
+        // _foo_bar
+        $this-&gt;_func_regexp = '[a-zA-Z_]\w*';
+
+        // matches valid registered object:
+        // foo-&gt;bar
+        $this-&gt;_reg_obj_regexp = '[a-zA-Z_]\w*-&gt;[a-zA-Z_]\w*';
+
+        // matches valid parameter values:
+        // true
+        // $foo
+        // $foo|bar
+        // #foo#
+        // #foo#|bar
+        // &quot;text&quot;
+        // &quot;text&quot;|bar
+        // $foo-&gt;bar
+        $this-&gt;_param_regexp = '(?:\s*(?:' . $this-&gt;_obj_call_regexp . '|'
+           . $this-&gt;_var_regexp . '|' . $this-&gt;_num_const_regexp  . '|\w+)(?&gt;' . $this-&gt;_mod_regexp . '*)\s*)';
+
+        // matches valid parenthesised function parameters:
+        //
+        // &quot;text&quot;
+        //    $foo, $bar, &quot;text&quot;
+        // $foo|bar, &quot;foo&quot;|bar, $foo-&gt;bar($foo)|bar
+        $this-&gt;_parenth_param_regexp = '(?:\((?:\w+|'
+                . $this-&gt;_param_regexp . '(?:\s*,\s*(?:(?:\w+|'
+                . $this-&gt;_param_regexp . ')))*)?\))';
+
+        // matches valid function call:
+        // foo()
+        // foo_bar($foo)
+        // _foo_bar($foo,&quot;bar&quot;)
+        // foo123($foo,$foo-&gt;bar(),&quot;foo&quot;)
+        $this-&gt;_func_call_regexp = '(?:' . $this-&gt;_func_regexp . '\s*(?:'
+           . $this-&gt;_parenth_param_regexp . '))';
+    }
+
+    /**
+     * compile a resource
+     *
+     * sets $compiled_content to the compiled source
+     * @param string $resource_name
+     * @param string $source_content
+     * @param string $compiled_content
+     * @return true
+     */
+    function _compile_file($resource_name, $source_content, &amp;$compiled_content)
+    {
+
+        if ($this-&gt;security) {
+            // do not allow php syntax to be executed unless specified
+            if ($this-&gt;php_handling == SMARTY_PHP_ALLOW &amp;&amp;
+                !$this-&gt;security_settings['PHP_HANDLING']) {
+                $this-&gt;php_handling = SMARTY_PHP_PASSTHRU;
+            }
+        }
+
+        $this-&gt;_load_filters();
+
+        $this-&gt;_current_file = $resource_name;
+        $this-&gt;_current_line_no = 1;
+        $ldq = preg_quote($this-&gt;left_delimiter, '~');
+        $rdq = preg_quote($this-&gt;right_delimiter, '~');
+
+        // run template source through prefilter functions
+        if (count($this-&gt;_plugins['prefilter']) &gt; 0) {
+            foreach ($this-&gt;_plugins['prefilter'] as $filter_name =&gt; $prefilter) {
+                if ($prefilter === false) continue;
+                if ($prefilter[3] || is_callable($prefilter[0])) {
+                    $source_content = call_user_func_array($prefilter[0],
+                                                            array($source_content, &amp;$this));
+                    $this-&gt;_plugins['prefilter'][$filter_name][3] = true;
+                } else {
+                    $this-&gt;_trigger_fatal_error(&quot;[plugin] prefilter '$filter_name' is not implemented&quot;);
+                }
+            }
+        }
+
+        /* fetch all special blocks */
+        $search = &quot;~{$ldq}\*(.*?)\*{$rdq}|{$ldq}\s*literal\s*{$rdq}(.*?){$ldq}\s*/literal\s*{$rdq}|{$ldq}\s*php\s*{$rdq}(.*?){$ldq}\s*/php\s*{$rdq}~s&quot;;
+
+        preg_match_all($search, $source_content, $match,  PREG_SET_ORDER);
+        $this-&gt;_folded_blocks = $match;
+        reset($this-&gt;_folded_blocks);
+
+        /* replace special blocks by &quot;{php}&quot; */
+        $source_content = preg_replace($search.'e', &quot;'&quot;
+                                       . $this-&gt;_quote_replace($this-&gt;left_delimiter) . 'php'
+                                       . &quot;' . str_repeat(\&quot;\n\&quot;, substr_count('\\0', \&quot;\n\&quot;)) .'&quot;
+                                       . $this-&gt;_quote_replace($this-&gt;right_delimiter)
+                                       . &quot;'&quot;
+                                       , $source_content);
+
+        /* Gather all template tags. */
+        preg_match_all(&quot;~{$ldq}\s*(.*?)\s*{$rdq}~s&quot;, $source_content, $_match);
+        $template_tags = $_match[1];
+        /* Split content by template tags to obtain non-template content. */
+        $text_blocks = preg_split(&quot;~{$ldq}.*?{$rdq}~s&quot;, $source_content);
+
+        /* loop through text blocks */
+        for ($curr_tb = 0, $for_max = count($text_blocks); $curr_tb &lt; $for_max; $curr_tb++) {
+            /* match anything resembling php tags */
+            if (preg_match_all('~(&lt;\?(?:\w+|=)?|\?&gt;|language\s*=\s*[\&quot;\']?php[\&quot;\']?)~is', $text_blocks[$curr_tb], $sp_match)) {
+                /* replace tags with placeholders to prevent recursive replacements */
+                $sp_match[1] = array_unique($sp_match[1]);
+                usort($sp_match[1], '_smarty_sort_length');
+                for ($curr_sp = 0, $for_max2 = count($sp_match[1]); $curr_sp &lt; $for_max2; $curr_sp++) {
+                    $text_blocks[$curr_tb] = str_replace($sp_match[1][$curr_sp],'%%%SMARTYSP'.$curr_sp.'%%%',$text_blocks[$curr_tb]);
+                }
+                /* process each one */
+                for ($curr_sp = 0, $for_max2 = count($sp_match[1]); $curr_sp &lt; $for_max2; $curr_sp++) {
+                    if ($this-&gt;php_handling == SMARTY_PHP_PASSTHRU) {
+                        /* echo php contents */
+                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', '&lt;?php echo \''.str_replace(&quot;'&quot;, &quot;\'&quot;, $sp_match[1][$curr_sp]).'\'; ?&gt;'.&quot;\n&quot;, $text_blocks[$curr_tb]);
+                    } else if ($this-&gt;php_handling == SMARTY_PHP_QUOTE) {
+                        /* quote php tags */
+                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', htmlspecialchars($sp_match[1][$curr_sp]), $text_blocks[$curr_tb]);
+                    } else if ($this-&gt;php_handling == SMARTY_PHP_REMOVE) {
+                        /* remove php tags */
+                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', '', $text_blocks[$curr_tb]);
+                    } else {
+                        /* SMARTY_PHP_ALLOW, but echo non php starting tags */
+                        $sp_match[1][$curr_sp] = preg_replace('~(&lt;\?(?!php|=|$))~i', '&lt;?php echo \'\\1\'?&gt;'.&quot;\n&quot;, $sp_match[1][$curr_sp]);
+                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', $sp_match[1][$curr_sp], $text_blocks[$curr_tb]);
+                    }
+                }
+            }
+        }
+
+        /* Compile the template tags into PHP code. */
+        $compiled_tags = array();
+        for ($i = 0, $for_max = count($template_tags); $i &lt; $for_max; $i++) {
+            $this-&gt;_current_line_no += substr_count($text_blocks[$i], &quot;\n&quot;);
+            $compiled_tags[] = $this-&gt;_compile_tag($template_tags[$i]);
+            $this-&gt;_current_line_no += substr_count($template_tags[$i], &quot;\n&quot;);
+        }
+        if (count($this-&gt;_tag_stack)&gt;0) {
+            list($_open_tag, $_line_no) = end($this-&gt;_tag_stack);
+            $this-&gt;_syntax_error(&quot;unclosed tag \{$_open_tag} (opened line $_line_no).&quot;, E_USER_ERROR, __FILE__, __LINE__);
+            return;
+        }
+
+        /* Reformat $text_blocks between 'strip' and '/strip' tags,
+           removing spaces, tabs and newlines. */
+        $strip = false;
+        for ($i = 0, $for_max = count($compiled_tags); $i &lt; $for_max; $i++) {
+            if ($compiled_tags[$i] == '{strip}') {
+                $compiled_tags[$i] = '';
+                $strip = true;
+                /* remove leading whitespaces */
+                $text_blocks[$i + 1] = ltrim($text_blocks[$i + 1]);
+            }
+            if ($strip) {
+                /* strip all $text_blocks before the next '/strip' */
+                for ($j = $i + 1; $j &lt; $for_max; $j++) {
+                    /* remove leading and trailing whitespaces of each line */
+                    $text_blocks[$j] = preg_replace('![\t ]*[\r\n]+[\t ]*!', '', $text_blocks[$j]);
+                    if ($compiled_tags[$j] == '{/strip}') {                       
+                        /* remove trailing whitespaces from the last text_block */
+                        $text_blocks[$j] = rtrim($text_blocks[$j]);
+                    }
+                    $text_blocks[$j] = &quot;&lt;?php echo '&quot; . strtr($text_blocks[$j], array(&quot;'&quot;=&gt;&quot;\'&quot;, &quot;\\&quot;=&gt;&quot;\\\\&quot;)) . &quot;'; ?&gt;&quot;;
+                    if ($compiled_tags[$j] == '{/strip}') {
+                        $compiled_tags[$j] = &quot;\n&quot;; /* slurped by php, but necessary
+                                    if a newline is following the closing strip-tag */
+                        $strip = false;
+                        $i = $j;
+                        break;
+                    }
+                }
+            }
+        }
+        $compiled_content = '';
+
+        /* Interleave the compiled contents and text blocks to get the final result. */
+        for ($i = 0, $for_max = count($compiled_tags); $i &lt; $for_max; $i++) {
+            if ($compiled_tags[$i] == '') {
+                // tag result empty, remove first newline from following text block
+                $text_blocks[$i+1] = preg_replace('~^(\r\n|\r|\n)~', '', $text_blocks[$i+1]);
+            }
+            $compiled_content .= $text_blocks[$i].$compiled_tags[$i];
+        }
+        $compiled_content .= $text_blocks[$i];
+
+        // remove \n from the end of the file, if any
+        if (($_len=strlen($compiled_content)) &amp;&amp; ($compiled_content{$_len - 1} == &quot;\n&quot; )) {
+            $compiled_content = substr($compiled_content, 0, -1);
+        }
+
+        if (!empty($this-&gt;_cache_serial)) {
+            $compiled_content = &quot;&lt;?php \$this-&gt;_cache_serials['&quot;.$this-&gt;_cache_include.&quot;'] = '&quot;.$this-&gt;_cache_serial.&quot;'; ?&gt;&quot; . $compiled_content;
+        }
+
+        // remove unnecessary close/open tags
+        $compiled_content = preg_replace('~\?&gt;\n?&lt;\?php~', '', $compiled_content);
+
+        // run compiled template through postfilter functions
+        if (count($this-&gt;_plugins['postfilter']) &gt; 0) {
+            foreach ($this-&gt;_plugins['postfilter'] as $filter_name =&gt; $postfilter) {
+                if ($postfilter === false) continue;
+                if ($postfilter[3] || is_callable($postfilter[0])) {
+                    $compiled_content = call_user_func_array($postfilter[0],
+                                                              array($compiled_content, &amp;$this));
+                    $this-&gt;_plugins['postfilter'][$filter_name][3] = true;
+                } else {
+                    $this-&gt;_trigger_fatal_error(&quot;Smarty plugin error: postfilter '$filter_name' is not implemented&quot;);
+                }
+            }
+        }
+
+        // put header at the top of the compiled template
+        $template_header = &quot;&lt;?php /* Smarty version &quot;.$this-&gt;_version.&quot;, created on &quot;.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;).&quot;\n&quot;;
+        $template_header .= &quot;         compiled from &quot;.strtr(urlencode($resource_name), array('%2F'=&gt;'/', '%3A'=&gt;':')).&quot; */ ?&gt;\n&quot;;
+
+        /* Emit code to load needed plugins. */
+        $this-&gt;_plugins_code = '';
+        if (count($this-&gt;_plugin_info)) {
+            $_plugins_params = &quot;array('plugins' =&gt; array(&quot;;
+            foreach ($this-&gt;_plugin_info as $plugin_type =&gt; $plugins) {
+                foreach ($plugins as $plugin_name =&gt; $plugin_info) {
+                    $_plugins_params .= &quot;array('$plugin_type', '$plugin_name', '&quot; . strtr($plugin_info[0], array(&quot;'&quot; =&gt; &quot;\\'&quot;, &quot;\\&quot; =&gt; &quot;\\\\&quot;)) . &quot;', $plugin_info[1], &quot;;
+                    $_plugins_params .= $plugin_info[2] ? 'true),' : 'false),';
+                }
+            }
+            $_plugins_params .= '))';
+            $plugins_code = &quot;&lt;?php require_once(SMARTY_CORE_DIR . 'core.load_plugins.php');\nsmarty_core_load_plugins($_plugins_params, \$this); ?&gt;\n&quot;;
+            $template_header .= $plugins_code;
+            $this-&gt;_plugin_info = array();
+            $this-&gt;_plugins_code = $plugins_code;
+        }
+
+        if ($this-&gt;_init_smarty_vars) {
+            $template_header .= &quot;&lt;?php require_once(SMARTY_CORE_DIR . 'core.assign_smarty_interface.php');\nsmarty_core_assign_smarty_interface(null, \$this); ?&gt;\n&quot;;
+            $this-&gt;_init_smarty_vars = false;
+        }
+
+        $compiled_content = $template_header . $compiled_content;
+        return true;
+    }
+
+    /**
+     * Compile a template tag
+     *
+     * @param string $template_tag
+     * @return string
+     */
+    function _compile_tag($template_tag)
+    {
+        /* Matched comment. */
+        if ($template_tag{0} == '*' &amp;&amp; $template_tag{strlen($template_tag) - 1} == '*')
+            return '';
+        
+        /* Split tag into two three parts: command, command modifiers and the arguments. */
+        if(! preg_match('~^(?:(' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp
+                . '|\/?' . $this-&gt;_reg_obj_regexp . '|\/?' . $this-&gt;_func_regexp . ')(' . $this-&gt;_mod_regexp . '*))
+                      (?:\s+(.*))?$
+                    ~xs', $template_tag, $match)) {
+            $this-&gt;_syntax_error(&quot;unrecognized tag: $template_tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+        
+        $tag_command = $match[1];
+        $tag_modifier = isset($match[2]) ? $match[2] : null;
+        $tag_args = isset($match[3]) ? $match[3] : null;
+
+        if (preg_match('~^' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '$~', $tag_command)) {
+            /* tag name is a variable or object */
+            $_return = $this-&gt;_parse_var_props($tag_command . $tag_modifier);
+            return &quot;&lt;?php echo $_return; ?&gt;&quot; . $this-&gt;_additional_newline;
+        }
+
+        /* If the tag name is a registered object, we process it. */
+        if (preg_match('~^\/?' . $this-&gt;_reg_obj_regexp . '$~', $tag_command)) {
+            return $this-&gt;_compile_registered_object_tag($tag_command, $this-&gt;_parse_attrs($tag_args), $tag_modifier);
+        }
+
+        switch ($tag_command) {
+            case 'include':
+                return $this-&gt;_compile_include_tag($tag_args);
+
+            case 'include_php':
+                return $this-&gt;_compile_include_php_tag($tag_args);
+
+            case 'if':
+                $this-&gt;_push_tag('if');
+                return $this-&gt;_compile_if_tag($tag_args);
+
+            case 'else':
+                list($_open_tag) = end($this-&gt;_tag_stack);
+                if ($_open_tag != 'if' &amp;&amp; $_open_tag != 'elseif')
+                    $this-&gt;_syntax_error('unexpected {else}', E_USER_ERROR, __FILE__, __LINE__);
+                else
+                    $this-&gt;_push_tag('else');
+                return '&lt;?php else: ?&gt;';
+
+            case 'elseif':
+                list($_open_tag) = end($this-&gt;_tag_stack);
+                if ($_open_tag != 'if' &amp;&amp; $_open_tag != 'elseif')
+                    $this-&gt;_syntax_error('unexpected {elseif}', E_USER_ERROR, __FILE__, __LINE__);
+                if ($_open_tag == 'if')
+                    $this-&gt;_push_tag('elseif');
+                return $this-&gt;_compile_if_tag($tag_args, true);
+
+            case '/if':
+                $this-&gt;_pop_tag('if');
+                return '&lt;?php endif; ?&gt;';
+
+            case 'capture':
+                return $this-&gt;_compile_capture_tag(true, $tag_args);
+
+            case '/capture':
+                return $this-&gt;_compile_capture_tag(false);
+
+            case 'ldelim':
+                return $this-&gt;left_delimiter;
+
+            case 'rdelim':
+                return $this-&gt;right_delimiter;
+
+            case 'section':
+                $this-&gt;_push_tag('section');
+                return $this-&gt;_compile_section_start($tag_args);
+
+            case 'sectionelse':
+                $this-&gt;_push_tag('sectionelse');
+                return &quot;&lt;?php endfor; else: ?&gt;&quot;;
+                break;
+
+            case '/section':
+                $_open_tag = $this-&gt;_pop_tag('section');
+                if ($_open_tag == 'sectionelse')
+                    return &quot;&lt;?php endif; ?&gt;&quot;;
+                else
+                    return &quot;&lt;?php endfor; endif; ?&gt;&quot;;
+
+            case 'foreach':
+                $this-&gt;_push_tag('foreach');
+                return $this-&gt;_compile_foreach_start($tag_args);
+                break;
+
+            case 'foreachelse':
+                $this-&gt;_push_tag('foreachelse');
+                return &quot;&lt;?php endforeach; else: ?&gt;&quot;;
+
+            case '/foreach':
+                $_open_tag = $this-&gt;_pop_tag('foreach');
+                if ($_open_tag == 'foreachelse')
+                    return &quot;&lt;?php endif; unset(\$_from); ?&gt;&quot;;
+                else
+                    return &quot;&lt;?php endforeach; endif; unset(\$_from); ?&gt;&quot;;
+                break;
+
+            case 'strip':
+            case '/strip':
+                if ($tag_command{0}=='/') {
+                    $this-&gt;_pop_tag('strip');
+                    if (--$this-&gt;_strip_depth==0) { /* outermost closing {/strip} */
+                        $this-&gt;_additional_newline = &quot;\n&quot;;
+                        return '{' . $tag_command . '}';
+                    }
+                } else {
+                    $this-&gt;_push_tag('strip');
+                    if ($this-&gt;_strip_depth++==0) { /* outermost opening {strip} */
+                        $this-&gt;_additional_newline = &quot;&quot;;
+                        return '{' . $tag_command . '}';
+                    }
+                }
+                return '';
+
+            case 'php':
+                /* handle folded tags replaced by {php} */
+                list(, $block) = each($this-&gt;_folded_blocks);
+                $this-&gt;_current_line_no += substr_count($block[0], &quot;\n&quot;);
+                /* the number of matched elements in the regexp in _compile_file()
+                   determins the type of folded tag that was found */
+                switch (count($block)) {
+                    case 2: /* comment */
+                        return '';
+
+                    case 3: /* literal */
+                        return &quot;&lt;?php echo '&quot; . strtr($block[2], array(&quot;'&quot;=&gt;&quot;\'&quot;, &quot;\\&quot;=&gt;&quot;\\\\&quot;)) . &quot;'; ?&gt;&quot; . $this-&gt;_additional_newline;
+
+                    case 4: /* php */
+                        if ($this-&gt;security &amp;&amp; !$this-&gt;security_settings['PHP_TAGS']) {
+                            $this-&gt;_syntax_error(&quot;(secure mode) php tags not permitted&quot;, E_USER_WARNING, __FILE__, __LINE__);
+                            return;
+                        }
+                        return '&lt;?php ' . $block[3] .' ?&gt;';
+                }
+                break;
+
+            case 'insert':
+                return $this-&gt;_compile_insert_tag($tag_args);
+
+            default:
+                if ($this-&gt;_compile_compiler_tag($tag_command, $tag_args, $output)) {
+                    return $output;
+                } else if ($this-&gt;_compile_block_tag($tag_command, $tag_args, $tag_modifier, $output)) {
+                    return $output;
+                } else if ($this-&gt;_compile_custom_tag($tag_command, $tag_args, $tag_modifier, $output)) {
+                    return $output;                    
+                } else {
+                    $this-&gt;_syntax_error(&quot;unrecognized tag '$tag_command'&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                }
+
+        }
+    }
+
+
+    /**
+     * compile the custom compiler tag
+     *
+     * sets $output to the compiled custom compiler tag
+     * @param string $tag_command
+     * @param string $tag_args
+     * @param string $output
+     * @return boolean
+     */
+    function _compile_compiler_tag($tag_command, $tag_args, &amp;$output)
+    {
+        $found = false;
+        $have_function = true;
+
+        /*
+         * First we check if the compiler function has already been registered
+         * or loaded from a plugin file.
+         */
+        if (isset($this-&gt;_plugins['compiler'][$tag_command])) {
+            $found = true;
+            $plugin_func = $this-&gt;_plugins['compiler'][$tag_command][0];
+            if (!is_callable($plugin_func)) {
+                $message = &quot;compiler function '$tag_command' is not implemented&quot;;
+                $have_function = false;
+            }
+        }
+        /*
+         * Otherwise we need to load plugin file and look for the function
+         * inside it.
+         */
+        else if ($plugin_file = $this-&gt;_get_plugin_filepath('compiler', $tag_command)) {
+            $found = true;
+
+            include_once $plugin_file;
+
+            $plugin_func = 'smarty_compiler_' . $tag_command;
+            if (!is_callable($plugin_func)) {
+                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
+                $have_function = false;
+            } else {
+                $this-&gt;_plugins['compiler'][$tag_command] = array($plugin_func, null, null, null, true);
+            }
+        }
+
+        /*
+         * True return value means that we either found a plugin or a
+         * dynamically registered function. False means that we didn't and the
+         * compiler should now emit code to load custom function plugin for this
+         * tag.
+         */
+        if ($found) {
+            if ($have_function) {
+                $output = call_user_func_array($plugin_func, array($tag_args, &amp;$this));
+                if($output != '') {
+                $output = '&lt;?php ' . $this-&gt;_push_cacheable_state('compiler', $tag_command)
+                                   . $output
+                                   . $this-&gt;_pop_cacheable_state('compiler', $tag_command) . ' ?&gt;';
+                }
+            } else {
+                $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
+            }
+            return true;
+        } else {
+            return false;
+        }
+    }
+
+
+    /**
+     * compile block function tag
+     *
+     * sets $output to compiled block function tag
+     * @param string $tag_command
+     * @param string $tag_args
+     * @param string $tag_modifier
+     * @param string $output
+     * @return boolean
+     */
+    function _compile_block_tag($tag_command, $tag_args, $tag_modifier, &amp;$output)
+    {
+        if ($tag_command{0} == '/') {
+            $start_tag = false;
+            $tag_command = substr($tag_command, 1);
+        } else
+            $start_tag = true;
+
+        $found = false;
+        $have_function = true;
+
+        /*
+         * First we check if the block function has already been registered
+         * or loaded from a plugin file.
+         */
+        if (isset($this-&gt;_plugins['block'][$tag_command])) {
+            $found = true;
+            $plugin_func = $this-&gt;_plugins['block'][$tag_command][0];
+            if (!is_callable($plugin_func)) {
+                $message = &quot;block function '$tag_command' is not implemented&quot;;
+                $have_function = false;
+            }
+        }
+        /*
+         * Otherwise we need to load plugin file and look for the function
+         * inside it.
+         */
+        else if ($plugin_file = $this-&gt;_get_plugin_filepath('block', $tag_command)) {
+            $found = true;
+
+            include_once $plugin_file;
+
+            $plugin_func = 'smarty_block_' . $tag_command;
+            if (!function_exists($plugin_func)) {
+                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
+                $have_function = false;
+            } else {
+                $this-&gt;_plugins['block'][$tag_command] = array($plugin_func, null, null, null, true);
+
+            }
+        }
+
+        if (!$found) {
+            return false;
+        } else if (!$have_function) {
+            $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
+            return true;
+        }
+
+        /*
+         * Even though we've located the plugin function, compilation
+         * happens only once, so the plugin will still need to be loaded
+         * at runtime for future requests.
+         */
+        $this-&gt;_add_plugin('block', $tag_command);
+
+        if ($start_tag)
+            $this-&gt;_push_tag($tag_command);
+        else
+            $this-&gt;_pop_tag($tag_command);
+
+        if ($start_tag) {
+            $output = '&lt;?php ' . $this-&gt;_push_cacheable_state('block', $tag_command);
+            $attrs = $this-&gt;_parse_attrs($tag_args);
+            $arg_list = $this-&gt;_compile_arg_list('block', $tag_command, $attrs, $_cache_attrs='');
+            $output .= &quot;$_cache_attrs\$this-&gt;_tag_stack[] = array('$tag_command', array(&quot;.implode(',', $arg_list).')); ';
+            $output .= $this-&gt;_compile_plugin_call('block', $tag_command).'($this-&gt;_tag_stack[count($this-&gt;_tag_stack)-1][1], null, $this, $_block_repeat=true);';
+            $output .= 'while ($_block_repeat) { ob_start(); ?&gt;';
+        } else {
+            $output = '&lt;?php $_block_content = ob_get_contents(); ob_end_clean(); ';
+            $_out_tag_text = $this-&gt;_compile_plugin_call('block', $tag_command).'($this-&gt;_tag_stack[count($this-&gt;_tag_stack)-1][1], $_block_content, $this, $_block_repeat=false)';
+            if ($tag_modifier != '') {
+                $this-&gt;_parse_modifiers($_out_tag_text, $tag_modifier);
+            }
+            $output .= 'echo '.$_out_tag_text.'; } ';
+            $output .= &quot; array_pop(\$this-&gt;_tag_stack); &quot; . $this-&gt;_pop_cacheable_state('block', $tag_command) . '?&gt;';
+        }
+
+        return true;
+    }
+
+
+    /**
+     * compile custom function tag
+     *
+     * @param string $tag_command
+     * @param string $tag_args
+     * @param string $tag_modifier
+     * @return string
+     */
+    function _compile_custom_tag($tag_command, $tag_args, $tag_modifier, &amp;$output)
+    {
+        $found = false;
+        $have_function = true;
+
+        /*
+         * First we check if the custom function has already been registered
+         * or loaded from a plugin file.
+         */
+        if (isset($this-&gt;_plugins['function'][$tag_command])) {
+            $found = true;
+            $plugin_func = $this-&gt;_plugins['function'][$tag_command][0];
+            if (!is_callable($plugin_func)) {
+                $message = &quot;custom function '$tag_command' is not implemented&quot;;
+                $have_function = false;
+            }
+        }
+        /*
+         * Otherwise we need to load plugin file and look for the function
+         * inside it.
+         */
+        else if ($plugin_file = $this-&gt;_get_plugin_filepath('function', $tag_command)) {
+            $found = true;
+
+            include_once $plugin_file;
+
+            $plugin_func = 'smarty_function_' . $tag_command;
+            if (!function_exists($plugin_func)) {
+                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
+                $have_function = false;
+            } else {
+                $this-&gt;_plugins['function'][$tag_command] = array($plugin_func, null, null, null, true);
+
+            }
+        }
+
+        if (!$found) {
+            return false;
+        } else if (!$have_function) {
+            $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
+            return true;
+        }
+
+        /* declare plugin to be loaded on display of the template that
+           we compile right now */
+        $this-&gt;_add_plugin('function', $tag_command);
+
+        $_cacheable_state = $this-&gt;_push_cacheable_state('function', $tag_command);
+        $attrs = $this-&gt;_parse_attrs($tag_args);
+        $arg_list = $this-&gt;_compile_arg_list('function', $tag_command, $attrs, $_cache_attrs='');
+
+        $output = $this-&gt;_compile_plugin_call('function', $tag_command).'(array('.implode(',', $arg_list).&quot;), \$this)&quot;;
+        if($tag_modifier != '') {
+            $this-&gt;_parse_modifiers($output, $tag_modifier);
+        }
+
+        if($output != '') {
+            $output =  '&lt;?php ' . $_cacheable_state . $_cache_attrs . 'echo ' . $output . ';'
+                . $this-&gt;_pop_cacheable_state('function', $tag_command) . &quot;?&gt;&quot; . $this-&gt;_additional_newline;
+        }
+
+        return true;
+    }
+
+    /**
+     * compile a registered object tag
+     *
+     * @param string $tag_command
+     * @param array $attrs
+     * @param string $tag_modifier
+     * @return string
+     */
+    function _compile_registered_object_tag($tag_command, $attrs, $tag_modifier)
+    {
+        if ($tag_command{0} == '/') {
+            $start_tag = false;
+            $tag_command = substr($tag_command, 1);
+        } else {
+            $start_tag = true;
+        }
+
+        list($object, $obj_comp) = explode('-&gt;', $tag_command);
+
+        $arg_list = array();
+        if(count($attrs)) {
+            $_assign_var = false;
+            foreach ($attrs as $arg_name =&gt; $arg_value) {
+                if($arg_name == 'assign') {
+                    $_assign_var = $arg_value;
+                    unset($attrs['assign']);
+                    continue;
+                }
+                if (is_bool($arg_value))
+                    $arg_value = $arg_value ? 'true' : 'false';
+                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
+            }
+        }
+
+        if($this-&gt;_reg_objects[$object][2]) {
+            // smarty object argument format
+            $args = &quot;array(&quot;.implode(',', (array)$arg_list).&quot;), \$this&quot;;
+        } else {
+            // traditional argument format
+            $args = implode(',', array_values($attrs));
+            if (empty($args)) {
+                $args = 'null';
+            }
+        }
+
+        $prefix = '';
+        $postfix = '';
+        $newline = '';
+        if(!is_object($this-&gt;_reg_objects[$object][0])) {
+            $this-&gt;_trigger_fatal_error(&quot;registered '$object' is not an object&quot; , $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
+        } elseif(!empty($this-&gt;_reg_objects[$object][1]) &amp;&amp; !in_array($obj_comp, $this-&gt;_reg_objects[$object][1])) {
+            $this-&gt;_trigger_fatal_error(&quot;'$obj_comp' is not a registered component of object '$object'&quot;, $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
+        } elseif(method_exists($this-&gt;_reg_objects[$object][0], $obj_comp)) {
+            // method
+            if(in_array($obj_comp, $this-&gt;_reg_objects[$object][3])) {
+                // block method
+                if ($start_tag) {
+                    $prefix = &quot;\$this-&gt;_tag_stack[] = array('$obj_comp', $args); &quot;;
+                    $prefix .= &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp(\$this-&gt;_tag_stack[count(\$this-&gt;_tag_stack)-1][1], null, \$this, \$_block_repeat=true); &quot;;
+                    $prefix .= &quot;while (\$_block_repeat) { ob_start();&quot;;
+                    $return = null;
+                    $postfix = '';
+            } else {
+                    $prefix = &quot;\$_obj_block_content = ob_get_contents(); ob_end_clean(); &quot;;
+                    $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp(\$this-&gt;_tag_stack[count(\$this-&gt;_tag_stack)-1][1], \$_obj_block_content, \$this, \$_block_repeat=false)&quot;;
+                    $postfix = &quot;} array_pop(\$this-&gt;_tag_stack);&quot;;
+                }
+            } else {
+                // non-block method
+                $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp($args)&quot;;
+            }
+        } else {
+            // property
+            $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp&quot;;
+        }
+
+        if($return != null) {
+            if($tag_modifier != '') {
+                $this-&gt;_parse_modifiers($return, $tag_modifier);
+            }
+
+            if(!empty($_assign_var)) {
+                $output = &quot;\$this-&gt;assign('&quot; . $this-&gt;_dequote($_assign_var) .&quot;',  $return);&quot;;
+            } else {
+                $output = 'echo ' . $return . ';';
+                $newline = $this-&gt;_additional_newline;
+            }
+        } else {
+            $output = '';
+        }
+
+        return '&lt;?php ' . $prefix . $output . $postfix . &quot;?&gt;&quot; . $newline;
+    }
+
+    /**
+     * Compile {insert ...} tag
+     *
+     * @param string $tag_args
+     * @return string
+     */
+    function _compile_insert_tag($tag_args)
+    {
+        $attrs = $this-&gt;_parse_attrs($tag_args);
+        $name = $this-&gt;_dequote($attrs['name']);
+
+        if (empty($name)) {
+            $this-&gt;_syntax_error(&quot;missing insert name&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+
+        if (!empty($attrs['script'])) {
+            $delayed_loading = true;
+        } else {
+            $delayed_loading = false;
+        }
+
+        foreach ($attrs as $arg_name =&gt; $arg_value) {
+            if (is_bool($arg_value))
+                $arg_value = $arg_value ? 'true' : 'false';
+            $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
+        }
+
+        $this-&gt;_add_plugin('insert', $name, $delayed_loading);
+
+        $_params = &quot;array('args' =&gt; array(&quot;.implode(', ', (array)$arg_list).&quot;))&quot;;
+
+        return &quot;&lt;?php require_once(SMARTY_CORE_DIR . 'core.run_insert_handler.php');\necho smarty_core_run_insert_handler($_params, \$this); ?&gt;&quot; . $this-&gt;_additional_newline;
+    }
+
+    /**
+     * Compile {include ...} tag
+     *
+     * @param string $tag_args
+     * @return string
+     */
+    function _compile_include_tag($tag_args)
+    {
+        $attrs = $this-&gt;_parse_attrs($tag_args);
+        $arg_list = array();
+
+        if (empty($attrs['file'])) {
+            $this-&gt;_syntax_error(&quot;missing 'file' attribute in include tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+
+        foreach ($attrs as $arg_name =&gt; $arg_value) {
+            if ($arg_name == 'file') {
+                $include_file = $arg_value;
+                continue;
+            } else if ($arg_name == 'assign') {
+                $assign_var = $arg_value;
+                continue;
+            }
+            if (is_bool($arg_value))
+                $arg_value = $arg_value ? 'true' : 'false';
+            $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
+        }
+
+        $output = '&lt;?php ';
+
+        if (isset($assign_var)) {
+            $output .= &quot;ob_start();\n&quot;;
+        }
+
+        $output .=
+            &quot;\$_smarty_tpl_vars = \$this-&gt;_tpl_vars;\n&quot;;
+
+
+        $_params = &quot;array('smarty_include_tpl_file' =&gt; &quot; . $include_file . &quot;, 'smarty_include_vars' =&gt; array(&quot;.implode(',', (array)$arg_list).&quot;))&quot;;
+        $output .= &quot;\$this-&gt;_smarty_include($_params);\n&quot; .
+        &quot;\$this-&gt;_tpl_vars = \$_smarty_tpl_vars;\n&quot; .
+        &quot;unset(\$_smarty_tpl_vars);\n&quot;;
+
+        if (isset($assign_var)) {
+            $output .= &quot;\$this-&gt;assign(&quot; . $assign_var . &quot;, ob_get_contents()); ob_end_clean();\n&quot;;
+        }
+
+        $output .= ' ?&gt;';
+
+        return $output;
+
+    }
+
+    /**
+     * Compile {include ...} tag
+     *
+     * @param string $tag_args
+     * @return string
+     */
+    function _compile_include_php_tag($tag_args)
+    {
+        $attrs = $this-&gt;_parse_attrs($tag_args);
+
+        if (empty($attrs['file'])) {
+            $this-&gt;_syntax_error(&quot;missing 'file' attribute in include_php tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+
+        $assign_var = (empty($attrs['assign'])) ? '' : $this-&gt;_dequote($attrs['assign']);
+        $once_var = (empty($attrs['once']) || $attrs['once']=='false') ? 'false' : 'true';
+
+        $arg_list = array();
+        foreach($attrs as $arg_name =&gt; $arg_value) {
+            if($arg_name != 'file' AND $arg_name != 'once' AND $arg_name != 'assign') {
+                if(is_bool($arg_value))
+                    $arg_value = $arg_value ? 'true' : 'false';
+                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
+            }
+        }
+
+        $_params = &quot;array('smarty_file' =&gt; &quot; . $attrs['file'] . &quot;, 'smarty_assign' =&gt; '$assign_var', 'smarty_once' =&gt; $once_var, 'smarty_include_vars' =&gt; array(&quot;.implode(',', $arg_list).&quot;))&quot;;
+
+        return &quot;&lt;?php require_once(SMARTY_CORE_DIR . 'core.smarty_include_php.php');\nsmarty_core_smarty_include_php($_params, \$this); ?&gt;&quot; . $this-&gt;_additional_newline;
+    }
+
+
+    /**
+     * Compile {section ...} tag
+     *
+     * @param string $tag_args
+     * @return string
+     */
+    function _compile_section_start($tag_args)
+    {
+        $attrs = $this-&gt;_parse_attrs($tag_args);
+        $arg_list = array();
+
+        $output = '&lt;?php ';
+        $section_name = $attrs['name'];
+        if (empty($section_name)) {
+            $this-&gt;_syntax_error(&quot;missing section name&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+
+        $output .= &quot;unset(\$this-&gt;_sections[$section_name]);\n&quot;;
+        $section_props = &quot;\$this-&gt;_sections[$section_name]&quot;;
+
+        foreach ($attrs as $attr_name =&gt; $attr_value) {
+            switch ($attr_name) {
+                case 'loop':
+                    $output .= &quot;{$section_props}['loop'] = is_array(\$_loop=$attr_value) ? count(\$_loop) : max(0, (int)\$_loop); unset(\$_loop);\n&quot;;
+                    break;
+
+                case 'show':
+                    if (is_bool($attr_value))
+                        $show_attr_value = $attr_value ? 'true' : 'false';
+                    else
+                        $show_attr_value = &quot;(bool)$attr_value&quot;;
+                    $output .= &quot;{$section_props}['show'] = $show_attr_value;\n&quot;;
+                    break;
+
+                case 'name':
+                    $output .= &quot;{$section_props}['$attr_name'] = $attr_value;\n&quot;;
+                    break;
+
+                case 'max':
+                case 'start':
+                    $output .= &quot;{$section_props}['$attr_name'] = (int)$attr_value;\n&quot;;
+                    break;
+
+                case 'step':
+                    $output .= &quot;{$section_props}['$attr_name'] = ((int)$attr_value) == 0 ? 1 : (int)$attr_value;\n&quot;;
+                    break;
+
+                default:
+                    $this-&gt;_syntax_error(&quot;unknown section attribute - '$attr_name'&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                    break;
+            }
+        }
+
+        if (!isset($attrs['show']))
+            $output .= &quot;{$section_props}['show'] = true;\n&quot;;
+
+        if (!isset($attrs['loop']))
+            $output .= &quot;{$section_props}['loop'] = 1;\n&quot;;
+
+        if (!isset($attrs['max']))
+            $output .= &quot;{$section_props}['max'] = {$section_props}['loop'];\n&quot;;
+        else
+            $output .= &quot;if ({$section_props}['max'] &lt; 0)\n&quot; .
+                       &quot;    {$section_props}['max'] = {$section_props}['loop'];\n&quot;;
+
+        if (!isset($attrs['step']))
+            $output .= &quot;{$section_props}['step'] = 1;\n&quot;;
+
+        if (!isset($attrs['start']))
+            $output .= &quot;{$section_props}['start'] = {$section_props}['step'] &gt; 0 ? 0 : {$section_props}['loop']-1;\n&quot;;
+        else {
+            $output .= &quot;if ({$section_props}['start'] &lt; 0)\n&quot; .
+                       &quot;    {$section_props}['start'] = max({$section_props}['step'] &gt; 0 ? 0 : -1, {$section_props}['loop'] + {$section_props}['start']);\n&quot; .
+                       &quot;else\n&quot; .
+                       &quot;    {$section_props}['start'] = min({$section_props}['start'], {$section_props}['step'] &gt; 0 ? {$section_props}['loop'] : {$section_props}['loop']-1);\n&quot;;
+        }
+
+        $output .= &quot;if ({$section_props}['show']) {\n&quot;;
+        if (!isset($attrs['start']) &amp;&amp; !isset($attrs['step']) &amp;&amp; !isset($attrs['max'])) {
+            $output .= &quot;    {$section_props}['total'] = {$section_props}['loop'];\n&quot;;
+        } else {
+            $output .= &quot;    {$section_props}['total'] = min(ceil(({$section_props}['step'] &gt; 0 ? {$section_props}['loop'] - {$section_props}['start'] : {$section_props}['start']+1)/abs({$section_props}['step'])), {$section_props}['max']);\n&quot;;
+        }
+        $output .= &quot;    if ({$section_props}['total'] == 0)\n&quot; .
+                   &quot;        {$section_props}['show'] = false;\n&quot; .
+                   &quot;} else\n&quot; .
+                   &quot;    {$section_props}['total'] = 0;\n&quot;;
+
+        $output .= &quot;if ({$section_props}['show']):\n&quot;;
+        $output .= &quot;
+            for ({$section_props}['index'] = {$section_props}['start'], {$section_props}['iteration'] = 1;
+                 {$section_props}['iteration'] &lt;= {$section_props}['total'];
+                 {$section_props}['index'] += {$section_props}['step'], {$section_props}['iteration']++):\n&quot;;
+        $output .= &quot;{$section_props}['rownum'] = {$section_props}['iteration'];\n&quot;;
+        $output .= &quot;{$section_props}['index_prev'] = {$section_props}['index'] - {$section_props}['step'];\n&quot;;
+        $output .= &quot;{$section_props}['index_next'] = {$section_props}['index'] + {$section_props}['step'];\n&quot;;
+        $output .= &quot;{$section_props}['first']      = ({$section_props}['iteration'] == 1);\n&quot;;
+        $output .= &quot;{$section_props}['last']       = ({$section_props}['iteration'] == {$section_props}['total']);\n&quot;;
+
+        $output .= &quot;?&gt;&quot;;
+
+        return $output;
+    }
+
+
+    /**
+     * Compile {foreach ...} tag.
+     *
+     * @param string $tag_args
+     * @return string
+     */
+    function _compile_foreach_start($tag_args)
+    {
+        $attrs = $this-&gt;_parse_attrs($tag_args);
+        $arg_list = array();
+
+        if (empty($attrs['from'])) {
+            return $this-&gt;_syntax_error(&quot;foreach: missing 'from' attribute&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+        $from = $attrs['from'];
+
+        if (empty($attrs['item'])) {
+            return $this-&gt;_syntax_error(&quot;foreach: missing 'item' attribute&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+        $item = $this-&gt;_dequote($attrs['item']);
+        if (!preg_match('~^\w+$~', $item)) {
+            return $this-&gt;_syntax_error(&quot;'foreach: item' must be a variable name (literal string)&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+
+        if (isset($attrs['key'])) {
+            $key  = $this-&gt;_dequote($attrs['key']);
+            if (!preg_match('~^\w+$~', $key)) {
+                return $this-&gt;_syntax_error(&quot;foreach: 'key' must to be a variable name (literal string)&quot;, E_USER_ERROR, __FILE__, __LINE__);
+            }
+            $key_part = &quot;\$this-&gt;_tpl_vars['$key'] =&gt; &quot;;
+        } else {
+            $key = null;
+            $key_part = '';
+        }
+
+        if (isset($attrs['name'])) {
+            $name = $attrs['name'];
+        } else {
+            $name = null;
+        }
+
+        $output = '&lt;?php ';
+        $output .= &quot;\$_from = $from; if (!is_array(\$_from) &amp;&amp; !is_object(\$_from)) { settype(\$_from, 'array'); }&quot;;
+        if (isset($name)) {
+            $foreach_props = &quot;\$this-&gt;_foreach[$name]&quot;;
+            $output .= &quot;{$foreach_props} = array('total' =&gt; count(\$_from), 'iteration' =&gt; 0);\n&quot;;
+            $output .= &quot;if ({$foreach_props}['total'] &gt; 0):\n&quot;;
+            $output .= &quot;    foreach (\$_from as $key_part\$this-&gt;_tpl_vars['$item']):\n&quot;;
+            $output .= &quot;        {$foreach_props}['iteration']++;\n&quot;;
+        } else {
+            $output .= &quot;if (count(\$_from)):\n&quot;;
+            $output .= &quot;    foreach (\$_from as $key_part\$this-&gt;_tpl_vars['$item']):\n&quot;;
+        }
+        $output .= '?&gt;';
+
+        return $output;
+    }
+
+
+    /**
+     * Compile {capture} .. {/capture} tags
+     *
+     * @param boolean $start true if this is the {capture} tag
+     * @param string $tag_args
+     * @return string
+     */
+
+    function _compile_capture_tag($start, $tag_args = '')
+    {
+        $attrs = $this-&gt;_parse_attrs($tag_args);
+
+        if ($start) {
+            if (isset($attrs['name']))
+                $buffer = $attrs['name'];
+            else
+                $buffer = &quot;'default'&quot;;
+
+            if (isset($attrs['assign']))
+                $assign = $attrs['assign'];
+            else
+                $assign = null;
+            $output = &quot;&lt;?php ob_start(); ?&gt;&quot;;
+            $this-&gt;_capture_stack[] = array($buffer, $assign);
+        } else {
+            list($buffer, $assign) = array_pop($this-&gt;_capture_stack);
+            $output = &quot;&lt;?php \$this-&gt;_smarty_vars['capture'][$buffer] = ob_get_contents(); &quot;;
+            if (isset($assign)) {
+                $output .= &quot; \$this-&gt;assign($assign, ob_get_contents());&quot;;
+            }
+            $output .= &quot;ob_end_clean(); ?&gt;&quot;;
+        }
+
+        return $output;
+    }
+
+    /**
+     * Compile {if ...} tag
+     *
+     * @param string $tag_args
+     * @param boolean $elseif if true, uses elseif instead of if
+     * @return string
+     */
+    function _compile_if_tag($tag_args, $elseif = false)
+    {
+
+        /* Tokenize args for 'if' tag. */
+        preg_match_all('~(?&gt;
+                ' . $this-&gt;_obj_call_regexp . '(?:' . $this-&gt;_mod_regexp . '*)? | # valid object call
+                ' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . '*)?    | # var or quoted string
+                \-?0[xX][0-9a-fA-F]+|\-?\d+(?:\.\d+)?|\.\d+|!==|===|==|!=|&lt;&gt;|&lt;&lt;|&gt;&gt;|&lt;=|&gt;=|\&amp;\&amp;|\|\||\(|\)|,|\!|\^|=|\&amp;|\~|&lt;|&gt;|\||\%|\+|\-|\/|\*|\@    | # valid non-word token
+                \b\w+\b                                                        | # valid word token
+                \S+                                                           # anything else
+                )~x', $tag_args, $match);
+
+        $tokens = $match[0];
+
+        if(empty($tokens)) {
+            $_error_msg .= $elseif ? &quot;'elseif'&quot; : &quot;'if'&quot;;
+            $_error_msg .= ' statement requires arguments'; 
+            $this-&gt;_syntax_error($_error_msg, E_USER_ERROR, __FILE__, __LINE__);
+        }
+            
+                
+        // make sure we have balanced parenthesis
+        $token_count = array_count_values($tokens);
+        if(isset($token_count['(']) &amp;&amp; $token_count['('] != $token_count[')']) {
+            $this-&gt;_syntax_error(&quot;unbalanced parenthesis in if statement&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+
+        $is_arg_stack = array();
+
+        for ($i = 0; $i &lt; count($tokens); $i++) {
+
+            $token = &amp;$tokens[$i];
+
+            switch (strtolower($token)) {
+                case '!':
+                case '%':
+                case '!==':
+                case '==':
+                case '===':
+                case '&gt;':
+                case '&lt;':
+                case '!=':
+                case '&lt;&gt;':
+                case '&lt;&lt;':
+                case '&gt;&gt;':
+                case '&lt;=':
+                case '&gt;=':
+                case '&amp;&amp;':
+                case '||':
+                case '|':
+                case '^':
+                case '&amp;':
+                case '~':
+                case ')':
+                case ',':
+                case '+':
+                case '-':
+                case '*':
+                case '/':
+                case '@':
+                    break;
+
+                case 'eq':
+                    $token = '==';
+                    break;
+
+                case 'ne':
+                case 'neq':
+                    $token = '!=';
+                    break;
+
+                case 'lt':
+                    $token = '&lt;';
+                    break;
+
+                case 'le':
+                case 'lte':
+                    $token = '&lt;=';
+                    break;
+
+                case 'gt':
+                    $token = '&gt;';
+                    break;
+
+                case 'ge':
+                case 'gte':
+                    $token = '&gt;=';
+                    break;
+
+                case 'and':
+                    $token = '&amp;&amp;';
+                    break;
+
+                case 'or':
+                    $token = '||';
+                    break;
+
+                case 'not':
+                    $token = '!';
+                    break;
+
+                case 'mod':
+                    $token = '%';
+                    break;
+
+                case '(':
+                    array_push($is_arg_stack, $i);
+                    break;
+
+                case 'is':
+                    /* If last token was a ')', we operate on the parenthesized
+                       expression. The start of the expression is on the stack.
+                       Otherwise, we operate on the last encountered token. */
+                    if ($tokens[$i-1] == ')')
+                        $is_arg_start = array_pop($is_arg_stack);
+                    else
+                        $is_arg_start = $i-1;
+                    /* Construct the argument for 'is' expression, so it knows
+                       what to operate on. */
+                    $is_arg = implode(' ', array_slice($tokens, $is_arg_start, $i - $is_arg_start));
+
+                    /* Pass all tokens from next one until the end to the
+                       'is' expression parsing function. The function will
+                       return modified tokens, where the first one is the result
+                       of the 'is' expression and the rest are the tokens it
+                       didn't touch. */
+                    $new_tokens = $this-&gt;_parse_is_expr($is_arg, array_slice($tokens, $i+1));
+
+                    /* Replace the old tokens with the new ones. */
+                    array_splice($tokens, $is_arg_start, count($tokens), $new_tokens);
+
+                    /* Adjust argument start so that it won't change from the
+                       current position for the next iteration. */
+                    $i = $is_arg_start;
+                    break;
+
+                default:
+                    if(preg_match('~^' . $this-&gt;_func_regexp . '$~', $token) ) {
+                            // function call
+                            if($this-&gt;security &amp;&amp;
+                               !in_array($token, $this-&gt;security_settings['IF_FUNCS'])) {
+                                $this-&gt;_syntax_error(&quot;(secure mode) '$token' not allowed in if statement&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                            }
+                    } elseif(preg_match('~^' . $this-&gt;_var_regexp . '$~', $token) &amp;&amp; isset($tokens[$i+1]) &amp;&amp; $tokens[$i+1] == '(') {
+                        // variable function call
+                        $this-&gt;_syntax_error(&quot;variable function call '$token' not allowed in if statement&quot;, E_USER_ERROR, __FILE__, __LINE__);                      
+                    } elseif(preg_match('~^' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $token)) {
+                        // object or variable
+                        $token = $this-&gt;_parse_var_props($token);
+                    } elseif(is_numeric($token)) {
+                        // number, skip it
+                    } else {
+                        $this-&gt;_syntax_error(&quot;unidentified token '$token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                    }
+                    break;
+            }
+        }
+
+        if ($elseif)
+            return '&lt;?php elseif ('.implode(' ', $tokens).'): ?&gt;';
+        else
+            return '&lt;?php if ('.implode(' ', $tokens).'): ?&gt;';
+    }
+
+
+    function _compile_arg_list($type, $name, $attrs, &amp;$cache_code) {
+        $arg_list = array();
+
+        if (isset($type) &amp;&amp; isset($name)
+            &amp;&amp; isset($this-&gt;_plugins[$type])
+            &amp;&amp; isset($this-&gt;_plugins[$type][$name])
+            &amp;&amp; empty($this-&gt;_plugins[$type][$name][4])
+            &amp;&amp; is_array($this-&gt;_plugins[$type][$name][5])
+            ) {
+            /* we have a list of parameters that should be cached */
+            $_cache_attrs = $this-&gt;_plugins[$type][$name][5];
+            $_count = $this-&gt;_cache_attrs_count++;
+            $cache_code = &quot;\$_cache_attrs =&amp; \$this-&gt;_smarty_cache_attrs('$this-&gt;_cache_serial','$_count');&quot;;
+
+        } else {
+            /* no parameters are cached */
+            $_cache_attrs = null;
+        }
+
+        foreach ($attrs as $arg_name =&gt; $arg_value) {
+            if (is_bool($arg_value))
+                $arg_value = $arg_value ? 'true' : 'false';
+            if (is_null($arg_value))
+                $arg_value = 'null';
+            if ($_cache_attrs &amp;&amp; in_array($arg_name, $_cache_attrs)) {
+                $arg_list[] = &quot;'$arg_name' =&gt; (\$this-&gt;_cache_including) ? \$_cache_attrs['$arg_name'] : (\$_cache_attrs['$arg_name']=$arg_value)&quot;;
+            } else {
+                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
+            }
+        }
+        return $arg_list;
+    }
+
+    /**
+     * Parse is expression
+     *
+     * @param string $is_arg
+     * @param array $tokens
+     * @return array
+     */
+    function _parse_is_expr($is_arg, $tokens)
+    {
+        $expr_end = 0;
+        $negate_expr = false;
+
+        if (($first_token = array_shift($tokens)) == 'not') {
+            $negate_expr = true;
+            $expr_type = array_shift($tokens);
+        } else
+            $expr_type = $first_token;
+
+        switch ($expr_type) {
+            case 'even':
+                if (isset($tokens[$expr_end]) &amp;&amp; $tokens[$expr_end] == 'by') {
+                    $expr_end++;
+                    $expr_arg = $tokens[$expr_end++];
+                    $expr = &quot;!(1 &amp; ($is_arg / &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;))&quot;;
+                } else
+                    $expr = &quot;!(1 &amp; $is_arg)&quot;;
+                break;
+
+            case 'odd':
+                if (isset($tokens[$expr_end]) &amp;&amp; $tokens[$expr_end] == 'by') {
+                    $expr_end++;
+                    $expr_arg = $tokens[$expr_end++];
+                    $expr = &quot;(1 &amp; ($is_arg / &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;))&quot;;
+                } else
+                    $expr = &quot;(1 &amp; $is_arg)&quot;;
+                break;
+
+            case 'div':
+                if (@$tokens[$expr_end] == 'by') {
+                    $expr_end++;
+                    $expr_arg = $tokens[$expr_end++];
+                    $expr = &quot;!($is_arg % &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;)&quot;;
+                } else {
+                    $this-&gt;_syntax_error(&quot;expecting 'by' after 'div'&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                }
+                break;
+
+            default:
+                $this-&gt;_syntax_error(&quot;unknown 'is' expression - '$expr_type'&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                break;
+        }
+
+        if ($negate_expr) {
+            $expr = &quot;!($expr)&quot;;
+        }
+
+        array_splice($tokens, 0, $expr_end, $expr);
+
+        return $tokens;
+    }
+
+
+    /**
+     * Parse attribute string
+     *
+     * @param string $tag_args
+     * @return array
+     */
+    function _parse_attrs($tag_args)
+    {
+
+        /* Tokenize tag attributes. */
+        preg_match_all('~(?:' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_qstr_regexp . ' | (?&gt;[^&quot;\'=\s]+)
+                         )+ |
+                         [=]
+                        ~x', $tag_args, $match);
+        $tokens       = $match[0];
+
+        $attrs = array();
+        /* Parse state:
+            0 - expecting attribute name
+            1 - expecting '='
+            2 - expecting attribute value (not '=') */
+        $state = 0;
+
+        foreach ($tokens as $token) {
+            switch ($state) {
+                case 0:
+                    /* If the token is a valid identifier, we set attribute name
+                       and go to state 1. */
+                    if (preg_match('~^\w+$~', $token)) {
+                        $attr_name = $token;
+                        $state = 1;
+                    } else
+                        $this-&gt;_syntax_error(&quot;invalid attribute name: '$token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                    break;
+
+                case 1:
+                    /* If the token is '=', then we go to state 2. */
+                    if ($token == '=') {
+                        $state = 2;
+                    } else
+                        $this-&gt;_syntax_error(&quot;expecting '=' after attribute name '$last_token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                    break;
+
+                case 2:
+                    /* If token is not '=', we set the attribute value and go to
+                       state 0. */
+                    if ($token != '=') {
+                        /* We booleanize the token if it's a non-quoted possible
+                           boolean value. */
+                        if (preg_match('~^(on|yes|true)$~', $token)) {
+                            $token = 'true';
+                        } else if (preg_match('~^(off|no|false)$~', $token)) {
+                            $token = 'false';
+                        } else if ($token == 'null') {
+                            $token = 'null';
+                        } else if (preg_match('~^' . $this-&gt;_num_const_regexp . '|0[xX][0-9a-fA-F]+$~', $token)) {
+                            /* treat integer literally */
+                        } else if (!preg_match('~^' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . ')*$~', $token)) {
+                            /* treat as a string, double-quote it escaping quotes */
+                            $token = '&quot;'.addslashes($token).'&quot;';
+                        }
+
+                        $attrs[$attr_name] = $token;
+                        $state = 0;
+                    } else
+                        $this-&gt;_syntax_error(&quot;'=' cannot be an attribute value&quot;, E_USER_ERROR, __FILE__, __LINE__);
+                    break;
+            }
+            $last_token = $token;
+        }
+
+        if($state != 0) {
+            if($state == 1) {
+                $this-&gt;_syntax_error(&quot;expecting '=' after attribute name '$last_token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
+            } else {
+                $this-&gt;_syntax_error(&quot;missing attribute value&quot;, E_USER_ERROR, __FILE__, __LINE__);
+            }
+        }
+
+        $this-&gt;_parse_vars_props($attrs);
+
+        return $attrs;
+    }
+
+    /**
+     * compile multiple variables and section properties tokens into
+     * PHP code
+     *
+     * @param array $tokens
+     */
+    function _parse_vars_props(&amp;$tokens)
+    {
+        foreach($tokens as $key =&gt; $val) {
+            $tokens[$key] = $this-&gt;_parse_var_props($val);
+        }
+    }
+
+    /**
+     * compile single variable and section properties token into
+     * PHP code
+     *
+     * @param string $val
+     * @param string $tag_attrs
+     * @return string
+     */
+    function _parse_var_props($val)
+    {
+        $val = trim($val);
+
+        if(preg_match('~^(' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_dvar_regexp . ')(' . $this-&gt;_mod_regexp . '*)$~', $val, $match)) {
+            // $ variable or object
+            $return = $this-&gt;_parse_var($match[1]);
+            $modifiers = $match[2];
+            if (!empty($this-&gt;default_modifiers) &amp;&amp; !preg_match('~(^|\|)smarty:nodefaults($|\|)~',$modifiers)) {
+                $_default_mod_string = implode('|',(array)$this-&gt;default_modifiers);
+                $modifiers = empty($modifiers) ? $_default_mod_string : $_default_mod_string . '|' . $modifiers;
+            }
+            $this-&gt;_parse_modifiers($return, $modifiers);
+            return $return;
+        } elseif (preg_match('~^' . $this-&gt;_db_qstr_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
+                // double quoted text
+                preg_match('~^(' . $this-&gt;_db_qstr_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
+                $return = $this-&gt;_expand_quoted_text($match[1]);
+                if($match[2] != '') {
+                    $this-&gt;_parse_modifiers($return, $match[2]);
+                }
+                return $return;
+            }
+        elseif(preg_match('~^' . $this-&gt;_num_const_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
+                // numerical constant
+                preg_match('~^(' . $this-&gt;_num_const_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
+                if($match[2] != '') {
+                    $this-&gt;_parse_modifiers($match[1], $match[2]);
+                    return $match[1];
+                }
+            }
+        elseif(preg_match('~^' . $this-&gt;_si_qstr_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
+                // single quoted text
+                preg_match('~^(' . $this-&gt;_si_qstr_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
+                if($match[2] != '') {
+                    $this-&gt;_parse_modifiers($match[1], $match[2]);
+                    return $match[1];
+                }
+            }
+        elseif(preg_match('~^' . $this-&gt;_cvar_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
+                // config var
+                return $this-&gt;_parse_conf_var($val);
+            }
+        elseif(preg_match('~^' . $this-&gt;_svar_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
+                // section var
+                return $this-&gt;_parse_section_prop($val);
+            }
+        elseif(!in_array($val, $this-&gt;_permitted_tokens) &amp;&amp; !is_numeric($val)) {
+            // literal string
+            return $this-&gt;_expand_quoted_text('&quot;' . strtr($val, array('\\' =&gt; '\\\\', '&quot;' =&gt; '\\&quot;')) .'&quot;');
+        }
+        return $val;
+    }
+
+    /**
+     * expand quoted text with embedded variables
+     *
+     * @param string $var_expr
+     * @return string
+     */
+    function _expand_quoted_text($var_expr)
+    {
+        // if contains unescaped $, expand it
+        if(preg_match_all('~(?:\`(?&lt;!\\\\)\$' . $this-&gt;_dvar_guts_regexp . '(?:' . $this-&gt;_obj_ext_regexp . ')*\`)|(?:(?&lt;!\\\\)\$\w+(\[[a-zA-Z0-9]+\])*)~', $var_expr, $_match)) {
+            $_match = $_match[0];
+            rsort($_match);
+            reset($_match);
+            foreach($_match as $_var) {
+                $var_expr = str_replace ($_var, '&quot;.(' . $this-&gt;_parse_var(str_replace('`','',$_var)) . ').&quot;', $var_expr);
+            }
+            $_return = preg_replace('~\.&quot;&quot;|(?&lt;!\\\\)&quot;&quot;\.~', '', $var_expr);
+        } else {
+            $_return = $var_expr;
+        }
+        // replace double quoted literal string with single quotes
+        $_return = preg_replace('~^&quot;([\s\w]+)&quot;$~',&quot;'\\1'&quot;,$_return);
+        return $_return;
+    }
+
+    /**
+     * parse variable expression into PHP code
+     *
+     * @param string $var_expr
+     * @param string $output
+     * @return string
+     */
+    function _parse_var($var_expr)
+    {
+        $_has_math = false;
+        $_math_vars = preg_split('~('.$this-&gt;_dvar_math_regexp.'|'.$this-&gt;_qstr_regexp.')~', $var_expr, -1, PREG_SPLIT_DELIM_CAPTURE);
+
+        if(count($_math_vars) &gt; 1) {
+            $_first_var = &quot;&quot;;
+            $_complete_var = &quot;&quot;;
+            $_output = &quot;&quot;;
+            // simple check if there is any math, to stop recursion (due to modifiers with &quot;xx % yy&quot; as parameter)
+            foreach($_math_vars as $_k =&gt; $_math_var) {
+                $_math_var = $_math_vars[$_k];
+
+                if(!empty($_math_var) || is_numeric($_math_var)) {
+                    // hit a math operator, so process the stuff which came before it
+                    if(preg_match('~^' . $this-&gt;_dvar_math_regexp . '$~', $_math_var)) {
+                        $_has_math = true;
+                        if(!empty($_complete_var) || is_numeric($_complete_var)) {
+                            $_output .= $this-&gt;_parse_var($_complete_var);
+                        }
+
+                        // just output the math operator to php
+                        $_output .= $_math_var;
+
+                        if(empty($_first_var))
+                            $_first_var = $_complete_var;
+
+                        $_complete_var = &quot;&quot;;
+                    } else {
+                        $_complete_var .= $_math_var;
+                    }
+                }
+            }
+            if($_has_math) {
+                if(!empty($_complete_var) || is_numeric($_complete_var))
+                    $_output .= $this-&gt;_parse_var($_complete_var);
+
+                // get the modifiers working (only the last var from math + modifier is left)
+                $var_expr = $_complete_var;
+            }
+        }
+
+        // prevent cutting of first digit in the number (we _definitly_ got a number if the first char is a digit)
+        if(is_numeric($var_expr{0}))
+            $_var_ref = $var_expr;
+        else
+            $_var_ref = substr($var_expr, 1);
+        
+        if(!$_has_math) {
+            
+            // get [foo] and .foo and -&gt;foo and (...) pieces
+            preg_match_all('~(?:^\w+)|' . $this-&gt;_obj_params_regexp . '|(?:' . $this-&gt;_var_bracket_regexp . ')|-&gt;\$?\w+|\.\$?\w+|\S+~', $_var_ref, $match);
+                        
+            $_indexes = $match[0];
+            $_var_name = array_shift($_indexes);
+
+            /* Handle $smarty.* variable references as a special case. */
+            if ($_var_name == 'smarty') {
+                /*
+                 * If the reference could be compiled, use the compiled output;
+                 * otherwise, fall back on the $smarty variable generated at
+                 * run-time.
+                 */
+                if (($smarty_ref = $this-&gt;_compile_smarty_ref($_indexes)) !== null) {
+                    $_output = $smarty_ref;
+                } else {
+                    $_var_name = substr(array_shift($_indexes), 1);
+                    $_output = &quot;\$this-&gt;_smarty_vars['$_var_name']&quot;;
+                }
+            } elseif(is_numeric($_var_name) &amp;&amp; is_numeric($var_expr{0})) {
+                // because . is the operator for accessing arrays thru inidizes we need to put it together again for floating point numbers
+                if(count($_indexes) &gt; 0)
+                {
+                    $_var_name .= implode(&quot;&quot;, $_indexes);
+                    $_indexes = array();
+                }
+                $_output = $_var_name;
+            } else {
+                $_output = &quot;\$this-&gt;_tpl_vars['$_var_name']&quot;;
+            }
+
+            foreach ($_indexes as $_index) {
+                if ($_index{0} == '[') {
+                    $_index = substr($_index, 1, -1);
+                    if (is_numeric($_index)) {
+                        $_output .= &quot;[$_index]&quot;;
+                    } elseif ($_index{0} == '$') {
+                        if (strpos($_index, '.') !== false) {
+                            $_output .= '[' . $this-&gt;_parse_var($_index) . ']';
+                        } else {
+                            $_output .= &quot;[\$this-&gt;_tpl_vars['&quot; . substr($_index, 1) . &quot;']]&quot;;
+                        }
+                    } else {
+                        $_var_parts = explode('.', $_index);
+                        $_var_section = $_var_parts[0];
+                        $_var_section_prop = isset($_var_parts[1]) ? $_var_parts[1] : 'index';
+                        $_output .= &quot;[\$this-&gt;_sections['$_var_section']['$_var_section_prop']]&quot;;
+                    }
+                } else if ($_index{0} == '.') {
+                    if ($_index{1} == '$')
+                        $_output .= &quot;[\$this-&gt;_tpl_vars['&quot; . substr($_index, 2) . &quot;']]&quot;;
+                    else
+                        $_output .= &quot;['&quot; . substr($_index, 1) . &quot;']&quot;;
+                } else if (substr($_index,0,2) == '-&gt;') {
+                    if(substr($_index,2,2) == '__') {
+                        $this-&gt;_syntax_error('call to internal object members is not allowed', E_USER_ERROR, __FILE__, __LINE__);
+                    } elseif($this-&gt;security &amp;&amp; substr($_index, 2, 1) == '_') {
+                        $this-&gt;_syntax_error('(secure) call to private object member is not allowed', E_USER_ERROR, __FILE__, __LINE__);
+                    } elseif ($_index{2} == '$') {
+                        if ($this-&gt;security) {
+                            $this-&gt;_syntax_error('(secure) call to dynamic object member is not allowed', E_USER_ERROR, __FILE__, __LINE__);
+                        } else {
+                            $_output .= '-&gt;{(($_var=$this-&gt;_tpl_vars[\''.substr($_index,3).'\']) &amp;&amp; substr($_var,0,2)!=\'__\') ? $_var : $this-&gt;trigger_error(&quot;cannot access property \\&quot;$_var\\&quot;&quot;)}';
+                        }
+                    } else {
+                        $_output .= $_index;
+                    }
+                } elseif ($_index{0} == '(') {
+                    $_index = $this-&gt;_parse_parenth_args($_index);
+                    $_output .= $_index;
+                } else {
+                    $_output .= $_index;
+                }
+            }
+        }
+
+        return $_output;
+    }
+
+    /**
+     * parse arguments in function call parenthesis
+     *
+     * @param string $parenth_args
+     * @return string
+     */
+    function _parse_parenth_args($parenth_args)
+    {
+        preg_match_all('~' . $this-&gt;_param_regexp . '~',$parenth_args, $match);
+        $orig_vals = $match = $match[0];
+        $this-&gt;_parse_vars_props($match);
+        $replace = array();
+        for ($i = 0, $count = count($match); $i &lt; $count; $i++) {
+            $replace[$orig_vals[$i]] = $match[$i];
+        }
+        return strtr($parenth_args, $replace);
+    }
+
+    /**
+     * parse configuration variable expression into PHP code
+     *
+     * @param string $conf_var_expr
+     */
+    function _parse_conf_var($conf_var_expr)
+    {
+        $parts = explode('|', $conf_var_expr, 2);
+        $var_ref = $parts[0];
+        $modifiers = isset($parts[1]) ? $parts[1] : '';
+
+        $var_name = substr($var_ref, 1, -1);
+
+        $output = &quot;\$this-&gt;_config[0]['vars']['$var_name']&quot;;
+
+        $this-&gt;_parse_modifiers($output, $modifiers);
+
+        return $output;
+    }
+
+    /**
+     * parse section property expression into PHP code
+     *
+     * @param string $section_prop_expr
+     * @return string
+     */
+    function _parse_section_prop($section_prop_expr)
+    {
+        $parts = explode('|', $section_prop_expr, 2);
+        $var_ref = $parts[0];
+        $modifiers = isset($parts[1]) ? $parts[1] : '';
+
+        preg_match('!%(\w+)\.(\w+)%!', $var_ref, $match);
+        $section_name = $match[1];
+        $prop_name = $match[2];
+
+        $output = &quot;\$this-&gt;_sections['$section_name']['$prop_name']&quot;;
+
+        $this-&gt;_parse_modifiers($output, $modifiers);
+
+        return $output;
+    }
+
+
+    /**
+     * parse modifier chain into PHP code
+     *
+     * sets $output to parsed modified chain
+     * @param string $output
+     * @param string $modifier_string
+     */
+    function _parse_modifiers(&amp;$output, $modifier_string)
+    {
+        preg_match_all('~\|(@?\w+)((?&gt;:(?:'. $this-&gt;_qstr_regexp . '|[^|]+))*)~', '|' . $modifier_string, $_match);
+        list(, $_modifiers, $modifier_arg_strings) = $_match;
+
+        for ($_i = 0, $_for_max = count($_modifiers); $_i &lt; $_for_max; $_i++) {
+            $_modifier_name = $_modifiers[$_i];
+
+            if($_modifier_name == 'smarty') {
+                // skip smarty modifier
+                continue;
+            }
+
+            preg_match_all('~:(' . $this-&gt;_qstr_regexp . '|[^:]+)~', $modifier_arg_strings[$_i], $_match);
+            $_modifier_args = $_match[1];
+
+            if ($_modifier_name{0} == '@') {
+                $_map_array = false;
+                $_modifier_name = substr($_modifier_name, 1);
+            } else {
+                $_map_array = true;
+            }
+
+            if (empty($this-&gt;_plugins['modifier'][$_modifier_name])
+                &amp;&amp; !$this-&gt;_get_plugin_filepath('modifier', $_modifier_name)
+                &amp;&amp; function_exists($_modifier_name)) {
+                if ($this-&gt;security &amp;&amp; !in_array($_modifier_name, $this-&gt;security_settings['MODIFIER_FUNCS'])) {
+                    $this-&gt;_trigger_fatal_error(&quot;[plugin] (secure mode) modifier '$_modifier_name' is not allowed&quot; , $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
+                } else {
+                    $this-&gt;_plugins['modifier'][$_modifier_name] = array($_modifier_name,  null, null, false);
+                }
+            }
+            $this-&gt;_add_plugin('modifier', $_modifier_name);
+
+            $this-&gt;_parse_vars_props($_modifier_args);
+
+            if($_modifier_name == 'default') {
+                // supress notifications of default modifier vars and args
+                if($output{0} == '$') {
+                    $output = '@' . $output;
+                }
+                if(isset($_modifier_args[0]) &amp;&amp; $_modifier_args[0]{0} == '$') {
+                    $_modifier_args[0] = '@' . $_modifier_args[0];
+                }
+            }
+            if (count($_modifier_args) &gt; 0)
+                $_modifier_args = ', '.implode(', ', $_modifier_args);
+            else
+                $_modifier_args = '';
+
+            if ($_map_array) {
+                $output = &quot;((is_array(\$_tmp=$output)) ? \$this-&gt;_run_mod_handler('$_modifier_name', true, \$_tmp$_modifier_args) : &quot; . $this-&gt;_compile_plugin_call('modifier', $_modifier_name) . &quot;(\$_tmp$_modifier_args))&quot;;
+
+            } else {
+
+                $output = $this-&gt;_compile_plugin_call('modifier', $_modifier_name).&quot;($output$_modifier_args)&quot;;
+
+            }
+        }
+    }
+
+
+    /**
+     * add plugin
+     *
+     * @param string $type
+     * @param string $name
+     * @param boolean? $delayed_loading
+     */
+    function _add_plugin($type, $name, $delayed_loading = null)
+    {
+        if (!isset($this-&gt;_plugin_info[$type])) {
+            $this-&gt;_plugin_info[$type] = array();
+        }
+        if (!isset($this-&gt;_plugin_info[$type][$name])) {
+            $this-&gt;_plugin_info[$type][$name] = array($this-&gt;_current_file,
+                                                      $this-&gt;_current_line_no,
+                                                      $delayed_loading);
+        }
+    }
+
+
+    /**
+     * Compiles references of type $smarty.foo
+     *
+     * @param string $indexes
+     * @return string
+     */
+    function _compile_smarty_ref(&amp;$indexes)
+    {
+        /* Extract the reference name. */
+        $_ref = substr($indexes[0], 1);
+        foreach($indexes as $_index_no=&gt;$_index) {
+            if ($_index{0} != '.' &amp;&amp; $_index_no&lt;2 || !preg_match('~^(\.|\[|-&gt;)~', $_index)) {
+                $this-&gt;_syntax_error('$smarty' . implode('', array_slice($indexes, 0, 2)) . ' is an invalid reference', E_USER_ERROR, __FILE__, __LINE__);
+            }
+        }
+
+        switch ($_ref) {
+            case 'now':
+                $compiled_ref = 'time()';
+                $_max_index = 1;
+                break;
+
+            case 'foreach':
+                array_shift($indexes);
+                $_var = $this-&gt;_parse_var_props(substr($indexes[0], 1));
+                $_propname = substr($indexes[1], 1);
+                $_max_index = 1;
+                switch ($_propname) {
+                    case 'index':
+                        array_shift($indexes);
+                        $compiled_ref = &quot;(\$this-&gt;_foreach[$_var]['iteration']-1)&quot;;
+                        break;
+                        
+                    case 'first':
+                        array_shift($indexes);
+                        $compiled_ref = &quot;(\$this-&gt;_foreach[$_var]['iteration'] &lt;= 1)&quot;;
+                        break;
+
+                    case 'last':
+                        array_shift($indexes);
+                        $compiled_ref = &quot;(\$this-&gt;_foreach[$_var]['iteration'] == \$this-&gt;_foreach[$_var]['total'])&quot;;
+                        break;
+                        
+                    case 'show':
+                        array_shift($indexes);
+                        $compiled_ref = &quot;(\$this-&gt;_foreach[$_var]['total'] &gt; 0)&quot;;
+                        break;
+                        
+                    default:
+                        unset($_max_index);
+                        $compiled_ref = &quot;\$this-&gt;_foreach[$_var]&quot;;
+                }
+                break;
+
+            case 'section':
+                array_shift($indexes);
+                $_var = $this-&gt;_parse_var_props(substr($indexes[0], 1));
+                $compiled_ref = &quot;\$this-&gt;_sections[$_var]&quot;;
+                break;
+
+            case 'get':
+                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_GET' : &quot;\$GLOBALS['HTTP_GET_VARS']&quot;;
+                break;
+
+            case 'post':
+                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_POST' : &quot;\$GLOBALS['HTTP_POST_VARS']&quot;;
+                break;
+
+            case 'cookies':
+                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_COOKIE' : &quot;\$GLOBALS['HTTP_COOKIE_VARS']&quot;;
+                break;
+
+            case 'env':
+                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_ENV' : &quot;\$GLOBALS['HTTP_ENV_VARS']&quot;;
+                break;
+
+            case 'server':
+                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_SERVER' : &quot;\$GLOBALS['HTTP_SERVER_VARS']&quot;;
+                break;
+
+            case 'session':
+                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_SESSION' : &quot;\$GLOBALS['HTTP_SESSION_VARS']&quot;;
+                break;
+
+            /*
+             * These cases are handled either at run-time or elsewhere in the
+             * compiler.
+             */
+            case 'request':
+                if ($this-&gt;request_use_auto_globals) {
+                    $compiled_ref = '$_REQUEST';
+                    break;
+                } else {
+                    $this-&gt;_init_smarty_vars = true;
+                }
+                return null;
+
+            case 'capture':
+                return null;
+
+            case 'template':
+                $compiled_ref = &quot;'$this-&gt;_current_file'&quot;;
+                $_max_index = 1;
+                break;
+
+            case 'version':
+                $compiled_ref = &quot;'$this-&gt;_version'&quot;;
+                $_max_index = 1;
+                break;
+
+            case 'const':
+                if ($this-&gt;security &amp;&amp; !$this-&gt;security_settings['ALLOW_CONSTANTS']) {
+                    $this-&gt;_syntax_error(&quot;(secure mode) constants not permitted&quot;,
+                                         E_USER_WARNING, __FILE__, __LINE__);
+                    return;
+                }
+                array_shift($indexes);
+                if (preg_match('!^\.\w+$!', $indexes[0])) {
+                    $compiled_ref = '@' . substr($indexes[0], 1);
+                } else {
+                    $_val = $this-&gt;_parse_var_props(substr($indexes[0], 1));
+                    $compiled_ref = '@constant(' . $_val . ')';
+                }
+                $_max_index = 1;
+                break;
+
+            case 'config':
+                $compiled_ref = &quot;\$this-&gt;_config[0]['vars']&quot;;
+                $_max_index = 3;
+                break;
+
+            case 'ldelim':
+                $compiled_ref = &quot;'$this-&gt;left_delimiter'&quot;;
+                break;
+
+            case 'rdelim':
+                $compiled_ref = &quot;'$this-&gt;right_delimiter'&quot;;
+                break;
+                
+            default:
+                $this-&gt;_syntax_error('$smarty.' . $_ref . ' is an unknown reference', E_USER_ERROR, __FILE__, __LINE__);
+                break;
+        }
+
+        if (isset($_max_index) &amp;&amp; count($indexes) &gt; $_max_index) {
+            $this-&gt;_syntax_error('$smarty' . implode('', $indexes) .' is an invalid reference', E_USER_ERROR, __FILE__, __LINE__);
+        }
+
+        array_shift($indexes);
+        return $compiled_ref;
+    }
+
+    /**
+     * compiles call to plugin of type $type with name $name
+     * returns a string containing the function-name or method call
+     * without the paramter-list that would have follow to make the
+     * call valid php-syntax
+     *
+     * @param string $type
+     * @param string $name
+     * @return string
+     */
+    function _compile_plugin_call($type, $name) {
+        if (isset($this-&gt;_plugins[$type][$name])) {
+            /* plugin loaded */
+            if (is_array($this-&gt;_plugins[$type][$name][0])) {
+                return ((is_object($this-&gt;_plugins[$type][$name][0][0])) ?
+                        &quot;\$this-&gt;_plugins['$type']['$name'][0][0]-&gt;&quot;    /* method callback */
+                        : (string)($this-&gt;_plugins[$type][$name][0][0]).'::'    /* class callback */
+                       ). $this-&gt;_plugins[$type][$name][0][1];
+
+            } else {
+                /* function callback */
+                return $this-&gt;_plugins[$type][$name][0];
+
+            }
+        } else {
+            /* plugin not loaded -&gt; auto-loadable-plugin */
+            return 'smarty_'.$type.'_'.$name;
+
+        }
+    }
+
+    /**
+     * load pre- and post-filters
+     */
+    function _load_filters()
+    {
+        if (count($this-&gt;_plugins['prefilter']) &gt; 0) {
+            foreach ($this-&gt;_plugins['prefilter'] as $filter_name =&gt; $prefilter) {
+                if ($prefilter === false) {
+                    unset($this-&gt;_plugins['prefilter'][$filter_name]);
+                    $_params = array('plugins' =&gt; array(array('prefilter', $filter_name, null, null, false)));
+                    require_once(SMARTY_CORE_DIR . 'core.load_plugins.php');
+                    smarty_core_load_plugins($_params, $this);
+                }
+            }
+        }
+        if (count($this-&gt;_plugins['postfilter']) &gt; 0) {
+            foreach ($this-&gt;_plugins['postfilter'] as $filter_name =&gt; $postfilter) {
+                if ($postfilter === false) {
+                    unset($this-&gt;_plugins['postfilter'][$filter_name]);
+                    $_params = array('plugins' =&gt; array(array('postfilter', $filter_name, null, null, false)));
+                    require_once(SMARTY_CORE_DIR . 'core.load_plugins.php');
+                    smarty_core_load_plugins($_params, $this);
+                }
+            }
+        }
+    }
+
+
+    /**
+     * Quote subpattern references
+     *
+     * @param string $string
+     * @return string
+     */
+    function _quote_replace($string)
+    {
+        return strtr($string, array('\\' =&gt; '\\\\', '$' =&gt; '\\$'));
+    }
+
+    /**
+     * display Smarty syntax error
+     *
+     * @param string $error_msg
+     * @param integer $error_type
+     * @param string $file
+     * @param integer $line
+     */
+    function _syntax_error($error_msg, $error_type = E_USER_ERROR, $file=null, $line=null)
+    {
+        $this-&gt;_trigger_fatal_error(&quot;syntax error: $error_msg&quot;, $this-&gt;_current_file, $this-&gt;_current_line_no, $file, $line, $error_type);
+    }
+
+
+    /**
+     * check if the compilation changes from cacheable to
+     * non-cacheable state with the beginning of the current
+     * plugin. return php-code to reflect the transition.
+     * @return string
+     */
+    function _push_cacheable_state($type, $name) {
+        $_cacheable = !isset($this-&gt;_plugins[$type][$name]) || $this-&gt;_plugins[$type][$name][4];
+        if ($_cacheable
+            || 0&lt;$this-&gt;_cacheable_state++) return '';
+        if (!isset($this-&gt;_cache_serial)) $this-&gt;_cache_serial = md5(uniqid('Smarty'));
+        $_ret = 'if ($this-&gt;caching &amp;&amp; !$this-&gt;_cache_including) { echo \'{nocache:'
+            . $this-&gt;_cache_serial . '#' . $this-&gt;_nocache_count
+            . '}\';}';
+        return $_ret;
+    }
+
+
+    /**
+     * check if the compilation changes from non-cacheable to
+     * cacheable state with the end of the current plugin return
+     * php-code to reflect the transition.
+     * @return string
+     */
+    function _pop_cacheable_state($type, $name) {
+        $_cacheable = !isset($this-&gt;_plugins[$type][$name]) || $this-&gt;_plugins[$type][$name][4];
+        if ($_cacheable
+            || --$this-&gt;_cacheable_state&gt;0) return '';
+        return 'if ($this-&gt;caching &amp;&amp; !$this-&gt;_cache_including) { echo \'{/nocache:'
+            . $this-&gt;_cache_serial . '#' . ($this-&gt;_nocache_count++)
+            . '}\';}';
+    }
+
+
+    /**
+     * push opening tag-name, file-name and line-number on the tag-stack
+     * @param string the opening tag's name
+     */
+    function _push_tag($open_tag)
+    {
+        array_push($this-&gt;_tag_stack, array($open_tag, $this-&gt;_current_line_no));
+    }
+
+    /**
+     * pop closing tag-name
+     * raise an error if this stack-top doesn't match with the closing tag
+     * @param string the closing tag's name
+     * @return string the opening tag's name
+     */
+    function _pop_tag($close_tag)
+    {
+        $message = '';
+        if (count($this-&gt;_tag_stack)&gt;0) {
+            list($_open_tag, $_line_no) = array_pop($this-&gt;_tag_stack);
+            if ($close_tag == $_open_tag) {
+                return $_open_tag;
+            }
+            if ($close_tag == 'if' &amp;&amp; ($_open_tag == 'else' || $_open_tag == 'elseif' )) {
+                return $this-&gt;_pop_tag($close_tag);
+            }
+            if ($close_tag == 'section' &amp;&amp; $_open_tag == 'sectionelse') {
+                $this-&gt;_pop_tag($close_tag);
+                return $_open_tag;
+            }
+            if ($close_tag == 'foreach' &amp;&amp; $_open_tag == 'foreachelse') {
+                $this-&gt;_pop_tag($close_tag);
+                return $_open_tag;
+            }
+            if ($_open_tag == 'else' || $_open_tag == 'elseif') {
+                $_open_tag = 'if';
+            } elseif ($_open_tag == 'sectionelse') {
+                $_open_tag = 'section';
+            } elseif ($_open_tag == 'foreachelse') {
+                $_open_tag = 'foreach';
+            }
+            $message = &quot; expected {/$_open_tag} (opened line $_line_no).&quot;;
+        }
+        $this-&gt;_syntax_error(&quot;mismatched tag {/$close_tag}.$message&quot;,
+                             E_USER_ERROR, __FILE__, __LINE__);
+    }
+
+}
+
+/**
+ * compare to values by their string length
+ *
+ * @access private
+ * @param string $a
+ * @param string $b
+ * @return 0|-1|1
+ */
+function _smarty_sort_length($a, $b)
+{
+    if($a == $b)
+        return 0;
+
+    if(strlen($a) == strlen($b))
+        return ($a &gt; $b) ? -1 : 1;
+
+    return (strlen($a) &gt; strlen($b)) ? -1 : 1;
+}
+
+
+/* vim: set et: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/debug.tpl
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/debug.tpl	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/debug.tpl	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,64 +1,64 @@
-{* Smarty *}
-
-{* debug.tpl, last updated version 2.0.1 *}
-
-{assign_debug_info}
-
-{if isset($_smarty_debug_output) and $_smarty_debug_output eq &quot;html&quot;}
-	&lt;table border=0 width=100%&gt;
-	&lt;tr bgcolor=#cccccc&gt;&lt;th colspan=2&gt;Smarty Debug Console&lt;/th&gt;&lt;/tr&gt;
-	&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;included templates &amp; config files (load time in seconds):&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;
-	{section name=templates loop=$_debug_tpls}
-		&lt;tr bgcolor={if %templates.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td colspan=2&gt;&lt;tt&gt;{section name=indent loop=$_debug_tpls[templates].depth}&nbsp;&nbsp;&nbsp;{/section}&lt;font color={if $_debug_tpls[templates].type eq &quot;template&quot;}brown{elseif $_debug_tpls[templates].type eq &quot;insert&quot;}black{else}green{/if}&gt;{$_debug_tpls[templates].filename|escape:html}&lt;/font&gt;{if isset($_debug_tpls[templates].exec_time)} &lt;font size=-1&gt;&lt;i&gt;({$_debug_tpls[templates].exec_time|string_format:&quot;%.5f&quot;}){if %templates.index% eq 0} (total){/if}&lt;/i&gt;&lt;/font&gt;{/if}&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
-	{sectionelse}
-		&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no templates included&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;	
-	{/section}
-	&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;assigned template variables:&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;
-	{section name=vars loop=$_debug_keys}
-		&lt;tr bgcolor={if %vars.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td valign=top&gt;&lt;tt&gt;&lt;font color=blue&gt;{ldelim}${$_debug_keys[vars]}{rdelim}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;td nowrap&gt;&lt;tt&gt;&lt;font color=green&gt;{$_debug_vals[vars]|@debug_print_var}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
-	{sectionelse}
-		&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no template variables assigned&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;	
-	{/section}
-	&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;assigned config file variables (outer template scope):&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;
-	{section name=config_vars loop=$_debug_config_keys}
-		&lt;tr bgcolor={if %config_vars.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td valign=top&gt;&lt;tt&gt;&lt;font color=maroon&gt;{ldelim}#{$_debug_config_keys[config_vars]}#{rdelim}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;&lt;tt&gt;&lt;font color=green&gt;{$_debug_config_vals[config_vars]|@debug_print_var}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
-	{sectionelse}
-		&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no config vars assigned&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;	
-	{/section}
-	&lt;/table&gt;
-&lt;/BODY&gt;&lt;/HTML&gt;
-{else}
-&lt;SCRIPT language=javascript&gt;
-	if( self.name == '' ) {ldelim}
-	   var title = 'Console';
-	{rdelim}
-	else {ldelim}
-	   var title = 'Console_' + self.name;
-	{rdelim}
-	_smarty_console = window.open(&quot;&quot;,title.value,&quot;width=680,height=600,resizable,scrollbars=yes&quot;);
-	_smarty_console.document.write(&quot;&lt;HTML&gt;&lt;TITLE&gt;Smarty Debug Console_&quot;+self.name+&quot;&lt;/TITLE&gt;&lt;BODY bgcolor=#ffffff&gt;&quot;);
-	_smarty_console.document.write(&quot;&lt;table border=0 width=100%&gt;&quot;);
-	_smarty_console.document.write(&quot;&lt;tr bgcolor=#cccccc&gt;&lt;th colspan=2&gt;Smarty Debug Console&lt;/th&gt;&lt;/tr&gt;&quot;);
-	_smarty_console.document.write(&quot;&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;included templates &amp; config files (load time in seconds):&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
-	{section name=templates loop=$_debug_tpls}
-		_smarty_console.document.write(&quot;&lt;tr bgcolor={if %templates.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td colspan=2&gt;&lt;tt&gt;{section name=indent loop=$_debug_tpls[templates].depth}&nbsp;&nbsp;&nbsp;{/section}&lt;font color={if $_debug_tpls[templates].type eq &quot;template&quot;}brown{elseif $_debug_tpls[templates].type eq &quot;insert&quot;}black{else}green{/if}&gt;{$_debug_tpls[templates].filename|escape:html|escape:javascript}&lt;/font&gt;{if isset($_debug_tpls[templates].exec_time)} &lt;font size=-1&gt;&lt;i&gt;({$_debug_tpls[templates].exec_time|string_format:&quot;%.5f&quot;}){if %templates.index% eq 0} (total){/if}&lt;/i&gt;&lt;/font&gt;{/if}&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
-	{sectionelse}
-		_smarty_console.document.write(&quot;&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no templates included&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);	
-	{/section}
-	_smarty_console.document.write(&quot;&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;assigned template variables:&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
-	{section name=vars loop=$_debug_keys}
-		_smarty_console.document.write(&quot;&lt;tr bgcolor={if %vars.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td valign=top&gt;&lt;tt&gt;&lt;font color=blue&gt;{ldelim}${$_debug_keys[vars]}{rdelim}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;td nowrap&gt;&lt;tt&gt;&lt;font color=green&gt;{$_debug_vals[vars]|@debug_print_var|escape:javascript}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
-	{sectionelse}
-		_smarty_console.document.write(&quot;&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no template variables assigned&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);	
-	{/section}
-	_smarty_console.document.write(&quot;&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;assigned config file variables (outer template scope):&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
-	{section name=config_vars loop=$_debug_config_keys}
-		_smarty_console.document.write(&quot;&lt;tr bgcolor={if %config_vars.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td valign=top&gt;&lt;tt&gt;&lt;font color=maroon&gt;{ldelim}#{$_debug_config_keys[config_vars]}#{rdelim}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;&lt;tt&gt;&lt;font color=green&gt;{$_debug_config_vals[config_vars]|@debug_print_var|escape:javascript}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
-	{sectionelse}
-		_smarty_console.document.write(&quot;&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no config vars assigned&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);	
-	{/section}
-	_smarty_console.document.write(&quot;&lt;/table&gt;&quot;);
-	_smarty_console.document.write(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);
-	_smarty_console.document.close();
-&lt;/SCRIPT&gt;
-{/if}
+{* Smarty *}
+
+{* debug.tpl, last updated version 2.0.1 *}
+
+{assign_debug_info}
+
+{if isset($_smarty_debug_output) and $_smarty_debug_output eq &quot;html&quot;}
+	&lt;table border=0 width=100%&gt;
+	&lt;tr bgcolor=#cccccc&gt;&lt;th colspan=2&gt;Smarty Debug Console&lt;/th&gt;&lt;/tr&gt;
+	&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;included templates &amp; config files (load time in seconds):&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;
+	{section name=templates loop=$_debug_tpls}
+		&lt;tr bgcolor={if %templates.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td colspan=2&gt;&lt;tt&gt;{section name=indent loop=$_debug_tpls[templates].depth}&nbsp;&nbsp;&nbsp;{/section}&lt;font color={if $_debug_tpls[templates].type eq &quot;template&quot;}brown{elseif $_debug_tpls[templates].type eq &quot;insert&quot;}black{else}green{/if}&gt;{$_debug_tpls[templates].filename|escape:html}&lt;/font&gt;{if isset($_debug_tpls[templates].exec_time)} &lt;font size=-1&gt;&lt;i&gt;({$_debug_tpls[templates].exec_time|string_format:&quot;%.5f&quot;}){if %templates.index% eq 0} (total){/if}&lt;/i&gt;&lt;/font&gt;{/if}&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
+	{sectionelse}
+		&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no templates included&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;	
+	{/section}
+	&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;assigned template variables:&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;
+	{section name=vars loop=$_debug_keys}
+		&lt;tr bgcolor={if %vars.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td valign=top&gt;&lt;tt&gt;&lt;font color=blue&gt;{ldelim}${$_debug_keys[vars]}{rdelim}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;td nowrap&gt;&lt;tt&gt;&lt;font color=green&gt;{$_debug_vals[vars]|@debug_print_var}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
+	{sectionelse}
+		&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no template variables assigned&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;	
+	{/section}
+	&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;assigned config file variables (outer template scope):&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;
+	{section name=config_vars loop=$_debug_config_keys}
+		&lt;tr bgcolor={if %config_vars.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td valign=top&gt;&lt;tt&gt;&lt;font color=maroon&gt;{ldelim}#{$_debug_config_keys[config_vars]}#{rdelim}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;&lt;tt&gt;&lt;font color=green&gt;{$_debug_config_vals[config_vars]|@debug_print_var}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;
+	{sectionelse}
+		&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no config vars assigned&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;	
+	{/section}
+	&lt;/table&gt;
+&lt;/BODY&gt;&lt;/HTML&gt;
+{else}
+&lt;SCRIPT language=javascript&gt;
+	if( self.name == '' ) {ldelim}
+	   var title = 'Console';
+	{rdelim}
+	else {ldelim}
+	   var title = 'Console_' + self.name;
+	{rdelim}
+	_smarty_console = window.open(&quot;&quot;,title.value,&quot;width=680,height=600,resizable,scrollbars=yes&quot;);
+	_smarty_console.document.write(&quot;&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Smarty Debug Console_&quot;+self.name+&quot;&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY bgcolor=#ffffff&gt;&quot;);
+	_smarty_console.document.write(&quot;&lt;table border=0 width=100%&gt;&quot;);
+	_smarty_console.document.write(&quot;&lt;tr bgcolor=#cccccc&gt;&lt;th colspan=2&gt;Smarty Debug Console&lt;/th&gt;&lt;/tr&gt;&quot;);
+	_smarty_console.document.write(&quot;&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;included templates &amp; config files (load time in seconds):&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
+	{section name=templates loop=$_debug_tpls}
+		_smarty_console.document.write(&quot;&lt;tr bgcolor={if %templates.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td colspan=2&gt;&lt;tt&gt;{section name=indent loop=$_debug_tpls[templates].depth}&nbsp;&nbsp;&nbsp;{/section}&lt;font color={if $_debug_tpls[templates].type eq &quot;template&quot;}brown{elseif $_debug_tpls[templates].type eq &quot;insert&quot;}black{else}green{/if}&gt;{$_debug_tpls[templates].filename|escape:html|escape:javascript}&lt;/font&gt;{if isset($_debug_tpls[templates].exec_time)} &lt;font size=-1&gt;&lt;i&gt;({$_debug_tpls[templates].exec_time|string_format:&quot;%.5f&quot;}){if %templates.index% eq 0} (total){/if}&lt;/i&gt;&lt;/font&gt;{/if}&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
+	{sectionelse}
+		_smarty_console.document.write(&quot;&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no templates included&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);	
+	{/section}
+	_smarty_console.document.write(&quot;&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;assigned template variables:&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
+	{section name=vars loop=$_debug_keys}
+		_smarty_console.document.write(&quot;&lt;tr bgcolor={if %vars.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td valign=top&gt;&lt;tt&gt;&lt;font color=blue&gt;{ldelim}${$_debug_keys[vars]}{rdelim}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;td nowrap&gt;&lt;tt&gt;&lt;font color=green&gt;{$_debug_vals[vars]|@debug_print_var|escape:javascript}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
+	{sectionelse}
+		_smarty_console.document.write(&quot;&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no template variables assigned&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);	
+	{/section}
+	_smarty_console.document.write(&quot;&lt;tr bgcolor=#cccccc&gt;&lt;td colspan=2&gt;&lt;b&gt;assigned config file variables (outer template scope):&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
+	{section name=config_vars loop=$_debug_config_keys}
+		_smarty_console.document.write(&quot;&lt;tr bgcolor={if %config_vars.index% is even}#eeeeee{else}#fafafa{/if}&gt;&lt;td valign=top&gt;&lt;tt&gt;&lt;font color=maroon&gt;{ldelim}#{$_debug_config_keys[config_vars]}#{rdelim}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;td&gt;&lt;tt&gt;&lt;font color=green&gt;{$_debug_config_vals[config_vars]|@debug_print_var|escape:javascript}&lt;/font&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
+	{sectionelse}
+		_smarty_console.document.write(&quot;&lt;tr bgcolor=#eeeeee&gt;&lt;td colspan=2&gt;&lt;tt&gt;&lt;i&gt;no config vars assigned&lt;/i&gt;&lt;/tt&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);	
+	{/section}
+	_smarty_console.document.write(&quot;&lt;/table&gt;&quot;);
+	_smarty_console.document.write(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);
+	_smarty_console.document.close();
+&lt;/SCRIPT&gt;
+{/if}

Copied: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/internals (from rev 14, XoopsCore/tags/121199-upd3rdparty-1/htdocs/class/smarty/internals)

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/block.textformat.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/block.textformat.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/block.textformat.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,102 +1,102 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-/**
- * Smarty {textformat}{/textformat} block plugin
- *
- * Type:     block function&lt;br&gt;
- * Name:     textformat&lt;br&gt;
- * Purpose:  format text a certain way with preset styles
- *           or custom wrap/indent settings&lt;br&gt;
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.textformat.php">http://smarty.php.net/manual/en/language.function.textformat.php</A> {textformat}
- *       (Smarty online manual)
- * @param array
- * &lt;pre&gt;
- * Params:   style: string (email)
- *           indent: integer (0)
- *           wrap: integer (80)
- *           wrap_char string (&quot;\n&quot;)
- *           indent_char: string (&quot; &quot;)
- *           wrap_boundary: boolean (true)
- * &lt;/pre&gt;
- * @param string contents of the block
- * @param Smarty clever simulation of a method
- * @return string string $content re-formatted
- */
-function smarty_block_textformat($params, $content, &amp;$smarty)
-{
-    if (is_null($content)) {
-        return;
-    }
-
-    $style = null;
-    $indent = 0;
-    $indent_first = 0;
-    $indent_char = ' ';
-    $wrap = 80;
-    $wrap_char = &quot;\n&quot;;
-    $wrap_cut = false;
-    $assign = null;
-    
-    foreach ($params as $_key =&gt; $_val) {
-        switch ($_key) {
-            case 'style':
-            case 'indent_char':
-            case 'wrap_char':
-            case 'assign':
-                $$_key = (string)$_val;
-                break;
-
-            case 'indent':
-            case 'indent_first':
-            case 'wrap':
-                $$_key = (int)$_val;
-                break;
-
-            case 'wrap_cut':
-                $$_key = (bool)$_val;
-                break;
-
-            default:
-                $smarty-&gt;trigger_error(&quot;textformat: unknown attribute '$_key'&quot;);
-        }
-    }
-
-    if ($style == 'email') {
-        $wrap = 72;
-    }
-
-    // split into paragraphs
-    $_paragraphs = preg_split('![\r\n][\r\n]!',$content);
-    $_output = '';
-
-    for($_x = 0, $_y = count($_paragraphs); $_x &lt; $_y; $_x++) {
-        if ($_paragraphs[$_x] == '') {
-            continue;
-        }
-        // convert mult. spaces &amp; special chars to single space
-        $_paragraphs[$_x] = preg_replace(array('!\s+!','!(^\s+)|(\s+$)!'), array(' ',''), $_paragraphs[$_x]);
-        // indent first line
-        if($indent_first &gt; 0) {
-            $_paragraphs[$_x] = str_repeat($indent_char, $indent_first) . $_paragraphs[$_x];
-        }
-        // wordwrap sentences
-        $_paragraphs[$_x] = wordwrap($_paragraphs[$_x], $wrap - $indent, $wrap_char, $wrap_cut);
-        // indent lines
-        if($indent &gt; 0) {
-            $_paragraphs[$_x] = preg_replace('!^!m', str_repeat($indent_char, $indent), $_paragraphs[$_x]);
-        }
-    }
-    $_output = implode($wrap_char . $wrap_char, $_paragraphs);
-
-    return $assign ? $smarty-&gt;assign($assign, $_output) : $_output;
-
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+/**
+ * Smarty {textformat}{/textformat} block plugin
+ *
+ * Type:     block function&lt;br&gt;
+ * Name:     textformat&lt;br&gt;
+ * Purpose:  format text a certain way with preset styles
+ *           or custom wrap/indent settings&lt;br&gt;
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.textformat.php">http://smarty.php.net/manual/en/language.function.textformat.php</A> {textformat}
+ *       (Smarty online manual)
+ * @param array
+ * &lt;pre&gt;
+ * Params:   style: string (email)
+ *           indent: integer (0)
+ *           wrap: integer (80)
+ *           wrap_char string (&quot;\n&quot;)
+ *           indent_char: string (&quot; &quot;)
+ *           wrap_boundary: boolean (true)
+ * &lt;/pre&gt;
+ * @param string contents of the block
+ * @param Smarty clever simulation of a method
+ * @return string string $content re-formatted
+ */
+function smarty_block_textformat($params, $content, &amp;$smarty)
+{
+    if (is_null($content)) {
+        return;
+    }
+
+    $style = null;
+    $indent = 0;
+    $indent_first = 0;
+    $indent_char = ' ';
+    $wrap = 80;
+    $wrap_char = &quot;\n&quot;;
+    $wrap_cut = false;
+    $assign = null;
+    
+    foreach ($params as $_key =&gt; $_val) {
+        switch ($_key) {
+            case 'style':
+            case 'indent_char':
+            case 'wrap_char':
+            case 'assign':
+                $$_key = (string)$_val;
+                break;
+
+            case 'indent':
+            case 'indent_first':
+            case 'wrap':
+                $$_key = (int)$_val;
+                break;
+
+            case 'wrap_cut':
+                $$_key = (bool)$_val;
+                break;
+
+            default:
+                $smarty-&gt;trigger_error(&quot;textformat: unknown attribute '$_key'&quot;);
+        }
+    }
+
+    if ($style == 'email') {
+        $wrap = 72;
+    }
+
+    // split into paragraphs
+    $_paragraphs = preg_split('![\r\n][\r\n]!',$content);
+    $_output = '';
+
+    for($_x = 0, $_y = count($_paragraphs); $_x &lt; $_y; $_x++) {
+        if ($_paragraphs[$_x] == '') {
+            continue;
+        }
+        // convert mult. spaces &amp; special chars to single space
+        $_paragraphs[$_x] = preg_replace(array('!\s+!','!(^\s+)|(\s+$)!'), array(' ',''), $_paragraphs[$_x]);
+        // indent first line
+        if($indent_first &gt; 0) {
+            $_paragraphs[$_x] = str_repeat($indent_char, $indent_first) . $_paragraphs[$_x];
+        }
+        // wordwrap sentences
+        $_paragraphs[$_x] = wordwrap($_paragraphs[$_x], $wrap - $indent, $wrap_char, $wrap_cut);
+        // indent lines
+        if($indent &gt; 0) {
+            $_paragraphs[$_x] = preg_replace('!^!m', str_repeat($indent_char, $indent), $_paragraphs[$_x]);
+        }
+    }
+    $_output = implode($wrap_char . $wrap_char, $_paragraphs);
+
+    return $assign ? $smarty-&gt;assign($assign, $_output) : $_output;
+
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/compiler.assign.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/compiler.assign.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/compiler.assign.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,38 +1,38 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-/**
- * Smarty {assign} compiler function plugin
- *
- * Type:     compiler function&lt;br&gt;
- * Name:     assign&lt;br&gt;
- * Purpose:  assign a value to a template variable
- * @link <A HREF="http://smarty.php.net/manual/en/language.custom.functions.php#LANGUAGE.FUNCTION.ASSIGN">http://smarty.php.net/manual/en/language.custom.functions.php#LANGUAGE.FUNCTION.ASSIGN</A> {assign}
- *       (Smarty online manual)
- * @param string containing var-attribute and value-attribute
- * @param Smarty_Compiler
- */
-function smarty_compiler_assign($tag_attrs, &amp;$compiler)
-{
-    $_params = $compiler-&gt;_parse_attrs($tag_attrs);
-
-    if (!isset($_params['var'])) {
-        $compiler-&gt;_syntax_error(&quot;assign: missing 'var' parameter&quot;, E_USER_WARNING);
-        return;
-    }
-
-    if (!isset($_params['value'])) {
-        $compiler-&gt;_syntax_error(&quot;assign: missing 'value' parameter&quot;, E_USER_WARNING);
-        return;
-    }
-
-    return &quot;\$this-&gt;assign({$_params['var']}, {$_params['value']});&quot;;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+/**
+ * Smarty {assign} compiler function plugin
+ *
+ * Type:     compiler function&lt;br&gt;
+ * Name:     assign&lt;br&gt;
+ * Purpose:  assign a value to a template variable
+ * @link <A HREF="http://smarty.php.net/manual/en/language.custom.functions.php#LANGUAGE.FUNCTION.ASSIGN">http://smarty.php.net/manual/en/language.custom.functions.php#LANGUAGE.FUNCTION.ASSIGN</A> {assign}
+ *       (Smarty online manual)
+ * @param string containing var-attribute and value-attribute
+ * @param Smarty_Compiler
+ */
+function smarty_compiler_assign($tag_attrs, &amp;$compiler)
+{
+    $_params = $compiler-&gt;_parse_attrs($tag_attrs);
+
+    if (!isset($_params['var'])) {
+        $compiler-&gt;_syntax_error(&quot;assign: missing 'var' parameter&quot;, E_USER_WARNING);
+        return;
+    }
+
+    if (!isset($_params['value'])) {
+        $compiler-&gt;_syntax_error(&quot;assign: missing 'value' parameter&quot;, E_USER_WARNING);
+        return;
+    }
+
+    return &quot;\$this-&gt;assign({$_params['var']}, {$_params['value']});&quot;;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.assign_debug_info.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.assign_debug_info.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.assign_debug_info.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,39 +1,39 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-/**
- * Smarty {assign_debug_info} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     assign_debug_info&lt;br&gt;
- * Purpose:  assign debug info to the template&lt;br&gt;
- * @param array unused in this plugin, this plugin uses {@link Smarty::$_config},
- *              {@link Smarty::$_tpl_vars} and {@link Smarty::$_smarty_debug_info}
- * @param Smarty
- */
-function smarty_function_assign_debug_info($params, &amp;$smarty)
-{
-    $assigned_vars = $smarty-&gt;_tpl_vars;
-    ksort($assigned_vars);
-    if (@is_array($smarty-&gt;_config[0])) {
-        $config_vars = $smarty-&gt;_config[0];
-        ksort($config_vars);
-        $smarty-&gt;assign(&quot;_debug_config_keys&quot;, array_keys($config_vars));
-        $smarty-&gt;assign(&quot;_debug_config_vals&quot;, array_values($config_vars));
-    }
-    
-    $included_templates = $smarty-&gt;_smarty_debug_info;
-    
-    $smarty-&gt;assign(&quot;_debug_keys&quot;, array_keys($assigned_vars));
-    $smarty-&gt;assign(&quot;_debug_vals&quot;, array_values($assigned_vars));
-    
-    $smarty-&gt;assign(&quot;_debug_tpls&quot;, $included_templates);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+/**
+ * Smarty {assign_debug_info} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     assign_debug_info&lt;br&gt;
+ * Purpose:  assign debug info to the template&lt;br&gt;
+ * @param array unused in this plugin, this plugin uses {@link Smarty::$_config},
+ *              {@link Smarty::$_tpl_vars} and {@link Smarty::$_smarty_debug_info}
+ * @param Smarty
+ */
+function smarty_function_assign_debug_info($params, &amp;$smarty)
+{
+    $assigned_vars = $smarty-&gt;_tpl_vars;
+    ksort($assigned_vars);
+    if (@is_array($smarty-&gt;_config[0])) {
+        $config_vars = $smarty-&gt;_config[0];
+        ksort($config_vars);
+        $smarty-&gt;assign(&quot;_debug_config_keys&quot;, array_keys($config_vars));
+        $smarty-&gt;assign(&quot;_debug_config_vals&quot;, array_values($config_vars));
+    }
+    
+    $included_templates = $smarty-&gt;_smarty_debug_info;
+    
+    $smarty-&gt;assign(&quot;_debug_keys&quot;, array_keys($assigned_vars));
+    $smarty-&gt;assign(&quot;_debug_vals&quot;, array_values($assigned_vars));
+    
+    $smarty-&gt;assign(&quot;_debug_tpls&quot;, $included_templates);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.config_load.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.config_load.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.config_load.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,140 +1,140 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-/**
- * Smarty {config_load} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     config_load&lt;br&gt;
- * Purpose:  load config file vars
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.config.load.php">http://smarty.php.net/manual/en/language.function.config.load.php</A> {config_load}
- *       (Smarty online manual)
- * @param array Format:
- * &lt;pre&gt;
- * array('file' =&gt; required config file name,
- *       'section' =&gt; optional config file section to load
- *       'scope' =&gt; local/parent/global
- *       'global' =&gt; overrides scope, setting to parent if true)
- * &lt;/pre&gt;
- * @param Smarty
- */
-function smarty_function_config_load($params, &amp;$smarty)
-{
-        if ($smarty-&gt;debugging) {
-            $_params = array();
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.get_microtime.php');
-            $_debug_start_time = smarty_core_get_microtime($_params, $smarty);
-        }
-
-        $_file = isset($params['file']) ? $smarty-&gt;_dequote($params['file']) : null;
-        $_section = isset($params['section']) ? $smarty-&gt;_dequote($params['section']) : null;
-        $_scope = isset($params['scope']) ? $smarty-&gt;_dequote($params['scope']) : 'global';
-        $_global = isset($params['global']) ? $smarty-&gt;_dequote($params['global']) : false;
-
-        if (!isset($_file) || strlen($_file) == 0) {
-            $smarty-&gt;trigger_error(&quot;missing 'file' attribute in config_load tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
-        }
-
-        if (isset($_scope)) {
-            if ($_scope != 'local' &amp;&amp;
-                $_scope != 'parent' &amp;&amp;
-                $_scope != 'global') {
-                $smarty-&gt;trigger_error(&quot;invalid 'scope' attribute value&quot;, E_USER_ERROR, __FILE__, __LINE__);
-            }
-        } else {
-            if ($_global) {
-                $_scope = 'parent';
-            } else {
-                $_scope = 'local';
-            }
-        }
-
-        $_params = array('resource_name' =&gt; $_file,
-                         'resource_base_path' =&gt; $smarty-&gt;config_dir,
-                         'get_source' =&gt; false);
-        $smarty-&gt;_parse_resource_name($_params);
-        $_file_path = $_params['resource_type'] . ':' . $_params['resource_name'];
-        if (isset($_section))
-            $_compile_file = $smarty-&gt;_get_compile_path($_file_path.'|'.$_section);
-        else
-            $_compile_file = $smarty-&gt;_get_compile_path($_file_path);
-
-        if($smarty-&gt;force_compile || !file_exists($_compile_file)) {
-            $_compile = true;
-        } elseif ($smarty-&gt;compile_check) {
-            $_params = array('resource_name' =&gt; $_file,
-                             'resource_base_path' =&gt; $smarty-&gt;config_dir,
-                             'get_source' =&gt; false);
-            $_compile = $smarty-&gt;_fetch_resource_info($_params) &amp;&amp;
-                $_params['resource_timestamp'] &gt; filemtime($_compile_file);
-        } else {
-            $_compile = false;
-        }
-
-        if($_compile) {
-            // compile config file
-            if(!is_object($smarty-&gt;_conf_obj)) {
-                require_once SMARTY_DIR . $smarty-&gt;config_class . '.class.php';
-                $smarty-&gt;_conf_obj = new $smarty-&gt;config_class();
-                $smarty-&gt;_conf_obj-&gt;overwrite = $smarty-&gt;config_overwrite;
-                $smarty-&gt;_conf_obj-&gt;booleanize = $smarty-&gt;config_booleanize;
-                $smarty-&gt;_conf_obj-&gt;read_hidden = $smarty-&gt;config_read_hidden;
-                $smarty-&gt;_conf_obj-&gt;fix_newlines = $smarty-&gt;config_fix_newlines;
-            }
-
-            $_params = array('resource_name' =&gt; $_file,
-                             'resource_base_path' =&gt; $smarty-&gt;config_dir,
-                             $_params['get_source'] = true);
-            if (!$smarty-&gt;_fetch_resource_info($_params)) {
-                return;
-            }
-            $smarty-&gt;_conf_obj-&gt;set_file_contents($_file, $_params['source_content']);
-            $_config_vars = array_merge($smarty-&gt;_conf_obj-&gt;get($_file),
-                    $smarty-&gt;_conf_obj-&gt;get($_file, $_section));
-            if(function_exists('var_export')) {
-                $_output = '&lt;?php $_config_vars = ' . var_export($_config_vars, true) . '; ?&gt;';
-            } else {
-                $_output = '&lt;?php $_config_vars = unserialize(\'' . strtr(serialize($_config_vars),array('\''=&gt;'\\\'', '\\'=&gt;'\\\\')) . '\'); ?&gt;';
-            }
-            $_params = (array('compile_path' =&gt; $_compile_file, 'compiled_content' =&gt; $_output, 'resource_timestamp' =&gt; $_params['resource_timestamp']));
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.write_compiled_resource.php');
-            smarty_core_write_compiled_resource($_params, $smarty);
-        } else {
-            include($_compile_file);
-        }
-
-        if ($smarty-&gt;caching) {
-            $smarty-&gt;_cache_info['config'][$_file] = true;
-        }
-
-        $smarty-&gt;_config[0]['vars'] = @array_merge($smarty-&gt;_config[0]['vars'], $_config_vars);
-        $smarty-&gt;_config[0]['files'][$_file] = true;
-
-        if ($_scope == 'parent') {
-                $smarty-&gt;_config[1]['vars'] = @array_merge($smarty-&gt;_config[1]['vars'], $_config_vars);
-                $smarty-&gt;_config[1]['files'][$_file] = true;
-        } else if ($_scope == 'global') {
-            for ($i = 1, $for_max = count($smarty-&gt;_config); $i &lt; $for_max; $i++) {
-                $smarty-&gt;_config[$i]['vars'] = @array_merge($smarty-&gt;_config[$i]['vars'], $_config_vars);
-                $smarty-&gt;_config[$i]['files'][$_file] = true;
-            }
-        }
-
-        if ($smarty-&gt;debugging) {
-            $_params = array();
-            require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.get_microtime.php');
-            $smarty-&gt;_smarty_debug_info[] = array('type'      =&gt; 'config',
-                                                'filename'  =&gt; $_file.' ['.$_section.'] '.$_scope,
-                                                'depth'     =&gt; $smarty-&gt;_inclusion_depth,
-                                                'exec_time' =&gt; smarty_core_get_microtime($_params, $smarty) - $_debug_start_time);
-        }
-
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+/**
+ * Smarty {config_load} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     config_load&lt;br&gt;
+ * Purpose:  load config file vars
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.config.load.php">http://smarty.php.net/manual/en/language.function.config.load.php</A> {config_load}
+ *       (Smarty online manual)
+ * @param array Format:
+ * &lt;pre&gt;
+ * array('file' =&gt; required config file name,
+ *       'section' =&gt; optional config file section to load
+ *       'scope' =&gt; local/parent/global
+ *       'global' =&gt; overrides scope, setting to parent if true)
+ * &lt;/pre&gt;
+ * @param Smarty
+ */
+function smarty_function_config_load($params, &amp;$smarty)
+{
+        if ($smarty-&gt;debugging) {
+            $_params = array();
+            require_once(SMARTY_CORE_DIR . 'core.get_microtime.php');
+            $_debug_start_time = smarty_core_get_microtime($_params, $smarty);
+        }
+
+        $_file = isset($params['file']) ? $smarty-&gt;_dequote($params['file']) : null;
+        $_section = isset($params['section']) ? $smarty-&gt;_dequote($params['section']) : null;
+        $_scope = isset($params['scope']) ? $smarty-&gt;_dequote($params['scope']) : 'global';
+        $_global = isset($params['global']) ? $smarty-&gt;_dequote($params['global']) : false;
+
+        if (!isset($_file) || strlen($_file) == 0) {
+            $smarty-&gt;trigger_error(&quot;missing 'file' attribute in config_load tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
+        }
+
+        if (isset($_scope)) {
+            if ($_scope != 'local' &amp;&amp;
+                $_scope != 'parent' &amp;&amp;
+                $_scope != 'global') {
+                $smarty-&gt;trigger_error(&quot;invalid 'scope' attribute value&quot;, E_USER_ERROR, __FILE__, __LINE__);
+            }
+        } else {
+            if ($_global) {
+                $_scope = 'parent';
+            } else {
+                $_scope = 'local';
+            }
+        }
+
+        $_params = array('resource_name' =&gt; $_file,
+                         'resource_base_path' =&gt; $smarty-&gt;config_dir,
+                         'get_source' =&gt; false);
+        $smarty-&gt;_parse_resource_name($_params);
+        $_file_path = $_params['resource_type'] . ':' . $_params['resource_name'];
+        if (isset($_section))
+            $_compile_file = $smarty-&gt;_get_compile_path($_file_path.'|'.$_section);
+        else
+            $_compile_file = $smarty-&gt;_get_compile_path($_file_path);
+
+        if($smarty-&gt;force_compile || !file_exists($_compile_file)) {
+            $_compile = true;
+        } elseif ($smarty-&gt;compile_check) {
+            $_params = array('resource_name' =&gt; $_file,
+                             'resource_base_path' =&gt; $smarty-&gt;config_dir,
+                             'get_source' =&gt; false);
+            $_compile = $smarty-&gt;_fetch_resource_info($_params) &amp;&amp;
+                $_params['resource_timestamp'] &gt; filemtime($_compile_file);
+        } else {
+            $_compile = false;
+        }
+
+        if($_compile) {
+            // compile config file
+            if(!is_object($smarty-&gt;_conf_obj)) {
+                require_once SMARTY_DIR . $smarty-&gt;config_class . '.class.php';
+                $smarty-&gt;_conf_obj = new $smarty-&gt;config_class();
+                $smarty-&gt;_conf_obj-&gt;overwrite = $smarty-&gt;config_overwrite;
+                $smarty-&gt;_conf_obj-&gt;booleanize = $smarty-&gt;config_booleanize;
+                $smarty-&gt;_conf_obj-&gt;read_hidden = $smarty-&gt;config_read_hidden;
+                $smarty-&gt;_conf_obj-&gt;fix_newlines = $smarty-&gt;config_fix_newlines;
+            }
+
+            $_params = array('resource_name' =&gt; $_file,
+                             'resource_base_path' =&gt; $smarty-&gt;config_dir,
+                             $_params['get_source'] = true);
+            if (!$smarty-&gt;_fetch_resource_info($_params)) {
+                return;
+            }
+            $smarty-&gt;_conf_obj-&gt;set_file_contents($_file, $_params['source_content']);
+            $_config_vars = array_merge($smarty-&gt;_conf_obj-&gt;get($_file),
+                    $smarty-&gt;_conf_obj-&gt;get($_file, $_section));
+            if(function_exists('var_export')) {
+                $_output = '&lt;?php $_config_vars = ' . var_export($_config_vars, true) . '; ?&gt;';
+            } else {
+                $_output = '&lt;?php $_config_vars = unserialize(\'' . strtr(serialize($_config_vars),array('\''=&gt;'\\\'', '\\'=&gt;'\\\\')) . '\'); ?&gt;';
+            }
+            $_params = (array('compile_path' =&gt; $_compile_file, 'compiled_content' =&gt; $_output, 'resource_timestamp' =&gt; $_params['resource_timestamp']));
+            require_once(SMARTY_CORE_DIR . 'core.write_compiled_resource.php');
+            smarty_core_write_compiled_resource($_params, $smarty);
+        } else {
+            include($_compile_file);
+        }
+
+        if ($smarty-&gt;caching) {
+            $smarty-&gt;_cache_info['config'][$_file] = true;
+        }
+
+        $smarty-&gt;_config[0]['vars'] = @array_merge($smarty-&gt;_config[0]['vars'], $_config_vars);
+        $smarty-&gt;_config[0]['files'][$_file] = true;
+
+        if ($_scope == 'parent') {
+                $smarty-&gt;_config[1]['vars'] = @array_merge($smarty-&gt;_config[1]['vars'], $_config_vars);
+                $smarty-&gt;_config[1]['files'][$_file] = true;
+        } else if ($_scope == 'global') {
+            for ($i = 1, $for_max = count($smarty-&gt;_config); $i &lt; $for_max; $i++) {
+                $smarty-&gt;_config[$i]['vars'] = @array_merge($smarty-&gt;_config[$i]['vars'], $_config_vars);
+                $smarty-&gt;_config[$i]['files'][$_file] = true;
+            }
+        }
+
+        if ($smarty-&gt;debugging) {
+            $_params = array();
+            require_once(SMARTY_CORE_DIR . 'core.get_microtime.php');
+            $smarty-&gt;_smarty_debug_info[] = array('type'      =&gt; 'config',
+                                                'filename'  =&gt; $_file.' ['.$_section.'] '.$_scope,
+                                                'depth'     =&gt; $smarty-&gt;_inclusion_depth,
+                                                'exec_time' =&gt; smarty_core_get_microtime($_params, $smarty) - $_debug_start_time);
+        }
+
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.counter.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.counter.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.counter.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,79 +1,79 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {counter} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     counter&lt;br&gt;
- * Purpose:  print out a counter value
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.counter.php">http://smarty.php.net/manual/en/language.function.counter.php</A> {counter}
- *       (Smarty online manual)
- * @param array parameters
- * @param Smarty
- * @return string|null
- */
-function smarty_function_counter($params, &amp;$smarty)
-{
-    static $counters = array();
-
-    $name = (isset($params['name'])) ? $params['name'] : 'default';
-    if (!isset($counters[$name])) {
-        $counters[$name] = array(
-            'start'=&gt;1,
-            'skip'=&gt;1,
-            'direction'=&gt;'up',
-            'count'=&gt;1
-            );
-    }
-    $counter =&amp; $counters[$name];
-
-    if (isset($params['start'])) {
-        $counter['start'] = $counter['count'] = (int)$params['start'];
-    }
-
-    if (!empty($params['assign'])) {
-        $counter['assign'] = $params['assign'];
-    }
-
-    if (isset($counter['assign'])) {
-        $smarty-&gt;assign($counter['assign'], $counter['count']);
-    }
-    
-    if (isset($params['print'])) {
-        $print = (bool)$params['print'];
-    } else {
-        $print = empty($counter['assign']);
-    }
-
-    if ($print) {
-        $retval = $counter['count'];
-    } else {
-        $retval = null;
-    }
-
-    if (isset($params['skip'])) {
-        $counter['skip'] = $params['skip'];
-    }
-    
-    if (isset($params['direction'])) {
-        $counter['direction'] = $params['direction'];
-    }
-
-    if ($counter['direction'] == &quot;down&quot;)
-        $counter['count'] -= $counter['skip'];
-    else
-        $counter['count'] += $counter['skip'];
-    
-    return $retval;
-    
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {counter} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     counter&lt;br&gt;
+ * Purpose:  print out a counter value
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.counter.php">http://smarty.php.net/manual/en/language.function.counter.php</A> {counter}
+ *       (Smarty online manual)
+ * @param array parameters
+ * @param Smarty
+ * @return string|null
+ */
+function smarty_function_counter($params, &amp;$smarty)
+{
+    static $counters = array();
+
+    $name = (isset($params['name'])) ? $params['name'] : 'default';
+    if (!isset($counters[$name])) {
+        $counters[$name] = array(
+            'start'=&gt;1,
+            'skip'=&gt;1,
+            'direction'=&gt;'up',
+            'count'=&gt;1
+            );
+    }
+    $counter =&amp; $counters[$name];
+
+    if (isset($params['start'])) {
+        $counter['start'] = $counter['count'] = (int)$params['start'];
+    }
+
+    if (!empty($params['assign'])) {
+        $counter['assign'] = $params['assign'];
+    }
+
+    if (isset($counter['assign'])) {
+        $smarty-&gt;assign($counter['assign'], $counter['count']);
+    }
+    
+    if (isset($params['print'])) {
+        $print = (bool)$params['print'];
+    } else {
+        $print = empty($counter['assign']);
+    }
+
+    if ($print) {
+        $retval = $counter['count'];
+    } else {
+        $retval = null;
+    }
+
+    if (isset($params['skip'])) {
+        $counter['skip'] = $params['skip'];
+    }
+    
+    if (isset($params['direction'])) {
+        $counter['direction'] = $params['direction'];
+    }
+
+    if ($counter['direction'] == &quot;down&quot;)
+        $counter['count'] -= $counter['skip'];
+    else
+        $counter['count'] += $counter['skip'];
+    
+    return $retval;
+    
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.cycle.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.cycle.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.cycle.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,102 +1,102 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-/**
- * Smarty {cycle} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     cycle&lt;br&gt;
- * Date:     May 3, 2002&lt;br&gt;
- * Purpose:  cycle through given values&lt;br&gt;
- * Input:
- *         - name = name of cycle (optional)
- *         - values = comma separated list of values to cycle,
- *                    or an array of values to cycle
- *                    (this can be left out for subsequent calls)
- *         - reset = boolean - resets given var to true
- *         - print = boolean - print var or not. default is true
- *         - advance = boolean - whether or not to advance the cycle
- *         - delimiter = the value delimiter, default is &quot;,&quot;
- *         - assign = boolean, assigns to template var instead of
- *                    printed.
- *
- * Examples:&lt;br&gt;
- * &lt;pre&gt;
- * {cycle values=&quot;#eeeeee,#d0d0d0d&quot;}
- * {cycle name=row values=&quot;one,two,three&quot; reset=true}
- * {cycle name=row}
- * &lt;/pre&gt;
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.cycle.php">http://smarty.php.net/manual/en/language.function.cycle.php</A> {cycle}
- *       (Smarty online manual)
- * @author Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @author credit to Mark Priatel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">mpriatel at rogers.com</A>&gt;
- * @author credit to Gerard &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">gerard at interfold.com</A>&gt;
- * @author credit to Jason Sweat &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">jsweat_php at yahoo.com</A>&gt;
- * @version  1.3
- * @param array
- * @param Smarty
- * @return string|null
- */
-function smarty_function_cycle($params, &amp;$smarty)
-{
-    static $cycle_vars;
-    
-    $name = (empty($params['name'])) ? 'default' : $params['name'];
-    $print = (isset($params['print'])) ? (bool)$params['print'] : true;
-    $advance = (isset($params['advance'])) ? (bool)$params['advance'] : true;
-    $reset = (isset($params['reset'])) ? (bool)$params['reset'] : false;
-            
-    if (!in_array('values', array_keys($params))) {
-        if(!isset($cycle_vars[$name]['values'])) {
-            $smarty-&gt;trigger_error(&quot;cycle: missing 'values' parameter&quot;);
-            return;
-        }
-    } else {
-        if(isset($cycle_vars[$name]['values'])
-            &amp;&amp; $cycle_vars[$name]['values'] != $params['values'] ) {
-            $cycle_vars[$name]['index'] = 0;
-        }
-        $cycle_vars[$name]['values'] = $params['values'];
-    }
-
-    $cycle_vars[$name]['delimiter'] = (isset($params['delimiter'])) ? $params['delimiter'] : ',';
-    
-    if(is_array($cycle_vars[$name]['values'])) {
-        $cycle_array = $cycle_vars[$name]['values'];
-    } else {
-        $cycle_array = explode($cycle_vars[$name]['delimiter'],$cycle_vars[$name]['values']);
-    }
-    
-    if(!isset($cycle_vars[$name]['index']) || $reset ) {
-        $cycle_vars[$name]['index'] = 0;
-    }
-    
-    if (isset($params['assign'])) {
-        $print = false;
-        $smarty-&gt;assign($params['assign'], $cycle_array[$cycle_vars[$name]['index']]);
-    }
-        
-    if($print) {
-        $retval = $cycle_array[$cycle_vars[$name]['index']];
-    } else {
-        $retval = null;
-    }
-
-    if($advance) {
-        if ( $cycle_vars[$name]['index'] &gt;= count($cycle_array) -1 ) {
-            $cycle_vars[$name]['index'] = 0;
-        } else {
-            $cycle_vars[$name]['index']++;
-        }
-    }
-    
-    return $retval;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+/**
+ * Smarty {cycle} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     cycle&lt;br&gt;
+ * Date:     May 3, 2002&lt;br&gt;
+ * Purpose:  cycle through given values&lt;br&gt;
+ * Input:
+ *         - name = name of cycle (optional)
+ *         - values = comma separated list of values to cycle,
+ *                    or an array of values to cycle
+ *                    (this can be left out for subsequent calls)
+ *         - reset = boolean - resets given var to true
+ *         - print = boolean - print var or not. default is true
+ *         - advance = boolean - whether or not to advance the cycle
+ *         - delimiter = the value delimiter, default is &quot;,&quot;
+ *         - assign = boolean, assigns to template var instead of
+ *                    printed.
+ *
+ * Examples:&lt;br&gt;
+ * &lt;pre&gt;
+ * {cycle values=&quot;#eeeeee,#d0d0d0d&quot;}
+ * {cycle name=row values=&quot;one,two,three&quot; reset=true}
+ * {cycle name=row}
+ * &lt;/pre&gt;
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.cycle.php">http://smarty.php.net/manual/en/language.function.cycle.php</A> {cycle}
+ *       (Smarty online manual)
+ * @author Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @author credit to Mark Priatel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">mpriatel at rogers.com</A>&gt;
+ * @author credit to Gerard &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">gerard at interfold.com</A>&gt;
+ * @author credit to Jason Sweat &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">jsweat_php at yahoo.com</A>&gt;
+ * @version  1.3
+ * @param array
+ * @param Smarty
+ * @return string|null
+ */
+function smarty_function_cycle($params, &amp;$smarty)
+{
+    static $cycle_vars;
+    
+    $name = (empty($params['name'])) ? 'default' : $params['name'];
+    $print = (isset($params['print'])) ? (bool)$params['print'] : true;
+    $advance = (isset($params['advance'])) ? (bool)$params['advance'] : true;
+    $reset = (isset($params['reset'])) ? (bool)$params['reset'] : false;
+            
+    if (!in_array('values', array_keys($params))) {
+        if(!isset($cycle_vars[$name]['values'])) {
+            $smarty-&gt;trigger_error(&quot;cycle: missing 'values' parameter&quot;);
+            return;
+        }
+    } else {
+        if(isset($cycle_vars[$name]['values'])
+            &amp;&amp; $cycle_vars[$name]['values'] != $params['values'] ) {
+            $cycle_vars[$name]['index'] = 0;
+        }
+        $cycle_vars[$name]['values'] = $params['values'];
+    }
+
+    $cycle_vars[$name]['delimiter'] = (isset($params['delimiter'])) ? $params['delimiter'] : ',';
+    
+    if(is_array($cycle_vars[$name]['values'])) {
+        $cycle_array = $cycle_vars[$name]['values'];
+    } else {
+        $cycle_array = explode($cycle_vars[$name]['delimiter'],$cycle_vars[$name]['values']);
+    }
+    
+    if(!isset($cycle_vars[$name]['index']) || $reset ) {
+        $cycle_vars[$name]['index'] = 0;
+    }
+    
+    if (isset($params['assign'])) {
+        $print = false;
+        $smarty-&gt;assign($params['assign'], $cycle_array[$cycle_vars[$name]['index']]);
+    }
+        
+    if($print) {
+        $retval = $cycle_array[$cycle_vars[$name]['index']];
+    } else {
+        $retval = null;
+    }
+
+    if($advance) {
+        if ( $cycle_vars[$name]['index'] &gt;= count($cycle_array) -1 ) {
+            $cycle_vars[$name]['index'] = 0;
+        } else {
+            $cycle_vars[$name]['index']++;
+        }
+    }
+    
+    return $retval;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.debug.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.debug.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.debug.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,35 +1,35 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {debug} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     debug&lt;br&gt;
- * Date:     July 1, 2002&lt;br&gt;
- * Purpose:  popup debug window
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.debug.php">http://smarty.php.net/manual/en/language.function.debug.php</A> {debug}
- *       (Smarty online manual)
- * @author   Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @version  1.0
- * @param array
- * @param Smarty
- * @return string output from {@link Smarty::_generate_debug_output()}
- */
-function smarty_function_debug($params, &amp;$smarty)
-{
-    if (isset($params['output'])) {
-        $smarty-&gt;assign('_smarty_debug_output', $params['output']);
-    }
-    require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.display_debug_console.php');
-    return smarty_core_display_debug_console(null, $smarty);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {debug} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     debug&lt;br&gt;
+ * Date:     July 1, 2002&lt;br&gt;
+ * Purpose:  popup debug window
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.debug.php">http://smarty.php.net/manual/en/language.function.debug.php</A> {debug}
+ *       (Smarty online manual)
+ * @author   Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @version  1.0
+ * @param array
+ * @param Smarty
+ * @return string output from {@link Smarty::_generate_debug_output()}
+ */
+function smarty_function_debug($params, &amp;$smarty)
+{
+    if (isset($params['output'])) {
+        $smarty-&gt;assign('_smarty_debug_output', $params['output']);
+    }
+    require_once(SMARTY_CORE_DIR . 'core.display_debug_console.php');
+    return smarty_core_display_debug_console(null, $smarty);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.eval.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.eval.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.eval.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,48 +1,48 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {eval} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     eval&lt;br&gt;
- * Purpose:  evaluate a template variable as a template&lt;br&gt;
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.eval.php">http://smarty.php.net/manual/en/language.function.eval.php</A> {eval}
- *       (Smarty online manual)
- * @param array
- * @param Smarty
- */
-function smarty_function_eval($params, &amp;$smarty)
-{
-
-    if (!isset($params['var'])) {
-        $smarty-&gt;trigger_error(&quot;eval: missing 'var' parameter&quot;);
-        return;
-    }
-
-    if($params['var'] == '') {
-        return;
-    }
-
-    $smarty-&gt;_compile_source('evaluated template', $params['var'], $_var_compiled);
-
-    ob_start();
-    $smarty-&gt;_eval('?&gt;' . $_var_compiled);
-    $_contents = ob_get_contents();
-    ob_end_clean();
-
-    if (!empty($params['assign'])) {
-        $smarty-&gt;assign($params['assign'], $_contents);
-    } else {
-        return $_contents;
-    }
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {eval} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     eval&lt;br&gt;
+ * Purpose:  evaluate a template variable as a template&lt;br&gt;
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.eval.php">http://smarty.php.net/manual/en/language.function.eval.php</A> {eval}
+ *       (Smarty online manual)
+ * @param array
+ * @param Smarty
+ */
+function smarty_function_eval($params, &amp;$smarty)
+{
+
+    if (!isset($params['var'])) {
+        $smarty-&gt;trigger_error(&quot;eval: missing 'var' parameter&quot;);
+        return;
+    }
+
+    if($params['var'] == '') {
+        return;
+    }
+
+    $smarty-&gt;_compile_source('evaluated template', $params['var'], $_var_compiled);
+
+    ob_start();
+    $smarty-&gt;_eval('?&gt;' . $_var_compiled);
+    $_contents = ob_get_contents();
+    ob_end_clean();
+
+    if (!empty($params['assign'])) {
+        $smarty-&gt;assign($params['assign'], $_contents);
+    } else {
+        return $_contents;
+    }
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.fetch.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.fetch.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.fetch.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,220 +1,220 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {fetch} plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     fetch&lt;br&gt;
- * Purpose:  fetch file, web or ftp data and display results
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.fetch.php">http://smarty.php.net/manual/en/language.function.fetch.php</A> {fetch}
- *       (Smarty online manual)
- * @param array
- * @param Smarty
- * @return string|null if the assign parameter is passed, Smarty assigns the
- *                     result to a template variable
- */
-function smarty_function_fetch($params, &amp;$smarty)
-{
-    if (empty($params['file'])) {
-        $smarty-&gt;_trigger_fatal_error(&quot;[plugin] parameter 'file' cannot be empty&quot;);
-        return;
-    }
-
-    $content = '';
-    if ($smarty-&gt;security &amp;&amp; !preg_match('!^(http|ftp)://!i', $params['file'])) {
-        $_params = array('resource_type' =&gt; 'file', 'resource_name' =&gt; $params['file']);
-        require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.is_secure.php');
-        if(!smarty_core_is_secure($_params, $smarty)) {
-            $smarty-&gt;_trigger_fatal_error('[plugin] (secure mode) fetch \'' . $params['file'] . '\' is not allowed');
-            return;
-        }
-        
-        // fetch the file
-        if($fp = @fopen($params['file'],'r')) {
-            while(!feof($fp)) {
-                $content .= fgets ($fp,4096);
-            }
-            fclose($fp);
-        } else {
-            $smarty-&gt;_trigger_fatal_error('[plugin] fetch cannot read file \'' . $params['file'] . '\'');
-            return;
-        }
-    } else {
-        // not a local file
-        if(preg_match('!^<A HREF="http://!i">http://!i</A>',$params['file'])) {
-            // http fetch
-            if($uri_parts = parse_url($params['file'])) {
-                // set defaults
-                $host = $server_name = $uri_parts['host'];
-                $timeout = 30;
-                $accept = &quot;image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*&quot;;
-                $agent = &quot;Smarty Template Engine &quot;.$smarty-&gt;_version;
-                $referer = &quot;&quot;;
-                $uri = !empty($uri_parts['path']) ? $uri_parts['path'] : '/';
-                $uri .= !empty($uri_parts['query']) ? '?' . $uri_parts['query'] : '';
-                $_is_proxy = false;
-                if(empty($uri_parts['port'])) {
-                    $port = 80;
-                } else {
-                    $port = $uri_parts['port'];
-                }
-                if(!empty($uri_parts['user'])) {
-                    $user = $uri_parts['user'];
-                }
-                if(!empty($uri_parts['pass'])) {
-                    $pass = $uri_parts['pass'];
-                }
-                // loop through parameters, setup headers
-                foreach($params as $param_key =&gt; $param_value) {
-                    switch($param_key) {
-                        case &quot;file&quot;:
-                        case &quot;assign&quot;:
-                        case &quot;assign_headers&quot;:
-                            break;
-                        case &quot;user&quot;:
-                            if(!empty($param_value)) {
-                                $user = $param_value;
-                            }
-                            break;
-                        case &quot;pass&quot;:
-                            if(!empty($param_value)) {
-                                $pass = $param_value;
-                            }
-                            break;
-                        case &quot;accept&quot;:
-                            if(!empty($param_value)) {
-                                $accept = $param_value;
-                            }
-                            break;
-                        case &quot;header&quot;:
-                            if(!empty($param_value)) {
-                                if(!preg_match('![\w\d-]+: .+!',$param_value)) {
-                                    $smarty-&gt;_trigger_fatal_error(&quot;[plugin] invalid header format '&quot;.$param_value.&quot;'&quot;);
-                                    return;
-                                } else {
-                                    $extra_headers[] = $param_value;
-                                }
-                            }
-                            break;
-                        case &quot;proxy_host&quot;:
-                            if(!empty($param_value)) {
-                                $proxy_host = $param_value;
-                            }
-                            break;
-                        case &quot;proxy_port&quot;:
-                            if(!preg_match('!\D!', $param_value)) {
-                                $proxy_port = (int) $param_value;
-                            } else {
-                                $smarty-&gt;_trigger_fatal_error(&quot;[plugin] invalid value for attribute '&quot;.$param_key.&quot;'&quot;);
-                                return;
-                            }
-                            break;
-                        case &quot;agent&quot;:
-                            if(!empty($param_value)) {
-                                $agent = $param_value;
-                            }
-                            break;
-                        case &quot;referer&quot;:
-                            if(!empty($param_value)) {
-                                $referer = $param_value;
-                            }
-                            break;
-                        case &quot;timeout&quot;:
-                            if(!preg_match('!\D!', $param_value)) {
-                                $timeout = (int) $param_value;
-                            } else {
-                                $smarty-&gt;_trigger_fatal_error(&quot;[plugin] invalid value for attribute '&quot;.$param_key.&quot;'&quot;);
-                                return;
-                            }
-                            break;
-                        default:
-                            $smarty-&gt;_trigger_fatal_error(&quot;[plugin] unrecognized attribute '&quot;.$param_key.&quot;'&quot;);
-                            return;
-                    }
-                }
-                if(!empty($proxy_host) &amp;&amp; !empty($proxy_port)) {
-                    $_is_proxy = true;
-                    $fp = fsockopen($proxy_host,$proxy_port,$errno,$errstr,$timeout);
-                } else {
-                    $fp = fsockopen($server_name,$port,$errno,$errstr,$timeout);
-                }
-
-                if(!$fp) {
-                    $smarty-&gt;_trigger_fatal_error(&quot;[plugin] unable to fetch: $errstr ($errno)&quot;);
-                    return;
-                } else {
-                    if($_is_proxy) {
-                        fputs($fp, 'GET ' . $params['file'] . &quot; HTTP/1.0\r\n&quot;);
-                    } else {
-                        fputs($fp, &quot;GET $uri HTTP/1.0\r\n&quot;);
-                    }
-                    if(!empty($host)) {
-                        fputs($fp, &quot;Host: $host\r\n&quot;);
-                    }
-                    if(!empty($accept)) {
-                        fputs($fp, &quot;Accept: $accept\r\n&quot;);
-                    }
-                    if(!empty($agent)) {
-                        fputs($fp, &quot;User-Agent: $agent\r\n&quot;);
-                    }
-                    if(!empty($referer)) {
-                        fputs($fp, &quot;Referer: $referer\r\n&quot;);
-                    }
-                    if(isset($extra_headers) &amp;&amp; is_array($extra_headers)) {
-                        foreach($extra_headers as $curr_header) {
-                            fputs($fp, $curr_header.&quot;\r\n&quot;);
-                        }
-                    }
-                    if(!empty($user) &amp;&amp; !empty($pass)) {
-                        fputs($fp, &quot;Authorization: BASIC &quot;.base64_encode(&quot;$user:$pass&quot;).&quot;\r\n&quot;);
-                    }
-
-                    fputs($fp, &quot;\r\n&quot;);
-                    while(!feof($fp)) {
-                        $content .= fgets($fp,4096);
-                    }
-                    fclose($fp);
-                    $csplit = split(&quot;\r\n\r\n&quot;,$content,2);
-
-                    $content = $csplit[1];
-
-                    if(!empty($params['assign_headers'])) {
-                        $smarty-&gt;assign($params['assign_headers'],split(&quot;\r\n&quot;,$csplit[0]));
-                    }
-                }
-            } else {
-                $smarty-&gt;_trigger_fatal_error(&quot;[plugin] unable to parse URL, check syntax&quot;);
-                return;
-            }
-        } else {
-            // ftp fetch
-            if($fp = @fopen($params['file'],'r')) {
-                while(!feof($fp)) {
-                    $content .= fgets ($fp,4096);
-                }
-                fclose($fp);
-            } else {
-                $smarty-&gt;_trigger_fatal_error('[plugin] fetch cannot read file \'' . $params['file'] .'\'');
-                return;
-            }
-        }
-
-    }
-
-
-    if (!empty($params['assign'])) {
-        $smarty-&gt;assign($params['assign'],$content);
-    } else {
-        return $content;
-    }
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {fetch} plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     fetch&lt;br&gt;
+ * Purpose:  fetch file, web or ftp data and display results
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.fetch.php">http://smarty.php.net/manual/en/language.function.fetch.php</A> {fetch}
+ *       (Smarty online manual)
+ * @param array
+ * @param Smarty
+ * @return string|null if the assign parameter is passed, Smarty assigns the
+ *                     result to a template variable
+ */
+function smarty_function_fetch($params, &amp;$smarty)
+{
+    if (empty($params['file'])) {
+        $smarty-&gt;_trigger_fatal_error(&quot;[plugin] parameter 'file' cannot be empty&quot;);
+        return;
+    }
+
+    $content = '';
+    if ($smarty-&gt;security &amp;&amp; !preg_match('!^(http|ftp)://!i', $params['file'])) {
+        $_params = array('resource_type' =&gt; 'file', 'resource_name' =&gt; $params['file']);
+        require_once(SMARTY_CORE_DIR . 'core.is_secure.php');
+        if(!smarty_core_is_secure($_params, $smarty)) {
+            $smarty-&gt;_trigger_fatal_error('[plugin] (secure mode) fetch \'' . $params['file'] . '\' is not allowed');
+            return;
+        }
+        
+        // fetch the file
+        if($fp = @fopen($params['file'],'r')) {
+            while(!feof($fp)) {
+                $content .= fgets ($fp,4096);
+            }
+            fclose($fp);
+        } else {
+            $smarty-&gt;_trigger_fatal_error('[plugin] fetch cannot read file \'' . $params['file'] . '\'');
+            return;
+        }
+    } else {
+        // not a local file
+        if(preg_match('!^<A HREF="http://!i">http://!i</A>',$params['file'])) {
+            // http fetch
+            if($uri_parts = parse_url($params['file'])) {
+                // set defaults
+                $host = $server_name = $uri_parts['host'];
+                $timeout = 30;
+                $accept = &quot;image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*&quot;;
+                $agent = &quot;Smarty Template Engine &quot;.$smarty-&gt;_version;
+                $referer = &quot;&quot;;
+                $uri = !empty($uri_parts['path']) ? $uri_parts['path'] : '/';
+                $uri .= !empty($uri_parts['query']) ? '?' . $uri_parts['query'] : '';
+                $_is_proxy = false;
+                if(empty($uri_parts['port'])) {
+                    $port = 80;
+                } else {
+                    $port = $uri_parts['port'];
+                }
+                if(!empty($uri_parts['user'])) {
+                    $user = $uri_parts['user'];
+                }
+                if(!empty($uri_parts['pass'])) {
+                    $pass = $uri_parts['pass'];
+                }
+                // loop through parameters, setup headers
+                foreach($params as $param_key =&gt; $param_value) {
+                    switch($param_key) {
+                        case &quot;file&quot;:
+                        case &quot;assign&quot;:
+                        case &quot;assign_headers&quot;:
+                            break;
+                        case &quot;user&quot;:
+                            if(!empty($param_value)) {
+                                $user = $param_value;
+                            }
+                            break;
+                        case &quot;pass&quot;:
+                            if(!empty($param_value)) {
+                                $pass = $param_value;
+                            }
+                            break;
+                        case &quot;accept&quot;:
+                            if(!empty($param_value)) {
+                                $accept = $param_value;
+                            }
+                            break;
+                        case &quot;header&quot;:
+                            if(!empty($param_value)) {
+                                if(!preg_match('![\w\d-]+: .+!',$param_value)) {
+                                    $smarty-&gt;_trigger_fatal_error(&quot;[plugin] invalid header format '&quot;.$param_value.&quot;'&quot;);
+                                    return;
+                                } else {
+                                    $extra_headers[] = $param_value;
+                                }
+                            }
+                            break;
+                        case &quot;proxy_host&quot;:
+                            if(!empty($param_value)) {
+                                $proxy_host = $param_value;
+                            }
+                            break;
+                        case &quot;proxy_port&quot;:
+                            if(!preg_match('!\D!', $param_value)) {
+                                $proxy_port = (int) $param_value;
+                            } else {
+                                $smarty-&gt;_trigger_fatal_error(&quot;[plugin] invalid value for attribute '&quot;.$param_key.&quot;'&quot;);
+                                return;
+                            }
+                            break;
+                        case &quot;agent&quot;:
+                            if(!empty($param_value)) {
+                                $agent = $param_value;
+                            }
+                            break;
+                        case &quot;referer&quot;:
+                            if(!empty($param_value)) {
+                                $referer = $param_value;
+                            }
+                            break;
+                        case &quot;timeout&quot;:
+                            if(!preg_match('!\D!', $param_value)) {
+                                $timeout = (int) $param_value;
+                            } else {
+                                $smarty-&gt;_trigger_fatal_error(&quot;[plugin] invalid value for attribute '&quot;.$param_key.&quot;'&quot;);
+                                return;
+                            }
+                            break;
+                        default:
+                            $smarty-&gt;_trigger_fatal_error(&quot;[plugin] unrecognized attribute '&quot;.$param_key.&quot;'&quot;);
+                            return;
+                    }
+                }
+                if(!empty($proxy_host) &amp;&amp; !empty($proxy_port)) {
+                    $_is_proxy = true;
+                    $fp = fsockopen($proxy_host,$proxy_port,$errno,$errstr,$timeout);
+                } else {
+                    $fp = fsockopen($server_name,$port,$errno,$errstr,$timeout);
+                }
+
+                if(!$fp) {
+                    $smarty-&gt;_trigger_fatal_error(&quot;[plugin] unable to fetch: $errstr ($errno)&quot;);
+                    return;
+                } else {
+                    if($_is_proxy) {
+                        fputs($fp, 'GET ' . $params['file'] . &quot; HTTP/1.0\r\n&quot;);
+                    } else {
+                        fputs($fp, &quot;GET $uri HTTP/1.0\r\n&quot;);
+                    }
+                    if(!empty($host)) {
+                        fputs($fp, &quot;Host: $host\r\n&quot;);
+                    }
+                    if(!empty($accept)) {
+                        fputs($fp, &quot;Accept: $accept\r\n&quot;);
+                    }
+                    if(!empty($agent)) {
+                        fputs($fp, &quot;User-Agent: $agent\r\n&quot;);
+                    }
+                    if(!empty($referer)) {
+                        fputs($fp, &quot;Referer: $referer\r\n&quot;);
+                    }
+                    if(isset($extra_headers) &amp;&amp; is_array($extra_headers)) {
+                        foreach($extra_headers as $curr_header) {
+                            fputs($fp, $curr_header.&quot;\r\n&quot;);
+                        }
+                    }
+                    if(!empty($user) &amp;&amp; !empty($pass)) {
+                        fputs($fp, &quot;Authorization: BASIC &quot;.base64_encode(&quot;$user:$pass&quot;).&quot;\r\n&quot;);
+                    }
+
+                    fputs($fp, &quot;\r\n&quot;);
+                    while(!feof($fp)) {
+                        $content .= fgets($fp,4096);
+                    }
+                    fclose($fp);
+                    $csplit = split(&quot;\r\n\r\n&quot;,$content,2);
+
+                    $content = $csplit[1];
+
+                    if(!empty($params['assign_headers'])) {
+                        $smarty-&gt;assign($params['assign_headers'],split(&quot;\r\n&quot;,$csplit[0]));
+                    }
+                }
+            } else {
+                $smarty-&gt;_trigger_fatal_error(&quot;[plugin] unable to parse URL, check syntax&quot;);
+                return;
+            }
+        } else {
+            // ftp fetch
+            if($fp = @fopen($params['file'],'r')) {
+                while(!feof($fp)) {
+                    $content .= fgets ($fp,4096);
+                }
+                fclose($fp);
+            } else {
+                $smarty-&gt;_trigger_fatal_error('[plugin] fetch cannot read file \'' . $params['file'] .'\'');
+                return;
+            }
+        }
+
+    }
+
+
+    if (!empty($params['assign'])) {
+        $smarty-&gt;assign($params['assign'],$content);
+    } else {
+        return $content;
+    }
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_checkboxes.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_checkboxes.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_checkboxes.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,143 +1,143 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {html_checkboxes} function plugin
- *
- * File:       function.html_checkboxes.php&lt;br&gt;
- * Type:       function&lt;br&gt;
- * Name:       html_checkboxes&lt;br&gt;
- * Date:       24.Feb.2003&lt;br&gt;
- * Purpose:    Prints out a list of checkbox input types&lt;br&gt;
- * Input:&lt;br&gt;
- *           - name       (optional) - string default &quot;checkbox&quot;
- *           - values     (required) - array
- *           - options    (optional) - associative array
- *           - checked    (optional) - array default not set
- *           - separator  (optional) - ie &lt;br&gt; or &nbsp;
- *           - output     (optional) - the output next to each checkbox
- *           - assign     (optional) - assign the output as an array to this variable
- * Examples:
- * &lt;pre&gt;
- * {html_checkboxes values=$ids output=$names}
- * {html_checkboxes values=$ids name='box' separator='&lt;br&gt;' output=$names}
- * {html_checkboxes values=$ids checked=$checked separator='&lt;br&gt;' output=$names}
- * &lt;/pre&gt;
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.checkboxes.php">http://smarty.php.net/manual/en/language.function.html.checkboxes.php</A> {html_checkboxes}
- *      (Smarty online manual)
- * @author     Christopher Kvarme &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">christopher.kvarme at flashjab.com</A>&gt;
- * @author credits to Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @version    1.0
- * @param array
- * @param Smarty
- * @return string
- * @uses smarty_function_escape_special_chars()
- */
-function smarty_function_html_checkboxes($params, &amp;$smarty)
-{
-    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
-
-    $name = 'checkbox';
-    $values = null;
-    $options = null;
-    $selected = null;
-    $separator = '';
-    $labels = true;
-    $output = null;
-
-    $extra = '';
-
-    foreach($params as $_key =&gt; $_val) {
-        switch($_key) {
-            case 'name':
-            case 'separator':
-                $$_key = $_val;
-                break;
-
-            case 'labels':
-                $$_key = (bool)$_val;
-                break;
-
-            case 'options':
-                $$_key = (array)$_val;
-                break;
-
-            case 'values':
-            case 'output':
-                $$_key = array_values((array)$_val);
-                break;
-
-            case 'checked':
-            case 'selected':
-                $selected = array_map('strval', array_values((array)$_val));
-                break;
-
-            case 'checkboxes':
-                $smarty-&gt;trigger_error('html_checkboxes: the use of the &quot;checkboxes&quot; attribute is deprecated, use &quot;options&quot; instead', E_USER_WARNING);
-                $options = (array)$_val;
-                break;
-
-            case 'assign':
-                break;
-
-            default:
-                if(!is_array($_val)) {
-                    $extra .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_val).'&quot;';
-                } else {
-                    $smarty-&gt;trigger_error(&quot;html_checkboxes: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
-                }
-                break;
-        }
-    }
-
-    if (!isset($options) &amp;&amp; !isset($values))
-        return ''; /* raise error here? */
-
-    settype($selected, 'array');
-    $_html_result = array();
-
-    if (is_array($options)) {
-
-        foreach ($options as $_key=&gt;$_val)
-            $_html_result[] = smarty_function_html_checkboxes_output($name, $_key, $_val, $selected, $extra, $separator, $labels);
-
-
-    } else {
-        foreach ($values as $_i=&gt;$_key) {
-            $_val = isset($output[$_i]) ? $output[$_i] : '';
-            $_html_result[] = smarty_function_html_checkboxes_output($name, $_key, $_val, $selected, $extra, $separator, $labels);
-        }
-
-    }
-
-    if(!empty($params['assign'])) {
-        $smarty-&gt;assign($params['assign'], $_html_result);
-    } else {
-        return implode(&quot;\n&quot;,$_html_result);
-    }
-
-}
-
-function smarty_function_html_checkboxes_output($name, $value, $output, $selected, $extra, $separator, $labels) {
-    $_output = '';
-    if ($labels) $_output .= '&lt;label&gt;';
-    $_output .= '&lt;input type=&quot;checkbox&quot; name=&quot;'
-        . smarty_function_escape_special_chars($name) . '[]&quot; value=&quot;'
-        . smarty_function_escape_special_chars($value) . '&quot;';
-
-    if (in_array((string)$value, $selected)) {
-        $_output .= ' checked=&quot;checked&quot;';
-    }
-    $_output .= $extra . ' /&gt;' . $output;
-    if ($labels) $_output .= '&lt;/label&gt;';
-    $_output .=  $separator;
-
-    return $_output;
-}
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {html_checkboxes} function plugin
+ *
+ * File:       function.html_checkboxes.php&lt;br&gt;
+ * Type:       function&lt;br&gt;
+ * Name:       html_checkboxes&lt;br&gt;
+ * Date:       24.Feb.2003&lt;br&gt;
+ * Purpose:    Prints out a list of checkbox input types&lt;br&gt;
+ * Input:&lt;br&gt;
+ *           - name       (optional) - string default &quot;checkbox&quot;
+ *           - values     (required) - array
+ *           - options    (optional) - associative array
+ *           - checked    (optional) - array default not set
+ *           - separator  (optional) - ie &lt;br&gt; or &nbsp;
+ *           - output     (optional) - the output next to each checkbox
+ *           - assign     (optional) - assign the output as an array to this variable
+ * Examples:
+ * &lt;pre&gt;
+ * {html_checkboxes values=$ids output=$names}
+ * {html_checkboxes values=$ids name='box' separator='&lt;br&gt;' output=$names}
+ * {html_checkboxes values=$ids checked=$checked separator='&lt;br&gt;' output=$names}
+ * &lt;/pre&gt;
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.checkboxes.php">http://smarty.php.net/manual/en/language.function.html.checkboxes.php</A> {html_checkboxes}
+ *      (Smarty online manual)
+ * @author     Christopher Kvarme &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">christopher.kvarme at flashjab.com</A>&gt;
+ * @author credits to Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @version    1.0
+ * @param array
+ * @param Smarty
+ * @return string
+ * @uses smarty_function_escape_special_chars()
+ */
+function smarty_function_html_checkboxes($params, &amp;$smarty)
+{
+    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
+
+    $name = 'checkbox';
+    $values = null;
+    $options = null;
+    $selected = null;
+    $separator = '';
+    $labels = true;
+    $output = null;
+
+    $extra = '';
+
+    foreach($params as $_key =&gt; $_val) {
+        switch($_key) {
+            case 'name':
+            case 'separator':
+                $$_key = $_val;
+                break;
+
+            case 'labels':
+                $$_key = (bool)$_val;
+                break;
+
+            case 'options':
+                $$_key = (array)$_val;
+                break;
+
+            case 'values':
+            case 'output':
+                $$_key = array_values((array)$_val);
+                break;
+
+            case 'checked':
+            case 'selected':
+                $selected = array_map('strval', array_values((array)$_val));
+                break;
+
+            case 'checkboxes':
+                $smarty-&gt;trigger_error('html_checkboxes: the use of the &quot;checkboxes&quot; attribute is deprecated, use &quot;options&quot; instead', E_USER_WARNING);
+                $options = (array)$_val;
+                break;
+
+            case 'assign':
+                break;
+
+            default:
+                if(!is_array($_val)) {
+                    $extra .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_val).'&quot;';
+                } else {
+                    $smarty-&gt;trigger_error(&quot;html_checkboxes: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
+                }
+                break;
+        }
+    }
+
+    if (!isset($options) &amp;&amp; !isset($values))
+        return ''; /* raise error here? */
+
+    settype($selected, 'array');
+    $_html_result = array();
+
+    if (isset($options)) {
+
+        foreach ($options as $_key=&gt;$_val)
+            $_html_result[] = smarty_function_html_checkboxes_output($name, $_key, $_val, $selected, $extra, $separator, $labels);
+
+
+    } else {
+        foreach ($values as $_i=&gt;$_key) {
+            $_val = isset($output[$_i]) ? $output[$_i] : '';
+            $_html_result[] = smarty_function_html_checkboxes_output($name, $_key, $_val, $selected, $extra, $separator, $labels);
+        }
+
+    }
+
+    if(!empty($params['assign'])) {
+        $smarty-&gt;assign($params['assign'], $_html_result);
+    } else {
+        return implode(&quot;\n&quot;,$_html_result);
+    }
+
+}
+
+function smarty_function_html_checkboxes_output($name, $value, $output, $selected, $extra, $separator, $labels) {
+    $_output = '';
+    if ($labels) $_output .= '&lt;label&gt;';
+    $_output .= '&lt;input type=&quot;checkbox&quot; name=&quot;'
+        . smarty_function_escape_special_chars($name) . '[]&quot; value=&quot;'
+        . smarty_function_escape_special_chars($value) . '&quot;';
+
+    if (in_array((string)$value, $selected)) {
+        $_output .= ' checked=&quot;checked&quot;';
+    }
+    $_output .= $extra . ' /&gt;' . $output;
+    if ($labels) $_output .= '&lt;/label&gt;';
+    $_output .=  $separator;
+
+    return $_output;
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_image.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_image.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_image.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,142 +1,139 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {html_image} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     html_image&lt;br&gt;
- * Date:     Feb 24, 2003&lt;br&gt;
- * Purpose:  format HTML tags for the image&lt;br&gt;
- * Input:&lt;br&gt;
- *         - file = file (and path) of image (required)
- *         - border = border width (optional, default 0)
- *         - height = image height (optional, default actual height)
- *         - image =image width (optional, default actual width)
- *         - basedir = base directory for absolute paths, default
- *                     is environment variable DOCUMENT_ROOT
- *
- * Examples: {html_image file=&quot;images/masthead.gif&quot;}
- * Output:   &lt;img src=&quot;images/masthead.gif&quot; border=0 width=400 height=23&gt;
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.image.php">http://smarty.php.net/manual/en/language.function.html.image.php</A> {html_image}
- *      (Smarty online manual)
- * @author   Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @author credits to Duda &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">duda at big.hu</A>&gt; - wrote first image function
- *           in repository, helped with lots of functionality
- * @version  1.0
- * @param array
- * @param Smarty
- * @return string
- * @uses smarty_function_escape_special_chars()
- */
-function smarty_function_html_image($params, &amp;$smarty)
-{
-    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
-    
-    $alt = '';
-    $file = '';
-    $border = 0;
-    $height = '';
-    $width = '';
-    $extra = '';
-    $prefix = '';
-    $suffix = '';
-    $server_vars = ($smarty-&gt;request_use_auto_globals) ? $_SERVER : $GLOBALS['HTTP_SERVER_VARS'];
-    $basedir = isset($server_vars['DOCUMENT_ROOT']) ? $server_vars['DOCUMENT_ROOT'] : '';
-    foreach($params as $_key =&gt; $_val) {
-        switch($_key) {
-            case 'file':
-            case 'border':
-            case 'height':
-            case 'width':
-            case 'dpi':
-            case 'basedir':
-                $$_key = $_val;
-                break;
-
-            case 'alt':
-                if(!is_array($_val)) {
-                    $$_key = smarty_function_escape_special_chars($_val);
-                } else {
-                    $smarty-&gt;trigger_error(&quot;html_image: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
-                }
-                break;
-
-            case 'link':
-            case 'href':
-                $prefix = '&lt;a href=&quot;' . $_val . '&quot;&gt;';
-                $suffix = '&lt;/a&gt;';
-                break;
-
-            default:
-                if(!is_array($_val)) {
-                    $extra .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_val).'&quot;';
-                } else {
-                    $smarty-&gt;trigger_error(&quot;html_image: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
-                }
-                break;
-        }
-    }
-
-    if (empty($file)) {
-        $smarty-&gt;trigger_error(&quot;html_image: missing 'file' parameter&quot;, E_USER_NOTICE);
-        return;
-    }
-
-    if (substr($file,0,1) == '/') {
-        $_image_path = $basedir . $file;
-    } else {
-        $_image_path = $file;
-    }
-
-    if(!isset($params['width']) || !isset($params['height'])) {
-        if ($smarty-&gt;security &amp;&amp;
-            ($_params = array('resource_type' =&gt; 'file', 'resource_name' =&gt; $_image_path)) &amp;&amp;
-            (require_once(SMARTY_DIR . 'core' . DIRECTORY_SEPARATOR . 'core.is_secure.php')) &amp;&amp;
-            (!smarty_core_is_secure($_params, $smarty)) ) {
-            $smarty-&gt;trigger_error(&quot;html_image: (secure) '$_image_path' not in secure directory&quot;, E_USER_NOTICE);
-
-        } elseif (!$_image_data = @getimagesize($_image_path)) {
-            if(!file_exists($_image_path)) {
-                $smarty-&gt;trigger_error(&quot;html_image: unable to find '$_image_path'&quot;, E_USER_NOTICE);
-                return;
-            } else if(!is_readable($_image_path)) {
-                $smarty-&gt;trigger_error(&quot;html_image: unable to read '$_image_path'&quot;, E_USER_NOTICE);
-                return;
-            } else {
-                $smarty-&gt;trigger_error(&quot;html_image: '$_image_path' is not a valid image file&quot;, E_USER_NOTICE);
-                return;
-            }
-        }
-
-        if(!isset($params['width'])) {
-            $width = $_image_data[0];
-        }
-        if(!isset($params['height'])) {
-            $height = $_image_data[1];
-        }
-
-    }
-
-    if(isset($params['dpi'])) {
-        if(strstr($server_vars['HTTP_USER_AGENT'], 'Mac')) {
-            $dpi_default = 72;
-        } else {
-            $dpi_default = 96;
-        }
-        $_resize = $dpi_default/$params['dpi'];
-        $width = round($width * $_resize);
-        $height = round($height * $_resize);
-    }
-
-    return $prefix . '&lt;img src=&quot;'.$file.'&quot; alt=&quot;'.$alt.'&quot; border=&quot;'.$border.'&quot; width=&quot;'.$width.'&quot; height=&quot;'.$height.'&quot;'.$extra.' /&gt;' . $suffix;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {html_image} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     html_image&lt;br&gt;
+ * Date:     Feb 24, 2003&lt;br&gt;
+ * Purpose:  format HTML tags for the image&lt;br&gt;
+ * Input:&lt;br&gt;
+ *         - file = file (and path) of image (required)
+ *         - height = image height (optional, default actual height)
+ *         - width = image width (optional, default actual width)
+ *         - basedir = base directory for absolute paths, default
+ *                     is environment variable DOCUMENT_ROOT
+ *
+ * Examples: {html_image file=&quot;images/masthead.gif&quot;}
+ * Output:   &lt;img src=&quot;images/masthead.gif&quot; width=400 height=23&gt;
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.image.php">http://smarty.php.net/manual/en/language.function.html.image.php</A> {html_image}
+ *      (Smarty online manual)
+ * @author   Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @author credits to Duda &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">duda at big.hu</A>&gt; - wrote first image function
+ *           in repository, helped with lots of functionality
+ * @version  1.0
+ * @param array
+ * @param Smarty
+ * @return string
+ * @uses smarty_function_escape_special_chars()
+ */
+function smarty_function_html_image($params, &amp;$smarty)
+{
+    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
+    
+    $alt = '';
+    $file = '';
+    $height = '';
+    $width = '';
+    $extra = '';
+    $prefix = '';
+    $suffix = '';
+    $server_vars = ($smarty-&gt;request_use_auto_globals) ? $_SERVER : $GLOBALS['HTTP_SERVER_VARS'];
+    $basedir = isset($server_vars['DOCUMENT_ROOT']) ? $server_vars['DOCUMENT_ROOT'] : '';
+    foreach($params as $_key =&gt; $_val) {
+        switch($_key) {
+            case 'file':
+            case 'height':
+            case 'width':
+            case 'dpi':
+            case 'basedir':
+                $$_key = $_val;
+                break;
+
+            case 'alt':
+                if(!is_array($_val)) {
+                    $$_key = smarty_function_escape_special_chars($_val);
+                } else {
+                    $smarty-&gt;trigger_error(&quot;html_image: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
+                }
+                break;
+
+            case 'link':
+            case 'href':
+                $prefix = '&lt;a href=&quot;' . $_val . '&quot;&gt;';
+                $suffix = '&lt;/a&gt;';
+                break;
+
+            default:
+                if(!is_array($_val)) {
+                    $extra .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_val).'&quot;';
+                } else {
+                    $smarty-&gt;trigger_error(&quot;html_image: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
+                }
+                break;
+        }
+    }
+
+    if (empty($file)) {
+        $smarty-&gt;trigger_error(&quot;html_image: missing 'file' parameter&quot;, E_USER_NOTICE);
+        return;
+    }
+
+    if (substr($file,0,1) == '/') {
+        $_image_path = $basedir . $file;
+    } else {
+        $_image_path = $file;
+    }
+
+    if(!isset($params['width']) || !isset($params['height'])) {
+        if ($smarty-&gt;security &amp;&amp;
+            ($_params = array('resource_type' =&gt; 'file', 'resource_name' =&gt; $_image_path)) &amp;&amp;
+            (require_once(SMARTY_CORE_DIR . 'core.is_secure.php')) &amp;&amp;
+            (!smarty_core_is_secure($_params, $smarty)) ) {
+            $smarty-&gt;trigger_error(&quot;html_image: (secure) '$_image_path' not in secure directory&quot;, E_USER_NOTICE);
+
+        } elseif (!$_image_data = @getimagesize($_image_path)) {
+            if(!file_exists($_image_path)) {
+                $smarty-&gt;trigger_error(&quot;html_image: unable to find '$_image_path'&quot;, E_USER_NOTICE);
+                return;
+            } else if(!is_readable($_image_path)) {
+                $smarty-&gt;trigger_error(&quot;html_image: unable to read '$_image_path'&quot;, E_USER_NOTICE);
+                return;
+            } else {
+                $smarty-&gt;trigger_error(&quot;html_image: '$_image_path' is not a valid image file&quot;, E_USER_NOTICE);
+                return;
+            }
+        }
+
+        if(!isset($params['width'])) {
+            $width = $_image_data[0];
+        }
+        if(!isset($params['height'])) {
+            $height = $_image_data[1];
+        }
+
+    }
+
+    if(isset($params['dpi'])) {
+        if(strstr($server_vars['HTTP_USER_AGENT'], 'Mac')) {
+            $dpi_default = 72;
+        } else {
+            $dpi_default = 96;
+        }
+        $_resize = $dpi_default/$params['dpi'];
+        $width = round($width * $_resize);
+        $height = round($height * $_resize);
+    }
+
+    return $prefix . '&lt;img src=&quot;'.$file.'&quot; alt=&quot;'.$alt.'&quot; width=&quot;'.$width.'&quot; height=&quot;'.$height.'&quot;'.$extra.' /&gt;' . $suffix;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_options.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_options.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_options.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,121 +1,121 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {html_options} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     html_options&lt;br&gt;
- * Input:&lt;br&gt;
- *           - name       (optional) - string default &quot;select&quot;
- *           - values     (required if no options supplied) - array
- *           - options    (required if no values supplied) - associative array
- *           - selected   (optional) - string default not set
- *           - output     (required if not options supplied) - array
- * Purpose:  Prints the list of &lt;option&gt; tags generated from
- *           the passed parameters
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.options.php">http://smarty.php.net/manual/en/language.function.html.options.php</A> {html_image}
- *      (Smarty online manual)
- * @param array
- * @param Smarty
- * @return string
- * @uses smarty_function_escape_special_chars()
- */
-function smarty_function_html_options($params, &amp;$smarty)
-{
-    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
-    
-    $name = null;
-    $values = null;
-    $options = null;
-    $selected = array();
-    $output = null;
-    
-    $extra = '';
-    
-    foreach($params as $_key =&gt; $_val) {
-        switch($_key) {
-            case 'name':
-                $$_key = (string)$_val;
-                break;
-            
-            case 'options':
-                $$_key = (array)$_val;
-                break;
-                
-            case 'values':
-            case 'output':
-                $$_key = array_values((array)$_val);
-                break;
-
-            case 'selected':
-                $$_key = array_map('strval', array_values((array)$_val));
-                break;
-                
-            default:
-                if(!is_array($_val)) {
-                    $extra .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_val).'&quot;';
-                } else {
-                    $smarty-&gt;trigger_error(&quot;html_options: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
-                }
-                break;
-        }
-    }
-
-    if (!isset($options) &amp;&amp; !isset($values))
-        return ''; /* raise error here? */
-
-    $_html_result = '';
-
-    if (is_array($options)) {
-        
-        foreach ($options as $_key=&gt;$_val)
-            $_html_result .= smarty_function_html_options_optoutput($_key, $_val, $selected);
-
-    } else {
-        
-        foreach ((array)$values as $_i=&gt;$_key) {
-            $_val = isset($output[$_i]) ? $output[$_i] : '';
-            $_html_result .= smarty_function_html_options_optoutput($_key, $_val, $selected);
-        }
-
-    }
-
-    if(!empty($name)) {
-        $_html_result = '&lt;select name=&quot;' . $name . '&quot;' . $extra . '&gt;' . &quot;\n&quot; . $_html_result . '&lt;/select&gt;' . &quot;\n&quot;;
-    }
-
-    return $_html_result;
-
-}
-
-function smarty_function_html_options_optoutput($key, $value, $selected) {
-    if(!is_array($value)) {
-        $_html_result = '&lt;option label=&quot;' . smarty_function_escape_special_chars($value) . '&quot; value=&quot;' .
-            smarty_function_escape_special_chars($key) . '&quot;';
-        if (in_array((string)$key, $selected))
-            $_html_result .= ' selected=&quot;selected&quot;';
-        $_html_result .= '&gt;' . smarty_function_escape_special_chars($value) . '&lt;/option&gt;' . &quot;\n&quot;;
-    } else {
-        $_html_result = smarty_function_html_options_optgroup($key, $value, $selected);
-    }
-    return $_html_result;
-}
-
-function smarty_function_html_options_optgroup($key, $values, $selected) {
-    $optgroup_html = '&lt;optgroup label=&quot;' . smarty_function_escape_special_chars($key) . '&quot;&gt;' . &quot;\n&quot;;
-    foreach ($values as $key =&gt; $value) {
-        $optgroup_html .= smarty_function_html_options_optoutput($key, $value, $selected);
-    }
-    $optgroup_html .= &quot;&lt;/optgroup&gt;\n&quot;;
-    return $optgroup_html;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {html_options} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     html_options&lt;br&gt;
+ * Input:&lt;br&gt;
+ *           - name       (optional) - string default &quot;select&quot;
+ *           - values     (required if no options supplied) - array
+ *           - options    (required if no values supplied) - associative array
+ *           - selected   (optional) - string default not set
+ *           - output     (required if not options supplied) - array
+ * Purpose:  Prints the list of &lt;option&gt; tags generated from
+ *           the passed parameters
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.options.php">http://smarty.php.net/manual/en/language.function.html.options.php</A> {html_image}
+ *      (Smarty online manual)
+ * @param array
+ * @param Smarty
+ * @return string
+ * @uses smarty_function_escape_special_chars()
+ */
+function smarty_function_html_options($params, &amp;$smarty)
+{
+    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
+    
+    $name = null;
+    $values = null;
+    $options = null;
+    $selected = array();
+    $output = null;
+    
+    $extra = '';
+    
+    foreach($params as $_key =&gt; $_val) {
+        switch($_key) {
+            case 'name':
+                $$_key = (string)$_val;
+                break;
+            
+            case 'options':
+                $$_key = (array)$_val;
+                break;
+                
+            case 'values':
+            case 'output':
+                $$_key = array_values((array)$_val);
+                break;
+
+            case 'selected':
+                $$_key = array_map('strval', array_values((array)$_val));
+                break;
+                
+            default:
+                if(!is_array($_val)) {
+                    $extra .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_val).'&quot;';
+                } else {
+                    $smarty-&gt;trigger_error(&quot;html_options: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
+                }
+                break;
+        }
+    }
+
+    if (!isset($options) &amp;&amp; !isset($values))
+        return ''; /* raise error here? */
+
+    $_html_result = '';
+
+    if (isset($options)) {
+        
+        foreach ($options as $_key=&gt;$_val)
+            $_html_result .= smarty_function_html_options_optoutput($_key, $_val, $selected);
+
+    } else {
+        
+        foreach ($values as $_i=&gt;$_key) {
+            $_val = isset($output[$_i]) ? $output[$_i] : '';
+            $_html_result .= smarty_function_html_options_optoutput($_key, $_val, $selected);
+        }
+
+    }
+
+    if(!empty($name)) {
+        $_html_result = '&lt;select name=&quot;' . $name . '&quot;' . $extra . '&gt;' . &quot;\n&quot; . $_html_result . '&lt;/select&gt;' . &quot;\n&quot;;
+    }
+
+    return $_html_result;
+
+}
+
+function smarty_function_html_options_optoutput($key, $value, $selected) {
+    if(!is_array($value)) {
+        $_html_result = '&lt;option label=&quot;' . smarty_function_escape_special_chars($value) . '&quot; value=&quot;' .
+            smarty_function_escape_special_chars($key) . '&quot;';
+        if (in_array((string)$key, $selected))
+            $_html_result .= ' selected=&quot;selected&quot;';
+        $_html_result .= '&gt;' . smarty_function_escape_special_chars($value) . '&lt;/option&gt;' . &quot;\n&quot;;
+    } else {
+        $_html_result = smarty_function_html_options_optgroup($key, $value, $selected);
+    }
+    return $_html_result;
+}
+
+function smarty_function_html_options_optgroup($key, $values, $selected) {
+    $optgroup_html = '&lt;optgroup label=&quot;' . smarty_function_escape_special_chars($key) . '&quot;&gt;' . &quot;\n&quot;;
+    foreach ($values as $key =&gt; $value) {
+        $optgroup_html .= smarty_function_html_options_optoutput($key, $value, $selected);
+    }
+    $optgroup_html .= &quot;&lt;/optgroup&gt;\n&quot;;
+    return $optgroup_html;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_radios.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_radios.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_radios.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,145 +1,156 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {html_radios} function plugin
- *
- * File:       function.html_radios.php&lt;br&gt;
- * Type:       function&lt;br&gt;
- * Name:       html_radios&lt;br&gt;
- * Date:       24.Feb.2003&lt;br&gt;
- * Purpose:    Prints out a list of radio input types&lt;br&gt;
- * Input:&lt;br&gt;
- *           - name       (optional) - string default &quot;radio&quot;
- *           - values     (required) - array
- *           - options    (optional) - associative array
- *           - checked    (optional) - array default not set
- *           - separator  (optional) - ie &lt;br&gt; or &nbsp;
- *           - output     (optional) - the output next to each radio button
- *           - assign     (optional) - assign the output as an array to this variable
- * Examples:
- * &lt;pre&gt;
- * {html_radios values=$ids output=$names}
- * {html_radios values=$ids name='box' separator='&lt;br&gt;' output=$names}
- * {html_radios values=$ids checked=$checked separator='&lt;br&gt;' output=$names}
- * &lt;/pre&gt;
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.radios.php">http://smarty.php.net/manual/en/language.function.html.radios.php</A> {html_radios}
- *      (Smarty online manual)
- * @author     Christopher Kvarme &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">christopher.kvarme at flashjab.com</A>&gt;
- * @author credits to Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @version    1.0
- * @param array
- * @param Smarty
- * @return string
- * @uses smarty_function_escape_special_chars()
- */
-function smarty_function_html_radios($params, &amp;$smarty)
-{
-    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
-   
-    $name = 'radio';
-    $values = null;
-    $options = null;
-    $selected = null;
-    $separator = '';
-    $labels = true;
-    $output = null;
-    $extra = '';
-
-    foreach($params as $_key =&gt; $_val) {
-        switch($_key) {
-            case 'name':
-            case 'separator':
-                $$_key = (string)$_val;
-                break;
-
-            case 'checked':
-            case 'selected':
-                if(is_array($_val)) {
-                    $smarty-&gt;trigger_error('html_radios: the &quot;' . $_key . '&quot; attribute cannot be an array', E_USER_WARNING);
-                } else {
-                    $selected = (string)$_val;
-                }
-                break;
-
-            case 'labels':
-                $$_key = (bool)$_val;
-                break;
-
-            case 'options':
-                $$_key = (array)$_val;
-                break;
-
-            case 'values':
-            case 'output':
-                $$_key = array_values((array)$_val);
-                break;
-
-            case 'radios':
-                $smarty-&gt;trigger_error('html_radios: the use of the &quot;radios&quot; attribute is deprecated, use &quot;options&quot; instead', E_USER_WARNING);
-                $options = (array)$_val;
-                break;
-
-            case 'assign':
-                break;
-
-            default:
-                if(!is_array($_val)) {
-                    $extra .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_val).'&quot;';
-                } else {
-                    $smarty-&gt;trigger_error(&quot;html_radios: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
-                }
-                break;
-        }
-    }
-
-    if (!isset($options) &amp;&amp; !isset($values))
-        return ''; /* raise error here? */
-
-    $_html_result = array();
-
-    if (isset($options) &amp;&amp; is_array($options)) {
-
-        foreach ((array)$options as $_key=&gt;$_val)
-            $_html_result[] = smarty_function_html_radios_output($name, $_key, $_val, $selected, $extra, $separator, $labels);
-
-    } else {
-
-        foreach ((array)$values as $_i=&gt;$_key) {
-            $_val = isset($output[$_i]) ? $output[$_i] : '';
-            $_html_result[] = smarty_function_html_radios_output($name, $_key, $_val, $selected, $extra, $separator, $labels);
-        }
-
-    }
-
-    if(!empty($params['assign'])) {
-        $smarty-&gt;assign($params['assign'], $_html_result);
-    } else {
-        return implode(&quot;\n&quot;,$_html_result);
-    }
-
-}
-
-function smarty_function_html_radios_output($name, $value, $output, $selected, $extra, $separator, $labels) {
-    $_output = '';
-    if ($labels) $_output .= '&lt;label&gt;';
-    $_output .= '&lt;input type=&quot;radio&quot; name=&quot;'
-        . smarty_function_escape_special_chars($name) . '&quot; value=&quot;'
-        . smarty_function_escape_special_chars($value) . '&quot;';
-
-    if ($value==$selected) {
-        $_output .= ' checked=&quot;checked&quot;';
-    }
-    $_output .= $extra . ' /&gt;' . $output;
-    if ($labels) $_output .= '&lt;/label&gt;';
-    $_output .=  $separator;
-
-    return $_output;
-}
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {html_radios} function plugin
+ *
+ * File:       function.html_radios.php&lt;br&gt;
+ * Type:       function&lt;br&gt;
+ * Name:       html_radios&lt;br&gt;
+ * Date:       24.Feb.2003&lt;br&gt;
+ * Purpose:    Prints out a list of radio input types&lt;br&gt;
+ * Input:&lt;br&gt;
+ *           - name       (optional) - string default &quot;radio&quot;
+ *           - values     (required) - array
+ *           - options    (optional) - associative array
+ *           - checked    (optional) - array default not set
+ *           - separator  (optional) - ie &lt;br&gt; or &nbsp;
+ *           - output     (optional) - the output next to each radio button
+ *           - assign     (optional) - assign the output as an array to this variable
+ * Examples:
+ * &lt;pre&gt;
+ * {html_radios values=$ids output=$names}
+ * {html_radios values=$ids name='box' separator='&lt;br&gt;' output=$names}
+ * {html_radios values=$ids checked=$checked separator='&lt;br&gt;' output=$names}
+ * &lt;/pre&gt;
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.radios.php">http://smarty.php.net/manual/en/language.function.html.radios.php</A> {html_radios}
+ *      (Smarty online manual)
+ * @author     Christopher Kvarme &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">christopher.kvarme at flashjab.com</A>&gt;
+ * @author credits to Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @version    1.0
+ * @param array
+ * @param Smarty
+ * @return string
+ * @uses smarty_function_escape_special_chars()
+ */
+function smarty_function_html_radios($params, &amp;$smarty)
+{
+    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
+   
+    $name = 'radio';
+    $values = null;
+    $options = null;
+    $selected = null;
+    $separator = '';
+    $labels = true;
+    $label_ids = false;
+    $output = null;
+    $extra = '';
+
+    foreach($params as $_key =&gt; $_val) {
+        switch($_key) {
+            case 'name':
+            case 'separator':
+                $$_key = (string)$_val;
+                break;
+
+            case 'checked':
+            case 'selected':
+                if(is_array($_val)) {
+                    $smarty-&gt;trigger_error('html_radios: the &quot;' . $_key . '&quot; attribute cannot be an array', E_USER_WARNING);
+                } else {
+                    $selected = (string)$_val;
+                }
+                break;
+
+            case 'labels':
+            case 'label_ids':
+                $$_key = (bool)$_val;
+                break;
+
+            case 'options':
+                $$_key = (array)$_val;
+                break;
+
+            case 'values':
+            case 'output':
+                $$_key = array_values((array)$_val);
+                break;
+
+            case 'radios':
+                $smarty-&gt;trigger_error('html_radios: the use of the &quot;radios&quot; attribute is deprecated, use &quot;options&quot; instead', E_USER_WARNING);
+                $options = (array)$_val;
+                break;
+
+            case 'assign':
+                break;
+
+            default:
+                if(!is_array($_val)) {
+                    $extra .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_val).'&quot;';
+                } else {
+                    $smarty-&gt;trigger_error(&quot;html_radios: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
+                }
+                break;
+        }
+    }
+
+    if (!isset($options) &amp;&amp; !isset($values))
+        return ''; /* raise error here? */
+
+    $_html_result = array();
+
+    if (isset($options)) {
+
+        foreach ($options as $_key=&gt;$_val)
+            $_html_result[] = smarty_function_html_radios_output($name, $_key, $_val, $selected, $extra, $separator, $labels, $label_ids);
+
+    } else {
+
+        foreach ($values as $_i=&gt;$_key) {
+            $_val = isset($output[$_i]) ? $output[$_i] : '';
+            $_html_result[] = smarty_function_html_radios_output($name, $_key, $_val, $selected, $extra, $separator, $labels, $label_ids);
+        }
+
+    }
+
+    if(!empty($params['assign'])) {
+        $smarty-&gt;assign($params['assign'], $_html_result);
+    } else {
+        return implode(&quot;\n&quot;,$_html_result);
+    }
+
+}
+
+function smarty_function_html_radios_output($name, $value, $output, $selected, $extra, $separator, $labels, $label_ids) {
+    $_output = '';
+    if ($labels) {
+      if($label_ids) {
+          $_id = smarty_function_escape_special_chars(preg_replace('![^\w\-\.]!', '_', $name . '_' . $value));
+          $_output .= '&lt;label for=&quot;' . $_id . '&quot;&gt;';
+      } else {
+          $_output .= '&lt;label&gt;';           
+      }
+   }
+   $_output .= '&lt;input type=&quot;radio&quot; name=&quot;'
+        . smarty_function_escape_special_chars($name) . '&quot; value=&quot;'
+        . smarty_function_escape_special_chars($value) . '&quot;';
+
+   if ($labels &amp;&amp; $label_ids) $_output .= ' id=&quot;' . $_id . '&quot;';
+
+    if ((string)$value==$selected) {
+        $_output .= ' checked=&quot;checked&quot;';
+    }
+    $_output .= $extra . ' /&gt;' . $output;
+    if ($labels) $_output .= '&lt;/label&gt;';
+    $_output .=  $separator;
+
+    return $_output;
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_select_date.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_select_date.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_select_date.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,312 +1,322 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-/**
- * Smarty {html_select_date} plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     html_select_date&lt;br&gt;
- * Purpose:  Prints the dropdowns for date selection.
- *
- * ChangeLog:&lt;br&gt;
- *           - 1.0 initial release
- *           - 1.1 added support for +/- N syntax for begin
- *                and end year values. (Monte)
- *           - 1.2 added support for yyyy-mm-dd syntax for
- *                time value. (Jan Rosier)
- *           - 1.3 added support for choosing format for
- *                month values (Gary Loescher)
- *           - 1.3.1 added support for choosing format for
- *                day values (Marcus Bointon)
- *           - 1.3.2 suppport negative timestamps, force year
- *             dropdown to include given date unless explicitly set (Monte)
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.select.date.php">http://smarty.php.net/manual/en/language.function.html.select.date.php</A> {html_select_date}
- *      (Smarty online manual)
- * @version 1.3.2
- * @author   Andrei Zmievski
- * @param array
- * @param Smarty
- * @return string
- */
-function smarty_function_html_select_date($params, &amp;$smarty)
-{
-    require_once $smarty-&gt;_get_plugin_filepath('shared','make_timestamp');
-    require_once $smarty-&gt;_get_plugin_filepath('function','html_options');
-    /* Default values. */
-    $prefix          = &quot;Date_&quot;;
-    $start_year      = strftime(&quot;%Y&quot;);
-    $end_year        = $start_year;
-    $display_days    = true;
-    $display_months  = true;
-    $display_years   = true;
-    $month_format    = &quot;%B&quot;;
-    /* Write months as numbers by default  GL */
-    $month_value_format = &quot;%m&quot;;
-    $day_format      = &quot;%02d&quot;;
-    /* Write day values using this format MB */
-    $day_value_format = &quot;%d&quot;;
-    $year_as_text    = false;
-    /* Display years in reverse order? Ie. 2000,1999,.... */
-    $reverse_years   = false;
-    /* Should the select boxes be part of an array when returned from PHP?
-       e.g. setting it to &quot;birthday&quot;, would create &quot;birthday[Day]&quot;,
-       &quot;birthday[Month]&quot; &amp; &quot;birthday[Year]&quot;. Can be combined with prefix */
-    $field_array     = null;
-    /* &lt;select size&gt;'s of the different &lt;select&gt; tags.
-       If not set, uses default dropdown. */
-    $day_size        = null;
-    $month_size      = null;
-    $year_size       = null;
-    /* Unparsed attributes common to *ALL* the &lt;select&gt;/&lt;input&gt; tags.
-       An example might be in the template: all_extra ='class =&quot;foo&quot;'. */
-    $all_extra       = null;
-    /* Separate attributes for the tags. */
-    $day_extra       = null;
-    $month_extra     = null;
-    $year_extra      = null;
-    /* Order in which to display the fields.
-       &quot;D&quot; -&gt; day, &quot;M&quot; -&gt; month, &quot;Y&quot; -&gt; year. */
-    $field_order     = 'MDY';
-    /* String printed between the different fields. */
-    $field_separator = &quot;\n&quot;;
-    $time = time();
-    $all_empty       = null;
-    $day_empty       = null;
-    $month_empty     = null;
-    $year_empty      = null;
-
-    foreach ($params as $_key=&gt;$_value) {
-        switch ($_key) {
-            case 'prefix':
-            case 'time':
-            case 'start_year':
-            case 'end_year':
-            case 'month_format':
-            case 'day_format':
-            case 'day_value_format':
-            case 'field_array':
-            case 'day_size':
-            case 'month_size':
-            case 'year_size':
-            case 'all_extra':
-            case 'day_extra':
-            case 'month_extra':
-            case 'year_extra':
-            case 'field_order':
-            case 'field_separator':
-            case 'month_value_format':
-            case 'month_empty':
-            case 'day_empty':
-            case 'year_empty':
-                $$_key = (string)$_value;
-                break;
-
-            case 'all_empty':
-                $$_key = (string)$_value;
-                $day_empty = $month_empty = $year_empty = $all_empty;
-                break;
-
-            case 'display_days':
-            case 'display_months':
-            case 'display_years':
-            case 'year_as_text':
-            case 'reverse_years':
-                $$_key = (bool)$_value;
-                break;
-
-            default:
-                $smarty-&gt;trigger_error(&quot;[html_select_date] unknown parameter $_key&quot;, E_USER_WARNING);
-
-        }
-    }
-
-    if(preg_match('!^-\d+$!',$time)) {
-        // negative timestamp, use date()
-        $time = date('Y-m-d',$time);
-    }
-    // If $time is not in format yyyy-mm-dd
-    if (!preg_match('/^\d{0,4}-\d{0,2}-\d{0,2}$/', $time)) {
-        // use smarty_make_timestamp to get an unix timestamp and
-        // strftime to make yyyy-mm-dd
-        $time = strftime('%Y-%m-%d', smarty_make_timestamp($time));
-    }
-    // Now split this in pieces, which later can be used to set the select
-    $time = explode(&quot;-&quot;, $time);
-    
-    // make syntax &quot;+N&quot; or &quot;-N&quot; work with start_year and end_year
-    if (preg_match('!^(\+|\-)\s*(\d+)$!', $end_year, $match)) {
-        if ($match[1] == '+') {
-            $end_year = strftime('%Y') + $match[2];
-        } else {
-            $end_year = strftime('%Y') - $match[2];
-        }
-    }
-    if (preg_match('!^(\+|\-)\s*(\d+)$!', $start_year, $match)) {
-        if ($match[1] == '+') {
-            $start_year = strftime('%Y') + $match[2];
-        } else {
-            $start_year = strftime('%Y') - $match[2];
-        }
-    }
-    if($start_year &gt; $time[0] &amp;&amp; !isset($params['start_year'])) {
-        // force start year to include given date if not explicitly set
-        $start_year = $time[0];
-    }
-    if($end_year &lt; $time[0] &amp;&amp; !isset($params['end_year'])) {
-        // force end year to include given date if not explicitly set
-        $end_year = $time[0];
-    }
-
-    $field_order = strtoupper($field_order);
-
-    $html_result = $month_result = $day_result = $year_result = &quot;&quot;;
-
-    if ($display_months) {
-        $month_names = array();
-        $month_values = array();
-        if(isset($month_empty)) {
-            $month_names[''] = $month_empty;
-            $month_values[''] = '';
-        }
-        for ($i = 1; $i &lt;= 12; $i++) {
-            $month_names[$i] = strftime($month_format, mktime(0, 0, 0, $i, 1, 2000));
-            $month_values[$i] = strftime($month_value_format, mktime(0, 0, 0, $i, 1, 2000));
-        }
-
-        $month_result .= '&lt;select name=';
-        if (null !== $field_array){
-            $month_result .= '&quot;' . $field_array . '[' . $prefix . 'Month]&quot;';
-        } else {
-            $month_result .= '&quot;' . $prefix . 'Month&quot;';
-        }
-        if (null !== $month_size){
-            $month_result .= ' size=&quot;' . $month_size . '&quot;';
-        }
-        if (null !== $month_extra){
-            $month_result .= ' ' . $month_extra;
-        }
-        if (null !== $all_extra){
-            $month_result .= ' ' . $all_extra;
-        }
-        $month_result .= '&gt;'.&quot;\n&quot;;
-
-        $month_result .= smarty_function_html_options(array('output'     =&gt; $month_names,
-                                                            'values'     =&gt; $month_values,
-                                                            'selected'   =&gt; $a=$time[1] ? strftime($month_value_format, mktime(0, 0, 0, (int)$time[1], 1, 2000)) : '',
-                                                            'print_result' =&gt; false),
-                                                      $smarty);
-        $month_result .= '&lt;/select&gt;';
-    }
-
-    if ($display_days) {
-        $days = array();
-        if (isset($day_empty)) {
-            $days[''] = $day_empty;
-            $day_values[''] = '';
-        }
-        for ($i = 1; $i &lt;= 31; $i++) {
-            $days[] = sprintf($day_format, $i);
-            $day_values[] = sprintf($day_value_format, $i);
-        }
-
-        $day_result .= '&lt;select name=';
-        if (null !== $field_array){
-            $day_result .= '&quot;' . $field_array . '[' . $prefix . 'Day]&quot;';
-        } else {
-            $day_result .= '&quot;' . $prefix . 'Day&quot;';
-        }
-        if (null !== $day_size){
-            $day_result .= ' size=&quot;' . $day_size . '&quot;';
-        }
-        if (null !== $all_extra){
-            $day_result .= ' ' . $all_extra;
-        }
-        if (null !== $day_extra){
-            $day_result .= ' ' . $day_extra;
-        }
-        $day_result .= '&gt;'.&quot;\n&quot;;
-        $day_result .= smarty_function_html_options(array('output'     =&gt; $days,
-                                                          'values'     =&gt; $day_values,
-                                                          'selected'   =&gt; $time[2],
-                                                          'print_result' =&gt; false),
-                                                    $smarty);
-        $day_result .= '&lt;/select&gt;';
-    }
-
-    if ($display_years) {
-        if (null !== $field_array){
-            $year_name = $field_array . '[' . $prefix . 'Year]';
-        } else {
-            $year_name = $prefix . 'Year';
-        }
-        if ($year_as_text) {
-            $year_result .= '&lt;input type=&quot;text&quot; name=&quot;' . $year_name . '&quot; value=&quot;' . $time[0] . '&quot; size=&quot;4&quot; maxlength=&quot;4&quot;';
-            if (null !== $all_extra){
-                $year_result .= ' ' . $all_extra;
-            }
-            if (null !== $year_extra){
-                $year_result .= ' ' . $year_extra;
-            }
-            $year_result .= '&gt;';
-        } else {
-            $years = range((int)$start_year, (int)$end_year);
-            if ($reverse_years) {
-                rsort($years, SORT_NUMERIC);
-            }
-            $yearvals = $years;
-            if(isset($year_empty)) {
-                array_unshift($years, $year_empty);
-                array_unshift($yearvals, '');
-            }
-            $year_result .= '&lt;select name=&quot;' . $year_name . '&quot;';
-            if (null !== $year_size){
-                $year_result .= ' size=&quot;' . $year_size . '&quot;';
-            }
-            if (null !== $all_extra){
-                $year_result .= ' ' . $all_extra;
-            }
-            if (null !== $year_extra){
-                $year_result .= ' ' . $year_extra;
-            }
-            $year_result .= '&gt;'.&quot;\n&quot;;
-            $year_result .= smarty_function_html_options(array('output' =&gt; $years,
-                                                               'values' =&gt; $yearvals,
-                                                               'selected'   =&gt; $time[0],
-                                                               'print_result' =&gt; false),
-                                                         $smarty);
-            $year_result .= '&lt;/select&gt;';
-        }
-    }
-
-    // Loop thru the field_order field
-    for ($i = 0; $i &lt;= 2; $i++){
-        $c = substr($field_order, $i, 1);
-        switch ($c){
-            case 'D':
-                $html_result .= $day_result;
-                break;
-
-            case 'M':
-                $html_result .= $month_result;
-                break;
-
-            case 'Y':
-                $html_result .= $year_result;
-                break;
-        }
-        // Add the field seperator
-        if($i != 2) {
-            $html_result .= $field_separator;
-        }
-    }
-
-    return $html_result;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+/**
+ * Smarty {html_select_date} plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     html_select_date&lt;br&gt;
+ * Purpose:  Prints the dropdowns for date selection.
+ *
+ * ChangeLog:&lt;br&gt;
+ *           - 1.0 initial release
+ *           - 1.1 added support for +/- N syntax for begin
+ *                and end year values. (Monte)
+ *           - 1.2 added support for yyyy-mm-dd syntax for
+ *                time value. (Jan Rosier)
+ *           - 1.3 added support for choosing format for
+ *                month values (Gary Loescher)
+ *           - 1.3.1 added support for choosing format for
+ *                day values (Marcus Bointon)
+ *           - 1.3.2 suppport negative timestamps, force year
+ *             dropdown to include given date unless explicitly set (Monte)
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.select.date.php">http://smarty.php.net/manual/en/language.function.html.select.date.php</A> {html_select_date}
+ *      (Smarty online manual)
+ * @version 1.3.2
+ * @author   Andrei Zmievski
+ * @param array
+ * @param Smarty
+ * @return string
+ */
+function smarty_function_html_select_date($params, &amp;$smarty)
+{
+    require_once $smarty-&gt;_get_plugin_filepath('shared','escape_special_chars');
+    require_once $smarty-&gt;_get_plugin_filepath('shared','make_timestamp');
+    require_once $smarty-&gt;_get_plugin_filepath('function','html_options');
+    /* Default values. */
+    $prefix          = &quot;Date_&quot;;
+    $start_year      = strftime(&quot;%Y&quot;);
+    $end_year        = $start_year;
+    $display_days    = true;
+    $display_months  = true;
+    $display_years   = true;
+    $month_format    = &quot;%B&quot;;
+    /* Write months as numbers by default  GL */
+    $month_value_format = &quot;%m&quot;;
+    $day_format      = &quot;%02d&quot;;
+    /* Write day values using this format MB */
+    $day_value_format = &quot;%d&quot;;
+    $year_as_text    = false;
+    /* Display years in reverse order? Ie. 2000,1999,.... */
+    $reverse_years   = false;
+    /* Should the select boxes be part of an array when returned from PHP?
+       e.g. setting it to &quot;birthday&quot;, would create &quot;birthday[Day]&quot;,
+       &quot;birthday[Month]&quot; &amp; &quot;birthday[Year]&quot;. Can be combined with prefix */
+    $field_array     = null;
+    /* &lt;select size&gt;'s of the different &lt;select&gt; tags.
+       If not set, uses default dropdown. */
+    $day_size        = null;
+    $month_size      = null;
+    $year_size       = null;
+    /* Unparsed attributes common to *ALL* the &lt;select&gt;/&lt;input&gt; tags.
+       An example might be in the template: all_extra ='class =&quot;foo&quot;'. */
+    $all_extra       = null;
+    /* Separate attributes for the tags. */
+    $day_extra       = null;
+    $month_extra     = null;
+    $year_extra      = null;
+    /* Order in which to display the fields.
+       &quot;D&quot; -&gt; day, &quot;M&quot; -&gt; month, &quot;Y&quot; -&gt; year. */
+    $field_order     = 'MDY';
+    /* String printed between the different fields. */
+    $field_separator = &quot;\n&quot;;
+    $time = time();
+    $all_empty       = null;
+    $day_empty       = null;
+    $month_empty     = null;
+    $year_empty      = null;
+    $extra_attrs     = '';
+
+    foreach ($params as $_key=&gt;$_value) {
+        switch ($_key) {
+            case 'prefix':
+            case 'time':
+            case 'start_year':
+            case 'end_year':
+            case 'month_format':
+            case 'day_format':
+            case 'day_value_format':
+            case 'field_array':
+            case 'day_size':
+            case 'month_size':
+            case 'year_size':
+            case 'all_extra':
+            case 'day_extra':
+            case 'month_extra':
+            case 'year_extra':
+            case 'field_order':
+            case 'field_separator':
+            case 'month_value_format':
+            case 'month_empty':
+            case 'day_empty':
+            case 'year_empty':
+                $$_key = (string)$_value;
+                break;
+
+            case 'all_empty':
+                $$_key = (string)$_value;
+                $day_empty = $month_empty = $year_empty = $all_empty;
+                break;
+
+            case 'display_days':
+            case 'display_months':
+            case 'display_years':
+            case 'year_as_text':
+            case 'reverse_years':
+                $$_key = (bool)$_value;
+                break;
+
+            default:
+                if(!is_array($_value)) {
+                    $extra_attrs .= ' '.$_key.'=&quot;'.smarty_function_escape_special_chars($_value).'&quot;';
+                } else {
+                    $smarty-&gt;trigger_error(&quot;html_select_date: extra attribute '$_key' cannot be an array&quot;, E_USER_NOTICE);
+                }
+                break;
+        }
+    }
+
+    if(preg_match('!^-\d+$!',$time)) {
+        // negative timestamp, use date()
+        $time = date('Y-m-d',$time);
+    }
+    // If $time is not in format yyyy-mm-dd
+    if (!preg_match('/^\d{0,4}-\d{0,2}-\d{0,2}$/', $time)) {
+        // use smarty_make_timestamp to get an unix timestamp and
+        // strftime to make yyyy-mm-dd
+        $time = strftime('%Y-%m-%d', smarty_make_timestamp($time));
+    }
+    // Now split this in pieces, which later can be used to set the select
+    $time = explode(&quot;-&quot;, $time);
+    
+    // make syntax &quot;+N&quot; or &quot;-N&quot; work with start_year and end_year
+    if (preg_match('!^(\+|\-)\s*(\d+)$!', $end_year, $match)) {
+        if ($match[1] == '+') {
+            $end_year = strftime('%Y') + $match[2];
+        } else {
+            $end_year = strftime('%Y') - $match[2];
+        }
+    }
+    if (preg_match('!^(\+|\-)\s*(\d+)$!', $start_year, $match)) {
+        if ($match[1] == '+') {
+            $start_year = strftime('%Y') + $match[2];
+        } else {
+            $start_year = strftime('%Y') - $match[2];
+        }
+    }
+    if (strlen($time[0]) &gt; 0) { 
+        if ($start_year &gt; $time[0] &amp;&amp; !isset($params['start_year'])) {
+            // force start year to include given date if not explicitly set
+            $start_year = $time[0];
+        }
+        if($end_year &lt; $time[0] &amp;&amp; !isset($params['end_year'])) {
+            // force end year to include given date if not explicitly set
+            $end_year = $time[0];
+        }
+    }
+
+    $field_order = strtoupper($field_order);
+
+    $html_result = $month_result = $day_result = $year_result = &quot;&quot;;
+
+    if ($display_months) {
+        $month_names = array();
+        $month_values = array();
+        if(isset($month_empty)) {
+            $month_names[''] = $month_empty;
+            $month_values[''] = '';
+        }
+        for ($i = 1; $i &lt;= 12; $i++) {
+            $month_names[$i] = strftime($month_format, mktime(0, 0, 0, $i, 1, 2000));
+            $month_values[$i] = strftime($month_value_format, mktime(0, 0, 0, $i, 1, 2000));
+        }
+
+        $month_result .= '&lt;select name=';
+        if (null !== $field_array){
+            $month_result .= '&quot;' . $field_array . '[' . $prefix . 'Month]&quot;';
+        } else {
+            $month_result .= '&quot;' . $prefix . 'Month&quot;';
+        }
+        if (null !== $month_size){
+            $month_result .= ' size=&quot;' . $month_size . '&quot;';
+        }
+        if (null !== $month_extra){
+            $month_result .= ' ' . $month_extra;
+        }
+        if (null !== $all_extra){
+            $month_result .= ' ' . $all_extra;
+        }
+        $month_result .= $extra_attrs . '&gt;'.&quot;\n&quot;;
+
+        $month_result .= smarty_function_html_options(array('output'     =&gt; $month_names,
+                                                            'values'     =&gt; $month_values,
+                                                            'selected'   =&gt; (int)$time[1] ? strftime($month_value_format, mktime(0, 0, 0, (int)$time[1], 1, 2000)) : '',
+                                                            'print_result' =&gt; false),
+                                                      $smarty);
+        $month_result .= '&lt;/select&gt;';
+    }
+
+    if ($display_days) {
+        $days = array();
+        if (isset($day_empty)) {
+            $days[''] = $day_empty;
+            $day_values[''] = '';
+        }
+        for ($i = 1; $i &lt;= 31; $i++) {
+            $days[] = sprintf($day_format, $i);
+            $day_values[] = sprintf($day_value_format, $i);
+        }
+
+        $day_result .= '&lt;select name=';
+        if (null !== $field_array){
+            $day_result .= '&quot;' . $field_array . '[' . $prefix . 'Day]&quot;';
+        } else {
+            $day_result .= '&quot;' . $prefix . 'Day&quot;';
+        }
+        if (null !== $day_size){
+            $day_result .= ' size=&quot;' . $day_size . '&quot;';
+        }
+        if (null !== $all_extra){
+            $day_result .= ' ' . $all_extra;
+        }
+        if (null !== $day_extra){
+            $day_result .= ' ' . $day_extra;
+        }
+        $day_result .= $extra_attrs . '&gt;'.&quot;\n&quot;;
+        $day_result .= smarty_function_html_options(array('output'     =&gt; $days,
+                                                          'values'     =&gt; $day_values,
+                                                          'selected'   =&gt; $time[2],
+                                                          'print_result' =&gt; false),
+                                                    $smarty);
+        $day_result .= '&lt;/select&gt;';
+    }
+
+    if ($display_years) {
+        if (null !== $field_array){
+            $year_name = $field_array . '[' . $prefix . 'Year]';
+        } else {
+            $year_name = $prefix . 'Year';
+        }
+        if ($year_as_text) {
+            $year_result .= '&lt;input type=&quot;text&quot; name=&quot;' . $year_name . '&quot; value=&quot;' . $time[0] . '&quot; size=&quot;4&quot; maxlength=&quot;4&quot;';
+            if (null !== $all_extra){
+                $year_result .= ' ' . $all_extra;
+            }
+            if (null !== $year_extra){
+                $year_result .= ' ' . $year_extra;
+            }
+            $year_result .= ' /&gt;';
+        } else {
+            $years = range((int)$start_year, (int)$end_year);
+            if ($reverse_years) {
+                rsort($years, SORT_NUMERIC);
+            } else {
+                sort($years, SORT_NUMERIC);
+            }
+            $yearvals = $years;
+            if(isset($year_empty)) {
+                array_unshift($years, $year_empty);
+                array_unshift($yearvals, '');
+            }
+            $year_result .= '&lt;select name=&quot;' . $year_name . '&quot;';
+            if (null !== $year_size){
+                $year_result .= ' size=&quot;' . $year_size . '&quot;';
+            }
+            if (null !== $all_extra){
+                $year_result .= ' ' . $all_extra;
+            }
+            if (null !== $year_extra){
+                $year_result .= ' ' . $year_extra;
+            }
+            $year_result .= $extra_attrs . '&gt;'.&quot;\n&quot;;
+            $year_result .= smarty_function_html_options(array('output' =&gt; $years,
+                                                               'values' =&gt; $yearvals,
+                                                               'selected'   =&gt; $time[0],
+                                                               'print_result' =&gt; false),
+                                                         $smarty);
+            $year_result .= '&lt;/select&gt;';
+        }
+    }
+
+    // Loop thru the field_order field
+    for ($i = 0; $i &lt;= 2; $i++){
+        $c = substr($field_order, $i, 1);
+        switch ($c){
+            case 'D':
+                $html_result .= $day_result;
+                break;
+
+            case 'M':
+                $html_result .= $month_result;
+                break;
+
+            case 'Y':
+                $html_result .= $year_result;
+                break;
+        }
+        // Add the field seperator
+        if($i != 2) {
+            $html_result .= $field_separator;
+        }
+    }
+
+    return $html_result;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_select_time.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_select_time.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_select_time.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,192 +1,192 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {html_select_time} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     html_select_time&lt;br&gt;
- * Purpose:  Prints the dropdowns for time selection
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.select.time.php">http://smarty.php.net/manual/en/language.function.html.select.time.php</A> {html_select_time}
- *          (Smarty online manual)
- * @param array
- * @param Smarty
- * @return string
- * @uses smarty_make_timestamp()
- */
-function smarty_function_html_select_time($params, &amp;$smarty)
-{
-    require_once $smarty-&gt;_get_plugin_filepath('shared','make_timestamp');
-    require_once $smarty-&gt;_get_plugin_filepath('function','html_options');
-    /* Default values. */
-    $prefix             = &quot;Time_&quot;;
-    $time               = time();
-    $display_hours      = true;
-    $display_minutes    = true;
-    $display_seconds    = true;
-    $display_meridian   = true;
-    $use_24_hours       = true;
-    $minute_interval    = 1;
-    $second_interval    = 1;
-    /* Should the select boxes be part of an array when returned from PHP?
-       e.g. setting it to &quot;birthday&quot;, would create &quot;birthday[Hour]&quot;,
-       &quot;birthday[Minute]&quot;, &quot;birthday[Seconds]&quot; &amp; &quot;birthday[Meridian]&quot;.
-       Can be combined with prefix. */
-    $field_array        = null;
-    $all_extra          = null;
-    $hour_extra         = null;
-    $minute_extra       = null;
-    $second_extra       = null;
-    $meridian_extra     = null;
-
-    foreach ($params as $_key=&gt;$_value) {
-        switch ($_key) {
-            case 'prefix':
-            case 'time':
-            case 'field_array':
-            case 'all_extra':
-            case 'hour_extra':
-            case 'minute_extra':
-            case 'second_extra':
-            case 'meridian_extra':
-                $$_key = (string)$_value;
-                break;
-
-            case 'display_hours':
-            case 'display_minutes':
-            case 'display_seconds':
-            case 'display_meridian':
-            case 'use_24_hours':
-                $$_key = (bool)$_value;
-                break;
-
-            case 'minute_interval':
-            case 'second_interval':
-                $$_key = (int)$_value;
-                break;
-
-            default:
-                $smarty-&gt;trigger_error(&quot;[html_select_time] unknown parameter $_key&quot;, E_USER_WARNING);
-        }
-    }
-
-    $time = smarty_make_timestamp($time);
-
-    $html_result = '';
-
-    if ($display_hours) {
-        $hours       = $use_24_hours ? range(0, 23) : range(1, 12);
-        $hour_fmt = $use_24_hours ? '%H' : '%I';
-        for ($i = 0, $for_max = count($hours); $i &lt; $for_max; $i++)
-            $hours[$i] = sprintf('%02d', $hours[$i]);
-        $html_result .= '&lt;select name=';
-        if (null !== $field_array) {
-            $html_result .= '&quot;' . $field_array . '[' . $prefix . 'Hour]&quot;';
-        } else {
-            $html_result .= '&quot;' . $prefix . 'Hour&quot;';
-        }
-        if (null !== $hour_extra){
-            $html_result .= ' ' . $hour_extra;
-        }
-        if (null !== $all_extra){
-            $html_result .= ' ' . $all_extra;
-        }
-        $html_result .= '&gt;'.&quot;\n&quot;;
-        $html_result .= smarty_function_html_options(array('output'          =&gt; $hours,
-                                                           'values'          =&gt; $hours,
-                                                           'selected'      =&gt; strftime($hour_fmt, $time),
-                                                           'print_result' =&gt; false),
-                                                     $smarty);
-        $html_result .= &quot;&lt;/select&gt;\n&quot;;
-    }
-
-    if ($display_minutes) {
-        $all_minutes = range(0, 59);
-        for ($i = 0, $for_max = count($all_minutes); $i &lt; $for_max; $i+= $minute_interval)
-            $minutes[] = sprintf('%02d', $all_minutes[$i]);
-        $selected = intval(floor(strftime('%M', $time) / $minute_interval) * $minute_interval);
-        $html_result .= '&lt;select name=';
-        if (null !== $field_array) {
-            $html_result .= '&quot;' . $field_array . '[' . $prefix . 'Minute]&quot;';
-        } else {
-            $html_result .= '&quot;' . $prefix . 'Minute&quot;';
-        }
-        if (null !== $minute_extra){
-            $html_result .= ' ' . $minute_extra;
-        }
-        if (null !== $all_extra){
-            $html_result .= ' ' . $all_extra;
-        }
-        $html_result .= '&gt;'.&quot;\n&quot;;
-        
-        $html_result .= smarty_function_html_options(array('output'          =&gt; $minutes,
-                                                           'values'          =&gt; $minutes,
-                                                           'selected'      =&gt; $selected,
-                                                           'print_result' =&gt; false),
-                                                     $smarty);
-        $html_result .= &quot;&lt;/select&gt;\n&quot;;
-    }
-
-    if ($display_seconds) {
-        $all_seconds = range(0, 59);
-        for ($i = 0, $for_max = count($all_seconds); $i &lt; $for_max; $i+= $second_interval)
-            $seconds[] = sprintf('%02d', $all_seconds[$i]);
-        $selected = intval(floor(strftime('%S', $time) / $second_interval) * $second_interval);
-        $html_result .= '&lt;select name=';
-        if (null !== $field_array) {
-            $html_result .= '&quot;' . $field_array . '[' . $prefix . 'Second]&quot;';
-        } else {
-            $html_result .= '&quot;' . $prefix . 'Second&quot;';
-        }
-        
-        if (null !== $second_extra){
-            $html_result .= ' ' . $second_extra;
-        }
-        if (null !== $all_extra){
-            $html_result .= ' ' . $all_extra;
-        }
-        $html_result .= '&gt;'.&quot;\n&quot;;
-        
-        $html_result .= smarty_function_html_options(array('output'          =&gt; $seconds,
-                                                           'values'          =&gt; $seconds,
-                                                           'selected'      =&gt; $selected,
-                                                           'print_result' =&gt; false),
-                                                     $smarty);
-        $html_result .= &quot;&lt;/select&gt;\n&quot;;
-    }
-
-    if ($display_meridian &amp;&amp; !$use_24_hours) {
-        $html_result .= '&lt;select name=';
-        if (null !== $field_array) {
-            $html_result .= '&quot;' . $field_array . '[' . $prefix . 'Meridian]&quot;';
-        } else {
-            $html_result .= '&quot;' . $prefix . 'Meridian&quot;';
-        }
-        
-        if (null !== $meridian_extra){
-            $html_result .= ' ' . $meridian_extra;
-        }
-        if (null !== $all_extra){
-            $html_result .= ' ' . $all_extra;
-        }
-        $html_result .= '&gt;'.&quot;\n&quot;;
-        
-        $html_result .= smarty_function_html_options(array('output'          =&gt; array('AM', 'PM'),
-                                                           'values'          =&gt; array('am', 'pm'),
-                                                           'selected'      =&gt; strtolower(strftime('%p', $time)),
-                                                           'print_result' =&gt; false),
-                                                     $smarty);
-        $html_result .= &quot;&lt;/select&gt;\n&quot;;
-    }
-
-    return $html_result;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {html_select_time} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     html_select_time&lt;br&gt;
+ * Purpose:  Prints the dropdowns for time selection
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.select.time.php">http://smarty.php.net/manual/en/language.function.html.select.time.php</A> {html_select_time}
+ *          (Smarty online manual)
+ * @param array
+ * @param Smarty
+ * @return string
+ * @uses smarty_make_timestamp()
+ */
+function smarty_function_html_select_time($params, &amp;$smarty)
+{
+    require_once $smarty-&gt;_get_plugin_filepath('shared','make_timestamp');
+    require_once $smarty-&gt;_get_plugin_filepath('function','html_options');
+    /* Default values. */
+    $prefix             = &quot;Time_&quot;;
+    $time               = time();
+    $display_hours      = true;
+    $display_minutes    = true;
+    $display_seconds    = true;
+    $display_meridian   = true;
+    $use_24_hours       = true;
+    $minute_interval    = 1;
+    $second_interval    = 1;
+    /* Should the select boxes be part of an array when returned from PHP?
+       e.g. setting it to &quot;birthday&quot;, would create &quot;birthday[Hour]&quot;,
+       &quot;birthday[Minute]&quot;, &quot;birthday[Seconds]&quot; &amp; &quot;birthday[Meridian]&quot;.
+       Can be combined with prefix. */
+    $field_array        = null;
+    $all_extra          = null;
+    $hour_extra         = null;
+    $minute_extra       = null;
+    $second_extra       = null;
+    $meridian_extra     = null;
+
+    foreach ($params as $_key=&gt;$_value) {
+        switch ($_key) {
+            case 'prefix':
+            case 'time':
+            case 'field_array':
+            case 'all_extra':
+            case 'hour_extra':
+            case 'minute_extra':
+            case 'second_extra':
+            case 'meridian_extra':
+                $$_key = (string)$_value;
+                break;
+
+            case 'display_hours':
+            case 'display_minutes':
+            case 'display_seconds':
+            case 'display_meridian':
+            case 'use_24_hours':
+                $$_key = (bool)$_value;
+                break;
+
+            case 'minute_interval':
+            case 'second_interval':
+                $$_key = (int)$_value;
+                break;
+
+            default:
+                $smarty-&gt;trigger_error(&quot;[html_select_time] unknown parameter $_key&quot;, E_USER_WARNING);
+        }
+    }
+
+    $time = smarty_make_timestamp($time);
+
+    $html_result = '';
+
+    if ($display_hours) {
+        $hours       = $use_24_hours ? range(0, 23) : range(1, 12);
+        $hour_fmt = $use_24_hours ? '%H' : '%I';
+        for ($i = 0, $for_max = count($hours); $i &lt; $for_max; $i++)
+            $hours[$i] = sprintf('%02d', $hours[$i]);
+        $html_result .= '&lt;select name=';
+        if (null !== $field_array) {
+            $html_result .= '&quot;' . $field_array . '[' . $prefix . 'Hour]&quot;';
+        } else {
+            $html_result .= '&quot;' . $prefix . 'Hour&quot;';
+        }
+        if (null !== $hour_extra){
+            $html_result .= ' ' . $hour_extra;
+        }
+        if (null !== $all_extra){
+            $html_result .= ' ' . $all_extra;
+        }
+        $html_result .= '&gt;'.&quot;\n&quot;;
+        $html_result .= smarty_function_html_options(array('output'          =&gt; $hours,
+                                                           'values'          =&gt; $hours,
+                                                           'selected'      =&gt; strftime($hour_fmt, $time),
+                                                           'print_result' =&gt; false),
+                                                     $smarty);
+        $html_result .= &quot;&lt;/select&gt;\n&quot;;
+    }
+
+    if ($display_minutes) {
+        $all_minutes = range(0, 59);
+        for ($i = 0, $for_max = count($all_minutes); $i &lt; $for_max; $i+= $minute_interval)
+            $minutes[] = sprintf('%02d', $all_minutes[$i]);
+        $selected = intval(floor(strftime('%M', $time) / $minute_interval) * $minute_interval);
+        $html_result .= '&lt;select name=';
+        if (null !== $field_array) {
+            $html_result .= '&quot;' . $field_array . '[' . $prefix . 'Minute]&quot;';
+        } else {
+            $html_result .= '&quot;' . $prefix . 'Minute&quot;';
+        }
+        if (null !== $minute_extra){
+            $html_result .= ' ' . $minute_extra;
+        }
+        if (null !== $all_extra){
+            $html_result .= ' ' . $all_extra;
+        }
+        $html_result .= '&gt;'.&quot;\n&quot;;
+        
+        $html_result .= smarty_function_html_options(array('output'          =&gt; $minutes,
+                                                           'values'          =&gt; $minutes,
+                                                           'selected'      =&gt; $selected,
+                                                           'print_result' =&gt; false),
+                                                     $smarty);
+        $html_result .= &quot;&lt;/select&gt;\n&quot;;
+    }
+
+    if ($display_seconds) {
+        $all_seconds = range(0, 59);
+        for ($i = 0, $for_max = count($all_seconds); $i &lt; $for_max; $i+= $second_interval)
+            $seconds[] = sprintf('%02d', $all_seconds[$i]);
+        $selected = intval(floor(strftime('%S', $time) / $second_interval) * $second_interval);
+        $html_result .= '&lt;select name=';
+        if (null !== $field_array) {
+            $html_result .= '&quot;' . $field_array . '[' . $prefix . 'Second]&quot;';
+        } else {
+            $html_result .= '&quot;' . $prefix . 'Second&quot;';
+        }
+        
+        if (null !== $second_extra){
+            $html_result .= ' ' . $second_extra;
+        }
+        if (null !== $all_extra){
+            $html_result .= ' ' . $all_extra;
+        }
+        $html_result .= '&gt;'.&quot;\n&quot;;
+        
+        $html_result .= smarty_function_html_options(array('output'          =&gt; $seconds,
+                                                           'values'          =&gt; $seconds,
+                                                           'selected'      =&gt; $selected,
+                                                           'print_result' =&gt; false),
+                                                     $smarty);
+        $html_result .= &quot;&lt;/select&gt;\n&quot;;
+    }
+
+    if ($display_meridian &amp;&amp; !$use_24_hours) {
+        $html_result .= '&lt;select name=';
+        if (null !== $field_array) {
+            $html_result .= '&quot;' . $field_array . '[' . $prefix . 'Meridian]&quot;';
+        } else {
+            $html_result .= '&quot;' . $prefix . 'Meridian&quot;';
+        }
+        
+        if (null !== $meridian_extra){
+            $html_result .= ' ' . $meridian_extra;
+        }
+        if (null !== $all_extra){
+            $html_result .= ' ' . $all_extra;
+        }
+        $html_result .= '&gt;'.&quot;\n&quot;;
+        
+        $html_result .= smarty_function_html_options(array('output'          =&gt; array('AM', 'PM'),
+                                                           'values'          =&gt; array('am', 'pm'),
+                                                           'selected'      =&gt; strtolower(strftime('%p', $time)),
+                                                           'print_result' =&gt; false),
+                                                     $smarty);
+        $html_result .= &quot;&lt;/select&gt;\n&quot;;
+    }
+
+    return $html_result;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_table.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_table.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.html_table.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,136 +1,137 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {html_table} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     html_table&lt;br&gt;
- * Date:     Feb 17, 2003&lt;br&gt;
- * Purpose:  make an html table from an array of data&lt;br&gt;
- * Input:&lt;br&gt;
- *         - loop = array to loop through
- *         - cols = number of columns
- *         - rows = number of rows
- *         - table_attr = table attributes
- *         - tr_attr = table row attributes (arrays are cycled)
- *         - td_attr = table cell attributes (arrays are cycled)
- *         - trailpad = value to pad trailing cells with
- *         - vdir = vertical direction (default: &quot;down&quot;, means top-to-bottom)
- *         - hdir = horizontal direction (default: &quot;right&quot;, means left-to-right)
- *         - inner = inner loop (default &quot;cols&quot;: print $loop line by line,
- *                   $loop will be printed column by column otherwise)
- *
- *
- * Examples:
- * &lt;pre&gt;
- * {table loop=$data}
- * {table loop=$data cols=4 tr_attr='&quot;bgcolor=red&quot;'}
- * {table loop=$data cols=4 tr_attr=$colors}
- * &lt;/pre&gt;
- * @author   Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @version  1.0
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.table.php">http://smarty.php.net/manual/en/language.function.html.table.php</A> {html_table}
- *          (Smarty online manual)
- * @param array
- * @param Smarty
- * @return string
- */
-function smarty_function_html_table($params, &amp;$smarty)
-{
-    $table_attr = 'border=&quot;1&quot;';
-    $tr_attr = '';
-    $td_attr = '';
-    $cols = 3;
-    $rows = 3;
-    $trailpad = '&nbsp;';
-    $vdir = 'down';
-    $hdir = 'right';
-    $inner = 'cols';
-
-    if (!isset($params['loop'])) {
-        $smarty-&gt;trigger_error(&quot;html_table: missing 'loop' parameter&quot;);
-        return;
-    }
-
-    foreach ($params as $_key=&gt;$_value) {
-        switch ($_key) {
-            case 'loop':
-                $$_key = (array)$_value;
-                break;
-
-            case 'cols':
-            case 'rows':
-                $$_key = (int)$_value;
-                break;
-
-            case 'table_attr':
-            case 'trailpad':
-            case 'hdir':
-            case 'vdir':
-                $$_key = (string)$_value;
-                break;
-
-            case 'tr_attr':
-            case 'td_attr':
-                $$_key = $_value;
-                break;
-        }
-    }
-
-    $loop_count = count($loop);
-    if (empty($params['rows'])) {
-        /* no rows specified */
-        $rows = ceil($loop_count/$cols);
-    } elseif (empty($params['cols'])) {
-        if (!empty($params['rows'])) {
-            /* no cols specified, but rows */
-            $cols = ceil($loop_count/$rows);
-        }
-    }
-
-    $output = &quot;&lt;table $table_attr&gt;\n&quot;;
-
-    for ($r=0; $r&lt;$rows; $r++) {
-        $output .= &quot;&lt;tr&quot; . smarty_function_html_table_cycle('tr', $tr_attr, $r) . &quot;&gt;\n&quot;;
-        $rx =  ($vdir == 'down') ? $r*$cols : ($rows-1-$r)*$cols;
-
-        for ($c=0; $c&lt;$cols; $c++) {
-            $x =  ($hdir == 'right') ? $rx+$c : $rx+$cols-1-$c;
-            if ($inner!='cols') {
-                /* shuffle x to loop over rows*/
-                $x = floor($x/$cols) + ($x%$cols)*$rows;
-            }
-
-            if ($x&lt;$loop_count) {
-                $output .= &quot;&lt;td&quot; . smarty_function_html_table_cycle('td', $td_attr, $c) . &quot;&gt;&quot; . $loop[$x] . &quot;&lt;/td&gt;\n&quot;;
-            } else {
-                $output .= &quot;&lt;td&quot; . smarty_function_html_table_cycle('td', $td_attr, $c) . &quot;&gt;$trailpad&lt;/td&gt;\n&quot;;
-            }
-        }
-        $output .= &quot;&lt;/tr&gt;\n&quot;;
-    }
-    $output .= &quot;&lt;/table&gt;\n&quot;;
-    
-    return $output;
-}
-
-function smarty_function_html_table_cycle($name, $var, $no) {
-    if(!is_array($var)) {
-        $ret = $var;
-    } else {
-        $ret = $var[$no % count($var)];
-    }
-    
-    return ($ret) ? ' '.$ret : '';
-}
-
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {html_table} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     html_table&lt;br&gt;
+ * Date:     Feb 17, 2003&lt;br&gt;
+ * Purpose:  make an html table from an array of data&lt;br&gt;
+ * Input:&lt;br&gt;
+ *         - loop = array to loop through
+ *         - cols = number of columns
+ *         - rows = number of rows
+ *         - table_attr = table attributes
+ *         - tr_attr = table row attributes (arrays are cycled)
+ *         - td_attr = table cell attributes (arrays are cycled)
+ *         - trailpad = value to pad trailing cells with
+ *         - vdir = vertical direction (default: &quot;down&quot;, means top-to-bottom)
+ *         - hdir = horizontal direction (default: &quot;right&quot;, means left-to-right)
+ *         - inner = inner loop (default &quot;cols&quot;: print $loop line by line,
+ *                   $loop will be printed column by column otherwise)
+ *
+ *
+ * Examples:
+ * &lt;pre&gt;
+ * {table loop=$data}
+ * {table loop=$data cols=4 tr_attr='&quot;bgcolor=red&quot;'}
+ * {table loop=$data cols=4 tr_attr=$colors}
+ * &lt;/pre&gt;
+ * @author   Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @version  1.0
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.html.table.php">http://smarty.php.net/manual/en/language.function.html.table.php</A> {html_table}
+ *          (Smarty online manual)
+ * @param array
+ * @param Smarty
+ * @return string
+ */
+function smarty_function_html_table($params, &amp;$smarty)
+{
+    $table_attr = 'border=&quot;1&quot;';
+    $tr_attr = '';
+    $td_attr = '';
+    $cols = 3;
+    $rows = 3;
+    $trailpad = '&nbsp;';
+    $vdir = 'down';
+    $hdir = 'right';
+    $inner = 'cols';
+
+    if (!isset($params['loop'])) {
+        $smarty-&gt;trigger_error(&quot;html_table: missing 'loop' parameter&quot;);
+        return;
+    }
+
+    foreach ($params as $_key=&gt;$_value) {
+        switch ($_key) {
+            case 'loop':
+                $$_key = (array)$_value;
+                break;
+
+            case 'cols':
+            case 'rows':
+                $$_key = (int)$_value;
+                break;
+
+            case 'table_attr':
+            case 'trailpad':
+            case 'hdir':
+            case 'vdir':
+            case 'inner':
+                $$_key = (string)$_value;
+                break;
+
+            case 'tr_attr':
+            case 'td_attr':
+                $$_key = $_value;
+                break;
+        }
+    }
+
+    $loop_count = count($loop);
+    if (empty($params['rows'])) {
+        /* no rows specified */
+        $rows = ceil($loop_count/$cols);
+    } elseif (empty($params['cols'])) {
+        if (!empty($params['rows'])) {
+            /* no cols specified, but rows */
+            $cols = ceil($loop_count/$rows);
+        }
+    }
+
+    $output = &quot;&lt;table $table_attr&gt;\n&quot;;
+
+    for ($r=0; $r&lt;$rows; $r++) {
+        $output .= &quot;&lt;tr&quot; . smarty_function_html_table_cycle('tr', $tr_attr, $r) . &quot;&gt;\n&quot;;
+        $rx =  ($vdir == 'down') ? $r*$cols : ($rows-1-$r)*$cols;
+
+        for ($c=0; $c&lt;$cols; $c++) {
+            $x =  ($hdir == 'right') ? $rx+$c : $rx+$cols-1-$c;
+            if ($inner!='cols') {
+                /* shuffle x to loop over rows*/
+                $x = floor($x/$cols) + ($x%$cols)*$rows;
+            }
+
+            if ($x&lt;$loop_count) {
+                $output .= &quot;&lt;td&quot; . smarty_function_html_table_cycle('td', $td_attr, $c) . &quot;&gt;&quot; . $loop[$x] . &quot;&lt;/td&gt;\n&quot;;
+            } else {
+                $output .= &quot;&lt;td&quot; . smarty_function_html_table_cycle('td', $td_attr, $c) . &quot;&gt;$trailpad&lt;/td&gt;\n&quot;;
+            }
+        }
+        $output .= &quot;&lt;/tr&gt;\n&quot;;
+    }
+    $output .= &quot;&lt;/table&gt;\n&quot;;
+    
+    return $output;
+}
+
+function smarty_function_html_table_cycle($name, $var, $no) {
+    if(!is_array($var)) {
+        $ret = $var;
+    } else {
+        $ret = $var[$no % count($var)];
+    }
+    
+    return ($ret) ? ' '.$ret : '';
+}
+
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.mailto.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.mailto.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.mailto.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,143 +1,163 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {mailto} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     mailto&lt;br&gt;
- * Date:     May 21, 2002
- * Purpose:  automate mailto address link creation, and optionally
- *           encode them.&lt;br&gt;
- * Input:&lt;br&gt;
- *         - address = e-mail address
- *         - text = (optional) text to display, default is address
- *         - encode = (optional) can be one of:
- *                * none : no encoding (default)
- *                * javascript : encode with javascript
- *                * hex : encode with hexidecimal (no javascript)
- *         - cc = (optional) address(es) to carbon copy
- *         - bcc = (optional) address(es) to blind carbon copy
- *         - subject = (optional) e-mail subject
- *         - newsgroups = (optional) newsgroup(s) to post to
- *         - followupto = (optional) address(es) to follow up to
- *         - extra = (optional) extra tags for the href link
- *
- * Examples:
- * &lt;pre&gt;
- * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot;}
- * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; encode=&quot;javascript&quot;}
- * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; encode=&quot;hex&quot;}
- * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; subject=&quot;Hello to you!&quot;}
- * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; cc=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">you at domain.com</A><A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">,they at domain.com</A>&quot;}
- * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; extra='class=&quot;mailto&quot;'}
- * &lt;/pre&gt;
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.mailto.php">http://smarty.php.net/manual/en/language.function.mailto.php</A> {mailto}
- *          (Smarty online manual)
- * @version  1.2
- * @author   Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @author   credits to Jason Sweat (added cc, bcc and subject functionality)
- * @param    array
- * @param    Smarty
- * @return   string
- */
-function smarty_function_mailto($params, &amp;$smarty)
-{
-    $extra = '';
-
-    if (empty($params['address'])) {
-        $smarty-&gt;trigger_error(&quot;mailto: missing 'address' parameter&quot;);
-        return;
-    } else {
-        $address = $params['address'];
-    }
-
-    $text = $address;
-
-    // netscape and mozilla do not decode %40 (@) in BCC field (bug?)
-    // so, don't encode it.
-    $mail_parms = array();
-    foreach ($params as $var=&gt;$value) {
-        switch ($var) {
-            case 'cc':
-            case 'bcc':
-            case 'followupto':
-                if (!empty($value))
-                    $mail_parms[] = $var.'='.str_replace('%40','@',rawurlencode($value));
-                break;
-                
-            case 'subject':
-            case 'newsgroups':
-                $mail_parms[] = $var.'='.rawurlencode($value);
-                break;
-
-            case 'extra':
-            case 'text':
-                $$var = $value;
-
-            default:
-        }
-    }
-
-    $mail_parm_vals = '';
-    for ($i=0; $i&lt;count($mail_parms); $i++) {
-        $mail_parm_vals .= (0==$i) ? '?' : '&amp;';
-        $mail_parm_vals .= $mail_parms[$i];
-    }
-    $address .= $mail_parm_vals;
-
-    $encode = (empty($params['encode'])) ? 'none' : $params['encode'];
-    if (!in_array($encode,array('javascript','hex','none')) ) {
-        $smarty-&gt;trigger_error(&quot;mailto: 'encode' parameter must be none, javascript or hex&quot;);
-        return;
-    }
-
-    if ($encode == 'javascript' ) {
-        $string = 'document.write(\'&lt;a href=&quot;mailto:'.$address.'&quot; '.$extra.'&gt;'.$text.'&lt;/a&gt;\');';
-
-        $js_encode = '';
-        for ($x=0; $x &lt; strlen($string); $x++) {
-            $js_encode .= '%' . bin2hex($string[$x]);
-        }
-
-        return '&lt;script type=&quot;text/javascript&quot;&gt;eval(unescape(\''.$js_encode.'\'))&lt;/script&gt;';
-
-    } elseif ($encode == 'hex') {
-
-        preg_match('!^(.*)(\?.*)$!',$address,$match);
-        if(!empty($match[2])) {
-            $smarty-&gt;trigger_error(&quot;mailto: hex encoding does not work with extra attributes. Try javascript.&quot;);
-            return;
-        }
-        $address_encode = '';
-        for ($x=0; $x &lt; strlen($address); $x++) {
-            if(preg_match('!\w!',$address[$x])) {
-                $address_encode .= '%' . bin2hex($address[$x]);
-            } else {
-                $address_encode .= $address[$x];
-            }
-        }
-        $text_encode = '';
-        for ($x=0; $x &lt; strlen($text); $x++) {
-            $text_encode .= '&amp;#x' . bin2hex($text[$x]).';';
-        }
-
-        $mailto = &quot;&#109;&#97;&#105;&#108;&#116;&#111;&#58;&quot;;
-        return '&lt;a href=&quot;'.$mailto.$address_encode.'&quot; '.$extra.'&gt;'.$text_encode.'&lt;/a&gt;';
-
-    } else {
-        // no encoding
-        return '&lt;a href=&quot;mailto:'.$address.'&quot; '.$extra.'&gt;'.$text.'&lt;/a&gt;';
-
-    }
-
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {mailto} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     mailto&lt;br&gt;
+ * Date:     May 21, 2002
+ * Purpose:  automate mailto address link creation, and optionally
+ *           encode them.&lt;br&gt;
+ * Input:&lt;br&gt;
+ *         - address = e-mail address
+ *         - text = (optional) text to display, default is address
+ *         - encode = (optional) can be one of:
+ *                * none : no encoding (default)
+ *                * javascript : encode with javascript
+ *                * javascript_charcode : encode with javascript charcode
+ *                * hex : encode with hexidecimal (no javascript)
+ *         - cc = (optional) address(es) to carbon copy
+ *         - bcc = (optional) address(es) to blind carbon copy
+ *         - subject = (optional) e-mail subject
+ *         - newsgroups = (optional) newsgroup(s) to post to
+ *         - followupto = (optional) address(es) to follow up to
+ *         - extra = (optional) extra tags for the href link
+ *
+ * Examples:
+ * &lt;pre&gt;
+ * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot;}
+ * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; encode=&quot;javascript&quot;}
+ * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; encode=&quot;hex&quot;}
+ * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; subject=&quot;Hello to you!&quot;}
+ * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; cc=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">you at domain.com</A><A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">,they at domain.com</A>&quot;}
+ * {mailto address=&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">me at domain.com</A>&quot; extra='class=&quot;mailto&quot;'}
+ * &lt;/pre&gt;
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.mailto.php">http://smarty.php.net/manual/en/language.function.mailto.php</A> {mailto}
+ *          (Smarty online manual)
+ * @version  1.2
+ * @author   Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @author   credits to Jason Sweat (added cc, bcc and subject functionality)
+ * @param    array
+ * @param    Smarty
+ * @return   string
+ */
+function smarty_function_mailto($params, &amp;$smarty)
+{
+    $extra = '';
+
+    if (empty($params['address'])) {
+        $smarty-&gt;trigger_error(&quot;mailto: missing 'address' parameter&quot;);
+        return;
+    } else {
+        $address = $params['address'];
+    }
+
+    $text = $address;
+
+    // netscape and mozilla do not decode %40 (@) in BCC field (bug?)
+    // so, don't encode it.
+    $mail_parms = array();
+    foreach ($params as $var=&gt;$value) {
+        switch ($var) {
+            case 'cc':
+            case 'bcc':
+            case 'followupto':
+                if (!empty($value))
+                    $mail_parms[] = $var.'='.str_replace('%40','@',rawurlencode($value));
+                break;
+                
+            case 'subject':
+            case 'newsgroups':
+                $mail_parms[] = $var.'='.rawurlencode($value);
+                break;
+
+            case 'extra':
+            case 'text':
+                $$var = $value;
+
+            default:
+        }
+    }
+
+    $mail_parm_vals = '';
+    for ($i=0; $i&lt;count($mail_parms); $i++) {
+        $mail_parm_vals .= (0==$i) ? '?' : '&amp;';
+        $mail_parm_vals .= $mail_parms[$i];
+    }
+    $address .= $mail_parm_vals;
+
+    $encode = (empty($params['encode'])) ? 'none' : $params['encode'];
+    if (!in_array($encode,array('javascript','javascript_charcode','hex','none')) ) {
+        $smarty-&gt;trigger_error(&quot;mailto: 'encode' parameter must be none, javascript or hex&quot;);
+        return;
+    }
+
+    if ($encode == 'javascript' ) {
+        $string = 'document.write(\'&lt;a href=&quot;mailto:'.$address.'&quot; '.$extra.'&gt;'.$text.'&lt;/a&gt;\');';
+
+        $js_encode = '';
+        for ($x=0; $x &lt; strlen($string); $x++) {
+            $js_encode .= '%' . bin2hex($string[$x]);
+        }
+
+        return '&lt;script type=&quot;text/javascript&quot;&gt;eval(unescape(\''.$js_encode.'\'))&lt;/script&gt;';
+
+    } elseif ($encode == 'javascript_charcode' ) {
+        $string = '&lt;a href=&quot;mailto:'.$address.'&quot; '.$extra.'&gt;'.$text.'&lt;/a&gt;';
+
+        for($x = 0, $y = strlen($string); $x &lt; $y; $x++ ) {
+            $ord[] = ord($string[$x]);   
+        }
+
+        $_ret = &quot;&lt;script type=\&quot;text/javascript\&quot; language=\&quot;javascript\&quot;&gt;\n&quot;;
+        $_ret .= &quot;&lt;!--\n&quot;;
+        $_ret .= &quot;{document.write(String.fromCharCode(&quot;;
+        $_ret .= implode(',',$ord);
+        $_ret .= &quot;))&quot;;
+        $_ret .= &quot;}\n&quot;;
+        $_ret .= &quot;//--&gt;\n&quot;;
+        $_ret .= &quot;&lt;/script&gt;\n&quot;;
+        
+        return $_ret;
+        
+        
+    } elseif ($encode == 'hex') {
+
+        preg_match('!^(.*)(\?.*)$!',$address,$match);
+        if(!empty($match[2])) {
+            $smarty-&gt;trigger_error(&quot;mailto: hex encoding does not work with extra attributes. Try javascript.&quot;);
+            return;
+        }
+        $address_encode = '';
+        for ($x=0; $x &lt; strlen($address); $x++) {
+            if(preg_match('!\w!',$address[$x])) {
+                $address_encode .= '%' . bin2hex($address[$x]);
+            } else {
+                $address_encode .= $address[$x];
+            }
+        }
+        $text_encode = '';
+        for ($x=0; $x &lt; strlen($text); $x++) {
+            $text_encode .= '&amp;#x' . bin2hex($text[$x]).';';
+        }
+
+        $mailto = &quot;&#109;&#97;&#105;&#108;&#116;&#111;&#58;&quot;;
+        return '&lt;a href=&quot;'.$mailto.$address_encode.'&quot; '.$extra.'&gt;'.$text_encode.'&lt;/a&gt;';
+
+    } else {
+        // no encoding
+        return '&lt;a href=&quot;mailto:'.$address.'&quot; '.$extra.'&gt;'.$text.'&lt;/a&gt;';
+
+    }
+
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.math.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.math.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.math.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,82 +1,83 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {math} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     math&lt;br&gt;
- * Purpose:  handle math computations in template&lt;br&gt;
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.math.php">http://smarty.php.net/manual/en/language.function.math.php</A> {math}
- *          (Smarty online manual)
- * @param array
- * @param Smarty
- * @return string
- */
-function smarty_function_math($params, &amp;$smarty)
-{
-    // be sure equation parameter is present
-    if (empty($params['equation'])) {
-        $smarty-&gt;trigger_error(&quot;math: missing equation parameter&quot;);
-        return;
-    }
-
-    $equation = $params['equation'];
-
-    // make sure parenthesis are balanced
-    if (substr_count($equation,&quot;(&quot;) != substr_count($equation,&quot;)&quot;)) {
-        $smarty-&gt;trigger_error(&quot;math: unbalanced parenthesis&quot;);
-        return;
-    }
-
-    // match all vars in equation, make sure all are passed
-    preg_match_all(&quot;!\!(0x)([a-zA-Z][a-zA-Z0-9_]*)!&quot;,$equation, $match);
-    $allowed_funcs = array('int','abs','ceil','cos','exp','floor','log','log10',
-                           'max','min','pi','pow','rand','round','sin','sqrt','srand','tan');
-    foreach($match[2] as $curr_var) {
-        if (!in_array($curr_var,array_keys($params)) &amp;&amp; !in_array($curr_var, $allowed_funcs)) {
-            $smarty-&gt;trigger_error(&quot;math: parameter $curr_var not passed as argument&quot;);
-            return;
-        }
-    }
-
-    foreach($params as $key =&gt; $val) {
-        if ($key != &quot;equation&quot; &amp;&amp; $key != &quot;format&quot; &amp;&amp; $key != &quot;assign&quot;) {
-            // make sure value is not empty
-            if (strlen($val)==0) {
-                $smarty-&gt;trigger_error(&quot;math: parameter $key is empty&quot;);
-                return;
-            }
-            if (!is_numeric($val)) {
-                $smarty-&gt;trigger_error(&quot;math: parameter $key: is not numeric&quot;);
-                return;
-            }
-            $equation = preg_replace(&quot;/\b$key\b/&quot;,$val, $equation);
-        }
-    }
-
-    eval(&quot;\$smarty_math_result = &quot;.$equation.&quot;;&quot;);
-
-    if (empty($params['format'])) {
-        if (empty($params['assign'])) {
-            return $smarty_math_result;
-        } else {
-            $smarty-&gt;assign($params['assign'],$smarty_math_result);
-        }
-    } else {
-        if (empty($params['assign'])){
-            printf($params['format'],$smarty_math_result);
-        } else {
-            $smarty-&gt;assign($params['assign'],sprintf($params['format'],$smarty_math_result));
-        }
-    }
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {math} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     math&lt;br&gt;
+ * Purpose:  handle math computations in template&lt;br&gt;
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.math.php">http://smarty.php.net/manual/en/language.function.math.php</A> {math}
+ *          (Smarty online manual)
+ * @param array
+ * @param Smarty
+ * @return string
+ */
+function smarty_function_math($params, &amp;$smarty)
+{
+    // be sure equation parameter is present
+    if (empty($params['equation'])) {
+        $smarty-&gt;trigger_error(&quot;math: missing equation parameter&quot;);
+        return;
+    }
+
+    $equation = $params['equation'];
+
+    // make sure parenthesis are balanced
+    if (substr_count($equation,&quot;(&quot;) != substr_count($equation,&quot;)&quot;)) {
+        $smarty-&gt;trigger_error(&quot;math: unbalanced parenthesis&quot;);
+        return;
+    }
+
+    // match all vars in equation, make sure all are passed
+    preg_match_all(&quot;!(?:0x[a-fA-F0-9]+)|([a-zA-Z][a-zA-Z0-9_]+)!&quot;,$equation, $match);
+    $allowed_funcs = array('int','abs','ceil','cos','exp','floor','log','log10',
+                           'max','min','pi','pow','rand','round','sin','sqrt','srand','tan');
+    
+    foreach($match[1] as $curr_var) {
+        if ($curr_var &amp;&amp; !in_array($curr_var, array_keys($params)) &amp;&amp; !in_array($curr_var, $allowed_funcs)) {
+            $smarty-&gt;trigger_error(&quot;math: function call $curr_var not allowed&quot;);
+            return;
+        }
+    }
+
+    foreach($params as $key =&gt; $val) {
+        if ($key != &quot;equation&quot; &amp;&amp; $key != &quot;format&quot; &amp;&amp; $key != &quot;assign&quot;) {
+            // make sure value is not empty
+            if (strlen($val)==0) {
+                $smarty-&gt;trigger_error(&quot;math: parameter $key is empty&quot;);
+                return;
+            }
+            if (!is_numeric($val)) {
+                $smarty-&gt;trigger_error(&quot;math: parameter $key: is not numeric&quot;);
+                return;
+            }
+            $equation = preg_replace(&quot;/\b$key\b/&quot;,$val, $equation);
+        }
+    }
+
+    eval(&quot;\$smarty_math_result = &quot;.$equation.&quot;;&quot;);
+
+    if (empty($params['format'])) {
+        if (empty($params['assign'])) {
+            return $smarty_math_result;
+        } else {
+            $smarty-&gt;assign($params['assign'],$smarty_math_result);
+        }
+    } else {
+        if (empty($params['assign'])){
+            printf($params['format'],$smarty_math_result);
+        } else {
+            $smarty-&gt;assign($params['assign'],sprintf($params['format'],$smarty_math_result));
+        }
+    }
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.popup.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.popup.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.popup.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,110 +1,117 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {popup} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     popup&lt;br&gt;
- * Purpose:  make text pop up in windows via overlib
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.popup.php">http://smarty.php.net/manual/en/language.function.popup.php</A> {popup}
- *          (Smarty online manual)
- * @param array
- * @param Smarty
- * @return string
- */
-function smarty_function_popup($params, &amp;$smarty)
-{
-    $append = '';
-    foreach ($params as $_key=&gt;$_value) {
-        switch ($_key) {
-            case 'text':
-            case 'trigger':
-                $$_key = (string)$_value;
-                break;
-
-            case 'caption':
-            case 'closetext':
-            case 'status':
-                $append .= ',' . strtoupper($_key) . &quot;,'&quot; . str_replace(&quot;'&quot;,&quot;\'&quot;,$_value) . &quot;'&quot;;
-                break;
-
-            case 'fgcolor':
-            case 'bgcolor':
-            case 'textcolor':
-            case 'capcolor':
-            case 'closecolor':
-            case 'textfont':
-            case 'captionfont':
-            case 'closefont':
-            case 'fgbackground':
-            case 'bgbackground':
-            case 'inarray':
-            case 'caparray':
-            case 'capicon':
-            case 'background':
-            case 'frame':
-            case 'function':
-                $append .= ',' . strtoupper($_key) . &quot;,'$_value'&quot;;
-                break;
-
-            case 'textsize':
-            case 'captionsize':
-            case 'closesize':
-            case 'width':
-            case 'height':
-            case 'border':
-            case 'offsetx':
-            case 'offsety':
-            case 'snapx':
-            case 'snapy':
-            case 'fixx':
-            case 'fixy':
-            case 'padx':
-            case 'pady':
-            case 'timeout':
-            case 'delay':
-                $append .= ',' . strtoupper($_key) . &quot;,$_value&quot;;
-                break;
-
-            case 'sticky':
-            case 'left':
-            case 'right':
-            case 'center':
-            case 'above':
-            case 'below':
-            case 'noclose':
-            case 'autostatus':
-            case 'autostatuscap':
-            case 'fullhtml':
-            case 'hauto':
-            case 'vauto':
-                if ($_value) $append .= ',' . strtoupper($_key);
-                break;
-
-            default:
-                $smarty-&gt;trigger_error(&quot;[popup] unknown parameter $_key&quot;, E_USER_WARNING);
-        }
-    }
-
-    if (empty($text) &amp;&amp; !isset($inarray) &amp;&amp; empty($function)) {
-        $smarty-&gt;trigger_error(&quot;overlib: attribute 'text' or 'inarray' or 'function' required&quot;);
-        return false;
-    }
-
-    if (empty($trigger)) { $trigger = &quot;onmouseover&quot;; }
-
-    $retval = $trigger . '=&quot;return overlib(\''.preg_replace(array(&quot;!'!&quot;,&quot;![\r\n]!&quot;),array(&quot;\'&quot;,'\r'),$text).'\'';
-    $retval .= $append . ');&quot; onmouseout=&quot;nd();&quot;';
-
-    return $retval;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {popup} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     popup&lt;br&gt;
+ * Purpose:  make text pop up in windows via overlib
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.popup.php">http://smarty.php.net/manual/en/language.function.popup.php</A> {popup}
+ *          (Smarty online manual)
+ * @param array
+ * @param Smarty
+ * @return string
+ */
+function smarty_function_popup($params, &amp;$smarty)
+{
+    $append = '';
+    foreach ($params as $_key=&gt;$_value) {
+        switch ($_key) {
+            case 'text':
+            case 'trigger':
+            case 'function':
+            case 'inarray':
+                $$_key = (string)$_value;
+                if ($_key == 'function' || $_key == 'inarray')
+                    $append .= ',' . strtoupper($_key) . &quot;,'$_value'&quot;;
+                break;
+
+            case 'caption':
+            case 'closetext':
+            case 'status':
+                $append .= ',' . strtoupper($_key) . &quot;,'&quot; . str_replace(&quot;'&quot;,&quot;\'&quot;,$_value) . &quot;'&quot;;
+                break;
+
+            case 'fgcolor':
+            case 'bgcolor':
+            case 'textcolor':
+            case 'capcolor':
+            case 'closecolor':
+            case 'textfont':
+            case 'captionfont':
+            case 'closefont':
+            case 'fgbackground':
+            case 'bgbackground':
+            case 'caparray':
+            case 'capicon':
+            case 'background':
+            case 'frame':
+                $append .= ',' . strtoupper($_key) . &quot;,'$_value'&quot;;
+                break;
+
+            case 'textsize':
+            case 'captionsize':
+            case 'closesize':
+            case 'width':
+            case 'height':
+            case 'border':
+            case 'offsetx':
+            case 'offsety':
+            case 'snapx':
+            case 'snapy':
+            case 'fixx':
+            case 'fixy':
+            case 'padx':
+            case 'pady':
+            case 'timeout':
+            case 'delay':
+                $append .= ',' . strtoupper($_key) . &quot;,$_value&quot;;
+                break;
+
+            case 'sticky':
+            case 'left':
+            case 'right':
+            case 'center':
+            case 'above':
+            case 'below':
+            case 'noclose':
+            case 'autostatus':
+            case 'autostatuscap':
+            case 'fullhtml':
+            case 'hauto':
+            case 'vauto':
+            case 'mouseoff':
+            case 'followmouse':
+                if ($_value) $append .= ',' . strtoupper($_key);
+                break;
+
+            default:
+                $smarty-&gt;trigger_error(&quot;[popup] unknown parameter $_key&quot;, E_USER_WARNING);
+        }
+    }
+
+    if (empty($text) &amp;&amp; !isset($inarray) &amp;&amp; empty($function)) {
+        $smarty-&gt;trigger_error(&quot;overlib: attribute 'text' or 'inarray' or 'function' required&quot;);
+        return false;
+    }
+
+    if (empty($trigger)) { $trigger = &quot;onmouseover&quot;; }
+
+    $retval = $trigger . '=&quot;return overlib(\''.preg_replace(array(&quot;!'!&quot;,&quot;![\r\n]!&quot;),array(&quot;\'&quot;,'\r'),$text).'\'';
+    $retval .= $append . ');&quot;';
+    if ($trigger == 'onmouseover')
+       $retval .= ' onmouseout=&quot;nd();&quot;';
+
+
+    return $retval;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.popup_init.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.popup_init.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/function.popup_init.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,39 +1,39 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty {popup_init} function plugin
- *
- * Type:     function&lt;br&gt;
- * Name:     popup_init&lt;br&gt;
- * Purpose:  initialize overlib
- * @link <A HREF="http://smarty.php.net/manual/en/language.function.popup.init.php">http://smarty.php.net/manual/en/language.function.popup.init.php</A> {popup_init}
- *          (Smarty online manual)
- * @param array
- * @param Smarty
- * @return string
- */
-function smarty_function_popup_init($params, &amp;$smarty)
-{
-    $zindex = 1000;
-    
-    if (!empty($params['zindex'])) {
-        $zindex = $params['zindex'];
-    }
-    
-    if (!empty($params['src'])) {
-        return '&lt;div id=&quot;overDiv&quot; style=&quot;position:absolute; visibility:hidden; z-index:'.$zindex.';&quot;&gt;&lt;/div&gt;' . &quot;\n&quot;
-         . '&lt;script type=&quot;text/javascript&quot; language=&quot;JavaScript&quot; src=&quot;'.$params['src'].'&quot;&gt;&lt;/script&gt;' . &quot;\n&quot;;
-    } else {
-        $smarty-&gt;trigger_error(&quot;popup_init: missing src parameter&quot;);
-    }
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty {popup_init} function plugin
+ *
+ * Type:     function&lt;br&gt;
+ * Name:     popup_init&lt;br&gt;
+ * Purpose:  initialize overlib
+ * @link <A HREF="http://smarty.php.net/manual/en/language.function.popup.init.php">http://smarty.php.net/manual/en/language.function.popup.init.php</A> {popup_init}
+ *          (Smarty online manual)
+ * @param array
+ * @param Smarty
+ * @return string
+ */
+function smarty_function_popup_init($params, &amp;$smarty)
+{
+    $zindex = 1000;
+    
+    if (!empty($params['zindex'])) {
+        $zindex = $params['zindex'];
+    }
+    
+    if (!empty($params['src'])) {
+        return '&lt;div id=&quot;overDiv&quot; style=&quot;position:absolute; visibility:hidden; z-index:'.$zindex.';&quot;&gt;&lt;/div&gt;' . &quot;\n&quot;
+         . '&lt;script type=&quot;text/javascript&quot; language=&quot;JavaScript&quot; src=&quot;'.$params['src'].'&quot;&gt;&lt;/script&gt;' . &quot;\n&quot;;
+    } else {
+        $smarty-&gt;trigger_error(&quot;popup_init: missing src parameter&quot;);
+    }
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.capitalize.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.capitalize.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.capitalize.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,42 +1,42 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty capitalize modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     capitalize&lt;br&gt;
- * Purpose:  capitalize words in the string
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifiers.php#LANGUAGE.MODIFIER.CAPITALIZE">http://smarty.php.net/manual/en/language.modifiers.php#LANGUAGE.MODIFIER.CAPITALIZE</A>
- *      capitalize (Smarty online manual)
- * @param string
- * @return string
- */
-function smarty_modifier_capitalize($string, $uc_digits = false)
-{
-    smarty_modifier_capitalize_ucfirst(null, $uc_digits);
-    return preg_replace_callback('!\b\w+\b!', 'smarty_modifier_capitalize_ucfirst', $string);
-}
-
-function smarty_modifier_capitalize_ucfirst($string, $uc_digits = null)
-{
-    static $_uc_digits = false;
-    
-    if(isset($uc_digits)) {
-        $_uc_digits = $uc_digits;
-        return;
-    }
-    
-    if(!preg_match('!\d!',$string[0]) || $_uc_digits)
-        return ucfirst($string[0]);
-    else
-        return $string[0];
-}
-
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty capitalize modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     capitalize&lt;br&gt;
+ * Purpose:  capitalize words in the string
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifiers.php#LANGUAGE.MODIFIER.CAPITALIZE">http://smarty.php.net/manual/en/language.modifiers.php#LANGUAGE.MODIFIER.CAPITALIZE</A>
+ *      capitalize (Smarty online manual)
+ * @param string
+ * @return string
+ */
+function smarty_modifier_capitalize($string, $uc_digits = false)
+{
+    smarty_modifier_capitalize_ucfirst(null, $uc_digits);
+    return preg_replace_callback('!\b\w+\b!', 'smarty_modifier_capitalize_ucfirst', $string);
+}
+
+function smarty_modifier_capitalize_ucfirst($string, $uc_digits = null)
+{
+    static $_uc_digits = false;
+    
+    if(isset($uc_digits)) {
+        $_uc_digits = $uc_digits;
+        return;
+    }
+    
+    if(!preg_match('!\d!',$string[0]) || $_uc_digits)
+        return ucfirst($string[0]);
+    else
+        return $string[0];
+}
+
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.cat.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.cat.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.cat.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,33 +1,33 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty cat modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     cat&lt;br&gt;
- * Date:     Feb 24, 2003
- * Purpose:  catenate a value to a variable
- * Input:    string to catenate
- * Example:  {$var|cat:&quot;foo&quot;}
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.cat.php">http://smarty.php.net/manual/en/language.modifier.cat.php</A> cat
- *          (Smarty online manual)
- * @author   Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @version 1.0
- * @param string
- * @param string
- * @return string
- */
-function smarty_modifier_cat($string, $cat)
-{
-    return $string . $cat;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty cat modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     cat&lt;br&gt;
+ * Date:     Feb 24, 2003
+ * Purpose:  catenate a value to a variable
+ * Input:    string to catenate
+ * Example:  {$var|cat:&quot;foo&quot;}
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.cat.php">http://smarty.php.net/manual/en/language.modifier.cat.php</A> cat
+ *          (Smarty online manual)
+ * @author   Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @version 1.0
+ * @param string
+ * @param string
+ * @return string
+ */
+function smarty_modifier_cat($string, $cat)
+{
+    return $string . $cat;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_characters.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_characters.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_characters.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,31 +1,31 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty count_characters modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     count_characteres&lt;br&gt;
- * Purpose:  count the number of characters in a text
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.count.characters.php">http://smarty.php.net/manual/en/language.modifier.count.characters.php</A>
- *          count_characters (Smarty online manual)
- * @param string
- * @param boolean include whitespace in the character count
- * @return integer
- */
-function smarty_modifier_count_characters($string, $include_spaces = false)
-{
-    if ($include_spaces)
-       return(strlen($string));
-
-    return preg_match_all(&quot;/[^\s]/&quot;,$string, $match);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty count_characters modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     count_characteres&lt;br&gt;
+ * Purpose:  count the number of characters in a text
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.count.characters.php">http://smarty.php.net/manual/en/language.modifier.count.characters.php</A>
+ *          count_characters (Smarty online manual)
+ * @param string
+ * @param boolean include whitespace in the character count
+ * @return integer
+ */
+function smarty_modifier_count_characters($string, $include_spaces = false)
+{
+    if ($include_spaces)
+       return(strlen($string));
+
+    return preg_match_all(&quot;/[^\s]/&quot;,$string, $match);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_paragraphs.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_paragraphs.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_paragraphs.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,28 +1,28 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty count_paragraphs modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     count_paragraphs&lt;br&gt;
- * Purpose:  count the number of paragraphs in a text
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.count.paragraphs.php">http://smarty.php.net/manual/en/language.modifier.count.paragraphs.php</A>
- *          count_paragraphs (Smarty online manual)
- * @param string
- * @return integer
- */
-function smarty_modifier_count_paragraphs($string)
-{
-    // count \r or \n characters
-    return count(preg_split('/[\r\n]+/', $string));
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty count_paragraphs modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     count_paragraphs&lt;br&gt;
+ * Purpose:  count the number of paragraphs in a text
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.count.paragraphs.php">http://smarty.php.net/manual/en/language.modifier.count.paragraphs.php</A>
+ *          count_paragraphs (Smarty online manual)
+ * @param string
+ * @return integer
+ */
+function smarty_modifier_count_paragraphs($string)
+{
+    // count \r or \n characters
+    return count(preg_split('/[\r\n]+/', $string));
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_sentences.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_sentences.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_sentences.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,28 +1,28 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty count_sentences modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     count_sentences
- * Purpose:  count the number of sentences in a text
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.count.paragraphs.php">http://smarty.php.net/manual/en/language.modifier.count.paragraphs.php</A>
- *          count_sentences (Smarty online manual)
- * @param string
- * @return integer
- */
-function smarty_modifier_count_sentences($string)
-{
-    // find periods with a word before but not after.
-    return preg_match_all('/[^\s]\.(?!\w)/', $string, $match);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty count_sentences modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     count_sentences
+ * Purpose:  count the number of sentences in a text
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.count.paragraphs.php">http://smarty.php.net/manual/en/language.modifier.count.paragraphs.php</A>
+ *          count_sentences (Smarty online manual)
+ * @param string
+ * @return integer
+ */
+function smarty_modifier_count_sentences($string)
+{
+    // find periods with a word before but not after.
+    return preg_match_all('/[^\s]\.(?!\w)/', $string, $match);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_words.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_words.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.count_words.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,32 +1,32 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty count_words modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     count_words&lt;br&gt;
- * Purpose:  count the number of words in a text
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.count.words.php">http://smarty.php.net/manual/en/language.modifier.count.words.php</A>
- *          count_words (Smarty online manual)
- * @param string
- * @return integer
- */
-function smarty_modifier_count_words($string)
-{
-    // split text by ' ',\r,\n,\f,\t
-    $split_array = preg_split('/\s+/',$string);
-    // count matches that contain alphanumerics
-    $word_count = preg_grep('/[a-zA-Z0-9\\x80-\\xff]/', $split_array);
-
-    return count($word_count);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty count_words modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     count_words&lt;br&gt;
+ * Purpose:  count the number of words in a text
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.count.words.php">http://smarty.php.net/manual/en/language.modifier.count.words.php</A>
+ *          count_words (Smarty online manual)
+ * @param string
+ * @return integer
+ */
+function smarty_modifier_count_words($string)
+{
+    // split text by ' ',\r,\n,\f,\t
+    $split_array = preg_split('/\s+/',$string);
+    // count matches that contain alphanumerics
+    $word_count = preg_grep('/[a-zA-Z0-9\\x80-\\xff]/', $split_array);
+
+    return count($word_count);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.date_format.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.date_format.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.date_format.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,48 +1,48 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-/**
- * Include the {@link shared.make_timestamp.php} plugin
- */
-require_once $smarty-&gt;_get_plugin_filepath('shared','make_timestamp');
-/**
- * Smarty date_format modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     date_format&lt;br&gt;
- * Purpose:  format datestamps via strftime&lt;br&gt;
- * Input:&lt;br&gt;
- *         - string: input date string
- *         - format: strftime format for output
- *         - default_date: default date if $string is empty
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.date.format.php">http://smarty.php.net/manual/en/language.modifier.date.format.php</A>
- *          date_format (Smarty online manual)
- * @param string
- * @param string
- * @param string
- * @return string|void
- * @uses smarty_make_timestamp()
- */
-function smarty_modifier_date_format($string, $format=&quot;%b %e, %Y&quot;, $default_date=null)
-{
-    if (substr(PHP_OS,0,3) == 'WIN') {
-           $_win_from = array ('%e',  '%T',       '%D');
-           $_win_to   = array ('%#d', '%H:%M:%S', '%m/%d/%y');
-           $format = str_replace($_win_from, $_win_to, $format);
-    }
-    if($string != '') {
-        return strftime($format, smarty_make_timestamp($string));
-    } elseif (isset($default_date) &amp;&amp; $default_date != '') {
-        return strftime($format, smarty_make_timestamp($default_date));
-    } else {
-        return;
-    }
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+/**
+ * Include the {@link shared.make_timestamp.php} plugin
+ */
+require_once $smarty-&gt;_get_plugin_filepath('shared','make_timestamp');
+/**
+ * Smarty date_format modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     date_format&lt;br&gt;
+ * Purpose:  format datestamps via strftime&lt;br&gt;
+ * Input:&lt;br&gt;
+ *         - string: input date string
+ *         - format: strftime format for output
+ *         - default_date: default date if $string is empty
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.date.format.php">http://smarty.php.net/manual/en/language.modifier.date.format.php</A>
+ *          date_format (Smarty online manual)
+ * @param string
+ * @param string
+ * @param string
+ * @return string|void
+ * @uses smarty_make_timestamp()
+ */
+function smarty_modifier_date_format($string, $format=&quot;%b %e, %Y&quot;, $default_date=null)
+{
+    if (substr(PHP_OS,0,3) == 'WIN') {
+           $_win_from = array ('%e',  '%T',       '%D');
+           $_win_to   = array ('%#d', '%H:%M:%S', '%m/%d/%y');
+           $format = str_replace($_win_from, $_win_to, $format);
+    }
+    if($string != '') {
+        return strftime($format, smarty_make_timestamp($string));
+    } elseif (isset($default_date) &amp;&amp; $default_date != '') {
+        return strftime($format, smarty_make_timestamp($default_date));
+    } else {
+        return;
+    }
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.debug_print_var.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.debug_print_var.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.debug_print_var.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,56 +1,56 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty debug_print_var modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     debug_print_var&lt;br&gt;
- * Purpose:  formats variable contents for display in the console
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.debug.print.var.php">http://smarty.php.net/manual/en/language.modifier.debug.print.var.php</A>
- *          debug_print_var (Smarty online manual)
- * @param array|object
- * @param integer
- * @param integer
- * @return string
- */
-function smarty_modifier_debug_print_var($var, $depth = 0, $length = 40)
-{
-    $_replace = array(&quot;\n&quot;=&gt;'&lt;i&gt;&#92;n&lt;/i&gt;', &quot;\r&quot;=&gt;'&lt;i&gt;&#92;r&lt;/i&gt;', &quot;\t&quot;=&gt;'&lt;i&gt;&#92;t&lt;/i&gt;');
-    if (is_array($var)) {
-        $results = &quot;&lt;b&gt;Array (&quot;.count($var).&quot;)&lt;/b&gt;&quot;;
-        foreach ($var as $curr_key =&gt; $curr_val) {
-            $return = smarty_modifier_debug_print_var($curr_val, $depth+1, $length);
-            $results .= &quot;&lt;br&gt;&quot;.str_repeat('&nbsp;', $depth*2).&quot;&lt;b&gt;&quot;.strtr($curr_key, $_replace).&quot;&lt;/b&gt; =&gt; $return&quot;;
-        }
-    } else if (is_object($var)) {
-        $object_vars = get_object_vars($var);
-        $results = &quot;&lt;b&gt;&quot;.get_class($var).&quot; Object (&quot;.count($object_vars).&quot;)&lt;/b&gt;&quot;;
-        foreach ($object_vars as $curr_key =&gt; $curr_val) {
-            $return = smarty_modifier_debug_print_var($curr_val, $depth+1, $length);
-            $results .= &quot;&lt;br&gt;&quot;.str_repeat('&nbsp;', $depth*2).&quot;&lt;b&gt;$curr_key&lt;/b&gt; =&gt; $return&quot;;
-        }
-    } else if (is_resource($var)) {
-        $results = '&lt;i&gt;'.(string)$var.'&lt;/i&gt;';
-    } else if (empty($var) &amp;&amp; $var != &quot;0&quot;) {
-        $results = '&lt;i&gt;empty&lt;/i&gt;';
-    } else {
-        if (strlen($var) &gt; $length ) {
-            $results = substr($var, 0, $length-3).'...';
-        } else {
-            $results = $var;
-        }
-        $results = htmlspecialchars($results);
-        $results = strtr($results, $_replace);
-    }
-    return $results;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty debug_print_var modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     debug_print_var&lt;br&gt;
+ * Purpose:  formats variable contents for display in the console
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.debug.print.var.php">http://smarty.php.net/manual/en/language.modifier.debug.print.var.php</A>
+ *          debug_print_var (Smarty online manual)
+ * @param array|object
+ * @param integer
+ * @param integer
+ * @return string
+ */
+function smarty_modifier_debug_print_var($var, $depth = 0, $length = 40)
+{
+    $_replace = array(&quot;\n&quot;=&gt;'&lt;i&gt;&#92;n&lt;/i&gt;', &quot;\r&quot;=&gt;'&lt;i&gt;&#92;r&lt;/i&gt;', &quot;\t&quot;=&gt;'&lt;i&gt;&#92;t&lt;/i&gt;');
+    if (is_array($var)) {
+        $results = &quot;&lt;b&gt;Array (&quot;.count($var).&quot;)&lt;/b&gt;&quot;;
+        foreach ($var as $curr_key =&gt; $curr_val) {
+            $return = smarty_modifier_debug_print_var($curr_val, $depth+1, $length);
+            $results .= &quot;&lt;br&gt;&quot;.str_repeat('&nbsp;', $depth*2).&quot;&lt;b&gt;&quot;.strtr($curr_key, $_replace).&quot;&lt;/b&gt; =&gt; $return&quot;;
+        }
+    } else if (is_object($var)) {
+        $object_vars = get_object_vars($var);
+        $results = &quot;&lt;b&gt;&quot;.get_class($var).&quot; Object (&quot;.count($object_vars).&quot;)&lt;/b&gt;&quot;;
+        foreach ($object_vars as $curr_key =&gt; $curr_val) {
+            $return = smarty_modifier_debug_print_var($curr_val, $depth+1, $length);
+            $results .= &quot;&lt;br&gt;&quot;.str_repeat('&nbsp;', $depth*2).&quot;&lt;b&gt;$curr_key&lt;/b&gt; =&gt; $return&quot;;
+        }
+    } else if (is_resource($var)) {
+        $results = '&lt;i&gt;'.(string)$var.'&lt;/i&gt;';
+    } else if (empty($var) &amp;&amp; $var != &quot;0&quot;) {
+        $results = '&lt;i&gt;empty&lt;/i&gt;';
+    } else {
+        if (strlen($var) &gt; $length ) {
+            $results = substr($var, 0, $length-3).'...';
+        } else {
+            $results = $var;
+        }
+        $results = htmlspecialchars($results);
+        $results = strtr($results, $_replace);
+    }
+    return $results;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.default.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.default.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.default.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,31 +1,31 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty default modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     default&lt;br&gt;
- * Purpose:  designate default value for empty variables
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.default.php">http://smarty.php.net/manual/en/language.modifier.default.php</A>
- *          default (Smarty online manual)
- * @param string
- * @param string
- * @return string
- */
-function smarty_modifier_default($string, $default = '')
-{
-    if (!isset($string) || $string === '')
-        return $default;
-    else
-        return $string;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty default modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     default&lt;br&gt;
+ * Purpose:  designate default value for empty variables
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.default.php">http://smarty.php.net/manual/en/language.modifier.default.php</A>
+ *          default (Smarty online manual)
+ * @param string
+ * @param string
+ * @return string
+ */
+function smarty_modifier_default($string, $default = '')
+{
+    if (!isset($string) || $string === '')
+        return $default;
+    else
+        return $string;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.escape.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.escape.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.escape.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,89 +1,89 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty escape modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     escape&lt;br&gt;
- * Purpose:  Escape the string according to escapement type
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.escape.php">http://smarty.php.net/manual/en/language.modifier.escape.php</A>
- *          escape (Smarty online manual)
- * @param string
- * @param html|htmlall|url|quotes|hex|hexentity|javascript
- * @return string
- */
-function smarty_modifier_escape($string, $esc_type = 'html')
-{
-    switch ($esc_type) {
-        case 'html':
-            return htmlspecialchars($string, ENT_QUOTES);
-
-        case 'htmlall':
-            return htmlentities($string, ENT_QUOTES);
-
-        case 'url':
-            return urlencode($string);
-
-        case 'quotes':
-            // escape unescaped single quotes
-            return preg_replace(&quot;%(?&lt;!\\\\)'%&quot;, &quot;\\'&quot;, $string);
-
-        case 'hex':
-            // escape every character into hex
-            $return = '';
-            for ($x=0; $x &lt; strlen($string); $x++) {
-                $return .= '%' . bin2hex($string[$x]);
-            }
-            return $return;
-            
-        case 'hexentity':
-            $return = '';
-            for ($x=0; $x &lt; strlen($string); $x++) {
-                $return .= '&amp;#x' . bin2hex($string[$x]) . ';';
-            }
-            return $return;
-
-        case 'decentity':
-            $return = '';
-            for ($x=0; $x &lt; strlen($string); $x++) {
-                $return .= '&amp;#' . ord($string[$x]) . ';';
-            }
-            return $return;
-
-        case 'javascript':
-            // escape quotes and backslashes, newlines, etc.
-            return strtr($string, array('\\'=&gt;'\\\\',&quot;'&quot;=&gt;&quot;\\'&quot;,'&quot;'=&gt;'\\&quot;',&quot;\r&quot;=&gt;'\\r',&quot;\n&quot;=&gt;'\\n','&lt;/'=&gt;'&lt;\/'));
-            
-        case 'mail':
-            // safe way to display e-mail address on a web page
-            return str_replace(array('@', '.'),array(' [AT] ', ' [DOT] '), $string);
-            
-        case 'nonstd':
-           // escape non-standard chars, such as ms document quotes
-           $_res = '';
-           for($_i = 0, $_len = strlen($string); $_i &lt; $_len; $_i++) {
-               $_ord = ord($string{$_i});
-               // non-standard char, escape it
-               if($_ord &gt;= 126){
-                   $_res .= '&amp;#' . $_ord . ';';
-               }
-               else {
-                   $_res .= $string{$_i};
-               }
-           }
-           return $_res;
-
-        default:
-            return $string;
-    }
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty escape modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     escape&lt;br&gt;
+ * Purpose:  Escape the string according to escapement type
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.escape.php">http://smarty.php.net/manual/en/language.modifier.escape.php</A>
+ *          escape (Smarty online manual)
+ * @param string
+ * @param html|htmlall|url|quotes|hex|hexentity|javascript
+ * @return string
+ */
+function smarty_modifier_escape($string, $esc_type = 'html')
+{
+    switch ($esc_type) {
+        case 'html':
+            return htmlspecialchars($string, ENT_QUOTES);
+
+        case 'htmlall':
+            return htmlentities($string, ENT_QUOTES);
+
+        case 'url':
+            return rawurlencode($string);
+
+        case 'quotes':
+            // escape unescaped single quotes
+            return preg_replace(&quot;%(?&lt;!\\\\)'%&quot;, &quot;\\'&quot;, $string);
+
+        case 'hex':
+            // escape every character into hex
+            $return = '';
+            for ($x=0; $x &lt; strlen($string); $x++) {
+                $return .= '%' . bin2hex($string[$x]);
+            }
+            return $return;
+            
+        case 'hexentity':
+            $return = '';
+            for ($x=0; $x &lt; strlen($string); $x++) {
+                $return .= '&amp;#x' . bin2hex($string[$x]) . ';';
+            }
+            return $return;
+
+        case 'decentity':
+            $return = '';
+            for ($x=0; $x &lt; strlen($string); $x++) {
+                $return .= '&amp;#' . ord($string[$x]) . ';';
+            }
+            return $return;
+
+        case 'javascript':
+            // escape quotes and backslashes, newlines, etc.
+            return strtr($string, array('\\'=&gt;'\\\\',&quot;'&quot;=&gt;&quot;\\'&quot;,'&quot;'=&gt;'\\&quot;',&quot;\r&quot;=&gt;'\\r',&quot;\n&quot;=&gt;'\\n','&lt;/'=&gt;'&lt;\/'));
+            
+        case 'mail':
+            // safe way to display e-mail address on a web page
+            return str_replace(array('@', '.'),array(' [AT] ', ' [DOT] '), $string);
+            
+        case 'nonstd':
+           // escape non-standard chars, such as ms document quotes
+           $_res = '';
+           for($_i = 0, $_len = strlen($string); $_i &lt; $_len; $_i++) {
+               $_ord = ord($string{$_i});
+               // non-standard char, escape it
+               if($_ord &gt;= 126){
+                   $_res .= '&amp;#' . $_ord . ';';
+               }
+               else {
+                   $_res .= $string{$_i};
+               }
+           }
+           return $_res;
+
+        default:
+            return $string;
+    }
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.indent.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.indent.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.indent.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,27 +1,27 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty indent modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     indent&lt;br&gt;
- * Purpose:  indent lines of text
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.indent.php">http://smarty.php.net/manual/en/language.modifier.indent.php</A>
- *          indent (Smarty online manual)
- * @param string
- * @param integer
- * @param string
- * @return string
- */
-function smarty_modifier_indent($string,$chars=4,$char=&quot; &quot;)
-{
-    return preg_replace('!^!m',str_repeat($char,$chars),$string);
-}
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty indent modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     indent&lt;br&gt;
+ * Purpose:  indent lines of text
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.indent.php">http://smarty.php.net/manual/en/language.modifier.indent.php</A>
+ *          indent (Smarty online manual)
+ * @param string
+ * @param integer
+ * @param string
+ * @return string
+ */
+function smarty_modifier_indent($string,$chars=4,$char=&quot; &quot;)
+{
+    return preg_replace('!^!m',str_repeat($char,$chars),$string);
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.lower.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.lower.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.lower.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,25 +1,25 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty lower modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     lower&lt;br&gt;
- * Purpose:  convert string to lowercase
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.lower.php">http://smarty.php.net/manual/en/language.modifier.lower.php</A>
- *          lower (Smarty online manual)
- * @param string
- * @return string
- */
-function smarty_modifier_lower($string)
-{
-    return strtolower($string);
-}
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty lower modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     lower&lt;br&gt;
+ * Purpose:  convert string to lowercase
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.lower.php">http://smarty.php.net/manual/en/language.modifier.lower.php</A>
+ *          lower (Smarty online manual)
+ * @param string
+ * @return string
+ */
+function smarty_modifier_lower($string)
+{
+    return strtolower($string);
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.nl2br.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.nl2br.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.nl2br.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,35 +1,35 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     nl2br&lt;br&gt;
- * Date:     Feb 26, 2003
- * Purpose:  convert \r\n, \r or \n to &lt;&lt;br&gt;&gt;
- * Input:&lt;br&gt;
- *         - contents = contents to replace
- *         - preceed_test = if true, includes preceeding break tags
- *           in replacement
- * Example:  {$text|nl2br}
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.nl2br.php">http://smarty.php.net/manual/en/language.modifier.nl2br.php</A>
- *          nl2br (Smarty online manual)
- * @version  1.0
- * @author   Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @param string
- * @return string
- */
-function smarty_modifier_nl2br($string)
-{
-    return nl2br($string);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     nl2br&lt;br&gt;
+ * Date:     Feb 26, 2003
+ * Purpose:  convert \r\n, \r or \n to &lt;&lt;br&gt;&gt;
+ * Input:&lt;br&gt;
+ *         - contents = contents to replace
+ *         - preceed_test = if true, includes preceeding break tags
+ *           in replacement
+ * Example:  {$text|nl2br}
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.nl2br.php">http://smarty.php.net/manual/en/language.modifier.nl2br.php</A>
+ *          nl2br (Smarty online manual)
+ * @version  1.0
+ * @author   Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @param string
+ * @return string
+ */
+function smarty_modifier_nl2br($string)
+{
+    return nl2br($string);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.regex_replace.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.regex_replace.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.regex_replace.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,29 +1,33 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty regex_replace modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     regex_replace&lt;br&gt;
- * Purpose:  regular epxression search/replace
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.regex.replace.php">http://smarty.php.net/manual/en/language.modifier.regex.replace.php</A>
- *          regex_replace (Smarty online manual)
- * @param string
- * @param string|array
- * @param string|array
- * @return string
- */
-function smarty_modifier_regex_replace($string, $search, $replace)
-{
-    return preg_replace($search, $replace, $string);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty regex_replace modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     regex_replace&lt;br&gt;
+ * Purpose:  regular epxression search/replace
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.regex.replace.php">http://smarty.php.net/manual/en/language.modifier.regex.replace.php</A>
+ *          regex_replace (Smarty online manual)
+ * @param string
+ * @param string|array
+ * @param string|array
+ * @return string
+ */
+function smarty_modifier_regex_replace($string, $search, $replace)
+{
+    if (preg_match('!\W(\w+)$!s', $search, $match) &amp;&amp; (strpos($match[1], 'e') !== false)) {
+        /* remove eval-modifier from $search */
+        $search = substr($search, 0, -strlen($match[1])) . str_replace('e', '', $match[1]);
+    }
+    return preg_replace($search, $replace, $string);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.replace.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.replace.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.replace.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,29 +1,29 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty replace modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     replace&lt;br&gt;
- * Purpose:  simple search/replace
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.replace.php">http://smarty.php.net/manual/en/language.modifier.replace.php</A>
- *          replace (Smarty online manual)
- * @param string
- * @param string
- * @param string
- * @return string
- */
-function smarty_modifier_replace($string, $search, $replace)
-{
-    return str_replace($search, $replace, $string);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty replace modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     replace&lt;br&gt;
+ * Purpose:  simple search/replace
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.replace.php">http://smarty.php.net/manual/en/language.modifier.replace.php</A>
+ *          replace (Smarty online manual)
+ * @param string
+ * @param string
+ * @param string
+ * @return string
+ */
+function smarty_modifier_replace($string, $search, $replace)
+{
+    return str_replace($search, $replace, $string);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.spacify.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.spacify.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.spacify.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,29 +1,29 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty spacify modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     spacify&lt;br&gt;
- * Purpose:  add spaces between characters in a string
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.spacify.php">http://smarty.php.net/manual/en/language.modifier.spacify.php</A>
- *          spacify (Smarty online manual)
- * @param string
- * @param string
- * @return string
- */
-function smarty_modifier_spacify($string, $spacify_char = ' ')
-{
-    return implode($spacify_char,
-                   preg_split('//', $string, -1, PREG_SPLIT_NO_EMPTY));
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty spacify modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     spacify&lt;br&gt;
+ * Purpose:  add spaces between characters in a string
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.spacify.php">http://smarty.php.net/manual/en/language.modifier.spacify.php</A>
+ *          spacify (Smarty online manual)
+ * @param string
+ * @param string
+ * @return string
+ */
+function smarty_modifier_spacify($string, $spacify_char = ' ')
+{
+    return implode($spacify_char,
+                   preg_split('//', $string, -1, PREG_SPLIT_NO_EMPTY));
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.string_format.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.string_format.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.string_format.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,28 +1,28 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty string_format modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     string_format&lt;br&gt;
- * Purpose:  format strings via sprintf
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.string.format.php">http://smarty.php.net/manual/en/language.modifier.string.format.php</A>
- *          string_format (Smarty online manual)
- * @param string
- * @param string
- * @return string
- */
-function smarty_modifier_string_format($string, $format)
-{
-    return sprintf($format, $string);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty string_format modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     string_format&lt;br&gt;
+ * Purpose:  format strings via sprintf
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.string.format.php">http://smarty.php.net/manual/en/language.modifier.string.format.php</A>
+ *          string_format (Smarty online manual)
+ * @param string
+ * @param string
+ * @return string
+ */
+function smarty_modifier_string_format($string, $format)
+{
+    return sprintf($format, $string);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.strip.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.strip.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.strip.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,33 +1,33 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty strip modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     strip&lt;br&gt;
- * Purpose:  Replace all repeated spaces, newlines, tabs
- *           with a single space or supplied replacement string.&lt;br&gt;
- * Example:  {$var|strip} {$var|strip:&quot;&nbsp;&quot;}
- * Date:     September 25th, 2002
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.strip.php">http://smarty.php.net/manual/en/language.modifier.strip.php</A>
- *          strip (Smarty online manual)
- * @author   Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @version  1.0
- * @param string
- * @param string
- * @return string
- */
-function smarty_modifier_strip($text, $replace = ' ')
-{
-    return preg_replace('!\s+!', $replace, $text);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty strip modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     strip&lt;br&gt;
+ * Purpose:  Replace all repeated spaces, newlines, tabs
+ *           with a single space or supplied replacement string.&lt;br&gt;
+ * Example:  {$var|strip} {$var|strip:&quot;&nbsp;&quot;}
+ * Date:     September 25th, 2002
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.strip.php">http://smarty.php.net/manual/en/language.modifier.strip.php</A>
+ *          strip (Smarty online manual)
+ * @author   Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @version  1.0
+ * @param string
+ * @param string
+ * @return string
+ */
+function smarty_modifier_strip($text, $replace = ' ')
+{
+    return preg_replace('!\s+!', $replace, $text);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.strip_tags.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.strip_tags.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.strip_tags.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,31 +1,31 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty strip_tags modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     strip_tags&lt;br&gt;
- * Purpose:  strip html tags from text
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.strip.tags.php">http://smarty.php.net/manual/en/language.modifier.strip.tags.php</A>
- *          strip_tags (Smarty online manual)
- * @param string
- * @param boolean
- * @return string
- */
-function smarty_modifier_strip_tags($string, $replace_with_space = true)
-{
-    if ($replace_with_space)
-        return preg_replace('!&lt;[^&gt;]*?&gt;!', ' ', $string);
-    else
-        return strip_tags($string);
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty strip_tags modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     strip_tags&lt;br&gt;
+ * Purpose:  strip html tags from text
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.strip.tags.php">http://smarty.php.net/manual/en/language.modifier.strip.tags.php</A>
+ *          strip_tags (Smarty online manual)
+ * @param string
+ * @param boolean
+ * @return string
+ */
+function smarty_modifier_strip_tags($string, $replace_with_space = true)
+{
+    if ($replace_with_space)
+        return preg_replace('!&lt;[^&gt;]*?&gt;!', ' ', $string);
+    else
+        return strip_tags($string);
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.truncate.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.truncate.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.truncate.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,43 +1,49 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty truncate modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     truncate&lt;br&gt;
- * Purpose:  Truncate a string to a certain length if necessary,
- *           optionally splitting in the middle of a word, and
- *           appending the $etc string.
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.truncate.php">http://smarty.php.net/manual/en/language.modifier.truncate.php</A>
- *          truncate (Smarty online manual)
- * @param string
- * @param integer
- * @param string
- * @param boolean
- * @return string
- */
-function smarty_modifier_truncate($string, $length = 80, $etc = '...',
-                                  $break_words = false)
-{
-    if ($length == 0)
-        return '';
-
-    if (strlen($string) &gt; $length) {
-        $length -= strlen($etc);
-        if (!$break_words)
-            $string = preg_replace('/\s+?(\S+)?$/', '', substr($string, 0, $length+1));
-      
-        return substr($string, 0, $length).$etc;
-    } else
-        return $string;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty truncate modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     truncate&lt;br&gt;
+ * Purpose:  Truncate a string to a certain length if necessary,
+ *           optionally splitting in the middle of a word, and
+ *           appending the $etc string or inserting $etc into the middle.
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.truncate.php">http://smarty.php.net/manual/en/language.modifier.truncate.php</A>
+ *          truncate (Smarty online manual)
+ * @param string
+ * @param integer
+ * @param string
+ * @param boolean
+ * @param boolean
+ * @return string
+ */
+function smarty_modifier_truncate($string, $length = 80, $etc = '...',
+                                  $break_words = false, $middle = false)
+{
+    if ($length == 0)
+        return '';
+
+    if (strlen($string) &gt; $length) {
+        $length -= strlen($etc);
+        if (!$break_words &amp;&amp; !$middle) {
+            $string = preg_replace('/\s+?(\S+)?$/', '', substr($string, 0, $length+1));
+        }
+        if(!$middle) {
+            return substr($string, 0, $length).$etc;
+        } else {
+            return substr($string, 0, $length/2) . $etc . substr($string, -$length/2);
+        }
+    } else {
+        return $string;
+    }
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.upper.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.upper.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.upper.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,25 +1,25 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty upper modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     upper&lt;br&gt;
- * Purpose:  convert string to uppercase
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.upper.php">http://smarty.php.net/manual/en/language.modifier.upper.php</A>
- *          upper (Smarty online manual)
- * @param string
- * @return string
- */
-function smarty_modifier_upper($string)
-{
-    return strtoupper($string);
-}
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty upper modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     upper&lt;br&gt;
+ * Purpose:  convert string to uppercase
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.upper.php">http://smarty.php.net/manual/en/language.modifier.upper.php</A>
+ *          upper (Smarty online manual)
+ * @param string
+ * @return string
+ */
+function smarty_modifier_upper($string)
+{
+    return strtoupper($string);
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.wordwrap.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.wordwrap.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/modifier.wordwrap.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,28 +1,28 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Smarty wordwrap modifier plugin
- *
- * Type:     modifier&lt;br&gt;
- * Name:     wordwrap&lt;br&gt;
- * Purpose:  wrap a string of text at a given length
- * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.wordwrap.php">http://smarty.php.net/manual/en/language.modifier.wordwrap.php</A>
- *          wordwrap (Smarty online manual)
- * @param string
- * @param integer
- * @param string
- * @param boolean
- * @return string
- */
-function smarty_modifier_wordwrap($string,$length=80,$break=&quot;\n&quot;,$cut=false)
-{
-    return wordwrap($string,$length,$break,$cut);
-}
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Smarty wordwrap modifier plugin
+ *
+ * Type:     modifier&lt;br&gt;
+ * Name:     wordwrap&lt;br&gt;
+ * Purpose:  wrap a string of text at a given length
+ * @link <A HREF="http://smarty.php.net/manual/en/language.modifier.wordwrap.php">http://smarty.php.net/manual/en/language.modifier.wordwrap.php</A>
+ *          wordwrap (Smarty online manual)
+ * @param string
+ * @param integer
+ * @param string
+ * @param boolean
+ * @return string
+ */
+function smarty_modifier_wordwrap($string,$length=80,$break=&quot;\n&quot;,$cut=false)
+{
+    return wordwrap($string,$length,$break,$cut);
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/outputfilter.trimwhitespace.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/outputfilter.trimwhitespace.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/outputfilter.trimwhitespace.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,75 +1,75 @@
-&lt;?php
-/**
- * Smarty plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-/**
- * Smarty trimwhitespace outputfilter plugin
- *
- * File:     outputfilter.trimwhitespace.php&lt;br&gt;
- * Type:     outputfilter&lt;br&gt;
- * Name:     trimwhitespace&lt;br&gt;
- * Date:     Jan 25, 2003&lt;br&gt;
- * Purpose:  trim leading white space and blank lines from
- *           template source after it gets interpreted, cleaning
- *           up code and saving bandwidth. Does not affect
- *           &lt;&lt;PRE&gt;&gt;&lt;/PRE&gt; and &lt;SCRIPT&gt;&lt;/SCRIPT&gt; blocks.&lt;br&gt;
- * Install:  Drop into the plugin directory, call
- *           &lt;code&gt;$smarty-&gt;load_filter('output','trimwhitespace');&lt;/code&gt;
- *           from application.
- * @author   Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
- * @author Contributions from Lars Noschinski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">lars at usenet.noschinski.de</A>&gt;
- * @version  1.3
- * @param string
- * @param Smarty
- */
-function smarty_outputfilter_trimwhitespace($source, &amp;$smarty)
-{
-    // Pull out the script blocks
-    preg_match_all(&quot;!&lt;script[^&gt;]+&gt;.*?&lt;/script&gt;!is&quot;, $source, $match);
-    $_script_blocks = $match[0];
-    $source = preg_replace(&quot;!&lt;script[^&gt;]+&gt;.*?&lt;/script&gt;!is&quot;,
-                           '@@@SMARTY:TRIM:SCRIPT@@@', $source);
-
-    // Pull out the pre blocks
-    preg_match_all(&quot;!&lt;pre&gt;.*?&lt;/pre&gt;!is&quot;, $source, $match);
-    $_pre_blocks = $match[0];
-    $source = preg_replace(&quot;!&lt;pre&gt;.*?&lt;/pre&gt;!is&quot;,
-                           '@@@SMARTY:TRIM:PRE@@@', $source);
-
-    // Pull out the textarea blocks
-    preg_match_all(&quot;!&lt;textarea[^&gt;]+&gt;.*?&lt;/textarea&gt;!is&quot;, $source, $match);
-    $_textarea_blocks = $match[0];
-    $source = preg_replace(&quot;!&lt;textarea[^&gt;]+&gt;.*?&lt;/textarea&gt;!is&quot;,
-                           '@@@SMARTY:TRIM:TEXTAREA@@@', $source);
-
-    // remove all leading spaces, tabs and carriage returns NOT
-    // preceeded by a php close tag.
-    $source = trim(preg_replace('/((?&lt;!\?&gt;)\n)[\s]+/m', '\1', $source));
-
-    // replace script blocks
-    smarty_outputfilter_trimwhitespace_replace(&quot;@@@SMARTY:TRIM:SCRIPT@@@&quot;,$_script_blocks, $source);
-
-    // replace pre blocks
-    smarty_outputfilter_trimwhitespace_replace(&quot;@@@SMARTY:TRIM:PRE@@@&quot;,$_pre_blocks, $source);
-
-    // replace textarea blocks
-    smarty_outputfilter_trimwhitespace_replace(&quot;@@@SMARTY:TRIM:TEXTAREA@@@&quot;,$_textarea_blocks, $source);
-
-    return $source;
-}
-
-function smarty_outputfilter_trimwhitespace_replace($search_str, $replace, &amp;$subject) {
-    $_len = strlen($search_str);
-    $_pos = 0;
-    for ($_i=0, $_count=count($replace); $_i&lt;$_count; $_i++)
-        if (($_pos=strpos($subject, $search_str, $_pos))!==false)
-            $subject = substr_replace($subject, $replace[$_i], $_pos, $_len);
-        else
-            break;
-
-}
-
-?&gt;
+&lt;?php
+/**
+ * Smarty plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+/**
+ * Smarty trimwhitespace outputfilter plugin
+ *
+ * File:     outputfilter.trimwhitespace.php&lt;br&gt;
+ * Type:     outputfilter&lt;br&gt;
+ * Name:     trimwhitespace&lt;br&gt;
+ * Date:     Jan 25, 2003&lt;br&gt;
+ * Purpose:  trim leading white space and blank lines from
+ *           template source after it gets interpreted, cleaning
+ *           up code and saving bandwidth. Does not affect
+ *           &lt;&lt;PRE&gt;&gt;&lt;/PRE&gt; and &lt;SCRIPT&gt;&lt;/SCRIPT&gt; blocks.&lt;br&gt;
+ * Install:  Drop into the plugin directory, call
+ *           &lt;code&gt;$smarty-&gt;load_filter('output','trimwhitespace');&lt;/code&gt;
+ *           from application.
+ * @author   Monte Ohrt &lt;monte at ohrt dot com&gt;
+ * @author Contributions from Lars Noschinski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">lars at usenet.noschinski.de</A>&gt;
+ * @version  1.3
+ * @param string
+ * @param Smarty
+ */
+function smarty_outputfilter_trimwhitespace($source, &amp;$smarty)
+{
+    // Pull out the script blocks
+    preg_match_all(&quot;!&lt;script[^&gt;]+&gt;.*?&lt;/script&gt;!is&quot;, $source, $match);
+    $_script_blocks = $match[0];
+    $source = preg_replace(&quot;!&lt;script[^&gt;]+&gt;.*?&lt;/script&gt;!is&quot;,
+                           '@@@SMARTY:TRIM:SCRIPT@@@', $source);
+
+    // Pull out the pre blocks
+    preg_match_all(&quot;!&lt;pre&gt;.*?&lt;/pre&gt;!is&quot;, $source, $match);
+    $_pre_blocks = $match[0];
+    $source = preg_replace(&quot;!&lt;pre&gt;.*?&lt;/pre&gt;!is&quot;,
+                           '@@@SMARTY:TRIM:PRE@@@', $source);
+
+    // Pull out the textarea blocks
+    preg_match_all(&quot;!&lt;textarea[^&gt;]+&gt;.*?&lt;/textarea&gt;!is&quot;, $source, $match);
+    $_textarea_blocks = $match[0];
+    $source = preg_replace(&quot;!&lt;textarea[^&gt;]+&gt;.*?&lt;/textarea&gt;!is&quot;,
+                           '@@@SMARTY:TRIM:TEXTAREA@@@', $source);
+
+    // remove all leading spaces, tabs and carriage returns NOT
+    // preceeded by a php close tag.
+    $source = trim(preg_replace('/((?&lt;!\?&gt;)\n)[\s]+/m', '\1', $source));
+
+    // replace script blocks
+    smarty_outputfilter_trimwhitespace_replace(&quot;@@@SMARTY:TRIM:SCRIPT@@@&quot;,$_script_blocks, $source);
+
+    // replace pre blocks
+    smarty_outputfilter_trimwhitespace_replace(&quot;@@@SMARTY:TRIM:PRE@@@&quot;,$_pre_blocks, $source);
+
+    // replace textarea blocks
+    smarty_outputfilter_trimwhitespace_replace(&quot;@@@SMARTY:TRIM:TEXTAREA@@@&quot;,$_textarea_blocks, $source);
+
+    return $source;
+}
+
+function smarty_outputfilter_trimwhitespace_replace($search_str, $replace, &amp;$subject) {
+    $_len = strlen($search_str);
+    $_pos = 0;
+    for ($_i=0, $_count=count($replace); $_i&lt;$_count; $_i++)
+        if (($_pos=strpos($subject, $search_str, $_pos))!==false)
+            $subject = substr_replace($subject, $replace[$_i], $_pos, $_len);
+        else
+            break;
+
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/shared.escape_special_chars.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/shared.escape_special_chars.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/shared.escape_special_chars.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,30 +1,30 @@
-&lt;?php
-/**
- * Smarty shared plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * escape_special_chars common function
- *
- * Function: smarty_function_escape_special_chars&lt;br&gt;
- * Purpose:  used by other smarty functions to escape
- *           special chars except for already escaped ones
- * @param string
- * @return string
- */
-function smarty_function_escape_special_chars($string)
-{
-    if(!is_array($string)) {
-        $string = preg_replace('!&amp;(#?\w+);!', '%%%SMARTY_START%%%\\1%%%SMARTY_END%%%', $string);
-        $string = htmlspecialchars($string);
-        $string = str_replace(array('%%%SMARTY_START%%%','%%%SMARTY_END%%%'), array('&amp;',';'), $string);
-    }
-    return $string;
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty shared plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * escape_special_chars common function
+ *
+ * Function: smarty_function_escape_special_chars&lt;br&gt;
+ * Purpose:  used by other smarty functions to escape
+ *           special chars except for already escaped ones
+ * @param string
+ * @return string
+ */
+function smarty_function_escape_special_chars($string)
+{
+    if(!is_array($string)) {
+        $string = preg_replace('!&amp;(#?\w+);!', '%%%SMARTY_START%%%\\1%%%SMARTY_END%%%', $string);
+        $string = htmlspecialchars($string);
+        $string = str_replace(array('%%%SMARTY_START%%%','%%%SMARTY_END%%%'), array('&amp;',';'), $string);
+    }
+    return $string;
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/shared.make_timestamp.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/shared.make_timestamp.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/smarty/plugins/shared.make_timestamp.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,43 +1,45 @@
-&lt;?php
-/**
- * Smarty shared plugin
- * @package Smarty
- * @subpackage plugins
- */
-
-
-/**
- * Function: smarty_make_timestamp&lt;br&gt;
- * Purpose:  used by other smarty functions to make a timestamp
- *           from a string.
- * @param string
- * @return string
- */
-function smarty_make_timestamp($string)
-{
-    if(empty($string)) {
-        $string = &quot;now&quot;;
-    }
-    $time = strtotime($string);
-    if (is_numeric($time) &amp;&amp; $time != -1)
-        return $time;
-
-    // is mysql timestamp format of YYYYMMDDHHMMSS?
-    if (preg_match('/^\d{14}$/', $string)) {
-        $time = mktime(substr($string,8,2),substr($string,10,2),substr($string,12,2),
-               substr($string,4,2),substr($string,6,2),substr($string,0,4));
-
-        return $time;
-    }
-
-    // couldn't recognize it, try to return a time
-    $time = (int) $string;
-    if ($time &gt; 0)
-        return $time;
-    else
-        return time();
-}
-
-/* vim: set expandtab: */
-
-?&gt;
+&lt;?php
+/**
+ * Smarty shared plugin
+ * @package Smarty
+ * @subpackage plugins
+ */
+
+
+/**
+ * Function: smarty_make_timestamp&lt;br&gt;
+ * Purpose:  used by other smarty functions to make a timestamp
+ *           from a string.
+ * @param string
+ * @return string
+ */
+function smarty_make_timestamp($string)
+{
+    if(empty($string)) {
+        // use &quot;now&quot;:
+        $time = time();
+
+    } elseif (preg_match('/^\d{14}$/', $string)) {
+        // it is mysql timestamp format of YYYYMMDDHHMMSS?            
+        $time = mktime(substr($string, 8, 2),substr($string, 10, 2),substr($string, 12, 2),
+                       substr($string, 4, 2),substr($string, 6, 2),substr($string, 0, 4));
+        
+    } elseif (is_numeric($string)) {
+        // it is a numeric string, we handle it as timestamp
+        $time = (int)$string;
+        
+    } else {
+        // strtotime should handle it
+        $time = strtotime($string);
+        if ($time == -1 || $time === false) {
+            // strtotime() was not able to parse $string, use &quot;now&quot;:
+            $time = time();
+        }
+    }
+    return $time;
+
+}
+
+/* vim: set expandtab: */
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/class/snoopy.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/class/snoopy.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/class/snoopy.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,1218 +1,1257 @@
-&lt;?php
-
-/*************************************************
-
-Snoopy - the PHP net client
-Author: Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
-Copyright (c): 1999-2000 ispi, all rights reserved
-Version: 1.01
-
- * This library is free software; you can redistribute it and/or
- * modify it under the terms of the GNU Lesser General Public
- * License as published by the Free Software Foundation; either
- * version 2.1 of the License, or (at your option) any later version.
- *
- * This library is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
- * Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU Lesser General Public
- * License along with this library; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-
-You may contact the author of Snoopy by e-mail at:
<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">-monte at ispi.net</A>
-
-Or, write to:
-Monte Ohrt
-CTO, ispi
-237 S. 70th suite 220
-Lincoln, NE 68510
-
-The latest version of Snoopy can be obtained from:
-<A HREF="http://snoopy.sourceforge.com">http://snoopy.sourceforge.com</A>
-
-*************************************************/
-
-class Snoopy
-{
-	/**** Public variables ****/
-	
-	/* user definable vars */
-
-	var $host			=	&quot;www.php.net&quot;;		// host name we are connecting to
-	var $port			=	80;					// port we are connecting to
-	var $proxy_host		=	&quot;&quot;;					// proxy host to use
-	var $proxy_port		=	&quot;&quot;;					// proxy port to use
-	var $agent			=	&quot;Snoopy v1.01&quot;;		// agent we masquerade as
-	var	$referer		=	&quot;&quot;;					// referer info to pass
-	var $cookies		=	array();			// array of cookies to pass
-												// $cookies[&quot;username&quot;]=&quot;joe&quot;;
-	var	$rawheaders		=	array();			// array of raw headers to send
-												// $rawheaders[&quot;Content-type&quot;]=&quot;text/html&quot;;
-
-	var $maxredirs		=	5;					// http redirection depth maximum. 0 = disallow
-	var $lastredirectaddr	=	&quot;&quot;;				// contains address of last redirected address
-	var	$offsiteok		=	true;				// allows redirection off-site
-	var $maxframes		=	0;					// frame content depth maximum. 0 = disallow
-	var $expandlinks	=	true;				// expand links to fully qualified URLs.
-												// this only applies to fetchlinks()
-												// or submitlinks()
-	var $passcookies	=	true;				// pass set cookies back through redirects
-												// NOTE: this currently does not respect
-												// dates, domains or paths.
-	
-	var	$user			=	&quot;&quot;;					// user for http authentication
-	var	$pass			=	&quot;&quot;;					// password for http authentication
-	
-	// http accept types
-	var $accept			=	&quot;image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*&quot;;
-	
-	var $results		=	&quot;&quot;;					// where the content is put
-		
-	var $error			=	&quot;&quot;;					// error messages sent here
-	var	$response_code	=	&quot;&quot;;					// response code returned from server
-	var	$headers		=	array();			// headers returned from server sent here
-	var	$maxlength		=	500000;				// max return data length (body)
-	var $read_timeout	=	0;					// timeout on read operations, in seconds
-												// supported only since PHP 4 Beta 4
-												// set to 0 to disallow timeouts
-	var $timed_out		=	false;				// if a read operation timed out
-	var	$status			=	0;					// http request status
-	
-	var	$curl_path		=	&quot;/usr/local/bin/curl&quot;;
-												// Snoopy will use cURL for fetching
-												// SSL content if a full system path to
-												// the cURL binary is supplied here.
-												// set to false if you do not have
-												// cURL installed. See <A HREF="http://curl.haxx.se">http://curl.haxx.se</A>
-												// for details on installing cURL.
-												// Snoopy does *not* use the cURL
-												// library functions built into php,
-												// as these functions are not stable
-												// as of this Snoopy release.
-	
-	/**** Private variables ****/	
-	
-	var	$_maxlinelen	=	4096;				// max line length (headers)
-	
-	var $_httpmethod	=	&quot;GET&quot;;				// default http request method
-	var $_httpversion	=	&quot;HTTP/1.0&quot;;			// default http request version
-	var $_submit_method	=	&quot;POST&quot;;				// default submit method
-	var $_submit_type	=	&quot;application/x-www-form-urlencoded&quot;;	// default submit type
-	var $_mime_boundary	=   &quot;&quot;;					// MIME boundary for multipart/form-data submit type
-	var $_redirectaddr	=	false;				// will be set if page fetched is a redirect
-	var $_redirectdepth	=	0;					// increments on an http redirect
-	var $_frameurls		= 	array();			// frame src urls
-	var $_framedepth	=	0;					// increments on frame depth
-	
-	var $_isproxy		=	false;				// set if using a proxy server
-	var $_fp_timeout	=	30;					// timeout for socket connection
-
-/*======================================================================*\
-	Function:	fetch
-	Purpose:	fetch the contents of a web page
-				(and possibly other protocols in the
-				future like ftp, nntp, gopher, etc.)
-	Input:		$URI	the location of the page to fetch
-	Output:		$this-&gt;results	the output text from the fetch
-\*======================================================================*/
-
-	function fetch($URI)
-	{
-	
-		//preg_match(&quot;|^([^:]+)://([^:/]+)(:[\d]+)*(.*)|&quot;,$URI,$URI_PARTS);
-		$URI_PARTS = parse_url($URI);
-		if (!empty($URI_PARTS[&quot;user&quot;]))
-			$this-&gt;user = $URI_PARTS[&quot;user&quot;];
-		if (!empty($URI_PARTS[&quot;pass&quot;]))
-			$this-&gt;pass = $URI_PARTS[&quot;pass&quot;];
-				
-		switch($URI_PARTS[&quot;scheme&quot;])
-		{
-			case &quot;http&quot;:
-				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
-				if(!empty($URI_PARTS[&quot;port&quot;]))
-					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
-				if($this-&gt;_connect($fp))
-				{
-					if($this-&gt;_isproxy)
-					{
-						// using proxy, send entire URI
-						$this-&gt;_httprequest($URI,$fp,$URI,$this-&gt;_httpmethod);
-					}
-					else
-					{
-						$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
-						// no proxy, send only the path
-						$this-&gt;_httprequest($path, $fp, $URI, $this-&gt;_httpmethod);
-					}
-					
-					$this-&gt;_disconnect($fp);
-
-					if($this-&gt;_redirectaddr)
-					{
-						/* url was redirected, check if we've hit the max depth */
-						if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
-						{
-							// only follow redirect if it's on this site, or offsiteok is true
-							if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
-							{
-								/* follow the redirect */
-								$this-&gt;_redirectdepth++;
-								$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
-								$this-&gt;fetch($this-&gt;_redirectaddr);
-							}
-						}
-					}
-
-					if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
-					{
-						$frameurls = $this-&gt;_frameurls;
-						$this-&gt;_frameurls = array();
-						
-						while(list(,$frameurl) = each($frameurls))
-						{
-							if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
-							{
-								$this-&gt;fetch($frameurl);
-								$this-&gt;_framedepth++;
-							}
-							else
-								break;
-						}
-					}					
-				}
-				else
-				{
-					return false;
-				}
-				return true;					
-				break;
-			case &quot;https&quot;:
-				if(!$this-&gt;curl_path || (!is_executable($this-&gt;curl_path)))
-					return false;
-				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
-				if(!empty($URI_PARTS[&quot;port&quot;]))
-					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
-				if($this-&gt;_isproxy)
-				{
-					// using proxy, send entire URI
-					$this-&gt;_httpsrequest($URI,$URI,$this-&gt;_httpmethod);
-				}
-				else
-				{
-					$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
-					// no proxy, send only the path
-					$this-&gt;_httpsrequest($path, $URI, $this-&gt;_httpmethod);
-				}
-
-				if($this-&gt;_redirectaddr)
-				{
-					/* url was redirected, check if we've hit the max depth */
-					if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
-					{
-						// only follow redirect if it's on this site, or offsiteok is true
-						if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
-						{
-							/* follow the redirect */
-							$this-&gt;_redirectdepth++;
-							$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
-							$this-&gt;fetch($this-&gt;_redirectaddr);
-						}
-					}
-				}
-
-				if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
-				{
-					$frameurls = $this-&gt;_frameurls;
-					$this-&gt;_frameurls = array();
-
-					while(list(,$frameurl) = each($frameurls))
-					{
-						if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
-						{
-							$this-&gt;fetch($frameurl);
-							$this-&gt;_framedepth++;
-						}
-						else
-							break;
-					}
-				}					
-				return true;					
-				break;
-			default:
-				// not a valid protocol
-				$this-&gt;error	=	'Invalid protocol &quot;'.$URI_PARTS[&quot;scheme&quot;].'&quot;\n';
-				return false;
-				break;
-		}		
-		return true;
-	}
-
-/*======================================================================*\
-	Function:	submit
-	Purpose:	submit an http form
-	Input:		$URI	the location to post the data
-				$formvars	the formvars to use.
-					format: $formvars[&quot;var&quot;] = &quot;val&quot;;
-	Output:		$this-&gt;results	the text output from the post
-\*======================================================================*/
-
-	function submit($URI, $formvars=&quot;&quot;, $formfiles=&quot;&quot;)
-	{
-		unset($postdata);
-		
-		$postdata = $this-&gt;_prepare_post_body($formvars, $formfiles);
-			
-		$URI_PARTS = parse_url($URI);
-		if (!empty($URI_PARTS[&quot;user&quot;]))
-			$this-&gt;user = $URI_PARTS[&quot;user&quot;];
-		if (!empty($URI_PARTS[&quot;pass&quot;]))
-			$this-&gt;pass = $URI_PARTS[&quot;pass&quot;];
-				
-		switch($URI_PARTS[&quot;scheme&quot;])
-		{
-			case &quot;http&quot;:
-				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
-				if(!empty($URI_PARTS[&quot;port&quot;]))
-					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
-				if($this-&gt;_connect($fp))
-				{
-					if($this-&gt;_isproxy)
-					{
-						// using proxy, send entire URI
-						$this-&gt;_httprequest($URI,$fp,$URI,$this-&gt;_submit_method,$this-&gt;_submit_type,$postdata);
-					}
-					else
-					{
-						$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
-						// no proxy, send only the path
-						$this-&gt;_httprequest($path, $fp, $URI, $this-&gt;_submit_method, $this-&gt;_submit_type, $postdata);
-					}
-					
-					$this-&gt;_disconnect($fp);
-
-					if($this-&gt;_redirectaddr)
-					{
-						/* url was redirected, check if we've hit the max depth */
-						if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
-						{						
-							if(!preg_match(&quot;|^&quot;.$URI_PARTS[&quot;scheme&quot;].&quot;://|&quot;, $this-&gt;_redirectaddr))
-								$this-&gt;_redirectaddr = $this-&gt;_expandlinks($this-&gt;_redirectaddr,$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$URI_PARTS[&quot;host&quot;]);						
-							
-							// only follow redirect if it's on this site, or offsiteok is true
-							if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
-							{
-								/* follow the redirect */
-								$this-&gt;_redirectdepth++;
-								$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
-								$this-&gt;submit($this-&gt;_redirectaddr,$formvars, $formfiles);
-							}
-						}
-					}
-
-					if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
-					{
-						$frameurls = $this-&gt;_frameurls;
-						$this-&gt;_frameurls = array();
-						
-						while(list(,$frameurl) = each($frameurls))
-						{														
-							if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
-							{
-								$this-&gt;fetch($frameurl);
-								$this-&gt;_framedepth++;
-							}
-							else
-								break;
-						}
-					}					
-					
-				}
-				else
-				{
-					return false;
-				}
-				return true;					
-				break;
-			case &quot;https&quot;:
-				if(!$this-&gt;curl_path || (!is_executable($this-&gt;curl_path)))
-					return false;
-				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
-				if(!empty($URI_PARTS[&quot;port&quot;]))
-					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
-				if($this-&gt;_isproxy)
-				{
-					// using proxy, send entire URI
-					$this-&gt;_httpsrequest($URI, $URI, $this-&gt;_submit_method, $this-&gt;_submit_type, $postdata);
-				}
-				else
-				{
-					$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
-					// no proxy, send only the path
-					$this-&gt;_httpsrequest($path, $URI, $this-&gt;_submit_method, $this-&gt;_submit_type, $postdata);
-				}
-
-				if($this-&gt;_redirectaddr)
-				{
-					/* url was redirected, check if we've hit the max depth */
-					if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
-					{						
-						if(!preg_match(&quot;|^&quot;.$URI_PARTS[&quot;scheme&quot;].&quot;://|&quot;, $this-&gt;_redirectaddr))
-							$this-&gt;_redirectaddr = $this-&gt;_expandlinks($this-&gt;_redirectaddr,$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$URI_PARTS[&quot;host&quot;]);						
-
-						// only follow redirect if it's on this site, or offsiteok is true
-						if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
-						{
-							/* follow the redirect */
-							$this-&gt;_redirectdepth++;
-							$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
-							$this-&gt;submit($this-&gt;_redirectaddr,$formvars, $formfiles);
-						}
-					}
-				}
-
-				if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
-				{
-					$frameurls = $this-&gt;_frameurls;
-					$this-&gt;_frameurls = array();
-
-					while(list(,$frameurl) = each($frameurls))
-					{														
-						if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
-						{
-							$this-&gt;fetch($frameurl);
-							$this-&gt;_framedepth++;
-						}
-						else
-							break;
-					}
-				}					
-				return true;					
-				break;
-				
-			default:
-				// not a valid protocol
-				$this-&gt;error	=	'Invalid protocol &quot;'.$URI_PARTS[&quot;scheme&quot;].'&quot;\n';
-				return false;
-				break;
-		}		
-		return true;
-	}
-
-/*======================================================================*\
-	Function:	fetchlinks
-	Purpose:	fetch the links from a web page
-	Input:		$URI	where you are fetching from
-	Output:		$this-&gt;results	an array of the URLs
-\*======================================================================*/
-
-	function fetchlinks($URI)
-	{
-		if ($this-&gt;fetch($URI))
-		{			
-
-			if(is_array($this-&gt;results))
-			{
-				for($x=0;$x&lt;count($this-&gt;results);$x++)
-					$this-&gt;results[$x] = $this-&gt;_striplinks($this-&gt;results[$x]);
-			}
-			else
-				$this-&gt;results = $this-&gt;_striplinks($this-&gt;results);
-
-			if($this-&gt;expandlinks)
-				$this-&gt;results = $this-&gt;_expandlinks($this-&gt;results, $URI);
-			return true;
-		}
-		else
-			return false;
-	}
-
-/*======================================================================*\
-	Function:	fetchform
-	Purpose:	fetch the form elements from a web page
-	Input:		$URI	where you are fetching from
-	Output:		$this-&gt;results	the resulting html form
-\*======================================================================*/
-
-	function fetchform($URI)
-	{
-		
-		if ($this-&gt;fetch($URI))
-		{			
-
-			if(is_array($this-&gt;results))
-			{
-				for($x=0;$x&lt;count($this-&gt;results);$x++)
-					$this-&gt;results[$x] = $this-&gt;_stripform($this-&gt;results[$x]);
-			}
-			else
-				$this-&gt;results = $this-&gt;_stripform($this-&gt;results);
-			
-			return true;
-		}
-		else
-			return false;
-	}
-	
-	
-/*======================================================================*\
-	Function:	fetchtext
-	Purpose:	fetch the text from a web page, stripping the links
-	Input:		$URI	where you are fetching from
-	Output:		$this-&gt;results	the text from the web page
-\*======================================================================*/
-
-	function fetchtext($URI)
-	{
-		if($this-&gt;fetch($URI))
-		{			
-			if(is_array($this-&gt;results))
-			{
-				for($x=0;$x&lt;count($this-&gt;results);$x++)
-					$this-&gt;results[$x] = $this-&gt;_striptext($this-&gt;results[$x]);
-			}
-			else
-				$this-&gt;results = $this-&gt;_striptext($this-&gt;results);
-			return true;
-		}
-		else
-			return false;
-	}
-
-/*======================================================================*\
-	Function:	submitlinks
-	Purpose:	grab links from a form submission
-	Input:		$URI	where you are submitting from
-	Output:		$this-&gt;results	an array of the links from the post
-\*======================================================================*/
-
-	function submitlinks($URI, $formvars=&quot;&quot;, $formfiles=&quot;&quot;)
-	{
-		if($this-&gt;submit($URI,$formvars, $formfiles))
-		{			
-			if(is_array($this-&gt;results))
-			{
-				for($x=0;$x&lt;count($this-&gt;results);$x++)
-				{
-					$this-&gt;results[$x] = $this-&gt;_striplinks($this-&gt;results[$x]);
-					if($this-&gt;expandlinks)
-						$this-&gt;results[$x] = $this-&gt;_expandlinks($this-&gt;results[$x],$URI);
-				}
-			}
-			else
-			{
-				$this-&gt;results = $this-&gt;_striplinks($this-&gt;results);
-				if($this-&gt;expandlinks)
-					$this-&gt;results = $this-&gt;_expandlinks($this-&gt;results,$URI);
-			}
-			return true;
-		}
-		else
-			return false;
-	}
-
-/*======================================================================*\
-	Function:	submittext
-	Purpose:	grab text from a form submission
-	Input:		$URI	where you are submitting from
-	Output:		$this-&gt;results	the text from the web page
-\*======================================================================*/
-
-	function submittext($URI, $formvars = &quot;&quot;, $formfiles = &quot;&quot;)
-	{
-		if($this-&gt;submit($URI,$formvars, $formfiles))
-		{			
-			if(is_array($this-&gt;results))
-			{
-				for($x=0;$x&lt;count($this-&gt;results);$x++)
-				{
-					$this-&gt;results[$x] = $this-&gt;_striptext($this-&gt;results[$x]);
-					if($this-&gt;expandlinks)
-						$this-&gt;results[$x] = $this-&gt;_expandlinks($this-&gt;results[$x],$URI);
-				}
-			}
-			else
-			{
-				$this-&gt;results = $this-&gt;_striptext($this-&gt;results);
-				if($this-&gt;expandlinks)
-					$this-&gt;results = $this-&gt;_expandlinks($this-&gt;results,$URI);
-			}
-			return true;
-		}
-		else
-			return false;
-	}
-
-	
-
-/*======================================================================*\
-	Function:	set_submit_multipart
-	Purpose:	Set the form submission content type to
-				multipart/form-data
-\*======================================================================*/
-	function set_submit_multipart()
-	{
-		$this-&gt;_submit_type = &quot;multipart/form-data&quot;;
-	}
-
-	
-/*======================================================================*\
-	Function:	set_submit_normal
-	Purpose:	Set the form submission content type to
-				application/x-www-form-urlencoded
-\*======================================================================*/
-	function set_submit_normal()
-	{
-		$this-&gt;_submit_type = &quot;application/x-www-form-urlencoded&quot;;
-	}
-
-
-// XOOPS2 Hack begin
-// Added on March 4, 2003 by <A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">onokazu at xoops.org</A>
-/*======================================================================*\
-	Function:	set_submit_xml
-	Purpose:	Set the submission content type to
-				text/xml
-\*======================================================================*/
-	function set_submit_xml()
-	{
-		$this-&gt;_submit_type = &quot;text/xml&quot;;
-	}
-// XOOPS2 Hack end
-
-
-/*======================================================================*\
-	Private functions
-\*======================================================================*/
-	
-	
-/*======================================================================*\
-	Function:	_striplinks
-	Purpose:	strip the hyperlinks from an html document
-	Input:		$document	document to strip.
-	Output:		$match		an array of the links
-\*======================================================================*/
-
-	function _striplinks($document)
-	{	
-		preg_match_all(&quot;'&lt;\s*a\s.*?href\s*=\s*			# find &lt;a href=
-						([\&quot;\'])?					# find single or double quote
-						(?(1) (.*?)\\1 | ([^\s\&gt;]+))		# if quote found, match up to next matching
-													# quote, otherwise match up to next space
-						'isx&quot;,$document,$links);
-						
-
-		// catenate the non-empty matches from the conditional subpattern
-
-		while(list($key,$val) = each($links[2]))
-		{
-			if(!empty($val))
-				$match[] = $val;
-		}				
-		
-		while(list($key,$val) = each($links[3]))
-		{
-			if(!empty($val))
-				$match[] = $val;
-		}		
-		
-		// return the links
-		return $match;
-	}
-
-/*======================================================================*\
-	Function:	_stripform
-	Purpose:	strip the form elements from an html document
-	Input:		$document	document to strip.
-	Output:		$match		an array of the links
-\*======================================================================*/
-
-	function _stripform($document)
-	{	
-		preg_match_all(&quot;'&lt;\/?(FORM|INPUT|SELECT|TEXTAREA|(OPTION))[^&lt;&gt;]*&gt;(?(2)(.*(?=&lt;\/?(option|select)[^&lt;&gt;]*&gt;[\r\n]*)|(?=[\r\n]*))|(?=[\r\n]*))'Usi&quot;,$document,$elements);
-		
-		// catenate the matches
-		$match = implode(&quot;\r\n&quot;,$elements[0]);
-				
-		// return the links
-		return $match;
-	}
-
-	
-	
-/*======================================================================*\
-	Function:	_striptext
-	Purpose:	strip the text from an html document
-	Input:		$document	document to strip.
-	Output:		$text		the resulting text
-\*======================================================================*/
-
-	function _striptext($document)
-	{
-		
-		// I didn't use preg eval (//e) since that is only available in PHP 4.0.
-		// so, list your entities one by one here. I included some of the
-		// more common ones.
-								
-		$search = array(&quot;'&lt;script[^&gt;]*?&gt;.*?&lt;/script&gt;'si&quot;,	// strip out javascript
-						&quot;'&lt;[\/\!]*?[^&lt;&gt;]*?&gt;'si&quot;,			// strip out html tags
-						&quot;'([\r\n])[\s]+'&quot;,					// strip out white space
-						&quot;'&amp;(quot|#34|#034|#x22);'i&quot;,		// replace html entities
-						&quot;'&amp;(amp|#38|#038|#x26);'i&quot;,			// added hexadecimal values
-						&quot;'&amp;(lt|#60|#060|#x3c);'i&quot;,
-						&quot;'&amp;(gt|#62|#062|#x3e);'i&quot;,
-						&quot;'&amp;(nbsp|#160|#xa0);'i&quot;,
-						&quot;'&amp;(iexcl|#161);'i&quot;,
-						&quot;'&amp;(cent|#162);'i&quot;,
-						&quot;'&amp;(pound|#163);'i&quot;,
-						&quot;'&amp;(copy|#169);'i&quot;,
-						&quot;'&amp;(reg|#174);'i&quot;,
-						&quot;'&amp;(deg|#176);'i&quot;,
-						&quot;'&amp;(#39|#039|#x27);'&quot;,
-						&quot;'&amp;(euro|#8364);'i&quot;,				// europe
-						&quot;'&amp;a(uml|UML);'&quot;,					// german
-						&quot;'&amp;o(uml|UML);'&quot;,
-						&quot;'&amp;u(uml|UML);'&quot;,
-						&quot;'&amp;A(uml|UML);'&quot;,
-						&quot;'&amp;O(uml|UML);'&quot;,
-						&quot;'&amp;U(uml|UML);'&quot;,
-						&quot;'&szlig;'i&quot;,
-						);
-		$replace = array(	&quot;&quot;,
-							&quot;&quot;,
-							&quot;\\1&quot;,
-							&quot;\&quot;&quot;,
-							&quot;&amp;&quot;,
-							&quot;&lt;&quot;,
-							&quot;&gt;&quot;,
-							&quot; &quot;,
-							chr(161),
-							chr(162),
-							chr(163),
-							chr(169),
-							chr(174),
-							chr(176),
-							chr(39),
-							chr(128),
-							chr(228),
-							chr(246),
-							chr(252),
-							chr(196),
-							chr(214),
-							chr(220),
-							chr(223),
-						);
-					
-		$text = preg_replace($search,$replace,$document);
-								
-		return $text;
-	}
-
-/*======================================================================*\
-	Function:	_expandlinks
-	Purpose:	expand each link into a fully qualified URL
-	Input:		$links			the links to qualify
-				$URI			the full URI to get the base from
-	Output:		$expandedLinks	the expanded links
-\*======================================================================*/
-
-	function _expandlinks($links,$URI)
-	{
-		
-		preg_match(&quot;/^[^\?]+/&quot;,$URI,$match);
-
-		$match = preg_replace(&quot;|/[^\/\.]+\.[^\/\.]+$|&quot;,&quot;&quot;,$match[0]);
-				
-		$search = array( 	&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,
-							&quot;|^(?!<A HREF="http://">http://</A>)(\/)?(?!mailto:)|i&quot;,
-							&quot;|/\./|&quot;,
-							&quot;|/[^\/]+/\.\./|&quot;
-						);
-						
-		$replace = array(	&quot;&quot;,
-							$match.&quot;/&quot;,
-							&quot;/&quot;,
-							&quot;/&quot;
-						);			
-				
-		$expandedLinks = preg_replace($search,$replace,$links);
-
-		return $expandedLinks;
-	}
-
-/*======================================================================*\
-	Function:	_httprequest
-	Purpose:	go get the http data from the server
-	Input:		$url		the url to fetch
-				$fp			the current open file pointer
-				$URI		the full URI
-				$body		body contents to send if any (POST)
-	Output:		
-\*======================================================================*/
-	
-	function _httprequest($url,$fp,$URI,$http_method,$content_type=&quot;&quot;,$body=&quot;&quot;)
-	{
-		$cookie_headers = '';
-		if($this-&gt;passcookies &amp;&amp; $this-&gt;_redirectaddr)
-			$this-&gt;setcookies();
-			
-		$URI_PARTS = parse_url($URI);
-		if(empty($url))
-			$url = &quot;/&quot;;
-		$headers = $http_method.&quot; &quot;.$url.&quot; &quot;.$this-&gt;_httpversion.&quot;\r\n&quot;;		
-		if(!empty($this-&gt;agent))
-			$headers .= &quot;User-Agent: &quot;.$this-&gt;agent.&quot;\r\n&quot;;
-		if(!empty($this-&gt;host) &amp;&amp; !isset($this-&gt;rawheaders['Host']))
-			$headers .= &quot;Host: &quot;.$this-&gt;host.&quot;\r\n&quot;;
-		if(!empty($this-&gt;accept))
-			$headers .= &quot;Accept: &quot;.$this-&gt;accept.&quot;\r\n&quot;;
-		if(!empty($this-&gt;referer))
-			$headers .= &quot;Referer: &quot;.$this-&gt;referer.&quot;\r\n&quot;;
-		if(!empty($this-&gt;cookies))
-		{			
-			if(!is_array($this-&gt;cookies))
-				$this-&gt;cookies = (array)$this-&gt;cookies;
-	
-			reset($this-&gt;cookies);
-			if ( count($this-&gt;cookies) &gt; 0 ) {
-				$cookie_headers .= 'Cookie: ';
-				foreach ( $this-&gt;cookies as $cookieKey =&gt; $cookieVal ) {
-				$cookie_headers .= $cookieKey.&quot;=&quot;.urlencode($cookieVal).&quot;; &quot;;
-				}
-				$headers .= substr($cookie_headers,0,-2) . &quot;\r\n&quot;;
-			} 
-		}
-		if(!empty($this-&gt;rawheaders))
-		{
-			if(!is_array($this-&gt;rawheaders))
-				$this-&gt;rawheaders = (array)$this-&gt;rawheaders;
-			while(list($headerKey,$headerVal) = each($this-&gt;rawheaders))
-				$headers .= $headerKey.&quot;: &quot;.$headerVal.&quot;\r\n&quot;;
-		}
-		if(!empty($content_type)) {
-			$headers .= &quot;Content-type: $content_type&quot;;
-			if ($content_type == &quot;multipart/form-data&quot;)
-				$headers .= &quot;; boundary=&quot;.$this-&gt;_mime_boundary;
-			$headers .= &quot;\r\n&quot;;
-		}
-		if(!empty($body))	
-			$headers .= &quot;Content-length: &quot;.strlen($body).&quot;\r\n&quot;;
-		if(!empty($this-&gt;user) || !empty($this-&gt;pass))	
-			$headers .= &quot;Authorization: Basic &quot;.base64_encode($this-&gt;user.&quot;:&quot;.$this-&gt;pass).&quot;\r\n&quot;;
-
-		$headers .= &quot;\r\n&quot;;
-		
-		// set the read timeout if needed
-		if ($this-&gt;read_timeout &gt; 0)
-			socket_set_timeout($fp, $this-&gt;read_timeout);
-		$this-&gt;timed_out = false;
-		
-		fwrite($fp,$headers.$body,strlen($headers.$body));
-		
-		$this-&gt;_redirectaddr = false;
-		unset($this-&gt;headers);
-						
-		while($currentHeader = fgets($fp,$this-&gt;_maxlinelen))
-		{
-			if ($this-&gt;read_timeout &gt; 0 &amp;&amp; $this-&gt;_check_timeout($fp))
-			{
-				$this-&gt;status=-100;
-				return false;
-			}
-				
-			if($currentHeader == &quot;\r\n&quot;)
-				break;
-						
-			// if a header begins with Location: or URI:, set the redirect
-			if(preg_match(&quot;/^(Location:|URI:)/i&quot;,$currentHeader))
-			{
-				// get URL portion of the redirect
-				preg_match(&quot;/^(Location:|URI:)[ ]+(.*)/&quot;,chop($currentHeader),$matches);
-				// look for :// in the Location header to see if hostname is included
-				if(!preg_match(&quot;|\:\/\/|&quot;,$matches[2]))
-				{
-					// no host in the path, so prepend
-					$this-&gt;_redirectaddr = $URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host.&quot;:&quot;.$this-&gt;port;
-					// eliminate double slash
-					if(!preg_match(&quot;|^/|&quot;,$matches[2]))
-							$this-&gt;_redirectaddr .= &quot;/&quot;.$matches[2];
-					else
-							$this-&gt;_redirectaddr .= $matches[2];
-				}
-				else
-					$this-&gt;_redirectaddr = $matches[2];
-			}
-		
-			if(preg_match(&quot;|^HTTP/|&quot;,$currentHeader))
-			{
-                if(preg_match(&quot;|^HTTP/[^\s]*\s(.*?)\s|&quot;,$currentHeader, $status))
-				{
-					$this-&gt;status= $status[1];
-                }				
-				$this-&gt;response_code = $currentHeader;
-			}
-				
-			$this-&gt;headers[] = $currentHeader;
-		}
-
-		$results = '';
-		do {
-    		$_data = fread($fp, $this-&gt;maxlength);
-    		if (strlen($_data) == 0) {
-        		break;
-    		}
-    		$results .= $_data;
-		} while(true);
-
-		if ($this-&gt;read_timeout &gt; 0 &amp;&amp; $this-&gt;_check_timeout($fp))
-		{
-			$this-&gt;status=-100;
-			return false;
-		}
-		
-		// check if there is a a redirect meta tag
-		
-		if(preg_match(&quot;'&lt;meta[\s]*http-equiv[^&gt;]*?content[\s]*=[\s]*[\&quot;\']?\d+;[\s]+URL[\s]*=[\s]*([^\&quot;\']*?)[\&quot;\']?&gt;'i&quot;,$results,$match))
-		{
-			$this-&gt;_redirectaddr = $this-&gt;_expandlinks($match[1],$URI);	
-		}
-
-		// have we hit our frame depth and is there frame src to fetch?
-		if(($this-&gt;_framedepth &lt; $this-&gt;maxframes) &amp;&amp; preg_match_all(&quot;'&lt;frame\s+.*src[\s]*=[\'\&quot;]?([^\'\&quot;\&gt;]+)'i&quot;,$results,$match))
-		{
-			$this-&gt;results[] = $results;
-			for($x=0; $x&lt;count($match[1]); $x++)
-				$this-&gt;_frameurls[] = $this-&gt;_expandlinks($match[1][$x],$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host);
-		}
-		// have we already fetched framed content?
-		elseif(is_array($this-&gt;results))
-			$this-&gt;results[] = $results;
-		// no framed content
-		else
-			$this-&gt;results = $results;
-		
-		return true;
-	}
-
-/*======================================================================*\
-	Function:	_httpsrequest
-	Purpose:	go get the https data from the server using curl
-	Input:		$url		the url to fetch
-				$URI		the full URI
-				$body		body contents to send if any (POST)
-	Output:		
-\*======================================================================*/
-	
-	function _httpsrequest($url,$URI,$http_method,$content_type=&quot;&quot;,$body=&quot;&quot;)
-	{
-		if($this-&gt;passcookies &amp;&amp; $this-&gt;_redirectaddr)
-			$this-&gt;setcookies();
-
-		$headers = array();		
-					
-		$URI_PARTS = parse_url($URI);
-		if(empty($url))
-			$url = &quot;/&quot;;
-		// GET ... header not needed for curl
-		//$headers[] = $http_method.&quot; &quot;.$url.&quot; &quot;.$this-&gt;_httpversion;		
-		if(!empty($this-&gt;agent))
-			$headers[] = &quot;User-Agent: &quot;.$this-&gt;agent;
-		if(!empty($this-&gt;host))
-			$headers[] = &quot;Host: &quot;.$this-&gt;host;
-		if(!empty($this-&gt;accept))
-			$headers[] = &quot;Accept: &quot;.$this-&gt;accept;
-		if(!empty($this-&gt;referer))
-			$headers[] = &quot;Referer: &quot;.$this-&gt;referer;
-		if(!empty($this-&gt;cookies))
-		{			
-			if(!is_array($this-&gt;cookies))
-				$this-&gt;cookies = (array)$this-&gt;cookies;
-	
-			reset($this-&gt;cookies);
-			if ( count($this-&gt;cookies) &gt; 0 ) {
-				$cookie_str = 'Cookie: ';
-				foreach ( $this-&gt;cookies as $cookieKey =&gt; $cookieVal ) {
-				$cookie_str .= $cookieKey.&quot;=&quot;.urlencode($cookieVal).&quot;; &quot;;
-				}
-				$headers[] = substr($cookie_str,0,-2);
-			}
-		}
-		if(!empty($this-&gt;rawheaders))
-		{
-			if(!is_array($this-&gt;rawheaders))
-				$this-&gt;rawheaders = (array)$this-&gt;rawheaders;
-			while(list($headerKey,$headerVal) = each($this-&gt;rawheaders))
-				$headers[] = $headerKey.&quot;: &quot;.$headerVal;
-		}
-		if(!empty($content_type)) {
-			if ($content_type == &quot;multipart/form-data&quot;)
-				$headers[] = &quot;Content-type: $content_type; boundary=&quot;.$this-&gt;_mime_boundary;
-			else
-				$headers[] = &quot;Content-type: $content_type&quot;;
-		}
-		if(!empty($body))	
-			$headers[] = &quot;Content-length: &quot;.strlen($body);
-		if(!empty($this-&gt;user) || !empty($this-&gt;pass))	
-			$headers[] = &quot;Authorization: BASIC &quot;.base64_encode($this-&gt;user.&quot;:&quot;.$this-&gt;pass);
-			
-		for($curr_header = 0; $curr_header &lt; count($headers); $curr_header++)
-			$cmdline_params .= &quot; -H \&quot;&quot;.$headers[$curr_header].&quot;\&quot;&quot;;
-		
-		if(!empty($body))
-			$cmdline_params .= &quot; -d \&quot;$body\&quot;&quot;;
-		
-		if($this-&gt;read_timeout &gt; 0)
-			$cmdline_params .= &quot; -m &quot;.$this-&gt;read_timeout;
-		
-		$headerfile = uniqid(time());
-
-		exec($this-&gt;curl_path.&quot; -D \&quot;/tmp/$headerfile\&quot;&quot;.$cmdline_params.&quot; &quot;.$URI,$results,$return);
-		
-		if($return)
-		{
-			$this-&gt;error = &quot;Error: cURL could not retrieve the document, error $return.&quot;;
-			return false;
-		}
-			
-			
-		$results = implode(&quot;\r\n&quot;,$results);
-		
-		$result_headers = file(&quot;/tmp/$headerfile&quot;);
-						
-		$this-&gt;_redirectaddr = false;
-		unset($this-&gt;headers);
-						
-		for($currentHeader = 0; $currentHeader &lt; count($result_headers); $currentHeader++)
-		{
-			
-			// if a header begins with Location: or URI:, set the redirect
-			if(preg_match(&quot;/^(Location: |URI: )/i&quot;,$result_headers[$currentHeader]))
-			{
-				// get URL portion of the redirect
-				preg_match(&quot;/^(Location: |URI:)\s+(.*)/&quot;,chop($result_headers[$currentHeader]),$matches);
-				// look for :// in the Location header to see if hostname is included
-				if(!preg_match(&quot;|\:\/\/|&quot;,$matches[2]))
-				{
-					// no host in the path, so prepend
-					$this-&gt;_redirectaddr = $URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host.&quot;:&quot;.$this-&gt;port;
-					// eliminate double slash
-					if(!preg_match(&quot;|^/|&quot;,$matches[2]))
-							$this-&gt;_redirectaddr .= &quot;/&quot;.$matches[2];
-					else
-							$this-&gt;_redirectaddr .= $matches[2];
-				}
-				else
-					$this-&gt;_redirectaddr = $matches[2];
-			}
-		
-			if(preg_match(&quot;|^HTTP/|&quot;,$result_headers[$currentHeader]))
-				$this-&gt;response_code = $result_headers[$currentHeader];
-
-			$this-&gt;headers[] = $result_headers[$currentHeader];
-		}
-
-		// check if there is a a redirect meta tag
-		
-		if(preg_match(&quot;'&lt;meta[\s]*http-equiv[^&gt;]*?content[\s]*=[\s]*[\&quot;\']?\d+;[\s]+URL[\s]*=[\s]*([^\&quot;\']*?)[\&quot;\']?&gt;'i&quot;,$results,$match))
-		{
-			$this-&gt;_redirectaddr = $this-&gt;_expandlinks($match[1],$URI);	
-		}
-
-		// have we hit our frame depth and is there frame src to fetch?
-		if(($this-&gt;_framedepth &lt; $this-&gt;maxframes) &amp;&amp; preg_match_all(&quot;'&lt;frame\s+.*src[\s]*=[\'\&quot;]?([^\'\&quot;\&gt;]+)'i&quot;,$results,$match))
-		{
-			$this-&gt;results[] = $results;
-			for($x=0; $x&lt;count($match[1]); $x++)
-				$this-&gt;_frameurls[] = $this-&gt;_expandlinks($match[1][$x],$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host);
-		}
-		// have we already fetched framed content?
-		elseif(is_array($this-&gt;results))
-			$this-&gt;results[] = $results;
-		// no framed content
-		else
-			$this-&gt;results = $results;
-
-		unlink(&quot;/tmp/$headerfile&quot;);
-		
-		return true;
-	}
-
-/*======================================================================*\
-	Function:	setcookies()
-	Purpose:	set cookies for a redirection
-\*======================================================================*/
-	
-	function setcookies()
-	{
-		for($x=0; $x&lt;count($this-&gt;headers); $x++)
-		{
-		if(preg_match('/^set-cookie:[\s]+([^=]+)=([^;]+)/i', $this-&gt;headers[$x],$match))
-			$this-&gt;cookies[$match[1]] = $match[2];
-		}
-	}
-
-	
-/*======================================================================*\
-	Function:	_check_timeout
-	Purpose:	checks whether timeout has occurred
-	Input:		$fp	file pointer
-\*======================================================================*/
-
-	function _check_timeout($fp)
-	{
-		if ($this-&gt;read_timeout &gt; 0) {
-			$fp_status = socket_get_status($fp);
-			if ($fp_status[&quot;timed_out&quot;]) {
-				$this-&gt;timed_out = true;
-				return true;
-			}
-		}
-		return false;
-	}
-
-/*======================================================================*\
-	Function:	_connect
-	Purpose:	make a socket connection
-	Input:		$fp	file pointer
-\*======================================================================*/
-	
-	function _connect(&amp;$fp)
-	{
-		if(!empty($this-&gt;proxy_host) &amp;&amp; !empty($this-&gt;proxy_port))
-			{
-				$this-&gt;_isproxy = true;
-				$host = $this-&gt;proxy_host;
-				$port = $this-&gt;proxy_port;
-			}
-		else
-		{
-			$host = $this-&gt;host;
-			$port = $this-&gt;port;
-		}
-	
-		$this-&gt;status = 0;
-		
-		if($fp = fsockopen(
-					$host,
-					$port,
-					$errno,
-					$errstr,
-					$this-&gt;_fp_timeout
-					))
-		{
-			// socket connection succeeded
-
-			return true;
-		}
-		else
-		{
-			// socket connection failed
-			$this-&gt;status = $errno;
-			switch($errno)
-			{
-				case -3:
-					$this-&gt;error=&quot;socket creation failed (-3)&quot;;
-				case -4:
-					$this-&gt;error=&quot;dns lookup failure (-4)&quot;;
-				case -5:
-					$this-&gt;error=&quot;connection refused or timed out (-5)&quot;;
-				default:
-					$this-&gt;error=&quot;connection failed (&quot;.$errno.&quot;)&quot;;
-			}
-			return false;
-		}
-	}
-/*======================================================================*\
-	Function:	_disconnect
-	Purpose:	disconnect a socket connection
-	Input:		$fp	file pointer
-\*======================================================================*/
-	
-	function _disconnect($fp)
-	{
-		return(fclose($fp));
-	}
-
-	
-/*======================================================================*\
-	Function:	_prepare_post_body
-	Purpose:	Prepare post body according to encoding type
-	Input:		$formvars  - form variables
-				$formfiles - form upload files
-	Output:		post body
-\*======================================================================*/
-	
-	function _prepare_post_body($formvars, $formfiles)
-	{
-		settype($formvars, &quot;array&quot;);
-		settype($formfiles, &quot;array&quot;);
-
-		if (count($formvars) == 0 &amp;&amp; count($formfiles) == 0)
-			return;
-		
-		switch ($this-&gt;_submit_type) {
-			case &quot;application/x-www-form-urlencoded&quot;:
-				reset($formvars);
-				while(list($key,$val) = each($formvars)) {
-					if (is_array($val) || is_object($val)) {
-						while (list($cur_key, $cur_val) = each($val)) {
-							$postdata .= urlencode($key).&quot;[]=&quot;.urlencode($cur_val).&quot;&amp;&quot;;
-						}
-					} else
-						$postdata .= urlencode($key).&quot;=&quot;.urlencode($val).&quot;&amp;&quot;;
-				}
-				break;
-
-			case &quot;multipart/form-data&quot;:
-				$this-&gt;_mime_boundary = &quot;Snoopy&quot;.md5(uniqid(microtime()));
-				
-				reset($formvars);
-				while(list($key,$val) = each($formvars)) {
-					if (is_array($val) || is_object($val)) {
-						while (list($cur_key, $cur_val) = each($val)) {
-							$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
-							$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$key\[\]\&quot;\r\n\r\n&quot;;
-							$postdata .= &quot;$cur_val\r\n&quot;;
-						}
-					} else {
-						$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
-						$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$key\&quot;\r\n\r\n&quot;;
-						$postdata .= &quot;$val\r\n&quot;;
-					}
-				}
-				
-				reset($formfiles);
-				while (list($field_name, $file_names) = each($formfiles)) {
-					settype($file_names, &quot;array&quot;);
-					while (list(, $file_name) = each($file_names)) {
-						if (!is_readable($file_name)) continue;
-
-						$fp = fopen($file_name, &quot;r&quot;);
-						$file_content = fread($fp, filesize($file_name));
-						fclose($fp);
-						$base_name = basename($file_name);
-
-						$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
-						$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$field_name\&quot;; filename=\&quot;$base_name\&quot;\r\n\r\n&quot;;
-						$postdata .= &quot;$file_content\r\n&quot;;
-					}
-				}
-				$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;--\r\n&quot;;
-				break;
-			// XOOPS2 Hack begin
-			// Added on March 4, 2003 by <A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">onokazu at xoops.org</A>
-			case &quot;text/xml&quot;:
-			default:
-				$postdata = $formvars[0];
-				break;
-			// XOOPS2 Hack end
-		}
-
-		return $postdata;
-	}
-}
-
-?&gt;
+&lt;?php
+
+/*************************************************
+
+Snoopy - the PHP net client
+Author: Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">monte at ispi.net</A>&gt;
+Copyright (c): 1999-2000 ispi, all rights reserved
+Version: 1.01
+
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+You may contact the author of Snoopy by e-mail at:
<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">+monte at ispi.net</A>
+
+Or, write to:
+Monte Ohrt
+CTO, ispi
+237 S. 70th suite 220
+Lincoln, NE 68510
+
+The latest version of Snoopy can be obtained from:
+<A HREF="http://snoopy.sourceforge.net/">http://snoopy.sourceforge.net/</A>
+
+*************************************************/
+
+class Snoopy
+{
+	/**** Public variables ****/
+	
+	/* user definable vars */
+
+	var $host			=	&quot;www.php.net&quot;;		// host name we are connecting to
+	var $port			=	80;					// port we are connecting to
+	var $proxy_host		=	&quot;&quot;;					// proxy host to use
+	var $proxy_port		=	&quot;&quot;;					// proxy port to use
+	var $proxy_user		=	&quot;&quot;;					// proxy user to use
+	var $proxy_pass		=	&quot;&quot;;					// proxy password to use
+	
+	var $agent			=	&quot;Snoopy v1.2.3&quot;;	// agent we masquerade as
+	var	$referer		=	&quot;&quot;;					// referer info to pass
+	var $cookies		=	array();			// array of cookies to pass
+												// $cookies[&quot;username&quot;]=&quot;joe&quot;;
+	var	$rawheaders		=	array();			// array of raw headers to send
+												// $rawheaders[&quot;Content-type&quot;]=&quot;text/html&quot;;
+
+	var $maxredirs		=	5;					// http redirection depth maximum. 0 = disallow
+	var $lastredirectaddr	=	&quot;&quot;;				// contains address of last redirected address
+	var	$offsiteok		=	true;				// allows redirection off-site
+	var $maxframes		=	0;					// frame content depth maximum. 0 = disallow
+	var $expandlinks	=	true;				// expand links to fully qualified URLs.
+												// this only applies to fetchlinks()
+												// submitlinks(), and submittext()
+	var $passcookies	=	true;				// pass set cookies back through redirects
+												// NOTE: this currently does not respect
+												// dates, domains or paths.
+	
+	var	$user			=	&quot;&quot;;					// user for http authentication
+	var	$pass			=	&quot;&quot;;					// password for http authentication
+	
+	// http accept types
+	var $accept			=	&quot;image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*&quot;;
+	
+	var $results		=	&quot;&quot;;					// where the content is put
+		
+	var $error			=	&quot;&quot;;					// error messages sent here
+	var	$response_code	=	&quot;&quot;;					// response code returned from server
+	var	$headers		=	array();			// headers returned from server sent here
+	var	$maxlength		=	500000;				// max return data length (body)
+	var $read_timeout	=	0;					// timeout on read operations, in seconds
+												// supported only since PHP 4 Beta 4
+												// set to 0 to disallow timeouts
+	var $timed_out		=	false;				// if a read operation timed out
+	var	$status			=	0;					// http request status
+
+	var $temp_dir		=	&quot;/tmp&quot;;				// temporary directory that the webserver
+												// has permission to write to.
+												// under Windows, this should be C:\temp
+
+	var	$curl_path		=	&quot;/usr/local/bin/curl&quot;;
+												// Snoopy will use cURL for fetching
+												// SSL content if a full system path to
+												// the cURL binary is supplied here.
+												// set to false if you do not have
+												// cURL installed. See <A HREF="http://curl.haxx.se">http://curl.haxx.se</A>
+												// for details on installing cURL.
+												// Snoopy does *not* use the cURL
+												// library functions built into php,
+												// as these functions are not stable
+												// as of this Snoopy release.
+	
+	/**** Private variables ****/	
+	
+	var	$_maxlinelen	=	4096;				// max line length (headers)
+	
+	var $_httpmethod	=	&quot;GET&quot;;				// default http request method
+	var $_httpversion	=	&quot;HTTP/1.0&quot;;			// default http request version
+	var $_submit_method	=	&quot;POST&quot;;				// default submit method
+	var $_submit_type	=	&quot;application/x-www-form-urlencoded&quot;;	// default submit type
+	var $_mime_boundary	=   &quot;&quot;;					// MIME boundary for multipart/form-data submit type
+	var $_redirectaddr	=	false;				// will be set if page fetched is a redirect
+	var $_redirectdepth	=	0;					// increments on an http redirect
+	var $_frameurls		= 	array();			// frame src urls
+	var $_framedepth	=	0;					// increments on frame depth
+	
+	var $_isproxy		=	false;				// set if using a proxy server
+	var $_fp_timeout	=	30;					// timeout for socket connection
+
+/*======================================================================*\
+	Function:	fetch
+	Purpose:	fetch the contents of a web page
+				(and possibly other protocols in the
+				future like ftp, nntp, gopher, etc.)
+	Input:		$URI	the location of the page to fetch
+	Output:		$this-&gt;results	the output text from the fetch
+\*======================================================================*/
+
+	function fetch($URI)
+	{
+	
+		//preg_match(&quot;|^([^:]+)://([^:/]+)(:[\d]+)*(.*)|&quot;,$URI,$URI_PARTS);
+		$URI_PARTS = parse_url($URI);
+		if (!empty($URI_PARTS[&quot;user&quot;]))
+			$this-&gt;user = $URI_PARTS[&quot;user&quot;];
+		if (!empty($URI_PARTS[&quot;pass&quot;]))
+			$this-&gt;pass = $URI_PARTS[&quot;pass&quot;];
+		if (empty($URI_PARTS[&quot;query&quot;]))
+			$URI_PARTS[&quot;query&quot;] = '';
+		if (empty($URI_PARTS[&quot;path&quot;]))
+			$URI_PARTS[&quot;path&quot;] = '';
+				
+		switch(strtolower($URI_PARTS[&quot;scheme&quot;]))
+		{
+			case &quot;http&quot;:
+				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
+				if(!empty($URI_PARTS[&quot;port&quot;]))
+					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
+				if($this-&gt;_connect($fp))
+				{
+					if($this-&gt;_isproxy)
+					{
+						// using proxy, send entire URI
+						$this-&gt;_httprequest($URI,$fp,$URI,$this-&gt;_httpmethod);
+					}
+					else
+					{
+						$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
+						// no proxy, send only the path
+						$this-&gt;_httprequest($path, $fp, $URI, $this-&gt;_httpmethod);
+					}
+					
+					$this-&gt;_disconnect($fp);
+
+					if($this-&gt;_redirectaddr)
+					{
+						/* url was redirected, check if we've hit the max depth */
+						if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
+						{
+							// only follow redirect if it's on this site, or offsiteok is true
+							if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
+							{
+								/* follow the redirect */
+								$this-&gt;_redirectdepth++;
+								$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
+								$this-&gt;fetch($this-&gt;_redirectaddr);
+							}
+						}
+					}
+
+					if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
+					{
+						$frameurls = $this-&gt;_frameurls;
+						$this-&gt;_frameurls = array();
+						
+						while(list(,$frameurl) = each($frameurls))
+						{
+							if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
+							{
+								$this-&gt;fetch($frameurl);
+								$this-&gt;_framedepth++;
+							}
+							else
+								break;
+						}
+					}					
+				}
+				else
+				{
+					return false;
+				}
+				return true;					
+				break;
+			case &quot;https&quot;:
+				if(!$this-&gt;curl_path)
+					return false;
+				if(function_exists(&quot;is_executable&quot;))
+				    if (!is_executable($this-&gt;curl_path))
+				        return false;
+				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
+				if(!empty($URI_PARTS[&quot;port&quot;]))
+					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
+				if($this-&gt;_isproxy)
+				{
+					// using proxy, send entire URI
+					$this-&gt;_httpsrequest($URI,$URI,$this-&gt;_httpmethod);
+				}
+				else
+				{
+					$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
+					// no proxy, send only the path
+					$this-&gt;_httpsrequest($path, $URI, $this-&gt;_httpmethod);
+				}
+
+				if($this-&gt;_redirectaddr)
+				{
+					/* url was redirected, check if we've hit the max depth */
+					if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
+					{
+						// only follow redirect if it's on this site, or offsiteok is true
+						if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
+						{
+							/* follow the redirect */
+							$this-&gt;_redirectdepth++;
+							$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
+							$this-&gt;fetch($this-&gt;_redirectaddr);
+						}
+					}
+				}
+
+				if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
+				{
+					$frameurls = $this-&gt;_frameurls;
+					$this-&gt;_frameurls = array();
+
+					while(list(,$frameurl) = each($frameurls))
+					{
+						if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
+						{
+							$this-&gt;fetch($frameurl);
+							$this-&gt;_framedepth++;
+						}
+						else
+							break;
+					}
+				}					
+				return true;					
+				break;
+			default:
+				// not a valid protocol
+				$this-&gt;error	=	'Invalid protocol &quot;'.$URI_PARTS[&quot;scheme&quot;].'&quot;\n';
+				return false;
+				break;
+		}		
+		return true;
+	}
+
+/*======================================================================*\
+	Function:	submit
+	Purpose:	submit an http form
+	Input:		$URI	the location to post the data
+				$formvars	the formvars to use.
+					format: $formvars[&quot;var&quot;] = &quot;val&quot;;
+				$formfiles  an array of files to submit
+					format: $formfiles[&quot;var&quot;] = &quot;/dir/filename.ext&quot;;
+	Output:		$this-&gt;results	the text output from the post
+\*======================================================================*/
+
+	function submit($URI, $formvars=&quot;&quot;, $formfiles=&quot;&quot;)
+	{
+		unset($postdata);
+		
+		$postdata = $this-&gt;_prepare_post_body($formvars, $formfiles);
+			
+		$URI_PARTS = parse_url($URI);
+		if (!empty($URI_PARTS[&quot;user&quot;]))
+			$this-&gt;user = $URI_PARTS[&quot;user&quot;];
+		if (!empty($URI_PARTS[&quot;pass&quot;]))
+			$this-&gt;pass = $URI_PARTS[&quot;pass&quot;];
+		if (empty($URI_PARTS[&quot;query&quot;]))
+			$URI_PARTS[&quot;query&quot;] = '';
+		if (empty($URI_PARTS[&quot;path&quot;]))
+			$URI_PARTS[&quot;path&quot;] = '';
+
+		switch(strtolower($URI_PARTS[&quot;scheme&quot;]))
+		{
+			case &quot;http&quot;:
+				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
+				if(!empty($URI_PARTS[&quot;port&quot;]))
+					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
+				if($this-&gt;_connect($fp))
+				{
+					if($this-&gt;_isproxy)
+					{
+						// using proxy, send entire URI
+						$this-&gt;_httprequest($URI,$fp,$URI,$this-&gt;_submit_method,$this-&gt;_submit_type,$postdata);
+					}
+					else
+					{
+						$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
+						// no proxy, send only the path
+						$this-&gt;_httprequest($path, $fp, $URI, $this-&gt;_submit_method, $this-&gt;_submit_type, $postdata);
+					}
+					
+					$this-&gt;_disconnect($fp);
+
+					if($this-&gt;_redirectaddr)
+					{
+						/* url was redirected, check if we've hit the max depth */
+						if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
+						{						
+							if(!preg_match(&quot;|^&quot;.$URI_PARTS[&quot;scheme&quot;].&quot;://|&quot;, $this-&gt;_redirectaddr))
+								$this-&gt;_redirectaddr = $this-&gt;_expandlinks($this-&gt;_redirectaddr,$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$URI_PARTS[&quot;host&quot;]);						
+							
+							// only follow redirect if it's on this site, or offsiteok is true
+							if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
+							{
+								/* follow the redirect */
+								$this-&gt;_redirectdepth++;
+								$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
+								if( strpos( $this-&gt;_redirectaddr, &quot;?&quot; ) &gt; 0 )
+									$this-&gt;fetch($this-&gt;_redirectaddr); // the redirect has changed the request method from post to get
+								else
+									$this-&gt;submit($this-&gt;_redirectaddr,$formvars, $formfiles);
+							}
+						}
+					}
+
+					if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
+					{
+						$frameurls = $this-&gt;_frameurls;
+						$this-&gt;_frameurls = array();
+						
+						while(list(,$frameurl) = each($frameurls))
+						{														
+							if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
+							{
+								$this-&gt;fetch($frameurl);
+								$this-&gt;_framedepth++;
+							}
+							else
+								break;
+						}
+					}					
+					
+				}
+				else
+				{
+					return false;
+				}
+				return true;					
+				break;
+			case &quot;https&quot;:
+				if(!$this-&gt;curl_path)
+					return false;
+				if(function_exists(&quot;is_executable&quot;))
+				    if (!is_executable($this-&gt;curl_path))
+				        return false;
+				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
+				if(!empty($URI_PARTS[&quot;port&quot;]))
+					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
+				if($this-&gt;_isproxy)
+				{
+					// using proxy, send entire URI
+					$this-&gt;_httpsrequest($URI, $URI, $this-&gt;_submit_method, $this-&gt;_submit_type, $postdata);
+				}
+				else
+				{
+					$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
+					// no proxy, send only the path
+					$this-&gt;_httpsrequest($path, $URI, $this-&gt;_submit_method, $this-&gt;_submit_type, $postdata);
+				}
+
+				if($this-&gt;_redirectaddr)
+				{
+					/* url was redirected, check if we've hit the max depth */
+					if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
+					{						
+						if(!preg_match(&quot;|^&quot;.$URI_PARTS[&quot;scheme&quot;].&quot;://|&quot;, $this-&gt;_redirectaddr))
+							$this-&gt;_redirectaddr = $this-&gt;_expandlinks($this-&gt;_redirectaddr,$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$URI_PARTS[&quot;host&quot;]);						
+
+						// only follow redirect if it's on this site, or offsiteok is true
+						if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
+						{
+							/* follow the redirect */
+							$this-&gt;_redirectdepth++;
+							$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
+							if( strpos( $this-&gt;_redirectaddr, &quot;?&quot; ) &gt; 0 )
+								$this-&gt;fetch($this-&gt;_redirectaddr); // the redirect has changed the request method from post to get
+							else
+								$this-&gt;submit($this-&gt;_redirectaddr,$formvars, $formfiles);
+						}
+					}
+				}
+
+				if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
+				{
+					$frameurls = $this-&gt;_frameurls;
+					$this-&gt;_frameurls = array();
+
+					while(list(,$frameurl) = each($frameurls))
+					{														
+						if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
+						{
+							$this-&gt;fetch($frameurl);
+							$this-&gt;_framedepth++;
+						}
+						else
+							break;
+					}
+				}					
+				return true;					
+				break;
+				
+			default:
+				// not a valid protocol
+				$this-&gt;error	=	'Invalid protocol &quot;'.$URI_PARTS[&quot;scheme&quot;].'&quot;\n';
+				return false;
+				break;
+		}		
+		return true;
+	}
+
+/*======================================================================*\
+	Function:	fetchlinks
+	Purpose:	fetch the links from a web page
+	Input:		$URI	where you are fetching from
+	Output:		$this-&gt;results	an array of the URLs
+\*======================================================================*/
+
+	function fetchlinks($URI)
+	{
+		if ($this-&gt;fetch($URI))
+		{			
+			if($this-&gt;lastredirectaddr)
+				$URI = $this-&gt;lastredirectaddr;
+			if(is_array($this-&gt;results))
+			{
+				for($x=0;$x&lt;count($this-&gt;results);$x++)
+					$this-&gt;results[$x] = $this-&gt;_striplinks($this-&gt;results[$x]);
+			}
+			else
+				$this-&gt;results = $this-&gt;_striplinks($this-&gt;results);
+
+			if($this-&gt;expandlinks)
+				$this-&gt;results = $this-&gt;_expandlinks($this-&gt;results, $URI);
+			return true;
+		}
+		else
+			return false;
+	}
+
+/*======================================================================*\
+	Function:	fetchform
+	Purpose:	fetch the form elements from a web page
+	Input:		$URI	where you are fetching from
+	Output:		$this-&gt;results	the resulting html form
+\*======================================================================*/
+
+	function fetchform($URI)
+	{
+		
+		if ($this-&gt;fetch($URI))
+		{			
+
+			if(is_array($this-&gt;results))
+			{
+				for($x=0;$x&lt;count($this-&gt;results);$x++)
+					$this-&gt;results[$x] = $this-&gt;_stripform($this-&gt;results[$x]);
+			}
+			else
+				$this-&gt;results = $this-&gt;_stripform($this-&gt;results);
+			
+			return true;
+		}
+		else
+			return false;
+	}
+	
+	
+/*======================================================================*\
+	Function:	fetchtext
+	Purpose:	fetch the text from a web page, stripping the links
+	Input:		$URI	where you are fetching from
+	Output:		$this-&gt;results	the text from the web page
+\*======================================================================*/
+
+	function fetchtext($URI)
+	{
+		if($this-&gt;fetch($URI))
+		{			
+			if(is_array($this-&gt;results))
+			{
+				for($x=0;$x&lt;count($this-&gt;results);$x++)
+					$this-&gt;results[$x] = $this-&gt;_striptext($this-&gt;results[$x]);
+			}
+			else
+				$this-&gt;results = $this-&gt;_striptext($this-&gt;results);
+			return true;
+		}
+		else
+			return false;
+	}
+
+/*======================================================================*\
+	Function:	submitlinks
+	Purpose:	grab links from a form submission
+	Input:		$URI	where you are submitting from
+	Output:		$this-&gt;results	an array of the links from the post
+\*======================================================================*/
+
+	function submitlinks($URI, $formvars=&quot;&quot;, $formfiles=&quot;&quot;)
+	{
+		if($this-&gt;submit($URI,$formvars, $formfiles))
+		{			
+			if($this-&gt;lastredirectaddr)
+				$URI = $this-&gt;lastredirectaddr;
+			if(is_array($this-&gt;results))
+			{
+				for($x=0;$x&lt;count($this-&gt;results);$x++)
+				{
+					$this-&gt;results[$x] = $this-&gt;_striplinks($this-&gt;results[$x]);
+					if($this-&gt;expandlinks)
+						$this-&gt;results[$x] = $this-&gt;_expandlinks($this-&gt;results[$x],$URI);
+				}
+			}
+			else
+			{
+				$this-&gt;results = $this-&gt;_striplinks($this-&gt;results);
+				if($this-&gt;expandlinks)
+					$this-&gt;results = $this-&gt;_expandlinks($this-&gt;results,$URI);
+			}
+			return true;
+		}
+		else
+			return false;
+	}
+
+/*======================================================================*\
+	Function:	submittext
+	Purpose:	grab text from a form submission
+	Input:		$URI	where you are submitting from
+	Output:		$this-&gt;results	the text from the web page
+\*======================================================================*/
+
+	function submittext($URI, $formvars = &quot;&quot;, $formfiles = &quot;&quot;)
+	{
+		if($this-&gt;submit($URI,$formvars, $formfiles))
+		{			
+			if($this-&gt;lastredirectaddr)
+				$URI = $this-&gt;lastredirectaddr;
+			if(is_array($this-&gt;results))
+			{
+				for($x=0;$x&lt;count($this-&gt;results);$x++)
+				{
+					$this-&gt;results[$x] = $this-&gt;_striptext($this-&gt;results[$x]);
+					if($this-&gt;expandlinks)
+						$this-&gt;results[$x] = $this-&gt;_expandlinks($this-&gt;results[$x],$URI);
+				}
+			}
+			else
+			{
+				$this-&gt;results = $this-&gt;_striptext($this-&gt;results);
+				if($this-&gt;expandlinks)
+					$this-&gt;results = $this-&gt;_expandlinks($this-&gt;results,$URI);
+			}
+			return true;
+		}
+		else
+			return false;
+	}
+
+	
+
+/*======================================================================*\
+	Function:	set_submit_multipart
+	Purpose:	Set the form submission content type to
+				multipart/form-data
+\*======================================================================*/
+	function set_submit_multipart()
+	{
+		$this-&gt;_submit_type = &quot;multipart/form-data&quot;;
+	}
+
+	
+/*======================================================================*\
+	Function:	set_submit_normal
+	Purpose:	Set the form submission content type to
+				application/x-www-form-urlencoded
+\*======================================================================*/
+	function set_submit_normal()
+	{
+		$this-&gt;_submit_type = &quot;application/x-www-form-urlencoded&quot;;
+	}
+
+	
+	
+
+/*======================================================================*\
+	Private functions
+\*======================================================================*/
+	
+	
+/*======================================================================*\
+	Function:	_striplinks
+	Purpose:	strip the hyperlinks from an html document
+	Input:		$document	document to strip.
+	Output:		$match		an array of the links
+\*======================================================================*/
+
+	function _striplinks($document)
+	{	
+		preg_match_all(&quot;'&lt;\s*a\s.*?href\s*=\s*			# find &lt;a href=
+						([\&quot;\'])?					# find single or double quote
+						(?(1) (.*?)\\1 | ([^\s\&gt;]+))		# if quote found, match up to next matching
+													# quote, otherwise match up to next space
+						'isx&quot;,$document,$links);
+						
+
+		// catenate the non-empty matches from the conditional subpattern
+
+		while(list($key,$val) = each($links[2]))
+		{
+			if(!empty($val))
+				$match[] = $val;
+		}				
+		
+		while(list($key,$val) = each($links[3]))
+		{
+			if(!empty($val))
+				$match[] = $val;
+		}		
+		
+		// return the links
+		return $match;
+	}
+
+/*======================================================================*\
+	Function:	_stripform
+	Purpose:	strip the form elements from an html document
+	Input:		$document	document to strip.
+	Output:		$match		an array of the links
+\*======================================================================*/
+
+	function _stripform($document)
+	{	
+		preg_match_all(&quot;'&lt;\/?(FORM|INPUT|SELECT|TEXTAREA|(OPTION))[^&lt;&gt;]*&gt;(?(2)(.*(?=&lt;\/?(option|select)[^&lt;&gt;]*&gt;[\r\n]*)|(?=[\r\n]*))|(?=[\r\n]*))'Usi&quot;,$document,$elements);
+		
+		// catenate the matches
+		$match = implode(&quot;\r\n&quot;,$elements[0]);
+				
+		// return the links
+		return $match;
+	}
+
+	
+	
+/*======================================================================*\
+	Function:	_striptext
+	Purpose:	strip the text from an html document
+	Input:		$document	document to strip.
+	Output:		$text		the resulting text
+\*======================================================================*/
+
+	function _striptext($document)
+	{
+		
+		// I didn't use preg eval (//e) since that is only available in PHP 4.0.
+		// so, list your entities one by one here. I included some of the
+		// more common ones.
+								
+		$search = array(&quot;'&lt;script[^&gt;]*?&gt;.*?&lt;/script&gt;'si&quot;,	// strip out javascript
+						&quot;'&lt;[\/\!]*?[^&lt;&gt;]*?&gt;'si&quot;,			// strip out html tags
+						&quot;'([\r\n])[\s]+'&quot;,					// strip out white space
+						&quot;'&amp;(quot|#34|#034|#x22);'i&quot;,		// replace html entities
+						&quot;'&amp;(amp|#38|#038|#x26);'i&quot;,			// added hexadecimal values
+						&quot;'&amp;(lt|#60|#060|#x3c);'i&quot;,
+						&quot;'&amp;(gt|#62|#062|#x3e);'i&quot;,
+						&quot;'&amp;(nbsp|#160|#xa0);'i&quot;,
+						&quot;'&amp;(iexcl|#161);'i&quot;,
+						&quot;'&amp;(cent|#162);'i&quot;,
+						&quot;'&amp;(pound|#163);'i&quot;,
+						&quot;'&amp;(copy|#169);'i&quot;,
+						&quot;'&amp;(reg|#174);'i&quot;,
+						&quot;'&amp;(deg|#176);'i&quot;,
+						&quot;'&amp;(#39|#039|#x27);'&quot;,
+						&quot;'&amp;(euro|#8364);'i&quot;,				// europe
+						&quot;'&amp;a(uml|UML);'&quot;,					// german
+						&quot;'&amp;o(uml|UML);'&quot;,
+						&quot;'&amp;u(uml|UML);'&quot;,
+						&quot;'&amp;A(uml|UML);'&quot;,
+						&quot;'&amp;O(uml|UML);'&quot;,
+						&quot;'&amp;U(uml|UML);'&quot;,
+						&quot;'&szlig;'i&quot;,
+						);
+		$replace = array(	&quot;&quot;,
+							&quot;&quot;,
+							&quot;\\1&quot;,
+							&quot;\&quot;&quot;,
+							&quot;&amp;&quot;,
+							&quot;&lt;&quot;,
+							&quot;&gt;&quot;,
+							&quot; &quot;,
+							chr(161),
+							chr(162),
+							chr(163),
+							chr(169),
+							chr(174),
+							chr(176),
+							chr(39),
+							chr(128),
+							&quot;&#228;&quot;,
+							&quot;&#246;&quot;,
+							&quot;&#252;&quot;,
+							&quot;&#196;&quot;,
+							&quot;&#214;&quot;,
+							&quot;&#220;&quot;,
+							&quot;&#223;&quot;,
+						);
+					
+		$text = preg_replace($search,$replace,$document);
+								
+		return $text;
+	}
+
+/*======================================================================*\
+	Function:	_expandlinks
+	Purpose:	expand each link into a fully qualified URL
+	Input:		$links			the links to qualify
+				$URI			the full URI to get the base from
+	Output:		$expandedLinks	the expanded links
+\*======================================================================*/
+
+	function _expandlinks($links,$URI)
+	{
+		
+		preg_match(&quot;/^[^\?]+/&quot;,$URI,$match);
+
+		$match = preg_replace(&quot;|/[^\/\.]+\.[^\/\.]+$|&quot;,&quot;&quot;,$match[0]);
+		$match = preg_replace(&quot;|/$|&quot;,&quot;&quot;,$match);
+		$match_part = parse_url($match);
+		$match_root =
+		$match_part[&quot;scheme&quot;].&quot;://&quot;.$match_part[&quot;host&quot;];
+				
+		$search = array( 	&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,
+							&quot;|^(\/)|i&quot;,
+							&quot;|^(?!<A HREF="http://">http://</A>)(?!mailto:)|i&quot;,
+							&quot;|/\./|&quot;,
+							&quot;|/[^\/]+/\.\./|&quot;
+						);
+						
+		$replace = array(	&quot;&quot;,
+							$match_root.&quot;/&quot;,
+							$match.&quot;/&quot;,
+							&quot;/&quot;,
+							&quot;/&quot;
+						);			
+				
+		$expandedLinks = preg_replace($search,$replace,$links);
+
+		return $expandedLinks;
+	}
+
+/*======================================================================*\
+	Function:	_httprequest
+	Purpose:	go get the http data from the server
+	Input:		$url		the url to fetch
+				$fp			the current open file pointer
+				$URI		the full URI
+				$body		body contents to send if any (POST)
+	Output:		
+\*======================================================================*/
+	
+	function _httprequest($url,$fp,$URI,$http_method,$content_type=&quot;&quot;,$body=&quot;&quot;)
+	{
+		$cookie_headers = '';
+		if($this-&gt;passcookies &amp;&amp; $this-&gt;_redirectaddr)
+			$this-&gt;setcookies();
+			
+		$URI_PARTS = parse_url($URI);
+		if(empty($url))
+			$url = &quot;/&quot;;
+		$headers = $http_method.&quot; &quot;.$url.&quot; &quot;.$this-&gt;_httpversion.&quot;\r\n&quot;;		
+		if(!empty($this-&gt;agent))
+			$headers .= &quot;User-Agent: &quot;.$this-&gt;agent.&quot;\r\n&quot;;
+		if(!empty($this-&gt;host) &amp;&amp; !isset($this-&gt;rawheaders['Host'])) {
+			$headers .= &quot;Host: &quot;.$this-&gt;host;
+			if(!empty($this-&gt;port))
+				$headers .= &quot;:&quot;.$this-&gt;port;
+			$headers .= &quot;\r\n&quot;;
+		}
+		if(!empty($this-&gt;accept))
+			$headers .= &quot;Accept: &quot;.$this-&gt;accept.&quot;\r\n&quot;;
+		if(!empty($this-&gt;referer))
+			$headers .= &quot;Referer: &quot;.$this-&gt;referer.&quot;\r\n&quot;;
+		if(!empty($this-&gt;cookies))
+		{			
+			if(!is_array($this-&gt;cookies))
+				$this-&gt;cookies = (array)$this-&gt;cookies;
+	
+			reset($this-&gt;cookies);
+			if ( count($this-&gt;cookies) &gt; 0 ) {
+				$cookie_headers .= 'Cookie: ';
+				foreach ( $this-&gt;cookies as $cookieKey =&gt; $cookieVal ) {
+				$cookie_headers .= $cookieKey.&quot;=&quot;.urlencode($cookieVal).&quot;; &quot;;
+				}
+				$headers .= substr($cookie_headers,0,-2) . &quot;\r\n&quot;;
+			} 
+		}
+		if(!empty($this-&gt;rawheaders))
+		{
+			if(!is_array($this-&gt;rawheaders))
+				$this-&gt;rawheaders = (array)$this-&gt;rawheaders;
+			while(list($headerKey,$headerVal) = each($this-&gt;rawheaders))
+				$headers .= $headerKey.&quot;: &quot;.$headerVal.&quot;\r\n&quot;;
+		}
+		if(!empty($content_type)) {
+			$headers .= &quot;Content-type: $content_type&quot;;
+			if ($content_type == &quot;multipart/form-data&quot;)
+				$headers .= &quot;; boundary=&quot;.$this-&gt;_mime_boundary;
+			$headers .= &quot;\r\n&quot;;
+		}
+		if(!empty($body))	
+			$headers .= &quot;Content-length: &quot;.strlen($body).&quot;\r\n&quot;;
+		if(!empty($this-&gt;user) || !empty($this-&gt;pass))	
+			$headers .= &quot;Authorization: Basic &quot;.base64_encode($this-&gt;user.&quot;:&quot;.$this-&gt;pass).&quot;\r\n&quot;;
+		
+		//add proxy auth headers
+		if(!empty($this-&gt;proxy_user))	
+			$headers .= 'Proxy-Authorization: ' . 'Basic ' . base64_encode($this-&gt;proxy_user . ':' . $this-&gt;proxy_pass).&quot;\r\n&quot;;
+
+
+		$headers .= &quot;\r\n&quot;;
+		
+		// set the read timeout if needed
+		if ($this-&gt;read_timeout &gt; 0)
+			socket_set_timeout($fp, $this-&gt;read_timeout);
+		$this-&gt;timed_out = false;
+		
+		fwrite($fp,$headers.$body,strlen($headers.$body));
+		
+		$this-&gt;_redirectaddr = false;
+		unset($this-&gt;headers);
+						
+		while($currentHeader = fgets($fp,$this-&gt;_maxlinelen))
+		{
+			if ($this-&gt;read_timeout &gt; 0 &amp;&amp; $this-&gt;_check_timeout($fp))
+			{
+				$this-&gt;status=-100;
+				return false;
+			}
+				
+			if($currentHeader == &quot;\r\n&quot;)
+				break;
+						
+			// if a header begins with Location: or URI:, set the redirect
+			if(preg_match(&quot;/^(Location:|URI:)/i&quot;,$currentHeader))
+			{
+				// get URL portion of the redirect
+				preg_match(&quot;/^(Location:|URI:)[ ]+(.*)/i&quot;,chop($currentHeader),$matches);
+				// look for :// in the Location header to see if hostname is included
+				if(!preg_match(&quot;|\:\/\/|&quot;,$matches[2]))
+				{
+					// no host in the path, so prepend
+					$this-&gt;_redirectaddr = $URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host.&quot;:&quot;.$this-&gt;port;
+					// eliminate double slash
+					if(!preg_match(&quot;|^/|&quot;,$matches[2]))
+							$this-&gt;_redirectaddr .= &quot;/&quot;.$matches[2];
+					else
+							$this-&gt;_redirectaddr .= $matches[2];
+				}
+				else
+					$this-&gt;_redirectaddr = $matches[2];
+			}
+		
+			if(preg_match(&quot;|^HTTP/|&quot;,$currentHeader))
+			{
+                if(preg_match(&quot;|^HTTP/[^\s]*\s(.*?)\s|&quot;,$currentHeader, $status))
+				{
+					$this-&gt;status= $status[1];
+                }				
+				$this-&gt;response_code = $currentHeader;
+			}
+				
+			$this-&gt;headers[] = $currentHeader;
+		}
+
+		$results = '';
+		do {
+    		$_data = fread($fp, $this-&gt;maxlength);
+    		if (strlen($_data) == 0) {
+        		break;
+    		}
+    		$results .= $_data;
+		} while(true);
+
+		if ($this-&gt;read_timeout &gt; 0 &amp;&amp; $this-&gt;_check_timeout($fp))
+		{
+			$this-&gt;status=-100;
+			return false;
+		}
+		
+		// check if there is a a redirect meta tag
+		
+		if(preg_match(&quot;'&lt;meta[\s]*http-equiv[^&gt;]*?content[\s]*=[\s]*[\&quot;\']?\d+;[\s]*URL[\s]*=[\s]*([^\&quot;\']*?)[\&quot;\']?&gt;'i&quot;,$results,$match))
+
+		{
+			$this-&gt;_redirectaddr = $this-&gt;_expandlinks($match[1],$URI);	
+		}
+
+		// have we hit our frame depth and is there frame src to fetch?
+		if(($this-&gt;_framedepth &lt; $this-&gt;maxframes) &amp;&amp; preg_match_all(&quot;'&lt;frame\s+.*src[\s]*=[\'\&quot;]?([^\'\&quot;\&gt;]+)'i&quot;,$results,$match))
+		{
+			$this-&gt;results[] = $results;
+			for($x=0; $x&lt;count($match[1]); $x++)
+				$this-&gt;_frameurls[] = $this-&gt;_expandlinks($match[1][$x],$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host);
+		}
+		// have we already fetched framed content?
+		elseif(is_array($this-&gt;results))
+			$this-&gt;results[] = $results;
+		// no framed content
+		else
+			$this-&gt;results = $results;
+		
+		return true;
+	}
+
+/*======================================================================*\
+	Function:	_httpsrequest
+	Purpose:	go get the https data from the server using curl
+	Input:		$url		the url to fetch
+				$URI		the full URI
+				$body		body contents to send if any (POST)
+	Output:		
+\*======================================================================*/
+	
+	function _httpsrequest($url,$URI,$http_method,$content_type=&quot;&quot;,$body=&quot;&quot;)
+	{
+		if($this-&gt;passcookies &amp;&amp; $this-&gt;_redirectaddr)
+			$this-&gt;setcookies();
+
+		$headers = array();		
+					
+		$URI_PARTS = parse_url($URI);
+		if(empty($url))
+			$url = &quot;/&quot;;
+		// GET ... header not needed for curl
+		//$headers[] = $http_method.&quot; &quot;.$url.&quot; &quot;.$this-&gt;_httpversion;		
+		if(!empty($this-&gt;agent))
+			$headers[] = &quot;User-Agent: &quot;.$this-&gt;agent;
+		if(!empty($this-&gt;host))
+			if(!empty($this-&gt;port))
+				$headers[] = &quot;Host: &quot;.$this-&gt;host.&quot;:&quot;.$this-&gt;port;
+			else
+				$headers[] = &quot;Host: &quot;.$this-&gt;host;
+		if(!empty($this-&gt;accept))
+			$headers[] = &quot;Accept: &quot;.$this-&gt;accept;
+		if(!empty($this-&gt;referer))
+			$headers[] = &quot;Referer: &quot;.$this-&gt;referer;
+		if(!empty($this-&gt;cookies))
+		{			
+			if(!is_array($this-&gt;cookies))
+				$this-&gt;cookies = (array)$this-&gt;cookies;
+	
+			reset($this-&gt;cookies);
+			if ( count($this-&gt;cookies) &gt; 0 ) {
+				$cookie_str = 'Cookie: ';
+				foreach ( $this-&gt;cookies as $cookieKey =&gt; $cookieVal ) {
+				$cookie_str .= $cookieKey.&quot;=&quot;.urlencode($cookieVal).&quot;; &quot;;
+				}
+				$headers[] = substr($cookie_str,0,-2);
+			}
+		}
+		if(!empty($this-&gt;rawheaders))
+		{
+			if(!is_array($this-&gt;rawheaders))
+				$this-&gt;rawheaders = (array)$this-&gt;rawheaders;
+			while(list($headerKey,$headerVal) = each($this-&gt;rawheaders))
+				$headers[] = $headerKey.&quot;: &quot;.$headerVal;
+		}
+		if(!empty($content_type)) {
+			if ($content_type == &quot;multipart/form-data&quot;)
+				$headers[] = &quot;Content-type: $content_type; boundary=&quot;.$this-&gt;_mime_boundary;
+			else
+				$headers[] = &quot;Content-type: $content_type&quot;;
+		}
+		if(!empty($body))	
+			$headers[] = &quot;Content-length: &quot;.strlen($body);
+		if(!empty($this-&gt;user) || !empty($this-&gt;pass))	
+			$headers[] = &quot;Authorization: BASIC &quot;.base64_encode($this-&gt;user.&quot;:&quot;.$this-&gt;pass);
+			
+		for($curr_header = 0; $curr_header &lt; count($headers); $curr_header++) {
+			$safer_header = strtr( $headers[$curr_header], &quot;\&quot;&quot;, &quot; &quot; );
+			$cmdline_params .= &quot; -H \&quot;&quot;.$safer_header.&quot;\&quot;&quot;;
+		}
+		
+		if(!empty($body))
+			$cmdline_params .= &quot; -d \&quot;$body\&quot;&quot;;
+		
+		if($this-&gt;read_timeout &gt; 0)
+			$cmdline_params .= &quot; -m &quot;.$this-&gt;read_timeout;
+		
+		$headerfile = tempnam($temp_dir, &quot;sno&quot;);
+
+		$safer_URI = strtr( $URI, &quot;\&quot;&quot;, &quot; &quot; ); // strip quotes from the URI to avoid shell access
+		exec($this-&gt;curl_path.&quot; -D \&quot;$headerfile\&quot;&quot;.$cmdline_params.&quot; \&quot;&quot;.$safer_URI.&quot;\&quot;&quot;,$results,$return);
+		
+		if($return)
+		{
+			$this-&gt;error = &quot;Error: cURL could not retrieve the document, error $return.&quot;;
+			return false;
+		}
+			
+			
+		$results = implode(&quot;\r\n&quot;,$results);
+		
+		$result_headers = file(&quot;$headerfile&quot;);
+						
+		$this-&gt;_redirectaddr = false;
+		unset($this-&gt;headers);
+						
+		for($currentHeader = 0; $currentHeader &lt; count($result_headers); $currentHeader++)
+		{
+			
+			// if a header begins with Location: or URI:, set the redirect
+			if(preg_match(&quot;/^(Location: |URI: )/i&quot;,$result_headers[$currentHeader]))
+			{
+				// get URL portion of the redirect
+				preg_match(&quot;/^(Location: |URI:)\s+(.*)/&quot;,chop($result_headers[$currentHeader]),$matches);
+				// look for :// in the Location header to see if hostname is included
+				if(!preg_match(&quot;|\:\/\/|&quot;,$matches[2]))
+				{
+					// no host in the path, so prepend
+					$this-&gt;_redirectaddr = $URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host.&quot;:&quot;.$this-&gt;port;
+					// eliminate double slash
+					if(!preg_match(&quot;|^/|&quot;,$matches[2]))
+							$this-&gt;_redirectaddr .= &quot;/&quot;.$matches[2];
+					else
+							$this-&gt;_redirectaddr .= $matches[2];
+				}
+				else
+					$this-&gt;_redirectaddr = $matches[2];
+			}
+		
+			if(preg_match(&quot;|^HTTP/|&quot;,$result_headers[$currentHeader]))
+				$this-&gt;response_code = $result_headers[$currentHeader];
+
+			$this-&gt;headers[] = $result_headers[$currentHeader];
+		}
+
+		// check if there is a a redirect meta tag
+		
+		if(preg_match(&quot;'&lt;meta[\s]*http-equiv[^&gt;]*?content[\s]*=[\s]*[\&quot;\']?\d+;[\s]*URL[\s]*=[\s]*([^\&quot;\']*?)[\&quot;\']?&gt;'i&quot;,$results,$match))
+		{
+			$this-&gt;_redirectaddr = $this-&gt;_expandlinks($match[1],$URI);	
+		}
+
+		// have we hit our frame depth and is there frame src to fetch?
+		if(($this-&gt;_framedepth &lt; $this-&gt;maxframes) &amp;&amp; preg_match_all(&quot;'&lt;frame\s+.*src[\s]*=[\'\&quot;]?([^\'\&quot;\&gt;]+)'i&quot;,$results,$match))
+		{
+			$this-&gt;results[] = $results;
+			for($x=0; $x&lt;count($match[1]); $x++)
+				$this-&gt;_frameurls[] = $this-&gt;_expandlinks($match[1][$x],$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host);
+		}
+		// have we already fetched framed content?
+		elseif(is_array($this-&gt;results))
+			$this-&gt;results[] = $results;
+		// no framed content
+		else
+			$this-&gt;results = $results;
+
+		unlink(&quot;$headerfile&quot;);
+		
+		return true;
+	}
+
+/*======================================================================*\
+	Function:	setcookies()
+	Purpose:	set cookies for a redirection
+\*======================================================================*/
+	
+	function setcookies()
+	{
+		for($x=0; $x&lt;count($this-&gt;headers); $x++)
+		{
+		if(preg_match('/^set-cookie:[\s]+([^=]+)=([^;]+)/i', $this-&gt;headers[$x],$match))
+			$this-&gt;cookies[$match[1]] = urldecode($match[2]);
+		}
+	}
+
+	
+/*======================================================================*\
+	Function:	_check_timeout
+	Purpose:	checks whether timeout has occurred
+	Input:		$fp	file pointer
+\*======================================================================*/
+
+	function _check_timeout($fp)
+	{
+		if ($this-&gt;read_timeout &gt; 0) {
+			$fp_status = socket_get_status($fp);
+			if ($fp_status[&quot;timed_out&quot;]) {
+				$this-&gt;timed_out = true;
+				return true;
+			}
+		}
+		return false;
+	}
+
+/*======================================================================*\
+	Function:	_connect
+	Purpose:	make a socket connection
+	Input:		$fp	file pointer
+\*======================================================================*/
+	
+	function _connect(&amp;$fp)
+	{
+		if(!empty($this-&gt;proxy_host) &amp;&amp; !empty($this-&gt;proxy_port))
+			{
+				$this-&gt;_isproxy = true;
+				
+				$host = $this-&gt;proxy_host;
+				$port = $this-&gt;proxy_port;
+			}
+		else
+		{
+			$host = $this-&gt;host;
+			$port = $this-&gt;port;
+		}
+	
+		$this-&gt;status = 0;
+		
+		if($fp = fsockopen(
+					$host,
+					$port,
+					$errno,
+					$errstr,
+					$this-&gt;_fp_timeout
+					))
+		{
+			// socket connection succeeded
+
+			return true;
+		}
+		else
+		{
+			// socket connection failed
+			$this-&gt;status = $errno;
+			switch($errno)
+			{
+				case -3:
+					$this-&gt;error=&quot;socket creation failed (-3)&quot;;
+				case -4:
+					$this-&gt;error=&quot;dns lookup failure (-4)&quot;;
+				case -5:
+					$this-&gt;error=&quot;connection refused or timed out (-5)&quot;;
+				default:
+					$this-&gt;error=&quot;connection failed (&quot;.$errno.&quot;)&quot;;
+			}
+			return false;
+		}
+	}
+/*======================================================================*\
+	Function:	_disconnect
+	Purpose:	disconnect a socket connection
+	Input:		$fp	file pointer
+\*======================================================================*/
+	
+	function _disconnect($fp)
+	{
+		return(fclose($fp));
+	}
+
+	
+/*======================================================================*\
+	Function:	_prepare_post_body
+	Purpose:	Prepare post body according to encoding type
+	Input:		$formvars  - form variables
+				$formfiles - form upload files
+	Output:		post body
+\*======================================================================*/
+	
+	function _prepare_post_body($formvars, $formfiles)
+	{
+		settype($formvars, &quot;array&quot;);
+		settype($formfiles, &quot;array&quot;);
+		$postdata = '';
+
+		if (count($formvars) == 0 &amp;&amp; count($formfiles) == 0)
+			return;
+		
+		switch ($this-&gt;_submit_type) {
+			case &quot;application/x-www-form-urlencoded&quot;:
+				reset($formvars);
+				while(list($key,$val) = each($formvars)) {
+					if (is_array($val) || is_object($val)) {
+						while (list($cur_key, $cur_val) = each($val)) {
+							$postdata .= urlencode($key).&quot;[]=&quot;.urlencode($cur_val).&quot;&amp;&quot;;
+						}
+					} else
+						$postdata .= urlencode($key).&quot;=&quot;.urlencode($val).&quot;&amp;&quot;;
+				}
+				break;
+
+			case &quot;multipart/form-data&quot;:
+				$this-&gt;_mime_boundary = &quot;Snoopy&quot;.md5(uniqid(microtime()));
+				
+				reset($formvars);
+				while(list($key,$val) = each($formvars)) {
+					if (is_array($val) || is_object($val)) {
+						while (list($cur_key, $cur_val) = each($val)) {
+							$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
+							$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$key\[\]\&quot;\r\n\r\n&quot;;
+							$postdata .= &quot;$cur_val\r\n&quot;;
+						}
+					} else {
+						$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
+						$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$key\&quot;\r\n\r\n&quot;;
+						$postdata .= &quot;$val\r\n&quot;;
+					}
+				}
+				
+				reset($formfiles);
+				while (list($field_name, $file_names) = each($formfiles)) {
+					settype($file_names, &quot;array&quot;);
+					while (list(, $file_name) = each($file_names)) {
+						if (!is_readable($file_name)) continue;
+
+						$fp = fopen($file_name, &quot;r&quot;);
+						$file_content = fread($fp, filesize($file_name));
+						fclose($fp);
+						$base_name = basename($file_name);
+
+						$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
+						$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$field_name\&quot;; filename=\&quot;$base_name\&quot;\r\n\r\n&quot;;
+						$postdata .= &quot;$file_content\r\n&quot;;
+					}
+				}
+				$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;--\r\n&quot;;
+				break;
+		}
+
+		return $postdata;
+	}
+}
+
+?&gt;

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/include/version.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/include/version.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/include/version.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -1,4 +1,4 @@
 &lt;?php
 // $Id$
-define(&quot;XOOPS_VERSION&quot;,&quot;XOOPS 2.0.13.2&quot;);
+define( &quot;XOOPS_VERSION&quot;, &quot;XOOPS 2.3.0-dev&quot; );
 ?&gt;
\ No newline at end of file

Modified: XoopsCore/branches/2.3.x/2.3-main/htdocs/mainfile.dist.php
===================================================================
--- XoopsCore/branches/2.3.x/2.3-main/htdocs/mainfile.dist.php	2005-11-20 04:21:59 UTC (rev 14)
+++ XoopsCore/branches/2.3.x/2.3-main/htdocs/mainfile.dist.php	2005-11-20 04:41:49 UTC (rev 15)
@@ -28,6 +28,11 @@
 if ( !defined(&quot;XOOPS_MAINFILE_INCLUDED&quot;) ) {
 	define(&quot;XOOPS_MAINFILE_INCLUDED&quot;,1);
 
+	// Physical path to your XOOPS directory
+	// Physical path to your main XOOPS directory WITHOUT trailing slash
+	// Example: define('XOOPS_ROOT_PATH', '/path/to/xoops/directory');
+	define('XOOPS_ROOT_PATH', '');
+
 	// XOOPS Physical Path
 	// Physical path to your main XOOPS directory WITHOUT trailing slash
 	// Example: define('XOOPS_ROOT_PATH', '/path/to/xoops/directory');


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000007.html">[Xoops4-svn] r14 - XoopsCore/branches/2.3.x
</A></li>
	<LI>Next message: <A HREF="000009.html">[Xoops4-svn] r16 - in XoopsCore/branches/2.3.x/2.3-main: . XOOPS XOOPS-data XOOPS-data/Application Support XOOPS-data/Caches htdocs htdocs/include upgrade
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8">[ date ]</a>
              <a href="thread.html#8">[ thread ]</a>
              <a href="subject.html#8">[ subject ]</a>
              <a href="author.html#8">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/xoops4-svn">More information about the Xoops4-svn
mailing list</a><br>
</body></html>
