<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Xoops4-svn] r185 - in XoopsCore/branches/2.2.x/2.2-main: docs html html/class html/class/xml html/class/xoopseditor/dhtmltextarea html/class/xoopseditor/koivi html/class/xoopseditor/koivi/include html/class/xoopseditor/textarea html/include html/install html/kernel html/language/english html/modules/pm html/modules/pm/templates html/modules/profile html/modules/profile/admin html/modules/profile/include html/modules/system html/modules/system/admin/banners html/modules/system/admin/groups html/modules/system/admin/mailusers html/modules/system/admin/preferences html/modules/system/admin/smilies html/modules/system/admin/tplsets html/modules/system/blocks html/modules/system/include html/modules/system/templates html/themes/default/css html/themes/xmt/css
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/xoops4-svn/2006-January/index.html" >
   <LINK REL="made" HREF="mailto:xoops4-svn%40lists.berlios.de?Subject=Re%3A%20%5BXoops4-svn%5D%20r185%20-%20in%20XoopsCore/branches/2.2.x/2.2-main%3A%20docs%20html%20html/class%20html/class/xml%20html/class/xoopseditor/dhtmltextarea%20html/class/xoopseditor/koivi%20html/class/xoopseditor/koivi/include%20html/class/xoopseditor/textarea%20html/include%20html/install%20html/kernel%20html/language/english%20html/modules/pm%20html/modules/pm/templates%20html/modules/profile%20html/modules/profile/admin%20html/modules/profile/include%20html/modules/system%20html/modules/system/admin/banners%20html/modules/system/admin/groups%20html/modules/system/admin/mailusers%20html/modules/system/admin/preferences%20html/modules/system/admin/smilies%20html/modules/system/admin/tplsets%20html/modules/system/blocks%20html/modules/system/include%20html/modules/system/templates%20html/themes/default/css%20html/themes/xmt/css&In-Reply-To=%3C200601222349.k0MNn8jG006497%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000176.html">
   <LINK REL="Next"  HREF="000178.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Xoops4-svn] r185 - in XoopsCore/branches/2.2.x/2.2-main: docs html html/class html/class/xml html/class/xoopseditor/dhtmltextarea html/class/xoopseditor/koivi html/class/xoopseditor/koivi/include html/class/xoopseditor/textarea html/include html/install html/kernel html/language/english html/modules/pm html/modules/pm/templates html/modules/profile html/modules/profile/admin html/modules/profile/include html/modules/system html/modules/system/admin/banners html/modules/system/admin/groups html/modules/system/admin/mailusers html/modules/system/admin/preferences html/modules/system/admin/smilies html/modules/system/admin/tplsets html/modules/system/blocks html/modules/system/include html/modules/system/templates html/themes/default/css html/themes/xmt/css</H1>
    <B>skalpa at BerliOS</B> 
    <A HREF="mailto:xoops4-svn%40lists.berlios.de?Subject=Re%3A%20%5BXoops4-svn%5D%20r185%20-%20in%20XoopsCore/branches/2.2.x/2.2-main%3A%20docs%20html%20html/class%20html/class/xml%20html/class/xoopseditor/dhtmltextarea%20html/class/xoopseditor/koivi%20html/class/xoopseditor/koivi/include%20html/class/xoopseditor/textarea%20html/include%20html/install%20html/kernel%20html/language/english%20html/modules/pm%20html/modules/pm/templates%20html/modules/profile%20html/modules/profile/admin%20html/modules/profile/include%20html/modules/system%20html/modules/system/admin/banners%20html/modules/system/admin/groups%20html/modules/system/admin/mailusers%20html/modules/system/admin/preferences%20html/modules/system/admin/smilies%20html/modules/system/admin/tplsets%20html/modules/system/blocks%20html/modules/system/include%20html/modules/system/templates%20html/themes/default/css%20html/themes/xmt/css&In-Reply-To=%3C200601222349.k0MNn8jG006497%40sheep.berlios.de%3E"
       TITLE="[Xoops4-svn] r185 - in XoopsCore/branches/2.2.x/2.2-main: docs html html/class html/class/xml html/class/xoopseditor/dhtmltextarea html/class/xoopseditor/koivi html/class/xoopseditor/koivi/include html/class/xoopseditor/textarea html/include html/install html/kernel html/language/english html/modules/pm html/modules/pm/templates html/modules/profile html/modules/profile/admin html/modules/profile/include html/modules/system html/modules/system/admin/banners html/modules/system/admin/groups html/modules/system/admin/mailusers html/modules/system/admin/preferences html/modules/system/admin/smilies html/modules/system/admin/tplsets html/modules/system/blocks html/modules/system/include html/modules/system/templates html/themes/default/css html/themes/xmt/css">skalpa at berlios.de
       </A><BR>
    <I>Mon Jan 23 00:49:08 CET 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000176.html">[Xoops4-svn] r184 - in XoopsCore/branches: . 2.2.x 2.2.x/2.2-main 2.2.x/2.2-main/docs 2.2.x/2.2-main/docs/images 2.2.x/2.2-main/extras 2.2.x/2.2-main/extras/theme_x2t 2.2.x/2.2-main/extras/theme_x2t/doc 2.2.x/2.2-main/extras/theme_x2t/extras 2.2.x/2.2-main/html 2.2.x/2.2-main/html/cache 2.2.x/2.2-main/html/class 2.2.x/2.2-main/html/class/auth 2.2.x/2.2-main/html/class/calendar 2.2.x/2.2-main/html/class/calendar/CSS 2.2.x/2.2-main/html/class/calendar/doc 2.2.x/2.2-main/html/class/calendar/doc/html 2.2.x/2.2-main/html/class/calendar/lang 2.2.x/2.2-main/html/class/database 2.2.x/2.2-main/html/class/mail 2.2.x/2.2-main/html/class/mail/phpmailer 2.2.x/2.2-main/html/class/smarty 2.2.x/2.2-main/html/class/smarty/configs 2.2.x/2.2-main/html/class/smarty/core 2.2.x/2.2-main/html/class/smarty/plugins 2.2.x/2.2-main/html/class/snoopy 2.2.x/2.2-main/html/class/xml 2.2.x/2.2-main/html/class/xml/rpc 2.2.x/2.2-main/html/class/xml/rss 2.2.x/2.2-main/html/class/xoopseditor 2.2.x/2.2-main/html/cl! ass/xoopseditor/dhtmltextarea 2.2.x/2.2-main/html/class/xoopseditor/dhtmltextarea/language 2.2.x/2.2-main/html/class/xoopseditor/koivi 2.2.x/2.2-main/html/class/xoopseditor/koivi/class 2.2.x/2.2-main/html/class/xoopseditor/koivi/images 2.2.x/2.2-main/html/class/xoopseditor/koivi/include 2.2.x/2.2-main/html/class/xoopseditor/koivi/include/js 2.2.x/2.2-main/html/class/xoopseditor/koivi/language 2.2.x/2.2-main/html/class/xoopseditor/koivi/skins 2.2.x/2.2-main/html/class/xoopseditor/koivi/skins/common 2.2.x/2.2-main/html/class/xoopseditor/koivi/skins/default 2.2.x/2.2-main/html/class/xoopseditor/koivi/skins/xp 2.2.x/2.2-main/html/class/xoopseditor/textarea 2.2.x/2.2-main/html/class/xoopseditor/textarea/language 2.2.x/2.2-main/html/class/xoopsform 2.2.x/2.2-main/html/images 2.2.x/2.2-main/html/images/banners 2.2.x/2.2-main/html/images/icons 2.2.x/2.2-main/html/images/subject 2.2.x/2.2-main/html/include 2.2.x/2.2-main/html/install 2.2.x/2.2-main/html/install/class 2.2.x/2.2-main/! html/install/img 2.2.x/2.2-main/html/install/language 2.2.x/2.! 2-main/h
</A></li>
        <LI>Next message: <A HREF="000178.html">[Xoops4-svn] r186 - XoopsCore/branches/2.2.x/2.2-main/html
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#177">[ date ]</a>
              <a href="thread.html#177">[ thread ]</a>
              <a href="subject.html#177">[ subject ]</a>
              <a href="author.html#177">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: skalpa
Date: 2006-01-23 00:49:01 +0100 (Mon, 23 Jan 2006)
New Revision: 185

Modified:
   XoopsCore/branches/2.2.x/2.2-main/docs/changelog.txt
   XoopsCore/branches/2.2.x/2.2-main/html/banners.php
   XoopsCore/branches/2.2.x/2.2-main/html/changelog.txt
   XoopsCore/branches/2.2.x/2.2-main/html/class/mimetypes.inc.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/module.textsanitizer.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/theme.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/tree.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/xml/saxparser.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/xoopscomments.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/dhtmltextarea/editor_registry.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/koivi/editor_registry.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/koivi/include/functions.inc.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/textarea/editor_registry.php
   XoopsCore/branches/2.2.x/2.2-main/html/class/xoopstree.php
   XoopsCore/branches/2.2.x/2.2-main/html/header.php
   XoopsCore/branches/2.2.x/2.2-main/html/imagemanager.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/checklogin.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/comment_form.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/comment_post.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/cp_functions.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/functions.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/notification_functions.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/notification_update.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/version.php
   XoopsCore/branches/2.2.x/2.2-main/html/include/xoopscodes.php
   XoopsCore/branches/2.2.x/2.2-main/html/install/index.php
   XoopsCore/branches/2.2.x/2.2-main/html/install/install_tpl.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/blockinstance.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/config.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/member.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/module.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/object.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/online.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/profile.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/profilefield.php
   XoopsCore/branches/2.2.x/2.2-main/html/kernel/tplfile.php
   XoopsCore/branches/2.2.x/2.2-main/html/language/english/local.php
   XoopsCore/branches/2.2.x/2.2-main/html/lostpass.php
   XoopsCore/branches/2.2.x/2.2-main/html/mainfile.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/readpmsg.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/templates/pm_viewpmsg.html
   XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/xoops_version.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/activate.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/admin/user.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/edituser.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/include/forms.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/include/functions.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/register.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/search.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/userinfo.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/banners/banners.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/groups/groups.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/mailusers/mailform.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/mailusers/mailusers.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/preferences/main.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/smilies/smilies.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/tplsets/main.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/tplsets/themeimgform.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/blocks/system_blocks.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/include/update.php
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/templates/system_imagemanager2.html
   XoopsCore/branches/2.2.x/2.2-main/html/modules/system/templates/system_userinfo.html
   XoopsCore/branches/2.2.x/2.2-main/html/pda.php
   XoopsCore/branches/2.2.x/2.2-main/html/search.php
   XoopsCore/branches/2.2.x/2.2-main/html/themes/default/css/style.css
   XoopsCore/branches/2.2.x/2.2-main/html/themes/xmt/css/style.css
   XoopsCore/branches/2.2.x/2.2-main/html/user.php
   XoopsCore/branches/2.2.x/2.2-main/html/xmlrpc.php
Log:
Sending phppp's changes for 2.2.4

Modified: XoopsCore/branches/2.2.x/2.2-main/docs/changelog.txt
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/docs/changelog.txt	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/docs/changelog.txt	2006-01-22 23:49:01 UTC (rev 185)
@@ -1,4 +1,43 @@
 ============================
+2006/01/22: Version 2.2.4
+============================
+- Security fix: sanitizing $xoopsConfig[&quot;language&quot;]: multiple files (phppp) 
+- Fixed reference-related issue, partially: multiple files (phppp) 
+- Fixed aged HTML tag errors: multiple files (phppp)(*)
+- Fixed bug that not check verification password for user registration: ROOT/modules/profile/register.php (phppp/tester)
+- Fixed Bug #1340925 - Mailing a selection doesn't work correctly (Mithrandir/pinchecl)
+- Fixed Bug #1346904 - XMT theme - 404 message (Mithrandir/Peter777)
+- Fixed profile field treatement error to allow XOBJ_DTYPE_URL clickable: ROOT/kernel/profilefield.php (phppp)
+- Reduced file size for cached profile field data: ROOT/kernel/profilefield.php, profile.php (phppp) 
+- Added missing time offset for calculating time: ROOT/language/english/local.php (phppp) 
+- Changed rss time to take into account time zone: ROOT/language/english/local.php (phppp)
+- Fixed bug that a user could read any message via message ID: ROOT/modules/pm/readmsg.php (phppp) 
+- Fixed url error: ROOT/modules/pm/templates/pm_viewmsg.html (phppp) 
+- Fixed bug that webmaster could not access inactive user info: ROOT/modules/profile/userinfo.php (phppp) 
+- Fixed bug that user could not change email: ROOT/modules/profile/edituser.php (phppp) 
+- Fixed bug that profile field value type couldn't be changed: ROOT/modules/profile/include/forms.php (phppp)
+- Added rights for admin in user account check:  ROOT/modules/profile/include/functions.php (phppp)
+- Changed sort for user from name to uname:  ROOT/modules/system/admin/groups/groups.php (phppp)
+- Fixed bug for censor word update:  ROOT/modules/system/admin/preferences/main.php (phppp)
+- Fixed bug for template paths:  ROOT/modules/system/admin/tplsets/main.php (phppp/wenmingpig)
+- Added user profile default values update on system module update:  ROOT/modules/system/include/update.php (phppp)
+- Changed CSS for font color for user name and text in footer:  theme default (phppp/Steven)
+- Fixed url bug:  ROOT/modules/system/admin/templates/system_imagemanager2.html (phppp)
+- Added single quote sanitizing: ROOT/pda.php (phppp)(*)
+- Added charset setting: ROOT/header.php (phppp)
+- Added URL sanitizing: ROOT/search.php (phppp)(*)
+- Fixed error messages: ROOT/lostpass.php (phppp)
+- Fixed user login redirect error: ROOT/user.php (phppp, reported by Anne)
+- Forced disabling gzip_compression: ROOT/class/theme.php (phppp)
+- Added sanitizing for meta footer: ROOT/class/theme.php (phppp)
+- Added $xoopsModule check: ROOT/class/theme.php (phppp)
+- Changed/Rolledback(partially) &quot;makeclicable&quot;,changed censor string process : ROOT/class/module.textsanitizer.php (phppp)
+- PHP 5 compatibility: ROOT/class/xml/saxparser.php (phppp)(*)
+- Added meta data sanitizing in header: ROOT/include/functions.php (phppp)(*)
+- Fixed typo for redirect time, added missing trimmaker for substr, changed userealname to false: ROOT/include/functions.php (phppp)(*)
+(*): from XoopsCube
+
+============================
 2005/10/30: Version 2.2.3 Final
 ============================
 - SECURITY: Fix to prevent mail headers injection (Skalpa/XOOPS Cube)
@@ -244,7 +283,7 @@
 - Implemented new token system for validating form origination and increased protection against CSRF (Mithrandir/Onokazu)
 - Security fix to avoid the usage of fopen and unlink when previewing (Onokazu)
 - Fixed bug - Missing &lt;/a&gt; in news/templates/blocks/news_block_bigstory.html (Mithrandir/blacKurd)
-- Fixed bug in header.php &#150; assign $xoops_lblocks (Mithrandir/phppp)
+- Fixed bug in header.php ?assign $xoops_lblocks (Mithrandir/phppp)
 - Fixed bug #1087786 Can&quot;t assign to $this in PHP5 (Mithrandir)
 - Included 2.0.9.3 fixes in 2.0.10 patch for easy upgrade from 2.0.9.2 (Mithrandir/rowd)
 - Fixed bug #1157029 - Bug in include/checklogin.php (Onokazu/sudhaker)

Modified: XoopsCore/branches/2.2.x/2.2-main/html/banners.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/banners.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/banners.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -86,7 +86,7 @@
                 &lt;td class='b_td'&gt;&lt;b&gt;Imp. Left&lt;/b&gt;&lt;/td&gt;
                 &lt;td class='b_td'&gt;&lt;b&gt;Clicks&lt;/b&gt;&lt;/td&gt;
                 &lt;td class='b_td'&gt;&lt;b&gt;% Clicks&lt;/b&gt;&lt;/td&gt;
-                &lt;td class='b_td'&gt;&lt;b&gt;Functions&lt;/b&gt;&lt;/td&gt;&lt;tr&gt;&quot;;
+                &lt;td class='b_td'&gt;&lt;b&gt;Functions&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;;
             $result = $xoopsDB-&gt;query(&quot;select bid, imptotal, impmade, clicks, date from &quot;.$xoopsDB-&gt;prefix(&quot;banner&quot;).&quot; where cid=$cid&quot;);
             while ( list($bid, $imptotal, $impmade, $clicks, $date) = $xoopsDB-&gt;fetchRow($result) ) {
                 if ( $impmade == 0 ) {
@@ -99,13 +99,13 @@
                 } else {
                     $left = $imptotal-$impmade;
                 }
-                echo &quot;&lt;td align='center'&gt;$bid&lt;/td&gt;
+                echo &quot;&lt;tr&gt;&lt;td align='center'&gt;$bid&lt;/td&gt;
                 &lt;td align='center'&gt;$impmade&lt;/td&gt;
                 &lt;td align='center'&gt;$imptotal&lt;/td&gt;
                 &lt;td align='center'&gt;$left&lt;/td&gt;
                 &lt;td align='center'&gt;$clicks&lt;/td&gt;
                 &lt;td align='center'&gt;$percent%&lt;/td&gt;
-                &lt;td align='center'&gt;&lt;a href='banners.php?op=EmailStats&amp;login=$login&amp;pass=$pass&amp;cid=$cid&amp;bid=$bid&amp;t=&quot;.$GLOBALS['xoopsSecurity']-&gt;createToken().&quot;'&gt;E-mail Stats&lt;/a&gt;&lt;/td&gt;&lt;tr&gt;&quot;;
+                &lt;td align='center'&gt;&lt;a href='banners.php?op=EmailStats&amp;login=$login&amp;pass=$pass&amp;cid=$cid&amp;bid=$bid&amp;t=&quot;.$GLOBALS['xoopsSecurity']-&gt;createToken().&quot;'&gt;E-mail Stats&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&quot;;
             }
             echo &quot;&lt;/table&gt;&lt;br /&gt;&lt;br /&gt;&lt;div&gt;Following are your running Banners in &quot;.$xoopsConfig['sitename'].&quot; &lt;/div&gt;&lt;br /&gt;&lt;br /&gt;&quot;;
             $result = $xoopsDB-&gt;query(&quot;select bid, imageurl, clickurl, htmlbanner, htmlcode from &quot;.$xoopsDB-&gt;prefix(&quot;banner&quot;).&quot; where cid=$cid&quot;);

Modified: XoopsCore/branches/2.2.x/2.2-main/html/changelog.txt
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/changelog.txt	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/changelog.txt	2006-01-22 23:49:01 UTC (rev 185)
@@ -1,4 +1,43 @@
 ============================
+2006/01/12: Version 2.2.4 
+============================
+- Security fix: sanitizing $xoopsConfig[&quot;language&quot;]: multiple files (phppp) 
+- Fixed reference-related issue, partially: multiple files (phppp) 
+- Fixed aged HTML tag errors: multiple files (phppp)(*)
+- Fixed bug that not check verification password for user registration: ROOT/modules/profile/register.php (phppp/tester)
+- Fixed Bug #1340925 - Mailing a selection doesn't work correctly (Mithrandir/pinchecl)
+- Fixed Bug #1346904 - XMT theme - 404 message (Mithrandir/Peter777)
+- Fixed profile field treatement error to allow XOBJ_DTYPE_URL clickable: ROOT/kernel/profilefield.php (phppp)
+- Reduced file size for cached profile field data: ROOT/kernel/profilefield.php, profile.php (phppp) 
+- Added missing time offset for calculating time: ROOT/language/english/local.php (phppp) 
+- Changed rss time to take into account time zone: ROOT/language/english/local.php (phppp)
+- Fixed bug that a user could read any message via message ID: ROOT/modules/pm/readmsg.php (phppp) 
+- Fixed url error: ROOT/modules/pm/templates/pm_viewmsg.html (phppp) 
+- Fixed bug that webmaster could not access inactive user info: ROOT/modules/profile/userinfo.php (phppp) 
+- Fixed bug that user could not change email: ROOT/modules/profile/edituser.php (phppp) 
+- Fixed bug that profile field value type couldn't be changed: ROOT/modules/profile/include/forms.php (phppp)
+- Added rights for admin in user account check:  ROOT/modules/profile/include/functions.php (phppp)
+- Changed sort for user from name to uname:  ROOT/modules/system/admin/groups/groups.php (phppp)
+- Fixed bug for censor word update:  ROOT/modules/system/admin/preferences/main.php (phppp)
+- Fixed bug for template paths:  ROOT/modules/system/admin/tplsets/main.php (phppp/wenmingpig)
+- Added user profile default values update on system module update:  ROOT/modules/system/include/update.php (phppp)
+- Changed CSS for font color for user name and text in footer:  theme default (phppp/Steven)
+- Fixed url bug:  ROOT/modules/system/admin/templates/system_imagemanager2.html (phppp)
+- Added single quote sanitizing: ROOT/pda.php (phppp)(*)
+- Added charset setting: ROOT/header.php (phppp)
+- Added URL sanitizing: ROOT/search.php (phppp)(*)
+- Fixed error messages: ROOT/lostpass.php (phppp)
+- Fixed user login redirect error: ROOT/user.php (phppp, reported by Anne)
+- Forced disabling gzip_compression: ROOT/class/theme.php (phppp)
+- Added sanitizing for meta footer: ROOT/class/theme.php (phppp)
+- Added $xoopsModule check: ROOT/class/theme.php (phppp)
+- Changed/Rolledback(partially) &quot;makeclicable&quot;,changed censor string process : ROOT/class/module.textsanitizer.php (phppp)
+- PHP 5 compatibility: ROOT/class/xml/saxparser.php (phppp)(*)
+- Added meta data sanitizing in header: ROOT/include/functions.php (phppp)(*)
+- Fixed typo for redirect time, added missing trimmaker for substr, changed userealname to false: ROOT/include/functions.php (phppp)(*)
+(*): from XoopsCube
+
+============================
 2005/10/30: Version 2.2.3 Final
 ============================
 - SECURITY: Fix to prevent mail headers injection (Skalpa/XOOPS Cube)
@@ -244,7 +283,7 @@
 - Implemented new token system for validating form origination and increased protection against CSRF (Mithrandir/Onokazu)
 - Security fix to avoid the usage of fopen and unlink when previewing (Onokazu)
 - Fixed bug - Missing &lt;/a&gt; in news/templates/blocks/news_block_bigstory.html (Mithrandir/blacKurd)
-- Fixed bug in header.php &#150; assign $xoops_lblocks (Mithrandir/phppp)
+- Fixed bug in header.php ?assign $xoops_lblocks (Mithrandir/phppp)
 - Fixed bug #1087786 Can&quot;t assign to $this in PHP5 (Mithrandir)
 - Included 2.0.9.3 fixes in 2.0.10 patch for easy upgrade from 2.0.9.2 (Mithrandir/rowd)
 - Fixed bug #1157029 - Bug in include/checklogin.php (Onokazu/sudhaker)

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/mimetypes.inc.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/mimetypes.inc.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/mimetypes.inc.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -1,233 +1,118 @@
-&lt;?php
-// $Id$
-/**
-
-* Extension to mimetype lookup table
-
-*
-
-* This file is provided as an helper for objects who need to perform filename to mimetype translations.
-
-* Common types have been provided, but feel free to add your own one if you need it.
-
-* &lt;br /&gt;&lt;br /&gt;
-
-* See the enclosed file LICENSE for licensing information.
-
-* If you did not receive this file, get it at <A HREF="http://www.fsf.org/copyleft/gpl.html">http://www.fsf.org/copyleft/gpl.html</A>
-
-*
-
-* @copyright    The Xoops project <A HREF="http://www.xoops.org/">http://www.xoops.org/</A>
-
-* @license      <A HREF="http://www.fsf.org/copyleft/gpl.html">http://www.fsf.org/copyleft/gpl.html</A> GNU public license
-
-* @author       Skalpa Keo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">skalpa at xoops.org</A>&gt;
-
-* @since        2.0.9.3
-
-*/
-
-return array(
-
-     &quot;hqx&quot;		=&gt; &quot;application/mac-binhex40&quot;,
-
-     &quot;doc&quot;		=&gt; &quot;application/msword&quot;,
-
-     &quot;dot&quot;		=&gt; &quot;application/msword&quot;,
-
-     &quot;bin&quot;		=&gt; &quot;application/octet-stream&quot;,
-
-     &quot;lha&quot;		=&gt; &quot;application/octet-stream&quot;,
-
-     &quot;lzh&quot;		=&gt; &quot;application/octet-stream&quot;,
-
-     &quot;exe&quot;		=&gt; &quot;application/octet-stream&quot;,
-
-     &quot;class&quot;	=&gt; &quot;application/octet-stream&quot;,
-
-     &quot;so&quot;		=&gt; &quot;application/octet-stream&quot;,
-
-     &quot;dll&quot;		=&gt; &quot;application/octet-stream&quot;,
-
-     &quot;pdf&quot;		=&gt; &quot;application/pdf&quot;,
-
-     &quot;ai&quot;		=&gt; &quot;application/postscript&quot;,
-
-     &quot;eps&quot;		=&gt; &quot;application/postscript&quot;,
-
-     &quot;ps&quot;		=&gt; &quot;application/postscript&quot;,
-
-     &quot;smi&quot;		=&gt; &quot;application/smil&quot;,
-
-     &quot;smil&quot;		=&gt; &quot;application/smil&quot;,
-
-     &quot;wbxml&quot;	=&gt; &quot;application/vnd.wap.wbxml&quot;,
-
-     &quot;wmlc&quot;		=&gt; &quot;application/vnd.wap.wmlc&quot;,
-
-     &quot;wmlsc&quot;	=&gt; &quot;application/vnd.wap.wmlscriptc&quot;,
-
-     &quot;xla&quot;		=&gt; &quot;application/vnd.ms-excel&quot;,
-
-     &quot;xls&quot;		=&gt; &quot;application/vnd.ms-excel&quot;,
-
-     &quot;xlt&quot;		=&gt; &quot;application/vnd.ms-excel&quot;,
-
-     &quot;ppt&quot;		=&gt; &quot;application/vnd.ms-powerpoint&quot;,
-
-     &quot;csh&quot;		=&gt; &quot;application/x-csh&quot;,
-
-     &quot;dcr&quot;		=&gt; &quot;application/x-director&quot;,
-
-     &quot;dir&quot;		=&gt; &quot;application/x-director&quot;,
-
-     &quot;dxr&quot;		=&gt; &quot;application/x-director&quot;,
-
-     &quot;spl&quot;		=&gt; &quot;application/x-futuresplash&quot;,
-
-     &quot;gtar&quot;		=&gt; &quot;application/x-gtar&quot;,
-
-     &quot;php&quot;		=&gt; &quot;application/x-httpd-php&quot;,
-
-     &quot;php3&quot;		=&gt; &quot;application/x-httpd-php&quot;,
-
-     &quot;php5&quot;		=&gt; &quot;application/x-httpd-php&quot;,
-
-     &quot;phtml&quot;	=&gt; &quot;application/x-httpd-php&quot;,
-
-     &quot;js&quot;		=&gt; &quot;application/x-javascript&quot;,
-
-     &quot;sh&quot;		=&gt; &quot;application/x-sh&quot;,
-
-     &quot;swf&quot;		=&gt; &quot;application/x-shockwave-flash&quot;,
-
-     &quot;sit&quot;		=&gt; &quot;application/x-stuffit&quot;,
-
-     &quot;tar&quot;		=&gt; &quot;application/x-tar&quot;,
-
-     &quot;tcl&quot;		=&gt; &quot;application/x-tcl&quot;,
-
-     &quot;xhtml&quot;	=&gt; &quot;application/xhtml+xml&quot;,
-
-     &quot;xht&quot;		=&gt; &quot;application/xhtml+xml&quot;,
-
-     &quot;xhtml&quot;	=&gt; &quot;application/xml&quot;,
-
-     &quot;ent&quot;		=&gt; &quot;application/xml-external-parsed-entity&quot;,
-
-     &quot;dtd&quot;		=&gt; &quot;application/xml-dtd&quot;,
-
-     &quot;mod&quot;		=&gt; &quot;application/xml-dtd&quot;,
-
-     &quot;gz&quot;		=&gt; &quot;application/x-gzip&quot;,
-
-     &quot;zip&quot;		=&gt; &quot;application/zip&quot;,
-
-     &quot;au&quot;		=&gt; &quot;audio/basic&quot;,
-
-     &quot;snd&quot;		=&gt; &quot;audio/basic&quot;,
-
-     &quot;mid&quot;		=&gt; &quot;audio/midi&quot;,
-
-     &quot;midi&quot;		=&gt; &quot;audio/midi&quot;,
-
-     &quot;kar&quot;		=&gt; &quot;audio/midi&quot;,
-
-     &quot;mp1&quot;		=&gt; &quot;audio/mpeg&quot;,
-
-     &quot;mp2&quot;		=&gt; &quot;audio/mpeg&quot;,
-
-     &quot;mp3&quot;		=&gt; &quot;audio/mpeg&quot;,
-
-     &quot;aif&quot;		=&gt; &quot;audio/x-aiff&quot;,
-
-     &quot;aiff&quot;		=&gt; &quot;audio/x-aiff&quot;,
-
-     &quot;m3u&quot;		=&gt; &quot;audio/x-mpegurl&quot;,
-
-     &quot;ram&quot;		=&gt; &quot;audio/x-pn-realaudio&quot;,
-
-     &quot;rm&quot;		=&gt; &quot;audio/x-pn-realaudio&quot;,
-
-     &quot;rpm&quot;		=&gt; &quot;audio/x-pn-realaudio-plugin&quot;,
-
-     &quot;ra&quot;		=&gt; &quot;audio/x-realaudio&quot;,
-
-     &quot;wav&quot;		=&gt; &quot;audio/x-wav&quot;,
-
-     &quot;bmp&quot;		=&gt; &quot;image/bmp&quot;,
-
-     &quot;gif&quot;		=&gt; &quot;image/gif&quot;,
-
-     &quot;jpeg&quot;		=&gt; &quot;image/jpeg&quot;,
-
-     &quot;jpg&quot;		=&gt; &quot;image/jpeg&quot;,
-
-     &quot;jpe&quot;		=&gt; &quot;image/jpeg&quot;,
-
-     &quot;png&quot;		=&gt; &quot;image/png&quot;,
-
-     &quot;tiff&quot;		=&gt; &quot;image/tiff&quot;,
-
-     &quot;tif&quot;		=&gt; &quot;image/tif&quot;,
-
-     &quot;wbmp&quot;		=&gt; &quot;image/vnd.wap.wbmp&quot;,
-
-     &quot;pnm&quot;		=&gt; &quot;image/x-portable-anymap&quot;,
-
-     &quot;pbm&quot;		=&gt; &quot;image/x-portable-bitmap&quot;,
-
-     &quot;pgm&quot;		=&gt; &quot;image/x-portable-graymap&quot;,
-
-     &quot;ppm&quot;		=&gt; &quot;image/x-portable-pixmap&quot;,
-
-     &quot;xbm&quot;		=&gt; &quot;image/x-xbitmap&quot;,
-
-     &quot;xpm&quot;		=&gt; &quot;image/x-xpixmap&quot;,
-
-	 &quot;ics&quot;		=&gt; &quot;text/calendar&quot;,
-
-	 &quot;ifb&quot;		=&gt; &quot;text/calendar&quot;,
-
-     &quot;css&quot;		=&gt; &quot;text/css&quot;,
-
-     &quot;html&quot;		=&gt; &quot;text/html&quot;,
-
-     &quot;htm&quot;		=&gt; &quot;text/html&quot;,
-
-     &quot;asc&quot;		=&gt; &quot;text/plain&quot;,
-
-     &quot;txt&quot;		=&gt; &quot;text/plain&quot;,
-
-     &quot;rtf&quot;		=&gt; &quot;text/rtf&quot;,
-
-     &quot;sgml&quot;		=&gt; &quot;text/x-sgml&quot;,
-
-     &quot;sgm&quot;		=&gt; &quot;text/x-sgml&quot;,
-
-     &quot;tsv&quot;		=&gt; &quot;text/tab-seperated-values&quot;,
-
-     &quot;wml&quot;		=&gt; &quot;text/vnd.wap.wml&quot;,
-
-     &quot;wmls&quot;		=&gt; &quot;text/vnd.wap.wmlscript&quot;,
-
-     &quot;xsl&quot;		=&gt; &quot;text/xml&quot;,
-
-     &quot;mpeg&quot;		=&gt; &quot;video/mpeg&quot;,
-
-     &quot;mpg&quot;		=&gt; &quot;video/mpeg&quot;,
-
-     &quot;mpe&quot;		=&gt; &quot;video/mpeg&quot;,
-
-     &quot;qt&quot;		=&gt; &quot;video/quicktime&quot;,
-
-     &quot;mov&quot;		=&gt; &quot;video/quicktime&quot;,
-
-     &quot;avi&quot;		=&gt; &quot;video/x-msvideo&quot;,
-
-);
-
-
-
+&lt;?php
+// $Id$
+/**
+* Extension to mimetype lookup table
+*
+* This file is provided as an helper for objects who need to perform filename to mimetype translations.
+* Common types have been provided, but feel free to add your own one if you need it.
+* &lt;br /&gt;&lt;br /&gt;
+* See the enclosed file LICENSE for licensing information.
+* If you did not receive this file, get it at <A HREF="http://www.fsf.org/copyleft/gpl.html">http://www.fsf.org/copyleft/gpl.html</A>
+*
+* @copyright    The Xoops project <A HREF="http://www.xoops.org/">http://www.xoops.org/</A>
+* @license      <A HREF="http://www.fsf.org/copyleft/gpl.html">http://www.fsf.org/copyleft/gpl.html</A> GNU public license
+* @author       Skalpa Keo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/xoops4-svn">skalpa at xoops.org</A>&gt;
+* @since        2.0.9.3
+*/
+
+return array(
+     &quot;hqx&quot;      =&gt; &quot;application/mac-binhex40&quot;,
+     &quot;doc&quot;      =&gt; &quot;application/msword&quot;,
+     &quot;dot&quot;      =&gt; &quot;application/msword&quot;,
+     &quot;bin&quot;      =&gt; &quot;application/octet-stream&quot;,
+     &quot;lha&quot;      =&gt; &quot;application/octet-stream&quot;,
+     &quot;lzh&quot;      =&gt; &quot;application/octet-stream&quot;,
+     &quot;exe&quot;      =&gt; &quot;application/octet-stream&quot;,
+     &quot;class&quot;    =&gt; &quot;application/octet-stream&quot;,
+     &quot;so&quot;       =&gt; &quot;application/octet-stream&quot;,
+     &quot;dll&quot;      =&gt; &quot;application/octet-stream&quot;,
+     &quot;pdf&quot;      =&gt; &quot;application/pdf&quot;,
+     &quot;ai&quot;       =&gt; &quot;application/postscript&quot;,
+     &quot;eps&quot;      =&gt; &quot;application/postscript&quot;,
+     &quot;ps&quot;       =&gt; &quot;application/postscript&quot;,
+     &quot;smi&quot;      =&gt; &quot;application/smil&quot;,
+     &quot;smil&quot;     =&gt; &quot;application/smil&quot;,
+     &quot;wbxml&quot;    =&gt; &quot;application/vnd.wap.wbxml&quot;,
+     &quot;wmlc&quot;     =&gt; &quot;application/vnd.wap.wmlc&quot;,
+     &quot;wmlsc&quot;    =&gt; &quot;application/vnd.wap.wmlscriptc&quot;,
+     &quot;xla&quot;      =&gt; &quot;application/vnd.ms-excel&quot;,
+     &quot;xls&quot;      =&gt; &quot;application/vnd.ms-excel&quot;,
+     &quot;xlt&quot;      =&gt; &quot;application/vnd.ms-excel&quot;,
+     &quot;ppt&quot;      =&gt; &quot;application/vnd.ms-powerpoint&quot;,
+     &quot;csh&quot;      =&gt; &quot;application/x-csh&quot;,
+     &quot;dcr&quot;      =&gt; &quot;application/x-director&quot;,
+     &quot;dir&quot;      =&gt; &quot;application/x-director&quot;,
+     &quot;dxr&quot;      =&gt; &quot;application/x-director&quot;,
+     &quot;spl&quot;      =&gt; &quot;application/x-futuresplash&quot;,
+     &quot;gtar&quot;     =&gt; &quot;application/x-gtar&quot;,
+     &quot;php&quot;      =&gt; &quot;application/x-httpd-php&quot;,
+     &quot;php3&quot;     =&gt; &quot;application/x-httpd-php&quot;,
+     &quot;php5&quot;     =&gt; &quot;application/x-httpd-php&quot;,
+     &quot;phtml&quot;    =&gt; &quot;application/x-httpd-php&quot;,
+     &quot;js&quot;       =&gt; &quot;application/x-javascript&quot;,
+     &quot;sh&quot;       =&gt; &quot;application/x-sh&quot;,
+     &quot;swf&quot;      =&gt; &quot;application/x-shockwave-flash&quot;,
+     &quot;sit&quot;      =&gt; &quot;application/x-stuffit&quot;,
+     &quot;tar&quot;      =&gt; &quot;application/x-tar&quot;,
+     &quot;tcl&quot;      =&gt; &quot;application/x-tcl&quot;,
+     &quot;xhtml&quot;    =&gt; &quot;application/xhtml+xml&quot;,
+     &quot;xht&quot;      =&gt; &quot;application/xhtml+xml&quot;,
+     &quot;xhtml&quot;    =&gt; &quot;application/xml&quot;,
+     &quot;ent&quot;      =&gt; &quot;application/xml-external-parsed-entity&quot;,
+     &quot;dtd&quot;      =&gt; &quot;application/xml-dtd&quot;,
+     &quot;mod&quot;      =&gt; &quot;application/xml-dtd&quot;,
+     &quot;gz&quot;       =&gt; &quot;application/x-gzip&quot;,
+     &quot;zip&quot;      =&gt; &quot;application/zip&quot;,
+     &quot;au&quot;       =&gt; &quot;audio/basic&quot;,
+     &quot;snd&quot;      =&gt; &quot;audio/basic&quot;,
+     &quot;mid&quot;      =&gt; &quot;audio/midi&quot;,
+     &quot;midi&quot;     =&gt; &quot;audio/midi&quot;,
+     &quot;kar&quot;      =&gt; &quot;audio/midi&quot;,
+     &quot;mp1&quot;      =&gt; &quot;audio/mpeg&quot;,
+     &quot;mp2&quot;      =&gt; &quot;audio/mpeg&quot;,
+     &quot;mp3&quot;      =&gt; &quot;audio/mpeg&quot;,
+     &quot;aif&quot;      =&gt; &quot;audio/x-aiff&quot;,
+     &quot;aiff&quot;     =&gt; &quot;audio/x-aiff&quot;,
+     &quot;m3u&quot;      =&gt; &quot;audio/x-mpegurl&quot;,
+     &quot;ram&quot;      =&gt; &quot;audio/x-pn-realaudio&quot;,
+     &quot;rm&quot;       =&gt; &quot;audio/x-pn-realaudio&quot;,
+     &quot;rpm&quot;      =&gt; &quot;audio/x-pn-realaudio-plugin&quot;,
+     &quot;ra&quot;       =&gt; &quot;audio/x-realaudio&quot;,
+     &quot;wav&quot;      =&gt; &quot;audio/x-wav&quot;,
+     &quot;bmp&quot;      =&gt; &quot;image/bmp&quot;,
+     &quot;gif&quot;      =&gt; &quot;image/gif&quot;,
+     &quot;jpeg&quot;     =&gt; &quot;image/jpeg&quot;,
+     &quot;jpg&quot;      =&gt; &quot;image/jpeg&quot;,
+     &quot;jpe&quot;      =&gt; &quot;image/jpeg&quot;,
+     &quot;png&quot;      =&gt; &quot;image/png&quot;,
+     &quot;tiff&quot;     =&gt; &quot;image/tiff&quot;,
+     &quot;tif&quot;      =&gt; &quot;image/tif&quot;,
+     &quot;wbmp&quot;     =&gt; &quot;image/vnd.wap.wbmp&quot;,
+     &quot;pnm&quot;      =&gt; &quot;image/x-portable-anymap&quot;,
+     &quot;pbm&quot;      =&gt; &quot;image/x-portable-bitmap&quot;,
+     &quot;pgm&quot;      =&gt; &quot;image/x-portable-graymap&quot;,
+     &quot;ppm&quot;      =&gt; &quot;image/x-portable-pixmap&quot;,
+     &quot;xbm&quot;      =&gt; &quot;image/x-xbitmap&quot;,
+     &quot;xpm&quot;      =&gt; &quot;image/x-xpixmap&quot;,
+     &quot;ics&quot;      =&gt; &quot;text/calendar&quot;,
+     &quot;ifb&quot;      =&gt; &quot;text/calendar&quot;,
+     &quot;css&quot;      =&gt; &quot;text/css&quot;,
+     &quot;html&quot;     =&gt; &quot;text/html&quot;,
+     &quot;htm&quot;      =&gt; &quot;text/html&quot;,
+     &quot;asc&quot;      =&gt; &quot;text/plain&quot;,
+     &quot;txt&quot;      =&gt; &quot;text/plain&quot;,
+     &quot;rtf&quot;      =&gt; &quot;text/rtf&quot;,
+     &quot;sgml&quot;     =&gt; &quot;text/x-sgml&quot;,
+     &quot;sgm&quot;      =&gt; &quot;text/x-sgml&quot;,
+     &quot;tsv&quot;      =&gt; &quot;text/tab-seperated-values&quot;,
+     &quot;wml&quot;      =&gt; &quot;text/vnd.wap.wml&quot;,
+     &quot;wmls&quot;     =&gt; &quot;text/vnd.wap.wmlscript&quot;,
+     &quot;xsl&quot;      =&gt; &quot;text/xml&quot;,
+     &quot;mpeg&quot;     =&gt; &quot;video/mpeg&quot;,
+     &quot;mpg&quot;      =&gt; &quot;video/mpeg&quot;,
+     &quot;mpe&quot;      =&gt; &quot;video/mpeg&quot;,
+     &quot;qt&quot;       =&gt; &quot;video/quicktime&quot;,
+     &quot;mov&quot;      =&gt; &quot;video/quicktime&quot;,
+     &quot;avi&quot;      =&gt; &quot;video/x-msvideo&quot;,
+);
 ?&gt;
\ No newline at end of file

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/module.textsanitizer.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/module.textsanitizer.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/module.textsanitizer.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -131,18 +131,22 @@
 	function makeClickable( $text )
 	{
 		/*$patterns = array(&quot;/(^|[^]_a-z0-9-=\&quot;'\/])([a-z]+?):\/\/([^, \r\n\&quot;\(\)'&lt;&gt;]+)/i&quot;, &quot;/(^|[^]_a-z0-9-=\&quot;'\/])www\.([a-z0-9\-]+)\.([^, \r\n\&quot;\(\)'&lt;&gt;]+)/i&quot;, &quot;/(^|[^]_a-z0-9-=\&quot;'\/])ftp\.([a-z0-9\-]+)\.([^, \r\n\&quot;\(\)'&lt;&gt;]+)/i&quot;, &quot;/(^|[^]_a-z0-9-=\&quot;'\/:\.])([a-z0-9\-_\.]+?)@([^, \r\n\&quot;\(\)'&lt;&gt;\[\]]+)/i&quot;);*/
-		$patterns = array(&quot;/(^|[^]_a-z0-9-=\&quot;'\/])([a-z]+?):\/\/([^
-                            \r\n\&quot;\(\)'&lt;&gt;]+)/i&quot;,
-                            &quot;/(^|[^]_a-z0-9-=\&quot;'\/])www\.([a-z0-9\-]+)\.([^
-                            \r\n\&quot;\(\)'&lt;&gt;]+)/i&quot;,
-                            &quot;/(^|[^]_a-z0-9-=\&quot;'\/])ftp\.([a-z0-9\-]+)\.([^
-                            \r\n\&quot;\(\)'&lt;&gt;]+)/i&quot;,
-                            &quot;/(^|[^]_a-z0-9-=\&quot;'\/:\.])([a-z0-9\-_\.]+?)@([^
-                            \r\n\&quot;\(\)'&lt;&gt;\[\]]+)/i&quot;);
+		$patterns = array(&quot;/(^|[^]_a-z0-9-=\&quot;'\/])([a-z]+?):\/\/([^,\r\n\&quot;\(\)'&lt;&gt;\s\b\[\]]+)/i&quot;,
+                            &quot;/(^|[^]_a-z0-9-=\&quot;'\/])www\.([a-z0-9\-]+)\.([^,\r\n\&quot;\(\)'&lt;&gt;\s\b\[\]]+)/i&quot;
+                            /*
+                            ,
+                            &quot;/(^|[^]_a-z0-9-=\&quot;'\/])ftp\.([a-z0-9\-]+)\.([^\r\n\&quot;\(\)'&lt;&gt;]+)/i&quot;,
+                            &quot;/(^|[^]_a-z0-9-=\&quot;'\/:\.])([a-z0-9\-_\.]+?)@([^\r\n\&quot;\(\)'&lt;&gt;\[\]]+)/i&quot;
+                            */
+                            );
 		$replacements = array(&quot;\\1&lt;a href=\&quot;\\2://\\3\&quot; target=\&quot;_blank\&quot;&gt;\\2://\\3&lt;/a&gt;&quot;, 
-		                      &quot;\\1&lt;a href=\&quot;<A HREF="http://www.\\2.\\3\">http://www.\\2.\\3\</A>&quot; target=\&quot;_blank\&quot;&gt;www.\\2.\\3&lt;/a&gt;&quot;,
+		                      &quot;\\1&lt;a href=\&quot;<A HREF="http://www.\\2.\\3\">http://www.\\2.\\3\</A>&quot; target=\&quot;_blank\&quot;&gt;www.\\2.\\3&lt;/a&gt;&quot;
+		                      /*
+		                      ,
 		                       &quot;\\1&lt;a href=\&quot;<A HREF="ftp://ftp.\\2.\\3\">ftp://ftp.\\2.\\3\</A>&quot; target=\&quot;_blank\&quot;&gt;ftp.\\2.\\3&lt;/a&gt;&quot;,
-		                       &quot;\\1&lt;script type=\&quot;text/javascript\&quot;&gt;var id='\\2';var host1='\\3';var host2='';document.write('&lt;a href=\&quot;mailto:'+id+'@'+host1+'.'+host2+'\&quot;&gt;'+id+'@'+host1+'.'+host2+'&lt;/a&gt;');&lt;/script&gt;&quot;);
+		                       &quot;\\1&lt;script type=\&quot;text/javascript\&quot;&gt;var id='\\2';var host1='\\3';var host2='';document.write('&lt;a href=\&quot;mailto:'+id+'@'+host1+'.'+host2+'\&quot;&gt;'+id+'@'+host1+'.'+host2+'&lt;/a&gt;');&lt;/script&gt;&quot;
+		                       */
+		                       );
 		return preg_replace($patterns, $replacements, $text);
 	}
 
@@ -307,28 +311,28 @@
 	{
 		if ($html != 1) {
 			// html not allowed
-			$text =&amp; $this-&gt;htmlSpecialChars($text);
+			$text = $this-&gt;htmlSpecialChars($text);
 		}
-		$text =&amp; $this-&gt;codePreConv($text, $xcode); // Ryuji_edit(2003-11-18)
-		$text =&amp; $this-&gt;makeClickable($text);
+		$text = $this-&gt;codePreConv($text, $xcode); // Ryuji_edit(2003-11-18)
+		$text = $this-&gt;makeClickable($text);
 		if ($smiley != 0) {
 			// process smiley
-			$text =&amp; $this-&gt;smiley($text);
+			$text = $this-&gt;smiley($text);
 		}
 		if ($xcode != 0) {
 			// decode xcode
 			if ($image != 0) {
 				// image allowed
-				$text =&amp; $this-&gt;xoopsCodeDecode($text);
+				$text = $this-&gt;xoopsCodeDecode($text);
             		} else {
                 		// image not allowed
-                		$text =&amp; $this-&gt;xoopsCodeDecode($text, 0);
+                		$text = $this-&gt;xoopsCodeDecode($text, 0);
 			}
 		}
 		if ($br != 0) {
-			$text =&amp; $this-&gt;nl2Br($text);
+			$text = $this-&gt;nl2Br($text);
 		}
-		$text =&amp; $this-&gt;codeConv($text, $xcode, $image);	// Ryuji_edit(2003-11-18)
+		$text = $this-&gt;codeConv($text, $xcode, $image);	// Ryuji_edit(2003-11-18)
 		return $text;
 	}
 
@@ -345,31 +349,31 @@
 	 **/
 	function &amp;previewTarea(&amp;$text, $html = 0, $smiley = 1, $xcode = 1, $image = 1, $br = 1)
 	{
-		$text =&amp; $this-&gt;stripSlashesGPC($text);
+		$text = $this-&gt;stripSlashesGPC($text);
 		if ($html != 1) {
 			// html not allowed
-			$text =&amp; $this-&gt;htmlSpecialChars($text);
+			$text = $this-&gt;htmlSpecialChars($text);
 		}
-		$text =&amp; $this-&gt;codePreConv($text, $xcode); // Ryuji_edit(2003-11-18)
-		$text =&amp; $this-&gt;makeClickable($text);
+		$text = $this-&gt;codePreConv($text, $xcode); // Ryuji_edit(2003-11-18)
+		$text = $this-&gt;makeClickable($text);
 		if ($smiley != 0) {
 			// process smiley
-			$text =&amp; $this-&gt;smiley($text);
+			$text = $this-&gt;smiley($text);
 		}
 		if ($xcode != 0) {
 			// decode xcode
 			if ($image != 0) {
 				// image allowed
-				$text =&amp; $this-&gt;xoopsCodeDecode($text);
+				$text = $this-&gt;xoopsCodeDecode($text);
 			} else {
 				// image not allowed
-				$text =&amp; $this-&gt;xoopsCodeDecode($text, 0);
+				$text = $this-&gt;xoopsCodeDecode($text, 0);
 			}
 		}
 		if ($br != 0) {
-			$text =&amp; $this-&gt;nl2Br($text);
+			$text = $this-&gt;nl2Br($text);
 		}
-		$text =&amp; $this-&gt;codeConv($text, $xcode, $image);	// Ryuji_edit(2003-11-18)
+		$text = $this-&gt;codeConv($text, $xcode, $image);	// Ryuji_edit(2003-11-18)
 		return $text;
 	}
 
@@ -390,6 +394,13 @@
 		if ($this-&gt;censorConf['censor_enable'] == 1) {
 			$replacement = $this-&gt;censorConf['censor_replace'];
 			foreach ($this-&gt;censorConf['censor_words'] as $bad) {
+				$bad = trim($bad);
+				if(!empty($bad)){
+					$patterns[] = &quot;/([^0-9a-z_])&quot;.$bad.&quot;([^0-9a-z_])/siU&quot;;
+					$replacements[] = &quot;\\1&quot;.$replacement.&quot;\\2&quot;;
+					$text = preg_replace($patterns, $replacements, $text);
+				}
+				/*
 				if ( !empty($bad) &amp;&amp; $bad != null &amp;&amp; $bad != &quot;&quot; &amp;&amp; $bad != &quot; &quot;) {//$bad must not be an empty string or everything will be censored. Spaces not allowed as bad strings either
 	 				$bad = quotemeta($bad);
 					$patterns[] = &quot;/(\s)&quot;.$bad.&quot;/siU&quot;;
@@ -402,6 +413,7 @@
 					$replacements[] = &quot;]&quot;.$replacement;
 					$text = preg_replace($patterns, $replacements, $text);
 				}
+				*/
    			}
 		}
    		return $text;
@@ -573,7 +585,7 @@
 	function &amp;oopsStripSlashesRT($text)
 	{
 		if (get_magic_quotes_runtime()) {
-			$text =&amp; stripslashes($text);
+			$text = stripslashes($text);
 		}
 		return $text;
 	}

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/theme.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/theme.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/theme.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -139,45 +139,45 @@
         $GLOBALS['xoopsTpl'] =&amp; $this-&gt;tplEngine;
         if ( $this-&gt;bufferOutput ) {
             global $xoopsConfig;
+            
+            /* Forced */
+            $xoopsConfig['gzip_compression'] = 0;
+            
+            //if Gzip is enabled and debug is turned off
+            if ( $xoopsConfig['gzip_compression'] == 1 &amp;&amp; ($xoopsConfig['debug_mode'] == array(0 =&gt; 0) || $xoopsConfig['debug_mode'] == array()))
+            {
+                $ob_started = false;
+                $phpver = phpversion();
+                $useragent = ( isset( $_SERVER[&quot;HTTP_USER_AGENT&quot;] ) ) ? $_SERVER[&quot;HTTP_USER_AGENT&quot;] : &quot;&quot;;
 
-            //if Gzip is enabled and debug is turned off
-            // DISABLED for XOOPS 2.2.3 until we figure out, why it won't work in some configurations - Mith.
-            // @TODO: Find out why gzip_compression gives blank pages
-//            if ( $xoopsConfig['gzip_compression'] == 1 &amp;&amp; ($xoopsConfig['debug_mode'] == array(0 =&gt; 0) || $xoopsConfig['debug_mode'] == array()))
-//            {
-//                $ob_started = false;
-//                $phpver = phpversion();
-//                $useragent = ( isset( $_SERVER[&quot;HTTP_USER_AGENT&quot;] ) ) ? $_SERVER[&quot;HTTP_USER_AGENT&quot;] : &quot;&quot;;
-//
-//                if ( $phpver &gt;= '4.0.4pl1' &amp;&amp; ( strstr( $useragent, 'compatible' ) || strstr( $useragent, 'Gecko' ) ) )
-//                {
-//                    if ( extension_loaded( 'zlib' ) ) {
-//                        ob_start( 'ob_gzhandler' );
-//                        $ob_started = true;
-//                    }
-//                }
-//                else if ( $phpver &gt; '4.0' )
-//                {
-//                    if ( strstr( $_SERVER['HTTP_ACCEPT_ENCODING'], 'gzip' ) )
-//                    {
-//                        if ( extension_loaded( 'zlib' ) )
-//                        {
-//                            ob_start();
-//                            ob_implicit_flush( 0 );
-//                            header( 'Content-Encoding: gzip' );
-//                            $ob_started = true;
-//                        }
-//                    }
-//                }
-//                if (!$ob_started) {
-//                    ob_start();
-//                }
-//            }
-//            else
-//            {
-//                ob_start();
-//            }
-            ob_start();
+                if ( $phpver &gt;= '4.0.4pl1' &amp;&amp; ( strstr( $useragent, 'compatible' ) || strstr( $useragent, 'Gecko' ) ) )
+                {
+                    if ( extension_loaded( 'zlib' ) ) {
+                        ob_start( 'ob_gzhandler' );
+                        $ob_started = true;
+                    }
+                }
+                else if ( $phpver &gt; '4.0' )
+                {
+                    if ( strstr( $_SERVER['HTTP_ACCEPT_ENCODING'], 'gzip' ) )
+                    {
+                        if ( extension_loaded( 'zlib' ) )
+                        {
+                            ob_start();
+                            ob_implicit_flush( 0 );
+                            header( 'Content-Encoding: gzip' );
+                            $ob_started = true;
+                        }
+                    }
+                }
+                if (!$ob_started) {
+                    ob_start();
+                }
+            }
+            else
+            {
+                ob_start();
+            }
         }
 
         $this-&gt;loadGlobalVars();
@@ -413,14 +413,18 @@
         'xoops_version' =&gt; XOOPS_VERSION,
         'xoops_upload_url' =&gt; XOOPS_UPLOAD_URL));
         $this-&gt;tplEngine-&gt;assign(
-        array('xoops_requesturi' =&gt; htmlspecialchars($GLOBALS['xoopsRequestUri'], ENT_QUOTES),
-        'xoops_sitename' =&gt; htmlspecialchars($xoopsConfig['sitename'], ENT_QUOTES),
-        'xoops_slogan' =&gt; htmlspecialchars($xoopsConfig['slogan'], ENT_QUOTES)));
+	        array('xoops_requesturi' =&gt; htmlspecialchars($GLOBALS['xoopsRequestUri'], ENT_QUOTES),
+	        'xoops_sitename' =&gt; htmlspecialchars($xoopsConfig['sitename'], ENT_QUOTES),
+	        'xoops_slogan' =&gt; htmlspecialchars($xoopsConfig['slogan'], ENT_QUOTES)));
         if ($loadConfig == true) {
             // Meta tags
             $config_handler =&amp; xoops_gethandler('config');
             $config =&amp; $config_handler-&gt;getConfigsByCat(XOOPS_CONF_METAFOOTER);
             foreach ($config as $name =&gt; $value) {
+	            // Sanitizer quote/single quote
+	            if(&quot;footer&quot; != $name){
+	            	$value = htmlspecialchars($value, ENT_QUOTES);
+            	}
                 // prefix each tag with 'xoops_'
                 $this-&gt;tplEngine-&gt;assign('xoops_'.$name, $value);
             }
@@ -439,7 +443,7 @@
         }
         global $xoopsUser, $xoopsModule;
         // Load user variables
-        if ($xoopsUser != '') {
+        if (is_object($xoopsUser)) {
             $this-&gt;tplEngine-&gt;assign(array(   'xoops_isuser' =&gt; true,
             'xoops_userid' =&gt; $xoopsUser-&gt;getVar('uid'),
             'xoops_uname' =&gt; $xoopsUser-&gt;getVar('uname')));
@@ -496,7 +500,10 @@
         $cachegroup = isset($GLOBALS['xoopsOption']['cache_group']) ? &quot;_&quot;.$GLOBALS['xoopsOption']['cache_group'] : &quot;&quot;;
 
         $protocol = strtolower(substr($_SERVER['SERVER_PROTOCOL'], 0, strpos($_SERVER['SERVER_PROTOCOL'], &quot;/&quot;, 0)));
-        return 'mod_'.$GLOBALS['xoopsModule']-&gt;getVar('dirname').'|'.md5(str_replace(XOOPS_URL, '', $protocol.&quot;://&quot;.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'].$cachegroup));
+        //return 'mod_'.$GLOBALS['xoopsModule']-&gt;getVar('dirname').'|'.md5(str_replace(XOOPS_URL, '', $protocol.&quot;://&quot;.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'].$cachegroup));
+        /* How could this happen? */
+        $mod_dirname = is_object($GLOBALS['xoopsModule'])? $GLOBALS['xoopsModule']-&gt;getVar('dirname'):&quot;system&quot;;
+        return 'mod_'.$mod_dirname.'|'.md5(str_replace(XOOPS_URL, '', $protocol.&quot;://&quot;.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'].$cachegroup));
     }
 
     /**

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/tree.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/tree.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/tree.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -219,7 +219,8 @@
             $ret .= '&lt;option value=&quot;0&quot;&gt;&lt;/option&gt;';
         }
         $this-&gt;_makeSelBoxOptions($fieldName, $selected, $key, $ret, $prefix);
-        return $ret.'&lt;/select&gt;';
+       	$ret .= '&lt;/select&gt;';
+        return $ret;
     }
 
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/xml/saxparser.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/xml/saxparser.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/xml/saxparser.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -160,8 +160,11 @@
     {
         xml_parser_free($this-&gt;parser);
 
-        unset($this);
-        // $this = null; // for PHP5 compatibility
+        if (!method_exists($this, '__destruct')) {
+             unset($this);
+        } else {
+            $this-&gt;__destruct();
+        }
     }
 
     /****************************************************************************

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/xoopscomments.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/xoopscomments.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/xoopscomments.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -294,12 +294,12 @@
 				$icq_image = &quot;&quot;;
 			}
 			if ( $poster-&gt;getVar(&quot;user_aim&quot;) != &quot;&quot; ) {
-				$aim_image = &quot;&lt;a href='aim:goim?screenname=&quot;.$poster-&gt;getVar(&quot;user_aim&quot;, &quot;E&quot;).&quot;&amp;message=Hi+&quot;.$poster-&gt;getVar(&quot;user_aim&quot;).&quot;+Are+you+there?'&gt;&lt;img src='&quot;.XOOPS_URL.&quot;/images/icons/aim.gif' alt='aim' /&gt;&lt;/a&gt;&quot;;
+				$aim_image = &quot;&lt;a href='aim:goim?screenname=&quot;.$poster-&gt;getVar(&quot;user_aim&quot;, &quot;E&quot;).&quot;&amp;message=Hi+&quot;.$poster-&gt;getVar(&quot;user_aim&quot;).&quot;+Are+you+there?'&gt;&lt;img src='&quot;.XOOPS_URL.&quot;/images/icons/aim.gif' alt='aim' /&gt;&lt;/a&gt;&quot;;
 			} else {
 				$aim_image = &quot;&quot;;
 			}
    			if ( $poster-&gt;getVar(&quot;user_yim&quot;) != &quot;&quot; ) {
-				$yim_image = &quot;&lt;a href='<A HREF="http://edit.yahoo.com/config/send_webmesg?.target=">http://edit.yahoo.com/config/send_webmesg?.target=</A>&quot;.$poster-&gt;getVar(&quot;user_yim&quot;, &quot;E&quot;).&quot;&amp;.src=pg'&gt;&lt;img src='&quot;.XOOPS_URL.&quot;/images/icons/yim.gif' alt='yim' /&gt;&lt;/a&gt;&quot;;
+				$yim_image = &quot;&lt;a href='<A HREF="http://edit.yahoo.com/config/send_webmesg?.target=">http://edit.yahoo.com/config/send_webmesg?.target=</A>&quot;.$poster-&gt;getVar(&quot;user_yim&quot;, &quot;E&quot;).&quot;&amp;.src=pg'&gt;&lt;img src='&quot;.XOOPS_URL.&quot;/images/icons/yim.gif' alt='yim' /&gt;&lt;/a&gt;&quot;;
 			} else {
 				$yim_image = &quot;&quot;;
 			}

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/dhtmltextarea/editor_registry.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/dhtmltextarea/editor_registry.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/dhtmltextarea/editor_registry.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -37,9 +37,8 @@
 if ( DIRECTORY_SEPARATOR != &quot;/&quot; ) $current_path = str_replace( strpos( $current_path, &quot;\\\\&quot;, 2 ) ? &quot;\\\\&quot; : DIRECTORY_SEPARATOR, &quot;/&quot;, $current_path);
 $root_path = dirname($current_path);
 
-if(file_exists($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;)){
-	include_once($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;);
-}else{
+$xoopsConfig['language'] = preg_replace(&quot;/[^a-z0-9_\-]/i&quot;, &quot;&quot;, $xoopsConfig['language']);
+if(!@include_once($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;)){
 	include_once($root_path.&quot;/language/english.php&quot;);
 }
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/koivi/editor_registry.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/koivi/editor_registry.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/koivi/editor_registry.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -37,9 +37,8 @@
 if ( DIRECTORY_SEPARATOR != &quot;/&quot; ) $current_path = str_replace( strpos( $current_path, &quot;\\\\&quot;, 2 ) ? &quot;\\\\&quot; : DIRECTORY_SEPARATOR, &quot;/&quot;, $current_path);
 $root_path = dirname($current_path);
 
-if(file_exists($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;)){
-	include_once($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;);
-}else{
+$xoopsConfig['language'] = preg_replace(&quot;/[^a-z0-9_\-]/i&quot;, &quot;&quot;, $xoopsConfig['language']);
+if(!@include_once($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;)){
 	include_once($root_path.&quot;/language/english.php&quot;);
 }
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/koivi/include/functions.inc.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/koivi/include/functions.inc.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/koivi/include/functions.inc.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -88,7 +88,7 @@
 	else return $comp;
 }*/
 
-function CheckBrowser($get_isie=true)
+function checkBrowser($get_isie=true)
 {
 	global $_SERVER;
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/textarea/editor_registry.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/textarea/editor_registry.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/xoopseditor/textarea/editor_registry.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -37,9 +37,8 @@
 if ( DIRECTORY_SEPARATOR != &quot;/&quot; ) $current_path = str_replace( strpos( $current_path, &quot;\\\\&quot;, 2 ) ? &quot;\\\\&quot; : DIRECTORY_SEPARATOR, &quot;/&quot;, $current_path);
 $root_path = dirname($current_path);
 
-if(file_exists($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;)){
-	include_once($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;);
-}else{
+$xoopsConfig['language'] = preg_replace(&quot;/[^a-z0-9_\-]/i&quot;, &quot;&quot;, $xoopsConfig['language']);
+if(!@include_once($root_path.&quot;/language/&quot;.$xoopsConfig['language'].&quot;.php&quot;)){
 	include_once($root_path.&quot;/language/english.php&quot;);
 }
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/class/xoopstree.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/class/xoopstree.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/class/xoopstree.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -192,7 +192,7 @@
 		list($parentid,$name) = $this-&gt;db-&gt;fetchRow($result);
 		$myts =&amp; MyTextSanitizer::getInstance();
 		$name = $myts-&gt;makeTboxData4Show($name);
-		$path = &quot;&lt;a href='&quot;.$funcURL.&quot;&amp;&quot;.$this-&gt;id.&quot;=&quot;.$sel_id.&quot;'&gt;&quot;.$name.&quot;&lt;/a&gt;&nbsp;:&nbsp;&quot;.$path.&quot;&quot;;
+		$path = &quot;&lt;a href='&quot;.$funcURL.&quot;&amp;&quot;.$this-&gt;id.&quot;=&quot;.$sel_id.&quot;'&gt;&quot;.$name.&quot;&lt;/a&gt;&nbsp;:&nbsp;&quot;.$path.&quot;&quot;;
 		if ( $parentid == 0 ) {
 			return $path;
 		}

Modified: XoopsCore/branches/2.2.x/2.2-main/html/header.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/header.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/header.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -28,6 +28,11 @@
     die(&quot;XOOPS root path not defined&quot;);
 }
 
+// Ensure charset setting
+if (!headers_sent()) {
+	header('Content-Type:text/html; charset='._CHARSET);
+}
+
 $GLOBALS['xoopsLogger']-&gt;context = &quot;core&quot;;
 
 // Get blocks

Modified: XoopsCore/branches/2.2.x/2.2-main/html/imagemanager.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/imagemanager.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/imagemanager.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -242,7 +242,7 @@
                 $fp = @fopen($uploader-&gt;getSavedDestination(), 'rb');
                 $fbinary = @fread($fp, filesize($uploader-&gt;getSavedDestination()));
                 @fclose($fp);
-                $image-&gt;setVar('image_body', addslashes($fbinary));
+                $image-&gt;setVar('image_body', $fbinary, true);
                 @unlink($uploader-&gt;getSavedDestination());
             }
             if (!$image_handler-&gt;insert($image)) {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/checklogin.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/checklogin.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/checklogin.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -108,7 +108,7 @@
     $notification_handler =&amp; xoops_gethandler('notification');
     $notification_handler-&gt;doLoginMaintenance($user-&gt;getVar('uid'));
 
-    redirect_header($url, 1, sprintf(_US_LOGGINGU, $user-&gt;getVar('uname')));
+    redirect_header($url, 1, sprintf(_US_LOGGINGU, $user-&gt;getVar('uname')), false); // disable &quot;addredirect&quot;!!
 } else {
 
     redirect_header(XOOPS_URL.'/user.php',1,_US_INCORRECTLOGIN);

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/comment_form.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/comment_form.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/comment_form.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -76,12 +76,12 @@
 			$status_select = new XoopsFormSelect(_CM_STATUS, 'com_status', $com_status);
 			$status_select-&gt;addOptionArray(array(XOOPS_COMMENT_PENDING =&gt; _CM_PENDING, XOOPS_COMMENT_ACTIVE =&gt; _CM_ACTIVE, XOOPS_COMMENT_HIDDEN =&gt; _CM_HIDDEN));
 			$cform-&gt;addElement($status_select);
+            $button_tray-&gt;addElement(new XoopsFormButton('', 'com_dodelete', _DELETE, 'submit'));
 		}
 		$html_checkbox = new XoopsFormCheckBox('', 'dohtml', $dohtml);
 		$html_checkbox-&gt;addOption(1, _CM_DOHTML);
 		$option_tray-&gt;addElement($html_checkbox);
-		$button_tray-&gt;addElement(new XoopsFormButton('', 'com_dodelete', _DELETE, 'submit'));
-	}
+    }
 }
 $smiley_checkbox = new XoopsFormCheckBox('', 'dosmiley', $dosmiley);
 $smiley_checkbox-&gt;addOption(1, _CM_DOSMILEY);

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/comment_post.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/comment_post.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/comment_post.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -58,7 +58,7 @@
 	if (isset($comment_config['extraParams']) &amp;&amp; is_array($comment_config['extraParams'])) {
 		$extra_params = '';
 		foreach ($comment_config['extraParams'] as $extra_param) {
-			$extra_params .= isset($_POST[$extra_param]) ? $extra_param.'='.$_POST[$extra_param].'&amp;' : $extra_param.'=&amp;';
+			$extra_params .= isset($_POST[$extra_param]) ? $extra_param.'='.htmlspecialchars($_POST[$extra_param]).'&amp;' : $extra_param.'=&amp;';
 		}
 		$redirect_page .= $extra_params;
 	}
@@ -99,6 +99,8 @@
 	exit();
 }
 
+include_once XOOPS_ROOT_PATH.&quot;/modules/system/constants.php&quot;;
+
 switch ( $op ) {
 
 case &quot;delete&quot;:
@@ -122,7 +124,7 @@
 		}
 	}
 	$p_comment =&amp; $myts-&gt;previewTarea($com_text, $dohtml, $dosmiley, $doxcode, $doimage, $dobr);
-	$com_icon = isset($com_icon) ? $com_icon : '';
+    $com_icon = (!empty($com_icon) &amp;&amp; is_file(XOOPS_ROOT_PATH . &quot;/images/subject/&quot; . $com_icon) ) ? $com_icon : '';
 	$noname = isset($noname) ? intval($noname) : 0;
 	$com_text = $myts-&gt;htmlSpecialChars($myts-&gt;stripSlashesGPC($com_text));
 	if ($xoopsModule-&gt;getVar('dirname') != 'system') {
@@ -266,12 +268,12 @@
 	$comment-&gt;setVar('doxcode', $doxcode);
 	$comment-&gt;setVar('doimage', $doimage);
 	$comment-&gt;setVar('dobr', $dobr);
-	$icon = isset($com_icon) ? $com_icon : '';
+    $icon = (!empty($com_icon) &amp;&amp; is_file(XOOPS_ROOT_PATH . &quot;/images/subject/&quot; . $com_icon) ) ? $com_icon : '';
 	$comment-&gt;setVar('com_icon', $icon);
 	$comment-&gt;setVar('com_modified', time());
 	$comment-&gt;setVar('com_modid', $com_modid);
-	if (isset($extra_params)) {
-		$comment-&gt;setVar('com_exparams', $extra_params);
+    if (!empty($extra_params)) {
+        $comment-&gt;setVar('com_exparams', str_replace('&amp;', '&amp;', $extra_params));
 	}
 	if (false != $comment_handler-&gt;insert($comment)) {
 		$newcid = $comment-&gt;getVar('com_id');

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/cp_functions.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/cp_functions.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/cp_functions.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -37,8 +37,15 @@
     //	} else {
     //  ob_start();
     //	}
+    if (!headers_sent()) {
+        header('Content-Type:text/html; charset='._CHARSET);
+        header('Expires: Mon, 26 Jul 1997 05:00:00 GMT');
+        header(&quot;Last-Modified: &quot; . gmdate(&quot;D, d M Y H:i:s&quot;) . &quot; GMT&quot;);
+        header('Cache-Control: no-store, no-cache, max-age=1, s-maxage=1, must-revalidate, post-check=0, pre-check=0');
+        header(&quot;Pragma: no-cache&quot;);
+    }
     $moduleperm_handler =&amp; xoops_gethandler('groupperm');
-    $admin_mids =&amp; $moduleperm_handler-&gt;getItemIds('module_admin', $xoopsUser-&gt;getGroups());
+    $admin_mids = $moduleperm_handler-&gt;getItemIds('module_admin', $xoopsUser-&gt;getGroups());
 
 
     $module_handler =&amp; xoops_gethandler('module');
@@ -55,7 +62,7 @@
     $isPrefAdmin = $moduleperm_handler-&gt;checkRight('system_admin', XOOPS_SYSTEM_PREF, $xoopsUser-&gt;getGroups());
 
     //load system items
-    $system_rights =&amp; $moduleperm_handler-&gt;getItemIds('system_admin', $xoopsUser-&gt;getGroups());
+    $system_rights = $moduleperm_handler-&gt;getItemIds('system_admin', $xoopsUser-&gt;getGroups());
     if (count($system_rights) &gt; 0 &amp;&amp; is_object($mods[1])) {
         $menuitems = $mods[1]-&gt;getAdminMenu();
         if (count($menuitems) &gt; 0) {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/functions.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/functions.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/functions.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -48,14 +48,14 @@
     &lt;head&gt;
     &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset='._CHARSET.'&quot; /&gt;
     &lt;meta http-equiv=&quot;content-language&quot; content=&quot;'._LANGCODE.'&quot; /&gt;
-    &lt;meta name=&quot;robots&quot; content=&quot;'.$xoopsConfigMetaFooter['meta_robots'].'&quot; /&gt;
-    &lt;meta name=&quot;keywords&quot; content=&quot;'.$xoopsConfigMetaFooter['meta_keywords'].'&quot; /&gt;
-    &lt;meta name=&quot;description&quot; content=&quot;'.$xoopsConfigMetaFooter['meta_desc'].'&quot; /&gt;
-    &lt;meta name=&quot;rating&quot; content=&quot;'.$xoopsConfigMetaFooter['meta_rating'].'&quot; /&gt;
-    &lt;meta name=&quot;author&quot; content=&quot;'.$xoopsConfigMetaFooter['meta_author'].'&quot; /&gt;
-    &lt;meta name=&quot;copyright&quot; content=&quot;'.$xoopsConfigMetaFooter['meta_copyright'].'&quot; /&gt;
+    &lt;meta name=&quot;robots&quot; content=&quot;'.htmlspecialchars($xoopsConfigMetaFooter['meta_robots']).'&quot; /&gt;
+    &lt;meta name=&quot;keywords&quot; content=&quot;'.htmlspecialchars($xoopsConfigMetaFooter['meta_keywords']).'&quot; /&gt;
+    &lt;meta name=&quot;description&quot; content=&quot;'.htmlspecialchars($xoopsConfigMetaFooter['meta_desc']).'&quot; /&gt;
+    &lt;meta name=&quot;rating&quot; content=&quot;'.htmlspecialchars($xoopsConfigMetaFooter['meta_rating']).'&quot; /&gt;
+    &lt;meta name=&quot;author&quot; content=&quot;'.htmlspecialchars($xoopsConfigMetaFooter['meta_author']).'&quot; /&gt;
+    &lt;meta name=&quot;copyright&quot; content=&quot;'.htmlspecialchars($xoopsConfigMetaFooter['meta_copyright']).'&quot; /&gt;
     &lt;meta name=&quot;generator&quot; content=&quot;XOOPS&quot; /&gt;
-    &lt;title&gt;'.$xoopsConfig['sitename'].'&lt;/title&gt;
+    &lt;title&gt;'.htmlspecialchars($xoopsConfig['sitename']).'&lt;/title&gt;
     &lt;script type=&quot;text/javascript&quot; src=&quot;'.XOOPS_URL.'/include/xoops.js&quot;&gt;&lt;/script&gt;
     ';
     $themecss = getcss($xoopsConfig['theme_set']);
@@ -149,8 +149,8 @@
 function xoops_load_lang_file( $filename, $module = '', $default = 'english' ) {
 	$lang = $GLOBALS['xoopsConfig']['language'];
 	$path = XOOPS_ROOT_PATH . ( empty($module) ? '/' : &quot;/modules/$module/&quot; ) . 'language';
-	if ( !( $ret = include_once( &quot;$path/$lang/$filename.php&quot; ) ) ) {
-		$ret = include_once( &quot;$path/$default/$filename.php&quot; );
+	if ( !( $ret = @include_once( &quot;$path/$lang/$filename.php&quot; ) ) ) {
+		$ret = @include_once( &quot;$path/$default/$filename.php&quot; );
 	}
 	return $ret;
 }
@@ -175,7 +175,8 @@
             $timeoffset = $xoopsConfig['default_TZ'];
         }
     }
-    $usertimestamp = intval($time) + (intval($timeoffset) - $xoopsConfig['server_TZ'])*3600;
+    //$usertimestamp = intval($time) + (intval($timeoffset) - $xoopsConfig['server_TZ'])*3600;
+    $usertimestamp = intval($time) + intval((floatval($timeoffset) - floatval($xoopsConfig['server_TZ']))*3600);
     return $usertimestamp;
 }
 
@@ -256,8 +257,11 @@
 */
 function OpenWaitBox()
 {
+	echo &quot;&lt;p align='center'&gt;&lt;strong&gt;&lt;big&gt;&quot; ._FETCHING.&quot;&lt;/big&gt;&lt;/strong&gt;&lt;br style='clear:both' /&gt;&lt;img src='&quot;.XOOPS_URL.&quot;/images/await.gif' alt='' style='padding:10px;' /&gt;&lt;br style='clear:both' /&gt;&quot; ._PLEASEWAIT.&quot;&lt;/p&gt;&quot;;
+	return;
+
     echo &quot;&lt;div id='waitDiv' style='position:absolute;left:40%;top:50%;visibility:hidden;text-align: center;'&gt;
-    &lt;table cellpadding='6' border='2' class='bg2'&gt;
+    &lt;table cellpadding='6' border='0' class='bg2'&gt;
       &lt;tr&gt;
         &lt;td align='center'&gt;&lt;b&gt;&lt;big&gt;&quot; ._FETCHING.&quot;&lt;/big&gt;&lt;/b&gt;&lt;br /&gt;&lt;img src='&quot;.XOOPS_URL.&quot;/images/await.gif' alt='' /&gt;&lt;br /&gt;&quot; ._PLEASEWAIT.&quot;&lt;/td&gt;
       &lt;/tr&gt;
@@ -371,12 +375,12 @@
             $bannerobject = '&lt;div&gt;&lt;a href=&quot;'.XOOPS_URL.'/banners.php?op=click&amp;bid='.$bid.'&quot; target=&quot;_blank&quot;&gt;';
             if (stristr($imageurl, '.swf')) {
                 $bannerobject = $bannerobject
-                .'&lt;object classid=&quot;clsid:D27CDB6E-AE6D-11cf-96B8-444553540000&quot; codebase=&quot;<A HREF="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0">http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0</A>&quot; width=&quot;468&quot; height=&quot;60&quot;&gt;'
-                .'&lt;param name=movie value=&quot;'.$imageurl.'&quot;&gt;'
-                .'&lt;param name=quality value=high&gt;'
-                .'&lt;embed src=&quot;'.$imageurl.'&quot; quality=high pluginspage=&quot;<A HREF="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash">http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash</A>&quot;; type=&quot;application/x-shockwave-flash&quot; width=&quot;468&quot; height=&quot;60&quot;&gt;'
-                .'&lt;/embed&gt;'
-                .'&lt;/object&gt;';
+                    .'&lt;object classid=&quot;clsid:D27CDB6E-AE6D-11cf-96B8-444553540000&quot; codebase=&quot;<A HREF="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0">http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0</A>&quot; width=&quot;468&quot; height=&quot;60&quot;&gt;'
+                    .'&lt;param name=&quot;movie&quot; value=&quot;'.$imageurl.'&quot;&gt;&lt;/param&gt;'
+                    .'&lt;param name=&quot;quality&quot; value=&quot;high&quot;&gt;&lt;/param&gt;'
+                    .'&lt;embed src=&quot;'.$imageurl.'&quot; quality=&quot;high&quot; pluginspage=&quot;<A HREF="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash">http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash</A>&quot;; type=&quot;application/x-shockwave-flash&quot; width=&quot;468&quot; height=&quot;60&quot;&gt;'
+                    .'&lt;/embed&gt;'
+                    .'&lt;/object&gt;';
             } else {
                 $bannerobject = $bannerobject.'&lt;img src=&quot;'.$imageurl.'&quot; alt=&quot;&quot; /&gt;';
             }
@@ -420,7 +424,7 @@
     $message = trim($message) != '' ? $message : _TAKINGBACK;
     $xTheme-&gt;tplEngine-&gt;assign('message', $message);
     $xTheme-&gt;tplEngine-&gt;assign('lang_ifnotreload', sprintf(_IFNOTRELOAD, $url));
-    $xTheme-&gt;tplEngine-&gt;assign('xoops_module_header', '&lt;meta http-equiv=&quot;Refresh&quot; content=&quot;2; url='.$url.'&quot; /&gt;');
+    $xTheme-&gt;tplEngine-&gt;assign('xoops_module_header', '&lt;meta http-equiv=&quot;Refresh&quot; content=&quot;'.$time.'; url='.$url.'&quot; /&gt;');
     $xoopsOption['template_main'] = 'system_redirect.html';
     include XOOPS_ROOT_PATH.&quot;/footer.php&quot;;
     exit();
@@ -553,10 +557,12 @@
     if ( file_exists(XOOPS_ROOT_PATH.&quot;/language/&quot;.$xoopsConfig['language'].&quot;/xoopsmailerlocal.php&quot;) ) {
         include_once XOOPS_ROOT_PATH.&quot;/language/&quot;.$xoopsConfig['language'].&quot;/xoopsmailerlocal.php&quot;;
         if ( class_exists(&quot;XoopsMailerLocal&quot;) ) {
-            return new XoopsMailerLocal();
+            $mailer = new XoopsMailerLocal();
+            return $mailer;
         }
     }
-    return new XoopsMailer();
+    $mailer = new XoopsMailer();
+    return $mailer;
 }
 
 function &amp;xoops_gethandler($name, $optional = false )
@@ -578,7 +584,8 @@
     if ( isset( $handlers[$name] ) ) {
     	return $handlers[$name];
     }
-    return false;
+    $ret = false;
+    return $ret;
 }
 
 function &amp;xoops_getmodulehandler($name = null, $module_dir = null, $optional = false)
@@ -611,7 +618,8 @@
     if ( isset( $handlers[$module_dir][$name] ) ) {
     	return $handlers[$module_dir][$name];
     }
-    return false;
+    $ret = false;
+    return $ret;
 }
 
 function xoops_getrank($rank_id =0, $posts = 0)
@@ -644,9 +652,9 @@
 function xoops_substr($str, $start, $length, $trimmarker = '...')
 {
    	if(is_callable(array(&quot;XoopsLocal&quot;, &quot;substr&quot;))) {
-	   	return XoopsLocal::substr($str, $start, $length); 
+	   	return XoopsLocal::substr($str, $start, $length, $trimmarker); 
 	   	// Or
-	   	// return xoops_local(&quot;substr&quot;, $str, $start, $length);
+	   	// return xoops_local(&quot;substr&quot;, $str, $start, $length, $trimmarker);
    	}
     if ( !XOOPS_USE_MULTIBYTES ) {
         return ( strlen($str) - $start &lt;= $length ) ? substr( $str, $start, $length ) : substr( $str, $start, $length - strlen($trimmarker) ) . $trimmarker;
@@ -736,7 +744,7 @@
     return $gperm_handler-&gt;deleteByModule($module_id, $perm_name, $item_id);
 }
 
-function &amp;xoops_utf8_encode(&amp;$text)
+function &amp;xoops_utf8_encode($text)
 {
    	if(is_callable(array(&quot;XoopsLocal&quot;, &quot;utf8_encode&quot;))) {
 	   	return XoopsLocal::utf8_encode($text); 
@@ -750,7 +758,7 @@
     return utf8_encode($text);
 }
 
-function &amp;xoops_convert_encoding(&amp;$text, $to='utf-8', $from='')
+function &amp;xoops_convert_encoding($text, $to='utf-8', $from='')
 {
    	if(is_callable(array(&quot;XoopsLocal&quot;, &quot;convert_encoding&quot;))) {
 	   	return XoopsLocal::convert_encoding($text, $to, $from); 
@@ -759,7 +767,7 @@
     return xoops_utf8_encode($text);
 }
 
-function xoops_getLinkedUnameFromId($userid, $usereal = 1)
+function xoops_getLinkedUnameFromId($userid, $usereal = 0)
 {
     $userid = intval($userid);
     if ($userid &gt; 0) {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/notification_functions.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/notification_functions.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/notification_functions.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -101,7 +101,8 @@
 			return $category;
 		}
 	}
-	return false;
+	$ret = false;
+	return $ret;
 }
 
 /**
@@ -119,9 +120,10 @@
  */
 function &amp;notificationCommentCategoryInfo($module_id=null)
 {
+	$ret = false;
 	$all_categories =&amp; notificationCategoryInfo ('', $module_id);
 	if (empty($all_categories)) {
-		return false;
+		return $ret;
 	}
 	foreach ($all_categories as $category) {
 		$all_events =&amp; notificationEvents ($category['name'], false, $module_id);
@@ -134,7 +136,7 @@
 			}
 		}
 	}
-	return false;
+	return $ret;
 }
 
 // TODO: some way to include or exclude admin-only events...
@@ -306,7 +308,8 @@
 			return $event;
 		}
 	}
-	return false;
+	$ret = false;
+	return $ret;
 }
 
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/notification_update.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/notification_update.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/notification_update.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -118,7 +118,7 @@
         $argstring .= &quot;?&quot; . $arg . &quot;=&quot; . $redirect_args[$arg];
         $first_arg = 0;
     } else {
-        $argstring .= &quot;&amp;&quot; . $arg . &quot;=&quot; . $redirect_args[$arg];
+		$argstring .= &quot;&amp;&quot; . $arg . &quot;=&quot; . $redirect_args[$arg];
     }
 }
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/version.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/version.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/version.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -1,4 +1,4 @@
 &lt;?php
 // $Id$
-define(&quot;XOOPS_VERSION&quot;,&quot;XOOPS 2.2.3 Final&quot;);
+define(&quot;XOOPS_VERSION&quot;,&quot;XOOPS 2.2.4&quot;);
 ?&gt;
\ No newline at end of file

Modified: XoopsCore/branches/2.2.x/2.2-main/html/include/xoopscodes.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/include/xoopscodes.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/include/xoopscodes.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -102,6 +102,6 @@
 		}
 	}
 	//hack for more
-	echo &quot;&nbsp;[&lt;a href='#moresmiley' onmouseover='style.cursor=\&quot;hand\&quot;' onclick='openWithSelfMain(\&quot;&quot;.XOOPS_URL.&quot;/misc.php?action=showpopups&amp;type=smilies&amp;target=&quot;.$textarea_id.&quot;\&quot;,\&quot;smilies\&quot;,300,475);'&gt;&quot;._MORE.&quot;&lt;/a&gt;]&quot;;
+	echo &quot;&nbsp;[&lt;a href='#moresmiley' onmouseover='style.cursor=\&quot;hand\&quot;' alt='' onclick='openWithSelfMain(\&quot;&quot;.XOOPS_URL.&quot;/misc.php?action=showpopups&amp;type=smilies&amp;target=&quot;.$textarea_id.&quot;\&quot;,\&quot;smilies\&quot;,300,475);'&gt;&quot;._MORE.&quot;&lt;/a&gt;]&quot;;
 }  //fin du hack
 ?&gt;
\ No newline at end of file

Modified: XoopsCore/branches/2.2.x/2.2-main/html/install/index.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/install/index.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/install/index.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -634,6 +634,8 @@
                 &lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;modules[]&quot; value=&quot;'.$module-&gt;getInfo('dirname').'&quot;' ;
             if(in_array($file, $pre_specified)){
             	$content .= ' &quot;checked&quot; ';
+            }else{
+            	$content .= ' &quot;disabled&quot; ';
             }
             $content .= '/&gt;&lt;/td&gt;
                 &lt;td align=&quot;center&quot; valign=&quot;bottom&quot;&gt;&lt;img src=&quot;'.XOOPS_URL.'/modules/'.$module-&gt;getInfo('dirname').'/'.$module-&gt;getInfo('image').'&quot; alt=&quot;'.htmlspecialchars($module-&gt;getInfo('name')).'&quot; border=&quot;0&quot; /&gt;&lt;/td&gt;

Modified: XoopsCore/branches/2.2.x/2.2-main/html/install/install_tpl.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/install/install_tpl.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/install/install_tpl.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -22,7 +22,7 @@
   &lt;tr&gt;
     &lt;td width=&quot;150&quot;&gt;&lt;a href=&quot;index.php&quot;&gt;&lt;img src=&quot;img/logo.gif&quot; width=&quot;150&quot; height=&quot;80&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;&lt;/td&gt;
     &lt;td width=&quot;478&quot; background=&quot;img/bg_darkblue.gif&quot;&gt;&nbsp;&lt;/td&gt;
-    &lt;td width=&quot;150&quot;&gt;&lt;img src=&quot;img/xoops2.gif&quot; width=&quot;100%&quot; height=&quot;80&quot;&gt;&lt;/td&gt;
+    &lt;td width=&quot;150&quot;&gt;&lt;img src=&quot;img/xoops2.gif&quot; width=&quot;100%&quot; height=&quot;80&quot; /&gt;&lt;/td&gt;
   &lt;/tr&gt;
   &lt;tr&gt;
     &lt;td width=&quot;150&quot;&gt;&lt;img src=&quot;img/hbar_left.gif&quot; width=&quot;100%&quot; height=&quot;23&quot; alt=&quot;&quot; /&gt;&lt;/td&gt;
@@ -31,7 +31,7 @@
   &lt;/tr&gt;
 &lt;/table&gt;
 
-&lt;table width=&quot;778&quot; align=&quot;center&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; background=&quot;img/bg_table.gif&quot;
+&lt;table width=&quot;778&quot; align=&quot;center&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; background=&quot;img/bg_table.gif&quot;&gt;
   &lt;tr&gt;
     &lt;td width='5%'&gt;&nbsp;&lt;/td&gt;
     &lt;td colspan=&quot;3&quot;&gt;&lt;?php if(!empty($title)) echo '&lt;h4 style=&quot;margin-top: 10px; margin-bottom: 5px; padding: 10px;&quot;&gt;'.$title.'&lt;/h4&gt;'; echo '&lt;div style=&quot;padding: 10px;&quot;&gt;'.$content.'&lt;/div&gt;'; ?&gt;&lt;/td&gt;

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/blockinstance.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/blockinstance.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/blockinstance.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -108,13 +108,13 @@
                 // execute the function
                 $block = $show_func($options);
                 if ( !$block ) {
-                    return false;
+                    return $block;
                 }
             } else {
-                return false;
+                return $block;
             }
         } else {
-            return false;
+            return $block;
         }
 
         return $block;
@@ -166,7 +166,7 @@
     function getLinkedObjects($groupid, $module_id=0, $pageid=0, $visible=null, $orderby='i.weight,i.instanceid', $isactive=1) {
         $ret = array();
         $groupperm_handler =&amp; xoops_gethandler('groupperm');
-        $instanceids =&amp; $groupperm_handler-&gt;getItemIds('block_read', $groupid);
+        $instanceids = $groupperm_handler-&gt;getItemIds('block_read', $groupid);
         if (!empty($instanceids)) {
             $block_handler =&amp; xoops_gethandler('block');
             $sql = 'SELECT DISTINCT i.instanceid, b.*, i.* FROM '.$this-&gt;table.' i, '.$block_handler-&gt;table.' b, '.$this-&gt;db-&gt;prefix('block_module_link').' m WHERE m.block_id=i.instanceid';

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/config.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/config.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/config.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -196,7 +196,7 @@
      * 
      * @return	array   Array of {@link XoopsConfigItem} objects
      */
-    function getConfigs($criteria = null, $id_as_key = false, $with_options = false)
+    function &amp;getConfigs($criteria = null, $id_as_key = false, $with_options = false)
     {
         $confs = $this-&gt;_cHandler-&gt;getObjects($criteria, $id_as_key);
         if ($with_options == true) {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/member.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/member.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/member.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -276,7 +276,7 @@
      */
     function getUsersByGroup($group_id, $asobject = false, $limit = 0, $start = 0)
     {
-        $user_ids =&amp; $this-&gt;_mHandler-&gt;getUsersByGroup($group_id, $limit, $start);
+        $user_ids = $this-&gt;_mHandler-&gt;getUsersByGroup($group_id, $limit, $start);
         if (!$asobject) {
            return $user_ids;
         } else {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/module.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/module.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/module.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -142,7 +142,7 @@
      * @param   mix  	$value
      * @return  bool
      **/
-    function &amp;setInfo($name, $value)
+    function setInfo($name, $value)
     {
         if(empty($name)) {
 	        $this-&gt;modinfo = $value;
@@ -1183,7 +1183,7 @@
             unset($existing_fields_arr);
         }
         else {
-            echo &quot;No Profile fields found&quot;;
+            //echo &quot;No Profile fields found&quot;;
         }
     }
 
@@ -1333,9 +1333,10 @@
         if (!empty($_cachedModule_dirname[$dirname])) {
             return $_cachedModule_dirname[$dirname];
         } else {
+	        $module = false;
             $sql = &quot;SELECT * FROM &quot;.$this-&gt;db-&gt;prefix('modules').&quot; WHERE dirname = '&quot;.trim($dirname).&quot;'&quot;;
             if (!$result = $this-&gt;db-&gt;query($sql)) {
-                return false;
+                return $module;
             }
             $numrows = $this-&gt;db-&gt;getRowsNum($result);
             if ($numrows == 1) {
@@ -1346,7 +1347,7 @@
                 $_cachedModule_mid[$module-&gt;getVar('mid')] =&amp; $module;
                 return $module;
             }
-            return false;
+            return $module;
         }
     }
 
@@ -1444,9 +1445,9 @@
         $modules = $this-&gt;getObjects($criteria, true);
         foreach (array_keys($modules) as $i) {
             if (!$dirname_as_key) {
-                $ret[$i] =&amp; $modules[$i]-&gt;getVar('name');
+                $ret[$i] = $modules[$i]-&gt;getVar('name');
             } else {
-                $ret[$modules[$i]-&gt;getVar('dirname')] =&amp; $modules[$i]-&gt;getVar('name');
+                $ret[$modules[$i]-&gt;getVar('dirname')] = $modules[$i]-&gt;getVar('name');
             }
         }
         return $ret;
@@ -1457,7 +1458,7 @@
     *
     * @return object
     */
-    function loadModule() {
+    function &amp;loadModule() {
         $url_arr = explode('/',strstr($_SERVER['REQUEST_URI'],'/modules/'));
         if (isset($url_arr[2])) {
             $xoopsModule =&amp; $this-&gt;getByDirname($url_arr[2]);

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/object.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/object.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/object.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -782,7 +782,7 @@
      *
      * @return array
      */
-    function getObjects($criteria = null, $id_as_key = false, $as_object = true)
+    function &amp;getObjects($criteria = null, $id_as_key = false, $as_object = true)
     {
         $ret = array();
         $limit = $start = 0;
@@ -800,7 +800,8 @@
             return $ret;
         }
 
-        return $this-&gt;convertResultSet($result, $id_as_key, $as_object);
+        $ret = $this-&gt;convertResultSet($result, $id_as_key, $as_object);
+        return $ret;
     }
 
     /**

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/online.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/online.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/online.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -143,7 +143,7 @@
             $limit = $criteria-&gt;getLimit();
             $start = $criteria-&gt;getStart();
         }
-        $result =&amp; $this-&gt;db-&gt;query($sql, $limit, $start);
+        $result = $this-&gt;db-&gt;query($sql, $limit, $start);
         if (!$result) {
             return false;
         }
@@ -165,7 +165,7 @@
         if (is_object($criteria) &amp;&amp; is_subclass_of($criteria, 'criteriaelement')) {
             $sql .= ' '.$criteria-&gt;renderWhere();
         }
-        if (!$result =&amp; $this-&gt;db-&gt;query($sql)) {
+        if (!$result = $this-&gt;db-&gt;query($sql)) {
             return false;
         }
         list($ret) = $this-&gt;db-&gt;fetchRow($result);

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/profile.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/profile.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/profile.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -46,7 +46,11 @@
     function init($fields) {
         if (is_array($fields) &amp;&amp; count($fields) &gt; 0) {
             foreach (array_keys($fields) as $key) {
-                $this-&gt;initVar($key, $fields[$key]-&gt;getVar('field_valuetype'), $fields[$key]-&gt;getVar('field_default', 'n'), $fields[$key]-&gt;getVar('field_required'), $fields[$key]-&gt;getVar('field_maxlength'));
+	            if(!is_object($fields[$key])){
+                	$this-&gt;initVar($key, $fields[$key]['field_valuetype'], $fields[$key]['field_default'], $fields[$key]['field_required'], $fields[$key]['field_maxlength']);
+            	}else{
+                	$this-&gt;initVar($key, $fields[$key]-&gt;getVar('field_valuetype'), $fields[$key]-&gt;getVar('field_default', 'n'), $fields[$key]-&gt;getVar('field_required'), $fields[$key]-&gt;getVar('field_maxlength'));
+            	}
             }
         }
     }
@@ -89,9 +93,16 @@
     *
     * @return array
     */
-    function loadFields() {
+    function &amp;loadFields($asObject = true) {
+        static $type;
+        
+        if(isset($type) &amp;&amp; $type != $asObject){
+	        $this-&gt;_fields = array();
+        }
+        $type = !empty($asObject);
+        
         if (count($this-&gt;_fields) == 0) {
-            $this-&gt;_fields =&amp; $this-&gt;_fHandler-&gt;loadFields();
+            $this-&gt;_fields = $this-&gt;_fHandler-&gt;loadFields(false, $asObject);
         }
         return $this-&gt;_fields;
     }

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/profilefield.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/profilefield.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/profilefield.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -151,6 +151,12 @@
             case 'theme':
             $element = new XoopsFormSelect($caption, $name, $value);
             $element-&gt;addOption(&quot;0&quot;, _SITEDEFAULT);
+            $theme_list = XoopsLists::getThemesList();
+            foreach($theme_list as $key=&gt;$val){
+	            if(!in_array($key, $GLOBALS['xoopsConfig']['theme_set_allowed'])) continue;
+            	$element-&gt;addOption($key, $val);
+            }
+            /*
             $handle = opendir(XOOPS_THEME_PATH.'/');
             $dirlist = array();
             while (false !== ($file = readdir($handle))) {
@@ -165,6 +171,7 @@
                 asort($dirlist);
                 $element-&gt;addOptionArray($dirlist);
             }
+            */
             break;
         }
         if ($this-&gt;getVar('field_description') != &quot;&quot;) {
@@ -192,13 +199,13 @@
             case 'theme':
             case &quot;language&quot;:
             case &quot;list&quot;:
-            return $value;
+            //return $value;
             break;
 
             case &quot;select&quot;:
             case &quot;radio&quot;:
             $options = $this-&gt;getVar('field_options');
-            return isset($options[$value]) ? htmlspecialchars($options[$value]) : &quot;&quot;;
+            $value = isset($options[$value]) ? htmlspecialchars($options[$value]) : &quot;&quot;;
             break;
 
             case &quot;select_multi&quot;:
@@ -212,12 +219,12 @@
                     }
                 }
             }
-            return $ret;
+            $value = $ret;
             break;
 
             case &quot;group&quot;:
             //change to retrieve groups and return name of group
-            return $value;
+            //return $value;
             break;
 
             case &quot;group_multi&quot;:
@@ -231,16 +238,19 @@
             
             case &quot;date&quot;:
             if ($value &gt; 0) {
-                return formatTimestamp($value, 's');
+                $value = formatTimestamp($value, 's');
+            }else{
+	            $value = &quot;&quot;;
             }
-            return &quot;&quot;;
             break;
             
             case &quot;datetime&quot;:
             if ($value &gt; 0) {
-                return formatTimestamp($value, 'm');
+                $value = formatTimestamp($value, 'm');
+            }else{
+	            $value = &quot;&quot;;
             }
-            return &quot;&quot;;
+            //return &quot;&quot;;
             break;
 
             case &quot;autotext&quot;:
@@ -248,9 +258,21 @@
 			$value = str_replace(&quot;{X_UID}&quot;, $user-&gt;getVar(&quot;uid&quot;), $value );
 			$value = str_replace(&quot;{X_URL}&quot;, XOOPS_URL, $value );
 			$value = str_replace(&quot;{X_UNAME}&quot;, $user-&gt;getVar(&quot;uname&quot;), $value );
-            return $value;
+            //return $value;
             break;
         }
+        
+        switch ($this-&gt;getVar('field_valuetype')) {
+	        case XOBJ_DTYPE_URL:
+	        if(!empty($value)){
+	        	$value = &quot;&lt;a href=\&quot;&quot;.$value.&quot;\&quot; target=\&quot;_blank\&quot;&gt;&quot;.$value.&quot;&lt;/a&gt;&quot;;
+        	}
+	        break;
+	        default:
+	        break;
+        }
+        return $value;
+        
     }
     
     /**
@@ -313,16 +335,42 @@
     *
     * @return array
     */
-    function loadFields($force_update = false) {
+    function loadFields($force_update = false, $asObject = true) {
         static $fields = array();
-        if (!empty($force_update) || count($fields) == 0) {
+        
+        $type = !empty($asObject);
+        if (!empty($force_update) || !isset($fields[$type])) {
             if (!empty($force_update) || !file_exists(XOOPS_CACHE_PATH.&quot;/profilefields.tmp&quot;)) {
                 $this-&gt;updateCache();
             }
             $s = implode(&quot;&quot;, @file(XOOPS_CACHE_PATH.&quot;/profilefields.tmp&quot;));
-            $fields = unserialize($s);
+            //$fields = unserialize($s);
+            /**/
+            $_fields_data = unserialize($s);
+	        $pseudo_obj =&amp; $this-&gt;create();
+	        $keys = array_keys($pseudo_obj-&gt;vars);
+	        $fields_data = array();
+            foreach($_fields_data as $key =&gt; $field_data){
+	            for($i=0;$i&lt;count($keys);$i++){
+		            $fields_data[$key][$keys[$i]] = $field_data[$i];
+	            }
+            }
+            
+            if(empty($asObject)):
+            $fields_out =&amp; $fields_data;
+            else:
+            foreach($fields_data as $key =&gt; $field_data){
+	            $field =&amp; $this-&gt;create(false);
+	            $field-&gt;assignvars($field_data);
+	            $fields_out[$key] = $field;
+	            unset($field);
+            }
+            endif;
+            $fields[$type] = $fields_out;
+            unset($fields_out);
+            /**/
         }
-        return $fields;
+        return $fields[$type];
     }
     
     /**
@@ -362,7 +410,7 @@
                 
             case &quot;textbox&quot;:
             	if($obj-&gt;getVar('field_valuetype')!=XOBJ_DTYPE_INT){
-                	$obj-&gt;setVar('field_valuetype', XOBJ_DTYPE_TXTBOX);
+                	//$obj-&gt;setVar('field_valuetype', XOBJ_DTYPE_TXTBOX);
             	}
                 break;
                 
@@ -503,10 +551,19 @@
         $criteria = new Criteria('fieldid', 0, &quot;!=&quot;);
         $criteria-&gt;setSort('field_weight');
         $field_objs =&amp; $this-&gt;getObjects(null);
+        $fields = array();
+        $pseudo_obj =&amp; $this-&gt;create();
         foreach (array_keys($field_objs) as $i) {
-            $fields[$field_objs[$i]-&gt;getVar('field_name')] = $field_objs[$i];
+            //$fields[$field_objs[$i]-&gt;getVar('field_name')] = $field_objs[$i];
+            /**/
+            $field = array();
+            foreach(array_keys($pseudo_obj-&gt;vars) as $key){
+	            $field[] = @$field_objs[$i]-&gt;getVar($key, &quot;n&quot;);
+            }
+            $fields[$field_objs[$i]-&gt;getVar('field_name')] = $field;
+            unset($filed);
         }
-        $s = serialize($fields);
+        $s = serialize($fields); // shall we do some character escaping?
         $fp = fopen(XOOPS_CACHE_PATH.&quot;/profilefields.tmp&quot;, &quot;w&quot;);
         if (!fputs($fp, $s)) {
             fclose($fp);

Modified: XoopsCore/branches/2.2.x/2.2-main/html/kernel/tplfile.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/kernel/tplfile.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/kernel/tplfile.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -258,7 +258,7 @@
     function getModuleTplCount($tplset)
     {
         $ret = array();
-        $sql = &quot;SELECT tpl_module, COUNT(tpl_id) AS count FROM &quot;.$this-&gt;db-&gt;prefix('tplfile').&quot; WHERE tpl_tplset='&quot;.$tplset.&quot;' GROUP BY tpl_module&quot;;
+        $sql = &quot;SELECT tpl_module, COUNT(tpl_id) AS count FROM &quot;.$this-&gt;db-&gt;prefix('tplfile').&quot; WHERE tpl_tplset=&quot;.$this-&gt;db-&gt;quoteString($tplset).&quot; GROUP BY tpl_module&quot;;
         $result = $this-&gt;db-&gt;query($sql);
         if (!$result) {
             return $ret;

Modified: XoopsCore/branches/2.2.x/2.2-main/html/language/english/local.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/language/english/local.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/language/english/local.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -40,7 +40,8 @@
 
 	function &amp;trim($text)
 	{
-	    return trim($text);
+	    $ret = trim($text);
+	    return $ret;
 	}
 	
 	/*
@@ -49,6 +50,17 @@
 	function formatTimestamp($time, $format=&quot;l&quot;, $timeoffset=&quot;&quot;)
 	{
 	    global $xoopsConfig, $xoopsUser;
+	    if(strtolower($format) == &quot;rss&quot; ||strtolower($format) == &quot;r&quot;){
+        	$TIME_ZONE = &quot;&quot;;
+        	if(!empty($GLOBALS['xoopsConfig']['server_TZ'])){
+				$server_TZ = abs(intval($GLOBALS['xoopsConfig']['server_TZ']*3600.0));
+				$prefix = ($GLOBALS['xoopsConfig']['server_TZ']&lt;0)?&quot; -&quot;:&quot; +&quot;;
+				$TIME_ZONE = $prefix.date(&quot;Hi&quot;,$server_TZ);
+			}
+			$date = gmdate(&quot;D, d M Y H:i:s&quot;, intval($time)).$TIME_ZONE;
+			return $date;
+    	}
+    	
 	    $usertimestamp = xoops_getUserTimestamp($time, $timeoffset);
 	    switch (strtolower($format)) {
 	        case 's':
@@ -68,15 +80,16 @@
 	        break;
 	        case 'c':
 	        case 'custom':	        
-	        if(date(&quot;Ymd&quot;, $usertimestamp) == date(&quot;Ymd&quot;)){
+	        $current_timestamp = xoops_getUserTimestamp(time(), $timeoffset);
+	        if(date(&quot;Ymd&quot;, $usertimestamp) == date(&quot;Ymd&quot;, $current_timestamp)){
 				$datestring = _TODAY;
-			}elseif(date(&quot;Ymd&quot;, $usertimestamp+24*60*60) == date(&quot;Ymd&quot;)){
+			}elseif(date(&quot;Ymd&quot;, $usertimestamp+24*60*60) == date(&quot;Ymd&quot;, $current_timestamp)){
 				$datestring = _YESTERDAY;
-			}elseif(date(&quot;Y&quot;, $usertimestamp) == date(&quot;Y&quot;)){
+			}elseif(date(&quot;Y&quot;, $usertimestamp) == date(&quot;Y&quot;, $current_timestamp)){
 				$datestring = _MONTHDAY;
 			}else{
 				$datestring = _YEARMONTHDAY;
-			}			
+			}
 	        break;
 	        default:
 	        if ($format != '') {
@@ -96,7 +109,8 @@
 	// Method 2: echo XoopsLocal::hello(&quot;Some greeting words&quot;);
 	function &amp;hello($text)
 	{
-		return &quot;&lt;div&gt;Hello, &quot;.$text.&quot;&lt;/div&gt;&quot;;
+		$ret = &quot;&lt;div&gt;Hello, &quot;.$text.&quot;&lt;/div&gt;&quot;;
+		return $ret;
 	}
 }
 ?&gt;
\ No newline at end of file

Modified: XoopsCore/branches/2.2.x/2.2-main/html/lostpass.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/lostpass.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/lostpass.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -60,16 +60,17 @@
         $xoopsMailer-&gt;assign(&quot;LOGINNAME&quot;, $getuser[0]-&gt;getVar('loginname'));
         if ( !$xoopsMailer-&gt;send() ) {
             echo $xoopsMailer-&gt;getErrors();
+	        redirect_header(&quot;user.php&quot;, 3, $xoopsMailer-&gt;getErrors(), false);
+        }else{
+	        $getuser[0]-&gt;setVar('pass', md5($newpass));
+	        if (!$member_handler-&gt;insertUser($getuser[0], true)) {
+	            include XOOPS_ROOT_PATH.&quot;/header.php&quot;;
+	            echo _US_MAILPWDNG;
+	            include XOOPS_ROOT_PATH.&quot;/footer.php&quot;;
+	            exit();
+	        }
+	        redirect_header(&quot;user.php&quot;, 3, sprintf(_US_PWDMAILED,$getuser[0]-&gt;getVar(&quot;uname&quot;)), false);
         }
-
-        $getuser[0]-&gt;setVar('pass', md5($newpass));
-        if (!$member_handler-&gt;insertUser($getuser[0], true)) {
-            include XOOPS_ROOT_PATH.&quot;/header.php&quot;;
-            echo _US_MAILPWDNG;
-            include XOOPS_ROOT_PATH.&quot;/footer.php&quot;;
-            exit();
-        }
-        redirect_header(&quot;user.php&quot;, 3, sprintf(_US_PWDMAILED,$getuser[0]-&gt;getVar(&quot;uname&quot;)), false);
         exit();
         // If no Code, send it
     } else {
@@ -82,10 +83,11 @@
         include XOOPS_ROOT_PATH.&quot;/header.php&quot;;
         if ( !$xoopsMailer-&gt;send() ) {
             echo $xoopsMailer-&gt;getErrors();
+        }else{
+	        echo &quot;&lt;h4&gt;&quot;;
+	        printf(_US_CONFMAIL,$getuser[0]-&gt;getVar(&quot;uname&quot;));
+	        echo &quot;&lt;/h4&gt;&quot;;
         }
-        echo &quot;&lt;h4&gt;&quot;;
-        printf(_US_CONFMAIL,$getuser[0]-&gt;getVar(&quot;uname&quot;));
-        echo &quot;&lt;/h4&gt;&quot;;
         include XOOPS_ROOT_PATH.&quot;/footer.php&quot;;
     }
 }

Modified: XoopsCore/branches/2.2.x/2.2-main/html/mainfile.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/mainfile.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/mainfile.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -24,12 +24,75 @@
 //  along with this program; if not, write to the Free Software              //
 //  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA //
 //  ------------------------------------------------------------------------ //
-/**
- * Xoops is not installed, redirect to the installer 
- **/
 
-// XOOPS is not installed yet.
-if(! defined('XOOPS_INSTALL')){
-    header('Location: install/index.php');
+if ( !defined(&quot;XOOPS_MAINFILE_INCLUDED&quot;) ) {
+	define(&quot;XOOPS_MAINFILE_INCLUDED&quot;,1);
+
+	// XOOPS Physical Path
+	// Physical path to your main XOOPS directory WITHOUT trailing slash
+	// Example: define('XOOPS_ROOT_PATH', 'w:/home/xoops.local/htdocs_dev/svn-2.2.4/html');
+	define('XOOPS_ROOT_PATH', 'w:/home/xoops.local/htdocs_dev/svn-2.2.4/html');
+
+	// XOOPS Virtual Path (URL)
+	// Virtual path to your main XOOPS directory WITHOUT trailing slash
+	// Example: define('XOOPS_URL', '<A HREF="http://dev.xoops.local/svn-2.2.4/html">http://dev.xoops.local/svn-2.2.4/html</A>');
+	define('XOOPS_URL', '<A HREF="http://dev.xoops.local/svn-2.2.4/html">http://dev.xoops.local/svn-2.2.4/html</A>');
+
+	define('XOOPS_CHECK_PATH', '1');
+	// Protect against external scripts execution if safe mode is not enabled
+	if ( XOOPS_CHECK_PATH &amp;&amp; !@ini_get('safe_mode') ) {
+		if ( function_exists('debug_backtrace') ) {
+			$xoopsScriptPath = debug_backtrace();
+			if ( !count($xoopsScriptPath) ) {
+			 	die(&quot;XOOPS path check: this file cannot be requested directly&quot;);
+			}
+			$xoopsScriptPath = $xoopsScriptPath[0]['file'];
+		} else {
+			$xoopsScriptPath = isset($_SERVER['PATH_TRANSLATED']) ? $_SERVER['PATH_TRANSLATED'] :  $_SERVER['SCRIPT_FILENAME'];
+		}
+		if ( DIRECTORY_SEPARATOR != '/' ) {
+			// IIS6 may double the \ chars
+			$xoopsScriptPath = str_replace( strpos( $xoopsScriptPath, '\\\\', 2 ) ? '\\\\' : DIRECTORY_SEPARATOR, '/', $xoopsScriptPath);
+		}
+		if ( strcasecmp( substr($xoopsScriptPath, 0, strlen(XOOPS_ROOT_PATH)), str_replace( DIRECTORY_SEPARATOR, '/', XOOPS_ROOT_PATH)) ) {
+		 	exit(&quot;XOOPS path check: Script is not inside XOOPS_ROOT_PATH and cannot run.&quot;);
+		}
+	}
+
+	// Database
+	// Choose the database to be used
+	define('XOOPS_DB_TYPE', 'mysql');
+
+	// Table Prefix
+	// This prefix will be added to all new tables created to avoid name conflict in the database. Please change this to something different than 'xoops'.
+	define('XOOPS_DB_PREFIX', 'x224');
+
+	// Database Hostname
+	// Hostname of the database server. If you are unsure, 'localhost' works in most cases.
+	define('XOOPS_DB_HOST', 'localhost');
+
+	// Database Username
+	// Your database user account on the host
+	define('XOOPS_DB_USER', 'root');
+
+	// Database Password
+	// Password for your database user account
+	define('XOOPS_DB_PASS', 'skalpa');
+
+	// Database Name
+	// The name of database on the host. The installer will attempt to create the database if not exist
+	define('XOOPS_DB_NAME', 'xoops_dev');
+
+	// Use persistent connection? (Yes=1 No=0)
+	// Default is 'No'. Choose 'No' if you are unsure.
+	define('XOOPS_DB_PCONNECT', '0');
+
+	define('XOOPS_GROUP_ADMIN', '1');
+	define('XOOPS_GROUP_USERS', '2');
+	define('XOOPS_GROUP_ANONYMOUS', '3');
+
+	if (!isset($xoopsOption['nocommon']) &amp;&amp; XOOPS_ROOT_PATH != '') {
+		require XOOPS_ROOT_PATH.&quot;/include/common.php&quot;;
+	}
 }
 ?&gt;
\ No newline at end of file

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/readpmsg.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/readpmsg.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/readpmsg.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -39,6 +39,14 @@
 	}else{
 		$pm = null;
 	}
+    if (is_object($pm) 
+    	&amp;&amp; (!$xoopsUser-&gt;isAdmin())
+    	&amp;&amp; ($pm-&gt;getVar('from_userid') != $xoopsUser-&gt;getVar('uid'))
+    	&amp;&amp; ($pm-&gt;getVar('to_userid') != $xoopsUser-&gt;getVar('uid'))
+    ){
+        redirect_header(XOOPS_URL.'/modules/'.$xoopsModule-&gt;getVar(&quot;dirname&quot;).'/index.php', 2, _NOPERM);
+        exit();
+    }
     if (is_object($pm) &amp;&amp; !empty($_POST['action']) ) {
         if (!$GLOBALS['xoopsSecurity']-&gt;check()) {
             echo implode('&lt;br /&gt;', $GLOBALS['xoopsSecurity']-&gt;getErrors());

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/templates/pm_viewpmsg.html
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/templates/pm_viewpmsg.html	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/templates/pm_viewpmsg.html	2006-01-22 23:49:01 UTC (rev 185)
@@ -71,7 +71,7 @@
                     &lt;{/if}&gt;
                 &lt;/td&gt;
                 &lt;td valign='middle'&gt;
-                    &lt;a href='readpmsg.php?msg_id=&lt;{$message.msg_id}&gt;start=&lt;{$message.msg_no}&gt;&amp;total_messages=&lt;{$total_messages}&gt;&amp;op=&lt;{$op}&gt;'&gt;
+                    &lt;a href='readpmsg.php?msg_id=&lt;{$message.msg_id}&gt;&amp;start=&lt;{$message.msg_no}&gt;&amp;total_messages=&lt;{$total_messages}&gt;&amp;op=&lt;{$op}&gt;'&gt;
                         &lt;{$message.subject}&gt;
                     &lt;/a&gt;
                 &lt;/td&gt;

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/xoops_version.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/xoops_version.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/pm/xoops_version.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -52,7 +52,7 @@
 //install
 $modversion['onInstall'] = 'include/install.php';
 //update
-$modversion['onUpdate'] = 'include/update.php';
+//$modversion['onUpdate'] = 'include/update.php';
 
 // Templates
 $modversion['templates'][1]['file'] = 'pm_pmlite.html';
@@ -106,10 +106,10 @@
 $modversion['profile']['field'][1]['type'] = 'autotext';
 $modversion['profile']['field'][1]['valuetype'] = XOBJ_DTYPE_TXTAREA;
 $modversion['profile']['field'][1]['default'] = &quot;&lt;a href=\&quot;javascript:openWithSelfMain('{X_URL}/modules/pm/pmlite.php?send2=1&amp;to_userid={X_UID}', 'pmlite', 550, 450);\&quot; title=\&quot;&quot;._PM_MI_MESSAGE.&quot; {X_UNAME}\&quot;&gt;&lt;img src=\&quot;{X_URL}/modules/pm/images/pm.gif\&quot; alt=\&quot;&quot;._PM_MI_MESSAGE.&quot; {X_UNAME}\&quot; /&gt;&lt;/a&gt;&quot;;
-$modversion['profile']['field'][1]['show'] = 1; 
-$modversion['profile']['field'][1]['title'] = _PM_MI_LINK_TITLE; 
+$modversion['profile']['field'][1]['show'] = 1;
+$modversion['profile']['field'][1]['title'] = _PM_MI_LINK_TITLE;
 $modversion['profile']['field'][1]['edit'] = 0;
-$modversion['profile']['field'][1]['description'] = _PM_MI_LINK_DESCRIPTION; 
+$modversion['profile']['field'][1]['description'] = _PM_MI_LINK_DESCRIPTION;
 $modversion['profile']['field'][1]['required'] = 0;
 $modversion['profile']['field'][1]['config'] = 0;
 $modversion['profile']['field'][1]['options'] = array();

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/activate.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/activate.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/activate.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -69,7 +69,6 @@
                     $xoopsMailer-&gt;setFromEmail($xoopsConfig['adminmail']);
                     $xoopsMailer-&gt;setFromName($xoopsConfig['sitename']);
                     $xoopsMailer-&gt;setSubject(sprintf(_PROFILE_MA_YOURACCOUNT,$xoopsConfig['sitename']));
-                    include XOOPS_ROOT_PATH.'/header.php';
                     if ( !$xoopsMailer-&gt;send() ) {
                         printf(_PROFILE_MA_ACTVMAILNG, $thisuser-&gt;getVar('uname'));
                     } else {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/admin/user.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/admin/user.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/admin/user.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -137,7 +137,7 @@
         $fields =&amp; $profile_handler-&gt;loadFields();
         // Get ids of fields that can be edited
         $gperm_handler =&amp; xoops_gethandler('groupperm');
-        $editable_fields =&amp; $gperm_handler-&gt;getItemIds('profile_edit', $xoopsUser-&gt;getGroups(), $xoopsModule-&gt;getVar('mid'));
+        $editable_fields = $gperm_handler-&gt;getItemIds('profile_edit', $xoopsUser-&gt;getGroups(), $xoopsModule-&gt;getVar('mid'));
 
         foreach (array_keys($fields) as $i) {
             $fieldname = $fields[$i]-&gt;getVar('field_name');

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/edituser.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/edituser.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/edituser.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -53,7 +53,7 @@
     }
     $errors = array();
     $myts =&amp; MyTextSanitizer::getInstance();
-    if ($xoopsUser-&gt;isAdmin()) {
+    if ($xoopsUser-&gt;isAdmin() || $xoopsModuleConfig['allow_chgmail'] == 1) {
         $email = '';
         if (!empty($_POST['email'])) {
             $email = $myts-&gt;stripSlashesGPC(trim($_POST['email']));
@@ -73,9 +73,9 @@
     } else {
         $member_handler =&amp; xoops_gethandler('member');
         $edituser =&amp; $member_handler-&gt;getUser($uid);
-//        if ($xoopsModuleConfig['allow_chgmail'] == 1) {
-//            $edituser-&gt;setVar('email', $email);
-//        }
+        if ($xoopsModuleConfig['allow_chgmail'] == 1) {
+            $edituser-&gt;setVar('email', $email);
+        }
         $edituser-&gt;setVar('name', $myts-&gt;stripSlashesGPC(trim($_POST['name'])));
         $edituser-&gt;setVar('uname', $myts-&gt;stripSlashesGPC(trim($_POST['uname'])));
         if ($xoopsUser-&gt;isAdmin()) {
@@ -95,7 +95,7 @@
         $fields =&amp; $profile_handler-&gt;loadFields();
         // Get ids of fields that can be edited
         $gperm_handler =&amp; xoops_gethandler('groupperm');
-        $editable_fields =&amp; $gperm_handler-&gt;getItemIds('profile_edit', $xoopsUser-&gt;getGroups(), $xoopsModule-&gt;getVar('mid'));
+        $editable_fields = $gperm_handler-&gt;getItemIds('profile_edit', $xoopsUser-&gt;getGroups(), $xoopsModule-&gt;getVar('mid'));
 
         foreach (array_keys($fields) as $i) {
             if (in_array($fields[$i]-&gt;getVar('fieldid'), $editable_fields)) {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/include/forms.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/include/forms.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/include/forms.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -60,11 +60,12 @@
         $element_select = new XoopsFormSelect(_PROFILE_AM_TYPE, 'field_type', $field-&gt;getVar('field_type', 'e'));
         $element_select-&gt;addOptionArray($fieldtypes);
 
-        $form-&gt;addElement($type_select);
+        //$form-&gt;addElement($type_select);
         $form-&gt;addElement($element_select);
 
         switch ($field-&gt;getVar('field_type')) {
             case &quot;textbox&quot;:
+            /*
             $valuetypes = array(XOBJ_DTYPE_ARRAY =&gt; _PROFILE_AM_ARRAY,
                         XOBJ_DTYPE_EMAIL =&gt; _PROFILE_AM_EMAIL,
                         XOBJ_DTYPE_INT =&gt; _PROFILE_AM_INT,
@@ -74,8 +75,9 @@
                         XOBJ_DTYPE_OTHER =&gt; _PROFILE_AM_OTHER);
             $type_select = new XoopsFormSelect(_PROFILE_AM_VALUETYPE, 'field_valuetype', $field-&gt;getVar('field_valuetype', 'e'));
             $type_select-&gt;addOptionArray($valuetypes);
-            $form-&gt;addElement($valuetypes);
+            $form-&gt;addElement($type_select);
             break;
+            */
 
             case &quot;select&quot;:
             case &quot;radio&quot;:
@@ -88,7 +90,7 @@
                         XOBJ_DTYPE_OTHER =&gt; _PROFILE_AM_OTHER);
             $type_select = new XoopsFormSelect(_PROFILE_AM_VALUETYPE, 'field_valuetype', $field-&gt;getVar('field_valuetype', 'e'));
             $type_select-&gt;addOptionArray($valuetypes);
-            $form-&gt;addElement($valuetypes);
+            $form-&gt;addElement($type_select);
             break;
 
 
@@ -171,7 +173,15 @@
             break;
 
             case &quot;theme&quot;:
-            $form-&gt;addElement(new XoopsFormSelectTheme(_PROFILE_AM_DEFAULT, 'field_default', $field-&gt;getVar('field_default', 'e')));
+           	$element = new XoopsFormSelect(_PROFILE_AM_DEFAULT, 'field_default', $field-&gt;getVar('field_default', 'e'));
+            $element-&gt;addOption(&quot;0&quot;, _SITEDEFAULT);
+            $theme_list = XoopsLists::getThemesList();
+            foreach($theme_list as $key=&gt;$val){
+	            if(!in_array($key, $GLOBALS['xoopsConfig']['theme_set_allowed'])) continue;
+            	$element-&gt;addOption($key, $val);
+            }
+            $form-&gt;addElement($element);
+            //$form-&gt;addElement(new XoopsFormSelectTheme(_PROFILE_AM_DEFAULT, 'field_default', $field-&gt;getVar('field_default', 'e')));
             break;
 
             case &quot;autotext&quot;:
@@ -389,7 +399,7 @@
     $weights[0][] = 0;
 
     $email_tray = new XoopsFormElementTray(_PROFILE_MA_EMAIL, '&lt;br /&gt;');
-    if ($user-&gt;isNew() || $xoopsUser-&gt;isAdmin()) {
+    if ($user-&gt;isNew() || $xoopsModuleConfig['allow_chgmail'] == 1 || $xoopsUser-&gt;isAdmin()) {
         $email_text = new XoopsFormText('', 'email', 30, 60, $user-&gt;getVar('email'));
     } else {
         $email_text = new XoopsFormLabel('', $user-&gt;getVar('email'));
@@ -452,7 +462,7 @@
     $fields =&amp; $profile_handler-&gt;loadFields();
     // Get ids of fields that can be edited
     $gperm_handler =&amp; xoops_gethandler('groupperm');
-    $editable_fields =&amp; $gperm_handler-&gt;getItemIds('profile_edit', $xoopsUser-&gt;getGroups(), $xoopsModule-&gt;getVar('mid'));
+    $editable_fields = $gperm_handler-&gt;getItemIds('profile_edit', $xoopsUser-&gt;getGroups(), $xoopsModule-&gt;getVar('mid'));
 
     $profile_fieldcat_handler =&amp; xoops_getmodulehandler('fieldcategory');
     /* @var $profile_fieldcat_handler ProfileFieldCategoryHandler */

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/include/functions.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/include/functions.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/include/functions.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -7,19 +7,24 @@
 *
 * @return string
 */
-function userCheck($user)
+function userCheck(&amp; $user)
 {
     global $xoopsModuleConfig;
+    $is_admin = (is_object($GLOBALS[&quot;xoopsUser&quot;]) &amp;&amp; $GLOBALS[&quot;xoopsUser&quot;]-&gt;isAdmin());
+    $is_admin_user = ($is_admin &amp;&amp; ($user-&gt;getVar(&quot;uid&quot;) == $GLOBALS[&quot;xoopsUser&quot;]-&gt;getVar(&quot;uid&quot;)));
+       
     $stop = '';
     if (!checkEmail($user-&gt;getVar('email'))) {
         $stop .= _PROFILE_MA_INVALIDMAIL.'&lt;br /&gt;'.print_r($user-&gt;getVar('email'));
     }
+    if(!$is_admin):
     foreach ($xoopsModuleConfig['bad_emails'] as $be) {
         if (!empty($be) &amp;&amp; preg_match(&quot;/&quot;.$be.&quot;/i&quot;, $user-&gt;getVar('email'))) {
             $stop .= _PROFILE_MA_INVALIDMAIL.'&lt;br /&gt;'.print_r($user-&gt;getVar('email'));
             break;
         }
     }
+    endif;
     if (strrpos($user-&gt;getVar('email'),' ') &gt; 0) {
         $stop .= _PROFILE_MA_EMAILNOSPACES.'&lt;br /&gt;';
     }
@@ -37,12 +42,13 @@
         $restriction = '/[\000-\040]/';
         break;
     }
-    if ($user-&gt;getVar('loginname') == &quot;&quot; || preg_match($restriction, $user-&gt;getVar('loginname'))) {
+    if ($user-&gt;getVar('loginname') == &quot;&quot; || (preg_match($restriction, $user-&gt;getVar('loginname')) &amp;&amp;!$is_admin_user) ) {
         $stop .= _PROFILE_MA_INVALIDNICKNAME.&quot;&lt;br /&gt;&quot;;
     }
 //    if ($user-&gt;getVar('name') == &quot;&quot; || preg_match($restriction, $user-&gt;getVar('name'))) {
 //        $stop .= _PROFILE_MA_INVALIDDISPLAYNAME.&quot;&lt;br /&gt;&quot;;
 //    }
+    if(!$is_admin_user):
     if (strlen($user-&gt;getVar('loginname')) &gt; $xoopsModuleConfig['max_uname']) {
         $stop .= sprintf(_PROFILE_MA_NICKNAMETOOLONG, $xoopsModuleConfig['max_uname']).&quot;&lt;br /&gt;&quot;;
     }
@@ -55,8 +61,9 @@
     if (strlen($user-&gt;getVar('uname')) &lt; $xoopsModuleConfig['min_uname']) {
         $stop .= sprintf(_PROFILE_MA_DISPLAYNAMETOOSHORT, $xoopsModuleConfig['min_uname']).&quot;&lt;br /&gt;&quot;;
     }
+    endif;
     foreach ($xoopsModuleConfig['bad_unames'] as $bu) {
-	    if(empty($bu) ||$user-&gt;isAdmin()) continue;
+	    if( empty($bu) || $is_admin_user) continue;
         if (preg_match(&quot;/&quot;.$bu.&quot;/i&quot;, $user-&gt;getVar('loginname'))) {
             $stop .= _PROFILE_MA_NAMERESERVED.&quot;&lt;br /&gt;&quot;;
             break;

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/register.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/register.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/register.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -72,7 +72,9 @@
             $stop .= _PROFILE_MA_UNEEDAGREE.'&lt;br /&gt;';
         }
     }
-    if (!empty($xoopsModuleConfig['minpass']) &amp;&amp; strlen(trim($_POST['pass'])) &lt; $xoopsModuleConfig['minpass']) {
+    if ( strcmp(trim($_POST['pass']), trim($_POST['vpass'])) ) {
+        $stop .= _PROFILE_MA_PASSNOTSAME.&quot;&lt;br /&gt;&quot;;
+    }elseif (!empty($xoopsModuleConfig['minpass']) &amp;&amp; strlen(trim($_POST['pass'])) &lt; $xoopsModuleConfig['minpass']) {
         $stop .= sprintf(_PROFILE_MA_PWDTOOSHORT,$xoopsModuleConfig['minpass']).&quot;&lt;br /&gt;&quot;;
     }
     $stop .= userCheck($newuser);
@@ -137,7 +139,7 @@
 
         $profile_handler =&amp; xoops_gethandler('profile');
         // Get fields
-        $fields =&amp; $profile_handler-&gt;loadFields();
+        $fields = $profile_handler-&gt;loadFields();
         if (count($fields) &gt; 0) {
             foreach (array_keys($fields) as $i) {
                 $fieldname = $fields[$i]-&gt;getVar('field_name');

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/search.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/search.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/search.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -42,7 +42,7 @@
     $fields =&amp; $profile_handler-&gt;loadFields();
     // Get ids of fields that can be searched
     $gperm_handler =&amp; xoops_gethandler('groupperm');
-    $searchable_fields =&amp; $gperm_handler-&gt;getItemIds('profile_search', $groups, $xoopsModule-&gt;getVar('mid'));
+    $searchable_fields = $gperm_handler-&gt;getItemIds('profile_search', $groups, $xoopsModule-&gt;getVar('mid'));
 
     include_once XOOPS_ROOT_PATH.&quot;/class/xoopsformloader.php&quot;;
     $searchform = new XoopsThemeForm(&quot;&quot;, &quot;searchform&quot;, &quot;search.php&quot;, &quot;post&quot;);
@@ -164,7 +164,7 @@
     $fields =&amp; $profile_handler-&gt;loadFields();
     // Get ids of fields that can be searched
     $gperm_handler =&amp; xoops_gethandler('groupperm');
-    $searchable_fields =&amp; $gperm_handler-&gt;getItemIds('profile_search', $groups, $xoopsModule-&gt;getVar('mid'));
+    $searchable_fields = $gperm_handler-&gt;getItemIds('profile_search', $groups, $xoopsModule-&gt;getVar('mid'));
     $searchvars = array();
 
     $criteria = new CriteriaCompo(new Criteria('level', 0, &quot;&gt;&quot;));

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/userinfo.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/userinfo.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/profile/userinfo.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -64,7 +64,9 @@
 
     $member_handler =&amp; xoops_gethandler('member');
     $thisUser =&amp; $member_handler-&gt;getUser($uid);
-    if (!is_object($thisUser) || !$thisUser-&gt;isActive()) {
+    if(!is_object($thisUser) || 
+    	( !$thisUser-&gt;isActive() &amp;&amp; (!is_object($xoopsUser) || !$xoopsUser-&gt;isAdmin()) )
+    ){
         redirect_header(&quot;index.php&quot;,3,_PROFILE_MA_SELECTNG);
         exit();
     }
@@ -82,9 +84,9 @@
 // Dynamic User Profiles
 $thisUsergroups =&amp; $thisUser-&gt;getGroups();
 $groupperm_handler =&amp; xoops_gethandler('groupperm');
-$show_ids =&amp; $groupperm_handler-&gt;getItemIds('profile_show', $thisUsergroups, $xoopsModule-&gt;getVar('mid'));
+$show_ids = $groupperm_handler-&gt;getItemIds('profile_show', $thisUsergroups, $xoopsModule-&gt;getVar('mid'));
 if (!is_object($xoopsUser) || !$xoopsUser-&gt;isAdmin()) {
-    $visible_ids =&amp; $groupperm_handler-&gt;getItemIds('profile_visible', $groups, $xoopsModule-&gt;getVar('mid'));
+    $visible_ids = $groupperm_handler-&gt;getItemIds('profile_visible', $groups, $xoopsModule-&gt;getVar('mid'));
     $fieldids = array_intersect($show_ids, $visible_ids);
 }
 else {
@@ -167,7 +169,7 @@
     $criteria = new CriteriaCompo(new Criteria('hassearch', 1));
     $criteria-&gt;add(new Criteria('isactive', 1));
     $modules =&amp; $module_handler-&gt;getObjects($criteria, true);
-    $mids =&amp; array_keys($modules);
+    $mids = array_keys($modules);
 
     $myts =&amp; MyTextSanitizer::getInstance();
     $allowed_mids = $gperm_handler-&gt;getItemIds('module_read', $groups);

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/banners/banners.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/banners/banners.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/banners/banners.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -125,9 +125,9 @@
     &lt;td align='center'&gt;&quot;._AM_FUNCTION.&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr align='center'&gt;&quot;;
     $result = $xoopsDB-&gt;query(&quot;SELECT cid, name, contact, email FROM &quot;.$xoopsDB-&gt;prefix(&quot;bannerclient&quot;).&quot; ORDER BY cid&quot;);
     while(list($cid, $name, $contact, $email) = $xoopsDB-&gt;fetchRow($result)) {
-        $name = $myts-&gt;makeTboxData4Show($name);
-        $contact = $myts-&gt;makeTboxData4Show($contact);
-        $email = $myts-&gt;makeTboxData4Show($email);
+        $name = htmlspecialchars($name,ENT_QUOTES);
+        $contact = htmlspecialchars($contact,ENT_QUOTES);
+        $email = htmlspecialchars($email,ENT_QUOTES);
         $result2 = $xoopsDB-&gt;query(&quot;SELECT COUNT(*) FROM &quot;.$xoopsDB-&gt;prefix(&quot;banner&quot;).&quot; WHERE cid=$cid&quot;);
         list($numrows) = $xoopsDB-&gt;fetchRow($result2);
         echo &quot;
@@ -297,9 +297,9 @@
     &quot;._AM_CLICKURLT.&quot;&lt;input type='text' name='clickurl' size='50' maxlength='200' value='&quot;.htmlspecialchars($clickurl, ENT_QUOTES).&quot;' /&gt;&lt;br /&gt;
     &quot;._AM_USEHTML;
     if ($htmlbanner){
-        echo &quot; &lt;input type='checkbox' name='htmlbanner' value='1' checked='checked'&gt;&quot;;
+        echo &quot; &lt;input type='checkbox' name='htmlbanner' value='1' checked='checked' /&gt;&quot;;
     }else{
-        echo &quot; &lt;input type='checkbox' name='htmlbanner' value='1'&gt;&quot;;
+        echo &quot; &lt;input type='checkbox' name='htmlbanner' value='1' /&gt;&quot;;
     }
     echo &quot;
     &lt;br /&gt;
@@ -347,9 +347,9 @@
             if(strtolower(substr($imageurl,strrpos($imageurl,&quot;.&quot;)))==&quot;.swf&quot;) {
                 $bannerobject = $bannerobject
                         .'&lt;object classid=&quot;clsid:D27CDB6E-AE6D-11cf-96B8-444553540000&quot; codebase=&quot;<A HREF="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0">http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0</A>&quot; width=&quot;468&quot; height=&quot;60&quot;&gt;'
-                        .'&lt;param name=movie value=&quot;'.$imageurl.'&quot;&gt;'
-                        .'&lt;param name=quality value=high&gt;'
-                        .'&lt;embed src=&quot;'.$imageurl.'&quot; quality=high pluginspage=&quot;<A HREF="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash">http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash</A>&quot;; type=&quot;application/x-shockwave-flash&quot; width=&quot;468&quot; height=&quot;60&quot;&gt;'
+                        .'&lt;param name=&quot;movie&quot; value=&quot;'.$imageurl.'&quot;&gt;&lt;/param&gt;'
+                        .'&lt;param name=&quot;quality&quot; value=&quot;high&quot;&gt;&lt;/param&gt;'
+                        .'&lt;embed src=&quot;'.$imageurl.'&quot; quality=&quot;high&quot; pluginspage=&quot;<A HREF="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash">http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash</A>&quot; type=&quot;application/x-shockwave-flash&quot; width=&quot;468&quot; height=&quot;60&quot;&gt;'
                         .'&lt;/embed&gt;'
                         .'&lt;/object&gt;';
             } else {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/groups/groups.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/groups/groups.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/groups/groups.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -93,11 +93,11 @@
     $name_value = $thisgroup-&gt;getVar(&quot;name&quot;, &quot;E&quot;);
     $desc_value = $thisgroup-&gt;getVar(&quot;description&quot;, &quot;E&quot;);
     $moduleperm_handler =&amp; xoops_gethandler('groupperm');
-    $a_mod_value =&amp; $moduleperm_handler-&gt;getItemIds('module_admin', $thisgroup-&gt;getVar('groupid'));
-    $r_mod_value =&amp; $moduleperm_handler-&gt;getItemIds('module_read', $thisgroup-&gt;getVar('groupid'));
-    
+    $a_mod_value = $moduleperm_handler-&gt;getItemIds('module_admin', $thisgroup-&gt;getVar('groupid'));
+    $r_mod_value = $moduleperm_handler-&gt;getItemIds('module_read', $thisgroup-&gt;getVar('groupid'));
+
     $gperm_handler =&amp; xoops_gethandler('groupperm');
-    $r_block_value =&amp; $gperm_handler-&gt;getItemIds('block_read', $g_id);
+    $r_block_value = $gperm_handler-&gt;getItemIds('block_read', $g_id);
     $op_value = &quot;update&quot;;
     $submit_value = _AM_UPDATEADG;
     $g_id_value = $thisgroup-&gt;getVar(&quot;groupid&quot;);
@@ -108,7 +108,7 @@
     }
 
     $sysperm_handler =&amp; xoops_gethandler('groupperm');
-    $s_cat_value =&amp; $sysperm_handler-&gt;getItemIds('system_admin', $g_id);
+    $s_cat_value = $sysperm_handler-&gt;getItemIds('system_admin', $g_id);
 
     include XOOPS_ROOT_PATH.&quot;/modules/system/admin/groups/groupform.php&quot;;
     echo &quot;&lt;br /&gt;&lt;h4 style='text-align:left'&gt;&quot;._AM_EDITMEMBER.&quot;&lt;/h4&gt;&quot;;
@@ -121,11 +121,11 @@
         $members =&amp; $member_handler-&gt;getUsersByGroup($g_id, false);
         if (count($members) &gt; 0) {
             $member_criteria = new Criteria('uid', &quot;(&quot;.implode(',', $members).&quot;)&quot;, &quot;IN&quot;);
-            $member_criteria-&gt;setSort('name');
+            $member_criteria-&gt;setSort('uname');
             $mlist = $member_handler-&gt;getUserList($member_criteria);
         }
         $criteria = new Criteria('level', 0, '&gt;');
-        $criteria-&gt;setSort('name');
+        $criteria-&gt;setSort('uname');
         $userslist =&amp; $member_handler-&gt;getUserList($criteria);
         $users =&amp; array_diff($userslist, $mlist);
         echo '&lt;table class=&quot;outer&quot;&gt;
@@ -168,7 +168,7 @@
         $mlist = array();
         if (count($members) &gt; 0) {
             $member_criteria = new Criteria('uid', &quot;(&quot;.implode(',', $members).&quot;)&quot;, &quot;IN&quot;);
-            $member_criteria-&gt;setSort('name');
+            $member_criteria-&gt;setSort('uname');
             $mlist = $member_handler-&gt;getUserList($member_criteria);
         }
         echo '&lt;a href=&quot;'.XOOPS_URL.'/modules/system/admin.php?fct=findusers&amp;group='.$g_id.'&quot;&gt;'._AM_FINDU4GROUP.'&lt;/a&gt;&lt;br /&gt;';

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/mailusers/mailform.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/mailusers/mailform.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/mailusers/mailform.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -1,101 +1,101 @@
-&lt;?php
-// $Id$
-//  ------------------------------------------------------------------------ //
-//                XOOPS - PHP Content Management System                      //
-//                    Copyright (c) 2000 XOOPS.org                           //
-//                       &lt;<A HREF="http://www.xoops.org/">http://www.xoops.org/</A>&gt;                             //
-//  ------------------------------------------------------------------------ //
-//  This program is free software; you can redistribute it and/or modify     //
-//  it under the terms of the GNU General Public License as published by     //
-//  the Free Software Foundation; either version 2 of the License, or        //
-//  (at your option) any later version.                                      //
-//                                                                           //
-//  You may not change or alter any portion of this comment or credits       //
-//  of supporting developers from this source code or any supporting         //
-//  source code which is considered copyrighted (c) material of the          //
-//  original comment or credit authors.                                      //
-//                                                                           //
-//  This program is distributed in the hope that it will be useful,          //
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of           //
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            //
-//  GNU General Public License for more details.                             //
-//                                                                           //
-//  You should have received a copy of the GNU General Public License        //
-//  along with this program; if not, write to the Free Software              //
-//  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA //
-//  ------------------------------------------------------------------------ //
-// Author: Kazumi Ono (AKA onokazu)                                          //
-// URL: <A HREF="http://www.myweb.ne.jp/,">http://www.myweb.ne.jp/,</A> <A HREF="http://www.xoops.org/,">http://www.xoops.org/,</A> <A HREF="http://jp.xoops.org/">http://jp.xoops.org/</A> //
-// Project: The XOOPS Project                                                //
-// ------------------------------------------------------------------------- //
-
-$form = new XoopsThemeForm(_AM_SENDMTOUSERS, &quot;mailusers&quot;, &quot;admin.php?fct=mailusers&quot;, 'post', true);
-
-// from finduser section
-if (!empty($_POST['memberslist_id'])) {
-    $user_count = count($_POST['memberslist_id']);
-    $display_names = &quot;&quot;;
-    for ( $i = 0; $i &lt; $user_count; $i++ ) {
-        $uid_hidden = new XoopsFormHidden(&quot;mail_to_user[]&quot;, $_POST['memberslist_id'][$i]);
-        $form-&gt;addElement($uid_hidden);
-        $display_names .= &quot;&lt;a href='&quot;.XOOPS_URL.&quot;/userinfo.php?uid=&quot;.$_POST['memberslist_id'][$i].&quot;' target='_blank'&gt;&quot;.$_POST['memberslist_uname'][$_POST['memberslist_id'][$i]].&quot;&lt;/a&gt;, &quot;;
-        unset($uid_hidden);
-    }
-    $users_label = new XoopsFormLabel(_AM_SENDTOUSERS2, substr($display_names, 0, -2));
-    $form-&gt;addElement($users_label);
-    $display_criteria = 0;
-}
-if ( !empty($display_criteria) ) {
-    $selected_groups = array();
-    $group_select = new XoopsFormSelectGroup(_AM_GROUPIS.&quot;&lt;br /&gt;&quot;, &quot;mail_to_group&quot;, false, $selected_groups, 5, true);
-    $lastlog_min = new XoopsFormText(_AM_LASTLOGMIN.&quot;&lt;br /&gt;&quot;._AM_TIMEFORMAT.&quot;&lt;br /&gt;&quot;, &quot;mail_lastlog_min&quot;, 20, 10);
-    $lastlog_max = new XoopsFormText(_AM_LASTLOGMAX.&quot;&lt;br /&gt;&quot;._AM_TIMEFORMAT.&quot;&lt;br /&gt;&quot;, &quot;mail_lastlog_max&quot;, 20, 10);
-    $regd_min = new XoopsFormText(_AM_REGDMIN.&quot;&lt;br /&gt;&quot;._AM_TIMEFORMAT.&quot;&lt;br /&gt;&quot;, &quot;mail_regd_min&quot;, 20, 10);
-    $regd_max = new XoopsFormText(_AM_REGDMAX.&quot;&lt;br /&gt;&quot;._AM_TIMEFORMAT.&quot;&lt;br /&gt;&quot;, &quot;mail_regd_max&quot;, 20, 10);
-    $idle_more = new XoopsFormText(_AM_IDLEMORE.&quot;&lt;br /&gt;&quot;, &quot;mail_idle_more&quot;, 10, 5);
-    $idle_less = new XoopsFormText(_AM_IDLELESS.&quot;&lt;br /&gt;&quot;, &quot;mail_idle_less&quot;, 10, 5);
-    $mailok_cbox = new XoopsFormCheckBox('', 'mail_mailok');
-    $mailok_cbox-&gt;addOption(1, _AM_MAILOK);
-    $inactive_cbox = new XoopsFormCheckBox(_AM_INACTIVE.&quot;&lt;br /&gt;&quot;, &quot;mail_inactive&quot;);
-    $inactive_cbox-&gt;addOption(1, _AMIFCHECKD);
-    $inactive_cbox-&gt;setExtra(&quot;onclick='javascript:disableElement(\&quot;mail_lastlog_min\&quot;);disableElement(\&quot;mail_lastlog_max\&quot;);disableElement(\&quot;mail_idle_more\&quot;);disableElement(\&quot;mail_idle_less\&quot;);disableElement(\&quot;mail_to_group[]\&quot;);'&quot;);
-    $criteria_tray = new XoopsFormElementTray(_AM_SENDTOUSERS, &quot;&lt;br /&gt;&lt;br /&gt;&quot;);
-    $criteria_tray-&gt;addElement($group_select);
-    $criteria_tray-&gt;addElement($lastlog_min);
-    $criteria_tray-&gt;addElement($lastlog_max);
-    $criteria_tray-&gt;addElement($idle_more);
-    $criteria_tray-&gt;addElement($idle_less);
-    $criteria_tray-&gt;addElement($mailok_cbox);
-    $criteria_tray-&gt;addElement($inactive_cbox);
-    $criteria_tray-&gt;addElement($regd_min);
-    $criteria_tray-&gt;addElement($regd_max);
-    $form-&gt;addElement($criteria_tray);
-}
-
-$fname_text = new XoopsFormText(_AM_MAILFNAME, &quot;mail_fromname&quot;, 30, 255, $xoopsConfig['sitename']);
-$fromemail = !empty($xoopsConfig['adminmail']) ? $xoopsConfig['adminmail'] : $xoopsUser-&gt;getVar(&quot;email&quot;, &quot;E&quot;);
-$femail_text = new XoopsFormText(_AM_MAILFMAIL, &quot;mail_fromemail&quot;, 30, 255, $fromemail);
-//$subject_caption = _AM_MAILSUBJECT.&quot;&lt;br /&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:bold;'&gt;&quot;._AM_MAILTAGS.&quot;&lt;/span&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:normal;'&gt;&quot;._AM_MAILTAGS1.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS2.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS3.&quot;&lt;/span&gt;&quot;;
-$subject_caption = _AM_MAILSUBJECT.&quot;&lt;br /&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:bold;'&gt;&quot;._AM_MAILTAGS.&quot;&lt;/span&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:normal;'&gt;&quot;._AM_MAILTAGS2.&quot;&lt;/span&gt;&quot;;
-$subject_text = new XoopsFormText($subject_caption, &quot;mail_subject&quot;, 50, 255);
-$body_caption = _AM_MAILBODY.&quot;&lt;br /&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:bold;'&gt;&quot;._AM_MAILTAGS.&quot;&lt;/span&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:normal;'&gt;&quot;._AM_MAILTAGS1.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS2.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS3.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS4.&quot;&lt;/span&gt;&quot;;
-$body_text = new XoopsFormTextArea($body_caption, &quot;mail_body&quot;, &quot;&quot;, 10);
-$to_checkbox = new XoopsFormCheckBox(_AM_SENDTO, &quot;mail_send_to&quot;, &quot;mail&quot;);
-$to_checkbox-&gt;addOption(&quot;mail&quot;, _AM_EMAIL);
-$to_checkbox-&gt;addOption(&quot;pm&quot;, _AM_PM);
-$start_hidden = new XoopsFormHidden(&quot;mail_start&quot;, 0);
-$op_hidden = new XoopsFormHidden(&quot;op&quot;, &quot;send&quot;);
-$submit_button = new XoopsFormButton(&quot;&quot;, &quot;mail_submit&quot;, _SEND, &quot;submit&quot;);
-
-$form-&gt;addElement($fname_text);
-$form-&gt;addElement($femail_text);
-$form-&gt;addElement($subject_text);
-$form-&gt;addElement($body_text);
-$form-&gt;addElement($to_checkbox);
-$form-&gt;addElement($op_hidden);
-$form-&gt;addElement($start_hidden);
-$form-&gt;addElement($submit_button);
-$form-&gt;setRequired($subject_text);
-$form-&gt;setRequired($body_text);
-//$form-&gt;setRequired($to_checkbox);
+&lt;?php
+// $Id$
+//  ------------------------------------------------------------------------ //
+//                XOOPS - PHP Content Management System                      //
+//                    Copyright (c) 2000 XOOPS.org                           //
+//                       &lt;<A HREF="http://www.xoops.org/">http://www.xoops.org/</A>&gt;                             //
+//  ------------------------------------------------------------------------ //
+//  This program is free software; you can redistribute it and/or modify     //
+//  it under the terms of the GNU General Public License as published by     //
+//  the Free Software Foundation; either version 2 of the License, or        //
+//  (at your option) any later version.                                      //
+//                                                                           //
+//  You may not change or alter any portion of this comment or credits       //
+//  of supporting developers from this source code or any supporting         //
+//  source code which is considered copyrighted (c) material of the          //
+//  original comment or credit authors.                                      //
+//                                                                           //
+//  This program is distributed in the hope that it will be useful,          //
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of           //
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            //
+//  GNU General Public License for more details.                             //
+//                                                                           //
+//  You should have received a copy of the GNU General Public License        //
+//  along with this program; if not, write to the Free Software              //
+//  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA //
+//  ------------------------------------------------------------------------ //
+// Author: Kazumi Ono (AKA onokazu)                                          //
+// URL: <A HREF="http://www.myweb.ne.jp/,">http://www.myweb.ne.jp/,</A> <A HREF="http://www.xoops.org/,">http://www.xoops.org/,</A> <A HREF="http://jp.xoops.org/">http://jp.xoops.org/</A> //
+// Project: The XOOPS Project                                                //
+// ------------------------------------------------------------------------- //
+
+$form = new XoopsThemeForm(_AM_SENDMTOUSERS, &quot;mailusers&quot;, &quot;admin.php?fct=mailusers&quot;, 'post', true);
+
+// from finduser section
+if (!empty($_POST['memberslist_id'])) {
+    $user_count = count($_POST['memberslist_id']);
+    $display_names = &quot;&quot;;
+    for ( $i = 0; $i &lt; $user_count; $i++ ) {
+        $uid_hidden = new XoopsFormHidden(&quot;mail_to_user[]&quot;, $_POST['memberslist_id'][$i]);
+        $form-&gt;addElement($uid_hidden);
+        $display_names .= &quot;&lt;a href='&quot;.XOOPS_URL.&quot;/userinfo.php?uid=&quot;.$_POST['memberslist_id'][$i].&quot;' target='_blank'&gt;&quot;.$_POST['memberslist_uname'][$_POST['memberslist_id'][$i]].&quot;&lt;/a&gt;, &quot;;
+        unset($uid_hidden);
+    }
+    $users_label = new XoopsFormLabel(_AM_SENDTOUSERS2, substr($display_names, 0, -2));
+    $form-&gt;addElement($users_label);
+    $display_criteria = 0;
+}
+if ( !empty($display_criteria) ) {
+    $selected_groups = array();
+    $group_select = new XoopsFormSelectGroup(_AM_GROUPIS.&quot;&lt;br /&gt;&quot;, &quot;mail_to_group&quot;, false, $selected_groups, 5, true);
+    $lastlog_min = new XoopsFormText(_AM_LASTLOGMIN.&quot;&lt;br /&gt;&quot;._AM_TIMEFORMAT.&quot;&lt;br /&gt;&quot;, &quot;mail_lastlog_min&quot;, 20, 10);
+    $lastlog_max = new XoopsFormText(_AM_LASTLOGMAX.&quot;&lt;br /&gt;&quot;._AM_TIMEFORMAT.&quot;&lt;br /&gt;&quot;, &quot;mail_lastlog_max&quot;, 20, 10);
+    $regd_min = new XoopsFormText(_AM_REGDMIN.&quot;&lt;br /&gt;&quot;._AM_TIMEFORMAT.&quot;&lt;br /&gt;&quot;, &quot;mail_regd_min&quot;, 20, 10);
+    $regd_max = new XoopsFormText(_AM_REGDMAX.&quot;&lt;br /&gt;&quot;._AM_TIMEFORMAT.&quot;&lt;br /&gt;&quot;, &quot;mail_regd_max&quot;, 20, 10);
+    $idle_more = new XoopsFormText(_AM_IDLEMORE.&quot;&lt;br /&gt;&quot;, &quot;mail_idle_more&quot;, 10, 5);
+    $idle_less = new XoopsFormText(_AM_IDLELESS.&quot;&lt;br /&gt;&quot;, &quot;mail_idle_less&quot;, 10, 5);
+    $mailok_cbox = new XoopsFormCheckBox('', 'mail_mailok');
+    $mailok_cbox-&gt;addOption(1, _AM_MAILOK);
+    $inactive_cbox = new XoopsFormCheckBox(_AM_INACTIVE.&quot;&lt;br /&gt;&quot;, &quot;mail_inactive&quot;);
+    $inactive_cbox-&gt;addOption(1, _AMIFCHECKD);
+    $inactive_cbox-&gt;setExtra(&quot;onclick='javascript:disableElement(\&quot;mail_lastlog_min\&quot;);disableElement(\&quot;mail_lastlog_max\&quot;);disableElement(\&quot;mail_idle_more\&quot;);disableElement(\&quot;mail_idle_less\&quot;);disableElement(\&quot;mail_to_group[]\&quot;);'&quot;);
+    $criteria_tray = new XoopsFormElementTray(_AM_SENDTOUSERS, &quot;&lt;br /&gt;&lt;br /&gt;&quot;);
+    $criteria_tray-&gt;addElement($group_select);
+    $criteria_tray-&gt;addElement($lastlog_min);
+    $criteria_tray-&gt;addElement($lastlog_max);
+    $criteria_tray-&gt;addElement($idle_more);
+    $criteria_tray-&gt;addElement($idle_less);
+    $criteria_tray-&gt;addElement($mailok_cbox);
+    $criteria_tray-&gt;addElement($inactive_cbox);
+    $criteria_tray-&gt;addElement($regd_min);
+    $criteria_tray-&gt;addElement($regd_max);
+    $form-&gt;addElement($criteria_tray);
+}
+
+$fname_text = new XoopsFormText(_AM_MAILFNAME, &quot;mail_fromname&quot;, 30, 255, htmlspecialchars($xoopsConfig['sitename'], ENT_QUOTES));
+$fromemail = !empty($xoopsConfig['adminmail']) ? $xoopsConfig['adminmail'] : $xoopsUser-&gt;getVar(&quot;email&quot;, &quot;E&quot;);
+$femail_text = new XoopsFormText(_AM_MAILFMAIL, &quot;mail_fromemail&quot;, 30, 255, $fromemail);
+//$subject_caption = _AM_MAILSUBJECT.&quot;&lt;br /&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:bold;'&gt;&quot;._AM_MAILTAGS.&quot;&lt;/span&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:normal;'&gt;&quot;._AM_MAILTAGS1.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS2.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS3.&quot;&lt;/span&gt;&quot;;
+$subject_caption = _AM_MAILSUBJECT.&quot;&lt;br /&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:bold;'&gt;&quot;._AM_MAILTAGS.&quot;&lt;/span&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:normal;'&gt;&quot;._AM_MAILTAGS2.&quot;&lt;/span&gt;&quot;;
+$subject_text = new XoopsFormText($subject_caption, &quot;mail_subject&quot;, 50, 255);
+$body_caption = _AM_MAILBODY.&quot;&lt;br /&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:bold;'&gt;&quot;._AM_MAILTAGS.&quot;&lt;/span&gt;&lt;br /&gt;&lt;span style='font-size:x-small;font-weight:normal;'&gt;&quot;._AM_MAILTAGS1.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS2.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS3.&quot;&lt;br /&gt;&quot;._AM_MAILTAGS4.&quot;&lt;/span&gt;&quot;;
+$body_text = new XoopsFormTextArea($body_caption, &quot;mail_body&quot;, &quot;&quot;, 10);
+$to_checkbox = new XoopsFormCheckBox(_AM_SENDTO, &quot;mail_send_to&quot;, &quot;mail&quot;);
+$to_checkbox-&gt;addOption(&quot;mail&quot;, _AM_EMAIL);
+$to_checkbox-&gt;addOption(&quot;pm&quot;, _AM_PM);
+$start_hidden = new XoopsFormHidden(&quot;mail_start&quot;, 0);
+$op_hidden = new XoopsFormHidden(&quot;op&quot;, &quot;send&quot;);
+$submit_button = new XoopsFormButton(&quot;&quot;, &quot;mail_submit&quot;, _SEND, &quot;submit&quot;);
+
+$form-&gt;addElement($fname_text);
+$form-&gt;addElement($femail_text);
+$form-&gt;addElement($subject_text);
+$form-&gt;addElement($body_text);
+$form-&gt;addElement($to_checkbox);
+$form-&gt;addElement($op_hidden);
+$form-&gt;addElement($start_hidden);
+$form-&gt;addElement($submit_button);
+$form-&gt;setRequired($subject_text);
+$form-&gt;setRequired($body_text);
+//$form-&gt;setRequired($to_checkbox);
 ?&gt;
\ No newline at end of file

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/mailusers/mailusers.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/mailusers/mailusers.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/mailusers/mailusers.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -180,6 +180,9 @@
                         $form-&gt;addElement($group_hidden);
                     }
                 }
+                if (!empty($_POST['mail_mailok'])) {
+                    $mailok_hidden = new XoopsFormHidden(&quot;mail_mailok&quot;, 1);
+                }
                 $inactive_hidden = new XoopsFormHidden(&quot;mail_inactive&quot;, $mail_inactive);
                 $lastlog_min_hidden = new XoopsFormHidden(&quot;mail_lastlog_min&quot;, $myts-&gt;makeTboxData4PreviewInForm($_POST['mail_lastlog_min']));
                 $lastlog_max_hidden = new XoopsFormHidden(&quot;mail_lastlog_max&quot;, $myts-&gt;makeTboxData4PreviewInForm($_POST['mail_lastlog_max']));
@@ -197,6 +200,7 @@
                 $submit_button = new XoopsFormButton(&quot;&quot;, &quot;mail_submit&quot;, _AM_SENDNEXT, &quot;submit&quot;);
                 $sent_label = new XoopsFormLabel(_AM_SENT, sprintf(_AM_SENTNUM, $_POST['mail_start']+1, $mail_end, $added_count));
                 $form-&gt;addElement($sent_label);
+                $form-&gt;addElement($mailok_hidden);
                 $form-&gt;addElement($inactive_hidden);
                 $form-&gt;addElement($lastlog_min_hidden);
                 $form-&gt;addElement($lastlog_max_hidden);

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/preferences/main.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/preferences/main.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/preferences/main.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -36,7 +36,7 @@
 
     if ($op == 'list') {
         $gperm_handler =&amp; xoops_gethandler('groupperm');
-        $admin_mids =&amp; $gperm_handler-&gt;getItemIds('module_admin', $xoopsUser-&gt;getGroups());
+        $admin_mids = $gperm_handler-&gt;getItemIds('module_admin', $xoopsUser-&gt;getGroups());
         if ($gperm_handler-&gt;checkRight('system_admin', XOOPS_SYSTEM_PREF, $xoopsUser-&gt;getGroups())) {
             array_push($admin_mids, 1);
         }
@@ -50,7 +50,7 @@
         }
 
         $module_handler =&amp; xoops_gethandler('module');
-        $modules =&amp; $module_handler-&gt;getList(new Criteria('mid', &quot;(&quot;.implode(',', array_keys($modcats)).&quot;)&quot;, 'IN'));
+        $modules = $module_handler-&gt;getList(new Criteria('mid', &quot;(&quot;.implode(',', array_keys($modcats)).&quot;)&quot;, 'IN'));
 
         foreach (array_keys($modules) as $modid) {
             $modcats[$modid]['module'] = $modules[$modid];
@@ -131,7 +131,7 @@
                 break;
                 case 'select':
                 $ele = new XoopsFormSelect($title, $config[$i]-&gt;getVar('conf_name'), $config[$i]-&gt;getConfValueForOutput());
-                $options =&amp; $config_handler-&gt;getConfigOptions(new Criteria('conf_id', $config[$i]-&gt;getVar('conf_id')));
+                $options = $config_handler-&gt;getConfigOptions(new Criteria('conf_id', $config[$i]-&gt;getVar('conf_id')));
                 $opcount = count($options);
                 for ($j = 0; $j &lt; $opcount; $j++) {
                     $optval = defined($options[$j]-&gt;getVar('confop_value')) ? constant($options[$j]-&gt;getVar('confop_value')) : $options[$j]-&gt;getVar('confop_value');
@@ -237,7 +237,7 @@
                 $module_handler =&amp; xoops_gethandler('module');
                 $criteria = new CriteriaCompo(new Criteria('hasmain', 1));
                 $criteria-&gt;add(new Criteria('isactive', 1));
-                $moduleslist =&amp; $module_handler-&gt;getList($criteria, true);
+                $moduleslist = $module_handler-&gt;getList($criteria, true);
                 $moduleslist['--'] = _MD_AM_NONE;
                 $ele-&gt;addOptionArray($moduleslist);
                 break;
@@ -368,8 +368,22 @@
                         $startmod_updated = true;
                     }
 
+                    if (empty($censor_words_updated) &amp;&amp; $config-&gt;getVar('conf_catid') == XOOPS_CONF_CENSOR &amp;&amp; $config-&gt;getVar('conf_name') == 'censor_words') {
+        				$ts =&amp; MyTextSanitizer::getInstance();
+						if (!isset($ts-&gt;censorConf)) {
+							$ts-&gt;censorConf =&amp; $config_handler-&gt;getConfigsByCat(XOOPS_CONF_CENSOR);
+						}
+	                    $censor_enable_original = $ts-&gt;censorConf['censor_enable'];
+	                    $ts-&gt;censorConf['censor_enable'] = 0;
+	                    $censor_words_updated = true;
+	                    $censor_enable_set = true;
+                    }
                     $config-&gt;setConfValueForInput($new_value);
                     $config_handler-&gt;insertConfig($config);
+                    if(!empty($censor_enable_set)){
+	                    $ts-&gt;censorConf['censor_enable'] == $censor_enable_original;
+	                    $censor_enable_set = false;
+                    }
                 }
                 unset($new_value);
             }

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/smilies/smilies.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/smilies/smilies.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/smilies/smilies.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -1,123 +1,122 @@
-&lt;?php
-// $Id$
-//  ------------------------------------------------------------------------ //
-//                XOOPS - PHP Content Management System                      //
-//                    Copyright (c) 2000 XOOPS.org                           //
-//                       &lt;<A HREF="http://www.xoops.org/">http://www.xoops.org/</A>&gt;                             //
-//  ------------------------------------------------------------------------ //
-//  This program is free software; you can redistribute it and/or modify     //
-//  it under the terms of the GNU General Public License as published by     //
-//  the Free Software Foundation; either version 2 of the License, or        //
-//  (at your option) any later version.                                      //
-//                                                                           //
-//  You may not change or alter any portion of this comment or credits       //
-//  of supporting developers from this source code or any supporting         //
-//  source code which is considered copyrighted (c) material of the          //
-//  original comment or credit authors.                                      //
-//                                                                           //
-//  This program is distributed in the hope that it will be useful,          //
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of           //
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            //
-//  GNU General Public License for more details.                             //
-//                                                                           //
-//  You should have received a copy of the GNU General Public License        //
-//  along with this program; if not, write to the Free Software              //
-//  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA //
-//  ------------------------------------------------------------------------ //
-// Author: Kazumi Ono (AKA onokazu)                                          //
-// URL: <A HREF="http://www.myweb.ne.jp/,">http://www.myweb.ne.jp/,</A> <A HREF="http://www.xoops.org/,">http://www.xoops.org/,</A> <A HREF="http://jp.xoops.org/">http://jp.xoops.org/</A> //
-// Project: The XOOPS Project                                                //
-// ------------------------------------------------------------------------- //
-
-if ( !is_object($xoopsUser) || !is_object($xoopsModule) || !$xoopsUser-&gt;isAdmin($xoopsModule-&gt;mid()) ) {
-    exit(&quot;Access Denied&quot;);
-}
-
-function SmilesAdmin()
-{
-    $db =&amp; Database::getInstance();
-    $url_smiles = XOOPS_UPLOAD_URL;
-    $myts =&amp; MyTextSanitizer::getInstance();
-    xoops_cp_header();
-    echo &quot;&lt;h4 style='text-align:left;'&gt;&quot;._AM_SMILESCONTROL.&quot;&lt;/h4&gt;&quot;;
-
-    if ($getsmiles = $db-&gt;query(&quot;SELECT * FROM &quot;.$db-&gt;prefix(&quot;smiles&quot;))) {
-        if (($numsmiles = $db-&gt;getRowsNum($getsmiles)) == &quot;0&quot;) {
-            //EMPTY
-        } else {
-            echo '&lt;form action=&quot;admin.php&quot; method=&quot;post&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;outer&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot;&gt;';
-            echo &quot;&lt;tr align='center'&gt;&lt;th align='left'&gt;&quot; ._AM_CODE.&quot;&lt;/th&gt;&quot;;
-            echo &quot;&lt;th&gt;&quot; ._AM_SMILIE.&quot;&lt;/th&gt;&quot;;
-            echo &quot;&lt;th&gt;&quot;._AM_SMILEEMOTION.&quot;&lt;/th&gt;&quot;;
-            echo &quot;&lt;th&gt;&quot; ._AM_DISPLAYF.&quot;&lt;/th&gt;&quot;;
-            echo &quot;&lt;th&gt;&quot;._AM_ACTION.&quot;&lt;/th&gt;&quot;;
-            echo &quot;&lt;/tr&gt;\n&quot;;
-            $i = 0;
-            while ($smiles = $db-&gt;fetchArray($getsmiles)) {
-                if ($i % 2 == 0) {
-                    $class = 'even';
-                } else {
-                    $class= 'odd';
-                }
-                $smiles['code'] = $myts-&gt;makeTboxData4Show($smiles['code']);
-                $smiles['smile_url'] = $myts-&gt;makeTboxData4Edit($smiles['smile_url']);
-                $smiles['smile_emotion'] = $myts-&gt;makeTboxData4Edit($smiles['emotion']);
-                echo &quot;&lt;tr align='center' class='$class'&gt;&quot;;
-                echo &quot;&lt;td align='left'&gt;&quot;.$smiles['code'].&quot;&lt;/td&gt;&quot;;
-                echo &quot;&lt;td&gt;&lt;img src='&quot;.$url_smiles.&quot;/&quot;.$smiles['smile_url'].&quot;' alt='' /&gt;&lt;/td&gt;&quot;;
-                echo '&lt;td&gt;'.$smiles['smile_emotion'].'&lt;/td&gt;';
-                echo '&lt;td&gt;&lt;input type=&quot;hidden&quot; name=&quot;smile_id['.$i.']&quot; value=&quot;'.$smiles['id'].'&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;old_display['.$i.']&quot; value=&quot;'.$smiles['display'].'&quot; /&gt;&lt;input type=&quot;checkbox&quot; value=&quot;1&quot; name=&quot;smile_display['.$i.']&quot;';
-                if ($smiles['display'] == 1) {
-                    echo ' checked=&quot;checked&quot;';
-                }
-                echo &quot;&lt;/td&gt;&lt;td&gt;&lt;a href='admin.php?fct=smilies&amp;op=SmilesEdit&amp;id=&quot;.$smiles['id'].&quot;'&gt;&quot; ._AM_EDIT.&quot;&lt;/a&gt;&nbsp;&quot;;
-                echo &quot;&lt;a href='admin.php?fct=smilies&amp;op=SmilesDel&amp;id=&quot;.$smiles['id'].&quot;'&gt;&quot; ._AM_DEL.&quot;&lt;/a&gt;&lt;/td&gt;&quot;;
-                echo &quot;&lt;/tr&gt;\n&quot;;
-                $i++;
-            }
-            echo '&lt;tr&gt;&lt;td class=&quot;foot&quot; colspan=&quot;5&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;op&quot; value=&quot;SmilesUpdate&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;fct&quot; value=&quot;smilies&quot; /&gt;'.$GLOBALS['xoopsSecurity']-&gt;getTokenHTML().'&lt;input type=&quot;submit&quot; value=&quot;'._SUBMIT.'&quot; /&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/form&gt;';
-        }
-    } else {
-        echo _AM_CNRFTSD;
-    }
-    $smiles['smile_code'] = '';
-    $smiles['smile_url'] = 'blank.gif';
-    $smiles['smile_desc'] = '';
-    $smiles['smile_display'] = 1;
-    $smiles['smile_form'] = _AM_ADDSMILE;
-    $smiles['op'] = 'SmilesAdd';
-    $smiles['id'] = '';
-    include XOOPS_ROOT_PATH.'/modules/system/admin/smilies/smileform.php';
-    $smile_form-&gt;display();
-    xoops_cp_footer();
-}
-
-function SmilesEdit($id)
-{
-    $db =&amp; Database::getInstance();
-    $myts =&amp; MyTextSanitizer::getInstance();
-    xoops_cp_header();
-    echo '&lt;a href=&quot;admin.php?fct=smilies&quot;&gt;'._AM_SMILESCONTROL .'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;'._AM_EDITSMILE.'&lt;br /&gt;&lt;br /&gt;';
-    if ($getsmiles = $db-&gt;query(&quot;SELECT * FROM &quot;.$db-&gt;prefix(&quot;smiles&quot;).&quot; WHERE id = $id&quot;)) {
-        $numsmiles = $db-&gt;getRowsNum($getsmiles);
-        if ( $numsmiles == 0 ) {
-            //EMPTY
-        } else {
-            if ($smiles = $db-&gt;fetchArray($getsmiles)) {
-                $smiles['smile_code'] = $myts-&gt;makeTboxData4Edit($smiles['code']);
-                $smiles['smile_url'] = $myts-&gt;makeTboxData4Edit($smiles['smile_url']);
-                $smiles['smile_desc'] = $myts-&gt;makeTboxData4Edit($smiles['emotion']);
-                $smiles['smile_display'] = $smiles['display'];
-                $smiles['smile_form'] = _AM_EDITSMILE;
-                $smiles['op'] = 'SmilesSave';
-                include XOOPS_ROOT_PATH.'/modules/system/admin/smilies/smileform.php';
-                $smile_form-&gt;addElement(new XoopsFormHidden('old_smile', $smiles['smile_url']));
-                $smile_form-&gt;display();
-            }
-        }
-    } else {
-        echo _AM_CNRFTSD;
-    }
-    xoops_cp_footer();
-}
+&lt;?php
+// $Id$
+//  ------------------------------------------------------------------------ //
+//                XOOPS - PHP Content Management System                      //
+//                    Copyright (c) 2000 XOOPS.org                           //
+//                       &lt;<A HREF="http://www.xoops.org/">http://www.xoops.org/</A>&gt;                             //
+//  ------------------------------------------------------------------------ //
+//  This program is free software; you can redistribute it and/or modify     //
+//  it under the terms of the GNU General Public License as published by     //
+//  the Free Software Foundation; either version 2 of the License, or        //
+//  (at your option) any later version.                                      //
+//                                                                           //
+//  You may not change or alter any portion of this comment or credits       //
+//  of supporting developers from this source code or any supporting         //
+//  source code which is considered copyrighted (c) material of the          //
+//  original comment or credit authors.                                      //
+//                                                                           //
+//  This program is distributed in the hope that it will be useful,          //
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of           //
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            //
+//  GNU General Public License for more details.                             //
+//                                                                           //
+//  You should have received a copy of the GNU General Public License        //
+//  along with this program; if not, write to the Free Software              //
+//  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA //
+//  ------------------------------------------------------------------------ //
+// Author: Kazumi Ono (AKA onokazu)                                          //
+// URL: <A HREF="http://www.myweb.ne.jp/,">http://www.myweb.ne.jp/,</A> <A HREF="http://www.xoops.org/,">http://www.xoops.org/,</A> <A HREF="http://jp.xoops.org/">http://jp.xoops.org/</A> //
+// Project: The XOOPS Project                                                //
+// ------------------------------------------------------------------------- //
+
+if ( !is_object($xoopsUser) || !is_object($xoopsModule) || !$xoopsUser-&gt;isAdmin($xoopsModule-&gt;mid()) ) {
+    exit(&quot;Access Denied&quot;);
+}
+function SmilesAdmin()
+{
+    $db =&amp; Database::getInstance();
+    $url_smiles = XOOPS_UPLOAD_URL;
+    $myts =&amp; MyTextSanitizer::getInstance();
+    xoops_cp_header();
+    echo &quot;&lt;h4 style='text-align:left;'&gt;&quot;._AM_SMILESCONTROL.&quot;&lt;/h4&gt;&quot;;
+
+    if ($getsmiles = $db-&gt;query(&quot;SELECT * FROM &quot;.$db-&gt;prefix(&quot;smiles&quot;))) {
+        if (($numsmiles = $db-&gt;getRowsNum($getsmiles)) == &quot;0&quot;) {
+            //EMPTY
+        } else {
+            echo '&lt;form action=&quot;admin.php&quot; method=&quot;post&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;outer&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot;&gt;';
+            echo &quot;&lt;tr align='center'&gt;&lt;th align='left'&gt;&quot; ._AM_CODE.&quot;&lt;/th&gt;&quot;;
+            echo &quot;&lt;th&gt;&quot; ._AM_SMILIE.&quot;&lt;/th&gt;&quot;;
+            echo &quot;&lt;th&gt;&quot;._AM_SMILEEMOTION.&quot;&lt;/th&gt;&quot;;
+            echo &quot;&lt;th&gt;&quot; ._AM_DISPLAYF.&quot;&lt;/th&gt;&quot;;
+            echo &quot;&lt;th&gt;&quot;._AM_ACTION.&quot;&lt;/th&gt;&quot;;
+            echo &quot;&lt;/tr&gt;\n&quot;;
+            $i = 0;
+            while ($smiles = $db-&gt;fetchArray($getsmiles)) {
+                if ($i % 2 == 0) {
+                    $class = 'even';
+                } else {
+                    $class= 'odd';
+                }
+                $smiles['code'] = $myts-&gt;makeTboxData4Show($smiles['code']);
+                $smiles['smile_url'] = $myts-&gt;makeTboxData4Edit($smiles['smile_url']);
+                $smiles['smile_emotion'] = $myts-&gt;makeTboxData4Edit($smiles['emotion']);
+                echo &quot;&lt;tr align='center' class='$class'&gt;&quot;;
+                echo &quot;&lt;td align='left'&gt;&quot;.$smiles['code'].&quot;&lt;/td&gt;&quot;;
+                echo &quot;&lt;td&gt;&lt;img src='&quot;.$url_smiles.&quot;/&quot;.$smiles['smile_url'].&quot;' alt='' /&gt;&lt;/td&gt;&quot;;
+                echo '&lt;td&gt;'.$smiles['smile_emotion'].'&lt;/td&gt;';
+                echo '&lt;td&gt;&lt;input type=&quot;hidden&quot; name=&quot;smile_id['.$i.']&quot; value=&quot;'.$smiles['id'].'&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;old_display['.$i.']&quot; value=&quot;'.$smiles['display'].'&quot; /&gt;&lt;input type=&quot;checkbox&quot; value=&quot;1&quot; name=&quot;smile_display['.$i.']&quot;';
+                if ($smiles['display'] == 1) {
+                    echo ' checked=&quot;checked&quot;';
+                }
+                echo &quot; /&gt;&lt;/td&gt;&lt;td&gt;&lt;a href='admin.php?fct=smilies&amp;op=SmilesEdit&amp;id=&quot;.$smiles['id'].&quot;'&gt;&quot; ._AM_EDIT.&quot;&lt;/a&gt;&nbsp;&quot;;
+                echo &quot;&lt;a href='admin.php?fct=smilies&amp;op=SmilesDel&amp;id=&quot;.$smiles['id'].&quot;'&gt;&quot; ._AM_DEL.&quot;&lt;/a&gt;&lt;/td&gt;&quot;;
+                echo &quot;&lt;/tr&gt;\n&quot;;
+                $i++;
+            }
+            echo '&lt;tr&gt;&lt;td class=&quot;foot&quot; colspan=&quot;5&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;op&quot; value=&quot;SmilesUpdate&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;fct&quot; value=&quot;smilies&quot; /&gt;'.$GLOBALS['xoopsSecurity']-&gt;getTokenHTML().'&lt;input type=&quot;submit&quot; value=&quot;'._SUBMIT.'&quot; /&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/form&gt;';
+        }
+    } else {
+        echo _AM_CNRFTSD;
+    }
+    $smiles['smile_code'] = '';
+    $smiles['smile_url'] = 'blank.gif';
+    $smiles['smile_desc'] = '';
+    $smiles['smile_display'] = 1;
+    $smiles['smile_form'] = _AM_ADDSMILE;
+    $smiles['op'] = 'SmilesAdd';
+    $smiles['id'] = '';
+    include XOOPS_ROOT_PATH.'/modules/system/admin/smilies/smileform.php';
+    $smile_form-&gt;display();
+    xoops_cp_footer();
+}
+
+function SmilesEdit($id)
+{
+    $db =&amp; Database::getInstance();
+    $myts =&amp; MyTextSanitizer::getInstance();
+    xoops_cp_header();
+    echo '&lt;a href=&quot;admin.php?fct=smilies&quot;&gt;'._AM_SMILESCONTROL .'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;'._AM_EDITSMILE.'&lt;br /&gt;&lt;br /&gt;';
+    if ($getsmiles = $db-&gt;query(&quot;SELECT * FROM &quot;.$db-&gt;prefix(&quot;smiles&quot;).&quot; WHERE id = $id&quot;)) {
+        $numsmiles = $db-&gt;getRowsNum($getsmiles);
+        if ( $numsmiles == 0 ) {
+            //EMPTY
+        } else {
+            if ($smiles = $db-&gt;fetchArray($getsmiles)) {
+                $smiles['smile_code'] = $myts-&gt;makeTboxData4Edit($smiles['code']);
+                $smiles['smile_url'] = $myts-&gt;makeTboxData4Edit($smiles['smile_url']);
+                $smiles['smile_desc'] = $myts-&gt;makeTboxData4Edit($smiles['emotion']);
+                $smiles['smile_display'] = $smiles['display'];
+                $smiles['smile_form'] = _AM_EDITSMILE;
+                $smiles['op'] = 'SmilesSave';
+                include XOOPS_ROOT_PATH.'/modules/system/admin/smilies/smileform.php';
+                $smile_form-&gt;addElement(new XoopsFormHidden('old_smile', $smiles['smile_url']));
+                $smile_form-&gt;display();
+            }
+        }
+    } else {
+        echo _AM_CNRFTSD;
+    }
+    xoops_cp_footer();
+}
 ?&gt;
\ No newline at end of file

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/tplsets/main.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/tplsets/main.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/tplsets/main.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -197,7 +197,7 @@
             foreach ($notinst_files as $nfile) {
                 if ($nfile != 'index.html') {
                     echo  '&lt;tr&gt;&lt;td style=&quot;background-color:#FFFF99; padding: 5px;&quot;&gt;'.$nfile.'&lt;/td&gt;&lt;td style=&quot;background-color:#FFFF99; padding: 5px;&quot;&gt;&nbsp;&lt;/td&gt;&lt;td style=&quot;background-color:#FFFF99; padding: 5px;&quot;&gt;';
-                    $physical_file = XOOPS_ROOT_PATH.'/templates/'.$tplset.'/'.$moddir.'/'.$nfile;
+                    $physical_file = XOOPS_ROOT_PATH.'/themes/'.$tplset.'/templates/'.$moddir.'/'.$nfile;
                     if (file_exists($physical_file)) {
                         echo '[&lt;a href=&quot;admin.php?fct=tplsets&amp;moddir='.$moddir.'&amp;tplset='.$tplset.'&amp;op=importtpl&amp;file='.urlencode($nfile).'&quot;&gt;'._MD_IMPORT.'&lt;/a&gt;]';
                     } else {
@@ -227,7 +227,7 @@
             }
             echo  '&lt;tr class=&quot;'.$class.'&quot;&gt;&lt;td class=&quot;head&quot;&gt;&lt;span style=&quot;font-weight:bold;&quot;&gt;'.$btemplates[$j]-&gt;getVar('tpl_file').'&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;span style=&quot;font-weight:normal;&quot;&gt;'.$btemplates[$j]-&gt;getVar('tpl_desc').'&lt;/span&gt;&lt;/td&gt;&lt;td&gt;'.formatTimestamp($last_modified, 'l').'&lt;/td&gt;';
             $filename = $btemplates[$j]-&gt;getVar('tpl_file');
-            $physical_file = XOOPS_ROOT_PATH.'/templates/'.$tplset.'/'.$moddir.'/blocks/'.$filename;
+            $physical_file = XOOPS_ROOT_PATH.'/themes/'.$tplset.'/templates/'.$moddir.'/blocks/'.$filename;
             if ($tplset != 'default') {
                 if (file_exists($physical_file)) {
                     $mtime = filemtime($physical_file);
@@ -257,7 +257,7 @@
             foreach ($bnotinst_files as $nfile) {
                 if ($nfile != 'index.html') {
                     echo  '&lt;tr style=&quot;background-color:#FFFF99;&quot;&gt;&lt;td style=&quot;background-color:#FFFF99; padding: 5px;&quot;&gt;'.$nfile.'&lt;/td&gt;&lt;td style=&quot;background-color:#FFFF99; padding: 5px;&quot;&gt;&nbsp;&lt;/td&gt;&lt;td style=&quot;background-color:#FFFF99; padding: 5px;&quot;&gt;';
-                    $physical_file = XOOPS_ROOT_PATH.'/templates/'.$tplset.'/'.$moddir.'/blocks/'.$nfile;
+                    $physical_file = XOOPS_ROOT_PATH.'/themes/'.$tplset.'/templates/'.$moddir.'/blocks/'.$nfile;
                     if (file_exists($physical_file)) {
                         echo '[&lt;a href=&quot;admin.php?fct=tplsets&amp;moddir='.$moddir.'&amp;tplset='.$tplset.'&amp;op=importtpl&amp;file='.urlencode($nfile).'&quot;&gt;'._MD_IMPORT.'&lt;/a&gt;]';
                     } else {
@@ -409,9 +409,9 @@
             if (count($tplsets) &gt; 0 &amp;&amp; is_object($tplsets[0])) {
                 $msgs[] = 'Deleting template set data...';
                 if (!$tplset_handler-&gt;delete($tplsets[0])) {
-                    $msgs[] = '&nbsp;&nbsp;&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Template set '.$tplset.' could not be deleted.&lt;/span&gt;';
+                    $msgs[] = '&nbsp;&nbsp;&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Template set '.htmlspecialchars($tplset, ENT_QUOTES).' could not be deleted.&lt;/span&gt;';
                 } else {
-                    $msgs[] = '&nbsp;&nbsp;Template set data removed from the database.';
+                    $msgs[] = '&nbsp;&nbsp;Template set data &lt;b&gt;'.htmlspecialchars($tplset, ENT_QUOTES).'&lt;/b&gt; removed from the database.';
                 }
             }
         } else {
@@ -457,7 +457,7 @@
             $tplsetobj-&gt;setVar('tplset_name', $newtheme);
             $tplsetobj-&gt;setVar('tplset_created', time());
             if (!$tplset_handler-&gt;insert($tplsetobj)) {
-                $msgs[] = '&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Could not create template set &lt;b&gt;'.$newtheme.'&lt;/b&gt;.&lt;/span&gt;&lt;br /&gt;';
+                $msgs[] = '&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Could not create template set &lt;b&gt;'.htmlspecialchars($newtheme, ENT_QUOTES).'&lt;/b&gt;.&lt;/span&gt;&lt;br /&gt;';
             } else {
                 $tplsetid = $tplsetobj-&gt;getVar('tplset_id');
                 $templates =&amp; $tpltpl_handler-&gt;getObjects(new Criteria('tpl_tplset', $tplset), true);
@@ -503,7 +503,7 @@
         &lt;head&gt;
         &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset='._CHARSET.'&quot; /&gt;
         &lt;meta http-equiv=&quot;content-language&quot; content=&quot;'._LANGCODE.'&quot; /&gt;
-        &lt;title&gt;'.$xoopsConfig['sitename'].' Administration&lt;/title&gt;
+        &lt;title&gt;'.htmlspecialchars($xoopsConfig['sitename']).' Administration&lt;/title&gt;
         &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; media=&quot;all&quot; href=&quot;'.XOOPS_URL.'/xoops.css&quot; /&gt;
             &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; media=&quot;all&quot; href=&quot;'.XOOPS_URL.'/modules/system/style.css&quot; /&gt;
         &lt;/head&gt;&lt;body&gt;';
@@ -560,7 +560,7 @@
         $id = intval($_GET['id']);
         $tpl =&amp; $tpltpl_handler-&gt;get($id);
         xoops_cp_header();
-        echo '&lt;a href=&quot;admin.php?fct=tplsets&quot;&gt;'. _MD_TPLMAIN .'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;&lt;a href=&quot;./admin.php?fct=tplsets&amp;op=listtpl&amp;moddir='.$tpl-&gt;getVar('tpl_module').'&amp;tplset='.$tpl-&gt;getVar('tpl_tplset').'&quot;&gt;'.$tpl-&gt;getVar('tpl_tplset').'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;'._MD_UPLOAD.'&lt;br /&gt;&lt;br /&gt;';
+        echo '&lt;a href=&quot;admin.php?fct=tplsets&quot;&gt;'. _MD_TPLMAIN .'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;&lt;a href=&quot;./admin.php?fct=tplsets&amp;op=listtpl&amp;moddir='.$tpl-&gt;getVar('tpl_module').'&amp;tplset='.urlencode($tpl-&gt;getVar('tpl_tplset')).'&quot;&gt;'.$tpl-&gt;getVar('tpl_tplset').'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;'._MD_UPLOAD.'&lt;br /&gt;&lt;br /&gt;';
         if (is_object($tpl)) {
             include_once XOOPS_ROOT_PATH.'/class/xoopsformloader.php';
             $form = new XoopsThemeForm(_MD_UPLOAD, 'tplupload_form', 'admin.php', 'post', true);
@@ -821,7 +821,7 @@
             flush();
             unset($newtpl);
         }
-        unset($files);
+        unset($tplfiles);
         $tplfiles =&amp; $tpltpl_handler-&gt;find('default', 'block', null, $moddir, null, true);
         $fcount = count($tplfiles);
         if ($fcount &gt; 0) {
@@ -845,7 +845,7 @@
             flush();
             unset($newtpl);
         }
-        echo '&lt;br /&gt;Module template files for template set &lt;b&gt;'.$tplset.'&lt;/b&gt; generated and installed.&lt;br /&gt;&lt;/code&gt;&lt;br /&gt;&lt;a href=&quot;admin.php?fct=tplsets&quot;&gt;'._MD_AM_BTOTADMIN.'&lt;/a&gt;';
+        echo '&lt;br /&gt;Module template files for template set &lt;b&gt;'.htmlspecialchars($tplset, ENT_QUOTES).'&lt;/b&gt; generated and installed.&lt;br /&gt;&lt;/code&gt;&lt;br /&gt;&lt;a href=&quot;admin.php?fct=tplsets&quot;&gt;'._MD_AM_BTOTADMIN.'&lt;/a&gt;';
         xoops_cp_footer();
         break;
     case 'uploadtar_go':
@@ -882,19 +882,21 @@
                 }
                 if ($tplset_name == '') {
                     echo '&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Template file not found&lt;/span&gt;&lt;br /&gt;';
+                } elseif  (preg_match('/['.preg_quote('\/:*?&quot;&lt;&gt;|','/').']/', $tplset_name)) {
+                    echo '&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Invalid Template Set Name&lt;/span&gt;&lt;br /&gt;';
                 } else {
                     $tplset_handler =&amp; xoops_gethandler('tplset');
                     if ($tplset_handler-&gt;getCount(new Criteria('tplset_name', $tplset_name)) &gt; 0) {
-                        echo '&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Template set &lt;b&gt;'.$tplset_name.'&lt;/b&gt; already exists.&lt;/span&gt;&lt;br /&gt;';
+                        echo '&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Template set &lt;b&gt;'.htmlspecialchars($tplset_name, ENT_QUOTES).'&lt;/b&gt; already exists.&lt;/span&gt;&lt;br /&gt;';
                     } else {
                         $tplset =&amp; $tplset_handler-&gt;create();
                         $tplset-&gt;setVar('tplset_name', $tplset_name);
                         $tplset-&gt;setVar('tplset_created', time());
                         if (!$tplset_handler-&gt;insert($tplset)) {
-                            echo '&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Could not create template set &lt;b&gt;'.$tplset_name.'&lt;/b&gt;.&lt;/span&gt;&lt;br /&gt;';
+                            echo '&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Could not create template set &lt;b&gt;'.htmlspecialchars($tplset_name, ENT_QUOTES).'&lt;/b&gt;.&lt;/span&gt;&lt;br /&gt;';
                         } else {
                             $tplsetid = $tplset-&gt;getVar('tplset_id');
-                            echo 'Template set &lt;b&gt;'.$tplset_name.'&lt;/b&gt; created. (ID: &lt;b&gt;'.$tplsetid.'&lt;/b&gt;)&lt;/span&gt;&lt;br /&gt;';
+                            echo 'Template set &lt;b&gt;'.htmlspecialchars($tplset_name, ENT_QUOTES).'&lt;/b&gt; created. (ID: &lt;b&gt;'.$tplsetid.'&lt;/b&gt;)&lt;/span&gt;&lt;br /&gt;';
                             $tpltpl_handler = xoops_gethandler('tplfile');
                             $themeimages = array();
                             foreach ($tar-&gt;files as $id =&gt; $info) {
@@ -934,9 +936,9 @@
                                     echo '&nbsp;&nbsp;&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Could not create image set.&lt;/span&gt;&lt;br /&gt;';
                                 } else {
                                     $newimgsetid = $imgset-&gt;getVar('imgset_id');
-                                    echo '&nbsp;&nbsp;Image set &lt;b&gt;'.$tplset_name.'&lt;/b&gt; created. (ID: &lt;b&gt;'.$newimgsetid.'&lt;/b&gt;)&lt;br /&gt;';
+                                    echo '&nbsp;&nbsp;Image set &lt;b&gt;'.htmlspecialchars($tplset_name, ENT_QUOTES).'&lt;/b&gt; created. (ID: &lt;b&gt;'.$newimgsetid.'&lt;/b&gt;)&lt;br /&gt;';
                                     if (!$imageset_handler-&gt;linktplset($newimgsetid, $tplset_name)) {
-                                        echo '&nbsp;&nbsp;&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Failed linking image set to template set &lt;b&gt;'.$tplset_name.'&lt;/b&gt;&lt;/span&gt;&lt;br /&gt;';
+                                        echo '&nbsp;&nbsp;&lt;span style=&quot;color:#ff0000;&quot;&gt;ERROR: Failed linking image set to template set &lt;b&gt;'.htmlspecialchars($tplset_name, ENT_QUOTES).'&lt;/b&gt;&lt;/span&gt;&lt;br /&gt;';
                                     }
                                     $image_handler =&amp; xoops_gethandler('imagesetimg');
                                     for ($i = 0; $i &lt; $icount; $i++) {
@@ -1000,7 +1002,7 @@
             $tform = array('tpl_tplset' =&gt; $tplset, 'tpl_id' =&gt; $id, 'tpl_file' =&gt; $tplfile-&gt;getVar('tpl_file'), 'tpl_desc' =&gt; $tplfile-&gt;getVar('tpl_desc'), 'tpl_lastmodified' =&gt; $tplfile-&gt;getVar('tpl_lastmodified'), 'tpl_source' =&gt; htmlspecialchars($html, ENT_QUOTES), 'tpl_module' =&gt; $moddir);
             include_once XOOPS_ROOT_PATH.'/modules/system/admin/tplsets/tplform.php';
             xoops_cp_header();
-            echo '&lt;a href=&quot;admin.php?fct=tplsets&quot;&gt;'. _MD_TPLMAIN .'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;&lt;a href=&quot;./admin.php?fct=tplsets&amp;op=listtpl&amp;moddir='.$moddir.'&amp;tplset='.$tplset.'&quot;&gt;'.$tplset.'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;'._MD_EDITTEMPLATE.'&lt;br /&gt;&lt;br /&gt;';
+            echo '&lt;a href=&quot;admin.php?fct=tplsets&quot;&gt;'. _MD_TPLMAIN .'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;&lt;a href=&quot;./admin.php?fct=tplsets&amp;op=listtpl&amp;moddir='.$moddir.'&amp;tplset='.urlencode($tplset).'&quot;&gt;'.htmlspecialchars($tplset, ENT_QUOTES).'&lt;/a&gt;&nbsp;&lt;span style=&quot;font-weight:bold;&quot;&gt;&raquo;&raquo;&lt;/span&gt;&nbsp;'._MD_EDITTEMPLATE.'&lt;br /&gt;&lt;br /&gt;';
             $form-&gt;display();
             xoops_cp_footer();
             echo '&lt;script type=&quot;text/javascript&quot;&gt;
@@ -1083,7 +1085,7 @@
         foreach ($msg as $m) {
             echo $m.'&lt;br /&gt;';
         }
-        echo '&lt;/code&gt;&lt;br /&gt;&lt;a href=&quot;admin.php?fct=tplsets&amp;op=listtpl&amp;tplset='.$tplset.'&amp;moddir='.$moddir.'&quot;&gt;'._MD_AM_BTOTADMIN.'&lt;/a&gt;';
+        echo '&lt;/code&gt;&lt;br /&gt;&lt;a href=&quot;admin.php?fct=tplsets&amp;op=listtpl&amp;tplset='.urlencode($tplset).'&amp;moddir='.$moddir.'&quot;&gt;'._MD_AM_BTOTADMIN.'&lt;/a&gt;';
         xoops_cp_footer();
         break;
     case 'importtpl':
@@ -1111,10 +1113,10 @@
         if (is_object($tplfile)) {
             switch ($tplfile-&gt;getVar('tpl_type')) {
                 case 'module':
-                    $filepath = XOOPS_ROOT_PATH.'/templates/'.$tplset.'/'.$tplfile-&gt;getVar('tpl_module').'/'.$tplfile-&gt;getVar('tpl_file');
+                    $filepath = XOOPS_ROOT_PATH.'/themes/'.$tplset.'/templates/'.$tplfile-&gt;getVar('tpl_module').'/'.$tplfile-&gt;getVar('tpl_file');
                     break;
                 case 'block':
-                    $filepath = XOOPS_ROOT_PATH.'/templates/'.$tplset.'/'.$tplfile-&gt;getVar('tpl_module').'/blocks/'.$tplfile-&gt;getVar('tpl_file');
+                    $filepath = XOOPS_ROOT_PATH.'/themes/'.$tplset.'/templates/'.$tplfile-&gt;getVar('tpl_module').'/blocks/'.$tplfile-&gt;getVar('tpl_file');
                     break;
                 default:
                     break;
@@ -1137,7 +1139,7 @@
         if (false != $error) {
             xoops_cp_header();
             xoops_error('Could not import file '.$filepath);
-            echo '&lt;br /&gt;&lt;a href=&quot;admin.php?fct=tplsets&amp;op=listtpl&amp;tplset='.$tplset.'&amp;moddir='.$moddir.'&quot;&gt;'._MD_AM_BTOTADMIN.'&lt;/a&gt;';
+            echo '&lt;br /&gt;&lt;a href=&quot;admin.php?fct=tplsets&amp;op=listtpl&amp;tplset='.urlencode($tplset).'&amp;moddir='.$moddir.'&quot;&gt;'._MD_AM_BTOTADMIN.'&lt;/a&gt;';
             xoops_cp_footer();
             exit();
         }

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/tplsets/themeimgform.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/tplsets/themeimgform.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin/tplsets/themeimgform.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -35,7 +35,7 @@
 	if ($icount &gt; 0) {
 		echo '&lt;form action=&quot;admin.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;outer&quot; cellspacing=&quot;1&quot;&gt;&lt;tr&gt;&lt;th colspan=&quot;3&quot;&gt;'._MD_EDITSKINIMG.'&lt;/th&gt;&lt;/tr&gt;';
 		for ($i = 0; $i &lt; $icount; $i++) {
-			echo '&lt;tr&gt;&lt;td rowspan=&quot;3&quot; valign=&quot;middle&quot; align=&quot;center&quot; class=&quot;odd&quot;&gt;&lt;img src=&quot;admin.php?fct=tplsets&amp;op=showimage&amp;id='.$imgs[$i]-&gt;getVar('imgsetimg_id').'&quot; alt=&quot;&quot; /&gt;&lt;/td&gt;&lt;td class=&quot;head&quot;&gt;'._MD_IMGFILE.'&lt;/td&gt;&lt;td class=&quot;even&quot;&gt;'.$imgs[$i]-&gt;getVar('imgsetimg_file').'&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;head&quot;&gt;'._MD_IMGNEWFILE.'&lt;/td&gt;&lt;td class=&quot;even&quot;&gt;&lt;input type=&quot;file&quot; name=&quot;imgfiles['.$imgs[$i]-&gt;getVar('imgsetimg_id').']&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;head&quot;&gt;'._MD_IMGDELETE.'&lt;/td&gt;&lt;td class=&quot;even&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;imgdelete['.$imgs[$i]-&gt;getVar('imgsetimg_id').']&quot; value=&quot;1&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;imgids[]&quot; value=&quot;'.$imgs[$i]-&gt;getVar('imgsetimg_id').'&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;';
+			echo '&lt;tr&gt;&lt;td rowspan=&quot;3&quot; valign=&quot;middle&quot; align=&quot;center&quot; class=&quot;odd&quot;&gt;&lt;img src=&quot;admin.php?fct=tplsets&amp;op=showimage&amp;id='.$imgs[$i]-&gt;getVar('imgsetimg_id').'&quot; alt=&quot;&quot; /&gt;&lt;/td&gt;&lt;td class=&quot;head&quot;&gt;'._MD_IMGFILE.'&lt;/td&gt;&lt;td class=&quot;even&quot;&gt;'.$imgs[$i]-&gt;getVar('imgsetimg_file').'&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;head&quot;&gt;'._MD_IMGNEWFILE.'&lt;/td&gt;&lt;td class=&quot;even&quot;&gt;&lt;input type=&quot;file&quot; name=&quot;imgfiles['.$imgs[$i]-&gt;getVar('imgsetimg_id').']&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;head&quot;&gt;'._MD_IMGDELETE.'&lt;/td&gt;&lt;td class=&quot;even&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;imgdelete['.$imgs[$i]-&gt;getVar('imgsetimg_id').']&quot; value=&quot;1&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;imgids[]&quot; value=&quot;'.$imgs[$i]-&gt;getVar('imgsetimg_id').'&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;';
 		}
 		echo '&lt;tr class=&quot;foot&quot;&gt;&lt;td colspan=&quot;3&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;tplset&quot; value=&quot;'.$tplset.'&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;op&quot; value=&quot;updateimage&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;fct&quot; value=&quot;tplsets&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;imgset&quot; value=&quot;'.$imgs[0]-&gt;getVar('imgsetimg_imgset').'&quot; /&gt;&lt;input type=&quot;submit&quot; name=&quot;imgsubmit&quot; value=&quot;'._SUBMIT.'&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/form&gt;';
 	}
@@ -49,7 +49,7 @@
 } else {
 	echo '&lt;table width=&quot;100%&quot; class=&quot;outer&quot; cellspacing=&quot;1&quot;&gt;&lt;tr&gt;&lt;th colspan=&quot;3&quot;&gt;'._MD_SKINIMGS.'&lt;/th&gt;&lt;/tr&gt;';
 	for ($i = 0; $i &lt; $icount; $i++) {
-		echo '&lt;tr&gt;&lt;td valign=&quot;middle&quot; align=&quot;center&quot; class=&quot;odd&quot;&gt;&lt;img src=&quot;admin.php?fct=tplsets&amp;op=showimage&amp;id='.$imgs[$i]-&gt;getVar('imgsetimg_id').'&quot; alt=&quot;&quot; /&gt;&lt;/td&gt;&lt;td class=&quot;head&quot;&gt;'._MD_IMGFILE.'&lt;/td&gt;&lt;td class=&quot;even&quot;&gt;'.$imgs[$i]-&gt;getVar('imgsetimg_file').'&lt;/td&gt;&lt;/tr&gt;';
+		echo '&lt;tr&gt;&lt;td valign=&quot;middle&quot; align=&quot;center&quot; class=&quot;odd&quot;&gt;&lt;img src=&quot;admin.php?fct=tplsets&amp;op=showimage&amp;id='.$imgs[$i]-&gt;getVar('imgsetimg_id').'&quot; alt=&quot;&quot; /&gt;&lt;/td&gt;&lt;td class=&quot;head&quot;&gt;'._MD_IMGFILE.'&lt;/td&gt;&lt;td class=&quot;even&quot;&gt;'.$imgs[$i]-&gt;getVar('imgsetimg_file').'&lt;/td&gt;&lt;/tr&gt;';
 	}
 	echo '&lt;/table&gt;';
 }

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/admin.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -93,7 +93,7 @@
 	$all_ok = false;
 	if (!in_array(XOOPS_GROUP_ADMIN, $groups)) {
 		$sysperm_handler =&amp; xoops_gethandler('groupperm');
-		$ok_syscats =&amp; $sysperm_handler-&gt;getItemIds('system_admin', $groups);
+		$ok_syscats = $sysperm_handler-&gt;getItemIds('system_admin', $groups);
 	} else {
 		$all_ok = true;
 	}

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/blocks/system_blocks.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/blocks/system_blocks.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/blocks/system_blocks.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -84,7 +84,7 @@
     } else {
         $online_handler-&gt;write($uid, $uname, time(), 0, $_SERVER['REMOTE_ADDR']);
     }
-    $onlines =&amp; $online_handler-&gt;getAll();
+    $onlines = $online_handler-&gt;getAll();
     if (false != $onlines) {
         $total = count($onlines);
         $block = array();
@@ -117,7 +117,7 @@
 function b_system_login_show()
 {
     global $xoopsUser, $xoopsConfig;
-    if (!$xoopsUser) {
+    if (!is_object($xoopsUser)) {
         $block = array();
         $block['lang_username'] = _USERNAME;
         $block['unamevalue'] = &quot;&quot;;
@@ -151,12 +151,12 @@
     $modules =&amp; $module_handler-&gt;getObjects($criteria, true);
     $moduleperm_handler =&amp; xoops_gethandler('groupperm');
     $groups = is_object($xoopsUser) ? $xoopsUser-&gt;getGroups() : XOOPS_GROUP_ANONYMOUS;
-    $read_allowed =&amp; $moduleperm_handler-&gt;getItemIds('module_read', $groups);
+    $read_allowed = $moduleperm_handler-&gt;getItemIds('module_read', $groups);
     foreach (array_keys($modules) as $i) {
         if (in_array($i, $read_allowed)) {
             $block['modules'][$i]['name'] = $modules[$i]-&gt;getVar('name');
             $block['modules'][$i]['directory'] = $modules[$i]-&gt;getVar('dirname');
-            $sublinks =&amp; $modules[$i]-&gt;subLink();
+            $sublinks = $modules[$i]-&gt;subLink();
             if ((count($sublinks) &gt; 0) &amp;&amp; (!empty($xoopsModule)) &amp;&amp; ($i == $xoopsModule-&gt;getVar('mid'))) {
                 foreach($sublinks as $sublink){
                     $block['modules'][$i]['sublinks'][] = array('name' =&gt; $sublink['name'], 'url' =&gt; XOOPS_URL.'/modules/'.$modules[$i]-&gt;getVar('dirname').'/'.$sublink['url']);
@@ -288,7 +288,7 @@
                     $prev_caption = $userinfo['groupname'];
                     $block['groups'][$i]['name'] = $myts-&gt;htmlSpecialChars($userinfo['groupname']);
                 }
-                if ($xoopsUser != '') {
+                if (!is_object($xoopsUser)) {
                     $block['groups'][$i]['users'][] = array('id' =&gt; $userinfo['uid'], 'name' =&gt; $myts-&gt;htmlspecialchars($userinfo['name']), 'msglink' =&gt; &quot;&lt;a href=\&quot;javascript:openWithSelfMain('&quot;.XOOPS_URL.&quot;/pmlite.php?send2=1&amp;to_userid=&quot;.$userinfo['uid'].&quot;','pmlite',450,370);\&quot;&gt;&lt;img src=\&quot;&quot;.XOOPS_URL.&quot;/images/icons/pm_small.gif\&quot; border=\&quot;0\&quot; width=\&quot;27\&quot; height=\&quot;17\&quot; alt=\&quot;\&quot; /&gt;&lt;/a&gt;&quot;, 'avatar' =&gt; XOOPS_UPLOAD_URL.'/'.$userinfo['user_avatar']);
                 } else {
                     if ($userinfo['user_viewemail']) {
@@ -317,7 +317,7 @@
     $criteria-&gt;setSort('user_regdate');
     $criteria-&gt;setLimit($limit);
     $member_handler =&amp; xoops_gethandler('member');
-    $newmembers =&amp; $member_handler-&gt;getUsers($criteria);
+    $newmembers = $member_handler-&gt;getUsers($criteria);
     $count = count($newmembers);
     for ($i = 0; $i &lt; $count; $i++) {
         if ( $options[1] == 1 ) {
@@ -383,7 +383,7 @@
             $comment_config[$mid] = $modules[$mid]-&gt;getInfo('comments');
         }
         $com['id'] = $i;
-        $com['title'] = '&lt;a href=&quot;'.XOOPS_URL.'/modules/'.$modules[$mid]-&gt;getVar('dirname').'/'.$comment_config[$mid]['pageName'].'?'.$comment_config[$mid]['itemName'].'='.$comments[$i]-&gt;getVar('com_itemid').'&amp;com_id='.$i.'&amp;com_rootid='.$comments[$i]-&gt;getVar('com_rootid').'&amp;'.$comments[$i]-&gt;getVar('com_exparams').'#comment'.$i.'&quot;&gt;'.$comments[$i]-&gt;getVar('com_title').'&lt;/a&gt;';
+        $com['title'] = '&lt;a href=&quot;'.XOOPS_URL.'/modules/'.$modules[$mid]-&gt;getVar('dirname').'/'.$comment_config[$mid]['pageName'].'?'.$comment_config[$mid]['itemName'].'='.$comments[$i]-&gt;getVar('com_itemid').'&amp;com_id='.$i.'&amp;com_rootid='.$comments[$i]-&gt;getVar('com_rootid').'&amp;'.htmlspecialchars($comments[$i]-&gt;getVar('com_exparams')).'#comment'.$i.'&quot;&gt;'.$comments[$i]-&gt;getVar('com_title').'&lt;/a&gt;';
         $com['icon'] = htmlspecialchars( $comments[$i]-&gt;getVar('com_icon'), ENT_QUOTES );
         $com['icon'] = ($com['icon'] != '') ? &quot;subject/&quot;.$com['icon'] : 'subject/icon1.gif';
         $com['time'] = formatTimestamp($comments[$i]-&gt;getVar('com_created'),'m');
@@ -410,7 +410,7 @@
     include_once XOOPS_ROOT_PATH . '/include/notification_functions.php';
     include_once XOOPS_ROOT_PATH . '/language/' . $xoopsConfig['language'] . '/notification.php';
     // Notification must be enabled, and user must be logged in
-    if (empty($xoopsUser) || !notificationEnabled('block')) {
+    if (!is_object($xoopsUser) || !notificationEnabled('block')) {
         return false; // do not display block
     }
     $notification_handler =&amp; xoops_gethandler('notification');

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/include/update.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/include/update.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/include/update.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -186,11 +186,42 @@
             }
         }
     }
+
+    /**
+    * update default value for some profile fields according to system preferences
+    * comments mode and order, default timezone and theme is set to the same values as in general settings
+    */
+    $module-&gt;setMessage('Updating user profile field default value...');
+    $profile_handler =&amp; xoops_gethandler('profile');
+    $fields = $profile_handler-&gt;loadFields();
+    $fields_update = array(&quot;umode&quot;=&gt;&quot;com_mode&quot;, &quot;uorder&quot;=&gt;&quot;com_order&quot;, &quot;timezone_offset&quot;=&gt;&quot;default_TZ&quot;);
+    $count = 0;
+    foreach (array_keys($fields) as $i) {
+        if ($fields[$i]-&gt;getVar('field_moduleid') == $module-&gt;getVar('mid')){
+         	$field_name = $fields[$i]-&gt;getVar('field_name');
+         	if (!in_array($field_name, array_keys($fields_update))) {
+         	    continue;
+         	}
+        	$count++;
+	        $default = $GLOBALS[&quot;xoopsConfig&quot;][$fields_update[$field_name]];
+	        if ($default == $fields[$i]-&gt;getVar(&quot;field_default&quot;)) {
+	            continue;
+	        }
+	        $fields[$i]-&gt;setVar(&quot;field_default&quot;, $default);
+        	if ($profile_handler-&gt;insertField($fields[$i])) {
+        	    $module-&gt;setMessage(&quot;&nbsp;&nbsp;Field &lt;strong&gt;&quot;.$field_name.&quot;&lt;/strong&gt; default value updated: &quot;.$default);
+        	}
+        }
+        if ($count&gt;=count($fields_update)) {
+            break;
+        }
+    }
+    unset($fields);
+
     return true;
 }
 
 function xoops_module_pre_update_system(&amp;$module) {
-
     $oldversion = $module-&gt;getVar('version');
     if ($oldversion &lt; 206) {
         $sql = &quot;ALTER TABLE &quot;.$GLOBALS['xoopsDB']-&gt;prefix(&quot;session&quot;).&quot; CHANGE sess_data sess_data MEDIUMBLOB NOT NULL&quot;;
@@ -320,7 +351,7 @@
         $ids = array();
         while ($row = $GLOBALS['xoopsDB']-&gt;fetchArray($result)) {
             if (!isset($ids[$row['oldid']])) { //if &quot;old id&quot; is not set as the new joint id
-            $ids[$row['newid']][] = $row['oldid'];
+                $ids[$row['newid']][] = $row['oldid'];
             }
         }
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/templates/system_imagemanager2.html
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/templates/system_imagemanager2.html	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/templates/system_imagemanager2.html	2006-01-22 23:49:01 UTC (rev 185)
@@ -35,7 +35,7 @@
 
   &lt;table cellspacing=&quot;0&quot; id=&quot;imagenav&quot;&gt;
     &lt;tr&gt;
-      &lt;td align=&quot;left&quot;&gt;&lt;a href=&quot;&lt;{$xoops_url}&gt;/imagemanager.php?target=&lt;{$target}&gt;&amp;cat_id=&lt;{$show_cat}&gt;&quot;&gt;&lt;{$lang_imgmanager}&gt;&lt;/a&gt;&lt;/td&gt;
+      &lt;td align=&quot;left&quot;&gt;&lt;a href=&quot;&lt;{$xoops_url}&gt;/imagemanager.php?target=&lt;{$target}&gt;&amp;cat_id=&lt;{$show_cat}&gt;&quot;&gt;&lt;{$lang_imgmanager}&gt;&lt;/a&gt;&lt;/td&gt;
     &lt;/tr&gt;
   &lt;/table&gt;
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/modules/system/templates/system_userinfo.html
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/modules/system/templates/system_userinfo.html	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/modules/system/templates/system_userinfo.html	2006-01-22 23:49:01 UTC (rev 185)
@@ -26,8 +26,8 @@
 
 &lt;table width=&quot;70%&quot; align=&quot;center&quot; border=&quot;0&quot;&gt;
   &lt;tr align=&quot;center&quot;&gt;
-    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;&lt;{$lang_editprofile}&gt;&quot; onclick=&quot;location='&lt;{$xoops_url}&gt;/modules/system/admin.php?fct=users&amp;uid=&lt;{$user_uid}&gt;&amp;op=modifyUser'&quot; /&gt;
-    &lt;input type=&quot;button&quot; value=&quot;&lt;{$lang_deleteaccount}&gt;&quot; onclick=&quot;location='&lt;{$xoops_url}&gt;/modules/system/admin.php?fct=users&amp;op=delUser&amp;uid=&lt;{$user_uid}&gt;'&quot; /&gt;
+    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;&lt;{$lang_editprofile}&gt;&quot; onclick=&quot;location='&lt;{$xoops_url}&gt;/modules/system/admin.php?fct=users&amp;uid=&lt;{$user_uid}&gt;&amp;op=modifyUser'&quot; /&gt;
+    &lt;input type=&quot;button&quot; value=&quot;&lt;{$lang_deleteaccount}&gt;&quot; onclick=&quot;location='&lt;{$xoops_url}&gt;/modules/system/admin.php?fct=users&amp;op=delUser&amp;uid=&lt;{$user_uid}&gt;'&quot; /&gt;&lt;/td&gt;
   &lt;/tr&gt;
 &lt;/table&gt;
 

Modified: XoopsCore/branches/2.2.x/2.2-main/html/pda.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/pda.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/pda.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -41,7 +41,7 @@
 if (!$result) {
     echo &quot;An error occured&quot;;
 } else {
-    echo &quot;&lt;img src='images/logo.gif' alt='&quot;.htmlspecialchars($xoopsConfig['sitename']).&quot;' border='0' /&gt;&lt;br /&gt;&quot;;
+    echo &quot;&lt;img src='images/logo.gif' alt='&quot;.htmlspecialchars($xoopsConfig['sitename'], ENT_QUOTES).&quot;' border='0' /&gt;&lt;br /&gt;&quot;;
     echo &quot;&lt;h2&gt;&quot;.htmlspecialchars($xoopsConfig['slogan']).&quot;&lt;/h2&gt;&quot;;
     echo &quot;&lt;div&gt;&quot;;
     while (list($storyid, $title) = $xoopsDB-&gt;fetchRow($result)) {

Modified: XoopsCore/branches/2.2.x/2.2-main/html/search.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/search.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/search.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -89,7 +89,7 @@
     }
 }
 
-$groups = ( $xoopsUser ) ? $xoopsUser -&gt; getGroups() : XOOPS_GROUP_ANONYMOUS;
+$groups = is_object($xoopsUser) ? $xoopsUser -&gt; getGroups() : XOOPS_GROUP_ANONYMOUS;
 $gperm_handler = &amp; xoops_gethandler( 'groupperm' );
 $available_modules = $gperm_handler-&gt;getItemIds('module_read', $groups);
 
@@ -191,7 +191,7 @@
                 if ( $count == 5 ) {
                     $search_url = XOOPS_URL.'/search.php?query='.urlencode(stripslashes(implode(' ', $queries)));
                     $search_url .= &quot;&amp;mid=$mid&amp;action=showall&amp;andor=$andor&quot;;
-                    echo '&lt;br /&gt;&lt;a href=&quot;'.$search_url.'&quot;&gt;'._SR_SHOWALLR.'&lt;/a&gt;&lt;/p&gt;';
+                    echo '&lt;br /&gt;&lt;a href=&quot;'.htmlspecialchars($search_url).'&quot;&gt;'._SR_SHOWALLR.'&lt;/a&gt;&lt;/p&gt;';
                 }
             }
         }

Modified: XoopsCore/branches/2.2.x/2.2-main/html/themes/default/css/style.css
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/themes/default/css/style.css	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/themes/default/css/style.css	2006-01-22 23:49:01 UTC (rev 185)
@@ -54,7 +54,8 @@
 .comUserRank {margin: 2px;}
 .comUserRankText {font-size: 10px;font-weight:bold;}
 .comUserRankImg {border: 0;}
-.comUserName {}
+.comUserName {color: #eee;}
+.comUserName a{color: #eee;}
 .comUserImg {margin: 2px;}
 .comDate {font-weight: normal; font-style: italic; font-size: smaller}
 .comDateCaption {font-weight: bold; font-style: normal;}
@@ -125,7 +126,8 @@
 .head {background-color: #e7e7e7; padding: 3px; font-weight: normal;}
 .even {background-color: #e7e7e7; padding: 3px;}
 .odd {background-color: #f7f7f7; padding: 3px;}
-.foot {background-color: #436792; padding: 3px; font-weight: bold;text-align: center;}
+.foot {color: #fff; background-color: #436792; padding: 3px; font-weight: bold;text-align: center;}
+.foot a {color: #fff;}
 tr.head td {background-color: #B6CDE4; padding: 3px; font-weight: bold;}
 tr.even td {background-color: #efefef; padding: 3px;}
 tr.odd td {background-color: #f7f7f7; padding: 3px;}
@@ -182,4 +184,4 @@
 * html .NavMenu td { position: relative;} /* ie 5.0 fix */
 /* ...Nav bar end */
 
-.section .item {margin-bottom: 0px;}
\ No newline at end of file
+.section .item {margin-bottom: 0px;}

Modified: XoopsCore/branches/2.2.x/2.2-main/html/themes/xmt/css/style.css
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/themes/xmt/css/style.css	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/themes/xmt/css/style.css	2006-01-22 23:49:01 UTC (rev 185)
@@ -40,14 +40,14 @@
 
 /* Begin Menus */
 td#mainmenu { margin: 0; }
-td#mainmenu a:before { content: url(images/menubullet.png); }
+td#mainmenu a:before { content: url(&quot;../images/menubullet.png&quot;); }
 td#mainmenu a:hover { }
 td#mainmenu a.menuTop { padding-left: 3px; }
 td#mainmenu a.menuMain { padding-left: 3px; }
 td#mainmenu a.menuSub { padding-left: 9px; }
 
 td#usermenu { margin: 0; }
-td#usermenu a:before { content: url(images/menubullet.png); }
+td#usermenu a:before { content: url(&quot;../images/menubullet.png&quot;); }
 td#usermenu a:hover { }
 td#usermenu a.menuTop { padding-left: 3px; }
 td#usermenu a.highlight { background: #fcc; }
@@ -72,7 +72,7 @@
 /*Lists */
 html&gt;body ul {list-style: none;text-indent: -12px;}
 ul li:before {content: &quot;\00BB \0020&quot;;}
-ul {margin-top: 0;margin-left: 0;padding-left: 12px;} 
+ul {margin-top: 0;margin-left: 0;padding-left: 12px;}
 li {margin: 7px 0 8px 10px;}
 
 /* System Messages */
@@ -81,7 +81,7 @@
 div.confirmMsg {border-top: 1px solid #ddf;border-left: 10px solid #48b;border-right: 1px solid #aaa;border-bottom: 1px solid #aaa;padding: 10px;width: 75%;color: #136C99;background: #ddffdf;font-weight: bold;text-align: center;}
 
 div.resultMsg {border-top: 1px solid silver;border-left: 10px solid #48b;border-right: 1px solid #666;border-bottom: 1px solid #666;padding: 10px;width: 75%;color: #333;background: #f9f9f9;font-weight: bold;text-align: center;}
-	
+
 /* Posts */
 div.xoopsCode {border: 1px inset #000;padding: 6px;background: #e7e7e7;font-family: &quot;Courier New&quot;,Courier,monospace; overflow: auto;}
 div.xoopsQuote { font-style: italic;  overflow: auto;}

Modified: XoopsCore/branches/2.2.x/2.2-main/html/user.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/user.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/user.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -56,7 +56,9 @@
         $xoopsTpl-&gt;assign('lang_sendpassword', _US_SENDPASSWORD);
         $xoopsTpl-&gt;assign('mailpasswd_token', $GLOBALS['xoopsSecurity']-&gt;createToken());
         include 'footer.php';
-    } elseif ( $xoopsUser ) {
+    } elseif ( trim($_GET['xoops_redirect']) ) {
+        header('Location: '.trim($_GET['xoops_redirect']));
+    } else {
         header('Location: '.XOOPS_URL.'/modules/profile/userinfo.php?uid='.$xoopsUser-&gt;getVar('uid'));
     }
     exit();

Modified: XoopsCore/branches/2.2.x/2.2-main/html/xmlrpc.php
===================================================================
--- XoopsCore/branches/2.2.x/2.2-main/html/xmlrpc.php	2006-01-22 22:34:51 UTC (rev 184)
+++ XoopsCore/branches/2.2.x/2.2-main/html/xmlrpc.php	2006-01-22 23:49:01 UTC (rev 185)
@@ -30,7 +30,7 @@
 include_once XOOPS_ROOT_PATH.'/class/xml/rpc/xmlrpctag.php';
 include_once XOOPS_ROOT_PATH.'/class/xml/rpc/xmlrpcparser.php';
 $response = new XoopsXmlRpcResponse();
-$parser = new XoopsXmlRpcParser($GLOBALS['HTTP_RAW_POST_DATA']);
+$parser = new XoopsXmlRpcParser(rawurldecode($GLOBALS['HTTP_RAW_POST_DATA']));
 if (!$parser-&gt;parse()) {
 	$response-&gt;add(new XoopsXmlRpcFault(102));
 } else {


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000176.html">[Xoops4-svn] r184 - in XoopsCore/branches: . 2.2.x 2.2.x/2.2-main 2.2.x/2.2-main/docs 2.2.x/2.2-main/docs/images 2.2.x/2.2-main/extras 2.2.x/2.2-main/extras/theme_x2t 2.2.x/2.2-main/extras/theme_x2t/doc 2.2.x/2.2-main/extras/theme_x2t/extras 2.2.x/2.2-main/html 2.2.x/2.2-main/html/cache 2.2.x/2.2-main/html/class 2.2.x/2.2-main/html/class/auth 2.2.x/2.2-main/html/class/calendar 2.2.x/2.2-main/html/class/calendar/CSS 2.2.x/2.2-main/html/class/calendar/doc 2.2.x/2.2-main/html/class/calendar/doc/html 2.2.x/2.2-main/html/class/calendar/lang 2.2.x/2.2-main/html/class/database 2.2.x/2.2-main/html/class/mail 2.2.x/2.2-main/html/class/mail/phpmailer 2.2.x/2.2-main/html/class/smarty 2.2.x/2.2-main/html/class/smarty/configs 2.2.x/2.2-main/html/class/smarty/core 2.2.x/2.2-main/html/class/smarty/plugins 2.2.x/2.2-main/html/class/snoopy 2.2.x/2.2-main/html/class/xml 2.2.x/2.2-main/html/class/xml/rpc 2.2.x/2.2-main/html/class/xml/rss 2.2.x/2.2-main/html/class/xoopseditor 2.2.x/2.2-main/html/cl! ass/xoopseditor/dhtmltextarea 2.2.x/2.2-main/html/class/xoopseditor/dhtmltextarea/language 2.2.x/2.2-main/html/class/xoopseditor/koivi 2.2.x/2.2-main/html/class/xoopseditor/koivi/class 2.2.x/2.2-main/html/class/xoopseditor/koivi/images 2.2.x/2.2-main/html/class/xoopseditor/koivi/include 2.2.x/2.2-main/html/class/xoopseditor/koivi/include/js 2.2.x/2.2-main/html/class/xoopseditor/koivi/language 2.2.x/2.2-main/html/class/xoopseditor/koivi/skins 2.2.x/2.2-main/html/class/xoopseditor/koivi/skins/common 2.2.x/2.2-main/html/class/xoopseditor/koivi/skins/default 2.2.x/2.2-main/html/class/xoopseditor/koivi/skins/xp 2.2.x/2.2-main/html/class/xoopseditor/textarea 2.2.x/2.2-main/html/class/xoopseditor/textarea/language 2.2.x/2.2-main/html/class/xoopsform 2.2.x/2.2-main/html/images 2.2.x/2.2-main/html/images/banners 2.2.x/2.2-main/html/images/icons 2.2.x/2.2-main/html/images/subject 2.2.x/2.2-main/html/include 2.2.x/2.2-main/html/install 2.2.x/2.2-main/html/install/class 2.2.x/2.2-main/! html/install/img 2.2.x/2.2-main/html/install/language 2.2.x/2.! 2-main/h
</A></li>
	<LI>Next message: <A HREF="000178.html">[Xoops4-svn] r186 - XoopsCore/branches/2.2.x/2.2-main/html
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#177">[ date ]</a>
              <a href="thread.html#177">[ thread ]</a>
              <a href="subject.html#177">[ subject ]</a>
              <a href="author.html#177">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/xoops4-svn">More information about the Xoops4-svn
mailing list</a><br>
</body></html>
